OBJECT Codeunit 50108 UPS Tracking
{
  OBJECT-PROPERTIES
  {
    Date=25.03.15;
    Time=17:38:19;
    Modified=Yes;
    Version List=HME2064,GOB;
  }
  PROPERTIES
  {
    TableNo=472;
    OnRun=BEGIN
            //Http;
            //H1522       05.09.14 JM +++++++++++++++++++++++
            IF NOT EVALUATE(VolumePercent,"Parameter String") THEN
              VolumePercent := 0;
            //H1522       05.09.14 JM -----------------------
            CreateTrackingRequestToUPS;
            //ImportXmlTrackingResponse;
            //CopyFromTempToArchiv;

            //S/P1133
            FPCGeneralSetup.GET;
            //E/P1133
          END;

  }
  CODE
  {
    VAR
      Spem@1000000000 : Text[1024];
      ImportLogUPS@1000000002 : Record 50124;
      TestFile@1000000003 : File;
      TestStream@1000000004 : InStream;
      rFile@1000000005 : Record 2000000022;
      FileNaam@1000000006 : Text[1024];
      MyFile@1000000007 : Record 2000000022;
      MyXmlTab@1000000008 : Record 50124;
      FPCGeneralSetup@1000000009 : Record 50055;
      TimeAndDate@1000000010 : Text[30];
      DHLStatus@1000000011 : Record 50021;
      MyFileM@1000000001 : Record 2000000022;
      CUParcelStatusHistoryMgmt@1000000012 : Codeunit 80011;
      IDForArchiving@1000000014 : Integer;
      TmpTrackingCode@1000000013 : Code[20];
      "*********HME1522**********"@1000000020 : Integer;
      Volume@1000000019 : Integer;
      VolumeToProcess@1000000018 : Integer;
      VolumeCount@1000000017 : Integer;
      VolumePercent@1000000016 : Integer;
      VolumeBreak@1000000015 : Boolean;
      UPSSoapRequest@1000000021 : TextConst 'ENU="<?xml version=""1.0"" ?><AccessRequest><AccessLicenseNumber>6CAF344DA6654668</AccessLicenseNumber><UserId>HOME24_pld</UserId><Password>KkuH6T#8T</Password></AccessRequest><?xml version=""1.0"" ?><TrackRequest><Request><TransactionReference><CustomerContext>%1</CustomerContext></TransactionReference><RequestAction>Track</RequestAction></Request><TrackingNumber>%2</TrackingNumber></TrackRequest>"';

    PROCEDURE CreateTrackingRequestToUPS@1000000001();
    VAR
      locautXmlHttp@1000000000 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{F6D90F16-9C73-11D3-B32E-00C04F990BB4}:'Microsoft XML, v6.0'.XMLHTTP";
      locautXmlDoc@1000000001 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{F6D90F11-9C73-11D3-B32E-00C04F990BB4}:'Microsoft XML, v6.0'.DOMDocument";
      BatchTrackingActionL@1000000002 : Record 50245;
    BEGIN
      CREATE(locautXmlDoc);
      CREATE(locautXmlHttp);
      FPCGeneralSetup.GET;
      FPCGeneralSetup.TESTFIELD("UPS Import Tracking path");
      FPCGeneralSetup.TESTFIELD("UPS Archiv Tracking path");

      //H2064,H1522,H1851,H1326,P1232,P1204,P1133,P1171,P1124,P1186,P1046 26.02.15 MSL ++++++++++++++++++++++++++++++++++++++++++
      {
      TempTabDistinct.DELETEALL;
      CASE FPCGeneralSetup."Active Parcel Status History" OF
        FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old":
          BEGIN
            DHLStatus.RESET;
            DHLStatus.SETFILTER("Document No.",'<>%1','');
            DHLStatus.SETRANGE("Document Type",DHLStatus."Document Type"::Order);
            DHLStatus.SETFILTER("Time Stamp",'<>%1',0DT);
            DHLStatus.SETRANGE("Shipping Agent",'UPS');
            DHLStatus.SETRANGE("Docdate Status Code",'21');
            DHLStatus.SETRANGE("Final Status UPS",FALSE);
            DHLStatus.SETRANGE("Imported over UPS API",FALSE);
            Volume[1] := DHLStatus.COUNT;
            VolumeMgt(0,1);
            IF DHLStatus.FIND('-') THEN BEGIN
              REPEAT
                IF NOT TempTabDistinct.GET(COPYSTR(DHLStatus."Docdata Status Description",14,20)) THEN BEGIN
                  TempTabDistinct.INIT;
                    TempTabDistinct."No." := COPYSTR(DHLStatus."Docdata Status Description",14,20);
                    TempTabDistinct."No. 2" := DHLStatus."Document No.";
                    TempTabDistinct.Description := DHLStatus."Docdata Status Description";
                  TempTabDistinct.INSERT;
                END;
                VolumeMgt(1,1);
              UNTIL (DHLStatus.NEXT=0) OR (VolumeBreak[1]);
            END;
          END;
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
        FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History":
          BEGIN
            ParcelStatusHistory.RESET;
            ParcelStatusHistory.SETRANGE("Shipping Agent Code",'UPS');
            ParcelStatusHistory.SETFILTER("Document No.",'<>%1','');
            ParcelStatusHistory.SETRANGE("Document Type",ParcelStatusHistory."Document Type"::Order);
            ParcelStatusHistory.SETFILTER("Timestamp Insert",'<>%1',0DT);
            ParcelStatusHistory.SETFILTER("Status Sub Code",'21|31');
            ParcelStatusHistory.SETFILTER("Used Interface",'<>%1',ParcelStatusHistory."Used Interface"::UPS);
            ParcelStatusHistory.SETRANGE("Is Final Status",FALSE);
            Volume[2] := ParcelStatusHistory.COUNT;
            VolumeMgt(0,2);
            IF ParcelStatusHistory.FIND('-') THEN BEGIN
              REPEAT
                CLEAR(TmpTrackingCode);
                IF ParcelStatusHistory."Tracking Code" <> '' THEN
                  TmpTrackingCode := COPYSTR(ParcelStatusHistory."Tracking Code",1,20)
                ELSE BEGIN
                  TmpTrackingCode :=
                    COPYSTR(
                      ParcelStatusHistory."Comment Part 1",
                      STRPOS(ParcelStatusHistory."Comment Part 1",': ') + 2,
                      20);
                END;
                IF TmpTrackingCode <> '' THEN
                  IF NOT TempTabDistinct.GET(TmpTrackingCode) THEN BEGIN
                    TempTabDistinct.INIT;
                    TempTabDistinct."No." := TmpTrackingCode;
                    TempTabDistinct."No. 2" := ParcelStatusHistory."Document No.";
                    TempTabDistinct.Description := COPYSTR(ParcelStatusHistory."Comment Part 1",1,50);
                    TempTabDistinct.INSERT;
                  END;
                VolumeMgt(1,2);
              UNTIL (ParcelStatusHistory.NEXT=0) OR (VolumeBreak[2]);
            END;
            ParcelStatusHistoryArchive.RESET;
            ParcelStatusHistoryArchive.SETRANGE("Shipping Agent Code",'UPS');
            ParcelStatusHistoryArchive.SETFILTER("Document No.",'<>%1','');
            ParcelStatusHistoryArchive.SETRANGE("Document Type",ParcelStatusHistoryArchive."Document Type"::Order);
            ParcelStatusHistoryArchive.SETFILTER("Timestamp Insert",'<>%1',0DT);
            ParcelStatusHistoryArchive.SETFILTER("Status Sub Code",'21|31');
            ParcelStatusHistoryArchive.SETFILTER("Used Interface",'<>%1',ParcelStatusHistoryArchive."Used Interface"::UPS);
            ParcelStatusHistoryArchive.SETRANGE("Is Final Status",FALSE);
            Volume[3] := ParcelStatusHistoryArchive.COUNT;
            VolumeMgt(0,3);
            IF ParcelStatusHistoryArchive.FIND('-') THEN BEGIN
              REPEAT
                CLEAR(TmpTrackingCode);
                IF ParcelStatusHistoryArchive."Tracking Code" <> '' THEN
                  TmpTrackingCode := COPYSTR(ParcelStatusHistoryArchive."Tracking Code",1,20)
                ELSE BEGIN
                  TmpTrackingCode :=
                    COPYSTR(
                      ParcelStatusHistoryArchive."Comment Part 1",
                      STRPOS(ParcelStatusHistoryArchive."Comment Part 1",': ') + 2,
                      20);
                END;
                IF TmpTrackingCode <> '' THEN
                  IF NOT TempTabDistinct.GET(TmpTrackingCode) THEN BEGIN
                    TempTabDistinct.INIT;
                    TempTabDistinct."No." := TmpTrackingCode;
                    TempTabDistinct."No. 2" := ParcelStatusHistoryArchive."Document No.";
                    TempTabDistinct.Description := COPYSTR(ParcelStatusHistoryArchive."Comment Part 1",1,50);
                    TempTabDistinct.INSERT;
                  END;
                VolumeMgt(1,3);
              UNTIL (ParcelStatusHistoryArchive.NEXT=0) OR (VolumeBreak[3]);
            END;
          END;
      END;


      IF TempTabDistinct.FIND('-') THEN BEGIN
        REPEAT
          Spem:=STRSUBSTNO(
          '<?xml version="1.0" ?>'+
          '<AccessRequest>'+
            '<AccessLicenseNumber>6CAF344DA6654668</AccessLicenseNumber>'+
            '<UserId>HOME24_pld</UserId>'+
            '<Password>KkuH6T#8T</Password>'+
          '</AccessRequest>'+
          '<?xml version="1.0" ?>'+
          '<TrackRequest>'+
            '<Request>'+
              '<TransactionReference>'+
              '<CustomerContext>%1</CustomerContext>'+
              '</TransactionReference>'+
              '<RequestAction>Track</RequestAction>'+
            '</Request>'+
            '<TrackingNumber>%2</TrackingNumber>'+
          '</TrackRequest>',TempTabDistinct.Description,TempTabDistinct."No.");
          TimeAndDate := DELCHR(FORMAT(TODAY),'=','.')+'-'+DELCHR(FORMAT(TIME,0,2),'=','.:,T');
          locautXmlHttp.open('POST','https://wwwcie.ups.com/ups.app/xml/Track',FALSE);
          locautXmlHttp.send(Spem);

          IF locautXmlHttp.readyState = 4 THEN BEGIN
          locautXmlDoc.load(locautXmlHttp.responseXML);

          locautXmlDoc.save(FPCGeneralSetup."UPS Import Tracking path"+TempTabDistinct."No."+'-'+TimeAndDate+'.xml');
          END;
        UNTIL TempTabDistinct.NEXT = 0;
      END;
      }
      BatchTrackingActionL.SETRANGE("Shipping Agent",BatchTrackingActionL."Shipping Agent"::UPS);
      Volume := BatchTrackingActionL.COUNT;
      VolumeMgt(0);
      IF BatchTrackingActionL.FINDSET THEN BEGIN
        REPEAT
          Spem:=STRSUBSTNO(UPSSoapRequest,BatchTrackingActionL."Tracking Description",BatchTrackingActionL."Tracking Code");
          TimeAndDate := DELCHR(FORMAT(TODAY),'=','.')+'-'+DELCHR(FORMAT(TIME,0,2),'=','.:,T');
          locautXmlHttp.open('POST',FPCGeneralSetup."UPS API URL",FALSE);
          locautXmlHttp.send(Spem);
          IF locautXmlHttp.readyState = 4 THEN BEGIN
            locautXmlDoc.load(locautXmlHttp.responseXML);
            locautXmlDoc.save(FPCGeneralSetup."UPS Import Tracking path"+BatchTrackingActionL."Document No."+'-'+TimeAndDate+'.xml');
          END;
          VolumeMgt(1);
        UNTIL (BatchTrackingActionL.NEXT = 0) OR (VolumeBreak);
      END;
      //H2064,H1522,H1851,H1326,P1232,P1204,P1133,P1171,P1124,P1186,P1046 26.02.15 MSL -----------------------------------
      ImportXmlTrackingResponse;
    END;

    PROCEDURE ImportXmlTrackingResponse@1000000000();
    VAR
      XMLDOMDocument@1000000000 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{F6D90F11-9C73-11D3-B32E-00C04F990BB4}:'Microsoft XML, v6.0'.DOMDocument";
      XMLDOMManagement@1000000001 : Codeunit 6224;
      CurrNode@1000000002 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      XMLNodeFound@1000000003 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
    BEGIN
      FPCGeneralSetup.GET;
      MyFile.SETRANGE(Path,FPCGeneralSetup."UPS Import Tracking path");
      MyFile.SETRANGE("Is a file",TRUE);
      MyFile.SETFILTER(Name,'*.xml');
      IF MyFile.FIND('-') THEN BEGIN
        REPEAT
          TestFile.OPEN(FPCGeneralSetup."UPS Import Tracking path"+MyFile.Name);
          TestFile.CREATEINSTREAM(TestStream);
          XMLPORT.IMPORT(50007, TestStream);
          IF MyXmlTab.FINDLAST THEN BEGIN
            IF MyXmlTab."File name" = '' THEN BEGIN
              MyXmlTab."File name" := MyFile.Name;
              MyXmlTab.MODIFY;
            END;
          END;
          TestFile.CLOSE;
          FILE.COPY(FPCGeneralSetup."UPS Import Tracking path"+MyFile.Name,FPCGeneralSetup."UPS Archiv Tracking path"+MyFile.Name);
          FILE.ERASE(FPCGeneralSetup."UPS Import Tracking path"+MyFile.Name);
        UNTIL MyFile.NEXT = 0;
      END;
      COMMIT;
      ImportInDHLHistory;
    END;

    PROCEDURE ImportInDHLHistory@1000000002();
    VAR
      UPSTrackingTabele@1000000000 : Record 50124;
      TrackingVariable@1000000003 : Code[20];
      TodayTimeToxport@1000000005 : DateTime;
      ActivitiyDateVariable@1000000006 : Date;
      ActivityTimeVariable@1000000007 : Time;
      UPSTrackingTbl2@1000000008 : Record 50124;
      ParcelStatusHistory@1000000009 : Record 80013;
      ParcelStatusHistoryArchive@1000000013 : Record 50187;
      ParcelStatusHistoryNew@1000000010 : Record 80013;
      UseEntryNo@1000000011 : Integer;
      "**** HME *********************"@1000000012 : Integer;
      RedirectedToCommentL@1000000014 : Text[250];
      BatchTrackingActionL@1000000001 : Record 50245;
    BEGIN
      //S/P1133
      FPCGeneralSetup.GET;
      //E/P1133

      // S/gob-lku/14.08.2013/P1046
      SetPassForFailure;
      // E/gob-lku/14.08.2013/P1046

      UPSTrackingTabele.RESET;
      // S/gob-lku/31.07.2013/P1046
      UPSTrackingTabele.SETCURRENTKEY(Pass);
      // E/gob-lku/31.07.2013/P1046
      UPSTrackingTabele.SETRANGE(Pass,FALSE);
      // S/gob-lku/25.07.2013/P1046
      //IF UPSTrackingTabele.FINDFIRST THEN BEGIN
      IF UPSTrackingTabele.FIND('-') THEN BEGIN
      // E/gob-lku/25.07.2013/P1046
        REPEAT
          //S/P1133
          CASE FPCGeneralSetup."Active Parcel Status History" OF
            //H2064 03.03.15 MSL +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
            {
            FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old":
              BEGIN
          //E/P1133
                DHLTrackingTabele.RESET;
                // S/gob-lku/31.07.2013/P1046
                DHLTrackingTabele.SETCURRENTKEY("Document No.","Document Line No.","Document Type","Time Stamp");
                // S/gob-lku/14.08.2103/P1046
                //DHLTrackingTabele.SETFILTER("Sale Order Code",'<>%1','');
                IF UPSTrackingTabele."ReferenceNumber Value" <> '' THEN
                  DHLTrackingTabele.SETRANGE("Document No.",COPYSTR(UPSTrackingTabele."ReferenceNumber Value",1,
                        STRLEN(UPSTrackingTabele."ReferenceNumber Value")-3))
                ELSE
                  DHLTrackingTabele.SETFILTER("Document No.",'<>%1','');
                // E/gob-lku/14.08.2103/P1046
                DHLTrackingTabele.SETRANGE("Document Type",DHLTrackingTabele."Document Type"::Order);
                // E/gob-lku/31.07.2013/P1046
                DHLTrackingTabele.SETRANGE("Shipping Agent",'UPS');
                DHLTrackingTabele.SETRANGE("Docdate Status Code",'21');
                // S/gob-lku/31.07.2013/P1046
                //DHLTrackingTabele.SETFILTER("Sale Order Code",'<>%1','');
                //DHLTrackingTabele.SETRANGE("Sales Doc Type",DHLTrackingTabele."Sales Doc Type"::Order);
                // E/gob-lku/31.07.2013/P1046
                DHLTrackingTabele.SETFILTER(DHLTrackingTabele."Docdata Status Description",'=%1',
                 UPSTrackingTabele.CustomerContext);
                 DHLTrackingTabele.SETRANGE("Status Event",UPSTrackingTabele."StatusType Code");
                 DHLTrackingTabele.SETRANGE("Final Status UPS",FALSE);
                 DHLTrackingTabele.SETRANGE("Imported over UPS API",TRUE);
                // S/gob-lku/25.07.2013/P1046
                //IF DHLTrackingTabele.FINDFIRST THEN BEGIN
                IF DHLTrackingTabele.FIND('-') THEN BEGIN
                // E/gob-lku/25.07.2013/P1046
                  REPEAT
                    EVALUATE(ActivitiyDateVariable,COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                    COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                    COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                    EVALUATE(ActivityTimeVariable,UPSTrackingTabele."Activity Time");
                    DHLTrackingTabele."Time Stamp" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                    DHLTrackingTabele."Import Time Stamp" :=   CURRENTDATETIME;
                    //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
                    {
                    //H0777  28.01.14  MBY  ----------------------------
                    DHLTrackingTabele.MODIFY;
                    //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
                    }
                    DHLTrackingTabele.MODIFY(TRUE);
                    //H0777  28.01.14  MBY  ----------------------------
                  UNTIL DHLTrackingTabele.NEXT = 0;
                  // S/gob-lku/31.07.2013/P1046
                  //UPSTrackingTabele.Pass := TRUE;
                  //UPSTrackingTabele.SalesLineNo := DHLTrackingTabele."Line No.";
                  //UPSTrackingTabele.DHLParcelHistEntryNo := DHLTrackingTabele."Entry No.";
                  //UPSTrackingTabele.MODIFY;
                  UPSTrackingTbl2.GET(UPSTrackingTabele."Entry no.");
                  UPSTrackingTbl2.Pass := TRUE;
                  UPSTrackingTbl2.SalesLineNo := DHLTrackingTabele."Document Line No.";
                  UPSTrackingTbl2.DHLParcelHistEntryNo := DHLTrackingTabele."Entry No.";
                  UPSTrackingTbl2.MODIFY;
                  // E/gob-lku/31.07.2013/P1046
                END;
          //S/P1133
              END;
            }
            //H2064 03.03.15 MSL ------------------------------------------------
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
            FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History":
              BEGIN
                ParcelStatusHistory.RESET;
                //H1554,H1326  20.10.14  DMA  +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
                IF UPSTrackingTabele."ReferenceNumber Value" <> '' THEN  BEGIN
                    ParcelStatusHistory.SETRANGE("Document No.",
                      COPYSTR(UPSTrackingTabele."ReferenceNumber Value",1,STRLEN(UPSTrackingTabele."ReferenceNumber Value")-3));
                  ParcelStatusHistory.SETRANGE("Document Type",ParcelStatusHistory."Document Type"::Order);
                  ParcelStatusHistory.SETRANGE("Used Interface",ParcelStatusHistory."Used Interface"::UPS);
                  //H1851  27.11.14  MBY  +++++++++++++++++++++++++
                  //ParcelStatusHistory.SETRANGE("Status Sub Code",'21');
                  ParcelStatusHistory.SETFILTER("Status Sub Code",'21|31');
                  //H1851  27.11.14  MBY  -------------------------
                  ParcelStatusHistory.SETRANGE("Status Code",UPSTrackingTabele."StatusType Code");
                  ParcelStatusHistory.SETRANGE("Tracking Code",UPSTrackingTabele.TrackingNumber);
                  IF ParcelStatusHistory.FIND('-') THEN BEGIN
                //H1554,H1326  20.10.14  DMA  ---------------------------------------------------------------------

                    REPEAT
                      EVALUATE(
                        ActivitiyDateVariable,
                        COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                        COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                        COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                      EVALUATE(ActivityTimeVariable,UPSTrackingTabele."Activity Time");
                      // S/P1232
                      //ParcelStatusHistory."Timestamp Insert" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                      //ParcelStatusHistory."Timestamp Interface" :=   CURRENTDATETIME;
                      ParcelStatusHistory."Timestamp Insert" := CURRENTDATETIME;
                      ParcelStatusHistory."Timestamp Interface" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                      // E/P1232

                      //H1436 06.08.14 DMA +++++++++++++++++++++++++++++++
                      IF (UPSTrackingTabele."Redirect-to Company Name" <> '') OR
                          (UPSTrackingTabele."Redirect-to Address Line 1" <> '') OR
                          (UPSTrackingTabele."Redirect-to Address Line 2" <> '')
                          OR (UPSTrackingTabele."Redirect-to Address Line 3" <> '')
                          OR (UPSTrackingTabele."Redirect-to Post Code" <> '')
                          OR (UPSTrackingTabele."Redirect-to State Province" <> '')
                          OR (UPSTrackingTabele."Redirect-to Country Code" <> '')
                          THEN BEGIN

                        RedirectedToCommentL := UPSTrackingTabele."Redirect-to Company Name"
                            + ',' + UPSTrackingTabele."Redirect-to Address Line 1" + ',' +
                            UPSTrackingTabele."Redirect-to Address Line 2" + ',' +
                            UPSTrackingTabele."Redirect-to Address Line 3" + ',' + UPSTrackingTabele."Redirect-to Post Code" + ',' +
                            UPSTrackingTabele."Redirect-to State Province" + ',' + UPSTrackingTabele."Redirect-to Country Code";

                        IF (ParcelStatusHistory."Comment Part 1" = '') AND
                          ((ParcelStatusHistory."Comment Part 2" <> RedirectedToCommentL) AND
                          (ParcelStatusHistory."Comment Part 3" <> RedirectedToCommentL) AND
                          (ParcelStatusHistory."Comment Part 4" <> RedirectedToCommentL)) THEN BEGIN
                          ParcelStatusHistory."Comment Part 1" := RedirectedToCommentL;
                        END ELSE IF (ParcelStatusHistory."Comment Part 2" = '') AND
                          ((ParcelStatusHistory."Comment Part 1" <> RedirectedToCommentL) AND
                          (ParcelStatusHistory."Comment Part 3" <> RedirectedToCommentL) AND
                          (ParcelStatusHistory."Comment Part 4" <> RedirectedToCommentL)) THEN BEGIN
                          ParcelStatusHistory."Comment Part 2" := RedirectedToCommentL;
                        END ELSE IF (ParcelStatusHistory."Comment Part 3" = '') AND
                          ((ParcelStatusHistory."Comment Part 1" <> RedirectedToCommentL) AND
                          (ParcelStatusHistory."Comment Part 2" <> RedirectedToCommentL) AND
                          (ParcelStatusHistory."Comment Part 4" <> RedirectedToCommentL)) THEN BEGIN
                          ParcelStatusHistory."Comment Part 3" := RedirectedToCommentL;
                        END ELSE IF (ParcelStatusHistory."Comment Part 4" = '') AND
                          ((ParcelStatusHistory."Comment Part 1" <> RedirectedToCommentL) AND
                          (ParcelStatusHistory."Comment Part 2" <> RedirectedToCommentL) AND
                          (ParcelStatusHistory."Comment Part 3" <> RedirectedToCommentL)) THEN BEGIN
                          ParcelStatusHistory."Comment Part 4" := RedirectedToCommentL;
                        END;
                      END;
                      //H1436 06.08.14 DMA -------------------------------


                      // S/P1228
                      //ParcelStatusHistory.MODIFY;
                      ParcelStatusHistory.MODIFY(TRUE);
                      // E/P1228
                    UNTIL ParcelStatusHistory.NEXT = 0;
                    UPSTrackingTbl2.GET(UPSTrackingTabele."Entry no.");
                    UPSTrackingTbl2.Pass := TRUE;
                    UPSTrackingTbl2.SalesLineNo := ParcelStatusHistory."Document Line No.";
                    UPSTrackingTbl2.DHLParcelHistEntryNo := ParcelStatusHistory."Entry No.";
                    UPSTrackingTbl2.MODIFY;
                //H1326  03.07.14  MBY  +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
                  END;
                END;
                //H1326  03.07.14  MBY  ---------------------------------------------------------------------
              END;
          END;
          //E/P1133
        UNTIL UPSTrackingTabele.NEXT = 0;
      END;

      UPSTrackingTabele.RESET;
      // S/gob-lku/31.07.2013/P1046
      UPSTrackingTabele.SETCURRENTKEY(Pass);
      // E/gob-lku/31.07.2013/P1046
      UPSTrackingTabele.SETRANGE(Pass,FALSE);
      // S/gob-lku/25.07.2013/P1046
      //IF UPSTrackingTabele.FINDFIRST THEN BEGIN
      IF UPSTrackingTabele.FIND('-') THEN BEGIN
      // E/gob-lku/25.07.2013/P1046
        REPEAT
          //H2064 03.03.15 MSL +++++++++++++++++++++++++++++++++++++++++++++++++++
          {
          //S/P1117
          //S/P1133
          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New"]
          THEN BEGIN
          //E/P1133
            DHLTrackingTabele.RESET;
            // S/gob-lku/31.07.2013/P1046
            //H1326  03.07.14  MBY  +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
            //DHLTrackingTabele.SETCURRENTKEY("Sale Order Code","Line No.","Sales Doc Type","Time Stamp");
            //H1326  03.07.14  MBY  ---------------------------------------------------------------------
            // S/gob-lku/14.08.2103/P1046
            //DHLTrackingTabele.SETFILTER("Sale Order Code",'<>%1','');
            IF UPSTrackingTabele."ReferenceNumber Value" <> '' THEN
              DHLTrackingTabele.SETRANGE("Document No.",COPYSTR(UPSTrackingTabele."ReferenceNumber Value",1,
                    STRLEN(UPSTrackingTabele."ReferenceNumber Value")-3))
            ELSE
              DHLTrackingTabele.SETFILTER("Document No.",'<>%1','');
            // E/gob-lku/14.08.2103/P1046
            DHLTrackingTabele.SETRANGE("Document Type",DHLTrackingTabele."Document Type"::Order);
            DHLTrackingTabele.SETFILTER("Time Stamp",'<>%1',0DT);
            // E/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETRANGE("Shipping Agent",'UPS');
            // S/gob-lku/31.07.2013/P1046
            //DHLTrackingTabele.SETFILTER("Time Stamp",'<>%1',0DT);
            // E/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETRANGE("Docdate Status Code",'21');
            // S/gob-lku/31.07.2013/P1046
            //DHLTrackingTabele.SETFILTER("Sale Order Code",'<>%1','');
            //DHLTrackingTabele.SETRANGE("Sales Doc Type",DHLTrackingTabele."Sales Doc Type"::Order);
            // E/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETRANGE(DHLTrackingTabele."Docdata Status Description",UPSTrackingTabele.CustomerContext);
            DHLTrackingTabele.SETRANGE("Final Status UPS",FALSE);
            DHLTrackingTabele.SETRANGE("Imported over UPS API",FALSE);
            // S/gob-lku/25.07.2013/P1046
            //IF DHLTrackingTabele.FINDFIRST THEN BEGIN
            IF DHLTrackingTabele.FIND('-') THEN BEGIN
            // E/gob-lku/25.07.2013/P1046
              REPEAT
                FindLastEntryNoInDHL.RESET;
                FindLastEntryNoInDHL.FINDLAST;
                //S/P1133
                IF FPCGeneralSetup."Active Parcel Status History" IN
                  [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
                  FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old"]
                THEN BEGIN
                //E/P1133
                  // S/gob-lku/31.07.2013/P1046
                  //UPSTrackingTabele.Pass := TRUE;
                  //UPSTrackingTabele.DHLParcelHistEntryNo := FindLastEntryNoInDHL."Entry No." + 1;
                  //UPSTrackingTabele.SalesLineNo := DHLTrackingTabele."Line No.";
                  //UPSTrackingTabele.MODIFY;
                  // S/P1082
                  UPSTrackingTbl2.GET(UPSTrackingTabele."Entry no.");
                  // E/P1082
                  UPSTrackingTbl2.Pass := TRUE;
                  UPSTrackingTbl2.DHLParcelHistEntryNo := FindLastEntryNoInDHL."Entry No." + 1;
                  UPSTrackingTbl2.SalesLineNo := DHLTrackingTabele."Document Line No.";
                  UPSTrackingTbl2.MODIFY;
                  // E/gob-lku/31.07.2013/P1046
                //S/P1133
                END;
                //E/P1133
                DHLTrackingTabeleInsertNew.INIT;
                DHLTrackingTabeleInsertNew."Entry No." := FindLastEntryNoInDHL."Entry No." + 1;
                // S/gob-lku/14.08.2013/P1046
                DHLTrackingTabeleInsertNew.INSERT;
                // E/gob-lku/14.08.2013/P1046
                DHLTrackingTabeleInsertNew."DHL Shipment Code" := '';
                DHLTrackingTabeleInsertNew."Account Number" := UPSTrackingTabele.ShipperNumber;
                DHLTrackingTabeleInsertNew."Production Line"       := '';
                DHLTrackingTabeleInsertNew.Product := '';
                TodayTimeToxport := CURRENTDATETIME;
                EVALUATE(ActivitiyDateVariable,COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                EVALUATE(ActivityTimeVariable,UPSTrackingTabele."Activity Time");
                DHLTrackingTabeleInsertNew."Time Stamp" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                DHLTrackingTabeleInsertNew."Import Time Stamp" := TodayTimeToxport;
                DHLTrackingTabeleInsertNew."Detection Location" := '';
                DHLTrackingTabeleInsertNew."Country of Origin" := UPSTrackingTabele."Shipper CountryCode";
                DHLTrackingTabeleInsertNew."Piece-Code (Identifier)" := '';
                DHLTrackingTabeleInsertNew."Commit at Date" := TODAY;
                DHLTrackingTabeleInsertNew."Status Event" := UPSTrackingTabele."StatusType Code";
                DHLTrackingTabeleInsertNew."Status Code" := '';
                DHLTrackingTabeleInsertNew."Standart Event" := '';
                DHLTrackingTabeleInsertNew."Reference Number" := UPSTrackingTabele."ReferenceNumber Code";
                DHLTrackingTabeleInsertNew."Recipient Name Is" := '';
                DHLTrackingTabeleInsertNew."Recipient Name Target" := '';
                DHLTrackingTabeleInsertNew."Routing Code" := '';
                DHLTrackingTabeleInsertNew."Return Policies (Y/N)" := FALSE;
                EVALUATE(DHLTrackingTabeleInsertNew."Delivery Date",COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                                                                    COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                                                                    COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                EVALUATE(DHLTrackingTabeleInsertNew."Pickup Date",COPYSTR(UPSTrackingTabele.PickupDate,7,2)+
                                                                  COPYSTR(UPSTrackingTabele.PickupDate,5,2)+
                                                                  COPYSTR(UPSTrackingTabele.PickupDate,1,4));
                DHLTrackingTabeleInsertNew."Document No." := DHLTrackingTabele."Document No.";
                DHLTrackingTabeleInsertNew."Document Type" := DHLTrackingTabele."Document Type";
                DHLTrackingTabeleInsertNew."Document Line No." := DHLTrackingTabele."Document Line No.";
                DHLTrackingTabeleInsertNew."Shipment Date" := DHLTrackingTabele."Shipment Date";
                DHLTrackingTabeleInsertNew."Purchase Order Code" := DHLTrackingTabele."Purchase Order Code";
                DHLTrackingTabeleInsertNew."PO Line No." := DHLTrackingTabele."PO Line No.";
                DHLTrackingTabeleInsertNew."Current Status" := DHLTrackingTabele."Current Status";
                DHLTrackingTabeleInsertNew."Rhenus Entry" := DHLTrackingTabele."Rhenus Entry";
                DHLTrackingTabeleInsertNew.DeleteMe := DHLTrackingTabele.DeleteMe;
                DHLTrackingTabeleInsertNew."Status Drop Shipment" :=  DHLTrackingTabele."Status Drop Shipment";
                DHLTrackingTabeleInsertNew."Drop Shipment Status Desc." := DHLTrackingTabele."Drop Shipment Status Desc.";
                //DHLTrackingTabeleInsertNew."Import Time Stamp" := 0DT;
                DHLTrackingTabeleInsertNew."Time Difference" := 0;
                DHLTrackingTabeleInsertNew."Status DHL" := DHLTrackingTabele."Status DHL";
                DHLTrackingTabeleInsertNew."Order Date" := DHLTrackingTabele."Order Date";
                DHLTrackingTabeleInsertNew."Shipment through" := DHLTrackingTabele."Shipment through";
                DHLTrackingTabeleInsertNew."Shipping Agent" := DHLTrackingTabele."Shipping Agent";
                //DHLTrackingTabeleInsertNew."VIR Status Comment" := DHLTrackingTabele."VIR Status Comment";
                DHLTrackingTabeleInsertNew."Status DHL HD" := DHLTrackingTabele."Status DHL HD";
                DHLTrackingTabeleInsertNew."Status Docdata" := DHLTrackingTabele."Status Docdata";
                DHLTrackingTabeleInsertNew."Docdate Status Code" := DHLTrackingTabele."Docdate Status Code";
                DHLTrackingTabeleInsertNew."DHL HD Status Code" := DHLTrackingTabele."DHL HD Status Code";
                DHLTrackingTabeleInsertNew."Docdata Status Description" := DHLTrackingTabele."Docdata Status Description";
                IF UPSTrackingTabele.ResponseStatusCode = '1' THEN BEGIN
                  DHLTrackingTabeleInsertNew."DHL HD Status Description" := COPYSTR(UPSTrackingTabele."StatusType Description",1,50);
                  DHLTrackingTabele."DHL HD Status Description" := COPYSTR(UPSTrackingTabele."StatusType Description",1,50);
                  DHLTrackingTabele.MODIFY;
                END ELSE BEGIN
                  DHLTrackingTabeleInsertNew."DHL HD Status Description" := COPYSTR(UPSTrackingTabele.ErrorDescription,1,50);
                  DHLTrackingTabele."DHL HD Status Description" := COPYSTR(UPSTrackingTabele.ErrorDescription,1,50);
                  DHLTrackingTabele.MODIFY;
                END;

                DHLTrackingTabeleInsertNew."Imported over DHL API" := DHLTrackingTabele."Imported over DHL API";
                DHLTrackingTabeleInsertNew."Imported over UPS API" := TRUE;
                DHLTrackingTabeleInsertNew."Status RIC Name" := DHLTrackingTabele."Status RIC Name";
                DHLTrackingTabeleInsertNew."Status Event Name" := DHLTrackingTabele."Status Event Name";
                DHLTrackingTabeleInsertNew."Rhenus Status Description" := DHLTrackingTabele."Rhenus Status Description";

                IF UPSTrackingTabele."StatusType Code" = 'D' THEN BEGIN
                  DHLTrackingTabeleInsertNew."Final Status UPS" := TRUE;
                  // S/gob-lku/31.07.2013/P1046
                  //DHLTrackingTabele."Final Status UPS" := TRUE;
                  //DHLTrackingTabele.MODIFY;
                  SetFinalStatus(DHLTrackingTabele."Document No.",DHLTrackingTabele."Document Type",
                    DHLTrackingTabele."Document Line No.");
                  // E/gob-lku/31.07.2013/P1046
                END;

                IF UPSTrackingTabele.AlternateTrackingNumber <> '' THEN BEGIN
                  DHLTrackingTabeleInsertNew."Final Status UPS" := TRUE;
                  // S/gob-lku/31.07.2013/P1046
                  //DHLTrackingTabele."Final Status UPS" := TRUE;
                  //DHLTrackingTabele.MODIFY;
                  SetFinalStatus(DHLTrackingTabele."Document No.",DHLTrackingTabele."Document Type",
                    DHLTrackingTabele."Document Line No.");
                  // E/gob-lku/31.07.2013/P1046
                  DHLTrackingTabele.AlternateTrackinNumberUPS := UPSTrackingTabele.AlternateTrackingNumber;
                  DHLTrackingTabeleInsertNew.AlternateTrackinNumberUPS := UPSTrackingTabele.AlternateTrackingNumber;
                  DHLTrackingTabele.MODIFY;
                END;

                // S/gob-lku/14.08.2013/P1046
                //DHLTrackingTabeleInsertNew.INSERT;
                // E/gob-lku/14.08.2013/P1046
                //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
                {
                //H0686  04.12.13  MBY  ----------------------------
                DHLTrackingTabeleInsertNew.MODIFY;
                //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
                }
                DHLTrackingTabeleInsertNew.MODIFY(TRUE);
                //H0686  04.12.13  MBY  ----------------------------
              UNTIL DHLTrackingTabele.NEXT = 0;
            END;
          //S/P1133
          END;
          }
          //H2064 03.03.15 MSL -------------------------------------------------

          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
            FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
          THEN BEGIN
          //E/P1133
            //H2064,P1184 03.03.15 MSL ++++++++++++++++++++++++++++++++++++++++++++++
            {
            //H1326  03.07.14  MBY  +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
            //ParcelStatusHistory.SETCURRENTKEY("Sales Doc. No.","Sales Doc. Line No.","Sales Doc. Type");
            //H1326  03.07.14  MBY  ---------------------------------------------------------------------
            IF UPSTrackingTabele."ReferenceNumber Value" <> '' THEN
              ParcelStatusHistory.SETRANGE(
                "Document No.",
                COPYSTR(UPSTrackingTabele."ReferenceNumber Value",1,STRLEN(UPSTrackingTabele."ReferenceNumber Value")-3))
            ELSE
              ParcelStatusHistory.SETFILTER("Document No.",'<>%1','');
            ParcelStatusHistory.SETRANGE("Document Type",ParcelStatusHistory."Document Type"::Order);
            ParcelStatusHistory.SETRANGE("Comment Part 1",UPSTrackingTabele.CustomerContext);

            //H1932 22.12.14 DMA +++++++++++++++++++++++++++++++++++++++++++++++
            IF (DELCHR(UPSTrackingTabele.TrackingNumber,'=', ' ') <> '') AND
              ((DELCHR(UPSTrackingTabele.CustomerContext,'=', ' ')) = '') THEN
              ParcelStatusHistory.SETRANGE("Tracking Code",UPSTrackingTabele.TrackingNumber);
            //H1932 22.12.14 DMA -----------------------------------------------

            ParcelStatusHistory.SETFILTER("Timestamp Insert",'<>%1',0DT);
            ParcelStatusHistory.SETRANGE("Shipping Agent Code",'UPS');
            //H1851,H1554,H1356,P1186,P1204  27.11.14  MBY  +++++++++++++++++++++++++++++++++++++++++++++++++++++++++
            //ParcelStatusHistory.SETRANGE("Status Sub Code",'21');
            ParcelStatusHistory.SETFILTER("Status Sub Code",'21|31');
            ParcelStatusHistory.SETRANGE("Is Final Status",FALSE);
            //H1851,H1554,H1356,P1186,P1204  27.11.14  MBY  ---------------------------------------------------------
            ParcelStatusHistory.SETFILTER("Used Interface",'<>%1',ParcelStatusHistory."Used Interface"::UPS);

            }
            BatchTrackingActionL.RESET;
            IF (DELCHR(UPSTrackingTabele.TrackingNumber,'=', ' ') <> '') AND
              ((DELCHR(UPSTrackingTabele.CustomerContext,'=', ' ')) = '') THEN
              BatchTrackingActionL.SETRANGE("Tracking Code",UPSTrackingTabele.TrackingNumber)
            ELSE
              BatchTrackingActionL.SETRANGE("Tracking Description",UPSTrackingTabele.CustomerContext);
            IF BatchTrackingActionL.FINDSET THEN BEGIN
            //IF ParcelStatusHistory.FIND('-') THEN BEGIN
            //H2064 03.03.15 MSL ---------------------------------------------------------
              REPEAT
                IF ParcelStatusHistory.GET(BatchTrackingActionL."Parcel Status History Entry No") THEN BEGIN
                  CLEAR(ParcelStatusHistoryNew);
                  ParcelStatusHistoryNew.INIT;
                  UseEntryNo := ParcelStatusHistoryNew.GetNextEntryNo(TRUE);
                  ParcelStatusHistoryNew."Entry No." := UseEntryNo;
                  ParcelStatusHistoryNew.INSERT;
                  IF FPCGeneralSetup."Active Parcel Status History" IN
                    [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
                    FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
                  THEN BEGIN
                    UPSTrackingTbl2.GET(UPSTrackingTabele."Entry no.");
                    UPSTrackingTbl2.Pass := TRUE;
                    UPSTrackingTbl2.DHLParcelHistEntryNo := UseEntryNo;
                    UPSTrackingTbl2.SalesLineNo := ParcelStatusHistory."Document Line No.";
                    UPSTrackingTbl2.MODIFY;
                  END;
                  ParcelStatusHistoryNew."Document Type" := ParcelStatusHistory."Document Type";
                  ParcelStatusHistoryNew."Document No." := ParcelStatusHistory."Document No.";
                  ParcelStatusHistoryNew."Document Line No." := ParcelStatusHistory."Document Line No.";
                  ParcelStatusHistoryNew."Purchase Doc. Type" := ParcelStatusHistory."Purchase Doc. Type";
                  ParcelStatusHistoryNew."Purchase Doc. No." := ParcelStatusHistory."Purchase Doc. No.";
                  ParcelStatusHistoryNew."Purchase Doc. Line No." := ParcelStatusHistory."Purchase Doc. Line No.";
                  ParcelStatusHistoryNew."Direction of Information" := ParcelStatusHistory."Direction of Information"::Incoming;
                  ParcelStatusHistoryNew."Used Interface" := ParcelStatusHistory."Used Interface"::UPS;
                  // S/P1186
                  ParcelStatusHistoryNew."Status Code" := UPSTrackingTabele."StatusType Code";
                  ParcelStatusHistoryNew."Status Sub Code" := ParcelStatusHistory."Status Sub Code";
                  // E/P1186
                  ParcelStatusHistoryNew."Account No." := UPSTrackingTabele.ShipperNumber;
                  EVALUATE(ActivitiyDateVariable,COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                  COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                  COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                  EVALUATE(ActivityTimeVariable,UPSTrackingTabele."Activity Time");
                  ParcelStatusHistoryNew."Timestamp Insert" := CURRENTDATETIME;
                  ParcelStatusHistoryNew."Timestamp Interface" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                  IF ParcelStatusHistoryNew."Timestamp Interface" <> 0DT THEN
                    ParcelStatusHistoryNew."Timestamp Difference" :=
                      ParcelStatusHistoryNew."Timestamp Insert" -
                      ParcelStatusHistoryNew."Timestamp Interface";
                  IF ParcelStatusHistoryNew."Timestamp Difference" < 0 THEN
                    ParcelStatusHistoryNew."Timestamp Difference" := ParcelStatusHistoryNew."Timestamp Difference" * -1;
                  ParcelStatusHistoryNew."Date Commit" := TODAY;
                  EVALUATE(ParcelStatusHistoryNew."Date Delivery",
                    COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                    COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                    COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                  EVALUATE(ParcelStatusHistoryNew."Date Pickup",
                    COPYSTR(UPSTrackingTabele.PickupDate,7,2)+
                    COPYSTR(UPSTrackingTabele.PickupDate,5,2)+
                    COPYSTR(UPSTrackingTabele.PickupDate,1,4));
                  ParcelStatusHistoryNew."Shipping Agent Code" := ParcelStatusHistory."Shipping Agent Code";
                  // S/P1204
                  //ParcelStatusHistoryNew."Comment Part 1" := UPSTrackingTabele."ReferenceNumber Code";
                  ParcelStatusHistoryNew."Tracking Code" := UPSTrackingTabele.TrackingNumber;
                  // E/P1204
                  IF UPSTrackingTabele.ResponseStatusCode = '1' THEN BEGIN
                    ParcelStatusHistoryNew."Comment Part 2" := COPYSTR(UPSTrackingTabele."StatusType Description",1,50);
                    ParcelStatusHistory."Comment Part 2" := COPYSTR(UPSTrackingTabele."StatusType Description",1,50);
                    //msl
                    //ParcelStatusHistory.MODIFY;
                  END ELSE BEGIN
                    ParcelStatusHistoryNew."Comment Part 2" := COPYSTR(UPSTrackingTabele.ErrorDescription,1,50);
                    ParcelStatusHistory."Comment Part 2" := COPYSTR(UPSTrackingTabele.ErrorDescription,1,50);
                    //msl
                    //ParcelStatusHistory.MODIFY;
                  END;
                  // S/P1204
                  { ****
                  IF UPSTrackingTabele.AlternateTrackingNumber <> '' THEN BEGIN
                    ParcelStatusHistoryNew."Tracking Code" := UPSTrackingTabele.AlternateTrackingNumber;
                    ParcelStatusHistory."Tracking Code" := UPSTrackingTabele.AlternateTrackingNumber;
                    ParcelStatusHistory.MODIFY;
                  END;
                  **** }
                  IF UPSTrackingTabele.AlternateTrackingNumber <> '' THEN BEGIN
                    ParcelStatusHistoryNew."Comment Part 1" := 'Alt. Track. No.: ' + UPSTrackingTabele.AlternateTrackingNumber;
                    ParcelStatusHistory."Comment Part 4" := 'Alt. Track. No.: ' + UPSTrackingTabele.AlternateTrackingNumber;
                    ParcelStatusHistory.MODIFY;
                  END;
                  IF UPSTrackingTabele."ReferenceNumber Code" <> '' THEN
                    ParcelStatusHistoryNew."Comment Part 3" := 'Ref. No.: ' + UPSTrackingTabele."ReferenceNumber Code";

                  //H1436 06.08.14 DMA +++++++++++++++++++++++++++++++
                  IF (UPSTrackingTabele."Redirect-to Company Name" <> '') OR
                     (UPSTrackingTabele."Redirect-to Address Line 1" <> '') OR (UPSTrackingTabele."Redirect-to Address Line 2" <> '')
                     OR (UPSTrackingTabele."Redirect-to Address Line 3" <> '') OR (UPSTrackingTabele."Redirect-to Post Code" <> '')
                     OR (UPSTrackingTabele."Redirect-to State Province" <> '') OR (UPSTrackingTabele."Redirect-to Country Code" <> '')
                     THEN BEGIN

                    RedirectedToCommentL := UPSTrackingTabele."Redirect-to Company Name"
                        + ',' + UPSTrackingTabele."Redirect-to Address Line 1" + ',' + UPSTrackingTabele."Redirect-to Address Line 2"
                        + ',' + UPSTrackingTabele."Redirect-to Address Line 3" + ',' + UPSTrackingTabele."Redirect-to Post Code"
                        + ',' + UPSTrackingTabele."Redirect-to State Province" + ',' + UPSTrackingTabele."Redirect-to Country Code";

                    IF (ParcelStatusHistoryNew."Comment Part 1" = '') AND
                      ((ParcelStatusHistoryNew."Comment Part 2" <> RedirectedToCommentL) AND
                      (ParcelStatusHistoryNew."Comment Part 3" <> RedirectedToCommentL) AND
                      (ParcelStatusHistoryNew."Comment Part 4" <> RedirectedToCommentL)) THEN BEGIN
                      ParcelStatusHistoryNew."Comment Part 1" := RedirectedToCommentL;
                    END ELSE IF (ParcelStatusHistoryNew."Comment Part 2" = '') AND
                      ((ParcelStatusHistoryNew."Comment Part 1" <> RedirectedToCommentL) AND
                      (ParcelStatusHistoryNew."Comment Part 3" <> RedirectedToCommentL) AND
                      (ParcelStatusHistoryNew."Comment Part 4" <> RedirectedToCommentL)) THEN BEGIN
                      ParcelStatusHistoryNew."Comment Part 2" := RedirectedToCommentL;
                    END ELSE IF (ParcelStatusHistoryNew."Comment Part 3" = '') AND
                      ((ParcelStatusHistoryNew."Comment Part 1" <> RedirectedToCommentL) AND
                      (ParcelStatusHistoryNew."Comment Part 2" <> RedirectedToCommentL) AND
                      (ParcelStatusHistoryNew."Comment Part 4" <> RedirectedToCommentL)) THEN BEGIN
                      ParcelStatusHistoryNew."Comment Part 3" := RedirectedToCommentL;
                    END ELSE IF (ParcelStatusHistoryNew."Comment Part 4" = '') AND
                      ((ParcelStatusHistoryNew."Comment Part 1" <> RedirectedToCommentL) AND
                      (ParcelStatusHistoryNew."Comment Part 2" <> RedirectedToCommentL) AND
                      (ParcelStatusHistoryNew."Comment Part 3" <> RedirectedToCommentL)) THEN BEGIN
                      ParcelStatusHistoryNew."Comment Part 4" := RedirectedToCommentL;
                    END;
                  END;
                  //H1436 06.08.14 DMA -------------------------------

                  // E/P1204
                // S/P1228
                //ParcelStatusHistoryNew.MODIFY;
                ParcelStatusHistoryNew.MODIFY(TRUE);
                // E/P1228
                // S/P1204
                //CLEAR(CUParcelStatusHistoryMgmt);
                //CUParcelStatusHistoryMgmt.CheckIfArchivedOrder(ParcelStatusHistoryNew."Entry No.");
                CLEAR(IDForArchiving);
                IDForArchiving := ParcelStatusHistoryNew."Entry No.";
                IF (UPSTrackingTabele."StatusType Code" = 'D') OR
                   (UPSTrackingTabele.AlternateTrackingNumber <> '')
                THEN BEGIN
                  ParcelStatusHistoryNew."Is Final Status" := TRUE;
                  // S/P1228
                  //ParcelStatusHistoryNew.MODIFY;
                  ParcelStatusHistoryNew.MODIFY(TRUE);
                  // E/P1228
                  SetFinalStatusNew(
                    ParcelStatusHistory."Document No.",
                    ParcelStatusHistory."Document Type",
                    ParcelStatusHistory."Document Line No.");
                END;
                CLEAR(CUParcelStatusHistoryMgmt);
                CUParcelStatusHistoryMgmt.CheckIfArchivedOrder(IDForArchiving);
                // E/P1204
                //H2064 03.03.15 MSL ++++++++++++++++++++++++++++++++++++
                //UNTIL ParcelStatusHistory.NEXT = 0;
                END
                ELSE
                {
                ParcelStatusHistoryArchive.RESET;

                //H1326  03.07.14  MBY  +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
                //ParcelStatusHistoryArchive.SETCURRENTKEY("Sales Doc. No.","Sales Doc. Line No.","Sales Doc. Type");
                //H1326  03.07.14  MBY  ---------------------------------------------------------------------
                IF UPSTrackingTabele."ReferenceNumber Value" <> '' THEN
                  ParcelStatusHistoryArchive.SETRANGE(
                    "Document No.",
                    COPYSTR(UPSTrackingTabele."ReferenceNumber Value",1,STRLEN(UPSTrackingTabele."ReferenceNumber Value")-3))
                ELSE
                  ParcelStatusHistoryArchive.SETFILTER("Document No.",'<>%1','');
                ParcelStatusHistoryArchive.SETRANGE("Document Type",ParcelStatusHistoryArchive."Document Type"::Order);
                ParcelStatusHistoryArchive.SETRANGE("Comment Part 1",UPSTrackingTabele.CustomerContext);

                //H1932 22.12.14 DMA +++++++++++++++++++++++++++++++++++++++++++++++
                IF (DELCHR(UPSTrackingTabele.TrackingNumber,'=', ' ') <> '') AND
                  ((DELCHR(UPSTrackingTabele.CustomerContext,'=', ' ')) = '') THEN
                  ParcelStatusHistoryArchive.SETRANGE("Tracking Code",UPSTrackingTabele.TrackingNumber);
                //H1932 22.12.14 DMA -----------------------------------------------

                ParcelStatusHistoryArchive.SETFILTER("Timestamp Insert",'<>%1',0DT);
                ParcelStatusHistoryArchive.SETRANGE("Shipping Agent Code",'UPS');
                //H1851,H1554,P1186,P1204  27.11.14  MBY  +++++++++++++++++++++++++++++++++++++++++++++++++++++++++
                //ParcelStatusHistoryArchive.SETRANGE("Status Sub Code",'21');
                ParcelStatusHistoryArchive.SETFILTER("Status Sub Code",'21|31');
                ParcelStatusHistoryArchive.SETRANGE("Is Final Status",FALSE);
                //H1851,H1554,P1186,P1204  27.11.14  MBY  ---------------------------------------------------------
                ParcelStatusHistoryArchive.SETFILTER("Used Interface",'<>%1',ParcelStatusHistoryArchive."Used Interface"::UPS);

                IF ParcelStatusHistoryArchive.FIND('-') THEN BEGIN
                  REPEAT
                }
                IF ParcelStatusHistoryArchive.GET(BatchTrackingActionL."Parcel Status History Entry No") THEN BEGIN
                //H2064 03.03.15 MSL ---------------------------------------------------------------
                  CLEAR(ParcelStatusHistoryNew);
                  ParcelStatusHistoryNew.INIT;
                  UseEntryNo := ParcelStatusHistoryNew.GetNextEntryNo(TRUE);
                  ParcelStatusHistoryNew."Entry No." := UseEntryNo;
                  ParcelStatusHistoryNew.INSERT;
                  IF FPCGeneralSetup."Active Parcel Status History" IN
                    [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
                    FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
                  THEN BEGIN
                    UPSTrackingTbl2.GET(UPSTrackingTabele."Entry no.");
                    UPSTrackingTbl2.Pass := TRUE;
                    UPSTrackingTbl2.DHLParcelHistEntryNo := UseEntryNo;
                    UPSTrackingTbl2.SalesLineNo := ParcelStatusHistoryArchive."Document Line No.";
                    UPSTrackingTbl2.MODIFY;
                  END;
                  ParcelStatusHistoryNew."Document Type" := ParcelStatusHistoryArchive."Document Type";
                  ParcelStatusHistoryNew."Document No." := ParcelStatusHistoryArchive."Document No.";
                  ParcelStatusHistoryNew."Document Line No." := ParcelStatusHistoryArchive."Document Line No.";
                  ParcelStatusHistoryNew."Purchase Doc. Type" := ParcelStatusHistoryArchive."Purchase Doc. Type";
                  ParcelStatusHistoryNew."Purchase Doc. No." := ParcelStatusHistoryArchive."Purchase Doc. No.";
                  ParcelStatusHistoryNew."Purchase Doc. Line No." := ParcelStatusHistoryArchive."Purchase Doc. Line No.";
                  ParcelStatusHistoryNew."Direction of Information" := ParcelStatusHistoryArchive."Direction of Information"::Incoming;
                  ParcelStatusHistoryNew."Used Interface" := ParcelStatusHistoryArchive."Used Interface"::UPS;
                  // S/P1186
                  ParcelStatusHistoryNew."Status Code" := UPSTrackingTabele."StatusType Code";
                  ParcelStatusHistoryNew."Status Sub Code" := ParcelStatusHistoryArchive."Status Sub Code";
                  // E/P1186
                  ParcelStatusHistoryNew."Account No." := UPSTrackingTabele.ShipperNumber;
                  EVALUATE(ActivitiyDateVariable,COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                  COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                  COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                  EVALUATE(ActivityTimeVariable,UPSTrackingTabele."Activity Time");
                  ParcelStatusHistoryNew."Timestamp Insert" := CURRENTDATETIME;
                  ParcelStatusHistoryNew."Timestamp Interface" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                  IF ParcelStatusHistoryNew."Timestamp Interface" <> 0DT THEN
                    ParcelStatusHistoryNew."Timestamp Difference" :=
                      ParcelStatusHistoryNew."Timestamp Insert" -
                      ParcelStatusHistoryNew."Timestamp Interface";
                  IF ParcelStatusHistoryNew."Timestamp Difference" < 0 THEN
                    ParcelStatusHistoryNew."Timestamp Difference" := ParcelStatusHistoryNew."Timestamp Difference" * -1;
                  ParcelStatusHistoryNew."Date Commit" := TODAY;
                  EVALUATE(ParcelStatusHistoryNew."Date Delivery",
                    COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                    COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                    COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                  EVALUATE(ParcelStatusHistoryNew."Date Pickup",
                    COPYSTR(UPSTrackingTabele.PickupDate,7,2)+
                    COPYSTR(UPSTrackingTabele.PickupDate,5,2)+
                    COPYSTR(UPSTrackingTabele.PickupDate,1,4));
                  ParcelStatusHistoryNew."Shipping Agent Code" := ParcelStatusHistoryArchive."Shipping Agent Code";
                  // S/P1204
                  //ParcelStatusHistoryNew."Comment Part 1" := UPSTrackingTabele."ReferenceNumber Code";
                  ParcelStatusHistoryNew."Tracking Code" := UPSTrackingTabele.TrackingNumber;
                  // E/P1204
                  IF UPSTrackingTabele.ResponseStatusCode = '1' THEN BEGIN
                    ParcelStatusHistoryNew."Comment Part 2" := COPYSTR(UPSTrackingTabele."StatusType Description",1,50);
                    ParcelStatusHistoryArchive."Comment Part 2" := COPYSTR(UPSTrackingTabele."StatusType Description",1,50);
                    ParcelStatusHistoryArchive.MODIFY;
                  END ELSE BEGIN
                    ParcelStatusHistoryNew."Comment Part 2" := COPYSTR(UPSTrackingTabele.ErrorDescription,1,50);
                    ParcelStatusHistoryArchive."Comment Part 2" := COPYSTR(UPSTrackingTabele.ErrorDescription,1,50);
                    ParcelStatusHistoryArchive.MODIFY;
                  END;
                  // S/P1204
                  { ****
                  IF UPSTrackingTabele.AlternateTrackingNumber <> '' THEN BEGIN
                    ParcelStatusHistoryNew."Tracking Code" := UPSTrackingTabele.AlternateTrackingNumber;
                    ParcelStatusHistoryArchive."Tracking Code" := UPSTrackingTabele.AlternateTrackingNumber;
                    ParcelStatusHistoryArchive.MODIFY;
                  END;
                  **** }
                  IF UPSTrackingTabele.AlternateTrackingNumber <> '' THEN BEGIN
                    ParcelStatusHistoryNew."Comment Part 1" := 'Alt. Track. No.: ' + UPSTrackingTabele.AlternateTrackingNumber;
                    ParcelStatusHistoryArchive."Comment Part 4" := 'Alt. Track. No.: ' + UPSTrackingTabele.AlternateTrackingNumber;
                    ParcelStatusHistoryArchive.MODIFY;
                  END;
                  IF UPSTrackingTabele."ReferenceNumber Code" <> '' THEN
                    ParcelStatusHistoryNew."Comment Part 3" := 'Ref. No.: ' + UPSTrackingTabele."ReferenceNumber Code";

                  //H1436 06.08.14 DMA +++++++++++++++++++++++++++++++
                  IF (UPSTrackingTabele."Redirect-to Company Name" <> '') OR
                     (UPSTrackingTabele."Redirect-to Address Line 1" <> '') OR (UPSTrackingTabele."Redirect-to Address Line 2" <> '')
                     OR (UPSTrackingTabele."Redirect-to Address Line 3" <> '') OR (UPSTrackingTabele."Redirect-to Post Code" <> '')
                     OR (UPSTrackingTabele."Redirect-to State Province" <> '') OR (UPSTrackingTabele."Redirect-to Country Code" <> '')
                     THEN BEGIN

                    RedirectedToCommentL := UPSTrackingTabele."Redirect-to Company Name"
                        + ',' + UPSTrackingTabele."Redirect-to Address Line 1" + ',' + UPSTrackingTabele."Redirect-to Address Line 2"
                        + ',' + UPSTrackingTabele."Redirect-to Address Line 3" + ',' + UPSTrackingTabele."Redirect-to Post Code"
                        + ',' + UPSTrackingTabele."Redirect-to State Province" + ',' + UPSTrackingTabele."Redirect-to Country Code";

                    IF (ParcelStatusHistoryNew."Comment Part 1" = '') AND
                      ((ParcelStatusHistoryNew."Comment Part 2" <> RedirectedToCommentL) AND
                      (ParcelStatusHistoryNew."Comment Part 3" <> RedirectedToCommentL) AND
                      (ParcelStatusHistoryNew."Comment Part 4" <> RedirectedToCommentL)) THEN BEGIN
                      ParcelStatusHistoryNew."Comment Part 1" := RedirectedToCommentL;
                    END ELSE IF (ParcelStatusHistoryNew."Comment Part 2" = '') AND
                      ((ParcelStatusHistoryNew."Comment Part 1" <> RedirectedToCommentL) AND
                      (ParcelStatusHistoryNew."Comment Part 3" <> RedirectedToCommentL) AND
                      (ParcelStatusHistoryNew."Comment Part 4" <> RedirectedToCommentL)) THEN BEGIN
                      ParcelStatusHistoryNew."Comment Part 2" := RedirectedToCommentL;
                    END ELSE IF (ParcelStatusHistoryNew."Comment Part 3" = '') AND
                      ((ParcelStatusHistoryNew."Comment Part 1" <> RedirectedToCommentL) AND
                      (ParcelStatusHistoryNew."Comment Part 2" <> RedirectedToCommentL) AND
                      (ParcelStatusHistoryNew."Comment Part 4" <> RedirectedToCommentL)) THEN BEGIN
                      ParcelStatusHistoryNew."Comment Part 3" := RedirectedToCommentL;
                    END ELSE IF (ParcelStatusHistoryNew."Comment Part 4" = '') AND
                      ((ParcelStatusHistoryNew."Comment Part 1" <> RedirectedToCommentL) AND
                      (ParcelStatusHistoryNew."Comment Part 2" <> RedirectedToCommentL) AND
                      (ParcelStatusHistoryNew."Comment Part 3" <> RedirectedToCommentL)) THEN BEGIN
                      ParcelStatusHistoryNew."Comment Part 4" := RedirectedToCommentL;
                    END;
                  END;
                  //H1436 06.08.14 DMA -------------------------------

                  // E/P1204
                  // S/P1228
                  //ParcelStatusHistoryNew.MODIFY;
                  ParcelStatusHistoryNew.MODIFY(TRUE);
                  // E/P1228
                  // S/P1204
                  //CLEAR(CUParcelStatusHistoryMgmt);
                  //CUParcelStatusHistoryMgmt.MoveParcelInfosToArchive(4,'',0,0,'',ParcelStatusHistoryNew."Entry No.");
                  CLEAR(IDForArchiving);
                  IDForArchiving := ParcelStatusHistoryNew."Entry No.";
                  IF (UPSTrackingTabele."StatusType Code" = 'D') OR
                     (UPSTrackingTabele.AlternateTrackingNumber <> '')
                  THEN BEGIN
                    ParcelStatusHistoryNew."Is Final Status" := TRUE;
                    // S/P1228
                    //ParcelStatusHistoryNew.MODIFY;
                    ParcelStatusHistoryNew.MODIFY(TRUE);
                    // E/P1228
                    SetFinalStatusNew(
                      ParcelStatusHistoryArchive."Document No.",
                      ParcelStatusHistoryArchive."Document Type",
                      ParcelStatusHistoryArchive."Document Line No.");
                  END;
                  CLEAR(CUParcelStatusHistoryMgmt);
                  CUParcelStatusHistoryMgmt.MoveParcelInfosToArchive(4,'',0,0,'',IDForArchiving);
                  // E/P1204
                //H2064 03.03.15 MSL +++++++++++++++++++++++++++
                //UNTIL ParcelStatusHistoryArchive.NEXT = 0;
                END;
              UNTIL BatchTrackingActionL.NEXT = 0;
                //H2064 03.03.15 MSL ---------------------------
            END;
          //S/P1133
          END;
          //E/P1133
          //E/P1117
        UNTIL UPSTrackingTabele.NEXT = 0;
      END;

      //H1326  03.07.14  MBY  +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
      {
      //S/P11117
      //S/P1133
      IF FPCGeneralSetup."Active Parcel Status History" IN
        [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New"]
      THEN BEGIN
      //E/P1133
        DHLTrackingTabele.RESET;
        // S/gob-lku/31.07.2013/P1046
        //DHLTrackingTabele.SETCURRENTKEY("Sale Order Code","Line No.","Sales Doc Type","Time Stamp");
        DHLTrackingTabele.SETFILTER("Sale Order Code",'<>%1','');
        DHLTrackingTabele.SETRANGE("Sales Doc Type",DHLTrackingTabele."Sales Doc Type"::Order);
        DHLTrackingTabele.SETRANGE("Time Stamp",0DT);
        // E/gob-lku/31.07.2013/P1046
        DHLTrackingTabele.SETRANGE("Shipping Agent",'UPS');
        // S/gob-lku/31.07.2013/P1046
        //DHLTrackingTabele.SETFILTER("Time Stamp",'=%1',0DT);
        // E/gob-lku/31.07.2013/P1046
        DHLTrackingTabele.SETRANGE("Docdate Status Code",'21');
        // S/gob-lku/31.07.2013/P1046
        //DHLTrackingTabele.SETFILTER("Sale Order Code",'<>%1','');
        //DHLTrackingTabele.SETRANGE("Sales Doc Type",DHLTrackingTabele."Sales Doc Type"::Order);
        // E/gob-lku/31.07.2013/P1046
        //DHLTrackingTabele.SETFILTER("Docdata Status Description",'=%1',
        //UPSTrackingTabele.CustomerContext);
        DHLTrackingTabele.SETRANGE("Imported over UPS API",TRUE);
        IF DHLTrackingTabele.FIND('-') THEN BEGIN
                  EVALUATE(ActivitiyDateVariable,COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                  COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                  COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                  EVALUATE(ActivityTimeVariable,UPSTrackingTabele."Activity Time");
          //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
          {
          //H0777  28.01.14  MBY  ----------------------------
          DHLTrackingTabele.MODIFYALL("Time Stamp",CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable));
          //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
          }
          DHLTrackingTabele.MODIFYALL("Time Stamp",CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable),TRUE);
          //H0777  28.01.14  MBY  ----------------------------
        END;
      //S/P1133
      END;

      IF FPCGeneralSetup."Active Parcel Status History" IN
        [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
        FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
      THEN BEGIN
      //E/P1133
        ParcelStatusHistory.RESET;
        //ParcelStatusHistory.SETCURRENTKEY("Sales Doc. No.","Sales Doc. Line No.","Sales Doc. Type");
        ParcelStatusHistory.SETFILTER("Sales Doc. No.",'<>%1','');
        ParcelStatusHistory.SETRANGE("Sales Doc. Type",ParcelStatusHistory."Sales Doc. Type"::Order);
        ParcelStatusHistory.SETRANGE("Timestamp Interface",0DT);
        ParcelStatusHistory.SETRANGE("Shipping Agent Code",'UPS');
        //H1851,P1186  MBY  27.11.14  ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
        //ParcelStatusHistory.SETRANGE("Status Sub Code",'21');
        ParcelStatusHistory.SETFILTER("Status Sub Code",'21|31');
        //H1851,P1186  MBY  27.11.14  --------------------------------------------------------
        ParcelStatusHistory.SETRANGE("Used Interface",ParcelStatusHistory."Used Interface"::UPS);
        IF ParcelStatusHistory.FIND('-') THEN BEGIN
          EVALUATE(ActivitiyDateVariable,
            COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
            COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
            COPYSTR(UPSTrackingTabele."Activity Date",1,4));
          EVALUATE(ActivityTimeVariable,
            UPSTrackingTabele."Activity Time");
          // S/P1228
          //ParcelStatusHistory.MODIFYALL("Timestamp Interface",CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable));
          ParcelStatusHistory.MODIFYALL("Timestamp Interface",CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable),TRUE);
          // E/P1228
        END;
      //S/P1133
      END;
      //E/P1133
      //E/P1117
      }
      //H1326  03.07.14  MBY  ---------------------------------------------------------------------

      CopyFromTempToArchiv;
    END;

    PROCEDURE CreateTrackingRequestManuToUPS@1000000003(SalesOrderCode@1000000003 : Code[20]);
    VAR
      locautXmlHttp@1000000000 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{F6D90F16-9C73-11D3-B32E-00C04F990BB4}:'Microsoft XML, v6.0'.XMLHTTP";
      locautXmlDoc@1000000001 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{F6D90F11-9C73-11D3-B32E-00C04F990BB4}:'Microsoft XML, v6.0'.DOMDocument";
      TempTabDistinct@1000000002 : TEMPORARY Record 27;
      ParcelStatusHistory@1000000004 : Record 80013;
      ParcelStatusHistoryArchive@1000000005 : Record 50187;
    BEGIN
      CREATE(locautXmlDoc);
      CREATE(locautXmlHttp);
      FPCGeneralSetup.GET;
      //FPCGeneralSetup.TESTFIELD("UPS Import Tracking path");
      //FPCGeneralSetup.TESTFIELD("UPS Archiv Tracking path");
      FPCGeneralSetup.TESTFIELD("UPS Temp path");
      TempTabDistinct.DELETEALL;

      //S/P1133
      CASE FPCGeneralSetup."Active Parcel Status History" OF
        FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old":
          BEGIN
      //E/P1133
            // S/gob-lku/31.07.2013/P1046
            DHLStatus.RESET;
            DHLStatus.SETCURRENTKEY("Document No.","Document Line No.","Document Type","Time Stamp");
            DHLStatus.SETFILTER("Document No.",SalesOrderCode);
            DHLStatus.SETRANGE("Document Type",DHLStatus."Document Type"::Order);
            DHLStatus.SETFILTER("Time Stamp",'<>%1',0DT);
            // E/gob-lku/31.07.2013/P1046
            DHLStatus.SETRANGE("Shipping Agent",'UPS');
            // S/gob-lku/31.07.2013/P1046
            //DHLStatus.SETFILTER("Time Stamp",'<>%1',0DT);
            // E/gob-lku/31.07.2013/P1046
            DHLStatus.SETRANGE("Docdate Status Code",'21');
            // S/gob-lku/31.07.2013/P1046
            //DHLStatus.SETFILTER("Sale Order Code",SalesOrderCode);
            //DHLStatus.SETRANGE("Sales Doc Type",DHLStatus."Sales Doc Type"::Order);
            // E/gob-lku/31.07.2013/P1046
            DHLStatus.SETRANGE("Final Status UPS",FALSE);
            DHLStatus.SETRANGE("Imported over UPS API",FALSE);
            // S/gob-lku/25.07.2013/P1046
            //IF DHLStatus.FINDFIRST THEN BEGIN
            IF DHLStatus.FIND('-') THEN BEGIN
            // E/gob-lku/25.07.2013/P1046
              REPEAT
                IF NOT TempTabDistinct.GET(COPYSTR(DHLStatus."Docdata Status Description",14,20)) THEN BEGIN
                  TempTabDistinct.INIT;
                    TempTabDistinct."No." := COPYSTR(DHLStatus."Docdata Status Description",14,20);
                    TempTabDistinct."No. 2" := DHLStatus."Document No.";
                    TempTabDistinct.Description := DHLStatus."Docdata Status Description";
                  TempTabDistinct.INSERT;
                END;
              UNTIL DHLStatus.NEXT=0;
            END;
      //S/P1133
          END;
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
        FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History":
          BEGIN
            ParcelStatusHistory.RESET;
            ParcelStatusHistory.SETCURRENTKEY("Document No.","Document Line No.","Document Type");
            ParcelStatusHistory.SETFILTER("Document No.",SalesOrderCode);
            ParcelStatusHistory.SETRANGE("Document Type",ParcelStatusHistory."Document Type"::Order);
            ParcelStatusHistory.SETFILTER("Timestamp Insert",'<>%1',0DT);
            ParcelStatusHistory.SETRANGE("Used Interface",ParcelStatusHistory."Used Interface"::UPS);

            //H1851  27.11.14  MBY  +++++++++++++++++++++++++
            //ParcelStatusHistory.SETRANGE("Status Sub Code",'21');
            ParcelStatusHistory.SETFILTER("Status Sub Code",'21|31');
            //H1851  27.11.14  MBY  -------------------------
            // S/P1186
            //ParcelStatusHistory.SETFILTER("Import API",'<>%1',ParcelStatusHistory."Import API"::UPS);
            // S/P1204
            //ParcelStatusHistory.SETFILTER("Status Code",'<>%1','D');
            ParcelStatusHistory.SETRANGE("Is Final Status",FALSE);
            // E/P1204
            // E/P1186
            IF ParcelStatusHistory.FIND('-') THEN BEGIN
              // S/P1232
              //ParcelStatusHistory.CALCFIELDS("Status Description","Status Sub Description");
              // E/P1232
              REPEAT
                // S/P1232
                { ******
                IF NOT TempTabDistinct.GET(COPYSTR(ParcelStatusHistory."Status Sub Description",14,20)) THEN BEGIN
                  TempTabDistinct.INIT;
                    TempTabDistinct."No." := COPYSTR(ParcelStatusHistory."Status Sub Description",14,20);
                    TempTabDistinct."No. 2" := ParcelStatusHistory."Sales Doc. No.";
                    TempTabDistinct.Description := ParcelStatusHistory."Status Sub Description";
                ***** }
                CLEAR(TmpTrackingCode);
                IF ParcelStatusHistory."Tracking Code" <> '' THEN
                  TmpTrackingCode := COPYSTR(ParcelStatusHistory."Tracking Code",1,20)
                ELSE BEGIN
                  TmpTrackingCode :=
                    COPYSTR(
                      ParcelStatusHistory."Comment Part 1",
                      STRPOS(ParcelStatusHistory."Comment Part 1",': ') + 2,
                      20);
                END;
                IF TmpTrackingCode <> '' THEN
                  IF NOT TempTabDistinct.GET(TmpTrackingCode) THEN BEGIN
                    TempTabDistinct."No." := TmpTrackingCode;
                    TempTabDistinct."No. 2" := ParcelStatusHistory."Document No.";
                    TempTabDistinct.Description := COPYSTR(ParcelStatusHistory."Comment Part 1",1,50);
                // E/P1232
                    TempTabDistinct.INSERT;
                  END;
              UNTIL ParcelStatusHistory.NEXT=0;
            END;
            // S/P1232
            ParcelStatusHistoryArchive.RESET;
            ParcelStatusHistoryArchive.SETCURRENTKEY("Document No.","Document Line No.","Document Type");
            ParcelStatusHistoryArchive.SETFILTER("Document No.",SalesOrderCode);
            ParcelStatusHistoryArchive.SETRANGE("Document Type",ParcelStatusHistoryArchive."Document Type"::Order);
            ParcelStatusHistoryArchive.SETFILTER("Timestamp Insert",'<>%1',0DT);
            ParcelStatusHistoryArchive.SETRANGE("Used Interface",ParcelStatusHistoryArchive."Used Interface"::UPS);
            //H1851  27.11.14  MBY  +++++++++++++++++++++++++
            //ParcelStatusHistoryArchive.SETRANGE("Status Sub Code",'21');
            ParcelStatusHistoryArchive.SETFILTER("Status Sub Code",'21|31');
            //H1851  27.11.14  MBY  -------------------------
            ParcelStatusHistoryArchive.SETRANGE("Is Final Status",FALSE);
            IF ParcelStatusHistoryArchive.FIND('-') THEN BEGIN
              REPEAT
                CLEAR(TmpTrackingCode);
                IF ParcelStatusHistoryArchive."Tracking Code" <> '' THEN
                  TmpTrackingCode := COPYSTR(ParcelStatusHistoryArchive."Tracking Code",1,20)
                ELSE BEGIN
                  TmpTrackingCode :=
                    COPYSTR(
                      ParcelStatusHistoryArchive."Comment Part 1",
                      STRPOS(ParcelStatusHistoryArchive."Comment Part 1",': ') + 2,
                      20);
                END;
                IF TmpTrackingCode <> '' THEN
                  IF NOT TempTabDistinct.GET(TmpTrackingCode) THEN BEGIN
                    TempTabDistinct.INIT;
                    TempTabDistinct."No." := TmpTrackingCode;
                    TempTabDistinct."No. 2" := ParcelStatusHistoryArchive."Document No.";
                    TempTabDistinct.Description := COPYSTR(ParcelStatusHistoryArchive."Comment Part 1",1,50);
                    TempTabDistinct.INSERT;
                  END;
              UNTIL ParcelStatusHistoryArchive.NEXT = 0;
            END;
            // E/P1232
          END;
      END;
      //E/P1133

      // S/gob-lku/25.07.2013/P1046
      //IF TempTabDistinct.FINDFIRST THEN BEGIN
      IF TempTabDistinct.FIND('-') THEN BEGIN
      // E/gob-lku/25.07.2013/P1046
        REPEAT
          Spem:=STRSUBSTNO(
          '<?xml version="1.0" ?>'+
          '<AccessRequest>'+
            '<AccessLicenseNumber>6CAF344DA6654668</AccessLicenseNumber>'+
            '<UserId>HOME24_pld</UserId>'+
            '<Password>KkuH6T#8T</Password>'+
          '</AccessRequest>'+
          '<?xml version="1.0" ?>'+
          '<TrackRequest>'+
            '<Request>'+
              '<TransactionReference>'+
              '<CustomerContext>%1</CustomerContext>'+
              '</TransactionReference>'+
              '<RequestAction>Track</RequestAction>'+
            '</Request>'+
            '<TrackingNumber>%2</TrackingNumber>'+
          '</TrackRequest>',TempTabDistinct.Description,TempTabDistinct."No.");
          // S/P1171
          //TimeAndDate := DELCHR(FORMAT(TODAY),'=','.')+'-'+DELCHR(FORMAT(TIME),'=','.:,');
          TimeAndDate := DELCHR(FORMAT(TODAY),'=','.')+'-'+DELCHR(FORMAT(TIME,0,2),'=','.:,T');
          // E/P1171
          locautXmlHttp.open('POST','https://wwwcie.ups.com/ups.app/xml/Track',FALSE);
          locautXmlHttp.send(Spem);
          locautXmlDoc.load(locautXmlHttp.responseXML);

          locautXmlDoc.save(FPCGeneralSetup."UPS Temp path"+TempTabDistinct."No."+'-'+TimeAndDate+'.xml');
        UNTIL TempTabDistinct.NEXT = 0;

      END;

      //IF locautXmlHttp.status = 200 THEN
        ImportXmlTrackingResponseManua(SalesOrderCode);
    END;

    PROCEDURE ImportXmlTrackingResponseManua@1000000006(DocumentNo@1000000004 : Code[20]);
    VAR
      XMLDOMDocument@1000000000 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{F6D90F11-9C73-11D3-B32E-00C04F990BB4}:'Microsoft XML, v6.0'.DOMDocument";
      XMLDOMManagement@1000000001 : Codeunit 6224;
      CurrNode@1000000002 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      XMLNodeFound@1000000003 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
    BEGIN
      FPCGeneralSetup.GET;
      MyFile.SETRANGE(Path,FPCGeneralSetup."UPS Temp path");
      MyFile.SETRANGE("Is a file",TRUE);
      MyFile.SETFILTER(Name,'*.xml');
      IF MyFile.FIND('-') THEN BEGIN
        REPEAT
          TestFile.OPEN(FPCGeneralSetup."UPS Temp path"+MyFile.Name);
          TestFile.CREATEINSTREAM(TestStream);
          XMLPORT.IMPORT(50007, TestStream);
          IF MyXmlTab.FINDLAST THEN BEGIN
            IF MyXmlTab."File name" = '' THEN BEGIN
              MyXmlTab."File name" := MyFile.Name;
              MyXmlTab.MODIFY;
            END;
          END;
          TestFile.CLOSE;
          FILE.COPY(FPCGeneralSetup."UPS Temp path"+MyFile.Name,FPCGeneralSetup."UPS Temp Archiv path"+MyFile.Name);
          FILE.ERASE(FPCGeneralSetup."UPS Temp path"+MyFile.Name);

        UNTIL MyFile.NEXT = 0;
      END;
      COMMIT;
      ImportInDHLHistoryManual(DocumentNo);;
    END;

    PROCEDURE ImportInDHLHistoryManual@1000000007(DocumentNo@1000000008 : Code[20]);
    VAR
      UPSTrackingTabele@1000000000 : Record 50124;
      DHLTrackingTabele@1000000001 : Record 50021;
      FindLastEntryNoInDHL@1000000002 : Record 50021;
      TrackingVariable@1000000003 : Code[20];
      DHLTrackingTabeleInsertNew@1000000004 : Record 50021;
      TodayTimeToxport@1000000005 : DateTime;
      ActivitiyDateVariable@1000000006 : Date;
      ActivityTimeVariable@1000000007 : Time;
      UPSTrackingTbl2@1000000009 : Record 50124;
      ParcelStatusHistory@1000000010 : Record 80013;
      ParcelStatusHistoryNew@1000000011 : Record 80013;
      UseEntryNo@1000000012 : Integer;
    BEGIN
      // S/gob-lku/14.08.2013/P1046
      SetPassForFailure;
      // E/gob-lku/14.08.2013/P1046

      //S/P1133
      FPCGeneralSetup.GET;
      //E/P1133

      //neu
      UPSTrackingTabele.RESET;
      // S/gob-lku/31.07.2013/P1046
      UPSTrackingTabele.SETCURRENTKEY(Pass);
      // E/gob-lku/31.07.2013/P1046
      UPSTrackingTabele.SETRANGE(Pass,FALSE);
      // S/gob-lku/25.07.2013/P1046
      //IF UPSTrackingTabele.FINDFIRST THEN BEGIN
      IF UPSTrackingTabele.FIND('-') THEN BEGIN
      // E/gob-lku/25.07.2013/P1046
        REPEAT
          //S/P1133
          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New"]
          THEN BEGIN
          //E/P1133
            DHLTrackingTabele.RESET;
            // S/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETCURRENTKEY("Document No.","Document Line No.","Document Type","Time Stamp");
            // S/gob-lku/14.08.2103/P1046
            //DHLTrackingTabele.SETFILTER("Sale Order Code",'<>%1','');
            IF UPSTrackingTabele."ReferenceNumber Value" <> '' THEN
              DHLTrackingTabele.SETRANGE("Document No.",COPYSTR(UPSTrackingTabele."ReferenceNumber Value",1,
                    STRLEN(UPSTrackingTabele."ReferenceNumber Value")-3))
            ELSE
              DHLTrackingTabele.SETFILTER("Document No.",'<>%1','');
            // E/gob-lku/14.08.2103/P1046
            DHLTrackingTabele.SETRANGE("Document Type",DHLTrackingTabele."Document Type"::Order);
            // E/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETRANGE("Shipping Agent",'UPS');
            DHLTrackingTabele.SETRANGE("Docdate Status Code",'21');
            // S/gob-lku/31.07.2013/P1046
            //DHLTrackingTabele.SETFILTER("Sale Order Code",'<>%1','');
            //DHLTrackingTabele.SETRANGE("Sales Doc Type",DHLTrackingTabele."Sales Doc Type"::Order);
            // E/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETFILTER(DHLTrackingTabele."Docdata Status Description",'=%1',
             UPSTrackingTabele.CustomerContext);
             DHLTrackingTabele.SETRANGE("Status Event",UPSTrackingTabele."StatusType Code");
             DHLTrackingTabele.SETRANGE("Final Status UPS",FALSE);
             DHLTrackingTabele.SETRANGE("Imported over UPS API",TRUE);
            // S/gob-lku/25.07.2013/P1046
            //IF DHLTrackingTabele.FINDFIRST THEN BEGIN
            IF DHLTrackingTabele.FIND('-') THEN BEGIN
            // E/gob-lku/25.07.2013/P1046
              REPEAT
                EVALUATE(ActivitiyDateVariable,COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                EVALUATE(ActivityTimeVariable,UPSTrackingTabele."Activity Time");
                DHLTrackingTabele."Time Stamp" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                DHLTrackingTabele."Import Time Stamp" := CURRENTDATETIME;
                //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
                {
                //H0777  28.01.14  MBY  ----------------------------
                DHLTrackingTabele.MODIFY;
                //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
                }
                DHLTrackingTabele.MODIFY(TRUE);
                //H0777  28.01.14  MBY  ----------------------------
              UNTIL DHLTrackingTabele.NEXT = 0;
              //S/P1133
              IF FPCGeneralSetup."Active Parcel Status History" IN
                [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
                FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old"]
              THEN BEGIN
              //E/P1133
                // S/gob-lku/31.07.2013/P1046
                //UPSTrackingTabele.Pass := TRUE;
                //UPSTrackingTabele.SalesLineNo := DHLTrackingTabele."Line No.";
                //UPSTrackingTabele.DHLParcelHistEntryNo := DHLTrackingTabele."Entry No.";
                //UPSTrackingTabele.MODIFY;
                // S/P1082
                UPSTrackingTbl2.GET(UPSTrackingTabele."Entry no.");
                // E/P1082
                UPSTrackingTbl2.Pass := TRUE;
                UPSTrackingTbl2.SalesLineNo := DHLTrackingTabele."Document Line No.";
                UPSTrackingTbl2.DHLParcelHistEntryNo := DHLTrackingTabele."Entry No.";
                UPSTrackingTbl2.MODIFY;
                // E/gob-lku/31.07.2013/P1046
              //S/P1133
              END;
              //E/P1133
            END;
          //S/P1133
          END;

          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
            FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
          THEN BEGIN
            ParcelStatusHistory.RESET;
            ParcelStatusHistory.SETCURRENTKEY("Document No.","Document Line No.","Document Type");
            IF UPSTrackingTabele."ReferenceNumber Value" <> '' THEN
              ParcelStatusHistory.SETRANGE("Document No.",
              COPYSTR(UPSTrackingTabele."ReferenceNumber Value",1,STRLEN(UPSTrackingTabele."ReferenceNumber Value")-3))
            ELSE
              ParcelStatusHistory.SETFILTER("Document No.",'<>%1','');
            ParcelStatusHistory.SETRANGE("Document Type",ParcelStatusHistory."Document Type"::Order);
            ParcelStatusHistory.SETRANGE("Shipping Agent Code",'UPS');
            //H1851  27.11.14  MBY  +++++++++++++++++++++++++
            //ParcelStatusHistory.SETRANGE("Status Sub Code",'21');
            ParcelStatusHistory.SETFILTER("Status Sub Code",'21|31');
            //H1851  27.11.14  MBY  -------------------------
            ParcelStatusHistory.CALCFIELDS("Status Description","Status Sub Description");
            ParcelStatusHistory.SETFILTER(ParcelStatusHistory."Status Sub Description",'=%1',UPSTrackingTabele.CustomerContext);
            ParcelStatusHistory.SETRANGE("Status Code",UPSTrackingTabele."StatusType Code");
            // S/P1186
            //ParcelStatusHistory.SETRANGE("Import API",ParcelStatusHistory."Import API"::UPS);
            // E/P1186
            IF ParcelStatusHistory.FIND('-') THEN BEGIN
              REPEAT
                EVALUATE(ActivitiyDateVariable,
                  COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                  COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                  COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                EVALUATE(ActivityTimeVariable,UPSTrackingTabele."Activity Time");
                // S/P1232
                //ParcelStatusHistory."Timestamp Insert" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                //ParcelStatusHistory."Timestamp Interface" := CURRENTDATETIME;
                ParcelStatusHistory."Timestamp Insert" := CURRENTDATETIME;
                ParcelStatusHistory."Timestamp Interface" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                // E/P1232
                // S/P1228
                //ParcelStatusHistory.MODIFY;
                ParcelStatusHistory.MODIFY(TRUE);
                // E/P1228
              UNTIL ParcelStatusHistory.NEXT = 0;
              //S/P1133
              IF FPCGeneralSetup."Active Parcel Status History" IN
                [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
                FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
              THEN BEGIN
              //E/P1133
                UPSTrackingTbl2.GET(UPSTrackingTabele."Entry no.");
                UPSTrackingTbl2.Pass := TRUE;
                UPSTrackingTbl2.SalesLineNo := ParcelStatusHistory."Document Line No.";
                UPSTrackingTbl2.DHLParcelHistEntryNo := ParcelStatusHistory."Entry No.";
                UPSTrackingTbl2.MODIFY;
              //S/P1133
              END;
              //E/P1133
            END;
          END;
          //E/P1133
        UNTIL UPSTrackingTabele.NEXT = 0;
      END;

      UPSTrackingTabele.RESET;
      // S/gob-lku/31.07.2013/P1046
      UPSTrackingTabele.SETCURRENTKEY(Pass);
      // E/gob-lku/31.07.2013/P1046
      UPSTrackingTabele.SETRANGE(Pass,FALSE);
      // S/gob-lku/25.07.2013/P1046
      //IF UPSTrackingTabele.FINDFIRST THEN BEGIN
      IF UPSTrackingTabele.FIND('-') THEN BEGIN
      // E/gob-lku/25.07.2013/P1046
        REPEAT
          //S/P1117
          //S/P1133
          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New"]
          THEN BEGIN
          //E/P1133
            DHLTrackingTabele.RESET;
            // S/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETCURRENTKEY("Document No.","Document Line No.","Document Type","Time Stamp");
            // S/gob-lku/14.08.2103/P1046
            //DHLTrackingTabele.SETFILTER("Sale Order Code",'<>%1','');
            IF UPSTrackingTabele."ReferenceNumber Value" <> '' THEN
              DHLTrackingTabele.SETRANGE("Document No.",COPYSTR(UPSTrackingTabele."ReferenceNumber Value",1,
                    STRLEN(UPSTrackingTabele."ReferenceNumber Value")-3))
            ELSE
              DHLTrackingTabele.SETFILTER("Document No.",'<>%1','');
            // E/gob-lku/14.08.2103/P1046
            DHLTrackingTabele.SETRANGE("Document Type",DHLTrackingTabele."Document Type"::Order);
            DHLTrackingTabele.SETFILTER("Time Stamp",'<>%1',0DT);
            // E/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETRANGE("Shipping Agent",'UPS');
            // S/gob-lku/31.07.2013/P1046
            //DHLTrackingTabele.SETFILTER("Time Stamp",'<>%1',0DT);
            // E/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETRANGE("Docdate Status Code",'21');
            // S/gob-lku/31.07.2013/P1046
            //DHLTrackingTabele.SETFILTER("Sale Order Code",'<>%1','');
            //DHLTrackingTabele.SETRANGE("Sales Doc Type",DHLTrackingTabele."Sales Doc Type"::Order);
            // E/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETFILTER(DHLTrackingTabele."Docdata Status Description",'=%1',
             UPSTrackingTabele.CustomerContext);
             DHLTrackingTabele.SETRANGE("Final Status UPS",FALSE);
             DHLTrackingTabele.SETRANGE("Imported over UPS API",FALSE);
            // S/gob-lku/25.07.2013/P1046
            //IF DHLTrackingTabele.FINDFIRST THEN BEGIN
            IF DHLTrackingTabele.FIND('-') THEN BEGIN
            // E/gob-lku/25.07.2013/P1046
              REPEAT
                FindLastEntryNoInDHL.RESET;
                 FindLastEntryNoInDHL.FINDLAST;
                //S/P1133
                IF FPCGeneralSetup."Active Parcel Status History" IN
                  [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
                  FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old"]
                THEN BEGIN
                //E/P1133
                  // S/gob-lku/31.07.2013/P1046
                  //UPSTrackingTabele.Pass := TRUE;
                  //UPSTrackingTabele.DHLParcelHistEntryNo := FindLastEntryNoInDHL."Entry No." + 1;
                  //UPSTrackingTabele.SalesLineNo := DHLTrackingTabele."Line No.";
                  //UPSTrackingTabele.MODIFY;
                  // S/P1082
                  UPSTrackingTbl2.GET(UPSTrackingTabele."Entry no.");
                  // E/P1082
                  UPSTrackingTbl2.Pass := TRUE;
                  UPSTrackingTbl2.DHLParcelHistEntryNo := FindLastEntryNoInDHL."Entry No." + 1;
                  UPSTrackingTbl2.SalesLineNo := DHLTrackingTabele."Document Line No.";
                  UPSTrackingTbl2.MODIFY;
                // E/gob-lku/31.07.2013/P1046
                //S/P1133
                END;
                //E/P1133

                DHLTrackingTabeleInsertNew.INIT;
                DHLTrackingTabeleInsertNew."Entry No." := FindLastEntryNoInDHL."Entry No." + 1;
                // S/gob-lku/14.08.2013/P1046
                DHLTrackingTabeleInsertNew.INSERT;
                // E/gob-lku/14.08.2013/P1046
                DHLTrackingTabeleInsertNew."DHL Shipment Code" := '';
                DHLTrackingTabeleInsertNew."Account Number" := UPSTrackingTabele.ShipperNumber;
                DHLTrackingTabeleInsertNew."Production Line"       := '';
                DHLTrackingTabeleInsertNew.Product := '';
                TodayTimeToxport := CURRENTDATETIME;

                EVALUATE(ActivitiyDateVariable,COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                EVALUATE(ActivityTimeVariable,UPSTrackingTabele."Activity Time");

                // S/gob-lku/25.07.2013/P1046
                //DHLTrackingTabele."Time Stamp" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                DHLTrackingTabeleInsertNew."Time Stamp" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                // E/gob-lku/25.07.2013/P1046
                DHLTrackingTabeleInsertNew."Import Time Stamp" := TodayTimeToxport;
                DHLTrackingTabeleInsertNew."Detection Location" := '';
                DHLTrackingTabeleInsertNew."Country of Origin" := UPSTrackingTabele."Shipper CountryCode";
                DHLTrackingTabeleInsertNew."Piece-Code (Identifier)" := '';
                DHLTrackingTabeleInsertNew."Commit at Date" := TODAY;
                DHLTrackingTabeleInsertNew."Status Event" := UPSTrackingTabele."StatusType Code";
                DHLTrackingTabeleInsertNew."Status Code" := '';
                DHLTrackingTabeleInsertNew."Standart Event" := '';
                DHLTrackingTabeleInsertNew."Reference Number" := UPSTrackingTabele."ReferenceNumber Code";
                DHLTrackingTabeleInsertNew."Recipient Name Is" := '';
                DHLTrackingTabeleInsertNew."Recipient Name Target" := '';
                DHLTrackingTabeleInsertNew."Routing Code" := '';
                DHLTrackingTabeleInsertNew."Return Policies (Y/N)" := FALSE;
                EVALUATE(DHLTrackingTabeleInsertNew."Delivery Date",COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                                                                    COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                                                                    COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                EVALUATE(DHLTrackingTabeleInsertNew."Pickup Date",COPYSTR(UPSTrackingTabele.PickupDate,7,2)+
                                                                  COPYSTR(UPSTrackingTabele.PickupDate,5,2)+
                                                                  COPYSTR(UPSTrackingTabele.PickupDate,1,4));

                DHLTrackingTabeleInsertNew."Document No." := DHLTrackingTabele."Document No.";
                DHLTrackingTabeleInsertNew."Document Type" := DHLTrackingTabele."Document Type";
                DHLTrackingTabeleInsertNew."Document Line No." := DHLTrackingTabele."Document Line No.";
                DHLTrackingTabeleInsertNew."Shipment Date" := DHLTrackingTabele."Shipment Date";
                DHLTrackingTabeleInsertNew."Purchase Order Code" := DHLTrackingTabele."Purchase Order Code";
                DHLTrackingTabeleInsertNew."PO Line No." := DHLTrackingTabele."PO Line No.";
                DHLTrackingTabeleInsertNew."Current Status" := DHLTrackingTabele."Current Status";
                DHLTrackingTabeleInsertNew."Rhenus Entry" := DHLTrackingTabele."Rhenus Entry";
                DHLTrackingTabeleInsertNew.DeleteMe := DHLTrackingTabele.DeleteMe;
                DHLTrackingTabeleInsertNew."Status Drop Shipment" :=  DHLTrackingTabele."Status Drop Shipment";
                DHLTrackingTabeleInsertNew."Drop Shipment Status Desc." := DHLTrackingTabele."Drop Shipment Status Desc.";
                DHLTrackingTabeleInsertNew."Import Time Stamp" := CURRENTDATETIME;
                DHLTrackingTabeleInsertNew."Time Difference" := 0;
                DHLTrackingTabeleInsertNew."Status DHL" := DHLTrackingTabele."Status DHL";
                DHLTrackingTabeleInsertNew."Order Date" := DHLTrackingTabele."Order Date";
                DHLTrackingTabeleInsertNew."Shipment through" := DHLTrackingTabele."Shipment through";
                DHLTrackingTabeleInsertNew."Shipping Agent" := DHLTrackingTabele."Shipping Agent";
                //DHLTrackingTabeleInsertNew."VIR Status Comment" := DHLTrackingTabele."VIR Status Comment";
                DHLTrackingTabeleInsertNew."Status DHL HD" := DHLTrackingTabele."Status DHL HD";
                DHLTrackingTabeleInsertNew."Status Docdata" := DHLTrackingTabele."Status Docdata";
                DHLTrackingTabeleInsertNew."Docdate Status Code" := DHLTrackingTabele."Docdate Status Code";
                DHLTrackingTabeleInsertNew."DHL HD Status Code" := DHLTrackingTabele."DHL HD Status Code";
                DHLTrackingTabeleInsertNew."Docdata Status Description" := DHLTrackingTabele."Docdata Status Description";
                IF UPSTrackingTabele.ResponseStatusCode = '1' THEN BEGIN
                  DHLTrackingTabeleInsertNew."DHL HD Status Description" := COPYSTR(UPSTrackingTabele."StatusType Description",1,50);
                  DHLTrackingTabele."DHL HD Status Description" := COPYSTR(UPSTrackingTabele."StatusType Description",1,50);
                  DHLTrackingTabele.MODIFY;
                END ELSE BEGIN
                  DHLTrackingTabeleInsertNew."DHL HD Status Description" := COPYSTR(UPSTrackingTabele.ErrorDescription,1,50);
                  DHLTrackingTabele."DHL HD Status Description" := COPYSTR(UPSTrackingTabele.ErrorDescription,1,50);
                  DHLTrackingTabele.MODIFY;
                END;

                DHLTrackingTabeleInsertNew."Imported over DHL API" := DHLTrackingTabele."Imported over DHL API";
                DHLTrackingTabeleInsertNew."Imported over UPS API" := TRUE;
                DHLTrackingTabeleInsertNew."Status RIC Name" := DHLTrackingTabele."Status RIC Name";
                DHLTrackingTabeleInsertNew."Status Event Name" := DHLTrackingTabele."Status Event Name";
                DHLTrackingTabeleInsertNew."Rhenus Status Description" := DHLTrackingTabele."Rhenus Status Description";



                IF UPSTrackingTabele."StatusType Code" = 'D' THEN BEGIN
                  DHLTrackingTabeleInsertNew."Final Status UPS" := TRUE;
                  // S/gob-lku/31.07.2013/P1046
                  //DHLTrackingTabele."Final Status UPS" := TRUE;
                  //DHLTrackingTabele.MODIFY;
                  SetFinalStatus(DHLTrackingTabele."Document No.",DHLTrackingTabele."Document Type",
                    DHLTrackingTabele."Document Line No.");
                  // E/gob-lku/31.07.2013/P1046
                  DHLTrackingTabele.MODIFY;
                END;

                IF UPSTrackingTabele.AlternateTrackingNumber <> '' THEN BEGIN
                  DHLTrackingTabeleInsertNew."Final Status UPS" := TRUE;
                  // S/gob-lku/31.07.2013/P1046
                  //DHLTrackingTabele."Final Status UPS" := TRUE;
                  //DHLTrackingTabele.MODIFY;
                  SetFinalStatus(DHLTrackingTabele."Document No.",DHLTrackingTabele."Document Type",
                    DHLTrackingTabele."Document Line No.");
                  // E/gob-lku/31.07.2013/P1046
                  DHLTrackingTabele.AlternateTrackinNumberUPS := UPSTrackingTabele.AlternateTrackingNumber;
                  DHLTrackingTabeleInsertNew.AlternateTrackinNumberUPS := UPSTrackingTabele.AlternateTrackingNumber;
                  DHLTrackingTabele.MODIFY;
                END;

                // S/gob-lku/14.08.2013/P1046
                //DHLTrackingTabeleInsertNew.INSERT;
                // E/gob-lku/14.08.2013/P1046
                //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
                {
                //H0686  04.12.13  MBY  ----------------------------
                DHLTrackingTabeleInsertNew.MODIFY;
                //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
                }
                DHLTrackingTabeleInsertNew.MODIFY(TRUE);
                //H0686  04.12.13  MBY  ----------------------------
              UNTIL DHLTrackingTabele.NEXT = 0;
            END;
          //S/P1133
          END;

          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
            FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
          THEN BEGIN
          //E/P1133
            ParcelStatusHistory.RESET;
            ParcelStatusHistory.SETCURRENTKEY("Document No.","Document Line No.","Document Type");
            IF UPSTrackingTabele."ReferenceNumber Value" <> '' THEN
              ParcelStatusHistory.SETRANGE(
                "Document No.",
                COPYSTR(UPSTrackingTabele."ReferenceNumber Value",1,STRLEN(UPSTrackingTabele."ReferenceNumber Value")-3))
            ELSE
              ParcelStatusHistory.SETFILTER("Document No.",'<>%1','');
            ParcelStatusHistory.SETRANGE("Document Type",ParcelStatusHistory."Document Type"::Order);
            ParcelStatusHistory.SETFILTER("Timestamp Insert",'<>%1',0DT);
            ParcelStatusHistory.SETRANGE("Shipping Agent Code",'UPS');
            //H1851,P1186,P1204  27.11.14  MBY  +++++++++++++++++++++++++++++++++++++++++++
            //ParcelStatusHistory.SETRANGE("Status Sub Code",'21');
            ParcelStatusHistory.SETFILTER("Status Sub Code",'21|31');
            ParcelStatusHistory.SETRANGE("Is Final Status",FALSE);
            //H1851,P1186,P1204  27.11.14  MBY  -------------------------------------------
            ParcelStatusHistory.SETFILTER("Used Interface",'<>%1',ParcelStatusHistory."Used Interface"::UPS);
            IF ParcelStatusHistory.FIND('-') THEN BEGIN
              REPEAT
                CLEAR(ParcelStatusHistoryNew);
                ParcelStatusHistoryNew.INIT;
                UseEntryNo := ParcelStatusHistoryNew.GetNextEntryNo(TRUE);
                ParcelStatusHistoryNew."Entry No." := UseEntryNo;
                ParcelStatusHistoryNew.INSERT;
                //S/P1133
                IF FPCGeneralSetup."Active Parcel Status History" IN
                  [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
                  FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
                THEN BEGIN
                //E/P1133
                  UPSTrackingTbl2.GET(UPSTrackingTabele."Entry no.");
                  UPSTrackingTbl2.Pass := TRUE;
                  UPSTrackingTbl2.DHLParcelHistEntryNo := UseEntryNo;
                  UPSTrackingTbl2.SalesLineNo := ParcelStatusHistory."Document Line No.";
                  UPSTrackingTbl2.MODIFY;
                //S/P1133
                END;
                //E/P1133
                ParcelStatusHistoryNew."Document Type" := ParcelStatusHistory."Document Type";
                ParcelStatusHistoryNew."Document No." := ParcelStatusHistory."Document No.";
                ParcelStatusHistoryNew."Document Line No." := ParcelStatusHistory."Document Line No.";
                ParcelStatusHistoryNew."Purchase Doc. Type" := ParcelStatusHistory."Purchase Doc. Type";
                ParcelStatusHistoryNew."Purchase Doc. No." := ParcelStatusHistory."Purchase Doc. No.";
                ParcelStatusHistoryNew."Purchase Doc. Line No." := ParcelStatusHistory."Purchase Doc. Line No.";
                ParcelStatusHistoryNew."Direction of Information" := ParcelStatusHistory."Direction of Information"::Incoming;
                ParcelStatusHistoryNew."Used Interface" := ParcelStatusHistory."Used Interface"::UPS;
                // S/P1186
                ParcelStatusHistoryNew."Status Code" := UPSTrackingTabele."StatusType Code";
                ParcelStatusHistoryNew."Status Sub Code" := ParcelStatusHistory."Status Sub Code";
                // E/P1186
                ParcelStatusHistoryNew."Account No." := UPSTrackingTabele.ShipperNumber;
                EVALUATE(ActivitiyDateVariable,COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                EVALUATE(ActivityTimeVariable,UPSTrackingTabele."Activity Time");
                ParcelStatusHistoryNew."Timestamp Insert" := CURRENTDATETIME;
                ParcelStatusHistoryNew."Timestamp Interface" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                // S/P1170
                IF ParcelStatusHistoryNew."Timestamp Interface" <> 0DT THEN
                // E/P1170
                  ParcelStatusHistoryNew."Timestamp Difference" :=
                    ParcelStatusHistoryNew."Timestamp Insert" -
                    ParcelStatusHistoryNew."Timestamp Interface";
                // S/P1170
                IF ParcelStatusHistoryNew."Timestamp Difference" < 0 THEN
                  ParcelStatusHistoryNew."Timestamp Difference" := ParcelStatusHistoryNew."Timestamp Difference" * -1;
                // E/P1170
                ParcelStatusHistoryNew."Date Commit" := TODAY;
                EVALUATE(ParcelStatusHistoryNew."Date Delivery",
                  COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                  COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                  COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                EVALUATE(ParcelStatusHistoryNew."Date Pickup",
                  COPYSTR(UPSTrackingTabele.PickupDate,7,2)+
                  COPYSTR(UPSTrackingTabele.PickupDate,5,2)+
                  COPYSTR(UPSTrackingTabele.PickupDate,1,4));
                ParcelStatusHistoryNew."Shipping Agent Code" := ParcelStatusHistory."Shipping Agent Code";
                // S/P1204
                //ParcelStatusHistoryNew."Comment Part 1" := UPSTrackingTabele."ReferenceNumber Code";
                ParcelStatusHistoryNew."Tracking Code" := UPSTrackingTabele.TrackingNumber;
                // E/P1204
                IF UPSTrackingTabele.ResponseStatusCode = '1' THEN BEGIN
                  ParcelStatusHistoryNew."Comment Part 2" := COPYSTR(UPSTrackingTabele."StatusType Description",1,50);
                  ParcelStatusHistory."Comment Part 2" := COPYSTR(UPSTrackingTabele."StatusType Description",1,50);
                  // S/P1228
                  //ParcelStatusHistory.MODIFY;
                  ParcelStatusHistory.MODIFY(TRUE);
                  // E/P1228
                END ELSE BEGIN
                  ParcelStatusHistoryNew."Comment Part 2" := COPYSTR(UPSTrackingTabele.ErrorDescription,1,50);
                  ParcelStatusHistory."Comment Part 2" := COPYSTR(UPSTrackingTabele.ErrorDescription,1,50);
                  // S/P1228
                  //ParcelStatusHistory.MODIFY;
                  ParcelStatusHistory.MODIFY(TRUE);
                  // E/P1228
                END;
                // S/P1204
                { ****
                IF UPSTrackingTabele.AlternateTrackingNumber <> '' THEN BEGIN
                  ParcelStatusHistoryNew."Tracking Code" := UPSTrackingTabele.AlternateTrackingNumber;
                  ParcelStatusHistory."Tracking Code" := UPSTrackingTabele.AlternateTrackingNumber;
                  ParcelStatusHistory.MODIFY;
                END;
                **** }
                IF UPSTrackingTabele.AlternateTrackingNumber <> '' THEN BEGIN
                  ParcelStatusHistoryNew."Comment Part 1" := 'Alt. Track. No.: ' + UPSTrackingTabele.AlternateTrackingNumber;
                  ParcelStatusHistory."Comment Part 4" := 'Alt. Track. No.: ' + UPSTrackingTabele.AlternateTrackingNumber;
                  // S/P1228
                  //ParcelStatusHistory.MODIFY;
                  ParcelStatusHistory.MODIFY(TRUE);
                  // E/P1228
                END;
                IF UPSTrackingTabele."ReferenceNumber Code" <> '' THEN
                  ParcelStatusHistoryNew."Comment Part 3" := 'Ref. No.: ' + UPSTrackingTabele."ReferenceNumber Code";
                // E/P1204
                //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
                {
                //H0777  28.01.14  MBY  ----------------------------
                ParcelStatusHistoryNew.MODIFY;
                //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
                }
                ParcelStatusHistoryNew.MODIFY(TRUE);
                //H0777  28.01.14  MBY  ----------------------------
                // S/P1204
                // S/P1180
                //CLEAR(CUParcelStatusHistoryMgmt);
                //CUParcelStatusHistoryMgmt.CheckIfArchivedOrder(ParcelStatusHistoryNew."Entry No.");
                // E/P1180
                CLEAR(IDForArchiving);
                IDForArchiving := ParcelStatusHistoryNew."Entry No.";
                IF (UPSTrackingTabele."StatusType Code" = 'D') OR
                   (UPSTrackingTabele.AlternateTrackingNumber <> '')
                THEN BEGIN
                  ParcelStatusHistoryNew."Is Final Status" := TRUE;
                  // S/P1228
                  //ParcelStatusHistoryNew.MODIFY;
                  ParcelStatusHistoryNew.MODIFY(TRUE);
                  // E/P1228
                  SetFinalStatusNew(
                    ParcelStatusHistory."Document No.",
                    ParcelStatusHistory."Document Type",
                    ParcelStatusHistory."Document Line No.");
                END;
                CLEAR(CUParcelStatusHistoryMgmt);
                CUParcelStatusHistoryMgmt.CheckIfArchivedOrder(IDForArchiving);
                // E/P1204
              UNTIL ParcelStatusHistory.NEXT = 0;
            END;
          //S/P1133
          END;
          //E/P1133
          //E/P1117
        UNTIL UPSTrackingTabele.NEXT = 0;
      END;

      //S/P11117
      //S/P1133
      IF FPCGeneralSetup."Active Parcel Status History" IN
        [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New"]
      THEN BEGIN
      //E/P1133
        DHLTrackingTabele.RESET;
        // S/gob-lku/31.07.2013/P1046
        DHLTrackingTabele.SETCURRENTKEY("Document No.","Document Line No.","Document Type","Time Stamp");
        DHLTrackingTabele.SETFILTER("Document No.",'<>%1','');
        DHLTrackingTabele.SETRANGE("Document Type",DHLTrackingTabele."Document Type"::Order);
        DHLTrackingTabele.SETFILTER("Time Stamp",'=%1',0DT);
        // E/gob-lku/31.07.2013/P1046
        DHLTrackingTabele.SETRANGE("Shipping Agent",'UPS');
        // S/gob-lku/31.07.2013/P1046
        //DHLTrackingTabele.SETFILTER("Time Stamp",'=%1',0DT);
        // E/gob-lku/31.07.2013/P1046
        DHLTrackingTabele.SETRANGE("Docdate Status Code",'21');
        // S/gob-lku/31.07.2013/P1046
        //DHLTrackingTabele.SETFILTER("Sale Order Code",'<>%1','');
        //DHLTrackingTabele.SETRANGE("Sales Doc Type",DHLTrackingTabele."Sales Doc Type"::Order);
        // E/gob-lku/31.07.2013/P1046
        DHLTrackingTabele.SETFILTER(DHLTrackingTabele."Docdata Status Description",'=%1',
        UPSTrackingTabele.CustomerContext);
        DHLTrackingTabele.SETRANGE("Imported over UPS API",TRUE);
        IF DHLTrackingTabele.FIND('-') THEN BEGIN
                EVALUATE(ActivitiyDateVariable,COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                EVALUATE(ActivityTimeVariable,UPSTrackingTabele."Activity Time");
          //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
          {
          //H0777  28.01.14  MBY  ----------------------------
          DHLTrackingTabele.MODIFYALL("Time Stamp",CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable));
          //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
          }
          DHLTrackingTabele.MODIFYALL("Time Stamp",CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable),TRUE);
          //H0777  28.01.14  MBY  ----------------------------
        END;
      //S/P1133
      END;

      IF FPCGeneralSetup."Active Parcel Status History" IN
        [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
        FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
      THEN BEGIN
      //E/P1133
        ParcelStatusHistory.RESET;
        ParcelStatusHistory.SETCURRENTKEY(
          "Document No.","Document Line No.","Document Type");
        ParcelStatusHistory.SETFILTER("Document No.",'<>%1','');
        ParcelStatusHistory.SETRANGE("Document Type",ParcelStatusHistory."Document Type"::Order);
        ParcelStatusHistory.SETFILTER("Timestamp Insert",'=%1',0DT);
        ParcelStatusHistory.SETRANGE("Shipping Agent Code",'UPS');
        //H1851,P1186  27.11.14  MBY  +++++++++++++++++++++++++++++++++++++++++++
        //ParcelStatusHistory.SETRANGE("Status Sub Code",'21');
        ParcelStatusHistory.SETFILTER("Status Sub Code",'21|31');
        //H1851,P1186  27.11.14  MBY  -------------------------------------------
        ParcelStatusHistory.SETRANGE("Used Interface",ParcelStatusHistory."Used Interface"::UPS);
        IF ParcelStatusHistory.FIND('-') THEN BEGIN
          EVALUATE(ActivitiyDateVariable,
            COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
            COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
            COPYSTR(UPSTrackingTabele."Activity Date",1,4));
          EVALUATE(ActivityTimeVariable,
            UPSTrackingTabele."Activity Time");
          // S/P1228
          //ParcelStatusHistory.MODIFYALL("Timestamp Interface",CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable));
          ParcelStatusHistory.MODIFYALL("Timestamp Interface",CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable),TRUE);
          // E/P1228
        END;
      //S/P1133
      END;
      //E/P1133
      //E/P1117

      InsertAlernateTrackinNummerMan(DocumentNo);
    END;

    PROCEDURE CopyFromTempToArchiv@1000000004();
    VAR
      FileRecToTransfer@1000000000 : Record 2000000022;
      FPCSetup@1000000001 : Record 50055;
    BEGIN
      FPCGeneralSetup.GET;
      FileRecToTransfer.SETRANGE(Path,FPCGeneralSetup."UPS Temp Archiv path");
      FileRecToTransfer.SETRANGE("Is a file",TRUE);
      FileRecToTransfer.SETFILTER(Name,'*.xml');
      IF FileRecToTransfer.FIND('-') THEN BEGIN
        REPEAT
          FILE.COPY(FPCGeneralSetup."UPS Temp Archiv path"+FileRecToTransfer.Name,
          FPCGeneralSetup."UPS Archiv Tracking path"+FileRecToTransfer.Name);
          FILE.ERASE(FPCGeneralSetup."UPS Temp Archiv path"+FileRecToTransfer.Name);
        UNTIL FileRecToTransfer.NEXT = 0;
      END;
      //H1326  03.07.14  MBY  +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
      //InsertAlernateTrackinNummer;
      //H1326  03.07.14  MBY  ---------------------------------------------------------------------
    END;

    PROCEDURE InsertAlernateTrackinNummer@1000000008();
    VAR
      DHLStatus@1000000000 : Record 50021;
      FindLastDHLParcelHistory@1000000001 : Record 50021;
      DHLStatusInsert@1000000002 : Record 50021;
      DHLStatusModify@1000000003 : Record 50021;
      i@1000000004 : Integer;
    BEGIN
      //S/P1133
      FPCGeneralSetup.GET;

      IF FPCGeneralSetup."Active Parcel Status History" IN
        [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New"]
      THEN BEGIN
      //E/P1133
        DHLStatus.RESET;
        // S/gob-lku/31.07.2013/P1046
        DHLStatus.SETCURRENTKEY("Document No.","Document Line No.","Document Type","Time Stamp");
        DHLStatus.SETFILTER("Document No.",'<>%1','');
        DHLStatus.SETRANGE("Document Type",DHLStatus."Document Type"::Order);
        DHLStatus.SETFILTER("Time Stamp",'<>%1',0DT);
        // E/gob-lku/31.07.2013/P1046
        DHLStatus.SETRANGE("Shipping Agent",'UPS');
        // S/gob-lku/31.07.2013/P1046
        //DHLStatus.SETFILTER("Time Stamp",'<>%1',0DT);
        // E/gob-lku/31.07.2013/P1046
        DHLStatus.SETRANGE("Docdate Status Code",'21');
        // S/gob-lku/31.07.2013/P1046
        //DHLStatus.SETFILTER("Sale Order Code",'');
        //DHLStatus.SETRANGE("Sales Doc Type",DHLStatus."Sales Doc Type"::Order);
        // E/gob-lku/31.07.2013/P1046
        DHLStatus.SETRANGE("Final Status UPS",TRUE);
        DHLStatus.SETRANGE("Imported over UPS API",FALSE);
        DHLStatus.SETFILTER(AlternateTrackinNumberUPS,'<>%1','');
        DHLStatus.SETRANGE("AlternateTrackinNumberUPS Pass",FALSE);
        DHLStatus.SETRANGE(InsertingAlternateNumer,FALSE);
        IF DHLStatus.FIND('-') THEN BEGIN
          REPEAT
            IF FindLastDHLParcelHistory.FINDLAST THEN BEGIN
              i := FindLastDHLParcelHistory."Entry No." + 1;
            END ELSE BEGIN
              i := 0;
            END;
            DHLStatusInsert.INIT;
              DHLStatusInsert.TRANSFERFIELDS(DHLStatus);
              DHLStatusInsert."Entry No." := i;
              DHLStatusInsert.AlternateTrackinNumberUPS := COPYSTR(DHLStatus."Docdata Status Description",14,20);
              DHLStatusInsert."Docdata Status Description" := 'Tracking ID: '+DHLStatus.AlternateTrackinNumberUPS;
              DHLStatusInsert."DHL HD Status Description" := '';
              DHLStatusInsert.InsertingAlternateNumer := TRUE;
              DHLStatusInsert."Imported over UPS API" := FALSE;
              DHLStatusInsert."Final Status UPS" := FALSE;
            DHLStatusInsert.INSERT;
            IF DHLStatusModify.GET(DHLStatus."Entry No.") THEN BEGIN
              DHLStatusModify."AlternateTrackinNumberUPS Pass" := TRUE;
              DHLStatusModify.MODIFY;
            END;

          UNTIL DHLStatus.NEXT = 0;
        END;
      //S/P1133
      END;
      //E/P1133

      CreateTracRequestToUPSAlt;
    END;

    PROCEDURE InsertAlernateTrackinNummerMan@1000000005(DocumentNo@1000000005 : Code[20]);
    VAR
      DHLStatus@1000000000 : Record 50021;
      FindLastDHLParcelHistory@1000000001 : Record 50021;
      DHLStatusInsert@1000000002 : Record 50021;
      DHLStatusModify@1000000003 : Record 50021;
      i@1000000004 : Integer;
    BEGIN
      //S/P1133
      FPCGeneralSetup.GET;

      IF FPCGeneralSetup."Active Parcel Status History" IN
        [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New"]
      THEN BEGIN
      //E/P1133
        DHLStatus.RESET;
        // S/gob-lku/31.07.2013/P1046
        DHLStatus.SETCURRENTKEY("Document No.","Document Line No.","Document Type","Time Stamp");
        DHLStatus.SETFILTER("Document No.",DocumentNo);
        DHLStatus.SETRANGE("Document Type",DHLStatus."Document Type"::Order);
        DHLStatus.SETFILTER("Time Stamp",'<>%1',0DT);
        // E/gob-lku/31.07.2013/P1046
        DHLStatus.SETRANGE("Shipping Agent",'UPS');
        // S/gob-lku/31.07.2013/P1046
        //DHLStatus.SETFILTER("Time Stamp",'<>%1',0DT);
        // E/gob-lku/31.07.2013/P1046
        DHLStatus.SETRANGE("Docdate Status Code",'21');
        // S/gob-lku/31.07.2013/P1046
        //DHLStatus.SETFILTER("Sale Order Code",DocumentNo);
        //DHLStatus.SETRANGE("Sales Doc Type",DHLStatus."Sales Doc Type"::Order);
        // E/gob-lku/31.07.2013/P1046
        DHLStatus.SETRANGE("Final Status UPS",TRUE);
        DHLStatus.SETRANGE("Imported over UPS API",FALSE);
        DHLStatus.SETFILTER(AlternateTrackinNumberUPS,'<>%1','');
        DHLStatus.SETRANGE("AlternateTrackinNumberUPS Pass",FALSE);
        DHLStatus.SETRANGE(InsertingAlternateNumer,FALSE);
        IF DHLStatus.FIND('-') THEN BEGIN
          REPEAT
            IF FindLastDHLParcelHistory.FINDLAST THEN BEGIN
              i := FindLastDHLParcelHistory."Entry No." + 1;
            END ELSE BEGIN
              i := 0;
            END;
            DHLStatusInsert.INIT;
              DHLStatusInsert.TRANSFERFIELDS(DHLStatus);
              DHLStatusInsert."Entry No." := i;
              DHLStatusInsert.AlternateTrackinNumberUPS := COPYSTR(DHLStatus."Docdata Status Description",14,20);
              DHLStatusInsert."Docdata Status Description" := 'Tracking ID: '+DHLStatus.AlternateTrackinNumberUPS;
              DHLStatusInsert."DHL HD Status Description" := '';
              DHLStatusInsert.InsertingAlternateNumer := TRUE;
              DHLStatusInsert."Imported over UPS API" := FALSE;
              DHLStatusInsert."Final Status UPS" := FALSE;
            DHLStatusInsert.INSERT;
            IF DHLStatusModify.GET(DHLStatus."Entry No.") THEN BEGIN
              DHLStatusModify."AlternateTrackinNumberUPS Pass" := TRUE;
              DHLStatusModify.MODIFY;
            END;

          UNTIL DHLStatus.NEXT = 0;
        END;
      //S/P1133
      END;
      //E/P1133

      CreateTrackingReqManuToUPSAlt(DocumentNo);
    END;

    PROCEDURE CreateTracRequestToUPSAlt@1000000013();
    VAR
      locautXmlHttp@1000000000 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{F6D90F16-9C73-11D3-B32E-00C04F990BB4}:'Microsoft XML, v6.0'.XMLHTTP";
      locautXmlDoc@1000000001 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{F6D90F11-9C73-11D3-B32E-00C04F990BB4}:'Microsoft XML, v6.0'.DOMDocument";
      TempTabDistinct@1000000002 : TEMPORARY Record 27;
      ParcelStatusHistory@1000000003 : Record 80013;
      ParcelStatusHistoryArchive@1000000004 : Record 50187;
    BEGIN
      CREATE(locautXmlDoc);
      CREATE(locautXmlHttp);
      FPCGeneralSetup.GET;
      FPCGeneralSetup.TESTFIELD("UPS Import Tracking path");
      FPCGeneralSetup.TESTFIELD("UPS Archiv Tracking path");

      TempTabDistinct.DELETEALL;

      //H1326  03.07.14  MBY  +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
      {
      //H1326  03.07.14  MBY  ---------------------------------------------------------------------

      //S/P1133
      CASE FPCGeneralSetup."Active Parcel Status History" OF
        FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old":
          BEGIN
      //E/P1133
            // S/gob-lku/31.07.2013/P1046
            DHLStatus.RESET;
            DHLStatus.SETCURRENTKEY("Sale Order Code","Line No.","Sales Doc Type","Time Stamp");
            DHLStatus.SETFILTER("Sale Order Code",'<>%1','');
            DHLStatus.SETRANGE("Sales Doc Type",DHLStatus."Sales Doc Type"::Order);
            DHLStatus.SETFILTER("Time Stamp",'<>%1',0DT);
            // E/gob-lku/31.07.2013/P1046
            DHLStatus.SETRANGE("Shipping Agent",'UPS');
            // S/gob-lku/31.07.2013/P1046
            //DHLStatus.SETFILTER("Time Stamp",'<>%1',0DT);
            // E/gob-lku/31.07.2013/P1046
            DHLStatus.SETRANGE("Docdate Status Code",'21');
            // S/gob-lku/31.07.2013/P1046
            //DHLStatus.SETFILTER("Sale Order Code",'');
            //DHLStatus.SETRANGE("Sales Doc Type",DHLStatus."Sales Doc Type"::Order);
            // E/gob-lku/31.07.2013/P1046
            DHLStatus.SETRANGE("Final Status UPS",FALSE);
            DHLStatus.SETRANGE("Imported over UPS API",FALSE);
            DHLStatus.SETRANGE(InsertingAlternateNumer,TRUE);

            //DHLStatus.SETRANGE("Imported over UPS API",FALSE);
            // S/gob-lku/25.07.2013/P1046
            //IF DHLStatus.FINDFIRST THEN BEGIN
            IF DHLStatus.FIND('-') THEN BEGIN
            // E/gob-lku/25.07.2013/P1046
              REPEAT
                IF NOT TempTabDistinct.GET(COPYSTR(DHLStatus."Docdata Status Description",14,20)) THEN BEGIN
                  TempTabDistinct.INIT;
                    TempTabDistinct."No." := COPYSTR(DHLStatus."Docdata Status Description",14,20);
                    TempTabDistinct."No. 2" := DHLStatus."Sale Order Code";
                    TempTabDistinct.Description := DHLStatus."Docdata Status Description";
                  TempTabDistinct.INSERT;
                END;
              UNTIL DHLStatus.NEXT=0;
            END;
      //S/P1133
          END;
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
        FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History":
          BEGIN
            ParcelStatusHistory.RESET;
            ParcelStatusHistory.SETCURRENTKEY("Sales Doc. No.","Sales Doc. Line No.","Sales Doc. Type");
            ParcelStatusHistory.SETFILTER("Sales Doc. No.",'<>%1','');
            ParcelStatusHistory.SETRANGE("Sales Doc. Type",ParcelStatusHistory."Sales Doc. Type"::Order);
            ParcelStatusHistory.SETFILTER("Timestamp Insert",'<>%1',0DT);
            // S/P1186
            //ParcelStatusHistory.SETRANGE("Used Interface",ParcelStatusHistory."Used Interface"::UPS);
            ParcelStatusHistory.SETFILTER("Used Interface",'<>%1',ParcelStatusHistory."Used Interface"::UPS);
            // E/P1186
            //H1851  27.11.14  MBY  +++++++++++++++++++++++++
            //ParcelStatusHistory.SETRANGE("Status Sub Code",'21');
            ParcelStatusHistory.SETFILTER("Status Sub Code",'21|31');
            //H1851  27.11.14  MBY  -------------------------
            // S/P1186
            //ParcelStatusHistory.SETFILTER("Import API",'<>%1',ParcelStatusHistory."Import API"::UPS);
            // S/P1204
            //ParcelStatusHistory.SETFILTER("Status Code",'<>%1','D');
            ParcelStatusHistory.SETRANGE("Is Final Status",FALSE);
            // E/P1204
            // E/P1186
            IF ParcelStatusHistory.FIND('-') THEN BEGIN
              //S/P1232
              //ParcelStatusHistory.CALCFIELDS("Status Description","Status Sub Description");
              // E/P1232
              REPEAT
                // S/P1232
                { ******
                IF NOT TempTabDistinct.GET(COPYSTR(ParcelStatusHistory."Status Description",14,20)) THEN BEGIN
                  TempTabDistinct.INIT;
                    TempTabDistinct."No." := COPYSTR(ParcelStatusHistory."Status Description",14,20);
                    TempTabDistinct."No. 2" := ParcelStatusHistory."Sales Doc. No.";
                    TempTabDistinct.Description := ParcelStatusHistory."Status Description";
                ***** }
                CLEAR(TmpTrackingCode);
                IF ParcelStatusHistory."Tracking Code" <> '' THEN
                  TmpTrackingCode := COPYSTR(ParcelStatusHistory."Tracking Code",1,20)
                ELSE BEGIN
                  TmpTrackingCode :=
                    COPYSTR(
                      ParcelStatusHistory."Comment Part 1",
                      STRPOS(ParcelStatusHistory."Comment Part 1",': ') + 2,
                      20);
                END;
                IF TmpTrackingCode <> '' THEN
                  IF NOT TempTabDistinct.GET(TmpTrackingCode) THEN BEGIN
                    TempTabDistinct."No." := TmpTrackingCode;
                    TempTabDistinct."No. 2" := ParcelStatusHistory."Sales Doc. No.";
                    TempTabDistinct.Description := COPYSTR(ParcelStatusHistory."Comment Part 1",1,50);
                // E/P1232
                    TempTabDistinct.INSERT;
                  END;
              UNTIL ParcelStatusHistory.NEXT=0;
            END;
            // S/P1232
            ParcelStatusHistoryArchive.RESET;
            ParcelStatusHistoryArchive.SETCURRENTKEY("Sales Doc. No.","Sales Doc. Line No.","Sales Doc. Type");
            ParcelStatusHistoryArchive.SETFILTER("Sales Doc. No.",'<>%1','');
            ParcelStatusHistoryArchive.SETRANGE("Sales Doc. Type",ParcelStatusHistoryArchive."Sales Doc. Type"::Order);
            ParcelStatusHistoryArchive.SETFILTER("Timestamp Insert",'<>%1',0DT);
            ParcelStatusHistoryArchive.SETFILTER("Used Interface",'<>%1',ParcelStatusHistoryArchive."Used Interface"::UPS);
            //H1851  27.11.14  MBY  +++++++++++++++++++++++++
            //ParcelStatusHistoryArchive.SETRANGE("Status Sub Code",'21');
            ParcelStatusHistoryArchive.SETFILTER("Status Sub Code",'21|31');
            //H1851  27.11.14  MBY  -------------------------
            ParcelStatusHistoryArchive.SETRANGE("Is Final Status",FALSE);
            IF ParcelStatusHistoryArchive.FIND('-') THEN BEGIN
              REPEAT
                CLEAR(TmpTrackingCode);
                IF ParcelStatusHistoryArchive."Tracking Code" <> '' THEN
                  TmpTrackingCode := COPYSTR(ParcelStatusHistoryArchive."Tracking Code",1,20)
                ELSE BEGIN
                  TmpTrackingCode :=
                    COPYSTR(
                      ParcelStatusHistoryArchive."Comment Part 1",
                      STRPOS(ParcelStatusHistoryArchive."Comment Part 1",': ') + 2,
                      20);
                END;
                IF TmpTrackingCode <> '' THEN
                  IF NOT TempTabDistinct.GET(TmpTrackingCode) THEN BEGIN
                    TempTabDistinct.INIT;
                    TempTabDistinct."No." := TmpTrackingCode;
                    TempTabDistinct."No. 2" := ParcelStatusHistoryArchive."Sales Doc. No.";
                    TempTabDistinct.Description := COPYSTR(ParcelStatusHistoryArchive."Comment Part 1",1,50);
                    TempTabDistinct.INSERT;
                  END;
              UNTIL ParcelStatusHistoryArchive.NEXT = 0;
            END;
            // E/P1232
          END;
      END;
      //E/P1133

      //H1326  03.07.14  MBY  +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
      }
      //H1326  03.07.14  MBY  ---------------------------------------------------------------------

      // S/gob-lku/25.07.2013/P1046
      //IF TempTabDistinct.FINDFIRST THEN BEGIN
      IF TempTabDistinct.FIND('-') THEN BEGIN
      // E/gob-lku/25.07.2013/P1046
        REPEAT
          Spem:=STRSUBSTNO(
          '<?xml version="1.0" ?>'+
          '<AccessRequest>'+
            '<AccessLicenseNumber>6CAF344DA6654668</AccessLicenseNumber>'+
            '<UserId>HOME24_pld</UserId>'+
            '<Password>KkuH6T#8T</Password>'+
          '</AccessRequest>'+
          '<?xml version="1.0" ?>'+
          '<TrackRequest>'+
            '<Request>'+
              '<TransactionReference>'+
              '<CustomerContext>%1</CustomerContext>'+
              '</TransactionReference>'+
              '<RequestAction>Track</RequestAction>'+
            '</Request>'+
            '<TrackingNumber>%2</TrackingNumber>'+
          '</TrackRequest>',TempTabDistinct.Description,TempTabDistinct."No.");
          // S/P1171
          //TimeAndDate := DELCHR(FORMAT(TODAY),'=','.')+'-'+DELCHR(FORMAT(TIME),'=','.:,');
          TimeAndDate := DELCHR(FORMAT(TODAY),'=','.')+'-'+DELCHR(FORMAT(TIME,0,2),'=','.:,T');
          // E/P1171
          locautXmlHttp.open('POST','https://wwwcie.ups.com/ups.app/xml/Track',FALSE);
          locautXmlHttp.send(Spem);
          locautXmlDoc.load(locautXmlHttp.responseXML);

          locautXmlDoc.save(FPCGeneralSetup."UPS Import Tracking path"+TempTabDistinct."No."+'-'+TimeAndDate+'.xml');
        UNTIL TempTabDistinct.NEXT = 0;
      END;


      //IF locautXmlHttp.status = 200 THEN
        ImportXmlTrackingResponseAlt;
    END;

    PROCEDURE ImportXmlTrackingResponseAlt@1000000014();
    VAR
      XMLDOMDocument@1000000000 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{F6D90F11-9C73-11D3-B32E-00C04F990BB4}:'Microsoft XML, v6.0'.DOMDocument";
      XMLDOMManagement@1000000001 : Codeunit 6224;
      CurrNode@1000000002 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      XMLNodeFound@1000000003 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
    BEGIN
      FPCGeneralSetup.GET;
      MyFile.SETRANGE(Path,FPCGeneralSetup."UPS Import Tracking path");
      MyFile.SETRANGE("Is a file",TRUE);
      MyFile.SETFILTER(Name,'*.xml');
      IF MyFile.FIND('-') THEN BEGIN
        REPEAT
          TestFile.OPEN(FPCGeneralSetup."UPS Import Tracking path"+MyFile.Name);
          TestFile.CREATEINSTREAM(TestStream);
          XMLPORT.IMPORT(50007, TestStream);
          IF MyXmlTab.FINDLAST THEN BEGIN
            IF MyXmlTab."File name" = '' THEN BEGIN
              MyXmlTab."File name" := MyFile.Name;
              MyXmlTab.MODIFY;
            END;
          END;
          TestFile.CLOSE;
          FILE.COPY(FPCGeneralSetup."UPS Import Tracking path"+MyFile.Name,FPCGeneralSetup."UPS Archiv Tracking path"+MyFile.Name);
          FILE.ERASE(FPCGeneralSetup."UPS Import Tracking path"+MyFile.Name);
        UNTIL MyFile.NEXT = 0;
      END;
      COMMIT;
      ImportInDHLHistoryAlt;
    END;

    PROCEDURE ImportInDHLHistoryAlt@1000000012();
    VAR
      UPSTrackingTabele@1000000000 : Record 50124;
      DHLTrackingTabele@1000000001 : Record 50021;
      FindLastEntryNoInDHL@1000000002 : Record 50021;
      TrackingVariable@1000000003 : Code[20];
      DHLTrackingTabeleInsertNew@1000000004 : Record 50021;
      TodayTimeToxport@1000000005 : DateTime;
      ActivitiyDateVariable@1000000006 : Date;
      ActivityTimeVariable@1000000007 : Time;
      UPSTrackingTbl2@1000000008 : Record 50124;
      ParcelStatusHistory@1000000009 : Record 80013;
      ParcelStatusHistoryNew@1000000010 : Record 80013;
      UseEntryNo@1000000011 : Integer;
    BEGIN
      // S/gob-lku/14.08.2013/P1046
      SetPassForFailure;
      // E/gob-lku/14.08.2013/P1046

      //S/P1133
      FPCGeneralSetup.GET;
      //E/P1133

      UPSTrackingTabele.RESET;
      // S/gob-lku/31.07.2013/P1046
      UPSTrackingTabele.SETCURRENTKEY(Pass);
      // E/gob-lku/31.07.2013/P1046
      UPSTrackingTabele.SETRANGE(Pass,FALSE);
      // S/gob-lku/25.07.2013/P1046
      //IF UPSTrackingTabele.FINDFIRST THEN BEGIN
      IF UPSTrackingTabele.FIND('-') THEN BEGIN
      // E/gob-lku/25.07.2013/P1046
        REPEAT
          //S/P1133
          CASE FPCGeneralSetup."Active Parcel Status History" OF
            FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old":
              BEGIN
          //E/P1133
                DHLTrackingTabele.RESET;
                // S/gob-lku/31.07.2013/P1046
                DHLTrackingTabele.SETCURRENTKEY("Document No.","Document Line No.","Document Type","Time Stamp");
                // S/gob-lku/14.08.2103/P1046
                //DHLTrackingTabele.SETFILTER("Sale Order Code",'<>%1','');
                IF UPSTrackingTabele."ReferenceNumber Value" <> '' THEN
                  DHLTrackingTabele.SETRANGE("Document No.",COPYSTR(UPSTrackingTabele."ReferenceNumber Value",1,
                        STRLEN(UPSTrackingTabele."ReferenceNumber Value")-3))
                ELSE
                  DHLTrackingTabele.SETFILTER("Document No.",'<>%1','');
                // E/gob-lku/14.08.2103/P1046
                DHLTrackingTabele.SETRANGE("Document Type",DHLTrackingTabele."Document Type"::Order);
                // E/gob-lku/31.07.2013/P1046
                DHLTrackingTabele.SETRANGE("Shipping Agent",'UPS');
                DHLTrackingTabele.SETRANGE("Docdate Status Code",'21');
                // S/gob-lku/31.07.2013/P1046
                //DHLTrackingTabele.SETFILTER("Sale Order Code",'<>%1','');
                //DHLTrackingTabele.SETRANGE("Sales Doc Type",DHLTrackingTabele."Sales Doc Type"::Order);
                // E/gob-lku/31.07.2013/P1046
                DHLTrackingTabele.SETFILTER(DHLTrackingTabele."Docdata Status Description",'=%1',
                 UPSTrackingTabele.CustomerContext);
                 DHLTrackingTabele.SETRANGE("Status Event",UPSTrackingTabele."StatusType Code");
                 DHLTrackingTabele.SETRANGE("Final Status UPS",FALSE);
                 DHLTrackingTabele.SETRANGE("Imported over UPS API",TRUE);
                // S/gob-lku/25.07.2013/P1046
                //IF DHLTrackingTabele.FINDFIRST THEN BEGIN
                IF DHLTrackingTabele.FIND('-') THEN BEGIN
                // E/gob-lku/25.07.2013/P1046
                  REPEAT
                    EVALUATE(ActivitiyDateVariable,COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                    COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                    COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                    EVALUATE(ActivityTimeVariable,UPSTrackingTabele."Activity Time");
                    DHLTrackingTabele."Time Stamp" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                    DHLTrackingTabele."Import Time Stamp" :=   CURRENTDATETIME;
                    //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
                    {
                    //H0777  28.01.14  MBY  ----------------------------
                    DHLTrackingTabele.MODIFY;
                    //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
                    }
                    DHLTrackingTabele.MODIFY(TRUE);
                    //H0777  28.01.14  MBY  ----------------------------
                  UNTIL DHLTrackingTabele.NEXT = 0;
                  // S/gob-lku/31.07.2013/P1046
                  //UPSTrackingTabele.Pass := TRUE;
                  //UPSTrackingTabele.SalesLineNo := DHLTrackingTabele."Line No.";
                  //UPSTrackingTabele.DHLParcelHistEntryNo := DHLTrackingTabele."Entry No.";
                  //UPSTrackingTabele.MODIFY;
                  // S/P1082
                  UPSTrackingTbl2.GET(UPSTrackingTabele."Entry no.");
                  // E/P1082
                  UPSTrackingTbl2.Pass := TRUE;
                  UPSTrackingTbl2.SalesLineNo := DHLTrackingTabele."Document Line No.";
                  UPSTrackingTbl2.DHLParcelHistEntryNo := DHLTrackingTabele."Entry No.";
                  UPSTrackingTbl2.MODIFY;
                  // E/gob-lku/31.07.2013/P1046
                END;
          //S/P1133
              END;
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
            FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History":
              BEGIN
                ParcelStatusHistory.RESET;
                ParcelStatusHistory.SETCURRENTKEY("Document No.","Document Line No.","Document Type");
                IF UPSTrackingTabele."ReferenceNumber Value" <> '' THEN
                  ParcelStatusHistory.SETRANGE("Document No.",
                  COPYSTR(UPSTrackingTabele."ReferenceNumber Value",1,STRLEN(UPSTrackingTabele."ReferenceNumber Value")-3))
                ELSE
                  ParcelStatusHistory.SETFILTER("Document No.",'<>%1','');
                ParcelStatusHistory.SETRANGE("Document Type",ParcelStatusHistory."Document Type"::Order);
                ParcelStatusHistory.SETRANGE("Used Interface",ParcelStatusHistory."Used Interface"::UPS);
                //H1851  27.11.14  MBY  +++++++++++++++++++++++++
                //ParcelStatusHistory.SETRANGE("Status Sub Code",'21');
                ParcelStatusHistory.SETFILTER("Status Sub Code",'21|31');
                //H1851  27.11.14  MBY  -------------------------
                ParcelStatusHistory.CALCFIELDS("Status Description","Status Sub Description");
                ParcelStatusHistory.SETFILTER(ParcelStatusHistory."Status Sub Description",'=%1',UPSTrackingTabele.CustomerContext);
                ParcelStatusHistory.SETRANGE("Status Code",UPSTrackingTabele."StatusType Code");
                // S/PP186
                //ParcelStatusHistory.SETRANGE("Import API",ParcelStatusHistory."Import API"::UPS);
                // E/P1186
                IF ParcelStatusHistory.FIND('-') THEN BEGIN
                  REPEAT
                    EVALUATE(ActivitiyDateVariable,
                      COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                      COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                      COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                    EVALUATE(ActivityTimeVariable,UPSTrackingTabele."Activity Time");
                    // S/P1232
                    //ParcelStatusHistory."Timestamp Insert" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                    //ParcelStatusHistory."Timestamp Interface" :=   CURRENTDATETIME;
                    ParcelStatusHistory."Timestamp Insert" := CURRENTDATETIME;
                    ParcelStatusHistory."Timestamp Interface" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                    // E/P1232
                    // S/P1228
                    //ParcelStatusHistory.MODIFY;
                    ParcelStatusHistory.MODIFY(TRUE);
                    // E/P1228
                  UNTIL ParcelStatusHistory.NEXT = 0;
                  UPSTrackingTbl2.GET(UPSTrackingTabele."Entry no.");
                  UPSTrackingTbl2.Pass := TRUE;
                  UPSTrackingTbl2.SalesLineNo := ParcelStatusHistory."Document Line No.";
                  UPSTrackingTbl2.DHLParcelHistEntryNo := ParcelStatusHistory."Entry No.";
                  UPSTrackingTbl2.MODIFY;
                END;
              END;
          END;
          //E/P1133
        UNTIL UPSTrackingTabele.NEXT = 0;
      END;

      UPSTrackingTabele.RESET;
      // S/gob-lku/31.07.2013/P1046
      UPSTrackingTabele.SETCURRENTKEY(Pass);
      // E/gob-lku/31.07.2013/P1046
      UPSTrackingTabele.SETRANGE(Pass,FALSE);
      // S/gob-lku/25.07.2013/P1046
      //IF UPSTrackingTabele.FINDFIRST THEN BEGIN
      IF UPSTrackingTabele.FIND('-') THEN BEGIN
      // E/gob-lku/25.07.2013/P1046
        REPEAT
          //S/P1117
          //S/P1133
          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New"]
          THEN BEGIN
          //E/P1133
            DHLTrackingTabele.RESET;
            // S/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETCURRENTKEY("Document No.","Document Line No.","Document Type","Time Stamp");
            // S/gob-lku/14.08.2103/P1046
            //DHLTrackingTabele.SETFILTER("Sale Order Code",'<>%1','');
            IF UPSTrackingTabele."ReferenceNumber Value" <> '' THEN
              DHLTrackingTabele.SETRANGE("Document No.",COPYSTR(UPSTrackingTabele."ReferenceNumber Value",1,
                    STRLEN(UPSTrackingTabele."ReferenceNumber Value")-3))
            ELSE
              DHLTrackingTabele.SETFILTER("Document No.",'<>%1','');
            // E/gob-lku/14.08.2103/P1046
            DHLTrackingTabele.SETRANGE("Document Type",DHLTrackingTabele."Document Type"::Order);
            DHLTrackingTabele.SETFILTER("Time Stamp",'<>%1',0DT);
            // E/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETRANGE("Shipping Agent",'UPS');
            // S/gob-lku/31.07.2013/P1046
            //DHLTrackingTabele.SETFILTER("Time Stamp",'<>%1',0DT);
            // E/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETRANGE("Docdate Status Code",'21');
            // S/gob-lku/31.07.2013/P1046
            //DHLTrackingTabele.SETFILTER("Sale Order Code",'<>%1','');
            //DHLTrackingTabele.SETRANGE("Sales Doc Type",DHLTrackingTabele."Sales Doc Type"::Order);
            // E/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETFILTER(DHLTrackingTabele."Docdata Status Description",'=%1',
             UPSTrackingTabele.CustomerContext);
             DHLTrackingTabele.SETRANGE("Final Status UPS",FALSE);
             DHLTrackingTabele.SETRANGE("Imported over UPS API",FALSE);
            // S/gob-lku/25.07.2013/P1046
            //IF DHLTrackingTabele.FINDFIRST THEN BEGIN
            IF DHLTrackingTabele.FIND('-') THEN BEGIN
            // E/gob-lku/25.07.2013/P1046
              REPEAT
                FindLastEntryNoInDHL.RESET;
                FindLastEntryNoInDHL.FINDLAST;
                //S/P1133
                IF FPCGeneralSetup."Active Parcel Status History" IN
                  [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
                  FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old"]
                THEN BEGIN
                //E/P1133
                  // S/gob-lku/31.07.2013/P1046
                  //UPSTrackingTabele.Pass := TRUE;
                  //UPSTrackingTabele.DHLParcelHistEntryNo := FindLastEntryNoInDHL."Entry No." + 1;
                  //UPSTrackingTabele.SalesLineNo := DHLTrackingTabele."Line No.";
                  //UPSTrackingTabele."OrderNo." := DHLTrackingTabele."Sale Order Code";
                  //UPSTrackingTabele.MODIFY;
                  // S/P1082
                  UPSTrackingTbl2.GET(UPSTrackingTabele."Entry no.");
                  // E/P1082
                  UPSTrackingTbl2.Pass := TRUE;
                  UPSTrackingTbl2.DHLParcelHistEntryNo := FindLastEntryNoInDHL."Entry No." + 1;
                  UPSTrackingTbl2.SalesLineNo := DHLTrackingTabele."Document Line No.";
                  UPSTrackingTbl2."OrderNo." := DHLTrackingTabele."Document No.";
                  UPSTrackingTbl2.MODIFY;
                  // E/gob-lku/31.07.2013/P1046
                //S/P1133
                END;
                //E/P1133
                DHLTrackingTabeleInsertNew.INIT;
                DHLTrackingTabeleInsertNew."Entry No." := FindLastEntryNoInDHL."Entry No." + 1;
                // S/gob-lku/14.08.2013/P1046
                DHLTrackingTabeleInsertNew.INSERT;
                // E/gob-lku/14.08.2013/P1046
                DHLTrackingTabeleInsertNew."DHL Shipment Code" := '';
                DHLTrackingTabeleInsertNew."Account Number" := UPSTrackingTabele.ShipperNumber;
                DHLTrackingTabeleInsertNew."Production Line"       := '';
                DHLTrackingTabeleInsertNew.Product := '';
                TodayTimeToxport := CURRENTDATETIME;
                EVALUATE(ActivitiyDateVariable,COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                EVALUATE(ActivityTimeVariable,UPSTrackingTabele."Activity Time");
                DHLTrackingTabeleInsertNew."Time Stamp" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                DHLTrackingTabeleInsertNew."Import Time Stamp" := TodayTimeToxport;
                DHLTrackingTabeleInsertNew."Detection Location" := '';
                DHLTrackingTabeleInsertNew."Country of Origin" := UPSTrackingTabele."Shipper CountryCode";
                DHLTrackingTabeleInsertNew."Piece-Code (Identifier)" := '';
                DHLTrackingTabeleInsertNew."Commit at Date" := TODAY;
                DHLTrackingTabeleInsertNew."Status Event" := UPSTrackingTabele."StatusType Code";
                DHLTrackingTabeleInsertNew."Status Code" := '';
                DHLTrackingTabeleInsertNew."Standart Event" := '';
                DHLTrackingTabeleInsertNew."Reference Number" := UPSTrackingTabele."ReferenceNumber Code";
                DHLTrackingTabeleInsertNew."Recipient Name Is" := '';
                DHLTrackingTabeleInsertNew."Recipient Name Target" := '';
                DHLTrackingTabeleInsertNew."Routing Code" := '';
                DHLTrackingTabeleInsertNew."Return Policies (Y/N)" := FALSE;
                EVALUATE(DHLTrackingTabeleInsertNew."Delivery Date",COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                                                                    COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                                                                    COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                EVALUATE(DHLTrackingTabeleInsertNew."Pickup Date",COPYSTR(UPSTrackingTabele.PickupDate,7,2)+
                                                                  COPYSTR(UPSTrackingTabele.PickupDate,5,2)+
                                                                  COPYSTR(UPSTrackingTabele.PickupDate,1,4));
                DHLTrackingTabeleInsertNew."Document No." := DHLTrackingTabele."Document No.";
                DHLTrackingTabeleInsertNew."Document Type" := DHLTrackingTabele."Document Type";
                DHLTrackingTabeleInsertNew."Document Line No." := DHLTrackingTabele."Document Line No.";
                DHLTrackingTabeleInsertNew."Shipment Date" := DHLTrackingTabele."Shipment Date";
                DHLTrackingTabeleInsertNew."Purchase Order Code" := DHLTrackingTabele."Purchase Order Code";
                DHLTrackingTabeleInsertNew."PO Line No." := DHLTrackingTabele."PO Line No.";
                DHLTrackingTabeleInsertNew."Current Status" := DHLTrackingTabele."Current Status";
                DHLTrackingTabeleInsertNew."Rhenus Entry" := DHLTrackingTabele."Rhenus Entry";
                DHLTrackingTabeleInsertNew.DeleteMe := DHLTrackingTabele.DeleteMe;
                DHLTrackingTabeleInsertNew."Status Drop Shipment" :=  DHLTrackingTabele."Status Drop Shipment";
                DHLTrackingTabeleInsertNew."Drop Shipment Status Desc." := DHLTrackingTabele."Drop Shipment Status Desc.";
                //DHLTrackingTabeleInsertNew."Import Time Stamp" := 0DT;
                DHLTrackingTabeleInsertNew."Time Difference" := 0;
                DHLTrackingTabeleInsertNew."Status DHL" := DHLTrackingTabele."Status DHL";
                DHLTrackingTabeleInsertNew."Order Date" := DHLTrackingTabele."Order Date";
                DHLTrackingTabeleInsertNew."Shipment through" := DHLTrackingTabele."Shipment through";
                DHLTrackingTabeleInsertNew."Shipping Agent" := DHLTrackingTabele."Shipping Agent";
                //DHLTrackingTabeleInsertNew."VIR Status Comment" := DHLTrackingTabele."VIR Status Comment";
                DHLTrackingTabeleInsertNew."Status DHL HD" := DHLTrackingTabele."Status DHL HD";
                DHLTrackingTabeleInsertNew."Status Docdata" := DHLTrackingTabele."Status Docdata";
                DHLTrackingTabeleInsertNew."Docdate Status Code" := DHLTrackingTabele."Docdate Status Code";
                DHLTrackingTabeleInsertNew."DHL HD Status Code" := DHLTrackingTabele."DHL HD Status Code";
                DHLTrackingTabeleInsertNew."Docdata Status Description" := DHLTrackingTabele."Docdata Status Description";
                IF UPSTrackingTabele.ResponseStatusCode = '1' THEN BEGIN
                  DHLTrackingTabeleInsertNew."DHL HD Status Description" := COPYSTR(UPSTrackingTabele."StatusType Description",1,50);
                  DHLTrackingTabele."DHL HD Status Description" := COPYSTR(UPSTrackingTabele."StatusType Description",1,50);
                  DHLTrackingTabele.MODIFY;
                END ELSE BEGIN
                  DHLTrackingTabeleInsertNew."DHL HD Status Description" := COPYSTR(UPSTrackingTabele.ErrorDescription,1,50);
                  DHLTrackingTabele."DHL HD Status Description" := COPYSTR(UPSTrackingTabele.ErrorDescription,1,50);
                  DHLTrackingTabele.MODIFY;
                END;

                DHLTrackingTabeleInsertNew."Imported over DHL API" := DHLTrackingTabele."Imported over DHL API";
                DHLTrackingTabeleInsertNew."Imported over UPS API" := TRUE;
                DHLTrackingTabeleInsertNew."Status RIC Name" := DHLTrackingTabele."Status RIC Name";
                DHLTrackingTabeleInsertNew."Status Event Name" := DHLTrackingTabele."Status Event Name";
                DHLTrackingTabeleInsertNew."Rhenus Status Description" := DHLTrackingTabele."Rhenus Status Description";

                IF UPSTrackingTabele."StatusType Code" = 'D' THEN BEGIN
                  DHLTrackingTabeleInsertNew."Final Status UPS" := TRUE;
                  // S/gob-lku/31.07.2013/P1046
                  //DHLTrackingTabele."Final Status UPS" := TRUE;
                  //DHLTrackingTabele.MODIFY;
                  SetFinalStatus(DHLTrackingTabele."Document No.",DHLTrackingTabele."Document Type",
                    DHLTrackingTabele."Document Line No.");
                  // E/gob-lku/31.07.2013/P1046
                  DHLTrackingTabele.MODIFY;
                END;

                IF UPSTrackingTabele.AlternateTrackingNumber <> '' THEN BEGIN
                  DHLTrackingTabeleInsertNew."Final Status UPS" := TRUE;
                  // S/gob-lku/31.07.2013/P1046
                  //DHLTrackingTabele."Final Status UPS" := TRUE;
                  //DHLTrackingTabele.MODIFY;
                  SetFinalStatus(DHLTrackingTabele."Document No.",DHLTrackingTabele."Document Type",
                    DHLTrackingTabele."Document Line No.");
                  // E/gob-lku/31.07.2013/P1046
                  DHLTrackingTabele.AlternateTrackinNumberUPS := UPSTrackingTabele.AlternateTrackingNumber;
                  DHLTrackingTabeleInsertNew.AlternateTrackinNumberUPS := UPSTrackingTabele.AlternateTrackingNumber;
                  DHLTrackingTabele.MODIFY;
                END;

                // S/gob-lku/14.08.2013/P1046
                //DHLTrackingTabeleInsertNew.INSERT;
                // E/gob-lku/14.08.2013/P1046
                //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
                {
                //H0686  04.12.13  MBY  ----------------------------
                DHLTrackingTabeleInsertNew.MODIFY;
                //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
                }
                DHLTrackingTabeleInsertNew.MODIFY(TRUE);
                //H0686  04.12.13  MBY  ----------------------------
              UNTIL DHLTrackingTabele.NEXT = 0;
            END;
          //S/P1133
          END;

          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
            FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
          THEN BEGIN
          //E/P1133
            ParcelStatusHistory.RESET;
            ParcelStatusHistory.SETCURRENTKEY("Document No.","Document Line No.","Document Type");
            IF UPSTrackingTabele."ReferenceNumber Value" <> '' THEN
              ParcelStatusHistory.SETRANGE(
                "Document No.",
                COPYSTR(UPSTrackingTabele."ReferenceNumber Value",1,STRLEN(UPSTrackingTabele."ReferenceNumber Value")-3))
            ELSE
              ParcelStatusHistory.SETFILTER("Document No.",'<>%1','');
            ParcelStatusHistory.SETRANGE("Document Type",ParcelStatusHistory."Document Type"::Order);
            ParcelStatusHistory.SETFILTER("Timestamp Insert",'<>%1',0DT);
            ParcelStatusHistory.SETRANGE("Shipping Agent Code",'UPS');
            //H1851,P1186,P1204  27.11.14  MBY  +++++++++++++++++++++++++++++++++++++++++++++++
            //ParcelStatusHistory.SETRANGE("Status Sub Code",'21');
            ParcelStatusHistory.SETFILTER("Status Sub Code",'21|31');
            ParcelStatusHistory.SETRANGE("Is Final Status",FALSE);
            //H1851,P1186,P1204  27.11.14  MBY  -----------------------------------------------
            ParcelStatusHistory.SETFILTER("Used Interface",'<>%1',ParcelStatusHistory."Used Interface"::UPS);
            IF ParcelStatusHistory.FIND('-') THEN BEGIN
              REPEAT
                CLEAR(ParcelStatusHistoryNew);
                ParcelStatusHistoryNew.INIT;
                UseEntryNo := ParcelStatusHistoryNew.GetNextEntryNo(TRUE);
                ParcelStatusHistoryNew."Entry No." := UseEntryNo;
                ParcelStatusHistoryNew.INSERT;
                //S/P1133
                IF FPCGeneralSetup."Active Parcel Status History" IN
                  [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
                  FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
                THEN BEGIN
                //E/P1133
                  UPSTrackingTbl2.GET(UPSTrackingTabele."Entry no.");
                  UPSTrackingTbl2.Pass := TRUE;
                  UPSTrackingTbl2.DHLParcelHistEntryNo := UseEntryNo;
                  UPSTrackingTbl2.SalesLineNo := ParcelStatusHistory."Document Line No.";
                  UPSTrackingTbl2.MODIFY;
                //S/P1133
                END;
                //E/P1133
                ParcelStatusHistoryNew."Document Type" := ParcelStatusHistory."Document Type";
                ParcelStatusHistoryNew."Document No." := ParcelStatusHistory."Document No.";
                ParcelStatusHistoryNew."Document Line No." := ParcelStatusHistory."Document Line No.";
                ParcelStatusHistoryNew."Purchase Doc. Type" := ParcelStatusHistory."Purchase Doc. Type";
                ParcelStatusHistoryNew."Purchase Doc. No." := ParcelStatusHistory."Purchase Doc. No.";
                ParcelStatusHistoryNew."Purchase Doc. Line No." := ParcelStatusHistory."Purchase Doc. Line No.";
                ParcelStatusHistoryNew."Direction of Information" := ParcelStatusHistory."Direction of Information"::Incoming;
                ParcelStatusHistoryNew."Used Interface" := ParcelStatusHistory."Used Interface"::UPS;
                // S/P1186
                ParcelStatusHistoryNew."Status Code" := UPSTrackingTabele."StatusType Code";
                ParcelStatusHistoryNew."Status Sub Code" := ParcelStatusHistory."Status Sub Code";
                // E/P1186
                ParcelStatusHistoryNew."Account No." := UPSTrackingTabele.ShipperNumber;
                EVALUATE(ActivitiyDateVariable,COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                EVALUATE(ActivityTimeVariable,UPSTrackingTabele."Activity Time");
                ParcelStatusHistoryNew."Timestamp Insert" := CURRENTDATETIME;
                ParcelStatusHistoryNew."Timestamp Interface" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                // S/P1170
                IF ParcelStatusHistoryNew."Timestamp Interface" <> 0DT THEN
                // E/P1170
                  ParcelStatusHistoryNew."Timestamp Difference" :=
                    ParcelStatusHistoryNew."Timestamp Insert" -
                    ParcelStatusHistoryNew."Timestamp Interface";
                // S/P1170
                IF ParcelStatusHistoryNew."Timestamp Difference" < 0 THEN
                  ParcelStatusHistoryNew."Timestamp Difference" := ParcelStatusHistoryNew."Timestamp Difference" * -1;
                // E/P1170
                ParcelStatusHistoryNew."Date Commit" := TODAY;
                EVALUATE(ParcelStatusHistoryNew."Date Delivery",
                  COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                  COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                  COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                EVALUATE(ParcelStatusHistoryNew."Date Pickup",
                  COPYSTR(UPSTrackingTabele.PickupDate,7,2)+
                  COPYSTR(UPSTrackingTabele.PickupDate,5,2)+
                  COPYSTR(UPSTrackingTabele.PickupDate,1,4));
                ParcelStatusHistoryNew."Shipping Agent Code" := ParcelStatusHistory."Shipping Agent Code";
                // S/P1204
                //ParcelStatusHistoryNew."Comment Part 1" := UPSTrackingTabele."ReferenceNumber Code";
                ParcelStatusHistoryNew."Tracking Code" := UPSTrackingTabele.TrackingNumber;
                // E/P1204
                IF UPSTrackingTabele.ResponseStatusCode = '1' THEN BEGIN
                  ParcelStatusHistoryNew."Comment Part 2" := COPYSTR(UPSTrackingTabele."StatusType Description",1,50);
                  ParcelStatusHistory."Comment Part 2" := COPYSTR(UPSTrackingTabele."StatusType Description",1,50);
                  // S/P1228
                  //ParcelStatusHistory.MODIFY;
                  ParcelStatusHistory.MODIFY(TRUE);
                  // E/P1228
                END ELSE BEGIN
                  ParcelStatusHistoryNew."Comment Part 2" := COPYSTR(UPSTrackingTabele.ErrorDescription,1,50);
                  ParcelStatusHistory."Comment Part 2" := COPYSTR(UPSTrackingTabele.ErrorDescription,1,50);
                  // S/P1228
                  //ParcelStatusHistory.MODIFY;
                  ParcelStatusHistory.MODIFY(TRUE);
                  // E/P1228
                END;
                // S/P1204
                { ****
                IF UPSTrackingTabele.AlternateTrackingNumber <> '' THEN BEGIN
                  ParcelStatusHistoryNew."Tracking Code" := UPSTrackingTabele.AlternateTrackingNumber;
                  ParcelStatusHistory."Tracking Code" := UPSTrackingTabele.AlternateTrackingNumber;
                  ParcelStatusHistory.MODIFY;
                END;
                **** }
                IF UPSTrackingTabele.AlternateTrackingNumber <> '' THEN BEGIN
                  ParcelStatusHistoryNew."Comment Part 1" := 'Alt. Track. No.: ' + UPSTrackingTabele.AlternateTrackingNumber;
                  ParcelStatusHistory."Comment Part 4" := 'Alt. Track. No.: ' + UPSTrackingTabele.AlternateTrackingNumber;
                  // S/P1228
                  //ParcelStatusHistory.MODIFY;
                  ParcelStatusHistory.MODIFY(TRUE);
                  // E/P1228
                END;
                IF UPSTrackingTabele."ReferenceNumber Code" <> '' THEN
                  ParcelStatusHistoryNew."Comment Part 3" := 'Ref. No.: ' + UPSTrackingTabele."ReferenceNumber Code";
                // E/P1204
                //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
                {
                //H0777  28.01.14  MBY  ----------------------------
                ParcelStatusHistoryNew.MODIFY;
                //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
                }
                ParcelStatusHistoryNew.MODIFY(TRUE);
                //H0777  28.01.14  MBY  ----------------------------
                // S/P1204
                // S/P1180
                //CLEAR(CUParcelStatusHistoryMgmt);
                //CUParcelStatusHistoryMgmt.CheckIfArchivedOrder(ParcelStatusHistoryNew."Entry No.");
                // E/P1180
                CLEAR(IDForArchiving);
                IDForArchiving := ParcelStatusHistoryNew."Entry No.";
                IF (UPSTrackingTabele."StatusType Code" = 'D') OR
                   (UPSTrackingTabele.AlternateTrackingNumber <> '')
                THEN BEGIN
                  ParcelStatusHistoryNew."Is Final Status" := TRUE;
                  // S/P1228
                  //ParcelStatusHistoryNew.MODIFY;
                  ParcelStatusHistoryNew.MODIFY(TRUE);
                  // E/P1228
                  SetFinalStatusNew(
                    ParcelStatusHistory."Document No.",
                    ParcelStatusHistory."Document Type",
                    ParcelStatusHistory."Document Line No.");
                END;
                CLEAR(CUParcelStatusHistoryMgmt);
                CUParcelStatusHistoryMgmt.CheckIfArchivedOrder(IDForArchiving);
                // E/P1204
              UNTIL ParcelStatusHistory.NEXT = 0;
            END;
          //S/P1133
          END;
          //E/P1133
          //E/P1117
        UNTIL UPSTrackingTabele.NEXT = 0;
      END;

      //S/P1133
      IF FPCGeneralSetup."Active Parcel Status History" IN
        [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old"]
      THEN BEGIN
      //E/P1133
        DHLTrackingTabele.RESET;
        // S/gob-lku/31.07.2013/P1046
        DHLTrackingTabele.SETCURRENTKEY("Document No.","Document Line No.","Document Type","Time Stamp");
        DHLTrackingTabele.SETFILTER("Document No.",'<>%1','');
        DHLTrackingTabele.SETRANGE("Document Type",DHLTrackingTabele."Document Type"::Order);
        DHLTrackingTabele.SETFILTER("Time Stamp",'=%1',0DT);
        // E/gob-lku/31.07.2013/P1046
        DHLTrackingTabele.SETRANGE("Shipping Agent",'UPS');
        // S/gob-lku/31.07.2013/P1046
        //DHLTrackingTabele.SETFILTER("Time Stamp",'=%1',0DT);
        // E/gob-lku/31.07.2013/P1046
        DHLTrackingTabele.SETRANGE("Docdate Status Code",'21');
        // S/gob-lku/31.07.2013/P1046
        //DHLTrackingTabele.SETFILTER("Sale Order Code",'<>%1','');
        //DHLTrackingTabele.SETRANGE("Sales Doc Type",DHLTrackingTabele."Sales Doc Type"::Order);
        // E/gob-lku/31.07.2013/P1046
        //DHLTrackingTabele.SETFILTER("Docdata Status Description",'=%1',
        //UPSTrackingTabele.CustomerContext);
        DHLTrackingTabele.SETRANGE("Imported over UPS API",TRUE);
        IF DHLTrackingTabele.FIND('-') THEN BEGIN
                  EVALUATE(ActivitiyDateVariable,COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                  COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                  COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                  EVALUATE(ActivityTimeVariable,UPSTrackingTabele."Activity Time");
          //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
          {
          //H0777  28.01.14  MBY  ----------------------------
          DHLTrackingTabele.MODIFYALL("Time Stamp",CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable));
          //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
          }
          DHLTrackingTabele.MODIFYALL("Time Stamp",CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable),TRUE);
          //H0777  28.01.14  MBY  ----------------------------
        END;
      //S/P1133
      END;
      //E/P1133

      CopyFromTempToArchivAlt;
    END;

    PROCEDURE CopyFromTempToArchivAlt@1000000015();
    VAR
      FileRecToTransfer@1000000000 : Record 2000000022;
      FPCSetup@1000000001 : Record 50055;
    BEGIN
      FPCGeneralSetup.GET;
      FileRecToTransfer.SETRANGE(Path,FPCGeneralSetup."UPS Temp Archiv path");
      FileRecToTransfer.SETRANGE("Is a file",TRUE);
      FileRecToTransfer.SETFILTER(Name,'*.xml');
      IF FileRecToTransfer.FIND('-') THEN BEGIN
        REPEAT
          FILE.COPY(FPCGeneralSetup."UPS Temp Archiv path"+FileRecToTransfer.Name,
          FPCGeneralSetup."UPS Archiv Tracking path"+FileRecToTransfer.Name);
          FILE.ERASE(FPCGeneralSetup."UPS Temp Archiv path"+FileRecToTransfer.Name);
        UNTIL FileRecToTransfer.NEXT = 0;
      END;
    END;

    PROCEDURE CreateTrackingReqManuToUPSAlt@1000000009(SalesOrderCode@1000000003 : Code[20]);
    VAR
      locautXmlHttp@1000000000 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{F6D90F16-9C73-11D3-B32E-00C04F990BB4}:'Microsoft XML, v6.0'.XMLHTTP";
      locautXmlDoc@1000000001 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{F6D90F11-9C73-11D3-B32E-00C04F990BB4}:'Microsoft XML, v6.0'.DOMDocument";
      TempTabDistinct@1000000002 : TEMPORARY Record 27;
      ParcelStatusHistory@1000000004 : Record 80013;
      ParcelStatusHistoryArchive@1000000005 : Record 50187;
    BEGIN
      CREATE(locautXmlDoc);
      CREATE(locautXmlHttp);
      FPCGeneralSetup.GET;
      //FPCGeneralSetup.TESTFIELD("UPS Import Tracking path");
      //FPCGeneralSetup.TESTFIELD("UPS Archiv Tracking path");
      FPCGeneralSetup.TESTFIELD("UPS Temp path");
      TempTabDistinct.DELETEALL;

      //S/P1133
      CASE FPCGeneralSetup."Active Parcel Status History" OF
        FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old":
          BEGIN
      //E/P1133
            // S/gob-lku/31.07.2013/P1046
            DHLStatus.RESET;
            DHLStatus.SETCURRENTKEY("Document No.","Document Line No.","Document Type","Time Stamp");
            DHLStatus.SETFILTER("Document No.",SalesOrderCode);
            DHLStatus.SETRANGE("Document Type",DHLStatus."Document Type"::Order);
            DHLStatus.SETFILTER("Time Stamp",'<>%1',0DT);
            // E/gob-lku/31.07.2013/P1046
            DHLStatus.SETRANGE("Shipping Agent",'UPS');
            // S/gob-lku/31.07.2013/P1046
            //DHLStatus.SETFILTER("Time Stamp",'<>%1',0DT);
            // E/gob-lku/31.07.2013/P1046
            DHLStatus.SETRANGE("Docdate Status Code",'21');
            // S/gob-lku/31.07.2013/P1046
            //DHLStatus.SETFILTER("Sale Order Code",SalesOrderCode);
            //DHLStatus.SETRANGE("Sales Doc Type",DHLStatus."Sales Doc Type"::Order);
            // E/gob-lku/31.07.2013/P1046
            DHLStatus.SETRANGE("Final Status UPS",FALSE);
            DHLStatus.SETRANGE("Imported over UPS API",FALSE);
            DHLStatus.SETRANGE(InsertingAlternateNumer,TRUE);
            // S/gob-lku/25.07.2013/P1046
            //IF DHLStatus.FINDFIRST THEN BEGIN
            IF DHLStatus.FIND('-') THEN BEGIN
            // E/gob-lku/25.07.2013/P1046
              REPEAT
                IF NOT TempTabDistinct.GET(COPYSTR(DHLStatus."Docdata Status Description",14,20)) THEN BEGIN
                  TempTabDistinct.INIT;
                    TempTabDistinct."No." := COPYSTR(DHLStatus."Docdata Status Description",14,20);
                    TempTabDistinct."No. 2" := DHLStatus."Document No.";
                    TempTabDistinct.Description := DHLStatus."Docdata Status Description";
                  TempTabDistinct.INSERT;
                END;
              UNTIL DHLStatus.NEXT=0;
            END;
      //S/P1133
          END;
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
        FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History":
          BEGIN
            ParcelStatusHistory.RESET;
            ParcelStatusHistory.SETCURRENTKEY("Document No.","Document Line No.","Document Type");
            ParcelStatusHistory.SETFILTER("Document No.",SalesOrderCode);
            ParcelStatusHistory.SETRANGE("Document Type",ParcelStatusHistory."Document Type"::Order);
            ParcelStatusHistory.SETFILTER("Timestamp Insert",'<>%1',0DT);
            // S/P1186
            //ParcelStatusHistory.SETRANGE("Used Interface",ParcelStatusHistory."Used Interface"::UPS);
            ParcelStatusHistory.SETFILTER("Used Interface",'<>%1',ParcelStatusHistory."Used Interface"::UPS);
            // E/P1186
            //H1851  27.11.14  MBY  +++++++++++++++++++++++++
            //ParcelStatusHistory.SETRANGE("Status Sub Code",'21');
            ParcelStatusHistory.SETFILTER("Status Sub Code",'21|31');
            //H1851  27.11.14  MBY  -------------------------
            // S/P1186
            //ParcelStatusHistory.SETFILTER("Import API",'<>%1',ParcelStatusHistory."Import API"::UPS);
            // S/P1204
            //ParcelStatusHistory.SETFILTER("Status Code",'<>%1','D');
            ParcelStatusHistory.SETRANGE("Is Final Status",FALSE);
            // E/P1204
            // E/P1186
            IF ParcelStatusHistory.FIND('-') THEN BEGIN
              // S/P1232
              //ParcelStatusHistory.CALCFIELDS("Status Description","Status Sub Description");
              // E/P1232
              REPEAT
                // S/P1232
                { ******
                IF NOT TempTabDistinct.GET(COPYSTR(ParcelStatusHistory."Status Sub Description",14,20)) THEN BEGIN
                  TempTabDistinct.INIT;
                    TempTabDistinct."No." := COPYSTR(ParcelStatusHistory."Status Sub Description",14,20);
                    TempTabDistinct."No. 2" := ParcelStatusHistory."Sales Doc. No.";
                    TempTabDistinct.Description := ParcelStatusHistory."Status Sub Description";
                ***** }
                CLEAR(TmpTrackingCode);
                IF ParcelStatusHistory."Tracking Code" <> '' THEN
                  TmpTrackingCode := COPYSTR(ParcelStatusHistory."Tracking Code",1,20)
                ELSE BEGIN
                  TmpTrackingCode :=
                    COPYSTR(
                      ParcelStatusHistory."Comment Part 1",
                      STRPOS(ParcelStatusHistory."Comment Part 1",': ') + 2,
                      20);
                END;
                IF TmpTrackingCode <> '' THEN
                  IF NOT TempTabDistinct.GET(TmpTrackingCode) THEN BEGIN
                    TempTabDistinct."No." := TmpTrackingCode;
                    TempTabDistinct."No. 2" := ParcelStatusHistory."Document No.";
                    TempTabDistinct.Description := COPYSTR(ParcelStatusHistory."Comment Part 1",1,50);
                // E/P1232
                    TempTabDistinct.INSERT;
                  END;
              UNTIL ParcelStatusHistory.NEXT=0;
            END;
            // S/P1232
            ParcelStatusHistoryArchive.RESET;
            ParcelStatusHistoryArchive.SETCURRENTKEY("Document No.","Document Line No.","Document Type");
            ParcelStatusHistoryArchive.SETFILTER("Document No.",SalesOrderCode);
            ParcelStatusHistoryArchive.SETRANGE("Document Type",ParcelStatusHistoryArchive."Document Type"::Order);
            ParcelStatusHistoryArchive.SETFILTER("Timestamp Insert",'<>%1',0DT);
            ParcelStatusHistoryArchive.SETFILTER("Used Interface",'<>%1',ParcelStatusHistoryArchive."Used Interface"::UPS);
            //H1851  27.11.14  MBY  +++++++++++++++++++++++++
            //ParcelStatusHistoryArchive.SETRANGE("Status Sub Code",'21');
            ParcelStatusHistoryArchive.SETFILTER("Status Sub Code",'21|31');
            //H1851  27.11.14  MBY  -------------------------
            ParcelStatusHistoryArchive.SETRANGE("Is Final Status",FALSE);
            IF ParcelStatusHistoryArchive.FIND('-') THEN BEGIN
              REPEAT
                CLEAR(TmpTrackingCode);
                IF ParcelStatusHistoryArchive."Tracking Code" <> '' THEN
                  TmpTrackingCode := COPYSTR(ParcelStatusHistoryArchive."Tracking Code",1,20)
                ELSE BEGIN
                  TmpTrackingCode :=
                    COPYSTR(
                      ParcelStatusHistoryArchive."Comment Part 1",
                      STRPOS(ParcelStatusHistoryArchive."Comment Part 1",': ') + 2,
                      20);
                END;
                IF TmpTrackingCode <> '' THEN
                  IF NOT TempTabDistinct.GET(TmpTrackingCode) THEN BEGIN
                    TempTabDistinct.INIT;
                    TempTabDistinct."No." := TmpTrackingCode;
                    TempTabDistinct."No. 2" := ParcelStatusHistoryArchive."Document No.";
                    TempTabDistinct.Description := COPYSTR(ParcelStatusHistoryArchive."Comment Part 1",1,50);
                    TempTabDistinct.INSERT;
                  END;
              UNTIL ParcelStatusHistoryArchive.NEXT = 0;
            END;
            // E/P1232
          END;
      END;
      //E/P1133

      // S/gob-lku/25.07.2013/P1046
      //IF TempTabDistinct.FINDFIRST THEN BEGIN
      IF TempTabDistinct.FIND('-') THEN BEGIN
      // E/gob-lku/25.07.2013/P1046
        REPEAT
          Spem:=STRSUBSTNO(
          '<?xml version="1.0" ?>'+
          '<AccessRequest>'+
            '<AccessLicenseNumber>6CAF344DA6654668</AccessLicenseNumber>'+
            '<UserId>HOME24_pld</UserId>'+
            '<Password>KkuH6T#8T</Password>'+
          '</AccessRequest>'+
          '<?xml version="1.0" ?>'+
          '<TrackRequest>'+
            '<Request>'+
              '<TransactionReference>'+
              '<CustomerContext>%1</CustomerContext>'+
              '</TransactionReference>'+
              '<RequestAction>Track</RequestAction>'+
            '</Request>'+
            '<TrackingNumber>%2</TrackingNumber>'+
          '</TrackRequest>',TempTabDistinct.Description,TempTabDistinct."No.");
          // S/P1171
          //TimeAndDate := DELCHR(FORMAT(TODAY),'=','.')+'-'+DELCHR(FORMAT(TIME),'=','.:,');
          TimeAndDate := DELCHR(FORMAT(TODAY),'=','.')+'-'+DELCHR(FORMAT(TIME,0,2),'=','.:,T');
          // E/P1171
          locautXmlHttp.open('POST','https://wwwcie.ups.com/ups.app/xml/Track',FALSE);
          locautXmlHttp.send(Spem);
          locautXmlDoc.load(locautXmlHttp.responseXML);

          locautXmlDoc.save(FPCGeneralSetup."UPS Temp path"+TempTabDistinct."No."+'-'+TimeAndDate+'M'+'.xml');
        UNTIL TempTabDistinct.NEXT = 0;

      END;

      //IF locautXmlHttp.status = 200 THEN
        ImportXmlTracResponseManuaAlt(SalesOrderCode);
    END;

    PROCEDURE ImportXmlTracResponseManuaAlt@1000000011(DocumentNo@1000000004 : Code[20]);
    VAR
      XMLDOMDocument@1000000000 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{F6D90F11-9C73-11D3-B32E-00C04F990BB4}:'Microsoft XML, v6.0'.DOMDocument";
      XMLDOMManagement@1000000001 : Codeunit 6224;
      CurrNode@1000000002 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      XMLNodeFound@1000000003 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
    BEGIN
      FPCGeneralSetup.GET;
      CLEAR(MyFile);
      CLEAR(MyFileM);
      MyFileM.SETRANGE(Path,FPCGeneralSetup."UPS Temp path");
      MyFileM.SETRANGE("Is a file",TRUE);
      MyFileM.SETFILTER(Name,'*.xml');
      IF MyFileM.FIND('-') THEN BEGIN
        REPEAT
         IF  EXISTS(FPCGeneralSetup."UPS Temp path"+MyFileM.Name) THEN BEGIN
          TestFile.OPEN(FPCGeneralSetup."UPS Temp path"+MyFileM.Name);
          TestFile.CREATEINSTREAM(TestStream);
          XMLPORT.IMPORT(50007, TestStream);
          IF MyXmlTab.FINDLAST THEN BEGIN
            IF MyXmlTab."File name" = '' THEN BEGIN
              MyXmlTab."File name" := MyFile.Name;
              MyXmlTab.MODIFY;
            END;
          END;
          TestFile.CLOSE;
          FILE.COPY(FPCGeneralSetup."UPS Temp path"+MyFileM.Name,FPCGeneralSetup."UPS Temp Archiv path"+MyFileM.Name);
          FILE.ERASE(FPCGeneralSetup."UPS Temp path"+MyFileM.Name);
          END;
        UNTIL MyFileM.NEXT = 0;
      END;
      //COMMIT;
      //ImportInDHLHistoryManualAlt(DocumentNo);;
    END;

    PROCEDURE ImportInDHLHistoryManualAlt@1000000010(DocumentNo@1000000008 : Code[20]);
    VAR
      UPSTrackingTabele@1000000000 : Record 50124;
      DHLTrackingTabele@1000000001 : Record 50021;
      FindLastEntryNoInDHL@1000000002 : Record 50021;
      TrackingVariable@1000000003 : Code[20];
      DHLTrackingTabeleInsertNew@1000000004 : Record 50021;
      TodayTimeToxport@1000000005 : DateTime;
      ActivitiyDateVariable@1000000006 : Date;
      ActivityTimeVariable@1000000007 : Time;
      UPSTrackingTbl2@1000000009 : Record 50124;
      ParcelStatusHistory@1000000010 : Record 80013;
      ParcelStatusHistoryFindLast@1000000011 : Record 80013;
      ParcelStatusHistoryInsert@1000000012 : Record 80013;
    BEGIN
      //S/P1133
      FPCGeneralSetup.GET;
      //E/P1133

      // S/gob-lku/14.08.2013/P1046
      SetPassForFailure;
      // E/gob-lku/14.08.2013/P1046

      //neu
      UPSTrackingTabele.RESET;
      // S/gob-lku/31.07.2013/P1046
      UPSTrackingTabele.SETCURRENTKEY(Pass);
      // E/gob-lku/31.07.2013/P1046
      UPSTrackingTabele.SETRANGE(Pass,FALSE);
      // S/gob-lku/25.07.2013/P1046
      //IF UPSTrackingTabele.FINDFIRST THEN BEGIN
      IF UPSTrackingTabele.FIND('-') THEN BEGIN
      // E/gob-lku/25.07.2013/P1046
        REPEAT
          //S/P1133
          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New"]
          THEN BEGIN
          //E/P1133
            DHLTrackingTabele.RESET;
            // S/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETCURRENTKEY("Document No.","Document Line No.","Document Type","Time Stamp");
            // S/gob-lku/14.08.2103/P1046
            //DHLTrackingTabele.SETFILTER("Sale Order Code",'<>%1','');
            IF UPSTrackingTabele."ReferenceNumber Value" <> '' THEN
              DHLTrackingTabele.SETRANGE("Document No.",COPYSTR(UPSTrackingTabele."ReferenceNumber Value",1,
                    STRLEN(UPSTrackingTabele."ReferenceNumber Value")-3))
            ELSE
              DHLTrackingTabele.SETFILTER("Document No.",'<>%1','');
            // E/gob-lku/14.08.2103/P1046
            DHLTrackingTabele.SETRANGE("Document Type",DHLTrackingTabele."Document Type"::Order);
            // E/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETRANGE("Shipping Agent",'UPS');
            DHLTrackingTabele.SETRANGE("Docdate Status Code",'21');
            // S/gob-lku/31.07.2013/P1046
            //DHLTrackingTabele.SETFILTER("Sale Order Code",'<>%1','');
            //DHLTrackingTabele.SETRANGE("Sales Doc Type",DHLTrackingTabele."Sales Doc Type"::Order);
            // E/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETFILTER(DHLTrackingTabele."Docdata Status Description",'=%1',
             UPSTrackingTabele.CustomerContext);
             DHLTrackingTabele.SETRANGE("Status Event",UPSTrackingTabele."StatusType Code");
             DHLTrackingTabele.SETRANGE("Final Status UPS",FALSE);
             DHLTrackingTabele.SETRANGE("Imported over UPS API",TRUE);
            // S/gob-lku/25.07.2013/P1046
            //IF DHLTrackingTabele.FINDFIRST THEN BEGIN
            IF DHLTrackingTabele.FIND('-') THEN BEGIN
            // E/gob-lku/25.07.2013/P1046
              REPEAT
                EVALUATE(ActivitiyDateVariable,COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                EVALUATE(ActivityTimeVariable,UPSTrackingTabele."Activity Time");
                DHLTrackingTabele."Time Stamp" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                DHLTrackingTabele."Import Time Stamp" := CURRENTDATETIME;
                //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
                {
                //H0777  28.01.14  MBY  ----------------------------
                DHLTrackingTabele.MODIFY;
                //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
                }
                DHLTrackingTabele.MODIFY(TRUE);
                //H0777  28.01.14  MBY  ----------------------------
              UNTIL DHLTrackingTabele.NEXT = 0;
              //S/P1133
              IF FPCGeneralSetup."Active Parcel Status History" IN
                [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
                FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old"]
              THEN BEGIN
              //E/P1133
                // S/gob-lku/31.07.2013/P1046
                //UPSTrackingTabele.Pass := TRUE;
                //UPSTrackingTabele.SalesLineNo := DHLTrackingTabele."Line No.";
                //UPSTrackingTabele.DHLParcelHistEntryNo := DHLTrackingTabele."Entry No.";
                //UPSTrackingTabele.MODIFY;
                // S/P1082
                UPSTrackingTbl2.GET(UPSTrackingTabele."Entry no.");
                // E/P1082
                UPSTrackingTbl2.Pass := TRUE;
                UPSTrackingTbl2.SalesLineNo := DHLTrackingTabele."Document Line No.";
                UPSTrackingTbl2.DHLParcelHistEntryNo := DHLTrackingTabele."Entry No.";
                UPSTrackingTbl2.MODIFY;
                // E/gob-lku/31.07.2013/P1046
              //S/P1133
              END;
              //E/P1133
            END;
          //S/P1133
          END;

          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
            FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
          THEN BEGIN
            ParcelStatusHistory.RESET;
            ParcelStatusHistory.SETCURRENTKEY("Document No.","Document Line No.","Document Type");
            IF UPSTrackingTabele."ReferenceNumber Value" <> '' THEN
              ParcelStatusHistory.SETRANGE("Document No.",
              COPYSTR(UPSTrackingTabele."ReferenceNumber Value",1,STRLEN(UPSTrackingTabele."ReferenceNumber Value")-3))
            ELSE
              ParcelStatusHistory.SETFILTER("Document No.",'<>%1','');
            ParcelStatusHistory.SETRANGE("Document Type",ParcelStatusHistory."Document Type"::Order);
            ParcelStatusHistory.SETRANGE("Used Interface",ParcelStatusHistory."Used Interface"::UPS);
            //H1851  27.11.14  MBY  +++++++++++++++++++++++++
            //ParcelStatusHistory.SETRANGE("Status Sub Code",'21');
            ParcelStatusHistory.SETFILTER("Status Sub Code",'21|31');
            //H1851  27.11.14  MBY  -------------------------
            ParcelStatusHistory.CALCFIELDS("Status Description","Status Sub Description");
            ParcelStatusHistory.SETFILTER(
              ParcelStatusHistory."Status Sub Description",'=%1',UPSTrackingTabele.CustomerContext);
            ParcelStatusHistory.SETRANGE("Status Code",UPSTrackingTabele."StatusType Code");
            // S/P1186
            //ParcelStatusHistory.SETRANGE("Import API",ParcelStatusHistory."Import API"::UPS);
            // E/P1186
            IF ParcelStatusHistory.FIND('-') THEN BEGIN
              REPEAT
                EVALUATE(ActivitiyDateVariable,
                  COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                  COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                  COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                EVALUATE(ActivityTimeVariable,UPSTrackingTabele."Activity Time");
                // S/P1232
                //ParcelStatusHistory."Timestamp Insert" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                //ParcelStatusHistory."Timestamp Interface" := CURRENTDATETIME;
                ParcelStatusHistory."Timestamp Insert" := CURRENTDATETIME;
                ParcelStatusHistory."Timestamp Interface" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                // E/P1232
                // S/P1228
                //ParcelStatusHistory.MODIFY;
                ParcelStatusHistory.MODIFY(TRUE);
                // E/P1228
              UNTIL ParcelStatusHistory.NEXT = 0;
              IF FPCGeneralSetup."Active Parcel Status History" IN
                [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
                FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
              THEN BEGIN
                UPSTrackingTbl2.GET(UPSTrackingTabele."Entry no.");
                UPSTrackingTbl2.Pass := TRUE;
                UPSTrackingTbl2.SalesLineNo := ParcelStatusHistory."Document Line No.";
                UPSTrackingTbl2.DHLParcelHistEntryNo := ParcelStatusHistory."Entry No.";
                UPSTrackingTbl2.MODIFY;
              END;
              //E/P1133
            END;
          END;
          //E/P1133
        UNTIL UPSTrackingTabele.NEXT = 0;
      END;

      UPSTrackingTabele.RESET;
      // S/gob-lku/31.07.2013/P1046
      UPSTrackingTabele.SETCURRENTKEY(Pass);
      // E/gob-lku/31.07.2013/P1046
      UPSTrackingTabele.SETRANGE(Pass,FALSE);
      // S/gob-lku/25.07.2013/P1046
      //IF UPSTrackingTabele.FINDFIRST THEN BEGIN
      IF UPSTrackingTabele.FIND('-') THEN BEGIN
      // E/gob-lku/25.07.2013/P1046
        REPEAT
          //S/P1133
          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New"]
          THEN BEGIN
          //E/P1133
            DHLTrackingTabele.RESET;
            // S/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETCURRENTKEY("Document No.","Document Line No.","Document Type","Time Stamp");
            // S/gob-lku/14.08.2103/P1046
            //DHLTrackingTabele.SETFILTER("Sale Order Code",'<>%1','');
            IF UPSTrackingTabele."ReferenceNumber Value" <> '' THEN
              DHLTrackingTabele.SETRANGE("Document No.",COPYSTR(UPSTrackingTabele."ReferenceNumber Value",1,
                    STRLEN(UPSTrackingTabele."ReferenceNumber Value")-3))
            ELSE
              DHLTrackingTabele.SETFILTER("Document No.",'<>%1','');
            // E/gob-lku/14.08.2103/P1046
            DHLTrackingTabele.SETRANGE("Document Type",DHLTrackingTabele."Document Type"::Order);
            DHLTrackingTabele.SETFILTER("Time Stamp",'<>%1',0DT);
            // E/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETRANGE("Shipping Agent",'UPS');
            // S/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETFILTER("Time Stamp",'<>%1',0DT);
            // E/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETRANGE("Docdate Status Code",'21');
            // S/gob-lku/31.07.2013/P1046
            //DHLTrackingTabele.SETFILTER("Sale Order Code",'<>%1','');
            //DHLTrackingTabele.SETRANGE("Sales Doc Type",DHLTrackingTabele."Sales Doc Type"::Order);
            // E/gob-lku/31.07.2013/P1046
            DHLTrackingTabele.SETFILTER(DHLTrackingTabele."Docdata Status Description",'=%1',
             UPSTrackingTabele.CustomerContext);
             DHLTrackingTabele.SETRANGE("Final Status UPS",FALSE);
             DHLTrackingTabele.SETRANGE("Imported over UPS API",FALSE);
            // S/gob-lku/25.07.2013/P1046
            //IF DHLTrackingTabele.FINDFIRST THEN BEGIN
            IF DHLTrackingTabele.FIND('-') THEN BEGIN
            // E/gob-lku/25.07.2013/P1046
              REPEAT
                //S/P1133
                IF FPCGeneralSetup."Active Parcel Status History" IN
                  [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
                  FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
                THEN BEGIN
                  FindLastEntryNoInDHL.RESET;
                  FindLastEntryNoInDHL.FINDLAST;
                  // S/gob-lku/31.07.2013/P1046
                  //UPSTrackingTabele.Pass := TRUE;
                  //UPSTrackingTabele.DHLParcelHistEntryNo := FindLastEntryNoInDHL."Entry No." + 1;
                  //UPSTrackingTabele.SalesLineNo := DHLTrackingTabele."Line No.";
                  //UPSTrackingTabele."OrderNo." := DHLTrackingTabele."Sale Order Code";
                  //UPSTrackingTabele.MODIFY;
                  // S/P1082
                  UPSTrackingTbl2.GET(UPSTrackingTabele."Entry no.");
                  // E/P1082
                  UPSTrackingTbl2.Pass := TRUE;
                  UPSTrackingTbl2.DHLParcelHistEntryNo := FindLastEntryNoInDHL."Entry No." + 1;
                  UPSTrackingTbl2.SalesLineNo := DHLTrackingTabele."Document Line No.";
                  UPSTrackingTbl2."OrderNo." := DHLTrackingTabele."Document No.";
                  UPSTrackingTbl2.MODIFY;
                  // E/gob-lku/31.07.2013/P1046
                //S/P1133
                END;
                //E/P1133

                DHLTrackingTabeleInsertNew.INIT;
                DHLTrackingTabeleInsertNew."Entry No." := FindLastEntryNoInDHL."Entry No." + 1;
                // S/gob-lku/14.08.2013/P1046
                DHLTrackingTabeleInsertNew.INSERT;
                // E/gob-lku/14.08.2013/P1046
                DHLTrackingTabeleInsertNew."DHL Shipment Code" := '';
                DHLTrackingTabeleInsertNew."Account Number" := UPSTrackingTabele.ShipperNumber;
                DHLTrackingTabeleInsertNew."Production Line"       := '';
                DHLTrackingTabeleInsertNew.Product := '';
                TodayTimeToxport := CURRENTDATETIME;

                EVALUATE(ActivitiyDateVariable,COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                EVALUATE(ActivityTimeVariable,UPSTrackingTabele."Activity Time");

                // S/gob-lku/25.07.2013/P1046
                //DHLTrackingTabele."Time Stamp" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                DHLTrackingTabeleInsertNew."Time Stamp" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                // E/gob-lku/25.07.2013/P1046
                DHLTrackingTabeleInsertNew."Import Time Stamp" := TodayTimeToxport;
                DHLTrackingTabeleInsertNew."Detection Location" := '';
                DHLTrackingTabeleInsertNew."Country of Origin" := UPSTrackingTabele."Shipper CountryCode";
                DHLTrackingTabeleInsertNew."Piece-Code (Identifier)" := '';
                DHLTrackingTabeleInsertNew."Commit at Date" := TODAY;
                DHLTrackingTabeleInsertNew."Status Event" := UPSTrackingTabele."StatusType Code";
                DHLTrackingTabeleInsertNew."Status Code" := '';
                DHLTrackingTabeleInsertNew."Standart Event" := '';
                DHLTrackingTabeleInsertNew."Reference Number" := UPSTrackingTabele."ReferenceNumber Code";
                DHLTrackingTabeleInsertNew."Recipient Name Is" := '';
                DHLTrackingTabeleInsertNew."Recipient Name Target" := '';
                DHLTrackingTabeleInsertNew."Routing Code" := '';
                DHLTrackingTabeleInsertNew."Return Policies (Y/N)" := FALSE;
                EVALUATE(DHLTrackingTabeleInsertNew."Delivery Date",COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                                                                    COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                                                                    COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                EVALUATE(DHLTrackingTabeleInsertNew."Pickup Date",COPYSTR(UPSTrackingTabele.PickupDate,7,2)+
                                                                  COPYSTR(UPSTrackingTabele.PickupDate,5,2)+
                                                                  COPYSTR(UPSTrackingTabele.PickupDate,1,4));

                DHLTrackingTabeleInsertNew."Document No." := DHLTrackingTabele."Document No.";
                DHLTrackingTabeleInsertNew."Document Type" := DHLTrackingTabele."Document Type";
                DHLTrackingTabeleInsertNew."Document Line No." := DHLTrackingTabele."Document Line No.";
                DHLTrackingTabeleInsertNew."Shipment Date" := DHLTrackingTabele."Shipment Date";
                DHLTrackingTabeleInsertNew."Purchase Order Code" := DHLTrackingTabele."Purchase Order Code";
                DHLTrackingTabeleInsertNew."PO Line No." := DHLTrackingTabele."PO Line No.";
                DHLTrackingTabeleInsertNew."Current Status" := DHLTrackingTabele."Current Status";
                DHLTrackingTabeleInsertNew."Rhenus Entry" := DHLTrackingTabele."Rhenus Entry";
                DHLTrackingTabeleInsertNew.DeleteMe := DHLTrackingTabele.DeleteMe;
                DHLTrackingTabeleInsertNew."Status Drop Shipment" :=  DHLTrackingTabele."Status Drop Shipment";
                DHLTrackingTabeleInsertNew."Drop Shipment Status Desc." := DHLTrackingTabele."Drop Shipment Status Desc.";
                DHLTrackingTabeleInsertNew."Import Time Stamp" := CURRENTDATETIME;
                DHLTrackingTabeleInsertNew."Time Difference" := 0;
                DHLTrackingTabeleInsertNew."Status DHL" := DHLTrackingTabele."Status DHL";
                DHLTrackingTabeleInsertNew."Order Date" := DHLTrackingTabele."Order Date";
                DHLTrackingTabeleInsertNew."Shipment through" := DHLTrackingTabele."Shipment through";
                DHLTrackingTabeleInsertNew."Shipping Agent" := DHLTrackingTabele."Shipping Agent";
                //DHLTrackingTabeleInsertNew."VIR Status Comment" := DHLTrackingTabele."VIR Status Comment";
                DHLTrackingTabeleInsertNew."Status DHL HD" := DHLTrackingTabele."Status DHL HD";
                DHLTrackingTabeleInsertNew."Status Docdata" := DHLTrackingTabele."Status Docdata";
                DHLTrackingTabeleInsertNew."Docdate Status Code" := DHLTrackingTabele."Docdate Status Code";
                DHLTrackingTabeleInsertNew."DHL HD Status Code" := DHLTrackingTabele."DHL HD Status Code";
                DHLTrackingTabeleInsertNew."Docdata Status Description" := DHLTrackingTabele."Docdata Status Description";
                IF UPSTrackingTabele.ResponseStatusCode = '1' THEN BEGIN
                  DHLTrackingTabeleInsertNew."DHL HD Status Description" := COPYSTR(UPSTrackingTabele."StatusType Description",1,50);
                  DHLTrackingTabele."DHL HD Status Description" := COPYSTR(UPSTrackingTabele."StatusType Description",1,50);
                  DHLTrackingTabele.MODIFY;
                END ELSE BEGIN
                  DHLTrackingTabeleInsertNew."DHL HD Status Description" := COPYSTR(UPSTrackingTabele.ErrorDescription,1,50);
                  DHLTrackingTabele."DHL HD Status Description" := COPYSTR(UPSTrackingTabele.ErrorDescription,1,50);
                  DHLTrackingTabele.MODIFY;
                END;

                DHLTrackingTabeleInsertNew."Imported over DHL API" := DHLTrackingTabele."Imported over DHL API";
                DHLTrackingTabeleInsertNew."Imported over UPS API" := TRUE;
                DHLTrackingTabeleInsertNew."Status RIC Name" := DHLTrackingTabele."Status RIC Name";
                DHLTrackingTabeleInsertNew."Status Event Name" := DHLTrackingTabele."Status Event Name";
                DHLTrackingTabeleInsertNew."Rhenus Status Description" := DHLTrackingTabele."Rhenus Status Description";



                IF UPSTrackingTabele."StatusType Code" = 'D' THEN BEGIN
                  DHLTrackingTabeleInsertNew."Final Status UPS" := TRUE;
                  // S/gob-lku/31.07.2013/P1046
                  //DHLTrackingTabele."Final Status UPS" := TRUE;
                  //DHLTrackingTabele.MODIFY;
                  SetFinalStatus(DHLTrackingTabele."Document No.",DHLTrackingTabele."Document Type",
                    DHLTrackingTabele."Document Line No.");
                  // E/gob-lku/31.07.2013/P1046
                  DHLTrackingTabele.MODIFY;
                END;

                IF UPSTrackingTabele.AlternateTrackingNumber <> '' THEN BEGIN
                  DHLTrackingTabeleInsertNew."Final Status UPS" := TRUE;
                  // S/gob-lku/31.07.2013/P1046
                  //DHLTrackingTabele."Final Status UPS" := TRUE;
                  //DHLTrackingTabele.MODIFY;
                  SetFinalStatus(DHLTrackingTabele."Document No.",DHLTrackingTabele."Document Type",
                    DHLTrackingTabele."Document Line No.");
                  // E/gob-lku/31.07.2013/P1046
                  DHLTrackingTabele.AlternateTrackinNumberUPS := UPSTrackingTabele.AlternateTrackingNumber;
                  DHLTrackingTabeleInsertNew.AlternateTrackinNumberUPS := UPSTrackingTabele.AlternateTrackingNumber;
                  DHLTrackingTabele.MODIFY;
                END;


                // S/gob-lku/14.08.2013/P1046
                //DHLTrackingTabeleInsertNew.INSERT;
                // E/gob-lku/14.08.2013/P1046
                //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
                {
                //H0686  04.12.13  MBY  ----------------------------
                DHLTrackingTabeleInsertNew.MODIFY;
                //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
                }
                DHLTrackingTabeleInsertNew.MODIFY(TRUE);
                //H0686  04.12.13  MBY  ----------------------------
              UNTIL DHLTrackingTabele.NEXT = 0;
          //S/P1133
          END;

          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
            FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
          THEN BEGIN
            ParcelStatusHistory.RESET;
            ParcelStatusHistory.SETCURRENTKEY("Document No.","Document Line No.","Document Type");
            IF UPSTrackingTabele."ReferenceNumber Value" <> '' THEN
              ParcelStatusHistory.SETRANGE("Document No.",
                COPYSTR(UPSTrackingTabele."ReferenceNumber Value",1,STRLEN(UPSTrackingTabele."ReferenceNumber Value")-3))
            ELSE
              ParcelStatusHistory.SETFILTER("Document No.",'<>%1','');
            ParcelStatusHistory.SETRANGE("Document Type",ParcelStatusHistory."Document Type"::Order);
            ParcelStatusHistory.SETFILTER("Timestamp Insert",'<>%1',0DT);
            // S/P1186
            //ParcelStatusHistory.SETRANGE("Used Interface",ParcelStatusHistory."Used Interface"::UPS);
            ParcelStatusHistory.SETFILTER("Used Interface",'<>%1',ParcelStatusHistory."Used Interface"::UPS);
            // E/P1186
            ParcelStatusHistory.SETFILTER("Timestamp Insert",'<>%1',0DT);
            //H1851  27.11.14  MBY  +++++++++++++++++++++++++
            //ParcelStatusHistory.SETRANGE("Status Sub Code",'21');
            ParcelStatusHistory.SETFILTER("Status Sub Code",'21|31');
            //H1851  27.11.14  MBY  -------------------------
            ParcelStatusHistory.CALCFIELDS("Status Description","Status Sub Description");
            ParcelStatusHistory.SETFILTER(ParcelStatusHistory."Status Sub Description",'=%1',UPSTrackingTabele.CustomerContext);
            // S/P1186
            //ParcelStatusHistory.SETFILTER("Import API",'<>%1',ParcelStatusHistory."Import API"::UPS);
            // S/P1204
            //ParcelStatusHistory.SETFILTER("Status Code",'<>%1','D');
            ParcelStatusHistory.SETRANGE("Is Final Status",FALSE);
            // E/P1204
            // E/P1186
            IF ParcelStatusHistory.FIND('-') THEN BEGIN
              REPEAT
                IF FPCGeneralSetup."Active Parcel Status History" IN
                  [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
                  FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
                THEN BEGIN
                  ParcelStatusHistoryFindLast.RESET;
                  ParcelStatusHistoryFindLast.FINDLAST;
                  UPSTrackingTbl2.GET(UPSTrackingTabele."Entry no.");
                  UPSTrackingTbl2.Pass := TRUE;
                  UPSTrackingTbl2.DHLParcelHistEntryNo := ParcelStatusHistoryFindLast."Entry No." + 1;
                  UPSTrackingTbl2.SalesLineNo := ParcelStatusHistory."Document Line No.";
                  UPSTrackingTbl2."OrderNo." := ParcelStatusHistory."Document No.";
                  UPSTrackingTbl2.MODIFY;
                END;
                ParcelStatusHistoryInsert.INIT;
                ParcelStatusHistoryInsert.TRANSFERFIELDS(ParcelStatusHistory);
                ParcelStatusHistoryInsert."Entry No." := ParcelStatusHistoryFindLast."Entry No." + 1;
                ParcelStatusHistoryInsert.INSERT;
                ParcelStatusHistoryInsert."Tracking Code" := '';
                ParcelStatusHistoryInsert."Account No." := UPSTrackingTabele.ShipperNumber;
                TodayTimeToxport := CURRENTDATETIME;
                EVALUATE(ActivitiyDateVariable,
                  COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                  COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                  COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                EVALUATE(ActivityTimeVariable,UPSTrackingTabele."Activity Time");
                ParcelStatusHistoryInsert."Timestamp Interface" := CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable);
                ParcelStatusHistoryInsert."Timestamp Insert" := TodayTimeToxport;
                ParcelStatusHistoryInsert."Piece Code" := '';
                ParcelStatusHistoryInsert."Date Commit" := TODAY;
                ParcelStatusHistoryInsert."Status Code" := UPSTrackingTabele."StatusType Code";
                // S/P1186
                //ParcelStatusHistoryInsert."Status RIC Code" := '';
                ParcelStatusHistoryInsert."Status Sub Code" := ParcelStatusHistory."Status Sub Code";
                // E/P1186
                EVALUATE(ParcelStatusHistoryInsert."Date Delivery",
                  COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                  COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                  COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                EVALUATE(ParcelStatusHistoryInsert."Date Pickup",
                  COPYSTR(UPSTrackingTabele.PickupDate,7,2)+
                  COPYSTR(UPSTrackingTabele.PickupDate,5,2)+
                  COPYSTR(UPSTrackingTabele.PickupDate,1,4));
                // S/P1170
                IF ParcelStatusHistoryInsert."Timestamp Interface" <> 0DT THEN
                // E/P1170
                  ParcelStatusHistoryInsert."Timestamp Difference" :=
                    ParcelStatusHistory."Timestamp Insert" - ParcelStatusHistory."Timestamp Interface";
                // S/P1170
                IF ParcelStatusHistoryInsert."Timestamp Difference" < 0 THEN
                  ParcelStatusHistoryInsert."Timestamp Difference" := ParcelStatusHistoryInsert."Timestamp Difference" * -1;
                // E/P1170
                // S/P1204
                { ****
                IF UPSTrackingTabele.ResponseStatusCode = '1' THEN BEGIN
                  ParcelStatusHistoryInsert."Comment Part 1" := COPYSTR(UPSTrackingTabele."StatusType Description",1,50);
                  ParcelStatusHistory."Comment Part 1" := COPYSTR(UPSTrackingTabele."StatusType Description",1,50);
                  ParcelStatusHistory.MODIFY;
                END ELSE BEGIN
                  ParcelStatusHistoryInsert.Error := TRUE;
                  ParcelStatusHistoryInsert."Comment Part 1" := COPYSTR(UPSTrackingTabele.ErrorDescription,1,50);
                  ParcelStatusHistory.Error := TRUE;
                  ParcelStatusHistory."Comment Part 1" := COPYSTR(UPSTrackingTabele.ErrorDescription,1,50);
                  ParcelStatusHistory.MODIFY;
                END;
                *** }
                IF UPSTrackingTabele.ResponseStatusCode = '1' THEN BEGIN
                  ParcelStatusHistoryInsert."Comment Part 2" := COPYSTR(UPSTrackingTabele."StatusType Description",1,50);
                  ParcelStatusHistory."Comment Part 2" := COPYSTR(UPSTrackingTabele."StatusType Description",1,50);
                  // S/P1228
                  //ParcelStatusHistory.MODIFY;
                  ParcelStatusHistory.MODIFY(TRUE);
                  // E/P1228
                END ELSE BEGIN
                  ParcelStatusHistoryInsert.Error := TRUE;
                  ParcelStatusHistoryInsert."Comment Part 2" := COPYSTR(UPSTrackingTabele.ErrorDescription,1,50);
                  ParcelStatusHistory.Error := TRUE;
                  ParcelStatusHistory."Comment Part 2" := COPYSTR(UPSTrackingTabele.ErrorDescription,1,50);
                  // S/P1228
                  //ParcelStatusHistory.MODIFY;
                  ParcelStatusHistory.MODIFY(TRUE);
                  // E/P1228
                END;
                ParcelStatusHistoryInsert."Tracking Code" := UPSTrackingTabele.TrackingNumber;
                // E/P1204
                ParcelStatusHistoryInsert."Import API" := ParcelStatusHistory."Import API"::UPS;
                // S/P1204
                { ****
                IF UPSTrackingTabele.AlternateTrackingNumber <> '' THEN BEGIN
                  ParcelStatusHistory."Comment Part 2" := UPSTrackingTabele.AlternateTrackingNumber;
                  ParcelStatusHistoryInsert."Comment Part 2" := UPSTrackingTabele.AlternateTrackingNumber;
                  ParcelStatusHistory.MODIFY;
                END;
                **** }
                IF UPSTrackingTabele.AlternateTrackingNumber <> '' THEN BEGIN
                  ParcelStatusHistory."Comment Part 4" := 'Alt. Track. No.: ' + UPSTrackingTabele.AlternateTrackingNumber;
                  ParcelStatusHistoryInsert."Comment Part 1" := 'Alt. Track. No.: ' + UPSTrackingTabele.AlternateTrackingNumber;
                  // S/P1228
                  //ParcelStatusHistory.MODIFY;
                  ParcelStatusHistory.MODIFY(TRUE);
                  // E/P1228
                END;
                IF UPSTrackingTabele."ReferenceNumber Code" <> '' THEN
                  ParcelStatusHistoryInsert."Comment Part 3" := 'Ref. No.: ' + UPSTrackingTabele."ReferenceNumber Code";
                // E/P1204
                //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
                {
                //H0777  28.01.14  MBY  ----------------------------
                ParcelStatusHistoryInsert.MODIFY;
                //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
                }
                ParcelStatusHistoryInsert.MODIFY(TRUE);
                //H0777  28.01.14  MBY  ----------------------------
                // S/P1204
                // S/P1180
                //CLEAR(CUParcelStatusHistoryMgmt);
                //CUParcelStatusHistoryMgmt.CheckIfArchivedOrder(ParcelStatusHistoryInsert."Entry No.");
                // E/P1180
                CLEAR(IDForArchiving);
                IDForArchiving := ParcelStatusHistoryInsert."Entry No.";
                IF (UPSTrackingTabele."StatusType Code" = 'D') OR
                   (UPSTrackingTabele.AlternateTrackingNumber <> '')
                THEN BEGIN
                  ParcelStatusHistoryInsert."Is Final Status" := TRUE;
                  // S/P1228
                  //ParcelStatusHistoryInsert.MODIFY;
                  ParcelStatusHistoryInsert.MODIFY(TRUE);
                  // E/P1228
                  SetFinalStatusNew(
                    ParcelStatusHistory."Document No.",
                    ParcelStatusHistory."Document Type",
                    ParcelStatusHistory."Document Line No.");
                END;
                CLEAR(CUParcelStatusHistoryMgmt);
                CUParcelStatusHistoryMgmt.CheckIfArchivedOrder(IDForArchiving);
                // E/P1204
              UNTIL ParcelStatusHistory.NEXT = 0;
            END;
          END;
          //E/P1133
          END;
        UNTIL UPSTrackingTabele.NEXT = 0;
      END;

      //S/P1133
      IF FPCGeneralSetup."Active Parcel Status History" IN
        [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old"]
      THEN BEGIN
      //E/P1133
        DHLTrackingTabele.RESET;
        // S/gob-lku/31.07.2013/P1046
        DHLTrackingTabele.SETCURRENTKEY("Document No.","Document Line No.","Document Type","Time Stamp");
        DHLTrackingTabele.SETFILTER("Document No.",'<>%1','');
        DHLTrackingTabele.SETRANGE("Document Type",DHLTrackingTabele."Document Type"::Order);
        DHLTrackingTabele.SETFILTER("Time Stamp",'=%1',0DT);
        // E/gob-lku/31.07.2013/P1046
        DHLTrackingTabele.SETRANGE("Shipping Agent",'UPS');
        // S/gob-lku/31.07.2013/P1046
        //DHLTrackingTabele.SETFILTER("Time Stamp",'=%1',0DT);
        // E/gob-lku/31.07.2013/P1046
        DHLTrackingTabele.SETRANGE("Docdate Status Code",'21');
        // S/gob-lku/31.07.2013/P1046
        //DHLTrackingTabele.SETFILTER("Sale Order Code",'<>%1','');
        //DHLTrackingTabele.SETRANGE("Sales Doc Type",DHLTrackingTabele."Sales Doc Type"::Order);
        // E/gob-lku/31.07.2013/P1046
        DHLTrackingTabele.SETFILTER(DHLTrackingTabele."Docdata Status Description",'=%1',
        UPSTrackingTabele.CustomerContext);
        DHLTrackingTabele.SETRANGE("Imported over UPS API",TRUE);
        IF DHLTrackingTabele.FIND('-') THEN BEGIN
                EVALUATE(ActivitiyDateVariable,COPYSTR(UPSTrackingTabele."Activity Date",7,2)+
                COPYSTR(UPSTrackingTabele."Activity Date",5,2)+
                COPYSTR(UPSTrackingTabele."Activity Date",1,4));
                EVALUATE(ActivityTimeVariable,UPSTrackingTabele."Activity Time");
          //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
          {
          //H0777  28.01.14  MBY  ----------------------------
          DHLTrackingTabele.MODIFYALL("Time Stamp",CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable));
          //H0777  28.01.14  MBY  ++++++++++++++++++++++++++++
          }
          DHLTrackingTabele.MODIFYALL("Time Stamp",CREATEDATETIME(ActivitiyDateVariable,ActivityTimeVariable),TRUE);
          //H0777  28.01.14  MBY  ----------------------------
        END;
      //S/P1133
      END;
      //E/P1133
    END;

    PROCEDURE SetFinalStatus@1000000016(SONo@1000000000 : Code[20];SOType@1000000002 : Option;LineNo@1000000001 : Integer);
    VAR
      DHLParcelsStatusHistory@1000000003 : Record 50021;
      "**** HME *********************"@1000000004 : Integer;
      ParcelStatusHistoryL@1000000005 : Record 80013;
      ParcelStatusHistoryArchiveL@1000000006 : Record 50187;
    BEGIN
      //S/P1133
      FPCGeneralSetup.GET;
      //E/P1133

      //S/P1133
      IF FPCGeneralSetup."Active Parcel Status History" IN
        [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
        // S/P1204
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
        // E/P1204
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old"]
      THEN BEGIN
      //E/P1133
        // S/gob-lku/31.07.2013/P1046
        DHLParcelsStatusHistory.SETCURRENTKEY("Document No.","Document Line No.","Document Type","Time Stamp");
        DHLParcelsStatusHistory.SETRANGE("Document No.",SONo);
        DHLParcelsStatusHistory.SETRANGE("Document Line No.",LineNo);
        DHLParcelsStatusHistory.SETRANGE("Document Type",SOType);
        DHLParcelsStatusHistory.SETRANGE("Shipping Agent",'UPS');
        DHLParcelsStatusHistory.SETRANGE("Docdate Status Code",'21');
        DHLParcelsStatusHistory.MODIFYALL("Final Status UPS",TRUE);
        // E/gob-lku/31.07.2013/P1046

      //H1436       03.09.14 JM +++++++++++++++++++++++++++++++++++
      {
        //H1377 18.07.14 DMA +++++++++++++++++++++++++++++++++++++++
        ParcelStatusHistoryL.RESET;
        ParcelStatusHistoryL.SETRANGE("Sales Doc. Type", SOType);
        ParcelStatusHistoryL.SETRANGE("Sales Doc. No.", SONo);
        ParcelStatusHistoryL.SETRANGE("Sales Doc. Line No.", LineNo);
        ParcelStatusHistoryL.SETRANGE("Shipping Agent Code", 'UPS');
        ParcelStatusHistoryL.SETRANGE("Status Sub Code",'21');
        ParcelStatusHistoryL.MODIFYALL("Is Final Status",TRUE);

        ParcelStatusHistoryArchiveL.RESET;
        ParcelStatusHistoryArchiveL.SETRANGE("Sales Doc. Type", SOType);
        ParcelStatusHistoryArchiveL.SETRANGE("Sales Doc. No.", SONo);
        ParcelStatusHistoryArchiveL.SETRANGE("Sales Doc. Line No.", LineNo);
        ParcelStatusHistoryArchiveL.SETRANGE("Shipping Agent Code", 'UPS');
        ParcelStatusHistoryArchiveL.SETRANGE("Status Sub Code",'21');
        ParcelStatusHistoryArchiveL.MODIFYALL("Is Final Status",TRUE);
      }
      //H1436       03.09.14 JM +++++++++++++++++++++++++++++++++++

        //H1377 18.07.14 DMA ---------------------------------------
      //S/P1133
      END;
      //E/P1133
    END;

    PROCEDURE SetPassForFailure@1000000017();
    VAR
      UPSTracking@1000000000 : Record 50124;
    BEGIN
      UPSTracking.SETCURRENTKEY(Pass);
      UPSTracking.SETRANGE(Pass,FALSE);
      UPSTracking.SETRANGE(ResponseStatusDescription,'Failure');
      UPSTracking.MODIFYALL(Pass,TRUE);
    END;

    PROCEDURE SetFinalStatusNew@1000000018(SONo@1000000000 : Code[20];SOType@1000000002 : Option;LineNo@1000000001 : Integer);
    VAR
      ParcelStatusHistoryLoc@1000000004 : Record 80013;
      ParcelStatusHistoryArchiveLoc@1000000005 : Record 50187;
    BEGIN
      // S/P1204
      FPCGeneralSetup.GET;
      //H2064 26.02.15 MSL ++++++++++++++++++++++++++++++
      DeleteBatchTrackingActionEntry(SOType,SONo,LineNo);
      //H2064 26.02.15 MSL ------------------------------

      IF FPCGeneralSetup."Active Parcel Status History" IN
        [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
        // H1519       04.08.14 JM ++++++++++++++++++++++++++++
        // FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
        // H1519       04.08.14 JM ----------------------------
        FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
      THEN BEGIN
        ParcelStatusHistoryLoc.RESET;
        ParcelStatusHistoryLoc.SETCURRENTKEY("Document No.","Document Line No.","Document Type");
        ParcelStatusHistoryLoc.SETRANGE("Document Type",SOType);
        ParcelStatusHistoryLoc.SETRANGE("Document No.",SONo);
        ParcelStatusHistoryLoc.SETRANGE("Document Line No.",LineNo);
        ParcelStatusHistoryLoc.SETRANGE("Shipping Agent Code",'UPS');
        //H1851  27.11.14  MBY  +++++++++++++++++++++++++
        //ParcelStatusHistoryLoc.SETRANGE("Status Sub Code",'21');
        ParcelStatusHistoryLoc.SETFILTER("Status Sub Code",'21|31');
        //H1851  27.11.14  MBY  -------------------------
        // S/P1228
        //ParcelStatusHistoryLoc.MODIFYALL("Is Final Status",TRUE);
        ParcelStatusHistoryLoc.MODIFYALL("Is Final Status",TRUE,TRUE);
        // E/P1228

        ParcelStatusHistoryArchiveLoc.RESET;
        ParcelStatusHistoryArchiveLoc.SETCURRENTKEY("Document No.","Document Line No.","Document Type");
        ParcelStatusHistoryArchiveLoc.SETRANGE("Document Type",SOType);
        ParcelStatusHistoryArchiveLoc.SETRANGE("Document No.",SONo);
        ParcelStatusHistoryArchiveLoc.SETRANGE("Document Line No.",LineNo);
        ParcelStatusHistoryArchiveLoc.SETRANGE("Shipping Agent Code",'UPS');
        //H1851  27.11.14  MBY  +++++++++++++++++++++++++
        //ParcelStatusHistoryArchiveLoc.SETRANGE("Status Sub Code",'21');
        ParcelStatusHistoryArchiveLoc.SETFILTER("Status Sub Code",'21|31');
        //H1851  27.11.14  MBY  -------------------------
        // S/P1228
        //ParcelStatusHistoryArchiveLoc.MODIFYALL("Is Final Status",TRUE);
        ParcelStatusHistoryArchiveLoc.MODIFYALL("Is Final Status",TRUE,TRUE);
        // E/P1228
      END;
      // E/P1204
    END;

    PROCEDURE VolumeMgt@1000000019(Action@1000000002 : 'Calculate,Count');
    VAR
      VolumeToProcessL@1000000000 : Decimal;
    BEGIN
      //H2064,H1522  26.02.15 MSL +++++++++++++++++++++++
      IF Action = Action::Calculate THEN BEGIN
        IF (VolumePercent >= 100) OR (VolumePercent = 0) THEN
          VolumePercent := 100;
        IF VolumePercent = 100 THEN BEGIN
          //Run 100%
          VolumeToProcess := Volume;
        END ELSE BEGIN
          VolumeToProcessL := Volume / 100 * VolumePercent;
          VolumeToProcessL := ROUND(VolumeToProcessL,1,'=');
          VolumeToProcess := VolumeToProcessL;
        END;
      END;
      IF Action = Action::Count THEN BEGIN
        VolumeCount := VolumeCount + 1;
        IF VolumeToProcess = VolumeCount THEN
          VolumeBreak := TRUE;
      END;
      //H2064,H1522  26.02.15 MSL ----------------------
    END;

    PROCEDURE DeleteBatchTrackingActionEntry@1000000020(DocType@1000000001 : Option;DocNo@1000000002 : Code[20];DocLineNo@1000000000 : Integer);
    VAR
      BatchTrackingActionL@1000000003 : Record 50245;
    BEGIN
      BatchTrackingActionL.SETRANGE("Document Type",DocType);
      BatchTrackingActionL.SETRANGE("Document No.",DocNo);
      BatchTrackingActionL.SETRANGE("Line No.",DocLineNo);
      BatchTrackingActionL.SETRANGE("Shipping Agent",BatchTrackingActionL."Shipping Agent"::UPS);
      BatchTrackingActionL.DELETEALL;
    END;

    BEGIN
    {
      +--------------------------------------------+
      |                                            |
      |                  Home24                    |
      |       Internal Customizing by NAV-Team     |
      |                                            |
      +--------------------------------------------+

      Project No. Date     Shortcut  Description
      _____________________________________________

      H0216      22.02.13 PAU       Ups Tracking
           '</TrackRequest>',TempTabDistinct."No."+'|'+TempTabDistinct."No. 2"+'/'+TempTabDistinct.Description,TempTabDistinct."No.");
      H0686       04.12.13 MBY       Execute OnModify trigger in "DHL Parcels Status History" table
      H0777       28.01.14 MBY       Execute OnModify trigger in "DHL Parcels Status History" table
      H1326       03.07.14 MBY       HotFix: UPS Tracking job
      H1377       18.07.14 DMA       Bug: UPS Tracking Job - 'Is Final Status' is not field when receive Final Status UPS, CODECHANGE
      H1436       06.08.14 DMA       UPS: Add segment "Redirect" to importer and processing, CODECHANGE
      H1436       03.09.14 JM        UPS: Add segment "Redirect" Code Change
      H1519       04.09.14 JM        Bug Fix: for H1436 , UPS Tracking Job - 'Is Final Status' H1436XX = dummy to merge
      H1522       05.09.14 JM        UPS Tracking reducing the processvolume by percentage
      H1554       02.10.14 DMA       Bugfix: UPS Job: MultiLine Order: Entry is not inserted to Parcel History table, codechange
      H1851       27.11.14 MBY       WHSLF: Add UPS tracking matching to new warehouse orders
      H1932       22.12.14 DMA       BUG: Recover UPS Job for WHS LF, CODECHANGE
      H2064       26.02.15 MSL       UPS Redesign: Scanning to Trigger based
      +--------------------------------------------+
      |                                            |
      |                  Home24                    |
      |     Cooperation GOB & Home24 NAV Team      |
      |                                            |
      +--------------------------------------------+

      Project No. Date      Shortcut  Description
      _____________________________________________
      P1046       25.07.13  gob-lku   diverse Anpassungen
      P1082       22.08.13  gob-lku   Fix - UPS Tabelle erneut getten
      P1117       08.10.13  gob-mlan  - Redesign of "DHL Parcel Status History"
                                      - Code within with //S/P1117/++S+++++++ and //E/P1117/--E-------
                                        will be replaced by the new code and/or it will be deactivated
      P1124       08.10.13  gob-lku   Fix - leere XML abfangen
      P1133       07.11.13  gob-mlan  Redesign of "DHL Parcel Status History"
      P1170       19.12.13  gob-mlan  Fix after test response M. Matyushenko
      P1171       06.01.14  gob-lku   TimeAndDate inkl. ms
      P1184       29.01.14  gob-mlan  Fix after test response M. Matyushenko
      P1186       31.01.14  gob-mlan  Fix after test response M. Matyushenko
      P1204       01.03.14  gob-mlan  Fix after test response M. Matyushenko
      P1228       30.03.14  gob-mlan  Adopt "Tracking Actions"-Logic (MBY) from T50021
      P1232       15.04.14  gob-mlan  Fix "Status Description" in "TempTabDistinct"
    }
    END.
  }
}

