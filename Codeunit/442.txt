OBJECT Codeunit 442 Sales-Post Prepayments
{
  OBJECT-PROPERTIES
  {
    Date=07.01.15;
    Time=16:27:27;
    Modified=Yes;
    Version List=NAVW16.00.01,DN(3),GOB1.01,OPP6.00,HME1408,T0078;
  }
  PROPERTIES
  {
    Permissions=TableData 37=imd,
                TableData 49=imd,
                TableData 112=imd,
                TableData 113=imd,
                TableData 114=imd,
                TableData 115=imd,
                TableData 252=imd,
                TableData 357=imd,
                TableData 359=imd;
    OnRun=BEGIN
          END;

  }
  CODE
  {
    VAR
      Text000@1000 : TextConst 'DEU=liegt nicht innerhalb des zugelassenen Buchungszeitraums.;ENU=is not within your range of allowed posting dates';
      GLSetup@1024 : Record 98;
      GenPostingSetup@1002 : Record 252;
      Text001@1003 : TextConst 'DEU=Es gibt nichts zu buchen.;ENU=There is nothing to post.';
      Text002@1006 : TextConst 'DEU=Vorauszahlungszeilen werden gebucht   #2######\;ENU=Posting Prepayment Lines   #2######\';
      Text003@1004 : TextConst 'DEU=%1 %2 -> Rechnung %3;ENU=%1 %2 -> Invoice %3';
      Text004@1005 : TextConst 'DEU=Verkauf und MwSt. buchen              #3######\;ENU=Posting sales and VAT      #3######\';
      Text005@1007 : TextConst 'DEU=Debitor buchen                        #4######\;ENU=Posting to customers       #4######\';
      Text006@1022 : TextConst 'DEU=Buchung an Gegenkonto                 #5######;ENU=Posting to bal. account    #5######';
      Text007@1009 : TextConst 'DEU=Die Kombination der in %1 %2 verwendeten Dimensionen ist gesperrt. %3;ENU=The combination of dimensions used in %1 %2 is blocked. %3';
      Text008@1008 : TextConst 'DEU=Die Kombination der in %1 %2, Zeilennr. %3, verwendeten Dimensionen ist gesperrt. %4;ENU=The combination of dimensions used in %1 %2, line no. %3 is blocked. %4';
      Text009@1011 : TextConst 'DEU=Die Dimensionen, die in %1 %2 verwendet werden, sind ungÅltig. %3;ENU=The dimensions used in %1 %2 are invalid. %3';
      Text010@1010 : TextConst 'DEU=Die Dimensionen, die in %1 %2, Zeilennr. %3, verwendet werden, sind ungÅltig. %4;ENU=The dimensions used in %1 %2, line no. %3 are invalid. %4';
      GenJnlPostLine@1013 : Codeunit 12;
      DimBufMgt@1012 : Codeunit 411;
      Text011@1001 : TextConst 'DEU=%1 %2 -> Gutschrift %3;ENU=%1 %2 -> Credit Memo %3';
      Text012@1015 : TextConst 'DEU=Vorauszahlung %1, %2 %3.;ENU=Prepayment %1, %2 %3.';
      Text013@1016 : TextConst 'DEU=Ein Vorauszahlungsbetrag von %1 kann den Verkaufszeilen nicht zugewiesen werden.;ENU=It is not possible to assign a prepayment amount of %1 to the sales lines.';
      Text014@1018 : TextConst 'DEU=MwSt.-Betrag;ENU=VAT Amount';
      Text015@1017 : TextConst 'DEU=%1% MwSt.;ENU=%1% VAT';
      Text016@1019 : TextConst 'DEU=Der neue Vorauszahlungsbetrag muss zwischen %1 und %2 liegen.;ENU=The new prepayment amount must be between %1 and %2.';
      Text017@1020 : TextConst 'DEU=Mindestens eine Zeile muss %1 > 0 aufweisen, um den Vorauszahlungsbetrag zu verteilen.;ENU=At least one line must have %1 > 0 to distribute prepayment amount.';
      Text018@1021 : TextConst 'DEU=muss positiv sein, wenn %1 nicht 0 ist.;ENU=must be positive when %1 is not 0';
      Text019@1014 : TextConst 'DEU=Rechnung,Gutschrift;ENU=Invoice,Credit Memo';
      CurrExchRate@1023 : Record 330;
      Res@1000000000 : Record 156;
      GOBLineNo@1108200000 : Integer;
      TempVATAmount@1000000002 : TEMPORARY Record 290;
      GOBSalesLine@1000000003 : Record 37;
      TotalAmount@1000000004 : Decimal;
      TotalAmountVAT@1000000005 : Decimal;
      TotalAmountinclVat@1000000006 : Decimal;
      VatPostingSetup@1000000007 : Record 325;
      CallFromRelease@1000000001 : Boolean;

    PROCEDURE Invoice@9(VAR SalesHeader@1000 : Record 36);
    VAR
      LT_SalesLine@1000000000 : Record 37;
    BEGIN
      // 2.00 B >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
      IF SalesHeader."Document Type" = SalesHeader."Document Type"::Order THEN
        WITH LT_SalesLine DO BEGIN
          SETRANGE("Document Type",SalesHeader."Document Type");
          SETRANGE("Document No.",SalesHeader."No.");
          SETFILTER(Quantity,'<>0');
          //A/gob-adb/15.05.13
          //IF FINDSET(TRUE,FALSE) THEN REPEAT
          IF FIND('-') THEN REPEAT
          //E/gob-adb/15.05.13
            IF "Inv. Discount Amount" <> 0 THEN BEGIN
              IF "Quantity Invoiced" = 0 THEN BEGIN
                "Prepmt. Line Amount" := ROUND(("Line Amount" - "Inv. Discount Amount") * "Prepayment %" / 100);
              END ELSE BEGIN
                IF "Prepayment %" <> 0 THEN
                  "Prepmt. Line Amount" := "Prepmt. Amt. Inv." +
                    ROUND(("Line Amount" - "Inv. Discount Amount") * (Quantity - "Quantity Invoiced") / Quantity * "Prepayment %" / 100)
                ELSE
                  "Prepmt. Line Amount" := ROUND(("Line Amount" - "Inv. Discount Amount") * "Prepayment %" / 100);
              END;
              LT_SalesLine.MODIFY;
            END;
          UNTIL LT_SalesLine.NEXT = 0;
        END;
      // 2.00 E <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

      Code(SalesHeader,0);
    END;

    PROCEDURE CreditMemo@10(VAR SalesHeader@1000 : Record 36);
    BEGIN
      Code(SalesHeader,1);
    END;

    LOCAL PROCEDURE Code@2(VAR SalesHeader2@1013 : Record 36;DocumentType@1022 : 'Invoice,Credit Memo');
    VAR
      SalesSetup@1010 : Record 311;
      SourceCodeSetup@1027 : Record 242;
      PaymentTerms@1030 : Record 3;
      Cust@1029 : Record 18;
      SalesHeader@1000 : Record 36;
      SalesLine@1001 : Record 37;
      SalesInvHeader@1002 : Record 112;
      SalesCrMemoHeader@1023 : Record 114;
      SalesInvLine@1014 : Record 113;
      SalesCrMemoLine@1024 : Record 115;
      PrepmtInvBuffer@1021 : TEMPORARY Record 461;
      TotalPrepmtInvLineBuffer@1019 : Record 461;
      TotalPrepmtInvLineBufferLCY@1020 : Record 461;
      GenJnlLine@1012 : Record 81;
      TempVATAmountLine@1000000002 : TEMPORARY Record 290;
      TempVATAmountLineDeduct@1015 : TEMPORARY Record 290;
      TempDocDim@1017 : TEMPORARY Record 357;
      TempJnlLineDim@1018 : TEMPORARY Record 356;
      TempDimBuf@1011 : TEMPORARY Record 360;
      CustLedgEntry@1031 : Record 21;
      DocDim@1033 : Record 357;
      TempSalesLines@1032 : TEMPORARY Record 37;
      GenJnlCheckLine@1009 : Codeunit 11;
      NoSeriesMgt@1008 : Codeunit 396;
      DimMgt@1007 : Codeunit 408;
      Window@1000000003 : Dialog;
      GenJnlLineDocNo@1006 : Code[20];
      GenJnlLineExtDocNo@1005 : Code[20];
      SrcCode@1004 : Code[10];
      PostingDescription@1028 : Text[50];
      GenJnlLineDocType@1003 : Integer;
      PrevLineNo@1016 : Integer;
      LineCount@1000000004 : Integer;
      PostedDocTabNo@1025 : Integer;
      LineNo@1026 : Integer;
      LT_GLAcc@1000000000 : Record 15;
      "*****GOB****"@1108200000 : Integer;
      GLSetup@1108200001 : Record 98;
      ReleaseSalesDoc@1108200002 : Codeunit 414;
      SalesLineLoc@1108200003 : Record 37;
      CancelOrder@1108200004 : Boolean;
      FPCManagement@1108200005 : Codeunit 50003;
      SalesCommentLine@1108200006 : Record 44;
      LRec_GLEntry@1108200007 : Record 17;
      LRec_GLAcc@1108200008 : Record 15;
      FPCGeneralSetup@1000000005 : Record 50055;
      L_GLEntry@1000000006 : Record 17;
      Buchenmerker@1000000007 : Boolean;
      InterfaceProcessMgt@1000000001 : Codeunit 50087;
      SalesLineL@1000000008 : Record 37;
      FPCManagementL@1000000009 : Codeunit 50003;
      WhseLFSalesInterfaceMgtL@1000000010 : Codeunit 50303;
    BEGIN
      SalesHeader := SalesHeader2;
      GLSetup.GET;
      WITH SalesHeader DO BEGIN
        TESTFIELD("Document Type","Document Type"::Order);
        TESTFIELD("Sell-to Customer No.");
        TESTFIELD("Bill-to Customer No.");
        TESTFIELD("Posting Date");
        TESTFIELD("Document Date");
        IF GenJnlCheckLine.DateNotAllowed("Posting Date") THEN
          FIELDERROR("Posting Date",Text000);

        IF NOT CheckOpenPrepaymentLines(SalesHeader,DocumentType) THEN
          ERROR(Text001);

        CopyAndCheckDocDimToTempDocDim(TempDocDim,SalesHeader);

        Cust.GET("Sell-to Customer No.");
        Cust.CheckBlockedCustOnDocs(Cust,PrepmtDocTypeToDocType("Document Type"),FALSE,TRUE);
        IF "Bill-to Customer No." <> "Sell-to Customer No." THEN BEGIN
          Cust.GET("Bill-to Customer No.");
          Cust.CheckBlockedCustOnDocs(Cust,PrepmtDocTypeToDocType("Document Type"),FALSE,TRUE);
        END;

        // Get Doc. No. and save
        CASE DocumentType OF
          DocumentType::Invoice:
            BEGIN
              TESTFIELD("Prepayment Due Date");
              TESTFIELD("Prepmt. Cr. Memo No.",'');
              IF "Prepayment No." = '' THEN BEGIN
                TESTFIELD("Prepayment No. Series");
                "Prepayment No." :=
                  NoSeriesMgt.GetNextNo("Prepayment No. Series","Posting Date",TRUE);
                MODIFY;
                COMMIT;
              END;
              GenJnlLineDocNo := "Prepayment No.";
            END;
          DocumentType::"Credit Memo":
            BEGIN
              TESTFIELD("Prepayment No.",'');
              IF "Prepmt. Cr. Memo No." = '' THEN BEGIN
                TESTFIELD("Prepmt. Cr. Memo No. Series");
                "Prepmt. Cr. Memo No." :=
                  NoSeriesMgt.GetNextNo("Prepmt. Cr. Memo No. Series","Posting Date",TRUE);
                MODIFY;
                COMMIT;
              END;
              GenJnlLineDocNo := "Prepmt. Cr. Memo No.";
            END;
        END;

        // 1.00 B >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
        IF GUIALLOWED THEN BEGIN
        // 1.00 E <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

        Window.OPEN(
          '#1#################################\\' +
          Text002 +
          Text004 +
          Text005 +
          Text006);
        Window.UPDATE(1,STRSUBSTNO('%1 %2',SELECTSTR(1 + DocumentType,Text019),"No."));

        // 1.00 B >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
        END;
        // 1.00 E <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

        SalesSetup.GET;
        SourceCodeSetup.GET;
        SrcCode := SourceCodeSetup.Sales;
        IF "Prepmt. Posting Description" <> '' THEN
          PostingDescription := "Prepmt. Posting Description"
        ELSE
          PostingDescription :=
            COPYSTR(
              STRSUBSTNO(Text012,SELECTSTR(1 + DocumentType,Text019),"Document Type","No."),
              1,MAXSTRLEN("Posting Description"));

        // Create posted header
        IF SalesSetup."Ext. Doc. No. Mandatory" THEN
          TESTFIELD("External Document No.");
        CASE DocumentType OF
          DocumentType::Invoice:
            BEGIN
              SalesInvHeader.INIT;
              SalesInvHeader.TRANSFERFIELDS(SalesHeader);
              SalesInvHeader."Posting Description" := PostingDescription;
              SalesInvHeader."Payment Terms Code" := "Prepmt. Payment Terms Code";

              // 3.00 B >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
              SalesInvHeader."Payment Method Code" := "Payment Method Code";
              // 3.00 E <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

              //A/GOB-ko/P0185/140812
              IF SalesInvHeader."External Document No." = '' THEN
                 SalesInvHeader."External Document No." := SalesHeader."No.";
              //E/GOB-ko/P0185/140812

              SalesInvHeader."Due Date" := "Prepayment Due Date";
              SalesInvHeader."Pmt. Discount Date" := "Prepmt. Pmt. Discount Date";
              SalesInvHeader."Payment Discount %" := "Prepmt. Payment Discount %";
              SalesInvHeader."Date Sent" := 0D;
              SalesInvHeader."Time Sent" := 0T;
              SalesInvHeader."No." := GenJnlLineDocNo;
              SalesInvHeader."Pre-Assigned No. Series" := '';
              SalesInvHeader."Source Code" := SrcCode;
              SalesInvHeader."User ID" := USERID;
              SalesInvHeader."No. Printed" := 0;
              SalesInvHeader."Prepayment Invoice" := TRUE;
              SalesInvHeader."Prepayment Order No." := "No.";
              SalesInvHeader.INSERT;
              GenJnlLineDocType := GenJnlLine."Document Type"::Invoice;
              PostedDocTabNo := DATABASE::"Sales Invoice Header";

              // 1.00 B >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
              IF GUIALLOWED THEN
              // 1.00 E <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

              Window.UPDATE(1,STRSUBSTNO(Text003,"Document Type","No.",SalesInvHeader."No."));
            END;
          DocumentType::"Credit Memo":
            BEGIN
              SalesCrMemoHeader.INIT;
              SalesCrMemoHeader.TRANSFERFIELDS(SalesHeader);
              SalesCrMemoHeader."Payment Terms Code" := "Prepmt. Payment Terms Code";

              // 3.00 B >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
              SalesCrMemoHeader."Payment Method Code" := "Payment Method Code";
              // 3.00 E <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

              //A/GOB-ko/P0185/140812
              IF SalesCrMemoHeader."External Document No." = '' THEN
                 SalesCrMemoHeader."External Document No." := SalesHeader."No.";
              //E/GOB-ko/P0185/140812

              SalesCrMemoHeader."Pmt. Discount Date" := "Prepmt. Pmt. Discount Date";
              SalesCrMemoHeader."Payment Discount %" := "Prepmt. Payment Discount %";
              IF "Prepmt. Payment Terms Code" <> '' THEN BEGIN
                PaymentTerms.GET("Prepmt. Payment Terms Code");
                IF NOT PaymentTerms."Calc. Pmt. Disc. on Cr. Memos" THEN BEGIN
                  SalesCrMemoHeader."Payment Discount %" := 0;
                  SalesCrMemoHeader."Pmt. Discount Date" := 0D;
                END;
              END;
              SalesCrMemoHeader."Posting Description" := PostingDescription;
              SalesCrMemoHeader."Due Date" := "Prepayment Due Date";
              SalesCrMemoHeader."Date Sent" := 0D;
              SalesCrMemoHeader."Time Sent" := 0T;
              SalesCrMemoHeader."No." := GenJnlLineDocNo;
              SalesCrMemoHeader."Pre-Assigned No. Series" := '';
              SalesCrMemoHeader."Source Code" := SrcCode;
              SalesCrMemoHeader."User ID" := USERID;
              SalesCrMemoHeader."No. Printed" := 0;
              SalesCrMemoHeader."Prepayment Credit Memo" := TRUE;
              SalesCrMemoHeader."Prepayment Order No." := "No.";
              SalesCrMemoHeader.Correction := GLSetup."Mark Cr. Memos as Corrections";
              //A/gob-jvi/
              {***
              IF CheckOpenPrepaymentInv(SalesHeader."Sell-to Customer No.",SalesHeader."Last Prepayment No.")
                THEN BEGIN
                  SalesCrMemoHeader."Applies-to Doc. Type" := SalesCrMemoHeader."Applies-to Doc. Type"::Invoice;
                  SalesCrMemoHeader."Applies-to Doc. No." := SalesHeader."Last Prepayment No.";
                  END;
              ***}
              //E/gob-jvi
              SalesCrMemoHeader.INSERT;
              GenJnlLineDocType := GenJnlLine."Document Type"::"Credit Memo";
              PostedDocTabNo := DATABASE::"Sales Cr.Memo Header";

              // 1.00 B >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
              IF GUIALLOWED THEN
              // 1.00 E <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

              Window.UPDATE(1,STRSUBSTNO(Text011,"Document Type","No.",SalesCrMemoHeader."No."));
            END;
        END;
        DimMgt.MoveOneDocDimToPostedDocDim(
          TempDocDim,DATABASE::"Sales Header","Document Type","No.",0,PostedDocTabNo,GenJnlLineDocNo);
        IF SalesSetup."Copy Comments Order to Invoice" THEN
          CopyCommentLines("No.",PostedDocTabNo,GenJnlLineDocNo);
        GenJnlLineExtDocNo := "External Document No.";
        //A/GOB-ko/P0185/140812
        IF GenJnlLineExtDocNo = '' THEN
           GenJnlLineExtDocNo := SalesHeader."No.";
        //E/GOB-ko/P0185/140812

        // Reverse old lines
        IF (DocumentType = DocumentType::Invoice) THEN BEGIN
          GetSalesLinesToDeduct(SalesHeader,TempSalesLines);
          IF NOT TempSalesLines.ISEMPTY THEN
            CalcVATAmountLines(SalesHeader,TempSalesLines,TempVATAmountLineDeduct,DocumentType::"Credit Memo");
        END;

        // Create Lines
        PrepmtInvBuffer.DELETEALL;
        CalcVATAmountLines(SalesHeader,SalesLine,TempVATAmountLine,DocumentType);
        IF TempVATAmountLine.FINDSET THEN
          REPEAT
            TempVATAmountLineDeduct := TempVATAmountLine;
            IF TempVATAmountLineDeduct.FIND THEN BEGIN
              TempVATAmountLine."VAT Base" := TempVATAmountLine."VAT Base" - TempVATAmountLineDeduct."VAT Base";
              TempVATAmountLine."VAT Amount" := TempVATAmountLine."VAT Amount" - TempVATAmountLineDeduct."VAT Amount";
              TempVATAmountLine."Amount Including VAT" := TempVATAmountLine."Amount Including VAT" -
                TempVATAmountLineDeduct."Amount Including VAT";
              TempVATAmountLine."Line Amount" := TempVATAmountLine."Line Amount" - TempVATAmountLineDeduct."Line Amount";
              TempVATAmountLine."Inv. Disc. Base Amount" := TempVATAmountLine."Inv. Disc. Base Amount" -
                TempVATAmountLineDeduct."Inv. Disc. Base Amount";
              TempVATAmountLine."Invoice Discount Amount" := TempVATAmountLine."Invoice Discount Amount" -
                TempVATAmountLineDeduct."Invoice Discount Amount";
              TempVATAmountLine."Calculated VAT Amount" := TempVATAmountLine."Calculated VAT Amount" -
                TempVATAmountLineDeduct."Calculated VAT Amount";
              TempVATAmountLine."VAT Difference" := TempVATAmountLine."VAT Difference" -
                TempVATAmountLineDeduct."VAT Difference";
              TempVATAmountLine.MODIFY;
            END;
          UNTIL TempVATAmountLine.NEXT = 0;

        UpdateVATOnLines(SalesHeader,SalesLine,TempVATAmountLine,DocumentType);
        BuildInvLineBuffer(
          SalesHeader,SalesLine,DocumentType,PrepmtInvBuffer,TempDocDim,SalesSetup."Invoice Rounding",TRUE);
        PrepmtInvBuffer.FIND('-');
        TempDimBuf.INIT;
        REPEAT
          LineCount := LineCount + 1;

          // 1.00 B >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
          IF GUIALLOWED THEN
          // 1.00 E <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

          Window.UPDATE(2,LineCount);
          IF PrepmtInvBuffer."Line No." <> 0 THEN
            LineNo := PrevLineNo + PrepmtInvBuffer."Line No."
          ELSE
            LineNo := PrevLineNo + 10000;
          CASE DocumentType OF
            DocumentType::Invoice:
              BEGIN
                SalesInvLine.INIT;
                SalesInvLine."Document No." := SalesInvHeader."No.";
                SalesInvLine."Line No." := LineNo;
                SalesInvLine."Sell-to Customer No." := SalesInvHeader."Sell-to Customer No.";
                SalesInvLine.Type := SalesInvLine.Type::"G/L Account";
                SalesInvLine."No." := PrepmtInvBuffer."G/L Account No.";
                SalesInvLine."Shortcut Dimension 1 Code" := PrepmtInvBuffer."Global Dimension 1 Code";
                SalesInvLine."Shortcut Dimension 2 Code" := PrepmtInvBuffer."Global Dimension 2 Code";
                SalesInvLine.Description := PrepmtInvBuffer.Description;
                SalesInvLine.Quantity := 1;
                IF "Prices Including VAT" THEN BEGIN
                  SalesInvLine."Unit Price" := PrepmtInvBuffer."Amount Incl. VAT";
                  SalesInvLine."Line Amount" := PrepmtInvBuffer."Amount Incl. VAT";
                END ELSE BEGIN
                  SalesInvLine."Unit Price" := PrepmtInvBuffer.Amount;
                  SalesInvLine."Line Amount" := PrepmtInvBuffer.Amount;
                END;
                SalesInvLine."Gen. Bus. Posting Group" := PrepmtInvBuffer."Gen. Bus. Posting Group";
                SalesInvLine."Gen. Prod. Posting Group" := PrepmtInvBuffer."Gen. Prod. Posting Group";
                SalesInvLine."VAT Bus. Posting Group" := PrepmtInvBuffer."VAT Bus. Posting Group";
                SalesInvLine."VAT Prod. Posting Group" := PrepmtInvBuffer."VAT Prod. Posting Group";
                SalesInvLine."VAT %" := PrepmtInvBuffer."VAT %";
                SalesInvLine.Amount := PrepmtInvBuffer.Amount;
                SalesInvLine."VAT Difference" := PrepmtInvBuffer."VAT Difference";
                SalesInvLine."Amount Including VAT" := PrepmtInvBuffer."Amount Incl. VAT";
                SalesInvLine."VAT Calculation Type" := PrepmtInvBuffer."VAT Calculation Type";
                SalesInvLine."VAT Base Amount" := PrepmtInvBuffer."VAT Base Amount";
                SalesInvLine."VAT Identifier" := PrepmtInvBuffer."VAT Identifier";
                SalesInvLine.INSERT;
                PostedDocTabNo := DATABASE::"Sales Invoice Line";
              END;
            DocumentType::"Credit Memo":
              BEGIN
                SalesCrMemoLine.INIT;
                SalesCrMemoLine."Document No." := SalesCrMemoHeader."No.";
                SalesCrMemoLine."Line No." := LineNo;
                SalesCrMemoLine."Sell-to Customer No." := SalesCrMemoHeader."Sell-to Customer No.";
                SalesCrMemoLine.Type := SalesInvLine.Type::"G/L Account";
                SalesCrMemoLine."No." := PrepmtInvBuffer."G/L Account No.";
                SalesCrMemoLine."Shortcut Dimension 1 Code" := PrepmtInvBuffer."Global Dimension 1 Code";
                SalesCrMemoLine."Shortcut Dimension 2 Code" := PrepmtInvBuffer."Global Dimension 2 Code";
                SalesCrMemoLine.Description := PrepmtInvBuffer.Description;
                SalesCrMemoLine.Quantity := 1;
                IF "Prices Including VAT" THEN BEGIN
                  SalesCrMemoLine."Unit Price" := PrepmtInvBuffer."Amount Incl. VAT";
                  SalesCrMemoLine."Line Amount" := PrepmtInvBuffer."Amount Incl. VAT";
                END ELSE BEGIN
                  SalesCrMemoLine."Unit Price" := PrepmtInvBuffer.Amount;
                  SalesCrMemoLine."Line Amount" := PrepmtInvBuffer.Amount;
                END;
                SalesCrMemoLine."Gen. Bus. Posting Group" := PrepmtInvBuffer."Gen. Bus. Posting Group";
                SalesCrMemoLine."Gen. Prod. Posting Group" := PrepmtInvBuffer."Gen. Prod. Posting Group";
                SalesCrMemoLine."VAT Bus. Posting Group" := PrepmtInvBuffer."VAT Bus. Posting Group";
                SalesCrMemoLine."VAT Prod. Posting Group" := PrepmtInvBuffer."VAT Prod. Posting Group";
                SalesCrMemoLine."VAT %" := PrepmtInvBuffer."VAT %";
                SalesCrMemoLine.Amount := PrepmtInvBuffer.Amount;
                SalesCrMemoLine."VAT Difference" := PrepmtInvBuffer."VAT Difference";
                SalesCrMemoLine."Amount Including VAT" := PrepmtInvBuffer."Amount Incl. VAT";
                SalesCrMemoLine."VAT Calculation Type" := PrepmtInvBuffer."VAT Calculation Type";
                SalesCrMemoLine."VAT Base Amount" := PrepmtInvBuffer."VAT Base Amount";
                SalesCrMemoLine."VAT Identifier" := PrepmtInvBuffer."VAT Identifier";
                SalesCrMemoLine.INSERT;
                PostedDocTabNo := DATABASE::"Sales Cr.Memo Line";
              END;
          END;
          TempDimBuf.RESET;
          TempDimBuf.DELETEALL;
          DimBufMgt.GetDimensions(PrepmtInvBuffer."Dimension Entry No.",TempDimBuf);
          DimMgt.MoveDimBufToPostedDocDim(TempDimBuf,PostedDocTabNo,GenJnlLineDocNo,LineNo);
          PrevLineNo := LineNo;
          InsertExtendedText(
            PostedDocTabNo,GenJnlLineDocNo,PrepmtInvBuffer."G/L Account No.","Document Date","Language Code",PrevLineNo);
        UNTIL PrepmtInvBuffer.NEXT = 0;

        // G/L Posting
        LineCount := 0;
        CompressInvLineBuffer(SalesHeader,PrepmtInvBuffer);
        PrepmtInvBuffer.FIND('+');
        REPEAT
          LineCount := LineCount + 1;

          // 1.00 B >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
          IF GUIALLOWED THEN
          // 1.00 E <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

          Window.UPDATE(3,LineCount);

          IF DocumentType = DocumentType::Invoice THEN
            ReverseAmounts(PrepmtInvBuffer);
          RoundAmounts(SalesHeader,PrepmtInvBuffer,TotalPrepmtInvLineBuffer,TotalPrepmtInvLineBufferLCY);

          GenJnlLine.INIT;
          GenJnlLine."Posting Date" := "Posting Date";
          GenJnlLine."Document Date" := "Document Date";
          GenJnlLine.Description := PostingDescription;
          GenJnlLine."Reason Code" := "Reason Code";
          GenJnlLine."Document Type" := GenJnlLineDocType;
          GenJnlLine."Document No." := GenJnlLineDocNo;
          GenJnlLine."External Document No." := GenJnlLineExtDocNo;
          GenJnlLine."Account No." := PrepmtInvBuffer."G/L Account No.";
          GenJnlLine."System-Created Entry" := TRUE;
          GenJnlLine.Amount := PrepmtInvBuffer.Amount;
          GenJnlLine."Source Currency Code" := "Currency Code";
          GenJnlLine."Source Currency Amount" := PrepmtInvBuffer."Amount (ACY)";
          GenJnlLine.Correction :=
            (DocumentType = DocumentType::"Credit Memo") AND GLSetup."Mark Cr. Memos as Corrections";
          GenJnlLine."Gen. Posting Type" := GenJnlLine."Gen. Posting Type"::Sale;
          GenJnlLine."Gen. Bus. Posting Group" := PrepmtInvBuffer."Gen. Bus. Posting Group";
          GenJnlLine."Gen. Prod. Posting Group" := PrepmtInvBuffer."Gen. Prod. Posting Group";
          GenJnlLine."VAT Bus. Posting Group" := PrepmtInvBuffer."VAT Bus. Posting Group";
          GenJnlLine."VAT Prod. Posting Group" := PrepmtInvBuffer."VAT Prod. Posting Group";
          GenJnlLine."Tax Area Code" := PrepmtInvBuffer."Tax Area Code";
          GenJnlLine."Tax Liable" := PrepmtInvBuffer."Tax Liable";
          GenJnlLine."Tax Group Code" := PrepmtInvBuffer."Tax Group Code";
          GenJnlLine."VAT Calculation Type" := PrepmtInvBuffer."VAT Calculation Type";
          GenJnlLine."VAT Base Amount" := PrepmtInvBuffer."VAT Base Amount";
          GenJnlLine."VAT Base Discount %" := "VAT Base Discount %";
          GenJnlLine."Source Curr. VAT Base Amount" := PrepmtInvBuffer."VAT Base Amount (ACY)";
          GenJnlLine."VAT Amount" := PrepmtInvBuffer."VAT Amount";
          GenJnlLine."Source Curr. VAT Amount" := PrepmtInvBuffer."VAT Amount (ACY)";
          GenJnlLine."VAT Difference" := PrepmtInvBuffer."VAT Difference";
          GenJnlLine."VAT Posting" := GenJnlLine."VAT Posting"::"Manual VAT Entry";
          GenJnlLine."Shortcut Dimension 1 Code" := PrepmtInvBuffer."Global Dimension 1 Code";
          GenJnlLine."Shortcut Dimension 2 Code" := PrepmtInvBuffer."Global Dimension 2 Code";
          GenJnlLine."Job No." := PrepmtInvBuffer."Job No.";
          GenJnlLine."Source Code" := SrcCode;
          GenJnlLine."EU 3-Party Trade" := "EU 3-Party Trade";
          GenJnlLine."Bill-to/Pay-to No." := "Bill-to Customer No.";
          GenJnlLine."Country/Region Code" := "VAT Country/Region Code";
          GenJnlLine."VAT Registration No." := "VAT Registration No.";
          GenJnlLine."Source Type" := GenJnlLine."Source Type"::Customer;
          GenJnlLine."Source No." := "Bill-to Customer No.";
          GenJnlLine."Posting No. Series" := "Posting No. Series";
          GenJnlLine."IC Partner Code" := "Sell-to IC Partner Code";
          GenJnlLine.Prepayment := TRUE;
          //A/P0053/gob-ko/03.07.2012/Ausgleich Sachkonto MP2
          LRec_GLAcc.GET(GenJnlLine."Account No.");
          IF LRec_GLAcc."Build Open Entries" = TRUE THEN BEGIN
            LRec_GLEntry.RESET;
            LRec_GLEntry.SETCURRENTKEY("G/L Account No.",Open,"Posting Date");
            LRec_GLEntry.SETRANGE("G/L Account No.",GenJnlLine."Account No.");
            LRec_GLEntry.SETRANGE("External Document No.",GenJnlLine."External Document No.");
            LRec_GLEntry.SETRANGE(Open,TRUE);
              IF LRec_GLEntry.FINDFIRST THEN BEGIN
                 IF LRec_GLEntry.Amount = -GenJnlLine.Amount THEN BEGIN
                    GenJnlLine."Applies-to Doc. Type" := LRec_GLEntry."Document Type";
                    GenJnlLine."Applies-to Doc. No." := LRec_GLEntry."Document No.";
                    GenJnlLine."Applied Account Type" := GenJnlLine."Applied Account Type"::"G/L Account";
                    GenJnlLine."Applied Account No." := GenJnlLine."Account No.";
                 END;
              END;
          END;
          //E/P0053/gob-ko/03.07.2012/Ausgleich Sachkonto MP2
          RunGenJnlPostLine(GenJnlLine,PrepmtInvBuffer."Dimension Entry No.");
        UNTIL PrepmtInvBuffer.NEXT(-1) = 0;

        // Post customer entry

        // 1.00 B >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
        IF GUIALLOWED THEN
        // 1.00 E <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

        Window.UPDATE(4,1);
        GenJnlLine.INIT;
        GenJnlLine."Posting Date" := "Posting Date";
        GenJnlLine."Document Date" := "Document Date";
        GenJnlLine.Description := PostingDescription;
        GenJnlLine."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
        GenJnlLine."Shortcut Dimension 2 Code" := "Shortcut Dimension 2 Code";
        GenJnlLine."Reason Code" := "Reason Code";
        GenJnlLine."Account Type" := GenJnlLine."Account Type"::Customer;
        GenJnlLine."Account No." := "Bill-to Customer No.";
        GenJnlLine."Document Type" := GenJnlLineDocType;
        GenJnlLine."Document No." := GenJnlLineDocNo;
        GenJnlLine."External Document No." := GenJnlLineExtDocNo;
        GenJnlLine."Currency Code" := "Currency Code";
        GenJnlLine.Amount := -TotalPrepmtInvLineBuffer."Amount Incl. VAT";
        GenJnlLine."Source Currency Code" := "Currency Code";
        GenJnlLine."Source Currency Amount" := -TotalPrepmtInvLineBuffer."Amount Incl. VAT";
        GenJnlLine."Amount (LCY)" := -TotalPrepmtInvLineBufferLCY."Amount Incl. VAT";
        IF SalesHeader."Currency Code" = '' THEN
          GenJnlLine."Currency Factor" := 1
        ELSE
          GenJnlLine."Currency Factor" :=  SalesHeader."Currency Factor";
        GenJnlLine.Correction :=
          (DocumentType = DocumentType::"Credit Memo") AND GLSetup."Mark Cr. Memos as Corrections";
        GenJnlLine."Sales/Purch. (LCY)" := -TotalPrepmtInvLineBufferLCY.Amount;
        GenJnlLine."Profit (LCY)" := -TotalPrepmtInvLineBufferLCY.Amount;
        GenJnlLine."Sell-to/Buy-from No." := "Sell-to Customer No.";
        GenJnlLine."Bill-to/Pay-to No." := "Bill-to Customer No.";
        GenJnlLine."Salespers./Purch. Code" := "Salesperson Code";
        GenJnlLine."System-Created Entry" := TRUE;
        GenJnlLine."Due Date" := "Prepayment Due Date";
        GenJnlLine."Payment Terms Code" := "Prepmt. Payment Terms Code";
        IF (DocumentType = DocumentType::Invoice) OR
           PaymentTerms."Calc. Pmt. Disc. on Cr. Memos"
        THEN BEGIN
          GenJnlLine."Pmt. Discount Date" := "Prepmt. Pmt. Discount Date";
          GenJnlLine."Payment Discount %" := "Prepmt. Payment Discount %";
        END;

        //A/gob-czi/P0143
        // 3.00 B >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
        //GenJnlLine."Payment Method Code 2" := "Payment Method Code";
        // 3.00 E <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
        //E/gob-czi/P0143

        GenJnlLine."Source Type" := GenJnlLine."Source Type"::Customer;
        GenJnlLine."Source No." := "Bill-to Customer No.";
        GenJnlLine."Source Code" := SrcCode;
        GenJnlLine."Posting No. Series" := "Posting No. Series";
        GenJnlLine."IC Partner Code" := "Sell-to IC Partner Code";
        GenJnlLine.Prepayment := TRUE;
        // gbedv PMT -------------------------------------------------- BEGIN
        GenJnlLine."Payment Method Code" := SalesHeader."Payment Method Code";
        // gbedv PMT -------------------------------------------------- END

        //A/gob-jvi/
        {***
        IF CheckOpenPrepaymentInv(SalesHeader."Sell-to Customer No.",SalesHeader."Last Prepayment No.")
          THEN BEGIN
            GenJnlLine."Applies-to Doc. Type" := SalesCrMemoHeader."Applies-to Doc. Type"::Invoice;
            GenJnlLine."Applies-to Doc. No." := SalesHeader."Last Prepayment No.";
            END;
        ***}
        //E/gob-jvi

        TempJnlLineDim.INIT;
        TempDocDim.RESET;
        TempDocDim.SETRANGE("Table ID",DATABASE::"Sales Header");
        DimMgt.CopyDocDimToJnlLineDim(TempDocDim,TempJnlLineDim);
        GenJnlPostLine.RunWithCheck(GenJnlLine,TempJnlLineDim);

        // Balancing account
        IF "Bal. Account No." <> '' THEN BEGIN

          // 1.00 B >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
          IF GUIALLOWED THEN
          // 1.00 E <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

          Window.UPDATE(5,1);
          CustLedgEntry.FINDLAST;
          GenJnlLine.INIT;
          GenJnlLine."Posting Date" := "Posting Date";
          GenJnlLine."Document Date" := "Document Date";
          GenJnlLine.Description := PostingDescription;
          GenJnlLine."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
          GenJnlLine."Shortcut Dimension 2 Code" := "Shortcut Dimension 2 Code";
          GenJnlLine."Reason Code" := "Reason Code";
          GenJnlLine."Account Type" := GenJnlLine."Account Type"::Customer;
          GenJnlLine."Account No." := "Bill-to Customer No.";
          IF GenJnlLineDocType = GenJnlLine."Document Type"::"Credit Memo" THEN
            GenJnlLine."Document Type" := GenJnlLine."Document Type"::Refund
          ELSE
            GenJnlLine."Document Type" := GenJnlLine."Document Type"::Payment;
          GenJnlLine."Document No." := GenJnlLineDocNo;
          GenJnlLine."External Document No." := GenJnlLineExtDocNo;
          IF "Bal. Account Type" = "Bal. Account Type"::"Bank Account" THEN
            GenJnlLine."Bal. Account Type" := GenJnlLine."Bal. Account Type"::"Bank Account";
          GenJnlLine."Bal. Account No." := "Bal. Account No.";
          GenJnlLine."Currency Code" := "Currency Code";
          GenJnlLine.Amount :=
            TotalPrepmtInvLineBuffer."Amount Incl. VAT" + CustLedgEntry."Remaining Pmt. Disc. Possible";
          GenJnlLine."Source Currency Code" := "Currency Code";
          GenJnlLine."Source Currency Amount" := GenJnlLine.Amount;
          GenJnlLine.Correction :=
            (DocumentType = DocumentType::"Credit Memo") AND GLSetup."Mark Cr. Memos as Corrections";
          CustLedgEntry.CALCFIELDS(Amount);
          IF CustLedgEntry.Amount = 0 THEN
            GenJnlLine."Amount (LCY)" := TotalPrepmtInvLineBufferLCY.Amount
          ELSE
            GenJnlLine."Amount (LCY)" :=
              TotalPrepmtInvLineBufferLCY.Amount +
              ROUND(
                CustLedgEntry."Remaining Pmt. Disc. Possible" / CustLedgEntry."Adjusted Currency Factor");
          IF SalesHeader."Currency Code" = '' THEN
            GenJnlLine."Currency Factor" := 1
          ELSE
            GenJnlLine."Currency Factor" :=  SalesHeader."Currency Factor";
          GenJnlLine."Applies-to Doc. Type" := GenJnlLineDocType;
          GenJnlLine."Applies-to Doc. No." := GenJnlLineDocNo;
          GenJnlLine."Source Type" := GenJnlLine."Source Type"::Customer;
          GenJnlLine."Source No." := "Bill-to Customer No.";
          GenJnlLine."Source Code" := SrcCode;
          GenJnlLine."Posting No. Series" := "Posting No. Series";
          GenJnlLine."IC Partner Code" := "Sell-to IC Partner Code";
          GenJnlLine."System-Created Entry" := TRUE;
          //A/gob-jvi/
          {***
          IF CheckOpenPrepaymentInv(SalesHeader."Sell-to Customer No.",SalesHeader."Last Prepayment No.")
            THEN BEGIN
              GenJnlLine."Applies-to Doc. Type" := SalesCrMemoHeader."Applies-to Doc. Type"::Invoice;
              GenJnlLine."Applies-to Doc. No." := SalesHeader."Last Prepayment No.";
              END;
          ***}
          //E/gob-jvi/

          GenJnlPostLine.RunWithCheck(GenJnlLine,TempJnlLineDim);
        END;

        // 4.00 B >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
        IF (SalesHeader."Payment Method Code" = 'GROUPON') AND (DocumentType = DocumentType::Invoice) THEN BEGIN
          SalesLine.RESET;
          SalesLine.SETRANGE("Document Type","Document Type");
          SalesLine.SETRANGE("Document No.","No.");
          SalesLine.SETRANGE(Type,SalesLine.Type::Resource);
          SalesLine.SETRANGE("Resource Type",SalesLine."Resource Type"::Groupon,SalesLine."Resource Type"::"Daily Deal");
          IF SalesLine.FINDFIRST THEN BEGIN
            Res.GET(SalesLine."No.");
            GenPostingSetup.GET(SalesLine."Gen. Bus. Posting Group",SalesLine."Gen. Prod. Posting Group");
            GenPostingSetup.TESTFIELD("Sales Prepayments Account");
            LT_GLAcc.GET(GenPostingSetup."Sales Prepayments Account");
            GenPostingSetup.TESTFIELD("Sales Account");
            LT_GLAcc.GET(GenPostingSetup."Sales Account");
            GenJnlLine.INIT;
            GenJnlLine."Posting Date" := "Posting Date";
            GenJnlLine."Document Date" := "Document Date";
            GenJnlLine.Description := PostingDescription;
            GenJnlLine."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
            GenJnlLine."Shortcut Dimension 2 Code" := "Shortcut Dimension 2 Code";
            GenJnlLine."Reason Code" := "Reason Code";
            GenJnlLine."Document Type" := GenJnlLineDocType;
            GenJnlLine."Document No." := GenJnlLineDocNo;
            GenJnlLine."External Document No." := GenJnlLineExtDocNo;
            GenJnlLine.VALIDATE("Account No.",GenPostingSetup."Sales Account");
            GenJnlLine."System-Created Entry" := TRUE;
            GenJnlLine.VALIDATE(Amount,ROUND(ROUND(Res."Commission %"*TotalPrepmtInvLineBuffer."Amount Incl. VAT"/100,0.01)*
              (100 + GenJnlLine."VAT %")/100,0.01));
            GenJnlLine.Correction := (DocumentType = DocumentType::"Credit Memo") AND GLSetup."Mark Cr. Memos as Corrections";
            GenJnlLine.VALIDATE("Bal. Account No.",GenPostingSetup."Sales Prepayments Account");
            GenJnlLine.VALIDATE("Bal. Gen. Posting Type",GenJnlLine."Bal. Gen. Posting Type"::" ");
            GenJnlLine.VALIDATE("Bal. Gen. Bus. Posting Group",'');
            GenJnlLine.VALIDATE("Bal. Gen. Prod. Posting Group",'');
            RunGenJnlPostLine(GenJnlLine,PrepmtInvBuffer."Dimension Entry No.");
          END;
        END;
        // 4.00 E <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
        //A/gob-ko/14.05.2012
          SalesLine.RESET;
          SalesLine.SETRANGE("Document Type","Document Type");
          SalesLine.SETRANGE("Document No.","No.");
          SalesLine.SETRANGE(Type,SalesLine.Type::Resource);
          //SalesLine.SETRANGE("Resource Type",SalesLine."Resource Type"::Groupon,SalesLine."Resource Type"::"Daily Deal");
          //A/gob-adb/08.07.13
          //IF SalesLine.FINDFIRST THEN BEGIN
          IF SalesLine.FIND('-') THEN BEGIN
          //E/gob-adb/08.07.13
             REPEAT
            Res.GET(SalesLine."No.");
            //IF SalesLine."Gen. Prod. Posting Group" = Res."Gen. Prod. Posting Group" THEN BEGIN
               IF (Res.Type = Res.Type::Groupon) OR
                  ((Res.Type = Res.Type::"Sales Bon") AND
                   (SalesLine."Gen. Prod. Posting Group" = Res."Coupon Gen Prod. Posting Group")) THEN BEGIN
                    GenPostingSetup.GET(SalesLine."Gen. Bus. Posting Group",SalesLine."Gen. Prod. Posting Group");
                    GenPostingSetup.TESTFIELD("Receiv. Groupon/Gift account");
                    LT_GLAcc.GET(GenPostingSetup."Receiv. Groupon/Gift account");
                    GenPostingSetup.TESTFIELD("Sales Prepayments Account");
                    LT_GLAcc.GET(GenPostingSetup."Sales Prepayments Account");
                   //A/gob-ko/31102012/P0549
                   IF GenJnlLine."Document Type" = GenJnlLine."Document Type"::"Credit Memo" THEN BEGIN
                      IF SalesHeader."Last Prepayment No." <> '' THEN BEGIN
                      L_GLEntry.SETCURRENTKEY("Document No.","Document Type","G/L Account No.");
                      L_GLEntry.SETRANGE("Document Type",L_GLEntry."Document Type"::Invoice);
                      L_GLEntry.SETRANGE("Document No.", SalesHeader2."Last Prepayment No.");
                      L_GLEntry.SETRANGE("G/L Account No.",GenPostingSetup."Receiv. Groupon/Gift account");
                      IF L_GLEntry.FIND('-') THEN
                         Buchenmerker := TRUE
                      ELSE
                         Buchenmerker := FALSE;
                      END;
                   END;
                   IF Buchenmerker = TRUE THEN BEGIN
                    //E/gob-ko/31102012/P0549
                  GenJnlLine.INIT;
                  GenJnlLine."Posting Date" := "Posting Date";
                  GenJnlLine."Document Date" := "Document Date";
                  GenJnlLine.Description := PostingDescription;
                  GenJnlLine."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
                  GenJnlLine."Shortcut Dimension 2 Code" := "Shortcut Dimension 2 Code";
                  GenJnlLine."Reason Code" := "Reason Code";
                  GenJnlLine."Document Type" := GenJnlLineDocType;
                  GenJnlLine."Document No." := GenJnlLineDocNo;
                  GenJnlLine."External Document No." := GenJnlLineExtDocNo;
                  GenJnlLine.VALIDATE("Account No.",GenPostingSetup."Sales Prepayments Account");
                  GenJnlLine.VALIDATE("Gen. Bus. Posting Group",SalesLine."Gen. Bus. Posting Group");
                  GenJnlLine.VALIDATE("VAT Bus. Posting Group",SalesLine."VAT Bus. Posting Group");
                  GenJnlLine.VALIDATE("Gen. Prod. Posting Group",LT_GLAcc."Gen. Prod. Posting Group");
                  GenJnlLine.VALIDATE("VAT Prod. Posting Group",LT_GLAcc."VAT Prod. Posting Group");
                  GenJnlLine."System-Created Entry" := TRUE;
                  IF GenJnlLine."Document Type" = GenJnlLine."Document Type"::"Credit Memo" THEN
                     GenJnlLine.VALIDATE(Amount,-SalesLine."Prepmt. Amt. Incl. VAT")
                  ELSE
                     GenJnlLine.VALIDATE(Amount,SalesLine."Prepmt. Amt. Incl. VAT");
                  GenJnlLine."Groupon/Gift certificate No." := Res."Original Code";
                  GenJnlLine.Correction := (DocumentType = DocumentType::"Credit Memo") AND GLSetup."Mark Cr. Memos as Corrections";
                  GenJnlLine.VALIDATE("Bal. Account No.",GenPostingSetup."Receiv. Groupon/Gift account");
                  GenJnlLine.VALIDATE("Bal. Gen. Posting Type",GenJnlLine."Bal. Gen. Posting Type"::" ");
                  GenJnlLine.VALIDATE("Bal. Gen. Bus. Posting Group",'');
                  GenJnlLine.VALIDATE("Bal. Gen. Prod. Posting Group",'');
                  //A/gob-ko/P0052/Ausgleich fÅr Geschenkgutschein
                  IF Res.Type = Res.Type::"Sales Bon" THEN BEGIN
                      LRec_GLEntry.RESET;
                      LRec_GLEntry.SETCURRENTKEY("G/L Account No.","Groupon/Gift certificate No.",LRec_GLEntry.Open);
                      LRec_GLEntry.SETRANGE("G/L Account No.",GenPostingSetup."Receiv. Groupon/Gift account");
                      LRec_GLEntry.SETRANGE("Groupon/Gift certificate No.",Res."Original Code");
                      LRec_GLEntry.SETRANGE(Open,TRUE);
                      IF LRec_GLEntry.FINDFIRST THEN BEGIN
                         IF LRec_GLEntry.Amount <= GenJnlLine.Amount THEN BEGIN
                            GenJnlLine."Applies-to Doc. Type" := LRec_GLEntry."Document Type";
                            GenJnlLine."Applies-to Doc. No." := LRec_GLEntry."Document No.";
                            GenJnlLine."Applied Account Type" := GenJnlLine."Applied Account Type"::"G/L Account";
                            GenJnlLine."Applied Account No." := GenPostingSetup."Receiv. Groupon/Gift account";
                         END;
                      END;
                  END;
                  //E/gob-ko/P0052/Ausgleich fÅr Geschenkgutschein
                  RunGenJnlPostLine(GenJnlLine,PrepmtInvBuffer."Dimension Entry No.");
                    //A/gob-ko/31102012/P0549
                    END;
                    //E/gob-ko/31102012/P0549
                    //A/gob-ko/P0226/230812
                    IF GenJnlLine."Document Type" = GenJnlLine."Document Type"::Invoice  THEN
                      CalculateVAT(SalesHeader,SalesLine,0)
                    ELSE
                      CalculateVAT(SalesHeader,SalesLine,1);
                    TempVATAmount.SETFILTER(TempVATAmount."VAT %",'<>0');
                    IF TempVATAmount.FIND('-') THEN BEGIN
                       REPEAT
                    //E/gob-ko/P0226/230812
                  //A/gob-ko
                  IF GLSetup.GET THEN
                     GLSetup.TESTFIELD("Vat Posting Group Gift Bon");
                  //12.07.2012 IF Res.Type = Res.Type::"Sales Bon" THEN BEGIN
                      IF (Res.Type = Res.Type::"Sales Bon") OR (Res.Type = Res.Type::Groupon) THEN BEGIN
                      GenPostingSetup.GET(SalesLine."Gen. Bus. Posting Group",SalesLine."Gen. Prod. Posting Group");
                      GenPostingSetup.TESTFIELD("Receiv. Groupon/Gift account");
                      LT_GLAcc.GET(GenPostingSetup."Receiv. Groupon/Gift account");
                      GenPostingSetup.TESTFIELD("Sales Prepayments Account");
                      LT_GLAcc.GET(GenPostingSetup."Sales Prepayments Account");
                      GenJnlLine.INIT;
                      GenJnlLine."Posting Date" := "Posting Date";
                      GenJnlLine."Document Date" := "Document Date";
                      GenJnlLine.Description := PostingDescription;
                      GenJnlLine."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
                      GenJnlLine."Shortcut Dimension 2 Code" := "Shortcut Dimension 2 Code";
                      GenJnlLine."Reason Code" := "Reason Code";
                      GenJnlLine."Document Type" := GenJnlLineDocType;
                      GenJnlLine."Document No." := GenJnlLineDocNo;
                      GenJnlLine."External Document No." := GenJnlLineExtDocNo;
                        //A/gob-ko/P0226/230812
                        VatPostingSetup.RESET;
                        VatPostingSetup.SETRANGE(VatPostingSetup."VAT Bus. Posting Group","VAT Bus. Posting Group");
                        VatPostingSetup.SETRANGE(VatPostingSetup."VAT %",TempVATAmount."VAT %");
                        VatPostingSetup.SETFILTER(VatPostingSetup."Unrealized VAT Type",'>0');

                        VatPostingSetup.FINDFIRST;

                        //E/gob-ko/P0226/230812
                      GenJnlLine.VALIDATE("Account No.",GenPostingSetup."Sales Prepayments Account");
                      GenJnlLine.VALIDATE("Gen. Bus. Posting Group",SalesLine."Gen. Bus. Posting Group");
                      GenJnlLine.VALIDATE("VAT Bus. Posting Group",SalesLine."VAT Bus. Posting Group");
                      GenJnlLine.VALIDATE("Gen. Prod. Posting Group",LT_GLAcc."Gen. Prod. Posting Group");
                      //GenJnlLine.VALIDATE("VAT Prod. Posting Group",LT_GLAcc."VAT Prod. Posting Group");
                        //A/gob-ko/P0226/230812
                        //GenJnlLine.VALIDATE("VAT Prod. Posting Group",GLSetup."Vat Posting Group Gift Bon");
                        GenJnlLine.VALIDATE("VAT Prod. Posting Group",VatPostingSetup."VAT Prod. Posting Group");
                        //E/gob-ko/P0226/230812
                      GenJnlLine.Prepayment := TRUE;
                      GenJnlLine."System-Created Entry" := TRUE;
                      IF GenJnlLine."Document Type" = GenJnlLine."Document Type"::"Credit Memo" THEN
                           //A/gob-ko/P0226/230812
                           //GenJnlLine.VALIDATE(Amount,SalesLine."Prepmt. Amt. Incl. VAT")
                           GenJnlLine.VALIDATE(Amount,
                              ROUND(SalesLine."Prepmt. Amt. Incl. VAT"*TempVATAmount."Amount Including VAT"/TotalAmountinclVat))
                           //E/gob-ko/P0226/230812
                      ELSE
                           //A/gob-ko/P0226/230812
                           //GenJnlLine.VALIDATE(Amount,-SalesLine."Prepmt. Amt. Incl. VAT");
                           GenJnlLine.VALIDATE(Amount,
                              ROUND(-SalesLine."Prepmt. Amt. Incl. VAT"*TempVATAmount."Amount Including VAT"/TotalAmountinclVat));
                           //E/gob-ko/P0226/230812
                      GenJnlLine."Groupon/Gift certificate No." := Res."Original Code";
                      GenJnlLine.Correction := (DocumentType = DocumentType::"Credit Memo") AND GLSetup."Mark Cr. Memos as Corrections";
                      {
                      GenJnlLine.VALIDATE("Bal. Account No.",GenPostingSetup."Sales Prepayments Account");
                      GenJnlLine.VALIDATE("Bal. Gen. Posting Type",GenJnlLine."Bal. Gen. Posting Type"::Sale);
                      GenJnlLine.VALIDATE("Gen. Bus. Posting Group",SalesLine."Gen. Bus. Posting Group");
                      GenJnlLine.VALIDATE("VAT Bus. Posting Group",SalesLine."VAT Bus. Posting Group");
                      GenJnlLine.VALIDATE("Gen. Prod. Posting Group",Res."Gen. Prod. Posting Group");
                      GenJnlLine.VALIDATE("VAT Prod. Posting Group",'19_VOLL');
                      }
                      RunGenJnlPostLine(GenJnlLine,PrepmtInvBuffer."Dimension Entry No.");

                      GenPostingSetup.GET(SalesLine."Gen. Bus. Posting Group",SalesLine."Gen. Prod. Posting Group");
                      GenPostingSetup.TESTFIELD("Receiv. Groupon/Gift account");
                      LT_GLAcc.GET(GenPostingSetup."Receiv. Groupon/Gift account");
                      GenPostingSetup.TESTFIELD("Sales Prepayments Account");
                      LT_GLAcc.GET(GenPostingSetup."Sales Prepayments Account");
                      GenJnlLine.INIT;
                      GenJnlLine."Posting Date" := "Posting Date";
                      GenJnlLine."Document Date" := "Document Date";
                      GenJnlLine.Description := PostingDescription;
                      GenJnlLine."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
                      GenJnlLine."Shortcut Dimension 2 Code" := "Shortcut Dimension 2 Code";
                      GenJnlLine."Reason Code" := "Reason Code";
                      GenJnlLine."Document Type" := GenJnlLineDocType;
                      GenJnlLine."Document No." := GenJnlLineDocNo;
                      GenJnlLine."External Document No." := GenJnlLineExtDocNo;
                      GenJnlLine.VALIDATE("Account No.",GenPostingSetup."Sales Prepayments Account");
                      GenJnlLine.VALIDATE("Gen. Bus. Posting Group",SalesLine."Gen. Bus. Posting Group");
                      GenJnlLine.VALIDATE("VAT Bus. Posting Group",SalesLine."VAT Bus. Posting Group");
                      GenJnlLine.VALIDATE("Gen. Prod. Posting Group",LT_GLAcc."Gen. Prod. Posting Group");
                        //A/gob-ko/P0226/230812
                        //GenJnlLine.VALIDATE("VAT Prod. Posting Group",GLSetup."Vat Posting Group Gift Bon");
                        GenJnlLine.VALIDATE("VAT Prod. Posting Group",VatPostingSetup."VAT Prod. Posting Group");
                        //E/gob-ko/P0226/230812

                      GenJnlLine."System-Created Entry" := TRUE;
                      IF GenJnlLine."Document Type" = GenJnlLine."Document Type"::"Credit Memo" THEN
                           //A/gob-ko/P0226/230812
                           //GenJnlLine.VALIDATE(Amount,-SalesLine."Prepmt. Amt. Incl. VAT")
                           GenJnlLine.VALIDATE(Amount,
                              ROUND(-SalesLine."Prepmt. Amt. Incl. VAT"*TempVATAmount."Amount Including VAT"/TotalAmountinclVat))
                           //E/gob-ko/P0226/230812

                        ELSE
                          //A/gob-ko/P0226/230812
                          //GenJnlLine.VALIDATE(Amount,SalesLine."Prepmt. Amt. Incl. VAT")
                          GenJnlLine.VALIDATE(Amount,
                             ROUND(SalesLine."Prepmt. Amt. Incl. VAT"*TempVATAmount."Amount Including VAT"/TotalAmountinclVat));
                          //E/gob-ko/P0226/230812
                      GenJnlLine."Groupon/Gift certificate No." := Res."Original Code";
                      GenJnlLine.Correction := (DocumentType = DocumentType::"Credit Memo") AND GLSetup."Mark Cr. Memos as Corrections";
                      {
                      GenJnlLine.VALIDATE("Bal. Account No.",GenPostingSetup."Sales Prepayments Account");
                      GenJnlLine.VALIDATE("Bal. Gen. Posting Type",GenJnlLine."Bal. Gen. Posting Type"::Sale);
                      GenJnlLine.VALIDATE("Gen. Bus. Posting Group",SalesLine."Gen. Bus. Posting Group");
                      GenJnlLine.VALIDATE("VAT Bus. Posting Group",SalesLine."VAT Bus. Posting Group");
                      GenJnlLine.VALIDATE("Gen. Prod. Posting Group",Res."Gen. Prod. Posting Group");
                      GenJnlLine.VALIDATE("VAT Prod. Posting Group",'ANZ');
                      }
                      RunGenJnlPostLine(GenJnlLine,PrepmtInvBuffer."Dimension Entry No.");
                  END;
                 //A/gob-Ko/230812/P0226
                 UNTIL TempVATAmount.NEXT = 0;
                 END;
                 //E/gob-Ko/230812/P0226

                  //E/gob-ko
               END;
             //END;
            UNTIL SalesLine.NEXT = 0;
          END;

        //E/gob-ko/14.05.2012
        // Update lines & header
        SalesLine.RESET;
        SalesLine.SETRANGE("Document Type","Document Type");
        SalesLine.SETRANGE("Document No.","No.");
        IF DocumentType = DocumentType::Invoice THEN BEGIN
          "Last Prepayment No." := GenJnlLineDocNo;
          "Prepayment No." := '';
          SalesLine.SETFILTER("Prepmt. Line Amount",'<>0');
          IF SalesLine.FIND('-') THEN
            REPEAT
              IF SalesLine."Prepmt. Line Amount" <> SalesLine."Prepmt. Amt. Inv." THEN BEGIN
                SalesLine."Prepmt. Amt. Inv." := SalesLine."Prepmt. Line Amount";
                SalesLine."Prepmt. Amount Inv. Incl. VAT" := SalesLine."Prepmt. Amt. Incl. VAT";

                // 2.00 B >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
                //original SalesLine.CalcPrepaymentToDeduct;
                SalesLine."Prepmt Amt to Deduct" := SalesLine."Prepmt. Amt. Inv." - SalesLine."Prepmt Amt Deducted";
                // 2.00 E <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

                SalesLine."Prepmt VAT Diff. to Deduct" :=
                  SalesLine."Prepmt VAT Diff. to Deduct" + SalesLine."Prepayment VAT Difference";
                SalesLine."Prepayment VAT Difference" := 0;
                SalesLine.MODIFY;
              END;
            UNTIL SalesLine.NEXT = 0;
        END ELSE BEGIN
          "Last Prepmt. Cr. Memo No." := GenJnlLineDocNo;
          "Prepmt. Cr. Memo No." := '';
          SalesLine.SETFILTER("Prepmt. Amt. Inv.",'<>0');
          IF SalesLine.FIND('-') THEN
            REPEAT
              SalesLine."Prepmt. Amt. Inv." := SalesLine."Prepmt Amt Deducted";
              SalesLine."Prepmt. Amount Inv. Incl. VAT" :=
                SalesLine."Prepmt. Amt. Inv." + SalesLine."Prepmt. Amt. Inv." * SalesLine."Prepayment VAT %"/100;
              SalesLine."Prepmt Amt to Deduct" := 0;
              SalesLine."Prepmt VAT Diff. to Deduct" := 0;
              IF SalesLine."Prepmt. Amount Inv. (LCY)" <> 0 THEN BEGIN
                WITH SalesHeader DO BEGIN
                  GenJnlLine.INIT;
                  GenJnlLine."Posting Date" := "Posting Date";
                  GenJnlLine."Document Date" := "Document Date";
                  GenJnlLine.Description := "Posting Description";
                  GenJnlLine."Reason Code" := "Reason Code";
                  GenJnlLine."Document Type" := GenJnlLineDocType;
                  GenJnlLine."Document No." := GenJnlLineDocNo;
                  GenJnlLine.Correction :=
                    (DocumentType = DocumentType::"Credit Memo") AND GLSetup."Mark Cr. Memos as Corrections";
                  GenJnlLine."External Document No." := GenJnlLineExtDocNo;
                  DocDim.SETRANGE("Table ID",DATABASE::"Sales Line");
                  DocDim.SETRANGE("Document Type","Document Type");
                  DocDim.SETRANGE("Document No.",SalesLine."Document No.");
                  DocDim.SETRANGE("Line No.",SalesLine."Line No.");
                  TempJnlLineDim.RESET;
                  TempJnlLineDim.DELETEALL;
                  DimMgt.CopyDocDimToJnlLineDim(DocDim,TempJnlLineDim);
                  GenJnlLine."Shortcut Dimension 1 Code" := SalesLine."Shortcut Dimension 1 Code";
                  GenJnlLine."Shortcut Dimension 2 Code" := SalesLine."Shortcut Dimension 2 Code";
                  GenJnlLine."Source Code" := SrcCode;
                  GenJnlLine."Source Type" := GenJnlLine."Source Type"::Customer;
                  GenJnlLine."Source No." := "Bill-to Customer No.";
                  GenJnlLine."Posting No. Series" := "Posting No. Series";
                  GenJnlLine."Source Currency Code" := "Currency Code";
                  RealizeGainLoss(GenJnlLine,SalesLine);
                  GenJnlPostLine.RunWithCheck(GenJnlLine,TempJnlLineDim);
                END;
                SalesLine."Prepmt. Amount Inv. (LCY)" := 0;
              END;
              SalesLine."Prepayment VAT Difference" := 0;
              SalesLine.MODIFY;
            UNTIL SalesLine.NEXT = 0;
        END;
        IF SalesHeader.Status <> SalesHeader.Status::"Pending Prepayment" THEN
          SalesHeader.Status := SalesHeader.Status::"Pending Prepayment";
        MODIFY;


        //S/P0022
        //A/P0313
        FPCGeneralSetup.GET;
        IF FPCGeneralSetup."Autom. Cancel Testorders" THEN BEGIN
        //E/P0313
      //S/P0042
        CancelOrder := FALSE;

        IF (FPCManagement.QtyStringUsedInString("Sell-to Customer Name",'TEST',TRUE) >= 2) OR
           (FPCManagement.QtyStringUsedInString("Sell-to Customer Name 2",'TEST',TRUE) >=2) OR
           (FPCManagement.QtyStringUsedInString("Bill-to Name",'TEST',TRUE) >= 2) OR
           (FPCManagement.QtyStringUsedInString("Bill-to Name 2",'TEST',TRUE) >= 2) OR
           (FPCManagement.QtyStringUsedInString("Ship-to Name",'TEST',TRUE) >= 2) OR
           (FPCManagement.QtyStringUsedInString("Ship-to Name 2",'TEST',TRUE) >= 2) THEN
          CancelOrder := TRUE;

          SalesCommentLine.RESET;
          SalesCommentLine.SETRANGE("Document Type",SalesCommentLine."Document Type"::Order);
          SalesCommentLine.SETRANGE("No.","No.");
          SalesCommentLine.SETRANGE("Document Line No.",0);
          //A/P0313
          SalesCommentLine.SETRANGE("Customer Comment Shop",TRUE);
          //E/P0313
          //A/P0318
          //IF (SalesCommentLine.FINDFIRST) AND (FPCManagement.QtyStringUsedInString(SalesCommentLine.Comment,'TEST',TRUE) >= 1) THEN
          IF (SalesCommentLine.FINDFIRST) AND (STRPOS(UPPERCASE(SalesCommentLine.Comment),'TEST') = 1) THEN
          //E/P0318
            CancelOrder := TRUE;

        IF CancelOrder THEN BEGIN
          SalesLineLoc.SETRANGE("Document No.","No.");
          SalesLineLoc.SETRANGE("Document Type","Document Type");
          IF SalesLineLoc.FIND('-') THEN
            REPEAT
              //A/gob-rste/05.10.12/P0414
              //SalesLineLoc."Cancellation Reason Code" := 'TEST';
              SalesLineLoc."Return Reason Code" := 'TEST';
              //E/gob-rste/05.10.12/P0414
              SalesLineLoc.MODIFY;
            UNTIL SalesLineLoc.NEXT = 0;
          MagentoCancel;
          EXIT;
        END;
        //A/P0313
        END;
        //E/P0313
        //E/P0042
        //IF (STRPOS(UPPERCASE(SalesHeader."Sell-to Customer Name"),'TEST TEST') <> 0) OR
           //(STRPOS(UPPERCASE(SalesHeader."Sell-to Customer Name"),'TESTVORNAME TESTNACHNAME') <> 0) THEN BEGIN
          //SalesLineLoc.SETRANGE("Document No.",SalesHeader."No.");
          //SalesLineLoc.SETRANGE("Document Type",SalesHeader."Document Type");
          //IF SalesLineLoc.FIND('-') THEN
            //REPEAT
              //SalesLineLoc."Cancellation Reason Code" := 'TEST';
              //SalesLineLoc.MODIFY;
            //UNTIL SalesLineLoc.NEXT = 0;
          //SalesHeader.MagentoCancel;
          //EXIT;
        //END;

        IF SalesLine."Prepmt. Amount Inv. (LCY)" <> 0 THEN BEGIN
          IF CheckPickingLinesPrepaym(SalesHeader) THEN
            SalesHeader.Kommissionierung := TRUE
          ELSE
            SalesHeader.Kommissionierung := FALSE;

          //S/P0041
          IF (SalesHeader.Kommissionierung) AND NOT(SalesHeader."Interruption Checked") THEN BEGIN
            FPCManagement.CheckForPickingInterruption(SalesHeader);
          END;
          IF (SalesHeader."Processing interrupted" <> SalesHeader."Processing interrupted"::No)
            AND NOT(SalesHeader."Interruption Checked") THEN
            SalesHeader.Kommissionierung := FALSE;
          //E/P0041

          //S/P0966
          InterfaceProcessMgt.ReserveOrderOnPostPrePmt(SalesHeader);
          //E/P0966

          //H1277, S/P0966 08.10.14 DMA +++++++++++++++++++++++++++++++++++++++++++
          FPCGeneralSetup.TESTFIELD("Interface Code Rhenus");
          IF (InterfaceProcessMgt.UseOldPicking(SalesHeader,FPCGeneralSetup."Interface Code Rhenus") AND
            (SalesHeader.Status = SalesHeader.Status::Released)) OR
            (InterfaceProcessMgt.UseOldReserve(SalesHeader,FPCGeneralSetup."Interface Code Rhenus") AND
            (SalesHeader.Status = SalesHeader.Status::"Pending Prepayment")) THEN BEGIN
          //H1277, E/P0966 08.10.14 DMA -------------------------------------------
            //A/gob-rste/14.09.12/P0329
            IF (SalesHeader.Kommissionierung) AND (SalesHeader."First Pick" = 0DT) THEN
                SalesHeader."First Pick" := CURRENTDATETIME;
            IF (SalesHeader.Kommissionierung) AND (SalesHeader."First Pick User" = '') THEN
                SalesHeader."First Pick User" := USERID;
            //E/gob-rste/14.09.12/P0329
            SalesHeader.MODIFY;
            //A/gob-rste/04.09.12/P0277
            IF NOT SalesHeader."Cancel Without Interfaces" THEN
            //E/gob-rste/04.09.12/P0277
            IF SalesHeader.Kommissionierung THEN
              //S/P1223
              IF NOT CallFromRelease THEN
              //E/P1213
                ReleaseSalesDoc.InsertExpLog(SalesHeader);
          //S/P0966
          END;
          //E/P0966
          //H1408 03.09.14 EHN +++++++++++++++++++++++++++++++++++++++++++++++++++++++
          //H1277, H1408 08.10.14 DMA +++++++++++++++++++++++++++++++++++++++++++
          FPCGeneralSetup.TESTFIELD("Interface Code Whse. LF");
          IF (InterfaceProcessMgt.UseOldPicking(SalesHeader,FPCGeneralSetup."Interface Code Whse. LF") AND
            (SalesHeader.Status = SalesHeader.Status::Released)) OR
            (InterfaceProcessMgt.UseOldReserve(SalesHeader,FPCGeneralSetup."Interface Code Whse. LF") AND
            (SalesHeader.Status = SalesHeader.Status::"Pending Prepayment")) THEN BEGIN
          //H1277, H1408 08.10.14 DMA -------------------------------------------

            IF (SalesHeader.Kommissionierung) AND (SalesHeader."First Pick" = 0DT) THEN
              SalesHeader."First Pick" := CURRENTDATETIME;
            IF (SalesHeader.Kommissionierung) AND (SalesHeader."First Pick User" = '') THEN
              SalesHeader."First Pick User" := USERID;
            SalesHeader.MODIFY;
            IF NOT "Cancel Without Interfaces" THEN
              IF Kommissionierung THEN
                IF NOT CallFromRelease THEN
                  WhseLFSalesInterfaceMgtL.TriggerWhsLFFromSalesHeader(SalesHeader);
          END;
          //H1408 03.09.14 EHN -------------------------------------------------------

        END;
        //E/P0022


      END;

      SalesHeader2 := SalesHeader;

      COMMIT;
      //A/gob-jvi/
      IF DocumentType = DocumentType::"Credit Memo" THEN AutomAppl(SalesHeader2);
      //E/gob-jvi/
      //T0078 07.01.15 TEC-GH ++++++++++++++++++++++++++++++++++++++++++++++++++
      IF DocumentType = DocumentType::Invoice THEN AutomAppl(SalesHeader2);
      //T0078 07.01.15 TEC-GH --------------------------------------------------
    END;

    PROCEDURE CheckOpenPrepaymentLines@1(SalesHeader@1000 : Record 36;DocumentType@1003 : 'Invoice,Credit Memo') : Boolean;
    VAR
      SalesLine@1001 : Record 37;
    BEGIN
      WITH SalesLine DO BEGIN
        ApplyFilter(SalesHeader,DocumentType,SalesLine);
        IF FIND('-') THEN BEGIN
          REPEAT
            IF PrepmtAmount(SalesLine,DocumentType) <> 0 THEN
              EXIT(TRUE);
          UNTIL NEXT = 0;
        END;
      END;
    END;

    LOCAL PROCEDURE RoundAmounts@5(SalesHeader@1001 : Record 36;VAR PrepmtInvLineBuf@1000 : Record 461;VAR TotalPrepmtInvLineBuf@1002 : Record 461;VAR TotalPrepmtInvLineBufLCY@1003 : Record 461);
    VAR
      VAT@1004 : Boolean;
      DummySalesLine@1005 : Record 37;
    BEGIN
      IncrAmounts(PrepmtInvLineBuf,TotalPrepmtInvLineBuf,SalesHeader,DummySalesLine,FALSE,0);

      IF SalesHeader."Currency Code" <> '' THEN BEGIN
        VAT := PrepmtInvLineBuf.Amount <> PrepmtInvLineBuf."Amount Incl. VAT";

        PrepmtInvLineBuf."Amount Incl. VAT" :=
          AmountToLCY(
            SalesHeader,TotalPrepmtInvLineBuf."Amount Incl. VAT",TotalPrepmtInvLineBufLCY."Amount Incl. VAT");
        IF VAT THEN
          PrepmtInvLineBuf.Amount := ROUND(PrepmtInvLineBuf."Amount Incl. VAT" / (1 + PrepmtInvLineBuf."VAT %" / 100))
        ELSE
          PrepmtInvLineBuf.Amount := PrepmtInvLineBuf."Amount Incl. VAT";
        PrepmtInvLineBuf."VAT Amount" := PrepmtInvLineBuf."Amount Incl. VAT" - PrepmtInvLineBuf.Amount;
        IF PrepmtInvLineBuf."VAT Base Amount" <> 0 THEN
          PrepmtInvLineBuf."VAT Base Amount" := PrepmtInvLineBuf.Amount;
      END;

      IncrAmounts(PrepmtInvLineBuf,TotalPrepmtInvLineBufLCY,SalesHeader,DummySalesLine,FALSE,0);
    END;

    LOCAL PROCEDURE IncrAmounts@8(PrepmtInvLineBuf@1001 : Record 461;VAR TotalPrepmtInvLineBuf@1000 : Record 461;SalesHeader@1004 : Record 36;SalesLine@1002 : Record 37;UpdateSalesLine@1003 : Boolean;DocumentType@1005 : 'Invoice,Credit Memo');
    VAR
      PrePmtAmount@1006 : Decimal;
    BEGIN
      WITH TotalPrepmtInvLineBuf DO BEGIN
        IF UpdateSalesLine THEN BEGIN
          IF SalesHeader."Prices Including VAT" THEN
            PrePmtAmount := PrepmtInvLineBuf.Amount + PrepmtInvLineBuf."VAT Amount"
          ELSE
            PrePmtAmount := PrepmtInvLineBuf.Amount;
          IF SalesHeader."Currency Code" <> '' THEN
            IF DocumentType = DocumentType::Invoice THEN
              SalesLine."Prepmt. Amount Inv. (LCY)" := SalesLine."Prepmt. Amount Inv. (LCY)" +
                (ROUND(CurrExchRate.ExchangeAmtFCYToLCY(
                  SalesHeader."Posting Date",
                  SalesHeader."Currency Code",
                  Amount + PrePmtAmount,
                  SalesHeader."Currency Factor")) -
                ROUND(CurrExchRate.ExchangeAmtFCYToLCY(
                  SalesHeader."Posting Date",
                  SalesHeader."Currency Code",
                  Amount,
                  SalesHeader."Currency Factor")))
            ELSE
              SalesLine."Prepmt. Amount Inv. (LCY)" := SalesLine."Prepmt. Amount Inv. (LCY)" -
                (ROUND(CurrExchRate.ExchangeAmtFCYToLCY(
                  SalesHeader."Posting Date",
                  SalesHeader."Currency Code",
                  Amount + PrePmtAmount,
                  SalesHeader."Currency Factor")) -
                ROUND(CurrExchRate.ExchangeAmtFCYToLCY(
                  SalesHeader."Posting Date",
                  SalesHeader."Currency Code",
                  Amount,
                  SalesHeader."Currency Factor")))
          ELSE
            IF DocumentType = DocumentType::Invoice THEN
              SalesLine."Prepmt. Amount Inv. (LCY)" := SalesLine."Prepmt. Amount Inv. (LCY)" +
                PrePmtAmount
            ELSE
              SalesLine."Prepmt. Amount Inv. (LCY)" := SalesLine."Prepmt. Amount Inv. (LCY)" -
                PrePmtAmount;
          SalesLine.MODIFY;
        END;
        Amount := Amount + PrepmtInvLineBuf.Amount;
        "Amount Incl. VAT" := "Amount Incl. VAT" + PrepmtInvLineBuf."Amount Incl. VAT";
        "VAT Amount" := "VAT Amount" + PrepmtInvLineBuf."VAT Amount";
        "VAT Base Amount" := "VAT Base Amount" + PrepmtInvLineBuf."VAT Base Amount";
        "Amount (ACY)" := "Amount (ACY)" + PrepmtInvLineBuf."Amount (ACY)";
        "VAT Amount (ACY)" := "VAT Amount (ACY)" + PrepmtInvLineBuf."VAT Amount (ACY)";
        "VAT Base Amount (ACY)" := "VAT Base Amount (ACY)" + PrepmtInvLineBuf."VAT Base Amount (ACY)";
        "VAT Difference" := "VAT Difference" + PrepmtInvLineBuf."VAT Difference";
      END;
    END;

    LOCAL PROCEDURE AmountToLCY@6(SalesHeader@1001 : Record 36;TotalAmt@1000 : Decimal;PrevTotalAmt@1002 : Decimal) : Decimal;
    VAR
      CurrExchRate@1003 : Record 330;
    BEGIN
      CurrExchRate.INIT;
      WITH SalesHeader DO
        EXIT(
          ROUND(
            CurrExchRate.ExchangeAmtFCYToLCY("Posting Date","Currency Code",TotalAmt,"Currency Factor")) -
          PrevTotalAmt);
    END;

    LOCAL PROCEDURE ReverseAmounts@7(VAR PrepmtInvLineBuffer@1000 : Record 461);
    BEGIN
      WITH PrepmtInvLineBuffer DO BEGIN
        Amount := -Amount;
        "Amount Incl. VAT" := -"Amount Incl. VAT";
        "VAT Amount" := -"VAT Amount";
        "VAT Base Amount" := -"VAT Base Amount";
        "Amount (ACY)" := -"Amount (ACY)";
        "VAT Amount (ACY)" := -"VAT Amount (ACY)";
        "VAT Base Amount (ACY)" := -"VAT Base Amount (ACY)";
        "VAT Difference" := -"VAT Difference";
      END;
    END;

    PROCEDURE BuildInvLineBuffer@3(SalesHeader@1000 : Record 36;VAR SalesLine@1001 : Record 37;DocumentType@1005 : 'Invoice,Credit Memo,Statistic';VAR PrepmtInvBuf@1002 : Record 461;VAR TempDocDim@1004 : Record 357;InvoiceRounding@1007 : Boolean;UpdateLines@1010 : Boolean);
    VAR
      GLAcc@1006 : Record 15;
      PrepmtInvBuf2@1003 : Record 461;
      TotalPrepmtInvLineBuffer@1009 : Record 461;
      TotalPrepmtInvLineBufferDummy@1008 : Record 461;
      GOBGLACC2@1108200000 : Record 15;
    BEGIN
      WITH SalesHeader DO BEGIN
        ApplyFilter(SalesHeader,DocumentType,SalesLine);
        SalesLine.SETRANGE("System-Created Entry",FALSE);
        IF SalesLine.FIND('-') THEN
          REPEAT
            IF PrepmtAmount(SalesLine,DocumentType) <> 0 THEN BEGIN

              // 1.00 B >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
              //original IF SalesLine.Quantity < 0 THEN
              //original   SalesLine.FIELDERROR(Quantity,STRSUBSTNO(Text018,FIELDCAPTION("Prepayment %")));
              //original IF SalesLine."Unit Price" < 0 THEN
              //original   SalesLine.FIELDERROR("Unit Price",STRSUBSTNO(Text018,FIELDCAPTION("Prepayment %")));
              // 1.00 E <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

              IF (SalesLine."Gen. Bus. Posting Group" <> GenPostingSetup."Gen. Bus. Posting Group") OR
                 (SalesLine."Gen. Prod. Posting Group" <> GenPostingSetup."Gen. Prod. Posting Group")
              THEN BEGIN
                GenPostingSetup.GET(
                  SalesLine."Gen. Bus. Posting Group",SalesLine."Gen. Prod. Posting Group");
                GenPostingSetup.TESTFIELD("Sales Prepayments Account");
              END;
              GLAcc.GET(GenPostingSetup."Sales Prepayments Account");
              FillInvLineBuffer(SalesHeader,SalesLine,GLAcc,PrepmtInvBuf2,TempDocDim);
              InsertInvLineBuffer(PrepmtInvBuf,PrepmtInvBuf2,SalesHeader,SalesLine,DocumentType,UpdateLines);

              IF InvoiceRounding THEN
                RoundAmounts(
                  SalesHeader,PrepmtInvBuf2,TotalPrepmtInvLineBuffer,TotalPrepmtInvLineBufferDummy);
            END;
          UNTIL SalesLine.NEXT = 0;
        IF InvoiceRounding THEN
          IF InsertInvoiceRounding(
            SalesHeader,PrepmtInvBuf2,TotalPrepmtInvLineBuffer,SalesLine."Line No.")
          THEN
            InsertInvLineBuffer(PrepmtInvBuf,PrepmtInvBuf2,SalesHeader,SalesLine,DocumentType,UpdateLines);
      END;
    END;

    PROCEDURE BuildInvLineBuffer2@19(SalesHeader@1000 : Record 36;VAR SalesLine@1001 : Record 37;DocumentType@1005 : 'Invoice,Credit Memo,Statistic';VAR PrepmtInvBuf@1002 : Record 461;VAR TempDocDim@1004 : Record 357);
    VAR
      SalesSetup@1003 : Record 311;
    BEGIN
      SalesSetup.GET;
      BuildInvLineBuffer(
        SalesHeader,SalesLine,DocumentType,PrepmtInvBuf,TempDocDim,SalesSetup."Invoice Rounding",FALSE);
    END;

    PROCEDURE InsertInvLineBuffer@11(VAR PrepmtInvBuf@1001 : Record 461;PrepmtInvBuf2@1000 : Record 461;SalesHeader@1003 : Record 36;SalesLine@1002 : Record 37;DocumentType@1004 : 'Invoice,Credit Memo';UpdateLine@1005 : Boolean);
    VAR
      PrePmtAmount@1006 : Decimal;
    BEGIN
      WITH PrepmtInvBuf DO BEGIN
        PrepmtInvBuf := PrepmtInvBuf2;
        IF FIND THEN BEGIN
          IncrAmounts(PrepmtInvBuf2,PrepmtInvBuf,SalesHeader,SalesLine,UpdateLine,DocumentType);
          MODIFY;
        END ELSE BEGIN
          IF UpdateLine THEN BEGIN
            IF SalesHeader."Prices Including VAT" THEN
              PrePmtAmount := "Amount Incl. VAT"
            ELSE
              PrePmtAmount := Amount;
            IF DocumentType = DocumentType::Invoice THEN
              SalesLine."Prepmt. Amount Inv. (LCY)" := SalesLine."Prepmt. Amount Inv. (LCY)" +
                ROUND(CurrExchRate.ExchangeAmtFCYToLCY(
                  SalesHeader."Posting Date",
                  SalesHeader."Currency Code",
                  PrePmtAmount,
                  SalesHeader."Currency Factor"))
            ELSE
              SalesLine."Prepmt. Amount Inv. (LCY)" := SalesLine."Prepmt. Amount Inv. (LCY)" -
                ROUND(CurrExchRate.ExchangeAmtFCYToLCY(
                  SalesHeader."Posting Date",
                  SalesHeader."Currency Code",
                  PrePmtAmount,
                  SalesHeader."Currency Factor"));
            SalesLine.MODIFY;
          END;
          INSERT;
        END;
      END;
    END;

    PROCEDURE FillInvLineBuffer@4(SalesHeader@1001 : Record 36;SalesLine@1002 : Record 37;GLAcc@1007 : Record 15;VAR PrepmtInvBuf@1000 : Record 461;VAR TempDocDim@1006 : Record 357);
    BEGIN
      WITH PrepmtInvBuf DO BEGIN
        CLEAR(PrepmtInvBuf);

        "G/L Account No." := GLAcc."No.";
        "Dimension Entry No." := InsertInDimBuffer(TempDocDim,SalesLine);
        "Gen. Bus. Posting Group" := SalesLine."Gen. Bus. Posting Group";
        "VAT Bus. Posting Group" := SalesLine."VAT Bus. Posting Group";
        "Gen. Prod. Posting Group" := GLAcc."Gen. Prod. Posting Group";
        "VAT Prod. Posting Group" := GLAcc."VAT Prod. Posting Group";
        "VAT Calculation Type" := SalesLine."Prepmt. VAT Calc. Type";
        "Global Dimension 1 Code" := SalesLine."Shortcut Dimension 1 Code";
        "Global Dimension 2 Code" := SalesLine."Shortcut Dimension 2 Code";
        "Job No." := SalesLine."Job No.";
        Amount := SalesLine."Prepayment Amount";
        "Amount Incl. VAT" := SalesLine."Prepmt. Amt. Incl. VAT";
        "VAT Base Amount" := SalesLine."Prepayment Amount";
        "VAT Amount" := SalesLine."Prepmt. Amt. Incl. VAT" - SalesLine."Prepayment Amount";
        "Amount (ACY)" := SalesLine."Prepayment Amount";
        "VAT Base Amount (ACY)" := SalesLine."Prepayment Amount";
        "VAT Amount (ACY)" := SalesLine."Prepmt. Amt. Incl. VAT" - SalesLine."Prepayment Amount";
        "VAT %" := SalesLine."Prepayment VAT %";
        "VAT Identifier" := SalesLine."Prepayment VAT Identifier";
        "VAT Difference" := SalesLine."Prepayment VAT Difference";
        "Tax Area Code" := SalesLine."Tax Area Code";
        "Tax Liable" := SalesLine."Tax Liable";
        "Tax Group Code" := SalesLine."Tax Group Code";
        IF NOT SalesHeader."Compress Prepayment" THEN BEGIN
          "Line No." := SalesLine."Line No.";
          Description := SalesLine.Description;
        END ELSE
          Description := GLAcc.Name;
      END;
    END;

    LOCAL PROCEDURE InsertInvoiceRounding@25(SalesHeader@1002 : Record 36;VAR PrepmtInvBuf@1000 : Record 461;TotalPrepmtInvBuf@1001 : Record 461;PrevLineNo@1008 : Integer) : Boolean;
    VAR
      SalesLine@1007 : Record 37;
      TempDocDim@1009 : TEMPORARY Record 357;
    BEGIN
      IF InitInvoiceRoundingLine(SalesHeader,TotalPrepmtInvBuf."Amount Incl. VAT",SalesLine) THEN BEGIN
        CreateDimensions(SalesLine,TempDocDim);
        WITH PrepmtInvBuf DO BEGIN
          CLEAR(PrepmtInvBuf);
          "Invoice Rounding" := TRUE;
          "G/L Account No." := SalesLine."No.";
          "Dimension Entry No." := InsertInDimBuffer(TempDocDim,SalesLine);
          "Gen. Bus. Posting Group" := SalesHeader."Gen. Bus. Posting Group";
          "VAT Bus. Posting Group" := SalesHeader."VAT Bus. Posting Group";
          "Gen. Prod. Posting Group" := SalesLine."Gen. Prod. Posting Group";
          "VAT Prod. Posting Group" := SalesLine."VAT Prod. Posting Group";
          "VAT Calculation Type" := SalesLine."VAT Calculation Type";
          "Global Dimension 1 Code" := SalesLine."Shortcut Dimension 1 Code";
          "Global Dimension 2 Code" := SalesLine."Shortcut Dimension 2 Code";
          Amount := SalesLine."Line Amount";
          "Amount Incl. VAT" := SalesLine."Amount Including VAT";
          "VAT Base Amount" := SalesLine."Line Amount";
          "VAT Amount" := SalesLine."Amount Including VAT" - SalesLine."Line Amount";
          "Amount (ACY)" := SalesLine."Prepayment Amount";
          "VAT Base Amount (ACY)" := SalesLine."Line Amount";
          "VAT Amount (ACY)" := SalesLine."Amount Including VAT" - SalesLine."Line Amount";
          "VAT %" := SalesLine."VAT %";
          "VAT Identifier" := SalesLine."VAT Identifier";
          "Tax Area Code" := SalesLine."Tax Area Code";
          "Tax Liable" := SalesLine."Tax Liable";
          "Tax Group Code" := SalesLine."Tax Group Code";
          "Line No." := PrevLineNo + 10000;
        END;
        EXIT(TRUE);
      END;
    END;

    LOCAL PROCEDURE InitInvoiceRoundingLine@29(SalesHeader@1000 : Record 36;TotalAmount@1004 : Decimal;VAR SalesLine@1001 : Record 37) : Boolean;
    VAR
      Currency@1007 : Record 4;
      CustPostingGr@1006 : Record 92;
      GLAcc@1005 : Record 15;
      InvoiceRoundingAmount@1002 : Decimal;
    BEGIN
      IF SalesHeader."Currency Code" = '' THEN
        Currency.InitRoundingPrecision
      ELSE
        Currency.GET(SalesHeader."Currency Code");
      Currency.TESTFIELD("Invoice Rounding Precision");
      InvoiceRoundingAmount :=
        -ROUND(
          TotalAmount -
          ROUND(
            TotalAmount,
            Currency."Invoice Rounding Precision",
            Currency.InvoiceRoundingDirection),
          Currency."Amount Rounding Precision");

      IF InvoiceRoundingAmount = 0 THEN
        EXIT(FALSE);

      CustPostingGr.GET(SalesHeader."Customer Posting Group");
      CustPostingGr.TESTFIELD("Invoice Rounding Account");
      GLAcc.GET(CustPostingGr."Invoice Rounding Account");
      WITH SalesLine DO BEGIN
        SetHideValidationDialog(TRUE);
        "Document Type" := SalesHeader."Document Type";
        "Document No." := SalesHeader."No.";
        "System-Created Entry" := TRUE;
        Type := Type::"G/L Account";
        VALIDATE("No.",CustPostingGr."Invoice Rounding Account");
        VALIDATE(Quantity,1);
        IF SalesHeader."Prices Including VAT" THEN
          VALIDATE("Unit Price",InvoiceRoundingAmount)
        ELSE
          VALIDATE(
            "Unit Price",
            ROUND(
              InvoiceRoundingAmount /
              (1 + (1 - SalesHeader."VAT Base Discount %" / 100) * "VAT %" / 100),
              Currency."Amount Rounding Precision"));
        VALIDATE("Amount Including VAT",InvoiceRoundingAmount);
      END;
      EXIT(TRUE);
    END;

    LOCAL PROCEDURE CompressInvLineBuffer@1000000000(SalesHeader@1000000001 : Record 36;VAR PrepmtInvBuffer@1000000000 : Record 461);
    VAR
      PrepmtInvBuffer2@1000 : TEMPORARY Record 461;
      DummySalesLine@1001 : Record 37;
    BEGIN
      IF SalesHeader."Compress Prepayment" THEN
        EXIT;

      WITH PrepmtInvBuffer2 DO BEGIN
        PrepmtInvBuffer.FIND('-');
        REPEAT
          PrepmtInvBuffer2 := PrepmtInvBuffer;
          "Line No." := 0;
          IF FIND THEN BEGIN
            IncrAmounts(PrepmtInvBuffer,PrepmtInvBuffer2,SalesHeader,DummySalesLine,FALSE,0);
            MODIFY;
          END ELSE
            INSERT;
        UNTIL PrepmtInvBuffer.NEXT = 0;

        PrepmtInvBuffer.DELETEALL;

        FIND('-');
        REPEAT
          PrepmtInvBuffer := PrepmtInvBuffer2;
          PrepmtInvBuffer.INSERT;
        UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE CopyCommentLines@22(FromNumber@1002 : Code[20];ToDocType@1000 : Integer;ToNumber@1003 : Code[20]);
    VAR
      SalesCommentLine@1004 : Record 44;
      SalesCommentLine2@1005 : Record 44;
    BEGIN
      WITH SalesCommentLine DO BEGIN
        SETRANGE("Document Type","Document Type"::Order);
        SETRANGE("No.",FromNumber);
        IF FIND('-') THEN
          REPEAT
            SalesCommentLine2 := SalesCommentLine;
            CASE ToDocType OF
              DATABASE::"Sales Invoice Header":
                SalesCommentLine2."Document Type" :=
                  SalesCommentLine2."Document Type"::"Posted Invoice";
              DATABASE::"Sales Cr.Memo Header":
                SalesCommentLine2."Document Type" :=
                  SalesCommentLine2."Document Type"::"Posted Credit Memo";
            END;
            SalesCommentLine2."No." := ToNumber;
            SalesCommentLine2.INSERT;
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE InsertExtendedText@17(TabNo@1000 : Integer;DocNo@1003 : Code[20];GLAccNo@1006 : Code[20];DocDate@1001 : Date;LanguageCode@1009 : Code[10];VAR PrevLineNo@1002 : Integer);
    VAR
      TempExtTextLine@1005 : TEMPORARY Record 280;
      SalesInvLine@1007 : Record 113;
      SalesCrMemoLine@1008 : Record 115;
      TransferExtText@1004 : Codeunit 378;
      NextLineNo@1010 : Integer;
    BEGIN
      TransferExtText.PrepmtGetAnyExtText(GLAccNo,TabNo,DocDate,LanguageCode,TempExtTextLine);
      IF TempExtTextLine.FIND('-') THEN BEGIN
        NextLineNo := PrevLineNo + 10000;
        REPEAT
          CASE TabNo OF
            DATABASE::"Sales Invoice Line":
              BEGIN
                SalesInvLine."Document No." := DocNo;
                SalesInvLine."Line No." := NextLineNo;
                SalesInvLine.Description := TempExtTextLine.Text;
                SalesInvLine.INSERT;
              END;
            DATABASE::"Sales Cr.Memo Line":
              BEGIN
                SalesCrMemoLine."Document No." := DocNo;
                SalesCrMemoLine."Line No." := NextLineNo;
                SalesCrMemoLine.Description := TempExtTextLine.Text;
                SalesCrMemoLine.INSERT;
              END;
          END;
          PrevLineNo := NextLineNo;
          NextLineNo := NextLineNo + 10000;
        UNTIL TempExtTextLine.NEXT = 0;
      END;
    END;

    PROCEDURE UpdateVATOnLines@36(SalesHeader@1001 : Record 36;VAR SalesLine@1011 : Record 37;VAR VATAmountLine@1003 : Record 290;DocumentType@1000 : 'Invoice,Credit Memo,Statistic');
    VAR
      TempVATAmountLineRemainder@1004 : TEMPORARY Record 290;
      Currency@1005 : Record 4;
      ChangeLogMgt@1012 : Codeunit 423;
      RecRef@1015 : RecordRef;
      xRecRef@1014 : RecordRef;
      PrepmtAmt@1002 : Decimal;
      NewAmount@1006 : Decimal;
      NewAmountIncludingVAT@1007 : Decimal;
      NewVATBaseAmount@1008 : Decimal;
      VATAmount@1009 : Decimal;
      VATDifference@1010 : Decimal;
      PrepmtAmtToInvTotal@1013 : Decimal;
    BEGIN
      IF SalesHeader."Currency Code" = '' THEN
        Currency.InitRoundingPrecision
      ELSE
        Currency.GET(SalesHeader."Currency Code");

      WITH SalesLine DO BEGIN
        ApplyFilter(SalesHeader,DocumentType,SalesLine);
        //A/gob-adb/15.05.13
        //LOCKTABLE;
        //E/gob-adb/15.05.13
        IF FIND('-') THEN
          REPEAT
            PrepmtAmtToInvTotal := PrepmtAmtToInvTotal + ("Prepmt. Line Amount" - "Prepmt. Amt. Inv.");
          UNTIL NEXT = 0;
        IF FIND('-') THEN
          REPEAT
            PrepmtAmt := PrepmtAmount(SalesLine,DocumentType);
            IF PrepmtAmt <> 0 THEN BEGIN
              VATAmountLine.GET(
                "Prepayment VAT Identifier",
                "Prepmt. VAT Calc. Type",
                "Prepayment Tax Group Code",
                FALSE,
                PrepmtAmt >= 0);
              IF VATAmountLine.Modified THEN BEGIN
                xRecRef.GETTABLE(SalesLine);
                IF NOT TempVATAmountLineRemainder.GET(
                     "Prepayment VAT Identifier",
                     "Prepmt. VAT Calc. Type",
                     "Prepayment Tax Group Code",
                     FALSE,
                     PrepmtAmt >= 0)
                THEN BEGIN
                  TempVATAmountLineRemainder := VATAmountLine;
                  TempVATAmountLineRemainder.INIT;
                  TempVATAmountLineRemainder.INSERT;
                END;

                IF SalesHeader."Prices Including VAT" THEN BEGIN
                  IF PrepmtAmt = 0 THEN BEGIN
                    VATAmount := 0;
                    NewAmountIncludingVAT := 0;
                  END ELSE BEGIN
                    VATAmount :=
                      TempVATAmountLineRemainder."VAT Amount" +
                      VATAmountLine."VAT Amount" * PrepmtAmt / VATAmountLine."Line Amount";
                    NewAmountIncludingVAT :=
                      TempVATAmountLineRemainder."Amount Including VAT" +
                      VATAmountLine."Amount Including VAT" * PrepmtAmt / VATAmountLine."Line Amount";
                  END;
                  NewAmount :=
                    ROUND(NewAmountIncludingVAT,Currency."Amount Rounding Precision") -
                    ROUND(VATAmount,Currency."Amount Rounding Precision");
                  NewVATBaseAmount :=
                    ROUND(
                      NewAmount * (1 - SalesHeader."VAT Base Discount %" / 100),
                      Currency."Amount Rounding Precision");
                END ELSE BEGIN
                  NewAmount := PrepmtAmt;
                  NewVATBaseAmount :=
                    ROUND(
                      NewAmount * (1 - SalesHeader."VAT Base Discount %" / 100),
                      Currency."Amount Rounding Precision");
                  IF VATAmountLine."VAT Base" = 0 THEN
                    VATAmount := 0
                  ELSE
                    VATAmount :=
                      TempVATAmountLineRemainder."VAT Amount" +
                      VATAmountLine."VAT Amount" * NewAmount / VATAmountLine."VAT Base";
                  NewAmountIncludingVAT := NewAmount + ROUND(VATAmount,Currency."Amount Rounding Precision");
                END;

                "Prepayment Amount" := NewAmount;
                "Prepmt. Amt. Incl. VAT" :=
                  ROUND(NewAmountIncludingVAT,Currency."Amount Rounding Precision");
                "Prepmt. VAT Base Amt." := NewVATBaseAmount;

                IF (VATAmountLine."Line Amount" - VATAmountLine."Invoice Discount Amount") = 0 THEN
                  VATDifference := 0
                ELSE
                  IF PrepmtAmtToInvTotal = 0 THEN
                    VATDifference :=
                      VATAmountLine."VAT Difference" * ("Prepmt. Line Amount" - "Prepmt. Amt. Inv.") /
                      (VATAmountLine."Line Amount" - VATAmountLine."Invoice Discount Amount")
                  ELSE
                    VATDifference :=
                      VATAmountLine."VAT Difference" * ("Prepmt. Line Amount" - "Prepmt. Amt. Inv.") /
                      PrepmtAmtToInvTotal;

                "Prepayment VAT Difference" := ROUND(VATDifference,Currency."Amount Rounding Precision");

                MODIFY;
                RecRef.GETTABLE(SalesLine);
                ChangeLogMgt.LogModification(RecRef,xRecRef);

                TempVATAmountLineRemainder."Amount Including VAT" :=
                  NewAmountIncludingVAT - ROUND(NewAmountIncludingVAT,Currency."Amount Rounding Precision");
                TempVATAmountLineRemainder."VAT Amount" := VATAmount - NewAmountIncludingVAT + NewAmount;
                TempVATAmountLineRemainder."VAT Difference" := VATDifference - "Prepayment VAT Difference";
                TempVATAmountLineRemainder.MODIFY;
              END;
            END;
          UNTIL NEXT = 0;
      END;
    END;

    PROCEDURE CalcVATAmountLines@35(VAR SalesHeader@1001 : Record 36;VAR SalesLine@1009 : Record 37;VAR VATAmountLine@1003 : Record 290;DocumentType@1008 : 'Invoice,Credit Memo,Statistic');
    VAR
      PrevVatAmountLine@1007 : Record 290;
      Currency@1004 : Record 4;
      SalesTaxCalculate@1005 : Codeunit 398;
      NewAmount@1002 : Decimal;
      NewPrepmtVATDiffAmt@1010 : Decimal;
    BEGIN
      IF SalesHeader."Currency Code" = '' THEN
        Currency.InitRoundingPrecision
      ELSE
        Currency.GET(SalesHeader."Currency Code");

      VATAmountLine.DELETEALL;

      WITH SalesLine DO BEGIN
        ApplyFilter(SalesHeader,DocumentType,SalesLine);
        IF FIND('-') THEN
          REPEAT
            NewAmount := PrepmtAmount(SalesLine,DocumentType);
            IF NewAmount <> 0 THEN BEGIN
              IF DocumentType = DocumentType::Invoice THEN
                NewAmount := "Prepmt. Line Amount";
              IF "Prepmt. VAT Calc. Type" IN
                 ["VAT Calculation Type"::"Reverse Charge VAT","VAT Calculation Type"::"Sales Tax"]
              THEN
                "VAT %" := 0;
              IF NOT VATAmountLine.GET(
                   "Prepayment VAT Identifier",
                   "Prepmt. VAT Calc. Type","Prepayment Tax Group Code",
                   FALSE,NewAmount >= 0)
              THEN BEGIN
                VATAmountLine.INIT;
                VATAmountLine."VAT Identifier" := "Prepayment VAT Identifier";
                VATAmountLine."VAT Calculation Type" := "Prepmt. VAT Calc. Type";
                VATAmountLine."Tax Group Code" := "Prepayment Tax Group Code";
                VATAmountLine."VAT %" := "Prepayment VAT %";
                VATAmountLine.Modified := TRUE;
                VATAmountLine.Positive := NewAmount >= 0;
                VATAmountLine."Includes Prepayment" := TRUE;
                VATAmountLine.INSERT;
              END;
              VATAmountLine."Line Amount" := VATAmountLine."Line Amount" + NewAmount;
              NewPrepmtVATDiffAmt := PrepmtVATDiffAmount(SalesLine,DocumentType);
              IF DocumentType = DocumentType::Invoice THEN
                NewPrepmtVATDiffAmt := SalesLine."Prepayment VAT Difference" + SalesLine."Prepmt VAT Diff. to Deduct" +
                  SalesLine."Prepmt VAT Diff. Deducted";
              VATAmountLine."VAT Difference" := VATAmountLine."VAT Difference" + NewPrepmtVATDiffAmt;
              VATAmountLine.MODIFY;
            END;
          UNTIL NEXT = 0;
      END;

      WITH VATAmountLine DO
        IF FIND('-') THEN
          REPEAT
            IF (PrevVatAmountLine."VAT Identifier" <> "VAT Identifier") OR
               (PrevVatAmountLine."VAT Calculation Type" <> "VAT Calculation Type") OR
               (PrevVatAmountLine."Tax Group Code" <> "Tax Group Code") OR
               (PrevVatAmountLine."Use Tax" <> "Use Tax")
            THEN
              PrevVatAmountLine.INIT;
            IF SalesHeader."Prices Including VAT" THEN BEGIN
              CASE "VAT Calculation Type" OF
                "VAT Calculation Type"::"Normal VAT",
                "VAT Calculation Type"::"Reverse Charge VAT":
                  BEGIN
                    "VAT Base" :=
                      ROUND(
                        ("Line Amount" - "Invoice Discount Amount") / (1 + "VAT %" / 100),
                        Currency."Amount Rounding Precision") - "VAT Difference";
                    "VAT Amount" :=
                      "VAT Difference" +
                      ROUND(
                        PrevVatAmountLine."VAT Amount" +
                        ("Line Amount" - "VAT Base" - "VAT Difference") *
                        (1 - SalesHeader."VAT Base Discount %" / 100),
                        Currency."Amount Rounding Precision",Currency.VATRoundingDirection);
                    "Amount Including VAT" := "VAT Base" + "VAT Amount";
                    IF Positive THEN
                      PrevVatAmountLine.INIT
                    ELSE BEGIN
                      PrevVatAmountLine := VATAmountLine;
                      PrevVatAmountLine."VAT Amount" :=
                        ("Line Amount" - "VAT Base" - "VAT Difference") *
                        (1 - SalesHeader."VAT Base Discount %" / 100);
                      PrevVatAmountLine."VAT Amount" :=
                        PrevVatAmountLine."VAT Amount" -
                        ROUND(PrevVatAmountLine."VAT Amount",Currency."Amount Rounding Precision",Currency.VATRoundingDirection);
                    END;
                  END;
                "VAT Calculation Type"::"Sales Tax":
                  BEGIN
                    "Amount Including VAT" := "Line Amount" - "Invoice Discount Amount";
                    "VAT Base" :=
                      ROUND(
                        SalesTaxCalculate.ReverseCalculateTax(
                          SalesHeader."Tax Area Code","Tax Group Code",SalesHeader."Tax Liable",
                          SalesHeader."Posting Date","Amount Including VAT",Quantity,SalesHeader."Currency Factor"),
                        Currency."Amount Rounding Precision");
                    "VAT Amount" := "VAT Difference" + "Amount Including VAT" - "VAT Base";
                    IF "VAT Base" = 0 THEN
                      "VAT %" := 0
                    ELSE
                      "VAT %" := ROUND(100 * "VAT Amount" / "VAT Base",0.00001);
                  END;
              END;
            END ELSE BEGIN
              CASE "VAT Calculation Type" OF
                "VAT Calculation Type"::"Normal VAT",
                "VAT Calculation Type"::"Reverse Charge VAT":
                  BEGIN
                    "VAT Base" := "Line Amount" - "Invoice Discount Amount";
                    "VAT Amount" :=
                      "VAT Difference" +
                      ROUND(
                        PrevVatAmountLine."VAT Amount" +
                        "VAT Base" * "VAT %" / 100 * (1 - SalesHeader."VAT Base Discount %" / 100),
                        Currency."Amount Rounding Precision",Currency.VATRoundingDirection);
                    "Amount Including VAT" := "Line Amount" - "Invoice Discount Amount" + "VAT Amount";
                    IF Positive THEN
                      PrevVatAmountLine.INIT
                    ELSE BEGIN
                      PrevVatAmountLine := VATAmountLine;
                      PrevVatAmountLine."VAT Amount" :=
                        "VAT Base" * "VAT %" / 100 * (1 - SalesHeader."VAT Base Discount %" / 100);
                      PrevVatAmountLine."VAT Amount" :=
                        PrevVatAmountLine."VAT Amount" -
                        ROUND(PrevVatAmountLine."VAT Amount",Currency."Amount Rounding Precision",Currency.VATRoundingDirection);
                    END;
                  END;
                "VAT Calculation Type"::"Sales Tax":
                  BEGIN
                    "VAT Base" := "Line Amount" - "Invoice Discount Amount";
                    "VAT Amount" :=
                      SalesTaxCalculate.CalculateTax(
                        SalesHeader."Tax Area Code","Tax Group Code",SalesHeader."Tax Liable",
                        SalesHeader."Posting Date","VAT Base",Quantity,SalesHeader."Currency Factor");
                    IF "VAT Base" = 0 THEN
                      "VAT %" := 0
                    ELSE
                      "VAT %" := ROUND(100 * "VAT Amount" / "VAT Base",0.00001);
                    "VAT Amount" :=
                      "VAT Difference" +
                      ROUND("VAT Amount",Currency."Amount Rounding Precision",Currency.VATRoundingDirection);
                    "Amount Including VAT" := "VAT Base" + "VAT Amount";
                  END;
              END;
            END;
            "Calculated VAT Amount" := "VAT Amount" - "VAT Difference";
            MODIFY;
          UNTIL NEXT = 0;
    END;

    PROCEDURE SumPrepmt@15(SalesHeader@1000 : Record 36;VAR SalesLine@1011 : Record 37;VAR VATAmountLine@1003 : Record 290;VAR TotalAmount@1001 : Decimal;VAR TotalVATAmount@1002 : Decimal;VAR VATAmountText@1004 : Text[30]);
    VAR
      SalesSetup@1012 : Record 311;
      PrepmtInvBuf@1005 : TEMPORARY Record 461;
      TotalPrepmtBuf@1007 : Record 461;
      TotalPrepmtBufLCY@1008 : Record 461;
      TempDocDim@1006 : TEMPORARY Record 357;
      DifVATPct@1009 : Boolean;
      PrevVATPct@1010 : Decimal;
    BEGIN
      SalesSetup.GET;
      CalcVATAmountLines(SalesHeader,SalesLine,VATAmountLine,2);
      UpdateVATOnLines(SalesHeader,SalesLine,VATAmountLine,2);
      BuildInvLineBuffer(SalesHeader,SalesLine,2,PrepmtInvBuf,TempDocDim,SalesSetup."Invoice Rounding",FALSE);
      IF PrepmtInvBuf.FIND('-') THEN BEGIN
        PrevVATPct := PrepmtInvBuf."VAT %";
        REPEAT
          RoundAmounts(SalesHeader,PrepmtInvBuf,TotalPrepmtBuf,TotalPrepmtBufLCY);
          IF PrepmtInvBuf."VAT %" <> PrevVATPct THEN
            DifVATPct := TRUE;
        UNTIL PrepmtInvBuf.NEXT = 0;
      END;

      TotalAmount := TotalPrepmtBuf.Amount;
      TotalVATAmount := TotalPrepmtBuf."VAT Amount";
      IF DifVATPct OR (PrepmtInvBuf."VAT %" = 0) THEN
        VATAmountText := Text014
      ELSE
        VATAmountText := STRSUBSTNO(Text015,PrevVATPct);
    END;

    PROCEDURE GetSalesLines@16(SalesHeader@1000 : Record 36;DocumentType@1003 : 'Invoice,Credit Memo,Statistic';VAR ToSalesLine@1001 : Record 37);
    VAR
      SalesSetup@1004 : Record 311;
      FromSalesLine@1002 : Record 37;
      InvRoundingSalesLine@1007 : Record 37;
      TempVATAmountLine@1005 : TEMPORARY Record 290;
      TotalAmt@1006 : Decimal;
      NextLineNo@1008 : Integer;
    BEGIN
      ApplyFilter(SalesHeader,DocumentType,FromSalesLine);
      IF FromSalesLine.FIND('-') THEN BEGIN
        REPEAT
          ToSalesLine := FromSalesLine;
          ToSalesLine.INSERT;
        UNTIL FromSalesLine.NEXT = 0;

        SalesSetup.GET;
        IF SalesSetup."Invoice Rounding" THEN BEGIN
          CalcVATAmountLines(SalesHeader,ToSalesLine,TempVATAmountLine,2);
          UpdateVATOnLines(SalesHeader,ToSalesLine,TempVATAmountLine,2);
          ToSalesLine.FIND('-');
          REPEAT
            TotalAmt := TotalAmt + ToSalesLine."Prepmt. Amt. Incl. VAT";
          UNTIL ToSalesLine.NEXT = 0;
          IF InitInvoiceRoundingLine(SalesHeader,TotalAmt,InvRoundingSalesLine) THEN
            WITH ToSalesLine DO BEGIN
              NextLineNo := "Line No." + 1;
              ToSalesLine := InvRoundingSalesLine;
              "Line No." := NextLineNo;

              IF DocumentType <> DocumentType::"Credit Memo" THEN
                "Prepmt. Line Amount" := "Line Amount"
              ELSE
                "Prepmt. Amt. Inv." := "Line Amount";
              "Prepmt. VAT Calc. Type" := "VAT Calculation Type";
              "Prepayment VAT Identifier" := "VAT Identifier";
              "Prepayment Tax Group Code" := "Tax Group Code";
              "Prepayment VAT Identifier" := "VAT Identifier";
              "Prepayment Tax Group Code" := "Tax Group Code";
              "Prepayment VAT %" := "VAT %";
              INSERT;
            END;
        END;
      END;
    END;

    LOCAL PROCEDURE CopyAndCheckDocDimToTempDocDim@34(VAR TempDocDim@1000 : Record 357;SalesHeader@1001 : Record 36);
    VAR
      DocDim@1002 : Record 357;
      SalesLine@1003 : Record 37;
      DimExist@1000000000 : Boolean;
    BEGIN
      TempDocDim.RESET;
      TempDocDim.DELETEALL;
      //A/gob-adb/08.07.13
      //DocDim.SETFILTER("Table ID",'%1|%2',DATABASE::"Sales Header",DATABASE::"Sales Line");
      DocDim.SETRANGE("Table ID",DATABASE::"Sales Header");
      //E/gob-adb/08.07.13
      DocDim.SETRANGE("Document Type",SalesHeader."Document Type");
      DocDim.SETRANGE("Document No.",SalesHeader."No.");
      IF DocDim.FIND('-') THEN BEGIN
        REPEAT
          TempDocDim.INIT;
          TempDocDim := DocDim;
          TempDocDim.INSERT;
        UNTIL DocDim.NEXT = 0;
      //A/gob-adb/08.07.13
        DimExist := TRUE;
      END;

      DocDim.SETRANGE("Table ID",DATABASE::"Sales Line");
      IF DocDim.FIND('-') THEN BEGIN
        REPEAT
          TempDocDim.INIT;
          TempDocDim := DocDim;
          TempDocDim.INSERT;
        UNTIL DocDim.NEXT = 0;
        DimExist := TRUE;
      END;

      IF DimExist THEN BEGIN
      //E/gob-adb/08.07.13
        TempDocDim.SETRANGE("Line No.",0);
        CheckDimComb(TempDocDim,0,SalesHeader);
      END;

      SalesLine."Line No." := 0;
      CheckDimValuePosting(TempDocDim,SalesHeader,SalesLine);

      SalesLine.SETRANGE("Document Type",SalesHeader."Document Type");
      SalesLine.SETRANGE("Document No.",SalesHeader."No.");
      SalesLine.SETFILTER(Type,'<>%1',SalesLine.Type::" ");
      IF SalesLine.FIND('-') THEN
        REPEAT
          TempDocDim.SETRANGE("Line No.",SalesLine."Line No.");
          CheckDimComb(TempDocDim,SalesLine."Line No.",SalesHeader);
          CheckDimValuePosting(TempDocDim,SalesHeader,SalesLine);
        UNTIL SalesLine.NEXT = 0;
      TempDocDim.RESET;
    END;

    PROCEDURE ApplyFilter@20(SalesHeader@1000 : Record 36;DocumentType@1001 : 'Invoice,Credit Memo,Statistic';VAR SalesLine@1002 : Record 37);
    BEGIN
      WITH SalesLine DO BEGIN
        RESET;
        SETRANGE("Document Type",SalesHeader."Document Type");
        SETRANGE("Document No.",SalesHeader."No.");
        SETFILTER(Type,'<>%1',Type::" ");
        IF DocumentType IN [DocumentType::Invoice,DocumentType::Statistic] THEN
          SETFILTER("Prepmt. Line Amount",'<>0')
        ELSE
          SETFILTER("Prepmt. Amt. Inv.",'<>0');
      END;
    END;

    PROCEDURE PrepmtAmount@12(SalesLine@1000 : Record 37;DocumentType@1001 : 'Invoice,Credit Memo,Statistic') : Decimal;
    BEGIN
      WITH SalesLine DO BEGIN
        CASE DocumentType OF
          DocumentType::Statistic:
            EXIT("Prepmt. Line Amount");
          DocumentType::Invoice:
            EXIT("Prepmt. Line Amount" - "Prepmt. Amt. Inv.");
          ELSE
            EXIT("Prepmt. Amt. Inv." - "Prepmt Amt Deducted");
        END;
      END;
    END;

    LOCAL PROCEDURE CheckDimComb@30(VAR TempDocDim@1003 : Record 357;LineNo@1000 : Integer;SalesHeader@1001 : Record 36);
    VAR
      DimMgt@1002 : Codeunit 408;
    BEGIN
      IF NOT DimMgt.CheckDocDimComb(TempDocDim) THEN BEGIN
        IF LineNo = 0 THEN
          ERROR(
            Text007,
            SalesHeader."Document Type",SalesHeader."No.",DimMgt.GetDimCombErr);
        ERROR(
          Text008,
          SalesHeader."Document Type",SalesHeader."No.",LineNo,DimMgt.GetDimCombErr);
      END;
    END;

    LOCAL PROCEDURE CheckDimValuePosting@28(VAR TempDocDim@1001 : Record 357;SalesHeader@1004 : Record 36;VAR SalesLine@1000 : Record 37);
    VAR
      DimMgt@1005 : Codeunit 408;
      TableIDArr@1002 : ARRAY [10] OF Integer;
      NumberArr@1003 : ARRAY [10] OF Code[20];
    BEGIN
      IF SalesLine."Line No." = 0 THEN BEGIN
        TableIDArr[1] := DATABASE::Customer;
        NumberArr[1] := SalesHeader."Bill-to Customer No.";
        TableIDArr[2] := DATABASE::Job;
        // NumberArr[2] := SalesHeader."Job No.";
        TableIDArr[3] := DATABASE::"Salesperson/Purchaser";
        NumberArr[3] := SalesHeader."Salesperson Code";
        TableIDArr[4] := DATABASE::Campaign;
        NumberArr[4] := SalesHeader."Campaign No.";
        TableIDArr[5] := DATABASE::"Responsibility Center";
        NumberArr[5] := SalesHeader."Responsibility Center";
        IF NOT DimMgt.CheckDocDimValuePosting(TempDocDim,TableIDArr,NumberArr) THEN
          ERROR(
            Text009,
            SalesHeader."Document Type",SalesHeader."No.",DimMgt.GetDimValuePostingErr);
      END ELSE BEGIN
        TableIDArr[1] := DimMgt.TypeToTableID3(SalesLine.Type);
        NumberArr[1] := SalesLine."No.";
        TableIDArr[2] := DATABASE::Job;
        NumberArr[2] := SalesLine."Job No.";
        IF NOT DimMgt.CheckDocDimValuePosting(TempDocDim,TableIDArr,NumberArr) THEN
          ERROR(
            Text010,
            SalesHeader."Document Type",SalesHeader."No.",SalesLine."Line No.",DimMgt.GetDimValuePostingErr);
      END;
    END;

    LOCAL PROCEDURE RunGenJnlPostLine@23(VAR GenJnlLine@1000 : Record 81;DimEntryNo@1001 : Integer);
    VAR
      TempDimBuf@1002 : TEMPORARY Record 360;
      TempJnlLineDim@1003 : TEMPORARY Record 356;
      DimMgt@1005 : Codeunit 408;
    BEGIN
      TempDimBuf.INIT;
      TempJnlLineDim.INIT;
      DimBufMgt.GetDimensions(DimEntryNo,TempDimBuf);
      DimMgt.CopyDimBufToJnlLineDim(
        TempDimBuf,TempJnlLineDim,GenJnlLine."Journal Template Name",
        GenJnlLine."Journal Batch Name",GenJnlLine."Line No.");
      GenJnlPostLine.RunWithCheck(GenJnlLine,TempJnlLineDim);
    END;

    PROCEDURE UpdatePrepmtAmountOnSaleslines@13(SalesHeader@1001 : Record 36;NewTotalPrepmtAmount@1000 : Decimal);
    VAR
      Currency@1004 : Record 4;
      SalesLine@1002 : Record 37;
      ChangeLogMgt@1005 : Codeunit 423;
      RecRef@1007 : RecordRef;
      xRecRef@1006 : RecordRef;
      TotalLineAmount@1003 : Decimal;
      TotalPrepmtAmount@1008 : Decimal;
      TotalPrepmtAmtInv@1010 : Decimal;
      LastLineNo@1009 : Integer;
    BEGIN
      IF SalesHeader."Currency Code" = '' THEN
        Currency.InitRoundingPrecision
      ELSE
        Currency.GET(SalesHeader."Currency Code");

      WITH SalesLine DO BEGIN
        SETRANGE("Document Type",SalesHeader."Document Type");
        SETRANGE("Document No.",SalesHeader."No.");
        SETFILTER(Type,'<>%1',Type::" ");
        SETFILTER("Line Amount",'<>0');
        SETFILTER("Prepayment %",'<>0');
        //A/gob-adb/15.05.13
        //LOCKTABLE;
        //E/gob-adb/15.05.13
        IF FIND('-') THEN
          REPEAT
            TotalLineAmount := TotalLineAmount + "Line Amount";
            TotalPrepmtAmtInv := TotalPrepmtAmtInv + "Prepmt. Amt. Inv.";
            LastLineNo := "Line No.";
          UNTIL NEXT = 0
        ELSE
          ERROR(Text017,FIELDCAPTION("Prepayment %"));
        IF TotalLineAmount = 0 THEN
          ERROR(Text013,NewTotalPrepmtAmount);
        IF NOT (NewTotalPrepmtAmount IN [TotalPrepmtAmtInv ..TotalLineAmount]) THEN
          ERROR(Text016,TotalPrepmtAmtInv,TotalLineAmount);
        IF FIND('-') THEN
          REPEAT
            xRecRef.GETTABLE(SalesLine);
            IF "Line No." <> LastLineNo THEN
              VALIDATE(
                "Prepmt. Line Amount",
                ROUND(
                  NewTotalPrepmtAmount * "Line Amount" / TotalLineAmount,
                  Currency."Amount Rounding Precision"))
            ELSE
              VALIDATE("Prepmt. Line Amount",NewTotalPrepmtAmount - TotalPrepmtAmount);
            TotalPrepmtAmount := TotalPrepmtAmount + "Prepmt. Line Amount";
            MODIFY;
            RecRef.GETTABLE(SalesLine);
            ChangeLogMgt.LogModification(RecRef,xRecRef);
          UNTIL NEXT = 0;
      END;
    END;

    PROCEDURE GetDimBuf@14(DimEntryNo@1001 : Integer;VAR ToDocDim@1002 : Record 357);
    VAR
      TempDimBuf@1000 : TEMPORARY Record 360;
      DimMgt@1003 : Codeunit 408;
    BEGIN
      ToDocDim.RESET;
      ToDocDim.DELETEALL;
      TempDimBuf.INIT;
      DimBufMgt.GetDimensions(DimEntryNo,TempDimBuf);
      DimMgt.CopyDimBufToDocDim(TempDimBuf,0,'',0,ToDocDim)
    END;

    LOCAL PROCEDURE CreateDimensions@26(VAR SalesLine@1009 : Record 37;VAR DocDim@1000 : Record 357);
    VAR
      SourceCodeSetup@1006 : Record 242;
      DimMgt@1010 : Codeunit 408;
      TableID@1007 : ARRAY [10] OF Integer;
      No@1008 : ARRAY [10] OF Code[20];
    BEGIN
      SourceCodeSetup.GET;
      TableID[1] := DATABASE::"G/L Account";
      No[1] := SalesLine."No.";
      TableID[2] := DATABASE::Job;
      No[2] := SalesLine."Job No.";
      TableID[3] := DATABASE::"Responsibility Center";
      No[3] := SalesLine."Responsibility Center";
      SalesLine."Shortcut Dimension 1 Code" := '';
      SalesLine."Shortcut Dimension 2 Code" := '';
      DimMgt.GetPreviousDocDefaultDim(
        DATABASE::"Sales Header",SalesLine."Document Type",SalesLine."Document No.",0,
        DATABASE::Customer,SalesLine."Shortcut Dimension 1 Code",SalesLine."Shortcut Dimension 2 Code");
      DimMgt.GetDefaultDim(
        TableID,No,SourceCodeSetup.Sales,
        SalesLine."Shortcut Dimension 1 Code",SalesLine."Shortcut Dimension 2 Code");
      DimMgt.ExtractDocDefaultDim(
        DATABASE::"Sales Line",SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.",DocDim)
    END;

    LOCAL PROCEDURE InsertInDimBuffer@18(VAR DocDim@1001 : Record 357;SalesLine@1002 : Record 37) : Integer;
    VAR
      TempDimBuf@1003 : TEMPORARY Record 360;
      EntryNo@1000 : Integer;
    BEGIN
      WITH DocDim DO BEGIN
        RESET;
        SETRANGE("Table ID",DATABASE::"Sales Line");
        SETRANGE("Document Type",SalesLine."Document Type");
        SETRANGE("Document No.",SalesLine."Document No.");
        SETRANGE("Line No.",SalesLine."Line No.");
        IF FIND('-') THEN BEGIN
          TempDimBuf.INIT;
          REPEAT
            TempDimBuf."Table ID" := "Table ID";
            TempDimBuf."Dimension Code" := "Dimension Code";
            TempDimBuf."Dimension Value Code" := "Dimension Value Code";
            TempDimBuf.INSERT;
          UNTIL NEXT = 0;
        END;
        RESET;
        EntryNo := DimBufMgt.FindDimensions(TempDimBuf);
        IF EntryNo = 0 THEN
          EntryNo := DimBufMgt.InsertDimensions(TempDimBuf);

        EXIT(EntryNo);
      END;
    END;

    LOCAL PROCEDURE PrepmtDocTypeToDocType@21(DocumentType@1000 : 'Invoice,Credit Memo') : Integer;
    BEGIN
      CASE DocumentType OF
        DocumentType::Invoice:
          EXIT(2);
        DocumentType::"Credit Memo":
          EXIT(3);
      END;
          EXIT(2);
    END;

    PROCEDURE GetSalesLinesToDeduct@24(SalesHeader@1000 : Record 36;VAR SalesLines@1002 : Record 37);
    VAR
      SalesLine@1001 : Record 37;
    BEGIN
      ApplyFilter(SalesHeader,1,SalesLine);
      IF SalesLine.FINDSET THEN
        REPEAT
          IF (PrepmtAmount(SalesLine,0) <> 0) AND (PrepmtAmount(SalesLine,1) <> 0) THEN BEGIN
            SalesLines := SalesLine;
            SalesLines.INSERT;
          END;
        UNTIL SalesLine.NEXT = 0;
    END;

    PROCEDURE RealizeGainLoss@27(VAR GenJnlLine@1000 : Record 81;SalesLine@1001 : Record 37);
    VAR
      Currency@1003 : Record 4;
    BEGIN
      IF (SalesLine."Gen. Bus. Posting Group" <> GenPostingSetup."Gen. Bus. Posting Group") OR
         (SalesLine."Gen. Prod. Posting Group" <> GenPostingSetup."Gen. Prod. Posting Group")
      THEN
        GenPostingSetup.GET(SalesLine."Gen. Bus. Posting Group",SalesLine."Gen. Prod. Posting Group");
      GenPostingSetup.TESTFIELD("Sales Prepayments Account");

      GenJnlLine."Account Type" := GenJnlLine."Account Type"::"G/L Account";
      GenJnlLine."Account No." := GenPostingSetup."Sales Prepayments Account";
      GenJnlLine."System-Created Entry" := TRUE;
      GenJnlLine.Amount := SalesLine."Prepmt. Amount Inv. (LCY)";
      Currency.GET(SalesLine."Currency Code");
      GenJnlLine."Bal. Account Type" := GenJnlLine."Bal. Account Type"::"G/L Account";
      IF GenJnlLine.Amount > 0 THEN  BEGIN
        Currency.TESTFIELD("Realized Gains Acc.");
        GenJnlLine."Bal. Account No." := Currency."Realized Gains Acc.";
      END ELSE BEGIN
        Currency.TESTFIELD("Realized Losses Acc.");
        GenJnlLine."Bal. Account No." := Currency."Realized Losses Acc.";
      END;
    END;

    PROCEDURE PrepmtVATDiffAmount@37(SalesLine@1000 : Record 37;DocumentType@1001 : 'Invoice,Credit Memo,Statistic') : Decimal;
    BEGIN
      WITH SalesLine DO BEGIN
        CASE DocumentType OF
          DocumentType::Statistic:
            EXIT("Prepayment VAT Difference");
          DocumentType::Invoice:
            EXIT("Prepayment VAT Difference");
          ELSE
            EXIT("Prepmt VAT Diff. to Deduct");
        END;
      END;
    END;

    PROCEDURE "***gobFunction***"@1108200000();
    BEGIN
    END;

    PROCEDURE CheckOpenPrepaymentInv@1108200001(CustNo@1108200000 : Code[20];PrepaymentNo@1108200001 : Code[20]) ApplPrepaymet : Boolean;
    VAR
      CustLedgEntr@1108200002 : Record 21;
    BEGIN
      ApplPrepaymet := FALSE;
      CustLedgEntr.SETRANGE("Customer No.",CustNo);
      CustLedgEntr.SETRANGE("Document Type",CustLedgEntr."Document Type"::Invoice);
      CustLedgEntr.SETFILTER("Document No.",PrepaymentNo);
      CustLedgEntr.SETRANGE(Prepayment,TRUE);
      CustLedgEntr.SETRANGE(Open,TRUE);

      IF NOT CustLedgEntr.ISEMPTY THEN ApplPrepaymet := TRUE;
    END;

    PROCEDURE AutomAppl@1108200002(VAR SalesHead@1108200000 : Record 36);
    VAR
      CustLedgEntrAdvInv@1108200001 : Record 21;
      CustLedgEntrCrMemo@1108200002 : Record 21;
      CUAutomAppl@1108200003 : Codeunit 50027;
    BEGIN
      IF (SalesHead."Last Prepayment No." = '') OR
         (SalesHead."Last Prepmt. Cr. Memo No." = '') THEN EXIT;

      CustLedgEntrAdvInv.RESET;
      CustLedgEntrAdvInv.SETRANGE("Customer No.",SalesHead."Sell-to Customer No.");
      CustLedgEntrAdvInv.SETRANGE("Document Type",CustLedgEntrAdvInv."Document Type"::Invoice);
      CustLedgEntrAdvInv.SETFILTER("Document No.",SalesHead."Last Prepayment No.");
      CustLedgEntrAdvInv.SETRANGE(Prepayment,TRUE);
      CustLedgEntrAdvInv.SETRANGE(Open,TRUE);

      IF NOT CustLedgEntrAdvInv.FINDLAST THEN EXIT;

      CustLedgEntrCrMemo.RESET;
      CustLedgEntrCrMemo.SETRANGE("Customer No.",SalesHead."Sell-to Customer No.");
      CustLedgEntrCrMemo.SETRANGE("Document Type",CustLedgEntrAdvInv."Document Type"::"Credit Memo");
      CustLedgEntrCrMemo.SETFILTER("Document No.",SalesHead."Last Prepmt. Cr. Memo No.");
      CustLedgEntrCrMemo.SETRANGE(Prepayment,TRUE);
      CustLedgEntrCrMemo.SETRANGE(Open,TRUE);

      IF NOT CustLedgEntrCrMemo.FINDLAST THEN EXIT;

      //Test
      //MESSAGE('%1',CustLedgEntrAdvInv."Document No.");

      CustLedgEntrAdvInv."Applies-to ID" := 'VZAUSGL';
      CustLedgEntrAdvInv.CALCFIELDS("Remaining Amount");
      CustLedgEntrAdvInv."Amount to Apply" := CustLedgEntrAdvInv."Remaining Amount";
      CODEUNIT.RUN(CODEUNIT::"Cust. Entry-Edit",CustLedgEntrAdvInv);

      CustLedgEntrCrMemo."Applies-to ID" := 'VZAUSGL';
      CustLedgEntrCrMemo.CALCFIELDS("Remaining Amount");
      CustLedgEntrCrMemo."Amount to Apply" := CustLedgEntrCrMemo."Remaining Amount";
      CODEUNIT.RUN(CODEUNIT::"Cust. Entry-Edit",CustLedgEntrCrMemo);

      CUAutomAppl.RUN(CustLedgEntrAdvInv);
      CUAutomAppl.RUN(CustLedgEntrCrMemo);
    END;

    PROCEDURE CalculateVAT@1000000003(VAR SalesHeader@1000000001 : Record 36;GOBSalesLine1@1000000000 : Record 37;DocumentType@1000000002 : 'Invoice,Credit Memo,Statistic');
    VAR
      PrevVatAmountLine@1007 : Record 290;
      Currency@1004 : Record 4;
      SalesTaxCalculate@1005 : Codeunit 398;
      NewAmount@1002 : Decimal;
      NewPrepmtVATDiffAmt@1010 : Decimal;
    BEGIN
      //A/gob-ko/P0226/230812

      IF SalesHeader."Currency Code" = '' THEN
        Currency.InitRoundingPrecision
      ELSE
        Currency.GET(SalesHeader."Currency Code");

      TempVATAmount.DELETEALL;


        //ApplyFilter(SalesHeader,DocumentType,GOBSalesLine);
        GOBSalesLine.SETRANGE(GOBSalesLine."Document No.",SalesHeader."No.");
        GOBSalesLine.SETRANGE("Document Type",GOBSalesLine."Document Type"::Order);
        GOBSalesLine.SETFILTER(GOBSalesLine."Line No.",'<>%1',GOBSalesLine1."Line No.");
        //GOBSalesLine.SETFILTER(GOBSalesLine."VAT %",'<>0');
        IF GOBSalesLine.FIND('-') THEN
          REPEAT
            NewAmount := PrepmtAmount(GOBSalesLine,DocumentType);
            IF NewAmount <> 0 THEN BEGIN
              IF DocumentType = DocumentType::Invoice THEN
                NewAmount := GOBSalesLine."Prepmt. Line Amount";
              IF GOBSalesLine."Prepmt. VAT Calc. Type" IN
                 [GOBSalesLine."VAT Calculation Type"::"Reverse Charge VAT",GOBSalesLine."VAT Calculation Type"::"Sales Tax"]
              THEN
                GOBSalesLine."VAT %" := 0;
              IF NOT TempVATAmount.GET(
                   GOBSalesLine."Prepayment VAT Identifier",
                   GOBSalesLine."Prepmt. VAT Calc. Type",GOBSalesLine."Prepayment Tax Group Code",
                   FALSE,NewAmount >= 0)
              THEN BEGIN
                TempVATAmount.INIT;
                TempVATAmount."VAT Identifier" := GOBSalesLine."Prepayment VAT Identifier";
                TempVATAmount."VAT Calculation Type" := GOBSalesLine."Prepmt. VAT Calc. Type";
                TempVATAmount."Tax Group Code" := GOBSalesLine."Prepayment Tax Group Code";
                TempVATAmount."VAT %" := GOBSalesLine."Prepayment VAT %";
                TempVATAmount.Modified := TRUE;
                TempVATAmount.Positive := NewAmount >= 0;
                TempVATAmount."Includes Prepayment" := TRUE;
                TempVATAmount.INSERT;
              END;
              TempVATAmount."Line Amount" := TempVATAmount."Line Amount" + NewAmount;
              NewPrepmtVATDiffAmt := PrepmtVATDiffAmount(GOBSalesLine,DocumentType);
              IF DocumentType = DocumentType::Invoice THEN
                NewPrepmtVATDiffAmt := GOBSalesLine."Prepayment VAT Difference" + GOBSalesLine."Prepmt VAT Diff. to Deduct" +
                  GOBSalesLine."Prepmt VAT Diff. Deducted";
              TempVATAmount."VAT Difference" := TempVATAmount."VAT Difference" + NewPrepmtVATDiffAmt;
              TempVATAmount.MODIFY;
            END;
          UNTIL GOBSalesLine.NEXT = 0;


      WITH TempVATAmount DO
        IF FIND('-') THEN
          REPEAT
            IF (PrevVatAmountLine."VAT Identifier" <> "VAT Identifier") OR
               (PrevVatAmountLine."VAT Calculation Type" <> "VAT Calculation Type") OR
               (PrevVatAmountLine."Tax Group Code" <> "Tax Group Code") OR
               (PrevVatAmountLine."Use Tax" <> "Use Tax")
            THEN
              PrevVatAmountLine.INIT;
            IF SalesHeader."Prices Including VAT" THEN BEGIN
              CASE "VAT Calculation Type" OF
                "VAT Calculation Type"::"Normal VAT",
                "VAT Calculation Type"::"Reverse Charge VAT":
                  BEGIN
                    "VAT Base" :=
                      ROUND(
                        ("Line Amount" - "Invoice Discount Amount") / (1 + "VAT %" / 100),
                        Currency."Amount Rounding Precision") - "VAT Difference";
                    "VAT Amount" :=
                      "VAT Difference" +
                      ROUND(
                        PrevVatAmountLine."VAT Amount" +
                        ("Line Amount" - "VAT Base" - "VAT Difference") *
                        (1 - SalesHeader."VAT Base Discount %" / 100),
                        Currency."Amount Rounding Precision",Currency.VATRoundingDirection);
                    "Amount Including VAT" := "VAT Base" + "VAT Amount";
                    IF Positive THEN
                      PrevVatAmountLine.INIT
                    ELSE BEGIN
                      PrevVatAmountLine := TempVATAmount;
                      PrevVatAmountLine."VAT Amount" :=
                        ("Line Amount" - "VAT Base" - "VAT Difference") *
                        (1 - SalesHeader."VAT Base Discount %" / 100);
                      PrevVatAmountLine."VAT Amount" :=
                        PrevVatAmountLine."VAT Amount" -
                        ROUND(PrevVatAmountLine."VAT Amount",Currency."Amount Rounding Precision",Currency.VATRoundingDirection);
                    END;
                  END;
                "VAT Calculation Type"::"Sales Tax":
                  BEGIN
                    "Amount Including VAT" := "Line Amount" - "Invoice Discount Amount";
                    "VAT Base" :=
                      ROUND(
                        SalesTaxCalculate.ReverseCalculateTax(
                          SalesHeader."Tax Area Code","Tax Group Code",SalesHeader."Tax Liable",
                          SalesHeader."Posting Date","Amount Including VAT",Quantity,SalesHeader."Currency Factor"),
                        Currency."Amount Rounding Precision");
                    "VAT Amount" := "VAT Difference" + "Amount Including VAT" - "VAT Base";
                    IF "VAT Base" = 0 THEN
                      "VAT %" := 0
                    ELSE
                      "VAT %" := ROUND(100 * "VAT Amount" / "VAT Base",0.00001);
                  END;
              END;
            END ELSE BEGIN
              CASE "VAT Calculation Type" OF
                "VAT Calculation Type"::"Normal VAT",
                "VAT Calculation Type"::"Reverse Charge VAT":
                  BEGIN
                    "VAT Base" := "Line Amount" - "Invoice Discount Amount";
                    "VAT Amount" :=
                      "VAT Difference" +
                      ROUND(
                        PrevVatAmountLine."VAT Amount" +
                        "VAT Base" * "VAT %" / 100 * (1 - SalesHeader."VAT Base Discount %" / 100),
                        Currency."Amount Rounding Precision",Currency.VATRoundingDirection);
                    "Amount Including VAT" := "Line Amount" - "Invoice Discount Amount" + "VAT Amount";
                    IF Positive THEN
                      PrevVatAmountLine.INIT
                    ELSE BEGIN
                      PrevVatAmountLine := TempVATAmount;
                      PrevVatAmountLine."VAT Amount" :=
                        "VAT Base" * "VAT %" / 100 * (1 - SalesHeader."VAT Base Discount %" / 100);
                      PrevVatAmountLine."VAT Amount" :=
                        PrevVatAmountLine."VAT Amount" -
                        ROUND(PrevVatAmountLine."VAT Amount",Currency."Amount Rounding Precision",Currency.VATRoundingDirection);
                    END;
                  END;
                "VAT Calculation Type"::"Sales Tax":
                  BEGIN
                    "VAT Base" := "Line Amount" - "Invoice Discount Amount";
                    "VAT Amount" :=
                      SalesTaxCalculate.CalculateTax(
                        SalesHeader."Tax Area Code","Tax Group Code",SalesHeader."Tax Liable",
                        SalesHeader."Posting Date","VAT Base",Quantity,SalesHeader."Currency Factor");
                    IF "VAT Base" = 0 THEN
                      "VAT %" := 0
                    ELSE
                      "VAT %" := ROUND(100 * "VAT Amount" / "VAT Base",0.00001);
                    "VAT Amount" :=
                      "VAT Difference" +
                      ROUND("VAT Amount",Currency."Amount Rounding Precision",Currency.VATRoundingDirection);
                    "Amount Including VAT" := "VAT Base" + "VAT Amount";
                  END;
              END;
            END;
            "Calculated VAT Amount" := "VAT Amount" - "VAT Difference";
            MODIFY;
          UNTIL NEXT = 0;
      TotalAmount := 0;
      TotalAmountVAT := 0;
      TotalAmountinclVat := 0;
      IF TempVATAmount.FINDFIRST THEN BEGIN
         REPEAT
         TotalAmount := TotalAmount + TempVATAmount."VAT Base";
         TotalAmountVAT := TotalAmountVAT + TempVATAmount."VAT Amount";
         TotalAmountinclVat := TotalAmountinclVat + TempVATAmount."Amount Including VAT";
         UNTIL TempVATAmount.NEXT = 0;
      END;
    END;

    PROCEDURE SetCallFromRelease@1000000001(p_CallFromRelease@1000000000 : Boolean);
    BEGIN
      //S/P1223
      CallFromRelease := p_CallFromRelease;
      //E/P1223
    END;

    BEGIN
    {
      1.00  27.10.11  eich - allow prepayment on lines with quantity < 0
      2.00  16.11.11  eich - useable for NAS
      3.00  30.01.12  eich - insert "Payment Method Code"
      4.00  06.02.12  eich - post commission for groupon

      +----------------------------------------------+
      | Copyright GOB Software & Systeme             |
      +----------------------------------------------+
      | FP Commerce                                  |
      |                                              |
      +----------------------------------------------+

      Version    Datum       Berater    PSP-Code   Bemerkung
      ---------------------------------------------------------------------------
      V1.00      10.05.12    gob-jvi               Automatischer Ausgleich der Vorauszahlungsrechnung mit Gutschrift
      V1.01      14.05.12    gob-ko                Anpassung Groupon-Buchung
      P0022      13.06.12    gob-mno               Neuer Funktionsaufruf fÅr Kommissionierhacken im Auftrag
      P0042      26.06.12    gob-rste              New Code autom. Cancel
      P0041      17.07.12    gob-rste              Check for Picking Interruption
      P0052      02.07.12    gob-ko                Automatischer Ausgleich bei Geschenkgutschein
      P0053      03.07.12    gob-ko                Automatischer Ausgleich bei MP2 Gutschrift
      P0185      14.08.12    gob-ko                automatic application for invoice and Credit Memo
      P0226      23.08.12    gob-ko                Anpassung Grouopon/Geschenkgutschein fÅr anteilige Steuer
      P0277      04.09.12    gob-rste              New Code for Cancel without interfaces
      P0313      12.09.12    gob-rste              New Code for Autom. Cancel Orders, Check COmment
      P0318      13.09.12    gob-rste              Check Test Comment
      P0329      14.09.12    gob-rste              Set First Pick
      P0414      05.10.12    gob-rste              Autom. Cancel Testorders
      P0549      31.10.12    gob-ko                Anpassung Groupon-Buchung
      P0914      15.05.13    gob-adb               Performance
      P0966      30.07.13    gob-rste              Fill Interface Process Log
      P1223      12.03.14    gob-rste              Avoid double Rhenus Triggering On Release Sales Order

      (c) gbedv, OPplus, All rights reserved

      No.  Date       changed
      -----------------------------------------------------
      PMT  14.04.11   OPplus Payment
      -----------------------------------------------------

      +--------------------------------------------+
      |                                            |
      |                  Home24                    |
      |       Internal Customizing by NAV-Team     |
      |                                            |
      +--------------------------------------------+

      Project No. Date     Shortcut  Description
      _____________________________________________
      H1408       05.08.14 DMA       Copy RHD Interface, rename and implement as Whs LF Interface
      H1277       08.10.14 DMA       IPL: Testing /Activation, CODECHANGE

      +--------------------------------------------+
      |                                            |
      |                  Home24                    |
      |     Cooperation Tectura & Home24 NAV Team  |
      |                                            |
      +--------------------------------------------+

      Project No. Date      Shortcut  Description
      _____________________________________________
      T0078       07.01.15  TEC-GH    Ally On Invoice too
    }
    END.
  }
}

