OBJECT Codeunit 50033 EasyLog Import
{
  OBJECT-PROPERTIES
  {
    Date=10.04.15;
    Time=12:00:00;
    Modified=Yes;
    Version List=chrmu,GOB,HME1980;
  }
  PROPERTIES
  {
    TableNo=472;
    OnRun=BEGIN
            // H0730, P0486, P0299, P0583, P0365, P0564, DYN0008  +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
            IF "Parameter String" = 'FIEGE' THEN BEGIN
              ProcessFiegeEntries;
              EXIT;
            END;

            IF "Parameter String" = 'REIMPORT' THEN BEGIN
              ReadFolder2;
              EXIT;
            END;

            IF ("Parameter String" = 'MANUALIMPORT') OR ("Parameter String" = 'MANUALIMPORTNIGHT') THEN BEGIN
              FPCGeneralSetup.GET;
              FPCGeneralSetup.TESTFIELD("Status Transport");
              FPCGeneralSetup.TESTFIELD("Status Pick");
              FPCGeneralSetup.TESTFIELD("Trigger DHL Pro Active");
              IF "Parameter String" = 'MANUALIMPORT' THEN
                ProcessFromImportTable(FPCGeneralSetup."No. Lines per man. DHL Import")
              ELSE
                ProcessFromImportTable(FPCGeneralSetup."No. Lines DHL Import (Night)")
            END ELSE BEGIN
              ProcessErrors := ("Parameter String" <> '');
              ReadFolder;
            END;
            // H0730, P0486, P0299, P0583, P0365, P0564, DYN0008 -------------------------------------------------------------------------------
          END;

  }
  CODE
  {
    VAR
      Interface@1000000003 : Record 50014;
      DHLSetup@1000000002 : Record 50022;
      Text001@1000000004 : TextConst 'ENU=The order %1 doesn''''t exist.';
      Text002@1000000005 : TextConst 'ENU=Process file %1.';
      Text003@1000000006 : TextConst 'ENU=The import is done.';
      Text004@1000000007 : TextConst 'ENU=The sales  order %1 cannot be posted. Fix the problem and post it manually.';
      Text005@1000000001 : TextConst 'ENU=The sales order %1 was posted.';
      Text006@1000000000 : TextConst 'ENU=Cannot download from FTP. Check FTP credentials.';
      RhenusSetup@1000000013 : Record 50012;
      FPCGeneralSetup@1000000019 : Record 50055;
      FileName@1000000008 : Text[1024];
      ErrorMessage@1000000009 : Text[250];
      Text007@1000000014 : TextConst 'ENU=The status for the sales order %1 was updated.';
      Text008@1000000015 : TextConst 'DEU=Der Auftrag hat Zeilen mit negativer Restauftragsmenge. Bitte kontrollieren Sie den Auftrag %1.;ENU=The sales order has negative Outstanding Quantity. Please check order %1.';
      Text010@1000000020 : TextConst 'ENU=Please check the base quantities of sales order %1 line %2!';
      Text011@1000000026 : TextConst 'ENU=Importation failed!';
      NotRHELocationCode@1000000012 : TextConst 'ENU=DIREKT';
      SpedPurchCode@1000000010 : TextConst 'ENU=SPED-LAG';
      ProcessErrors@1000000011 : Boolean;
      UseSOArchive@1000000016 : Boolean;
      Counter@1000000017 : Integer;
      Text009@1000000018 : TextConst 'ENU=The status for the return order %1 was updated.';
      Kanal1und2@1000000021 : TextConst 'ENU=GER-1|GER-2|FRA-1|FRA-2|NL-1|NL-2';
      p_HowToHandleStatusDescription@1000000023 : ' ,Fill Parcel Status Description,See Comments';
      ShippingAgent@1000000024 : Code[10];
      CUParcelStatusHistoryMgmt@1000000025 : Codeunit 80011;

    PROCEDURE ReadFolder@1000000000();
    VAR
      FileRec@1000000000 : Record 2000000022;
    BEGIN
      DHLSetup.GET;
      RhenusSetup.GET;

      Interface.GET('EASYLOG');
      IF Interface."Use FTP" THEN
        FTPDownload;

      ProcessIntTable;

      FileRec.RESET;
      FileRec.SETRANGE(Path,Interface."Import Folder");
      FileRec.SETRANGE("Is a file",TRUE);
      // A/gob-lku/29.08.2012/P0246
      //IF FileRec.FINDSET THEN
      IF FileRec.FINDSET THEN BEGIN
      // E/gob-lku/29.08.2012/P0246
        REPEAT
          FileName := Interface."Import Folder" + FileRec.Name;
          ReadFile;
          IF FILE.RENAME(Interface."Import Folder" + FileRec.Name, Interface."Archive Root Folder" + FileRec.Name) THEN
            ;
        UNTIL FileRec.NEXT = 0;
        InsertLogEntry('', Text003, 0, FALSE, FALSE);
      // A/gob-lku/29.08.2012/P0246
      END;

      // A/gob-lku/07.09.12/P0299
      {
      Interface.GET('EASYLOG2');
      IF Interface."Use FTP" THEN FTPDownload;

      ProcessIntTable;

      FileRec.RESET;
      FileRec.SETRANGE(Path,Interface."Import Folder");
      FileRec.SETRANGE("Is a file",TRUE);
      IF FileRec.FINDSET THEN BEGIN
        REPEAT
          FileName := Interface."Import Folder" + FileRec.Name;
          ReadFile2;
          IF FILE.RENAME(Interface."Import Folder" + FileRec.Name,
                  Interface."Archive Root Folder" + FileRec.Name) THEN;
        UNTIL FileRec.NEXT = 0;
        InsertLogEntry('',Text003, 0, FALSE, FALSE);
      END;
      // E/gob-lku/29.08.2012/P0246
      }
      // E/gob-lku/07.09.12/P0299
    END;

    PROCEDURE ReadFolder2@1000000028();
    VAR
      FileRec@1000000000 : Record 2000000022;
    BEGIN
      // A/gob-lku/23.10.12/P0486

      DHLSetup.GET;
      RhenusSetup.GET;

      Interface.GET('EASYLOG2');

      ProcessIntTable;

      FileRec.RESET;
      FileRec.SETRANGE(Path,Interface."Import Folder");
      FileRec.SETRANGE("Is a file",TRUE);
      IF FileRec.FINDSET THEN BEGIN
        REPEAT
          FileName := Interface."Import Folder" + FileRec.Name;
          ReadFile3;
          IF FILE.RENAME(Interface."Import Folder" + FileRec.Name,
                  Interface."Archive Root Folder" + FileRec.Name) THEN;
        UNTIL FileRec.NEXT = 0;
        InsertLogEntry('',Text003, 0, FALSE, FALSE);
      END;
      // E/gob-lku/23.10.12/P0486
    END;

    PROCEDURE ReadFile@1000000001();
    VAR
      ELFile@1000000000 : File;
      NewLine@1000000003 : Text[1024];
      ImportDHLProactive@1000000001 : Record 50097;
    BEGIN
      ELFile.TEXTMODE(TRUE);
      InsertLogEntry('',STRSUBSTNO(Text002, FileName), 0, FALSE, TRUE);
      IF ELFile.OPEN(FileName) THEN BEGIN
        ELFile.READ(NewLine);

        // A/gob-lku/08.11.2012/P0566
        IF ImportDHLProactive.FINDLAST THEN;
        Counter := ImportDHLProactive."Entry No." + 1;
        // E/gob-lku/08.11.2012/P0566

        REPEAT
          ELFile.READ(NewLine);
          ProcessLine(NewLine);

          // A/gob-lku/08.11.2012/P0566
          Counter += 1;
          // E/gob-lku/08.11.2012/P0566

        UNTIL (ELFile.POS = ELFile.LEN);
      END;
    END;

    PROCEDURE ReadFile2@1000000007();
    VAR
      ELFile@1000000001 : File;
      NewLine@1000000000 : Text[1024];
      ImportDHLProactive@1000000002 : Record 50097;
      Dia@1000000003 : Dialog;
    BEGIN
      // A/gob-lku/29.08.2012/P0246
      ELFile.TEXTMODE(TRUE);
      InsertLogEntry('',STRSUBSTNO(Text002, FileName), 0, FALSE, TRUE);
      IF ELFile.OPEN(FileName) THEN BEGIN
      //H0550 09.09.13 ARI ++++++++++++++++++++++++++++++++++++++++++++++++
      {
      //H0550 09.09.13 ARI ------------------------------------------------
        Dia.OPEN('Aktuelle Zeile #1#######');
      //H0550 09.09.13 ARI ++++++++++++++++++++++++++++++++++++++++++++++++
      }
        IF GUIALLOWED THEN
          Dia.OPEN('Aktuelle Zeile #1#######');
      //H0550 09.09.13 ARI ------------------------------------------------

        ELFile.READ(NewLine);
        // A/gob-lku/07.09.12/P0299
        IF ImportDHLProactive.FINDLAST THEN;
        Counter := ImportDHLProactive."Entry No." + 1;
        // E/gob-lku/07.09.12/P0299
        REPEAT
          ELFile.READ(NewLine);
          ProcessLine2(NewLine);
          // A/gob-lku/07.09.12/P0299
      //H0550 09.09.13 ARI ++++++++++++++++++++++++++++++++++++++++++++++++
          IF GUIALLOWED THEN BEGIN
      //H0550 09.09.13 ARI ------------------------------------------------
            Counter += 1;
            Dia.UPDATE(1,Counter);
          // E/gob-lku/07.09.12/P0299
      //H0550 09.09.13 ARI ++++++++++++++++++++++++++++++++++++++++++++++++
          END;
      //H0550 09.09.13 ARI ------------------------------------------------

        UNTIL (ELFile.POS = ELFile.LEN);
      //H0550 09.09.13 ARI ++++++++++++++++++++++++++++++++++++++++++++++++
        IF GUIALLOWED THEN
      //H0550 09.09.13 ARI ------------------------------------------------
          Dia.CLOSE;
      END;
      // E/gob-lku/29.08.2012/P0246
    END;

    PROCEDURE ReadFile3@1000000012();
    VAR
      ELFile@1000000001 : File;
      NewLine@1000000000 : Text[1024];
      ImportDHLProactive@1000000002 : Record 50097;
      Dia@1000000003 : Dialog;
    BEGIN
      // A/gob-lku/23.10.12/P0486
      ELFile.TEXTMODE(TRUE);
      InsertLogEntry('',STRSUBSTNO(Text002, FileName), 0, FALSE, TRUE);
      IF ELFile.OPEN(FileName) THEN BEGIN

        ELFile.READ(NewLine);
        IF ImportDHLProactive.FINDLAST THEN;
        Counter := ImportDHLProactive."Entry No." + 1;
        REPEAT
          ELFile.READ(NewLine);
          ProcessLine3(NewLine);
          Counter += 1;
        UNTIL (ELFile.POS = ELFile.LEN);
      END;
      // E/gob-lku/23.10.12/P0486
    END;

    PROCEDURE ProcessLine@1000000003(TextLine@1000000000 : Text[1024]);
    VAR
      SO@1000000009 : Record 36;
      SOLine@1000000005 : Record 37;
      SOLog@1000000010 : Record 50001;
      SalesPost@1000000016 : Codeunit 80;
      DeliveryDate@1000000004 : Text[10];
      CommitDate@1000000011 : Text[10];
      SONo@1000000007 : Code[40];
      EventCode@1000000003 : Code[10];
      RICCode@1000000002 : Code[10];
      AccNo@1000000008 : Text[40];
      DHLShipment@1000000012 : Text[50];
      EmpfName@1000000001 : Text[250];
      TimeStamp@1000000013 : Text[30];
      i@1000000017 : Integer;
      intVar@1000000014 : Integer;
      PLZ@1000000015 : Text[10];
    BEGIN
      i := 1;

      WHILE (STRPOS(TextLine,';') <> 0) AND (i <> 27) DO BEGIN
        // A/gob-lku/20.12.2012/P0709
        IF COPYSTR(TextLine,1,STRPOS(TextLine,';') - 1) = 'Einlieferdatum' THEN
          i := 27;
        // E/gob-lku/20.12.2012/P0709
        IF i = 1 THEN
          AccNo := COPYSTR(TextLine,1,STRPOS(TextLine,';') - 1);
        IF i = 4 THEN
          TimeStamp := COPYSTR(TextLine,1,STRPOS(TextLine,';') - 1);
        IF i = 9 THEN
          DHLShipment := COPYSTR(TextLine,1,STRPOS(TextLine,';') - 1);
        IF i = 10 THEN
          CommitDate := COPYSTR(TextLine,1,STRPOS(TextLine,';') - 1);
        IF i = 11 THEN
          DeliveryDate := COPYSTR(TextLine,1,STRPOS(TextLine,';') - 1);
        IF i = 13 THEN
          EventCode := COPYSTR(TextLine,1,STRPOS(TextLine,';') - 1);
        // A/gob-lku/11.12.2012/P0661
        //IF i = 14 THEN
        IF i = 14 THEN BEGIN
        // E/gob-lku/11.12.2012/P0661
          RICCode := COPYSTR(TextLine,1,STRPOS(TextLine,';') - 1);
          // A/gob-lku/11.12.2012/P0661
          IF DeliveryDate = '' THEN
            IF ((EventCode IN ['CNRFC','DLVRD','DLVRF','HLDCC','HNDDE','HNDND','OFWRD'])
            OR ((EventCode = 'NTDEL') AND (RICCode IN ['CNCNR','CPUNK','MOVED','NHOME','NTCCN','NTORD','OTHER']))
            OR ((EventCode = 'RETRN') AND (RICCode IN ['CNCNR','NTCCN','NTORD']))) THEN
              DeliveryDate := COPYSTR(TimeStamp,1,4) + COPYSTR(TimeStamp,6,2) + COPYSTR(TimeStamp,9,2); // Delivery Date
        END;
        // E/gob-lku/11.12.2012/P0661
        IF i = 18 THEN BEGIN
          SONo := COPYSTR(TextLine,1,STRPOS(TextLine,';') - 1);
          WHILE STRPOS(SONo,' ') <> 0 DO
            SONo := COPYSTR(SONo,STRPOS(SONo,' ') + 1);
          IF STRPOS(SONo,'_') <> 0  THEN BEGIN
            IF EVALUATE(intVar,COPYSTR(SONo,1,STRPOS(SONo,'_') - 1)) THEN
              SONo := COPYSTR(SONo,1,STRPOS(SONo,'_') - 1)
            ELSE BEGIN

              // A/gob-lku/24.10.2012/P0486
              //SONo := COPYSTR(SONo,STRPOS(SONo,'_') + 1);
              SONo := COPYSTR(SONo,1,STRPOS(SONo,'_') - 1);
              // E/gob-lku/24.10.2012/P0486

              IF STRPOS(SONo,'_') <> 0  THEN BEGIN
                IF EVALUATE(intVar,COPYSTR(SONo,1,STRPOS(SONo,'_') - 1)) THEN
                  SONo := COPYSTR(SONo,1,STRPOS(SONo,'_') - 1)
                ELSE
                  SONo := COPYSTR(SONo,STRPOS(SONo,'_') + 1);
              END;
            END;
          END;

        // A/gob-lku/08.11.2012/P0566
        END;
        IF i = 26 THEN BEGIN
          PLZ := COPYSTR(TextLine,1,5);
          IF PLZ = '00000' THEN
            PLZ := '';
          //IF NOT Process(SONo,DHLShipment,AccNo,EventCode,RICCode,DeliveryDate,CommitDate,TimeStamp,0) THEN;
          FillImportTable(SONo,DHLShipment,AccNo,EventCode,RICCode,DeliveryDate,CommitDate,TimeStamp,PLZ,TRUE);
        // E/gob-lku/08.11.2012/P0566

        END;
        TextLine := COPYSTR(TextLine,STRPOS(TextLine,';') + 1);
        i := i + 1;
      END;
    END;

    PROCEDURE ProcessLine2@1000000008(TextLine@1000000000 : Text[1024]);
    VAR
      SO@1000000009 : Record 36;
      SOLine@1000000005 : Record 37;
      SOLog@1000000010 : Record 50001;
      SalesOrderShipmentsDHL@1000000015 : Record 50020;
      SalesPost@1000000016 : Codeunit 80;
      DeliveryDate@1000000004 : Text[10];
      CommitDate@1000000011 : Text[10];
      SONo@1000000007 : Code[40];
      EventCode@1000000003 : Code[10];
      RICCode@1000000002 : Code[10];
      AccNo@1000000008 : Text[40];
      DHLShipment@1000000012 : Text[50];
      EmpfName@1000000001 : Text[250];
      TimeStamp@1000000013 : Text[30];
      i@1000000017 : Integer;
      intVar@1000000014 : Integer;
      PLZ@1000000018 : Text[10];
    BEGIN
      // A/gob-lku/29.08.2012/P0246
      i := 1;

      WHILE (STRPOS(TextLine,';') <> 0) AND (i <> 6) DO BEGIN
        IF i = 1 THEN BEGIN // Piece-Code (Paketnummer)
          DHLShipment := COPYSTR(TextLine,1,STRPOS(TextLine,';') - 1);
          IF SalesOrderShipmentsDHL.GET(DHLShipment,'DHL') THEN
            SONo := SalesOrderShipmentsDHL."SO No."; // Sales Order Number
        END;
        IF i = 2 THEN // Erfassungszeitpunkt
          TimeStamp := COPYSTR(TextLine,1,STRPOS(TextLine,';') - 1);
        IF i = 4 THEN BEGIN // Status Event
          EventCode := COPYSTR(TextLine,1,STRPOS(TextLine,';') - 1);
          IF EventCode = 'DLVRD' THEN
            DeliveryDate := COPYSTR(TimeStamp,1,4) + COPYSTR(TimeStamp,6,2) + COPYSTR(TimeStamp,9,2); // Delivery Date
        END;
        IF i = 5 THEN BEGIN // Status RIC
          RICCode := COPYSTR(TextLine,1,STRPOS(TextLine,';') - 1);

          // A/gob-lku/07.09.12/P0299
          FillImportTable(SONo,DHLShipment,AccNo,EventCode,RICCode,DeliveryDate,CommitDate,TimeStamp,PLZ,FALSE);
          // E/gob-lku/07.09.12/P0299
          //IF NOT Process(SONo,DHLShipment,AccNo,EventCode,RICCode,DeliveryDate,CommitDate,TimeStamp,0) THEN;

        END;
        TextLine := COPYSTR(TextLine,STRPOS(TextLine,';') + 1);
        i := i + 1;
      END;
      // E/gob-lku/29.08.2012/P0246
    END;

    PROCEDURE ProcessLine3@1000000017(TextLine@1000000000 : Text[1024]);
    VAR
      SO@1000000009 : Record 36;
      SOLine@1000000005 : Record 37;
      SOLog@1000000010 : Record 50001;
      SalesOrderShipmentsDHL@1000000015 : Record 50020;
      SalesPost@1000000016 : Codeunit 80;
      DeliveryDate@1000000004 : Text[10];
      CommitDate@1000000011 : Text[10];
      SONo@1000000007 : Code[40];
      EventCode@1000000003 : Code[10];
      RICCode@1000000002 : Code[10];
      AccNo@1000000008 : Text[40];
      DHLShipment@1000000012 : Text[50];
      EmpfName@1000000001 : Text[250];
      TimeStamp@1000000013 : Text[30];
      i@1000000017 : Integer;
      intVar@1000000014 : Integer;
      PLZ@1000000018 : Text[10];
    BEGIN
      // A/gob-lku/23.10.12/P0486
      i := 1;

      WHILE (STRPOS(TextLine,';') <> 0) AND (i <> 27) DO BEGIN
        IF i = 1 THEN
          AccNo := COPYSTR(TextLine,1,STRPOS(TextLine,';') - 1);
        IF i = 4 THEN
          TimeStamp := COPYSTR(TextLine,1,STRPOS(TextLine,';') - 1);
        IF i = 9 THEN
          DHLShipment := COPYSTR(TextLine,1,STRPOS(TextLine,';') - 1);
        IF i = 10 THEN
          CommitDate := COPYSTR(TextLine,1,STRPOS(TextLine,';') - 1);
        IF i = 11 THEN
          DeliveryDate := COPYSTR(TextLine,1,STRPOS(TextLine,';') - 1);
        IF i = 13 THEN
          EventCode := COPYSTR(TextLine,1,STRPOS(TextLine,';') - 1);
        // A/gob-lku/11.12.2012/P0661
        //IF i = 14 THEN
        IF i = 14 THEN BEGIN
        // E/gob-lku/11.12.2012/P0661
          RICCode := COPYSTR(TextLine,1,STRPOS(TextLine,';') - 1);
          // A/gob-lku/11.12.2012/P0661
          IF DeliveryDate = '' THEN
            IF ((EventCode IN ['CNRFC','DLVRD','DLVRF','HLDCC','HNDDE','HNDND','OFWRD'])
            OR ((EventCode = 'NTDEL') AND (RICCode IN ['CNCNR','CPUNK','MOVED','NHOME','NTCCN','NTORD','OTHER']))
            OR ((EventCode = 'RETRN') AND (RICCode IN ['CNCNR','NTCCN','NTORD']))) THEN
              DeliveryDate := COPYSTR(TimeStamp,1,4) + COPYSTR(TimeStamp,6,2) + COPYSTR(TimeStamp,9,2); // Delivery Date
        END;
        // E/gob-lku/11.12.2012/P0661
        IF i = 18 THEN BEGIN
          SONo := COPYSTR(TextLine,1,STRPOS(TextLine,';') - 1);
          WHILE STRPOS(SONo,' ') <> 0 DO
            SONo := COPYSTR(SONo,STRPOS(SONo,' ') + 1);
          IF STRPOS(SONo,'_') <> 0  THEN BEGIN
            IF EVALUATE(intVar,COPYSTR(SONo,1,STRPOS(SONo,'_') - 1)) THEN
              SONo := COPYSTR(SONo,1,STRPOS(SONo,'_') - 1)
            ELSE BEGIN
              SONo := COPYSTR(SONo,1,STRPOS(SONo,'_') - 1);
              IF STRPOS(SONo,'_') <> 0  THEN BEGIN
                IF EVALUATE(intVar,COPYSTR(SONo,1,STRPOS(SONo,'_') - 1)) THEN
                  SONo := COPYSTR(SONo,1,STRPOS(SONo,'_') - 1)
                ELSE
                  SONo := COPYSTR(SONo,STRPOS(SONo,'_') + 1);
              END;
            END;
          END;

        // A/gob-lku/08.11.2012/P0566
        END;
        IF i = 26 THEN BEGIN
          PLZ := COPYSTR(TextLine,1,5);
          IF PLZ = '00000' THEN
            PLZ := '';
          //FillImportTable(SONo,DHLShipment,AccNo,EventCode,RICCode,DeliveryDate,CommitDate,TimeStamp);
          FillImportTable(SONo,DHLShipment,AccNo,EventCode,RICCode,DeliveryDate,CommitDate,TimeStamp,PLZ,FALSE);
        // E/gob-lku/08.11.2012/P0566

        END;
        TextLine := COPYSTR(TextLine,STRPOS(TextLine,';') + 1);
        i := i + 1;
      END;
      // E/gob-lku/23.10.12/P0486
    END;

    PROCEDURE FillIntTable@1000000004(SONo@1000000007 : Code[40];DHLShipment@1000000003 : Text[50];AccNo@1000000004 : Text[40];EventCode@1000000006 : Code[10];RICCode@1000000005 : Code[10];DeliveryDate@1000000009 : Text[10];CommitDate@1000000008 : Text[10];TimeStamp@1000000010 : Text[30]) : Integer;
    VAR
      ImpDoc@1000000001 : Record 50034;
      ImpDocLine@1000000000 : Record 50035;
      ParcelStatusDHL@1000000002 : Record 50021;
      ParcelStatusHistory@1000000012 : Record 80013;
      UseNewParcelHistory@1000000011 : Boolean;
    BEGIN
      {
      ImpDoc.SETRANGE(ImpDoc."Document No.",SONo);
      ImpDoc.SETRANGE(ImpDoc."Error Message",ErrorMessage);
      IF ImpDoc.FINDFIRST THEN EXIT(ImpDoc."Entry No.");
      }

      //S/P1133
      FPCGeneralSetup.GET;
      UseNewParcelHistory :=
        FPCGeneralSetup."Active Parcel Status History" IN
          [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
          FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"];
      //E/P1133

      ImpDoc.INIT;
      ImpDoc."Entry No." := 0;
      ImpDoc."Creation Date" := CURRENTDATETIME;
      ImpDoc."File Name" := FileName;
      ImpDoc.Interface := Interface.Code;
      ImpDoc."Document No." := SONo;
      ImpDoc.Imported := TRUE;
      ImpDoc.Error := TRUE;
      ImpDoc."Error Message" := ErrorMessage;
      ImpDoc.INSERT;

      ImpDocLine.INIT;
      ImpDocLine."Entry No." := ImpDoc."Entry No.";
      ImpDocLine."Line No" := 10000;
      //S/P1133
      IF NOT UseNewParcelHistory THEN
        ImpDocLine.Description := ParcelStatusDHL.FIELDCAPTION("DHL Shipment Code")
      ELSE
        ImpDocLine.Description := ParcelStatusHistory.FIELDCAPTION("Tracking Code");
      //E/P1133
      ImpDocLine.StartPos := 1;
      ImpDocLine."Field Value" := DHLShipment;
      ImpDocLine.Error := TRUE;
      ImpDocLine."Error Message" := ErrorMessage;
      ImpDocLine.INSERT;

      ImpDocLine.INIT;
      ImpDocLine."Entry No." := ImpDoc."Entry No.";
      ImpDocLine."Line No" := 20000;
      //S/P1133
      IF NOT UseNewParcelHistory THEN
        ImpDocLine.Description := ParcelStatusDHL.FIELDCAPTION("Account Number")
      ELSE
        ImpDocLine.Description := ParcelStatusHistory.FIELDCAPTION("Account No.");
      //E/P1133
      ImpDocLine.StartPos := 2;
      ImpDocLine."Field Value" := AccNo;
      ImpDocLine.INSERT;

      ImpDocLine.INIT;
      ImpDocLine."Entry No." := ImpDoc."Entry No.";
      ImpDocLine."Line No" := 30000;
      //S/P1133
      IF NOT UseNewParcelHistory THEN
        ImpDocLine.Description := ParcelStatusDHL.FIELDCAPTION("Document No.")
      ELSE
        ImpDocLine.Description := ParcelStatusHistory.FIELDCAPTION("Document No.");
      //E/P1133
      ImpDocLine.StartPos := 3;
      ImpDocLine."Field Value" := SONo;
      ImpDocLine.INSERT;

      ImpDocLine.INIT;
      ImpDocLine."Entry No." := ImpDoc."Entry No.";
      ImpDocLine."Line No" := 40000;
      //S/P1133
      IF NOT UseNewParcelHistory THEN
        ImpDocLine.Description := ParcelStatusDHL.FIELDCAPTION("Commit at Date")
      ELSE
        ImpDocLine.Description := ParcelStatusHistory.FIELDCAPTION("Date Commit");
      //E/P1133
      ImpDocLine.StartPos := 4;
      ImpDocLine."Field Value" := CommitDate;
      ImpDocLine.INSERT;

      ImpDocLine.INIT;
      ImpDocLine."Entry No." := ImpDoc."Entry No.";
      ImpDocLine."Line No" := 50000;
      //S/P1133
      IF NOT UseNewParcelHistory THEN
        ImpDocLine.Description := ParcelStatusDHL.FIELDCAPTION("Delivery Date")
      ELSE
        ImpDocLine.Description := ParcelStatusHistory.FIELDCAPTION("Date Delivery");
      //E/P1133
      ImpDocLine.StartPos := 5;
      ImpDocLine."Field Value" := DeliveryDate;
      ImpDocLine.INSERT;

      ImpDocLine.INIT;
      ImpDocLine."Entry No." := ImpDoc."Entry No.";
      ImpDocLine."Line No" := 60000;
      //S/P1133
      IF NOT UseNewParcelHistory THEN
        ImpDocLine.Description := ParcelStatusDHL.FIELDCAPTION("Status Event")
      ELSE
        ImpDocLine.Description := ParcelStatusHistory.FIELDCAPTION("Status Code");
      //E/P1133
      ImpDocLine.StartPos := 6;
      ImpDocLine."Field Value" := EventCode;
      ImpDocLine.INSERT;

      ImpDocLine.INIT;
      ImpDocLine."Entry No." := ImpDoc."Entry No.";
      ImpDocLine."Line No" := 70000;
      //S/P1133
      IF NOT UseNewParcelHistory THEN
        ImpDocLine.Description := ParcelStatusDHL.FIELDCAPTION("Status Code")
      ELSE
        ImpDocLine.Description := ParcelStatusHistory.FIELDCAPTION("Status Sub Code");
      //E/P1133
      ImpDocLine.StartPos := 7;
      ImpDocLine."Field Value" := RICCode;
      ImpDocLine.INSERT;

      ImpDocLine.INIT;
      ImpDocLine."Entry No." := ImpDoc."Entry No.";
      ImpDocLine."Line No" := 80000;
      //S/P1133
      IF NOT UseNewParcelHistory THEN
        ImpDocLine.Description := ParcelStatusDHL.FIELDCAPTION("Time Stamp")
      ELSE
        ImpDocLine.Description := ParcelStatusHistory.FIELDCAPTION("Timestamp Insert");
      //E/P1133
      ImpDocLine.StartPos := 8;
      ImpDocLine."Field Value" := TimeStamp;
      ImpDocLine.INSERT;

      EXIT(ImpDoc."Entry No.");
    END;

    PROCEDURE Process@1000000002(SONo@1000000023 : Code[40];DHLShipment@1000000019 : Text[50];AccNo@1000000020 : Text[40];EventCode@1000000022 : Code[10];RICCode@1000000021 : Code[10];DeliveryDate@1000000018 : Text[10];CommitDate@1000000000 : Text[10];TimeStamp@1000000001 : Text[30];ProcEntry@1000000002 : Integer;PLZ@1000000037 : Text[10]) : Boolean;
    VAR
      SO@1000000009 : Record 36;
      SOLine@1000000005 : Record 37;
      SOLog@1000000010 : Record 50001;
      ParcelStatusDHL@1000000006 : Record 50021;
      Purchasing@1000000012 : Record 5721;
      SalesPost@1000000016 : Codeunit 80;
      IFExportMgt@1000000004 : Codeunit 50010;
      timeS@1000000003 : DateTime;
      dayVar@1000000013 : Integer;
      monthVar@1000000014 : Integer;
      yearVar@1000000015 : Integer;
      timeVar@1000000007 : Time;
      dateVar@1000000008 : Date;
      SONo1@1000000011 : Code[40];
      RHEPurchCode@1000000017 : Text[250];
      SalesLineLoc@1000000024 : Record 37;
      DHLParcelsStatusHistory@1000000025 : Record 50021;
      SalesHeaderLoc@1000000026 : Record 36;
      DHLPostingDate@1000000027 : Date;
      PostChannel@1000000028 : Boolean;
      SOHeaderArchive@1000000030 : Record 5107;
      SOLineArchive@1000000029 : Record 5108;
      OrderFound@1000000031 : Boolean;
      ReturnOrderLine@1000000032 : Record 37;
      Item_l@1000000033 : Record 27;
      Filter_l@1000000034 : Text[1024];
      NewDHLStatusLine@1000000035 : Boolean;
      DHLStatus@1000000036 : Record 50028;
      FPCMgt@1000000038 : Codeunit 50003;
      FPCGeneralSetup@1000000039 : Record 50055;
      InterfaceProcessMgt@1000000040 : Codeunit 50087;
      LineToPost@1000000041 : Boolean;
      NoNext@1000000042 : Boolean;
      ParcelStatusHistory@1000000043 : Record 80013;
      ParcelStatusHistoryArchive@1000000047 : Record 50187;
      RecRef@1000000045 : RecordRef;
      DateCommit@1000000044 : Date;
      DateDelivery@1000000046 : Date;
      FoundLineNo@1000000048 : Integer;
      GoOn@1000000049 : Boolean;
      UsedInterdace@1000000050 : Integer;
      BatchSalesPostHeaderL@1000000051 : Record 50225;
      "*** HME **********************"@1000000052 : Integer;
      ParcelStatusHistoryL@1000000053 : Record 80013;
      ParcelStatusHistoryArchiveL@1000000054 : Record 50187;
      FieldRefL@1000000055 : FieldRef;
    BEGIN
      //S/P1133
      FPCGeneralSetup.GET;
      //E/P1133

      ErrorMessage := '';
      // A/gob-lku/06.09.12/P0287
      UseSOArchive := FALSE;
      // E/gob-lku/06.09.12/P0287
      // 23.07.12 nas >>>
      //A/gob-rste/03.08.12/P0133
      //IF SONo = '' THEN EXIT(TRUE);
      IF SONo <> '' THEN BEGIN
      //E/gob-rste/03.08.12/P0133
      // 23.07.12 nas <<<

        // A/gob-lku/17.12.2012/P0683
        IF STRLEN(SONo) > MAXSTRLEN(SO."No.") THEN
          SONo := COPYSTR(SONo,1,MAXSTRLEN(SO."No."));
        // E/gob-lku/17.12.2012/P0683

        //100712  chrmu look for the order no in the sales lines >>>>
        SOLine.RESET;

        IF SO.GET(SO."Document Type"::Order,SONo) THEN BEGIN
          SOLine.SETRANGE("Document Type",SOLine."Document Type"::Order);
          SOLine.SETRANGE("Document No.",SONo);
        END ELSE BEGIN
          // 23.07.12 nas >>>
          // A/gob-lku/18.09.12/P0334
          IF STRLEN(SONo) > 3 THEN
            SONo1 := COPYSTR(SONo,1,STRLEN(SONo) - 3);
          // E/gob-lku/18.09.12/P0334
          IF SO.GET(SO."Document Type"::Order,SONo1) THEN BEGIN
            SONo := SONo1;
            SOLine.SETRANGE("Document Type",SOLine."Document Type"::Order);
            SOLine.SETRANGE("Document No.",SONo);
          END ELSE BEGIN
          // 23.07.12 nas <<<<
            SOLine.RESET;
            //A/gob-adb/16.05.13
            SOLine.SETCURRENTKEY("Dropship No.");
            //E/gob-adb/16.05.13
            SOLine.SETRANGE("Dropship No.",SONo);
            IF SOLine.FINDFIRST THEN BEGIN
              SONo := SOLine."Document No.";
              SO.GET(SOLine."Document Type",SOLine."Document No.");
              // 23.07.12 nas >>>
              SOLine.SETRANGE("Document Type",SOLine."Document Type"::Order);
              SOLine.SETRANGE("Document No.",SONo);
              // 23.07.12 nas <<<<
            END ELSE BEGIN
            // A/gob-lku/05.09.12/P0287
              SOHeaderArchive.SETRANGE("Document Type",SOHeaderArchive."Document Type"::Order);
              SOHeaderArchive.SETRANGE("No.",SONo);
              IF SOHeaderArchive.FINDFIRST THEN BEGIN
                SOLineArchive.SETRANGE("Document Type",SOLineArchive."Document Type"::Order);
                SOLineArchive.SETRANGE("Document No.",SONo);
                UseSOArchive := TRUE;
              END ELSE BEGIN
            // E/gob-lku/05.09.12/P0287

              // A/gob-lku/10.10.12/P0425
                SOHeaderArchive.SETRANGE("Document Type",SOHeaderArchive."Document Type"::Order);
                SOHeaderArchive.SETRANGE("No.",SONo1);
                IF SOHeaderArchive.FINDFIRST THEN BEGIN
                  SONo := SONo1;
                  SOLineArchive.SETRANGE("Document Type",SOLineArchive."Document Type"::Order);
                  SOLineArchive.SETRANGE("Document No.",SONo);
                  UseSOArchive := TRUE;
                END ELSE BEGIN
                  SOLineArchive.RESET;
                  //A/gob-adb/16.05.13
                  SOLineArchive.SETCURRENTKEY("Dropship No.");
                  //E/gob-adb/16.05.13
                  SOLineArchive.SETRANGE("Dropship No.",SONo);
                  IF SOLineArchive.FINDFIRST THEN BEGIN
                    SONo := SOLineArchive."Document No.";
                    // A/gob-lku/13.11.2012/P0579
                    //SOHeaderArchive.GET(SOLineArchive."Document Type",SOLineArchive."Document No.",
                    //          SOLineArchive."Doc. No. Occurrence",SOLineArchive."Version No.");
                    IF NOT SOHeaderArchive.GET(SOLineArchive."Document Type",SOLineArchive."Document No.",
                              SOLineArchive."Doc. No. Occurrence",SOLineArchive."Version No.") THEN
                      EXIT(FALSE);
                    // E/gob-lku/13.11.2012/P0579
                    SOLineArchive.SETRANGE("Document Type",SOLineArchive."Document Type"::Order);
                    SOLineArchive.SETRANGE("Document No.",SONo);
                    UseSOArchive := TRUE;
                  END ELSE BEGIN
              // E/gob-lku/10.10.12/P0425

              ErrorMessage := STRSUBSTNO(Text001, SONo);
              IF ProcEntry = 0 THEN
                ProcEntry := FillIntTable(SONo,DHLShipment,AccNo,EventCode,RICCode,DeliveryDate,CommitDate,TimeStamp);
              InsertLogEntry(SONo, ErrorMessage, ProcEntry, TRUE, FALSE);
              // A/gob-lku/08.01.2013/P0726
              //EXIT(TRUE);
              EXIT(FALSE);
              // A/gob-lku/08.01.2013/P0726

              // A/gob-lku/10.10.12/P0425
                  END;
                END;
              // E/gob-lku/10.10.12/P0425
            // A/gob-lku/05.09.12/P0287
              END;
            // E/gob-lku/05.09.12/P0287
            END;
          END;
        END;
        //100712  chrmu look for the order no in the sales lines <<<<

        //100712  chrmu change hardcoded old purch codes to new >>>
        //24.07.12  nas filter by Parcel Channel >>>
        Purchasing.RESET;
        Purchasing.SETRANGE("Parcel Channel",TRUE);
        //S/P1135
        //Only Rhenus Channel for Filter
        FPCGeneralSetup.GET;
        FPCGeneralSetup.TESTFIELD("Interface Code Rhenus");
        Purchasing.SETRANGE("Interface Code",FPCGeneralSetup."Interface Code Rhenus");
        //E/P1135
        IF Purchasing.FINDSET THEN REPEAT
          IF RHEPurchCode = '' THEN
            RHEPurchCode := Purchasing.Code
          ELSE
            RHEPurchCode := RHEPurchCode + '|' + Purchasing.Code ;
        UNTIL Purchasing.NEXT = 0;
        //24.07.12  nas filter by Parcel Channel <<<

        // A/gob-lku/05.09.12/P0287
        IF UseSOArchive THEN BEGIN

          SOLineArchive.SETRANGE(Type,SOLineArchive.Type::Item);

          // A/gob-lku/24.10.2012/P0490
          //S/P1117
          //S/P1133
          CASE FPCGeneralSetup."Active Parcel Status History" OF
            FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old":
              BEGIN
          //E/P1133
                ParcelStatusDHL.RESET;
                //A/P0841
                ParcelStatusDHL.SETCURRENTKEY(
                  "Document No.","Document Line No.","Current Status",
                  "Time Stamp","DHL Shipment Code","Rhenus Entry");
                //E/P0841
                ParcelStatusDHL.SETRANGE("DHL Shipment Code",DHLShipment);
                ParcelStatusDHL.SETRANGE("Document No.",SONo);
                IF ParcelStatusDHL.FINDFIRST THEN BEGIN
          //S/P1133
                  FoundLineNo := ParcelStatusDHL."Document Line No.";
                  GoOn := TRUE;
                END;
              END;
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
            FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History":
              BEGIN
          //E/P1133
                ParcelStatusHistory.RESET;
                ParcelStatusHistory.SETCURRENTKEY("Tracking Code","Piece Code");
                ParcelStatusHistory.SETRANGE("Tracking Code",DHLShipment);
                ParcelStatusHistory.SETRANGE("Document No.",SONo);
                ParcelStatusHistoryArchive.RESET;
                ParcelStatusHistoryArchive.SETCURRENTKEY("Tracking Code","Piece Code");
                ParcelStatusHistoryArchive.SETRANGE("Tracking Code",DHLShipment);
                ParcelStatusHistoryArchive.SETRANGE("Document No.",SONo);
                CLEAR(FoundLineNo);
                IF ParcelStatusHistory.FINDFIRST THEN
                  FoundLineNo := ParcelStatusHistory."Document Line No."
                ELSE
                  IF ParcelStatusHistoryArchive.FINDFIRST THEN
                    FoundLineNo := ParcelStatusHistoryArchive."Document Line No.";
                IF FoundLineNo <> 0 THEN
                  GoOn := TRUE;
              END;
          END;
          IF GoOn THEN BEGIN
          //E/P1133
            SOLineArchive.SETRANGE("Line No.",FoundLineNo);
            IF SOLineArchive.FINDFIRST THEN;
            // S/P1142
            IF ((EventCode IN ['CNRFC','DLVRD','DLVRF','HLDCC','HNDDE','HNDND','OFWRD'])
            OR ((EventCode = 'NTDEL') AND (RICCode IN ['CNCNR','CPUNK','MOVED','NHOME','NTCCN','NTORD','OTHER']))
            OR ((EventCode = 'RETRN') AND (RICCode IN ['CNCNR','NTCCN','NTORD']))) THEN
              CheckOtherArchivedSalesLines(SOLineArchive);
            // E/P1142
          END ELSE BEGIN

          //IF STRPOS(AccNo, RhenusSetup."Rhenus DHL Account No.") = 1 THEN
          RhenusSetup.GET();
          IF STRPOS(AccNo, RhenusSetup."Rhenus DHL Account No.") = 1 THEN BEGIN
          // E/gob-lku/24.10.2012/P0490
            SOLineArchive.SETFILTER("Purchasing Code",RHEPurchCode);
          // A/gob-lku/24.10.2012/P0490
            IF SOLineArchive.FINDSET THEN
              REPEAT
                IF Item_l.GET(SOLineArchive."No.") THEN BEGIN
                  IF (Item_l."Shipping Code" = '1918') OR (SOLineArchive."Purchasing Code" = 'GER-2')
                      // A/gob-lku/08.01.2013/P0726
                      OR (SOLineArchive."Purchasing Code" = 'AT-2')
                      // E/gob-lku/08.01.2013/P0726
                      OR (SOLineArchive."Purchasing Code" = 'FRA-2') OR (SOLineArchive."Purchasing Code" = 'NL-2') THEN
                    IF Filter_l = '' THEN
                      Filter_l := FORMAT(SOLineArchive."Line No.")
                    ELSE
                      Filter_l += '|' + FORMAT(SOLineArchive."Line No.");
                END;
              UNTIL SOLineArchive.NEXT = 0;
            SOLineArchive.SETFILTER("Line No.",Filter_l);
          //ELSE
          END;
          IF NOT SOLineArchive.FINDFIRST THEN
          // E/gob-lku/24.10.2012/P0490
            SOLineArchive.SETRANGE("Location Code",NotRHELocationCode);
          IF NOT SOLineArchive.FINDFIRST THEN BEGIN
            SOLineArchive.SETRANGE("Purchasing Code",SpedPurchCode);
            SOLineArchive.SETRANGE("Location Code");
          END;
          IF NOT SOLineArchive.FINDFIRST THEN BEGIN
            SOLineArchive.SETRANGE("Purchasing Code");
            SOLineArchive.SETRANGE("Location Code");
          END;
          //100712  chrmu change hardcoded old purch codes to new <<<

          // A/gob-lku/24.10.2012/P0490
          END;
          // E/gob-lku/24.10.2012/P0490

          IF SOLineArchive.FINDSET THEN
            REPEAT
              SOLineArchive."DHL Shipment Number" := DHLShipment;
              SOLineArchive."Status Event Code" := EventCode;
              SOLineArchive."Status Code" := RICCode;
              SOLineArchive.MODIFY;

              //S/P1117
              //S/P1133
              IF FPCGeneralSetup."Active Parcel Status History" IN
                [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
                FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
                FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New"]
              THEN BEGIN
              //E/P1133
              CLEAR(ParcelStatusDHL);
              ParcelStatusDHL.RESET;
              //A/P0841
              ParcelStatusDHL.SETCURRENTKEY(
                "Document No.","Document Line No.","Current Status",
                "Time Stamp","DHL Shipment Code","Rhenus Entry");
              //E/P0841
              ParcelStatusDHL.SETRANGE("DHL Shipment Code",UPPERCASE(DHLShipment));
              //DYN0007  08.08.12  nas  removed filtering by Account No. >>
              //ParcelStatusDHL.SETRANGE("Account Number",AccNo);
              //DYN0007  08.08.12  nas  removed filtering by Account No. <<
              ParcelStatusDHL.SETRANGE("Document Line No.",SOLineArchive."Line No.");
              ParcelStatusDHL.SETRANGE("Document No.",SONo);
              ParcelStatusDHL.SETRANGE("Status Event",EventCode);
              ParcelStatusDHL.SETRANGE("Status Code",RICCode);
              //S/P1133
              END;

              IF FPCGeneralSetup."Active Parcel Status History" IN
                [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
                FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
                FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
              THEN BEGIN
              //E/P1133
                CLEAR(ParcelStatusHistory);
                ParcelStatusHistoryArchive.RESET;
                ParcelStatusHistoryArchive.SETCURRENTKEY("Document No.","Document Line No.","Document Type");
                ParcelStatusHistoryArchive.SETRANGE("Document No.",SONo);
                ParcelStatusHistoryArchive.SETRANGE("Document Line No.",SOLineArchive."Line No.");
                ParcelStatusHistoryArchive.SETRANGE("Document Type",ParcelStatusHistoryArchive."Document Type"::Order);
                ParcelStatusHistoryArchive.SETRANGE("Tracking Code",UPPERCASE(DHLShipment));
                ParcelStatusHistoryArchive.SETRANGE("Status Code",EventCode);
                ParcelStatusHistoryArchive.SETRANGE("Status Sub Code",RICCode);
              //S/P1133
              END;
              //E/P1133
              //E/P1117

              // A/gob-lku/19.09.12/P0353
              dateVar := WORKDATE;
              //19.07.12  nas changed date format >>
              IF STRLEN(TimeStamp) > 13 THEN
                IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                  IF EVALUATE(monthVar,COPYSTR(TimeStamp,6,2))THEN
                    IF EVALUATE(yearVar,COPYSTR(TimeStamp,1,4)) THEN
                      dateVar := DMY2DATE(dayVar,monthVar,yearVar);
              //19.07.12  nas changed date format <<
              IF NOT EVALUATE(timeVar,COPYSTR(TimeStamp,12,8)) THEN
                timeVar := TIME;

              //S/P1117
              //S/P1133
              IF FPCGeneralSetup."Active Parcel Status History" IN
                [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
                FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
                FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New"]
              THEN
              //E/P1133
                // A/gob-lku/26.10.12/P0524
                //ParcelStatusDHL.SETRANGE("Time Stamp",CREATEDATETIME(dateVar,timeVar));
                ParcelStatusDHL.SETRANGE("Time Stamp",ROUNDDATETIME(CREATEDATETIME(dateVar,timeVar),100000,'<')
                    ,ROUNDDATETIME(CREATEDATETIME(dateVar,timeVar),100000,'>'));
                // E/gob-lku/26.10.12/P0524
                // E/gob-lku/19.09.12/P0353
              //S/P1133
              IF FPCGeneralSetup."Active Parcel Status History" IN
                [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
                FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
                FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
              THEN
              //E/P1133
                ParcelStatusHistoryArchive.SETRANGE(
                  "Timestamp Insert",
                  ROUNDDATETIME(CREATEDATETIME(dateVar,timeVar),100000,'<'),
                  ROUNDDATETIME(CREATEDATETIME(dateVar,timeVar),100000,'>'));
                //E/P1117

              //S/P1133
              IF FPCGeneralSetup."Active Parcel Status History" IN
                [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
                FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
                FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New"]
              THEN BEGIN
              //E/P1133
                //A/P0841
                //IF NOT ParcelStatusDHL.FINDFIRST THEN BEGIN
                IF ParcelStatusDHL.ISEMPTY THEN BEGIN
                //E/P0841
                  ParcelStatusDHL."Entry No." := 0;
                  ParcelStatusDHL."DHL Shipment Code" := UPPERCASE(DHLShipment);
                  ParcelStatusDHL."Account Number" := AccNo;
                  ParcelStatusDHL."Document Line No." := SOLineArchive."Line No.";
                  ParcelStatusDHL."Document No." := SONo;
                  ParcelStatusDHL."Document Type" := ParcelStatusDHL."Document Type"::Order;

                  // A/gob-lku/19.09.12/P0353     Vorgelagert fr Filterung nach Time Stamp
                  {
                  dateVar := WORKDATE;
                  //19.07.12  nas changed date format >>
                  IF STRLEN(TimeStamp) > 13 THEN
                    IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                      IF EVALUATE(monthVar,COPYSTR(TimeStamp,6,2))THEN
                        IF EVALUATE(yearVar,COPYSTR(TimeStamp,1,4)) THEN
                          dateVar := DMY2DATE(dayVar,monthVar,yearVar);
                  //19.07.12  nas changed date format <<
                  IF NOT EVALUATE(timeVar,COPYSTR(TimeStamp,12,8)) THEN
                    timeVar := TIME;
                  }
                  // A/gob-lku/19.09.12/P0353     Vorgelagert fr Filterung nach Time Stamp

                  ParcelStatusDHL."Time Stamp" := CREATEDATETIME(dateVar,timeVar);

                  // A/10.10.12/gob-lku/P0429
                  ParcelStatusDHL."Import Time Stamp" := CURRENTDATETIME;
                  ParcelStatusDHL."Time Difference" := ParcelStatusDHL."Time Stamp" - ParcelStatusDHL."Import Time Stamp";
                  ParcelStatusDHL."Status DHL" := TRUE;
                  ParcelStatusDHL."Order Date" := SOHeaderArchive."Order Date";
                  ParcelStatusDHL."Shipment through" := ParcelStatusDHL."Shipment through"::DHL;
                  // E/10.10.12/gob-lku/P0429
                  // S/gob-lku/13.08.2013/P1051
                  ParcelStatusDHL."Shipping Agent" := 'DHL';
                  // E/gob-lku/13.08.2013/P1051

                  ParcelStatusDHL."Current Status" := TRUE;
                  ParcelStatusDHL."Status Event" := EventCode;
                  ParcelStatusDHL."Status Code" := RICCode;

                  IF EVALUATE(dayVar,COPYSTR(CommitDate,7,2)) THEN
                    IF EVALUATE(monthVar,COPYSTR(CommitDate,5,2))THEN
                      IF EVALUATE(yearVar,COPYSTR(CommitDate,1,4)) THEN
                        ParcelStatusDHL."Commit at Date" := DMY2DATE(dayVar,monthVar,yearVar);

                  IF EVALUATE(dayVar,COPYSTR(DeliveryDate,7,2)) THEN
                    IF EVALUATE(monthVar,COPYSTR(DeliveryDate,5,2))THEN
                      IF EVALUATE(yearVar,COPYSTR(DeliveryDate,1,4)) THEN
                        ParcelStatusDHL."Delivery Date" := DMY2DATE(dayVar,monthVar,yearVar);

                  // A/gob-lku/29.10.2012/P0528
                  IF (SOLineArchive."Purchasing Code" = 'GER-9') OR
                     (SOLineArchive."Purchasing Code" = 'NL-9') OR
                     // A/gob-lku/08.01.2013/P0726
                     (SOLineArchive."Purchasing Code" = 'AT-9') OR
                     // E/gob-lku/08.01.2013/P0726
                     (SOLineArchive."Purchasing Code" = 'FRA-9') THEN
                    IF DHLStatus.GET(EventCode,RICCode) THEN
                      ParcelStatusDHL."Docdata Status Description" := DHLStatus."Status Event Name";
                  // E/gob-lku/29.10.2012/P0528

                  // S/gob-lku/13.06.13/P0963
                  IF SOLineArchive."Drop Shipment" THEN BEGIN
                    ParcelStatusDHL."Purchase Order Code" := SOLineArchive."Purchase Order No.";
                    ParcelStatusDHL."PO Line No." := SOLineArchive."Purch. Order Line No.";
                  END;
                  // E/gob-lku/13.06.13/P0963

                  //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
                  {
                  //H0686  04.12.13  MBY  ----------------------------
                  ParcelStatusDHL.INSERT;
                  //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
                  }
                  ParcelStatusDHL.INSERT(TRUE);
                  //H0686  04.12.13  MBY  ----------------------------

                  InsertLogEntry(SONo,STRSUBSTNO(Text007, SOHeaderArchive."No."), ProcEntry, FALSE, FALSE)
                END;
              //S/P1133
              END;

              IF FPCGeneralSetup."Active Parcel Status History" IN
                [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
                FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
                FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
              THEN BEGIN
              //E/P1133
                IF ParcelStatusHistoryArchive.ISEMPTY THEN BEGIN
                  CLEAR(CUParcelStatusHistoryMgmt);
                  RecRef.GETTABLE(SOLineArchive);
                  IF EVALUATE(dayVar,COPYSTR(CommitDate,7,2)) THEN
                    IF EVALUATE(monthVar,COPYSTR(CommitDate,5,2))THEN
                      IF EVALUATE(yearVar,COPYSTR(CommitDate,1,4)) THEN
                        DateCommit := DMY2DATE(dayVar,monthVar,yearVar);
                  IF EVALUATE(dayVar,COPYSTR(DeliveryDate,7,2)) THEN
                    IF EVALUATE(monthVar,COPYSTR(DeliveryDate,5,2))THEN
                      IF EVALUATE(yearVar,COPYSTR(DeliveryDate,1,4)) THEN
                        DateDelivery := DMY2DATE(dayVar,monthVar,yearVar);
                  CUParcelStatusHistoryMgmt.SetDateGlobals(0D,DateDelivery,DateCommit);
                  CUParcelStatusHistoryMgmt.SetAccountNo(AccNo);
                  CUParcelStatusHistoryMgmt.SetDateTimeGlobal(CREATEDATETIME(dateVar,timeVar));
                  CUParcelStatusHistoryMgmt.FillHistoryByDocLine(
                    RecRef,                 // Rec
                    1,                      // p_Command
                    0,                      // p_InfoDirection::  Incoming,Outgoing
                    2,                      // p_UsedInterface::  ,EDI,DHL,DocData,Drop Shipment,Rhenus,UPS
                    'DHL',                  // p_ShippingAgentCode
                    UPPERCASE(DHLShipment), // p_TrackingCode
                    '',                     // p_PieceCode
                    EventCode,              // p_StatusCode
                    RICCode,                // p_StatusRICCode
                    '',                     // p_Comment
                    0);                     // p_HandleStatusDescription
                  //S/P1117/++S+++++++
                  // Activate when code above gets deactivated !!!
                  //InsertLogEntry(SONo,STRSUBSTNO(Text007, SOHeaderArchive."No."), ProcEntry, FALSE, FALSE)
                  //E/P1117/--E-------
                  //S/P1129
                  CUParcelStatusHistoryMgmt.MoveParcelInfosToArchive(
                    1,                              // p_Command::All,SalesDoc,PurchDoc,Date,EntryNo
                    SOLineArchive."Document No.",   // p_DocNo
                    0,                              // p_LineNo
                    SOLineArchive."Document Type",  // p_DocType
                    '',                             // p_DateFilterString
                    0);                             // p_EntryNo
                //E/P1129
                END;
              //S/P1133
              END;
              //E/P1133
              //E/P1117
            UNTIL SOLineArchive.NEXT = 0

        END ELSE BEGIN
        // E/gob-lku/05.09.12/P0287

        SOLine.SETRANGE(Type,SOLine.Type::Item);

        //S/P1133
        CASE FPCGeneralSetup."Active Parcel Status History" OF
          FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
          FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old":
            BEGIN
               CLEAR(GoOn);
               // A/gob-lku/24.10.2012/P0490
               ParcelStatusDHL.RESET;
              //A/gob-adb/16.05.13
              ParcelStatusDHL.SETCURRENTKEY("Document No.");
              //E/gob-adb/16.05.13
              ParcelStatusDHL.SETRANGE("DHL Shipment Code",DHLShipment);
              ParcelStatusDHL.SETRANGE("Document No.",SONo);
              IF ParcelStatusDHL.FINDFIRST THEN BEGIN
                FoundLineNo := ParcelStatusDHL."Document Line No.";
                GoOn := TRUE;
              END;
            END;
          FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
          FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History":
            BEGIN
              CLEAR(GoOn);
              ParcelStatusHistory.RESET;
              //A/gob-adb/16.05.13
              ParcelStatusHistory.SETCURRENTKEY("Tracking Code","Piece Code");
              //E/gob-adb/16.05.13
              ParcelStatusHistory.SETRANGE("Tracking Code",DHLShipment);
              ParcelStatusHistory.SETRANGE("Document No.",SONo);
              IF ParcelStatusHistory.FINDFIRST THEN BEGIN
                FoundLineNo := ParcelStatusHistory."Document Line No.";
                GoOn := TRUE;
              END;
            END;
        END;
        IF GoOn THEN BEGIN
        //E/P1133
          SOLine.SETRANGE("Line No.",FoundLineNo);
          IF SOLine.FINDFIRST THEN;
          // S/P1142
          IF ((EventCode IN ['CNRFC','DLVRD','DLVRF','HLDCC','HNDDE','HNDND','OFWRD'])
          OR ((EventCode = 'NTDEL') AND (RICCode IN ['CNCNR','CPUNK','MOVED','NHOME','NTCCN','NTORD','OTHER']))
          OR ((EventCode = 'RETRN') AND (RICCode IN ['CNCNR','NTCCN','NTORD']))) THEN
            CheckOtherSalesLines(SOLine);
          {
          // E/P1142
          IF (SOLine."Purchasing Code" = 'GER-1') OR (SOLine."Purchasing Code" = 'GER-2')
              OR (SOLine."Purchasing Code" = 'FRA-1') OR (SOLine."Purchasing Code" = 'FRA-2')
              // A/gob-lku/08.01.2013/P0726
              OR (SOLine."Purchasing Code" = 'AT-1') OR (SOLine."Purchasing Code" = 'AT-2')
              // E/gob-lku/08.01.2013/P0726
              OR (SOLine."Purchasing Code" = 'NL-1') OR (SOLine."Purchasing Code" = 'NL-2') THEN BEGIN
            SOLine.SETFILTER("Purchasing Code",Kanal1und2);
            // A/gob-lku/04.12.2012/P0638
            //SOLine.SETRANGE("No.",SOLine."No.");
            SOLine.SETRANGE("Line No.");
            IF SOLine.FINDSET THEN
              REPEAT
                IF Item_l.GET(SOLine."No.") THEN BEGIN
                  IF (Item_l."Shipping Code" = '1918') OR (SOLine."Purchasing Code" = 'GER-2')
                      // A/gob-lku/08.01.2013/P0726
                      OR (SOLine."Purchasing Code" = 'AT-2')
                      // E/gob-lku/08.01.2013/P0726
                      OR (SOLine."Purchasing Code" = 'FRA-2') OR (SOLine."Purchasing Code" = 'NL-2') THEN
                    IF Filter_l = '' THEN
                      Filter_l := FORMAT(SOLine."Line No.")
                    ELSE
                      Filter_l += '|' + FORMAT(SOLine."Line No.");
                END;
              UNTIL SOLine.NEXT = 0;
            SOLine.SETFILTER("Line No.",Filter_l);
            // E/gob-lku/04.12.2012/P0638
          END;
          IF (SOLine."Purchasing Code" = 'GER-7')
              // S/gob-lku/13.06.13/P0963
              OR (SOLine."Purchasing Code" = 'GER-13')
              OR (SOLine."Purchasing Code" = 'FRA-13')
              OR (SOLine."Purchasing Code" = 'NL-13')
              OR (SOLine."Purchasing Code" = 'AT-13')
              // E/gob-lku/13.06.13/P0963
              //A/gob-rste/31.10.12/P0538
              OR (SOLine."Purchasing Code" = 'GER-12')
              OR (SOLine."Purchasing Code" = 'FRA-12')
              OR (SOLine."Purchasing Code" = 'NL-12')
              //E/gob-rste/31.10.12/P0538
              // A/gob-lku/08.01.2013/P0726
              OR (SOLine."Purchasing Code" = 'AT-7')
              OR (SOLine."Purchasing Code" = 'AT-12')
              // E/gob-lku/08.01.2013/P0726
              OR (SOLine."Purchasing Code" = 'FRA-7')
              OR (SOLine."Purchasing Code" = 'NL-7') THEN BEGIN
            SOLine.SETRANGE("Purchasing Code",SOLine."Purchasing Code");
            SOLine.SETRANGE("Vendor No.",SOLine."Vendor No.");
            SOLine.SETRANGE("Line No.");
          END;
          IF (SOLine."Purchasing Code" = 'GER-9')
              OR (SOLine."Purchasing Code" = 'FRA-9')
              // A/gob-lku/08.01.2013/P0726
              OR (SOLine."Purchasing Code" = 'AT-9')
              // E/gob-lku/08.01.2013/P0726
              OR (SOLine."Purchasing Code" = 'NL-9') THEN BEGIN
            SOLine.SETRANGE("Purchasing Code",SOLine."Purchasing Code");
            SOLine.SETRANGE("Line No.");
          END;
          // S/P1142
          }
          // E/P1142
        END ELSE BEGIN

        //IF STRPOS(AccNo, RhenusSetup."Rhenus DHL Account No.") = 1 THEN
        RhenusSetup.GET();
        IF STRPOS(AccNo, RhenusSetup."Rhenus DHL Account No.") = 1 THEN BEGIN
        // E/gob-lku/24.10.2012/P0490
          SOLine.SETFILTER("Purchasing Code",RHEPurchCode);
        // A/gob-lku/24.10.2012/P0490
          IF SOLine.FINDSET THEN
            REPEAT
              IF Item_l.GET(SOLine."No.") THEN BEGIN
                IF (Item_l."Shipping Code" = '1918') OR (SOLine."Purchasing Code" = 'GER-2')
                    // A/gob-lku/08.01.2013/P0726
                    OR (SOLine."Purchasing Code" = 'AT-2')
                    // E/gob-lku/08.01.2013/P0726
                    OR (SOLine."Purchasing Code" = 'FRA-2') OR (SOLine."Purchasing Code" = 'NL-2') THEN
                  IF Filter_l = '' THEN
                    Filter_l := FORMAT(SOLine."Line No.")
                  ELSE
                    Filter_l += '|' + FORMAT(SOLine."Line No.");
              END;
            UNTIL SOLine.NEXT = 0;
          NewDHLStatusLine := TRUE;
          SOLine.SETFILTER("Line No.",Filter_l);
        //ELSE
        END;
        IF NOT SOLine.FINDFIRST THEN
        // E/gob-lku/24.10.2012/P0490

          SOLine.SETRANGE("Location Code",NotRHELocationCode);
        IF NOT SOLine.FINDFIRST THEN BEGIN
          SOLine.SETRANGE("Purchasing Code",SpedPurchCode);
          SOLine.SETRANGE("Location Code");
        END;
        IF NOT SOLine.FINDFIRST THEN BEGIN
          SOLine.SETRANGE("Purchasing Code");
          SOLine.SETRANGE("Location Code");
        END;
        //100712  chrmu change hardcoded old purch codes to new <<<

        // A/gob-lku/24.10.2012/P0490
        END;
        // E/gob-lku/24.10.2012/P0490

        IF SOLine.FINDSET THEN
          REPEAT
            SOLine."DHL Shipment Number" := DHLShipment;
            SOLine."Status Event Code" := EventCode;
            SOLine."Status Code" := RICCode;
            SOLine.MODIFY;
            //A/P0564
            IF (EventCode <> 'DLVRD') AND (SOLine."Purchasing Code" <> '') THEN BEGIN
              CLEAR(InterfaceProcessMgt);
              FPCGeneralSetup.GET;
              FPCGeneralSetup.TESTFIELD("Status Transport");
              FPCGeneralSetup.TESTFIELD("Status Pick");
              IF InterfaceProcessMgt.TriggerActive(FPCGeneralSetup."Trigger DHL Pro Active") THEN
                InterfaceProcessMgt.UpdateProcessLogForInterface(
                  SOLine."Document No.",
                  SOLine."Line No.",
                  InterfaceProcessMgt.GetInterfaceFromPurchCode(SOLine."Purchasing Code"),
                  FPCGeneralSetup."Status Pick",
                  FPCGeneralSetup."Status Transport",
                  FPCGeneralSetup."Trigger DHL Pro Active"
                  );
            END;
            //E/P0564

            //S/P1117
            //S/P1133
            IF FPCGeneralSetup."Active Parcel Status History" IN
              [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New"]
            THEN BEGIN
            //E/P1133
              CLEAR(ParcelStatusDHL);
              ParcelStatusDHL.RESET;
              //A/gob-adb/16.05.13
              ParcelStatusDHL.SETCURRENTKEY("Document No.");
              //E/gob-adb/16.05.13
              ParcelStatusDHL.SETRANGE("DHL Shipment Code",UPPERCASE(DHLShipment));
              //DYN0007  08.08.12  nas  removed filtering by Account No. >>
              //ParcelStatusDHL.SETRANGE("Account Number",AccNo);
              //DYN0007  08.08.12  nas  removed filtering by Account No. <<
              ParcelStatusDHL.SETRANGE("Document Line No.",SOLine."Line No.");
              ParcelStatusDHL.SETRANGE("Document No.",SONo);
              ParcelStatusDHL.SETRANGE("Status Event",EventCode);
              ParcelStatusDHL.SETRANGE("Status Code",RICCode);
            //S/P1133
            END;

            IF FPCGeneralSetup."Active Parcel Status History" IN
              [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
              FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
            THEN BEGIN
            //E/P1133
              CLEAR(ParcelStatusHistory);
              ParcelStatusHistory.RESET;
              ParcelStatusHistory.SETCURRENTKEY("Document No.","Document Line No.","Document Type");
              ParcelStatusHistory.SETRANGE("Document No.",SONo);
              ParcelStatusHistory.SETRANGE("Document Line No.",SOLine."Line No.");
              ParcelStatusHistory.SETRANGE("Document Type",SOLine."Document Type");
              ParcelStatusHistory.SETRANGE("Tracking Code",UPPERCASE(DHLShipment));
              ParcelStatusHistory.SETRANGE("Status Code",EventCode);
              ParcelStatusHistory.SETRANGE("Status Sub Code",RICCode);
            //S/P1133
            END;
            //E/P1133
            //E/P1117

            // A/gob-lku/19.09.12/P0353
            dateVar := WORKDATE;
            //19.07.12  nas changed date format >>
            IF STRLEN(TimeStamp) > 13 THEN
              IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                IF EVALUATE(monthVar,COPYSTR(TimeStamp,6,2))THEN
                  IF EVALUATE(yearVar,COPYSTR(TimeStamp,1,4)) THEN
                    dateVar := DMY2DATE(dayVar,monthVar,yearVar);
            //19.07.12  nas changed date format <<
            IF NOT EVALUATE(timeVar,COPYSTR(TimeStamp,12,8)) THEN
              timeVar := TIME;

            //S/P1117
            //S/P1133
            IF FPCGeneralSetup."Active Parcel Status History" IN
              [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New"]
            THEN
            //E/P1133
              // A/gob-lku/26.10.12/P0524
              //ParcelStatusDHL.SETRANGE("Time Stamp",CREATEDATETIME(dateVar,timeVar));
              ParcelStatusDHL.SETRANGE("Time Stamp",ROUNDDATETIME(CREATEDATETIME(dateVar,timeVar),100000,'<')
                  ,ROUNDDATETIME(CREATEDATETIME(dateVar,timeVar),100000,'>'));
              // E/gob-lku/26.10.12/P0524

            //S/P1133
            IF FPCGeneralSetup."Active Parcel Status History" IN
              [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
              FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
            THEN
            //E/P1133
              ParcelStatusHistory.SETRANGE(
                "Timestamp Insert",
                ROUNDDATETIME(CREATEDATETIME(dateVar,timeVar),100000,'<'),
                ROUNDDATETIME(CREATEDATETIME(dateVar,timeVar),100000,'>'));
            //E/P1117
            // E/gob-lku/19.09.12/P0353

            //S/P1117
            //S/P1133
            IF FPCGeneralSetup."Active Parcel Status History" IN
              [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New"]
            THEN BEGIN
            //E/P1133
              IF NOT ParcelStatusDHL.FINDFIRST THEN BEGIN
                ParcelStatusDHL."Entry No." := 0;
                ParcelStatusDHL."DHL Shipment Code" := UPPERCASE(DHLShipment);
                ParcelStatusDHL."Account Number" := AccNo;
                ParcelStatusDHL."Document Line No." := SOLine."Line No.";
                ParcelStatusDHL."Document No." := SONo;
                ParcelStatusDHL."Document Type" := ParcelStatusDHL."Document Type"::Order;

                // A/gob-lku/19.09.12/P0353     Vorgelagert fr Filterung nach Time Stamp
                {
                dateVar := WORKDATE;
                //19.07.12  nas changed date format >>
                IF STRLEN(TimeStamp) > 13 THEN
                  IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                    IF EVALUATE(monthVar,COPYSTR(TimeStamp,6,2))THEN
                      IF EVALUATE(yearVar,COPYSTR(TimeStamp,1,4)) THEN
                        dateVar := DMY2DATE(dayVar,monthVar,yearVar);
                //19.07.12  nas changed date format <<
                IF NOT EVALUATE(timeVar,COPYSTR(TimeStamp,12,8)) THEN
                  timeVar := TIME;
                }
                // E/gob-lku/19.09.12/P0353     Vorgelagert fr Filterung nach Time Stamp

                ParcelStatusDHL."Time Stamp" := CREATEDATETIME(dateVar,timeVar);

                // A/10.10.12/gob-lku/P0429
                ParcelStatusDHL."Import Time Stamp" := CURRENTDATETIME;
                ParcelStatusDHL."Time Difference" := ParcelStatusDHL."Time Stamp" - ParcelStatusDHL."Import Time Stamp";
                ParcelStatusDHL."Status DHL" := TRUE;
                ParcelStatusDHL."Order Date" := SO."Order Date";
                ParcelStatusDHL."Shipment through" := ParcelStatusDHL."Shipment through"::DHL;
                // E/10.10.12/gob-lku/P0429
                // S/gob-lku/13.08.2013/P1051
                ParcelStatusDHL."Shipping Agent" := 'DHL';
                // E/gob-lku/13.08.2013/P1051

                ParcelStatusDHL."Current Status" := TRUE;
                ParcelStatusDHL."Status Event" := EventCode;
                ParcelStatusDHL."Status Code" := RICCode;

                IF EVALUATE(dayVar,COPYSTR(CommitDate,7,2)) THEN
                  IF EVALUATE(monthVar,COPYSTR(CommitDate,5,2))THEN
                    IF EVALUATE(yearVar,COPYSTR(CommitDate,1,4)) THEN
                      ParcelStatusDHL."Commit at Date" := DMY2DATE(dayVar,monthVar,yearVar);

                IF EVALUATE(dayVar,COPYSTR(DeliveryDate,7,2)) THEN
                  IF EVALUATE(monthVar,COPYSTR(DeliveryDate,5,2))THEN
                    IF EVALUATE(yearVar,COPYSTR(DeliveryDate,1,4)) THEN
                      ParcelStatusDHL."Delivery Date" := DMY2DATE(dayVar,monthVar,yearVar);

                // A/gob-lku/29.10.2012/P0528
                IF (SOLine."Purchasing Code" = 'GER-9') OR
                   (SOLine."Purchasing Code" = 'NL-9') OR
                   // A/gob-lku/08.01.2013/P0726
                   (SOLine."Purchasing Code" = 'AT-9') OR
                   // E/gob-lku/08.01.2013/P0726

                    // A/gob-lku/11.01.2013/P0734
                   //(SOLine."Purchasing Code" = 'FRA-9') THEN
                   (SOLine."Purchasing Code" = 'FRA-9') THEN BEGIN
                    // E/gob-lku/11.01.2013/P0734

                  IF DHLStatus.GET(EventCode,RICCode) THEN
                    ParcelStatusDHL."Docdata Status Description" := DHLStatus."Status Event Name";
                // E/gob-lku/29.10.2012/P0528

                // A/gob-lku/11.01.2013/P0734
                  ParcelStatusDHL."Shipping Agent" := FPCMgt.GetShippingAgentSalesLine(SOLine,'DOCDATA');
                END;
                // E/gob-lku/11.01.2013/P0734

                // S/gob-lku/13.06.13/P0963
                IF SOLine."Drop Shipment" THEN BEGIN
                  ParcelStatusDHL."Purchase Order Code" := SOLine."Purchase Order No.";
                  ParcelStatusDHL."PO Line No." := SOLine."Purch. Order Line No.";
                END;
                // E/gob-lku/13.06.13/P0963

                //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
                {
                //H0686  04.12.13  MBY  ----------------------------
                ParcelStatusDHL.INSERT;
                //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
                }
                ParcelStatusDHL.INSERT(TRUE);
                //H0686  04.12.13  MBY  ----------------------------

                //S/P1133
                IF FPCGeneralSetup."Active Parcel Status History" IN
                  [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
                  FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old"]
                THEN
                //E/P1133
                  InsertLogEntry(SONo,STRSUBSTNO(Text007, SO."No."), ProcEntry, FALSE, FALSE)
              END;
            //S/P1133
            END;

            IF FPCGeneralSetup."Active Parcel Status History" IN
              [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
              FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
            THEN BEGIN
            //E/P1133
              IF ParcelStatusHistory.ISEMPTY THEN BEGIN
                CLEAR(RecRef);
                CLEAR(CUParcelStatusHistoryMgmt);
                CLEAR(DateDelivery);
                CLEAR(DateCommit);
                RecRef.GETTABLE(SOLine);
                // S/P1179
                { ****************
                IF SOLine."Purchasing Code" IN ['GER-9','NL-9','AT-9','FRA-9'] THEN
                  ShippingAgent := FPCMgt.GetShippingAgentSalesLine(SOLine,'DOCDATA')
                ELSE
                  ShippingAgent := 'DHL';
                **************** }

                IF SOLine."Purchasing Code" IN ['GER-9','NL-9','AT-9','FRA-9'] THEN BEGIN
                  ShippingAgent := FPCMgt.GetShippingAgentSalesLine(SOLine,'DOCDATA');
                  UsedInterdace := 3;
                END ELSE BEGIN
                  ShippingAgent := 'DHL';
                  UsedInterdace := 2;
                END;
                // E/P1179
                CUParcelStatusHistoryMgmt.SetAccountNo(AccNo);
                CUParcelStatusHistoryMgmt.SetDateTimeGlobal(CREATEDATETIME(dateVar,timeVar));
                IF EVALUATE(dayVar,COPYSTR(CommitDate,7,2)) THEN
                  IF EVALUATE(monthVar,COPYSTR(CommitDate,5,2))THEN
                    IF EVALUATE(yearVar,COPYSTR(CommitDate,1,4)) THEN
                      DateCommit := DMY2DATE(dayVar,monthVar,yearVar);
                IF EVALUATE(dayVar,COPYSTR(DeliveryDate,7,2)) THEN
                  IF EVALUATE(monthVar,COPYSTR(DeliveryDate,5,2))THEN
                    IF EVALUATE(yearVar,COPYSTR(DeliveryDate,1,4)) THEN
                      DateDelivery := DMY2DATE(dayVar,monthVar,yearVar);
                CUParcelStatusHistoryMgmt.SetDateGlobals(0D,DateDelivery,DateCommit);
                // S/P1179
                { ****************
                CUParcelStatusHistoryMgmt.FillHistoryByDocLine(
                  RecRef,                   // Rec
                  1,                        // p_Command
                  0,                        // p_InfoDirection::  Incoming,Outgoing
                  3,                        // p_UsedInterface::  ,EDI,DHL,DocData,Drop Shipment,Rhenus,UPS
                  ShippingAgent,            // p_ShippingAgentCode
                  UPPERCASE(DHLShipment),   // p_TrackingCode
                  '',                       // p_PieceCode
                  EventCode,                // p_StatusCode
                  RICCode,                  // p_StatusRICCode
                  '',                       // p_Comment
                  0);                       // p_HandleStatusDescription
                **************** }

                CUParcelStatusHistoryMgmt.FillHistoryByDocLine(
                  RecRef,                   // Rec
                  1,                        // p_Command
                  0,                        // p_InfoDirection::  Incoming,Outgoing
                  UsedInterdace,            // p_UsedInterface::  ,EDI,DHL,DocData,Drop Shipment,Rhenus,UPS
                  ShippingAgent,            // p_ShippingAgentCode
                  UPPERCASE(DHLShipment),   // p_TrackingCode
                  '',                       // p_PieceCode
                  EventCode,                // p_StatusCode
                  RICCode,                  // p_StatusRICCode
                  '',                       // p_Comment
                  0);                       // p_HandleStatusDescription
                // E/P1179
              //S/P1133
              END;
              IF FPCGeneralSetup."Active Parcel Status History" IN
                [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
                FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
              THEN
                InsertLogEntry(SONo,STRSUBSTNO(Text007, SO."No."), ProcEntry, FALSE, FALSE)
              //P1133
            END;
            //E/P1117
          UNTIL SOLine.NEXT = 0
        ELSE
          SOLine.INIT;

        // A/gob-lku/05.09.12/P0287
        END;
        // E/gob-lku/05.09.12/P0287

        //12.07.12  nas moved check below >>>
        IF RhenusSetup."STA Import Only 1700XX" AND (STRPOS(SONo,'1700') <> 1) THEN EXIT(TRUE);
        IF RhenusSetup."STA Import Only 1000XX" AND (STRPOS(SONo,'1000') <> 1) THEN EXIT(TRUE);
        // A/gob-lku/18.09.12/P0334
        //IF STRPOS(SO."No.",RhenusSetup."STA Import Filter") <> 1 THEN EXIT(TRUE);
        // E/gob-lku/18.09.12/P0334

        //IF NOT SO.Kommissionierung THEN EXIT(true);
        //12.07.12  nas moved check below <<<

        // A/gob-lku/05.09.12/P0287
        //IF (SO."No." <> '') AND (EventCode = 'DLVRD') AND (SO.Kommissionierung) THEN BEGIN
        // A/gob-lku/10.10.12/P0425
        //IF (SO."No." <> '') AND (EventCode = 'DLVRD') AND (SO.Kommissionierung) AND (NOT UseSOArchive) THEN BEGIN
        // A/gob-lku/11.12.2012/P0661
        //IF (SO."No." <> '') AND (EventCode = 'DLVRD') AND (NOT UseSOArchive) THEN BEGIN
        // H1057  23.04.14  MBY  ++++++++++++++++++++++++++++
        {
        // H1057  23.04.14  MBY  ----------------------------
        IF (SO."No." <> '') AND (NOT UseSOArchive) AND
          ((EventCode IN ['CNRFC','DLVRD','DLVRF','HLDCC','HNDDE','HNDND','OFWRD'])
          OR ((EventCode = 'NTDEL') AND (RICCode IN ['CNCNR','CPUNK','MOVED','NHOME','NTCCN','NTORD','OTHER']))
          OR ((EventCode = 'RETRN') AND (RICCode IN ['CNCNR','NTCCN','NTORD']))) THEN BEGIN
        // E/gob-lku/11.12.2012/P0661
        // E/gob-lku/10.10.12/P0425
        // E/gob-lku/05.09.12/P0287

          //SO.Status := SO.Status::Open;
          //S/P1133
          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old"]
          THEN
          //E/P1133
            IF ParcelStatusDHL."Delivery Date" <> 0D THEN
              SO."Posting Date" := ParcelStatusDHL."Delivery Date";
          //S/P1133
          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
            FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
          THEN
            IF ParcelStatusHistory."Date Delivery" <> 0D THEN
              SO."Posting Date" := ParcelStatusHistory."Date Delivery";
          //E/P1133
          SO.Ship := TRUE;
          SO.Invoice := FALSE;
          SO.MODIFY;

          //100712  chrmu change hardcoded old purch codes to new >>>
          SOLine.RESET;
          SOLine.SETRANGE("Document Type",SOLine."Document Type"::Order);
          SOLine.SETRANGE("Document No.",SONo);
          RhenusSetup.GET();
          AccNo := COPYSTR(AccNo,1,STRLEN(RhenusSetup."Rhenus DHL Account No."));
          // A/gob-lku/30.08.2012/P0259
          //SOLine.MODIFYALL("Qty. to Ship",0);
          IF SOLine.FIND('-') THEN
            REPEAT
            // A/gob-lku/04.09.2012/P0275
              IF SOLine."Outstanding Quantity" < 0 THEN BEGIN
                ErrorMessage := COPYSTR(GETLASTERRORTEXT,1,250);
                IF ProcEntry = 0 THEN
                  ProcEntry := FillIntTable(SONo,DHLShipment,AccNo,EventCode,RICCode,DeliveryDate,CommitDate,TimeStamp);
                InsertLogEntry(SONo,STRSUBSTNO(Text008, SO."No."), ProcEntry, TRUE, FALSE);
                EXIT(FALSE);
              END;
            // E/gob-lku/04.09.2012/P0275

            // A/gob-lku/23.10.2012/P0480
            IF (SOLine."Qty. to Ship (Base)" * SOLine."Quantity (Base)" < 0) OR
               (ABS(SOLine."Qty. to Ship (Base)") > ABS(SOLine."Outstanding Qty. (Base)")) OR
               (SOLine."Quantity (Base)" * SOLine."Outstanding Qty. (Base)" < 0)
            THEN BEGIN
              ErrorMessage := COPYSTR(GETLASTERRORTEXT,1,250);
              IF ProcEntry = 0 THEN
                ProcEntry := FillIntTable(SONo,DHLShipment,AccNo,EventCode,RICCode,DeliveryDate,CommitDate,TimeStamp);
              InsertLogEntry(SONo,STRSUBSTNO(Text010, SOLine."Document No.",SOLine."Line No."), ProcEntry, TRUE, FALSE);
              EXIT(FALSE);
            END;
            // E/gob-lku/23.10.2012/P0480

              SOLine.VALIDATE("Qty. to Ship",0);
              SOLine.MODIFY;
            UNTIL SOLine.NEXT = 0;
          // E/gob-lku/30.08.2012/P0259

          // A/gob-lku/24.10.2012/P0490
          //S/P1117
          //S/P1133
          CLEAR(FoundLineNo);
          CLEAR(GoOn);
          CASE FPCGeneralSetup."Active Parcel Status History" OF
            FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old":
              BEGIN
          //E/P1133
                ParcelStatusDHL.RESET;
                //A/gob-adb/16.05.13
                ParcelStatusDHL.SETCURRENTKEY("Sale Order Code");
                //E/gob-adb/16.05.13
                ParcelStatusDHL.SETRANGE("DHL Shipment Code",DHLShipment);
                ParcelStatusDHL.SETRANGE("Sale Order Code",SONo);
                IF (ParcelStatusDHL.FINDFIRST) AND (NOT NewDHLStatusLine) THEN BEGIN
                  FoundLineNo := ParcelStatusDHL."Line No.";
                  GoOn := TRUE;
                END;
          //S/P1133
              END;
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
            FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History":
              BEGIN
                ParcelStatusHistory.RESET;
                ParcelStatusHistory.SETCURRENTKEY("Sales Doc. No.","Sales Doc. Line No.","Sales Doc. Type");
                ParcelStatusHistory.SETRANGE("Tracking Code",DHLShipment);
                ParcelStatusHistory.SETRANGE("Sales Doc. No.",SONo);
                IF (ParcelStatusHistory.FINDFIRST) AND (NOT NewDHLStatusLine) THEN BEGIN
                  GoOn := TRUE;
                  FoundLineNo := ParcelStatusHistory."Sales Doc. Line No.";
                END;
              END;
          END;
          IF GoOn THEN BEGIN
            SOLine.SETRANGE("Line No.",FoundLineNo);
          //E/P1133
            IF SOLine.FINDFIRST THEN;
            // S/P1142
            IF ((EventCode IN ['CNRFC','DLVRD','DLVRF','HLDCC','HNDDE','HNDND','OFWRD'])
            OR ((EventCode = 'NTDEL') AND (RICCode IN ['CNCNR','CPUNK','MOVED','NHOME','NTCCN','NTORD','OTHER']))
            OR ((EventCode = 'RETRN') AND (RICCode IN ['CNCNR','NTCCN','NTORD']))) THEN
              CheckOtherSalesLines(SOLine);
            // E/P1142
          END ELSE BEGIN

          //IF STRPOS(AccNo, RhenusSetup."Rhenus DHL Account No.") = 1 THEN
          RhenusSetup.GET();
          IF STRPOS(AccNo, RhenusSetup."Rhenus DHL Account No.") = 1 THEN BEGIN
          // E/gob-lku/24.10.2012/P0490
            SOLine.SETFILTER("Purchasing Code",RHEPurchCode);
          // A/gob-lku/24.10.2012/P0490
            IF SOLine.FINDSET THEN
              REPEAT
                IF Item_l.GET(SOLine."No.") THEN BEGIN
                  IF (Item_l."Shipping Code" = '1918') OR (SOLine."Purchasing Code" = 'GER-2')
                      // A/gob-lku/08.01.2013/P0726
                      OR (SOLine."Purchasing Code" = 'AT-2')
                      // E/gob-lku/08.01.2013/P0726
                      OR (SOLine."Purchasing Code" = 'FRA-2') OR (SOLine."Purchasing Code" = 'NL-2') THEN
                    IF Filter_l = '' THEN
                      Filter_l := FORMAT(SOLine."Line No.")
                    ELSE
                      Filter_l += '|' + FORMAT(SOLine."Line No.");
                END;
              UNTIL SOLine.NEXT = 0;
            SOLine.SETFILTER("Line No.",Filter_l);
          //ELSE
          END;
          IF NOT SOLine.FINDFIRST THEN
          // E/gob-lku/24.10.2012/P0490

            SOLine.SETRANGE("Location Code",NotRHELocationCode);

          IF NOT SOLine.FINDFIRST THEN BEGIN
            SOLine.SETRANGE("Purchasing Code",SpedPurchCode);
            SOLine.SETRANGE("Location Code");
          END;
          IF NOT SOLine.FINDFIRST THEN BEGIN
            SOLine.SETRANGE("Purchasing Code");
            SOLine.SETRANGE("Location Code");
          END;

          // A/gob-lku/24.10.2012/P0490
          END;
          // E/gob-lku/24.10.2012/P0490

          // S/gob-lku/30.07.2013/P1051
          LineToPost := FALSE;
          // E/gob-lku/30.07.2013/P1051

          IF SOLine.FINDSET THEN REPEAT
            // A/gob-lku/04.09.2012/P0275
            IF SOLine."Outstanding Quantity" > 0 THEN BEGIN
            // E/gob-lku/04.09.2012/P0275
              // S/gob-lku/30.07.2013/P1051
              LineToPost := TRUE;
              // E/gob-lku/30.07.2013/P1051
              SOLine.VALIDATE("Qty. to Ship",SOLine."Outstanding Quantity");
              // A/gob-lku/23.10.2012/P0664
              dateVar := WORKDATE;
              IF STRLEN(TimeStamp) > 13 THEN
                IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                  IF EVALUATE(monthVar,COPYSTR(TimeStamp,6,2))THEN
                    IF EVALUATE(yearVar,COPYSTR(TimeStamp,1,4)) THEN
                      dateVar := DMY2DATE(dayVar,monthVar,yearVar);
              IF NOT EVALUATE(timeVar,COPYSTR(TimeStamp,12,8)) THEN
                timeVar := TIME;
              // A/gob-lku/23.01.2013/P0761
              //SOLine."Actual Delivery Date" := ROUNDDATETIME(CREATEDATETIME(dateVar,timeVar));
              // E/gob-lku/23.01.2013/P0761
              // E/gob-lku/23.10.2012/P0664

              SOLine.MODIFY;

            // A/gob-lku/04.09.2012/P0275
            END;
            // E/gob-lku/04.09.2012/P0275
          UNTIL SOLine.NEXT = 0;
          //100712  chrmu change hardcoded old purch codes to new <<<

          // S/gob-lku/30.07.2013/P1051
          IF NOT LineToPost THEN
            EXIT(TRUE);
          // E/gob-lku/30.07.2013/P1051

          SO.Ship := TRUE;
          SO.Invoice := FALSE;
          COMMIT;
          SO.Ship := TRUE;
          SO.Invoice := FALSE;

          // A/gob-lku/10.10.12/P0425
          IF NOT SO.Kommissionierung THEN
            SO."Ignore Komm. Control" := TRUE;
          // E/gob-lku/10.10.12/P0425

          IF SalesPost.RUN(SO) THEN
            InsertLogEntry(SONo,STRSUBSTNO(Text005, SO."No."), ProcEntry, FALSE, FALSE)
          ELSE BEGIN
            ErrorMessage := COPYSTR(GETLASTERRORTEXT,1,250);
            IF ProcEntry = 0 THEN
              ProcEntry := FillIntTable(SONo,DHLShipment,AccNo,EventCode,RICCode,DeliveryDate,CommitDate,TimeStamp);
            InsertLogEntry(SONo,STRSUBSTNO(Text004, SO."No."), ProcEntry, TRUE, FALSE);
            InsertLogEntry(SONo, ErrorMessage, ProcEntry, FALSE, FALSE);
            EXIT(FALSE);
          END;
        END;
        // H1057  23.04.14  MBY  ++++++++++++++++++++++++++++
        }
        // H1057  23.04.14  MBY  ----------------------------

        EXIT(TRUE);
      //A/gob-rste/03.08.12/P0133
      END ELSE BEGIN
        //A/gob-rste/10.09.12/P0302
        OrderFound := FALSE;
        //E/gob-rste/10.09.12/P0302
        PostChannel := FALSE;
        SalesHeaderLoc.INIT;

        SalesLineLoc.RESET;
        //A/gob-adb/06.08.13/P1014
        SalesLineLoc.SETCURRENTKEY("DHL Shipment Number");
        //E/gob-adb/06.08.13/P1014
        SalesLineLoc.SETRANGE("Document Type",SalesLineLoc."Document Type"::Order);
        SalesLineLoc.SETRANGE(Type,SalesLineLoc.Type::Item);
        SalesLineLoc.SETFILTER("No.",'<>%1','');
        //A/gob-rste/31.10.12/P0538
        //SalesLineLoc.SETRANGE("Purchasing Code",'GER-7');
        // A/gob-lku/08.01.2013/P0726
        //SalesLineLoc.SETFILTER("Purchasing Code",'GER-7|GER-12');
        // S/gob-lku/13.06.13/P0963
        //SalesLineLoc.SETFILTER("Purchasing Code",'*-7|*-12');
        SalesLineLoc.SETFILTER("Purchasing Code",'*-7|*-12|*-13');
        // S/gob-lku/13.06.13/P0963
        // E/gob-lku/08.01.2013/P0726
        //E/gob-rste/31.10.12/P0538
        SalesLineLoc.SETRANGE("DHL Shipment Number",DHLShipment);

        // A/gob-lku/06.11.2012/P0553
        IF STRLEN(TimeStamp) > 13 THEN
          IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
            IF EVALUATE(monthVar,COPYSTR(TimeStamp,6,2))THEN
              IF EVALUATE(yearVar,COPYSTR(TimeStamp,1,4)) THEN
                dateVar := DMY2DATE(dayVar,monthVar,yearVar);

        IF NOT EVALUATE(timeVar,COPYSTR(TimeStamp,12,8)) THEN
          timeVar := TIME;

        SalesLineLoc.SETFILTER("Created At",'<%1',CREATEDATETIME(dateVar,timeVar));
        // E/gob-lku/06.11.2012/P0553

        IF NOT SalesLineLoc.ISEMPTY THEN BEGIN
          PostChannel := TRUE;
          SalesLineLoc.FINDLAST;
          //A/gob-rste/10.09.12/P0302
          OrderFound := TRUE;
          //E/gob-rste/10.09.12/P0302
          SalesHeaderLoc.GET(SalesLineLoc."Document Type",SalesLineLoc."Document No.");
          // A/gob-lku/08.11.2012/P0566
          // S/gob-lku/15.05.2013/P0916
          //IF PLZ <> '' THEN
          //S/P0998
          //IF PLZ <> '' THEN BEGIN
          IF (PLZ <> '') AND (SalesHeaderLoc."Ship-to Country/Region Code" IN ['DE','']) THEN BEGIN
          //E/P0998
          // E/gob-lku/15.05.2013/P0916
            IF SalesHeaderLoc."Ship-to Post Code" = PLZ THEN
          // E/gob-lku/08.11.2012/P0566
          UpdateLinesGER7(SalesLineLoc,
                          DHLShipment,
                          AccNo,
                          EventCode,
                          RICCode,
                          DeliveryDate,
                          CommitDate,
                          TimeStamp,
        // A/gob-lku/08.11.2012/P0566
                          //ProcEntry);
                          ProcEntry)
            ELSE BEGIN
              OrderFound := FALSE;
              PostChannel := FALSE;
            END;
          // S/gob-lku/15.05.2013/P0916
          END ELSE BEGIN
            UpdateLinesGER7(SalesLineLoc,
                            DHLShipment,
                            AccNo,
                            EventCode,
                            RICCode,
                            DeliveryDate,
                            CommitDate,
                            TimeStamp,
                            ProcEntry);
          END;
          // E/gob-lku/15.05.2013/P0916
        END;
        //END ELSE BEGIN
        IF NOT OrderFound THEN BEGIN
        // E/gob-lku/08.11.2012/P0566
          //S/P1133
          CLEAR(GoOn);
          CASE FPCGeneralSetup."Active Parcel Status History" OF
            FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old":
              BEGIN
          //E/P1133
                DHLParcelsStatusHistory.RESET;
                // A/gob-lku/08.11.2012/P0566
                //DHLParcelsStatusHistory.SETRANGE("Piece-Code (Identifier)",DHLShipment);
                // S/gob-lku/14.08.2013/P1051
                //DHLParcelsStatusHistory.SETRANGE("DHL Shipment Code",DHLShipment);
                DHLParcelsStatusHistory.SETCURRENTKEY("Piece-Code (Identifier)");
                DHLParcelsStatusHistory.SETRANGE("Piece-Code (Identifier)",DHLShipment);
                // E/gob-lku/14.08.2013/P1051
                // E/gob-lku/08.11.2012/P0566
                IF DHLParcelsStatusHistory.FINDLAST THEN
          //S/P1133
                  GoOn := TRUE
              END;
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
            FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History":
              BEGIN
                ParcelStatusHistory.RESET;
                ParcelStatusHistory.SETCURRENTKEY("Tracking Code","Piece Code");
                ParcelStatusHistory.SETRANGE("Piece Code",DHLShipment);
                IF ParcelStatusHistory.FINDLAST THEN
                  GoOn := TRUE;
              END;
          END;
          IF GoOn THEN BEGIN
          //E/P1133
            SalesLineLoc.RESET;
            SalesLineLoc.SETRANGE("Document Type",SalesLineLoc."Document Type"::Order);
            SalesLineLoc.SETRANGE(Type,SalesLineLoc.Type::Item);
            SalesLineLoc.SETFILTER("No.",'<>%1','');
            //A/gob-rste/31.10.12/P0538
            //SalesLineLoc.SETRANGE("Purchasing Code",'GER-7');
            // A/gob-lku/08.01.2013/P0726
            //SalesLineLoc.SETFILTER("Purchasing Code",'GER-7|GER-12');
            // S/gob-lku/13.06.13/P0963
            //SalesLineLoc.SETFILTER("Purchasing Code",'*-7|*-12');
            SalesLineLoc.SETFILTER("Purchasing Code",'*-7|*-12|*-13');
            // E/gob-lku/13.06.13/P0963
            // E/gob-lku/08.01.2013/P0726
            //E/gob-rste/31.10.12/P0538
            //S/P1133
            CASE FPCGeneralSetup."Active Parcel Status History" OF
              FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old":
                BEGIN
            //E/P1133
                  // A/gob-lku/24.10.2012/P0490
                  //SalesLineLoc.SETRANGE("DHL Shipment Number",DHLParcelsStatusHistory."DHL Shipment Code");
                  SalesLineLoc.SETRANGE("Line No.",DHLParcelsStatusHistory."Document Line No.");
                  SalesLineLoc.SETRANGE("Document No.",DHLParcelsStatusHistory."Document No.");
                  // E/gob-lku/24.10.2012/P0490
            //S/P1133
                END;
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
              FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History":
                BEGIN
                  SalesLineLoc.SETRANGE("Document No.",ParcelStatusHistory."Document No.");
                  SalesLineLoc.SETRANGE("Line No.",ParcelStatusHistory."Document Line No.");
                END;
            END;
            //E/P1133

            // A/gob-lku/06.11.2012/P0553
            IF STRLEN(TimeStamp) > 13 THEN
              IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                IF EVALUATE(monthVar,COPYSTR(TimeStamp,6,2))THEN
                  IF EVALUATE(yearVar,COPYSTR(TimeStamp,1,4)) THEN
                    dateVar := DMY2DATE(dayVar,monthVar,yearVar);

            IF NOT EVALUATE(timeVar,COPYSTR(TimeStamp,12,8)) THEN
              timeVar := TIME;
            SalesLineLoc.SETFILTER("Created At",'<%1',CREATEDATETIME(dateVar,timeVar));
            // E/gob-lku/06.11.2012/P0553
            IF NOT SalesLineLoc.ISEMPTY THEN BEGIN
              PostChannel := TRUE;
              //A/gob-rste/10.09.12/P0302
              OrderFound := TRUE;
              //E/gob-rste/10.09.12/P0302
              SalesLineLoc.FINDLAST;
              SalesHeaderLoc.GET(SalesLineLoc."Document Type",SalesLineLoc."Document No.");
              // A/gob-lku/08.11.2012/P0566
              // S/gob-lku/15.05.2013/P0916
              //IF PLZ <> '' THEN
              //S/P0998
              //IF PLZ <> '' THEN BEGIN
              IF (PLZ <> '') AND (SalesHeaderLoc."Ship-to Country/Region Code" IN ['DE','']) THEN BEGIN
              //E/P0998
              // E/gob-lku/15.05.2013/P0916
                IF SalesHeaderLoc."Ship-to Post Code" = PLZ THEN
              // E/gob-lku/08.11.2012/P0566
              UpdateLinesGER7(SalesLineLoc,
                              DHLShipment,
                              AccNo,
                              EventCode,
                              RICCode,
                              DeliveryDate,
                              CommitDate,
                              TimeStamp,
            // A/gob-lku/08.11.2012/P0566
                              //ProcEntry);
                              ProcEntry)
                ELSE BEGIN
                  OrderFound := FALSE;
                  PostChannel := FALSE;
                END;
            // S/gob-lku/15.05.2013/P0916
            END ELSE BEGIN
              UpdateLinesGER7(SalesLineLoc,
                              DHLShipment,
                              AccNo,
                              EventCode,
                              RICCode,
                              DeliveryDate,
                              CommitDate,
                              TimeStamp,
                              ProcEntry);
            END;
            // E/gob-lku/15.05.2013/P0916
            END;
            // A/gob-lku/05.09.12/P0287
            END;
            //END ELSE BEGIN
            IF NOT OrderFound THEN BEGIN
            // E/gob-lku/08.11.2012/P0566
              //A/gob-adb/06.08.13/P1014
              SOLineArchive.SETCURRENTKEY("DHL Shipment Number");
              //E/gob-adb/06.08.13/P1014
              SOLineArchive.SETRANGE("Document Type",SOLineArchive."Document Type"::Order);
              SOLineArchive.SETRANGE(Type,SOLineArchive.Type::Item);
              SOLineArchive.SETFILTER("No.",'<>%1','');
              //A/gob-rste/31.10.12/P0538
              //SOLineArchive.SETRANGE("Purchasing Code",'GER-7');
              // A/gob-lku/08.01.2013/P0726
              //SOLineArchive.SETFILTER("Purchasing Code",'GER-7|GER-12');
              // S/gob-lku/13.06.13/P0963
              //SOLineArchive.SETFILTER("Purchasing Code",'*-7|*-12');
              SOLineArchive.SETFILTER("Purchasing Code",'*-7|*-12|*-13');
              // E/gob-lku/13.06.13/P0963
              // E/gob-lku/08.01.2013/P0726
              //E/gob-rste/31.10.12/P0538
              // S/P1115
              //SOLineArchive.SETRANGE("DHL Shipment Number",DHLParcelsStatusHistory."DHL Shipment Code");
              SOLineArchive.SETRANGE("DHL Shipment Number",DHLShipment);
              // E/P1115

              // A/gob-lku/06.11.2012/P0553
              IF STRLEN(TimeStamp) > 13 THEN
                IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                  IF EVALUATE(monthVar,COPYSTR(TimeStamp,6,2))THEN
                    IF EVALUATE(yearVar,COPYSTR(TimeStamp,1,4)) THEN
                      dateVar := DMY2DATE(dayVar,monthVar,yearVar);

              IF NOT EVALUATE(timeVar,COPYSTR(TimeStamp,12,8)) THEN
                timeVar := TIME;

              SOLineArchive.SETFILTER("Created At",'<%1',CREATEDATETIME(dateVar,timeVar));
              // E/gob-lku/06.11.2012/P0553

              IF NOT SOLineArchive.ISEMPTY THEN BEGIN
                PostChannel := FALSE; // PostChannel = FALSE, damit Archive nicht buchen will
                //A/gob-rste/10.09.12/P0302
                OrderFound := TRUE;
                //E/gob-rste/10.09.12/P0302
                SOLineArchive.FINDLAST;
                SOHeaderArchive.SETRANGE("Document Type",SOHeaderArchive."Document Type"::Order);
                SOHeaderArchive.SETRANGE("No.",SOLineArchive."Document No.");
                // A/gob-lku/08.11.2012/P0566
                //S/P0998
                //IF PLZ <> '' THEN
                IF (PLZ <> '') AND (SOHeaderArchive."Ship-to Country/Region Code" IN ['DE','']) THEN
                //E/P0998
                  SOHeaderArchive.SETRANGE("Ship-to Post Code",PLZ);
                //IF SOHeaderArchive.FINDFIRST THEN;
                IF SOHeaderArchive.FINDFIRST THEN BEGIN
                // E/gob-lku/08.11.2012/P0566

                UpdateArchiveLinesGER7(SOLineArchive,
                                       DHLShipment,
                                       AccNo,
                                       EventCode,
                                       RICCode,
                                       DeliveryDate,
                                       CommitDate,
                                       TimeStamp,
                                       ProcEntry);
              // A/gob-lku/08.11.2012/P0566
              END ELSE
                OrderFound := FALSE;
              // E/gob-lku/08.11.2012/P0566
              END;
            // E/gob-lku/05.09.12/P0287
          END;
        END;
        // A/gob-lku/08.11.2012/P0566
        IF NOT OrderFound THEN BEGIN
        // E/gob-lku/08.11.2012/P0566

        //A,gob-Fuchs,11.10.12,P0443
        //SalesHeaderLoc.INIT;
        //E,gob-Fuchs,11.10.12,P0443
        SalesLineLoc.RESET;
        //A/gob-adb/06.08.13/P1014
        SalesLineLoc.SETCURRENTKEY("DHL Shipment Number");
        //E/gob-adb/06.08.13/P1014
        SalesLineLoc.SETRANGE("Document Type",SalesLineLoc."Document Type"::Order);
        SalesLineLoc.SETRANGE(Type,SalesLineLoc.Type::Item);
        SalesLineLoc.SETFILTER("No.",'<>%1','');

        // A/gob-lku/29.10.2012/P0528
        //SalesLineLoc.SETRANGE("Purchasing Code",'GER-9');
        // A/gob-lku/08.01.2013/P0726
        //SalesLineLoc.SETFILTER("Purchasing Code",'GER-9|NL-9|FRA-9');
        SalesLineLoc.SETFILTER("Purchasing Code",'*-9');
        // E/gob-lku/08.01.2013/P0726
        // E/gob-lku/29.10.2012/P0528

        SalesLineLoc.SETRANGE("DHL Shipment Number",DHLShipment);
        IF NOT SalesLineLoc.ISEMPTY THEN BEGIN
          // S/P1113
          //SalesLineLoc.FINDLAST;
          SalesLineLoc.FIND('-');

          //A/gob-rste/10.09.12/P0302
          //OrderFound := TRUE;
          //E/gob-rste/10.09.12/P0302

          //SalesHeaderLoc.GET(SalesLineLoc."Document Type",SalesLineLoc."Document No.");
          REPEAT
            SalesHeaderLoc.SETRANGE("Document Type",SalesLineLoc."Document Type"::Order);
            SalesHeaderLoc.SETRANGE("No.",SalesLineLoc."Document No.");
            IF PLZ <> '' THEN
              SalesHeaderLoc.SETRANGE("Ship-to Post Code",PLZ);
            IF SalesHeaderLoc.FINDFIRST THEN
              OrderFound := TRUE;
            IF NOT OrderFound THEN
              NoNext := SalesLineLoc.NEXT = 0;
          UNTIL OrderFound OR NoNext;

          IF OrderFound THEN
          // E/P1113

          UpdateLinesGER9(SalesLineLoc,
                          DHLShipment,
                          AccNo,
                          EventCode,
                          RICCode,
                          DeliveryDate,
                          CommitDate,
                          TimeStamp,
                          ProcEntry);

        // A/gob-lku/30.10.2012/P0531
        //END;
        END ELSE BEGIN

          SOLineArchive.RESET;
          //A/gob-adb/06.08.13/P1014
          SOLineArchive.SETCURRENTKEY("DHL Shipment Number");
          //E/gob-adb/06.08.13/P1014
          SOLineArchive.SETRANGE("Document Type",SalesLineLoc."Document Type"::Order);
          SOLineArchive.SETRANGE(Type,SalesLineLoc.Type::Item);
          SOLineArchive.SETFILTER("No.",'<>%1','');
          // A/gob-lku/08.01.2013/P0726
          //SOLineArchive.SETFILTER("Purchasing Code",'GER-9|NL-9|FRA-9');
          SOLineArchive.SETFILTER("Purchasing Code",'*-9');
          // E/gob-lku/08.01.2013/P0726

          SOLineArchive.SETRANGE("DHL Shipment Number",DHLShipment);
          IF NOT SOLineArchive.ISEMPTY THEN BEGIN
            // S/P1113
            //SOLineArchive.FINDLAST;
            SOLineArchive.FIND('-');
            //OrderFound := TRUE;
            //PostChannel := FALSE;
            // A/gob-lku/13.11.2012/P0579
            //SOHeaderArchive.GET(SOLineArchive."Document Type",SOLineArchive."Document No."
            //                ,SOLineArchive."Doc. No. Occurrence",SOLineArchive."Version No.");

            REPEAT
              SOHeaderArchive.SETRANGE("Document Type",SOLineArchive."Document Type"::Order);
              SOHeaderArchive.SETRANGE("No.",SOLineArchive."Document No.");
              IF PLZ <> '' THEN
                SOHeaderArchive.SETRANGE("Ship-to Post Code",PLZ);
              IF SOHeaderArchive.FINDFIRST THEN BEGIN
                OrderFound := TRUE;
                PostChannel := FALSE;
              END;
              IF NOT OrderFound THEN
                NoNext := SOLineArchive.NEXT = 0;
            UNTIL (OrderFound) OR (NoNext);
            IF NOT OrderFound THEN
            //IF NOT SOHeaderArchive.GET(SOLineArchive."Document Type",SOLineArchive."Document No.",
            //          SOLineArchive."Doc. No. Occurrence",SOLineArchive."Version No.") THEN
            // E/P1113
              EXIT(FALSE);
            // E/gob-lku/13.11.2012/P0579
            UpdateArchiveLinesGER9(SOLineArchive,
                            DHLShipment,
                            AccNo,
                            EventCode,
                            RICCode,
                            DeliveryDate,
                            CommitDate,
                            TimeStamp,
                            ProcEntry);

          END;
          // S/P1139
          //S/P1133
          CASE FPCGeneralSetup."Active Parcel Status History" OF
            FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old":
              BEGIN
          //E/P1133
                DHLParcelsStatusHistory.RESET;
                DHLParcelsStatusHistory.SETCURRENTKEY("DHL Shipment Code","Piece-Code (Identifier)");
                DHLParcelsStatusHistory.SETRANGE("DHL Shipment Code",DHLShipment);
                DHLParcelsStatusHistory.SETRANGE("Piece-Code (Identifier)",DHLShipment);
                IF DHLParcelsStatusHistory.FIND('-') THEN
                  REPEAT
                    SalesLineLoc.RESET;
                    SalesLineLoc.SETRANGE("Document Type",SalesLineLoc."Document Type"::Order);
                    SalesLineLoc.SETRANGE("Document No.",DHLParcelsStatusHistory."Document No.");
                    SalesLineLoc.SETRANGE("Line No.",DHLParcelsStatusHistory."Document Line No.");
                    IF SalesLineLoc.FINDFIRST THEN BEGIN
                      // S/P1155
                      //SalesHeaderLoc.GET(SalesLineLoc."Document Type",SalesLineLoc."No.");
                      SalesHeaderLoc.GET(SalesLineLoc."Document Type",SalesLineLoc."Document No.");
                      // E/P1155
                      IF PLZ <> '' THEN
                        IF SalesHeaderLoc."Ship-to Post Code" = PLZ THEN BEGIN
                          OrderFound := TRUE;
                          PostChannel := TRUE;
                          UpdateLinesGER9(SalesLineLoc,
                                          DHLShipment,
                                          AccNo,
                                          EventCode,
                                          RICCode,
                                          DeliveryDate,
                                          CommitDate,
                                          TimeStamp,
                                          ProcEntry);
                        END;
                    END ELSE BEGIN
                      SOLineArchive.RESET;
                      SOLineArchive.SETRANGE("Document Type",SalesLineLoc."Document Type"::Order);
                      SOLineArchive.SETRANGE("Document No.",DHLParcelsStatusHistory."Document No.");
                      SOLineArchive.SETRANGE("Line No.",DHLParcelsStatusHistory."Document Line No.");
                      IF SOLineArchive.FINDFIRST THEN BEGIN
                        // S/P1155
                        //SOHeaderArchive.GET(SOLineArchive."Document Type",SOLineArchive."No.",
                        SOHeaderArchive.GET(SOLineArchive."Document Type",SOLineArchive."Document No.",
                        // E/P1155
                                            SOLineArchive."Doc. No. Occurrence",SOLineArchive."Version No.");
                        IF PLZ <> '' THEN
                          IF SOHeaderArchive."Ship-to Post Code" = PLZ THEN BEGIN
                            OrderFound := TRUE;
                            PostChannel := FALSE;
                            UpdateArchiveLinesGER9(SOLineArchive,
                                            DHLShipment,
                                            AccNo,
                                            EventCode,
                                            RICCode,
                                            DeliveryDate,
                                            CommitDate,
                                            TimeStamp,
                                            ProcEntry);
                          END;
                      END;
                    END;
                  UNTIL (DHLParcelsStatusHistory.NEXT = 0) OR (OrderFound)
          //S/P1133
              END;
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
            FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History":
              BEGIN
                ParcelStatusHistory.RESET;
                ParcelStatusHistory.SETCURRENTKEY("Tracking Code","Piece Code");
                ParcelStatusHistory.SETRANGE("Tracking Code",DHLShipment);
                ParcelStatusHistory.SETRANGE("Piece Code",DHLShipment);
                IF ParcelStatusHistory.FIND('-') THEN
                  REPEAT
                    SalesLineLoc.RESET;
                    SalesLineLoc.SETRANGE("Document Type",SalesLineLoc."Document Type"::Order);
                    SalesLineLoc.SETRANGE("Document No.",ParcelStatusHistory."Document No.");
                    SalesLineLoc.SETRANGE("Line No.",ParcelStatusHistory."Document Line No.");
                    IF SalesLineLoc.FINDFIRST THEN BEGIN
                      // S/P1155
                      //SalesHeaderLoc.GET(SalesLineLoc."Document Type",SalesLineLoc."No.");
                      SalesHeaderLoc.GET(SalesLineLoc."Document Type",SalesLineLoc."Document No.");
                      // E/P1155
                      IF PLZ <> '' THEN
                        IF SalesHeaderLoc."Ship-to Post Code" = PLZ THEN BEGIN
                          OrderFound := TRUE;
                          PostChannel := TRUE;
                          UpdateLinesGER9(SalesLineLoc,
                                          DHLShipment,
                                          AccNo,
                                          EventCode,
                                          RICCode,
                                          DeliveryDate,
                                          CommitDate,
                                          TimeStamp,
                                          ProcEntry);
                        END;
                    END ELSE BEGIN
                      SOLineArchive.RESET;
                      SOLineArchive.SETRANGE("Document Type",SalesLineLoc."Document Type"::Order);
                      SOLineArchive.SETRANGE("Document No.",ParcelStatusHistory."Document No.");
                      SOLineArchive.SETRANGE("Line No.",ParcelStatusHistory."Document Line No.");
                      IF SOLineArchive.FINDFIRST THEN BEGIN
                        // S/P1155
                        //SOHeaderArchive.GET(SOLineArchive."Document Type",SOLineArchive."No.",
                        SOHeaderArchive.GET(SOLineArchive."Document Type",SOLineArchive."Document No.",
                        // E/P1155
                                            SOLineArchive."Doc. No. Occurrence",SOLineArchive."Version No.");
                        IF PLZ <> '' THEN
                          IF SOHeaderArchive."Ship-to Post Code" = PLZ THEN BEGIN
                            OrderFound := TRUE;
                            PostChannel := FALSE;
                            UpdateArchiveLinesGER9(SOLineArchive,
                                            DHLShipment,
                                            AccNo,
                                            EventCode,
                                            RICCode,
                                            DeliveryDate,
                                            CommitDate,
                                            TimeStamp,
                                            ProcEntry);
                          END;
                      END;
                    END;
                  UNTIL (ParcelStatusHistory.NEXT = 0) OR (OrderFound)
              END;
          END;
          //E/P1133
          // E/P1139
        END;
        // E/gob-lku/30.10.2012/P0531

        // A/gob-lku/08.11.2012/P0566
        END;
        // E/gob-lku/08.11.2012/P0566

        IF PostChannel = TRUE THEN BEGIN
          // H1057  23.04.14  MBY  ++++++++++++++++++++++++++++
          {
          // H1057  23.04.14  MBY  ----------------------------
          // A/gob-lku/10.10.12/P0425
          //IF (SalesHeaderLoc."No." <> '') AND (EventCode = 'DLVRD') AND
          //   (SalesHeaderLoc.Kommissionierung) AND (SalesHeaderLoc."Document Date" >= 250512D)
          // A/gob-lku/11.12.2012/P0661
          //IF (SalesHeaderLoc."No." <> '') AND (EventCode = 'DLVRD')
          IF (SalesHeaderLoc."No." <> '') AND
            ((EventCode IN ['CNRFC','DLVRD','DLVRF','HLDCC','HNDDE','HNDND','OFWRD'])
            OR ((EventCode = 'NTDEL') AND (RICCode IN ['CNCNR','CPUNK','MOVED','NHOME','NTCCN','NTORD','OTHER']))
            OR ((EventCode = 'RETRN') AND (RICCode IN ['CNCNR','NTCCN','NTORD'])))
          // E/gob-lku/11.12.2012/P0661
          // E/gob-lku/10.10.12/P0425
          THEN BEGIN
            IF EVALUATE(dayVar,COPYSTR(DeliveryDate,7,2)) THEN
              IF EVALUATE(monthVar,COPYSTR(DeliveryDate,5,2))THEN
                IF EVALUATE(yearVar,COPYSTR(DeliveryDate,1,4)) THEN
                  DHLPostingDate := DMY2DATE(dayVar,monthVar,yearVar);

            IF DHLPostingDate <> 0D THEN
              // A/gob-lku/17.10.12/P0455
              //SalesHeaderLoc."Posting Date" := ParcelStatusDHL."Delivery Date";
              SalesHeaderLoc."Posting Date" := DHLPostingDate;
              // E/gob-lku/17.10.12/P0455

            SalesHeaderLoc.Ship := TRUE;
            SalesHeaderLoc.Invoice := FALSE;
            SalesHeaderLoc.MODIFY;

            SalesLineLoc.RESET;
            SalesLineLoc.SETRANGE("Document Type",SalesLineLoc."Document Type"::Order);
            SalesLineLoc.SETRANGE("Document No.",SalesHeaderLoc."No.");
            // A/gob-lku/30.08.12/P0259
            //SalesLineLoc.SETRANGE("Purchasing Code",'GER-7');
            //SalesLineLoc.MODIFYALL("Qty. to Ship",0);
            IF SalesLineLoc.FIND('-') THEN
              REPEAT
              // A/gob-lku/04.09.2012/P0275
                IF SalesLineLoc."Outstanding Quantity" < 0 THEN BEGIN
                  ErrorMessage := COPYSTR(GETLASTERRORTEXT,1,250);
                  IF ProcEntry = 0 THEN
                    ProcEntry := FillIntTable(SalesLineLoc."Document No.",
                                DHLShipment,AccNo,EventCode,RICCode,DeliveryDate,CommitDate,TimeStamp);
                  InsertLogEntry(SalesLineLoc."Document No.",STRSUBSTNO(Text008, SalesLineLoc."Document No."), ProcEntry, TRUE, FALSE);
                  EXIT(FALSE);
                END;
              // E/gob-lku/04.09.2012/P0275

                // A/gob-lku/23.10.2012/P0480
                IF (SalesLineLoc."Qty. to Ship (Base)" * SalesLineLoc."Quantity (Base)" < 0) OR
                   (ABS(SalesLineLoc."Qty. to Ship (Base)") > ABS(SalesLineLoc."Outstanding Qty. (Base)")) OR
                   (SalesLineLoc."Quantity (Base)" * SalesLineLoc."Outstanding Qty. (Base)" < 0)
                THEN BEGIN
                  ErrorMessage := COPYSTR(GETLASTERRORTEXT,1,250);
                  IF ProcEntry = 0 THEN
                    ProcEntry := FillIntTable(SalesLineLoc."Document No.",
                                DHLShipment,AccNo,EventCode,RICCode,DeliveryDate,CommitDate,TimeStamp);
                  InsertLogEntry(SalesLineLoc."Document No.",
                                STRSUBSTNO(Text010, SalesLineLoc."Document No.",SalesLineLoc."Line No."), ProcEntry, TRUE, FALSE);
                  EXIT(FALSE);
                END;
                // E/gob-lku/23.10.2012/P0480

                SalesLineLoc.VALIDATE("Qty. to Ship",0);
                SalesLineLoc.MODIFY;
              UNTIL SalesLineLoc.NEXT = 0;
            //A/gob-rste/31.10.12/P0538
            //SalesLineLoc.SETRANGE("Purchasing Code",'GER-7');
            // A/gob-lku/08.01.2013/P0726
            //SalesLineLoc.SETFILTER("Purchasing Code",'GER-7|GER-12');
            // S/gob-lku/13.06.13/P0963
            //SalesLineLoc.SETFILTER("Purchasing Code",'*-7|*-12');
            SalesLineLoc.SETFILTER("Purchasing Code",'*-7|*-12|*-13');
            // E/gob-lku/13.06.13/P0963
            // E/gob-lku/08.01.2013/P0726
            //E/gob-rste/31.10.12/P0538
            // A/gob-lku/24.10.2012/P0490
            SalesLineLoc.SETRANGE("DHL Shipment Number",DHLShipment);
            IF SalesLineLoc.FINDFIRST THEN
              SalesLineLoc.SETRANGE("Vendor No.",SalesLineLoc."Vendor No.");
            SalesLineLoc.SETRANGE("DHL Shipment Number");
            // E/gob-lku/24.10.2012/P0490

            // E/gob-lku/30.08.12/P0259
            // S/gob-lku/30.07.2013/P1051
            LineToPost := FALSE;
            // E/gob-lku/30.07.2013/P1051
            IF SalesLineLoc.FINDSET THEN
              REPEAT
                // A/gob-lku/04.09.2012/P0275
                IF SalesLineLoc."Outstanding Quantity" > 0 THEN BEGIN
                  // E/gob-lku/04.09.2012/P0275
                  // S/gob-lku/30.07.2013/P1051
                  LineToPost := TRUE;
                  // E/gob-lku/30.07.2013/P1051
                  SalesLineLoc.VALIDATE("Qty. to Ship",SalesLineLoc."Outstanding Quantity");
                  // A/gob-lku/23.10.2012/P0664
                  dateVar := WORKDATE;
                  IF STRLEN(TimeStamp) > 13 THEN
                    IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                      IF EVALUATE(monthVar,COPYSTR(TimeStamp,6,2))THEN
                        IF EVALUATE(yearVar,COPYSTR(TimeStamp,1,4)) THEN
                          dateVar := DMY2DATE(dayVar,monthVar,yearVar);
                  IF NOT EVALUATE(timeVar,COPYSTR(TimeStamp,12,8)) THEN
                    timeVar := TIME;
                  // A/gob-lku/23.01.2013/P0761
                  //SalesLineLoc."Actual Delivery Date" := ROUNDDATETIME(CREATEDATETIME(dateVar,timeVar));
                  // E/gob-lku/23.01.2013/P0761
                  // E/gob-lku/23.10.2012/P0664

                  SalesLineLoc.MODIFY;
                  // A/gob-lku/04.09.2012/P0275
                END;
                // E/gob-lku/04.09.2012/P0275
              UNTIL SalesLineLoc.NEXT = 0;

            // A/gob-lku/10.10.12/P0425
            IF NOT SalesHeaderLoc.Kommissionierung THEN
              SalesHeaderLoc."Ignore Komm. Control" := TRUE;
            // E/gob-lku/10.10.12/P0425

            COMMIT;

            // S/gob-lku/30.07.2013/P1051
            IF NOT LineToPost THEN
              EXIT(TRUE);
            // E/gob-lku/30.07.2013/P1051

            IF SalesPost.RUN(SalesHeaderLoc) THEN
              InsertLogEntry(SalesHeaderLoc."No.",STRSUBSTNO(Text005, SalesHeaderLoc."No."), ProcEntry, FALSE, FALSE)
            ELSE BEGIN
              ErrorMessage := COPYSTR(GETLASTERRORTEXT,1,250);
              IF ProcEntry = 0 THEN
                ProcEntry := FillIntTable(SalesHeaderLoc."No.",DHLShipment,AccNo,EventCode,RICCode,DeliveryDate,CommitDate,TimeStamp);
              InsertLogEntry(SalesHeaderLoc."No.",STRSUBSTNO(Text004, SalesHeaderLoc."No."), ProcEntry, TRUE, FALSE);
              InsertLogEntry(SalesHeaderLoc."No.", ErrorMessage, ProcEntry, FALSE, FALSE);
              EXIT(FALSE);
            END;
          END;
          // H1057  23.04.14  MBY  ++++++++++++++++++++++++++++
          }
          // H1057  23.04.14  MBY  ----------------------------
          EXIT(TRUE);
        END;

        //H1952 06.01.15 DMA ++++++++++++++++++++++++++++++++++

        IF NOT OrderFound THEN BEGIN
          DHLSetup.GET;
          ParcelStatusHistoryL.RESET;
          ParcelStatusHistoryL.SETRANGE("Document Type",ParcelStatusHistoryL."Document Type"::Order);
          ParcelStatusHistoryL.SETRANGE("Tracking Code",DHLShipment);
          ParcelStatusHistoryL.SETRANGE("Shipping Agent Code",DHLSetup."DHL Shipping Agent");
          IF ParcelStatusHistoryL.FINDLAST THEN BEGIN
            RecRef.OPEN(DATABASE::"Sales Line");
            FieldRefL := RecRef.FIELD(1);
            FieldRefL.SETRANGE(ParcelStatusHistoryL."Document Type");
            FieldRefL := RecRef.FIELD(3);
            FieldRefL.SETRANGE(ParcelStatusHistoryL."Document No.");
            FieldRefL := RecRef.FIELD(4);
            FieldRefL.SETRANGE(ParcelStatusHistoryL."Document Line No.");
            IF RecRef.FINDFIRST THEN BEGIN
              CLEAR(CUParcelStatusHistoryMgmt);
              IF EVALUATE(dayVar,COPYSTR(CommitDate,7,2)) THEN
                IF EVALUATE(monthVar,COPYSTR(CommitDate,5,2))THEN
                  IF EVALUATE(yearVar,COPYSTR(CommitDate,1,4)) THEN
                    DateCommit := DMY2DATE(dayVar,monthVar,yearVar);
              IF EVALUATE(dayVar,COPYSTR(DeliveryDate,7,2)) THEN
                IF EVALUATE(monthVar,COPYSTR(DeliveryDate,5,2))THEN
                  IF EVALUATE(yearVar,COPYSTR(DeliveryDate,1,4)) THEN
                    DateDelivery := DMY2DATE(dayVar,monthVar,yearVar);
              CUParcelStatusHistoryMgmt.SetDateGlobals(0D,DateDelivery,DateCommit);
              CUParcelStatusHistoryMgmt.SetAccountNo(AccNo);
              CUParcelStatusHistoryMgmt.SetDateTimeGlobal(CREATEDATETIME(dateVar,timeVar));

              CUParcelStatusHistoryMgmt.FillHistoryByDocLine(
                RecRef,                       // Rec
                1,                            // p_Command
                0,                            // p_InfoDirection::  Incoming,Outgoing
                3,                            // p_UsedInterface::  ,EDI,DHL,DocData,Drop Shipment,Rhenus,UPS
                DHLSetup."DHL Shipping Agent",// p_ShippingAgentCode
                UPPERCASE(DHLShipment),       // p_TrackingCode
                '',                           // p_PieceCode
                EventCode,                    // p_StatusCode
                RICCode,                      // p_StatusRICCode
                '',                           // p_Comment
                0);                           // p_HandleStatusDescription

                OrderFound := TRUE;

            END;
          END ELSE BEGIN
            ParcelStatusHistoryArchiveL.RESET;
            ParcelStatusHistoryArchiveL.SETRANGE("Document Type",ParcelStatusHistoryL."Document Type"::Order);
            ParcelStatusHistoryArchiveL.SETRANGE("Tracking Code",DHLShipment);
            ParcelStatusHistoryArchiveL.SETRANGE("Shipping Agent Code",DHLSetup."DHL Shipping Agent");
            IF ParcelStatusHistoryArchiveL.FINDLAST THEN BEGIN
              RecRef.OPEN(DATABASE::"Sales Line Archive");
              FieldRefL := RecRef.FIELD(1);
              FieldRefL.SETRANGE(ParcelStatusHistoryArchiveL."Document Type");
              FieldRefL := RecRef.FIELD(3);
              FieldRefL.SETRANGE(ParcelStatusHistoryArchiveL."Document No.");
              FieldRefL := RecRef.FIELD(4);
              FieldRefL.SETRANGE(ParcelStatusHistoryArchiveL."Document Line No.");
              IF RecRef.FINDFIRST THEN BEGIN
                CLEAR(CUParcelStatusHistoryMgmt);
                IF EVALUATE(dayVar,COPYSTR(CommitDate,7,2)) THEN
                  IF EVALUATE(monthVar,COPYSTR(CommitDate,5,2))THEN
                    IF EVALUATE(yearVar,COPYSTR(CommitDate,1,4)) THEN
                      DateCommit := DMY2DATE(dayVar,monthVar,yearVar);
                IF EVALUATE(dayVar,COPYSTR(DeliveryDate,7,2)) THEN
                  IF EVALUATE(monthVar,COPYSTR(DeliveryDate,5,2))THEN
                    IF EVALUATE(yearVar,COPYSTR(DeliveryDate,1,4)) THEN
                      DateDelivery := DMY2DATE(dayVar,monthVar,yearVar);
                CUParcelStatusHistoryMgmt.SetDateGlobals(0D,DateDelivery,DateCommit);
                CUParcelStatusHistoryMgmt.SetAccountNo(AccNo);
                CUParcelStatusHistoryMgmt.SetDateTimeGlobal(CREATEDATETIME(dateVar,timeVar));

                CUParcelStatusHistoryMgmt.FillHistoryByDocLine(
                  RecRef,                       // Rec
                  1,                            // p_Command
                  0,                            // p_InfoDirection::  Incoming,Outgoing
                  3,                            // p_UsedInterface::  ,EDI,DHL,DocData,Drop Shipment,Rhenus,UPS
                  DHLSetup."DHL Shipping Agent",// p_ShippingAgentCode
                  UPPERCASE(DHLShipment),       // p_TrackingCode
                  '',                           // p_PieceCode
                  EventCode,                    // p_StatusCode
                  RICCode,                      // p_StatusRICCode
                  '',                           // p_Comment
                  0);                           // p_HandleStatusDescription

                  OrderFound := TRUE;

              END;
            END;
          END;
        END;
        //H1952 06.01.15 DMA ----------------------------------

        //A/gob-rste/10.09.12/P0302
        // Check Return Order Lines
        IF OrderFound = FALSE THEN BEGIN
          ReturnOrderLine.RESET;
          ReturnOrderLine.SETRANGE("Document Type",ReturnOrderLine."Document Type"::"Return Order");
          ReturnOrderLine.SETRANGE(Type,ReturnOrderLine.Type::Item);
          ReturnOrderLine.SETRANGE("DHL Shipment Number",DHLShipment);
          IF NOT ReturnOrderLine.ISEMPTY THEN BEGIN
            ReturnOrderLine.FINDLAST;
            UpdateLinesReturnOrder(ReturnOrderLine,
                                   DHLShipment,
                                   AccNo,
                                   EventCode,
                                   RICCode,
                                   DeliveryDate,
                                   CommitDate,
                                   TimeStamp,
                                   ProcEntry);
          END ELSE BEGIN
            //S/P1133
            CASE FPCGeneralSetup."Active Parcel Status History" OF
              FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old":
                BEGIN
            //E/P1133
                  DHLParcelsStatusHistory.RESET;
                  DHLParcelsStatusHistory.SETRANGE("Piece-Code (Identifier)",DHLShipment);
                  IF DHLParcelsStatusHistory.FINDLAST THEN BEGIN
                    ReturnOrderLine.RESET;
                    ReturnOrderLine.SETRANGE("Document Type",ReturnOrderLine."Document Type"::"Return Order");
                    ReturnOrderLine.SETRANGE("Document No.",DHLParcelsStatusHistory."Document No.");
                    ReturnOrderLine.SETRANGE(Type,ReturnOrderLine.Type::Item);

                    // A/gob-lku/24.10.2012/P0490
                    //ReturnOrderLine.SETRANGE("DHL Shipment Number",DHLShipment);
                    ReturnOrderLine.SETRANGE("Line No.",DHLParcelsStatusHistory."Document Line No.");
                    // E/gob-lku/24.10.2012/P0490
                    IF NOT ReturnOrderLine.ISEMPTY THEN BEGIN
                      ReturnOrderLine.FINDLAST;
                      UpdateLinesReturnOrder(ReturnOrderLine,
                                             DHLShipment,
                                             AccNo,
                                             EventCode,
                                             RICCode,
                                             DeliveryDate,
                                             CommitDate,
                                             TimeStamp,
                                             ProcEntry);
                    END;
                  END;
            //S/P1133
                END;
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
              FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History":
                BEGIN
                  ParcelStatusHistory.RESET;
                  ParcelStatusHistory.SETRANGE("Piece Code",DHLShipment);
                  IF ParcelStatusHistory.FINDLAST THEN BEGIN
                    ReturnOrderLine.RESET;
                    ReturnOrderLine.SETRANGE("Document Type",ReturnOrderLine."Document Type"::"Return Order");
                    ReturnOrderLine.SETRANGE("Document No.",ParcelStatusHistory."Document No.");
                    ReturnOrderLine.SETRANGE(Type,ReturnOrderLine.Type::Item);
                    ReturnOrderLine.SETRANGE("Line No.",ParcelStatusHistory."Document Line No.");
                    IF NOT ReturnOrderLine.ISEMPTY THEN BEGIN
                      ReturnOrderLine.FINDLAST;
                      UpdateLinesReturnOrder(
                        ReturnOrderLine,
                        DHLShipment,
                        AccNo,
                        EventCode,
                        RICCode,
                        DeliveryDate,
                        CommitDate,
                        TimeStamp,
                        ProcEntry);
                    END;
                  END;
                END;
            END;
            //E/P1133

          END;
        END;
        //E/gob-rste/10.09.12/P0302
      END;
      EXIT(TRUE);
      //E/gob-rste/03.08.12/P0133
    END;

    PROCEDURE ProcessIntTable@1000000005();
    VAR
      ImpDoc@1000000001 : Record 50034;
      ImpDocLine@1000000000 : Record 50035;
      ImpDoc2@1000000009 : Record 50034;
      DeliveryDate@1000000008 : Text[10];
      CommitDate@1000000007 : Text[10];
      SONo@1000000006 : Code[40];
      EventCode@1000000005 : Code[10];
      RICCode@1000000004 : Code[10];
      AccNo@1000000003 : Text[40];
      DHLShipment@1000000002 : Text[50];
      TimeStamp@1000000010 : Text[30];
      PLZ@1000000011 : Text[10];
    BEGIN
      ImpDoc.RESET;
      ImpDoc.SETCURRENTKEY(Interface,Imported,Complete,"Import Framework Code","Document No.");
      ImpDoc.SETRANGE(Interface,Interface.Code);
      ImpDoc.SETRANGE(Imported,TRUE);
      ImpDoc.SETRANGE(Complete,FALSE);
      //DYN0008 08.08.12  nas run only new entries >>
      IF NOT ProcessErrors THEN
        ImpDoc.SETRANGE(Error,FALSE);
      //DYN0008 08.08.12  nas run only new entries <<

      //A/gob-adb/15.05.13
      //ImpDoc.MODIFYALL("Error Message",'');
      //IF ImpDoc.FINDSET(TRUE,TRUE) THEN

      IF NOT ImpDoc.ISEMPTY THEN
        ImpDoc.MODIFYALL("Error Message",'');

      IF ImpDoc.FIND('-') THEN
      //E/gob-adb/15.05.13
        REPEAT

          IF ImpDocLine.GET(ImpDoc."Entry No.",10000) THEN DHLShipment := ImpDocLine."Field Value";
          IF ImpDocLine.GET(ImpDoc."Entry No.",20000) THEN AccNo := ImpDocLine."Field Value";
          IF ImpDocLine.GET(ImpDoc."Entry No.",30000) THEN SONo := ImpDocLine."Field Value";
          IF ImpDocLine.GET(ImpDoc."Entry No.",40000) THEN CommitDate := ImpDocLine."Field Value";
          IF ImpDocLine.GET(ImpDoc."Entry No.",50000) THEN DeliveryDate := ImpDocLine."Field Value";
          IF ImpDocLine.GET(ImpDoc."Entry No.",60000) THEN EventCode := ImpDocLine."Field Value";
          IF ImpDocLine.GET(ImpDoc."Entry No.",70000) THEN RICCode := ImpDocLine."Field Value";
          IF ImpDocLine.GET(ImpDoc."Entry No.",80000) THEN TimeStamp := ImpDocLine."Field Value";

          IF Process(SONo,DHLShipment,AccNo,EventCode,RICCode,DeliveryDate,CommitDate,TimeStamp,ImpDoc."Entry No.",PLZ) THEN BEGIN
            ImpDoc2.GET(ImpDoc."Entry No.");
            ImpDoc2.Complete := TRUE;
            ImpDoc2.Error := FALSE;
            //ImpDoc2."Error Message" := '';
            ImpDoc2.MODIFY;
            COMMIT;
          END ELSE BEGIN
            ImpDoc2.GET(ImpDoc."Entry No.");
            ImpDoc2.Complete := FALSE;
            ImpDoc2.Error := TRUE;
            ImpDoc2."Error Message" := ErrorMessage;
            ImpDoc2.MODIFY;
            COMMIT;
          END;

        UNTIL ImpDoc.NEXT = 0;
    END;

    PROCEDURE InsertLogEntry@1113800003(OrderNo@1000000001 : Code[20];MsgText@1113800000 : Text[250];ProcEntry@1000000004 : Integer;IsError@1113800002 : Boolean;NewImportNo@1000000003 : Boolean);
    VAR
      ImportLog@1000000005 : Record 50013;
      ErrorText@1113800004 : Text[1024];
      LastImportNo@1000000000 : Integer;
      intVar@1000000002 : Integer;
    BEGIN
      //H1006  14.04.14  MBY  ++++++++++++++++++++++++++++
      RhenusSetup.GET;
      IF NOT RhenusSetup."Disable Import Framework Log" THEN BEGIN
      //H1006  14.04.14  MBY  ----------------------------
        ImportLog.RESET;
        IF ImportLog.FINDLAST THEN
          LastImportNo := ImportLog."Import No."
        ELSE
          LastImportNo := 0;

        IF NewImportNo THEN
          LastImportNo += 1;

        ImportLog.INIT;
        ImportLog."Entry No." := 0;
        ImportLog.Date := TODAY;
        ImportLog.Time := TIME;
        ImportLog."Import No." := LastImportNo;
        ImportLog.Interface := 'EASYLOG';
        ImportLog."Import\Export" := ImportLog."Import\Export"::Import;
        ImportLog."Document No." := OrderNo;
        ImportLog."Document Type" := ImportLog."Document Type"::Order;
        ImportLog."Proc. Entry No." := ProcEntry;

        IF IsError THEN
          ImportLog.Type := ImportLog.Type::Error
        ELSE
          ImportLog.Type := ImportLog.Type::Message;

        ImportLog."Message Text" := MsgText;
        ImportLog.INSERT;
      //H1006  14.04.14  MBY  ++++++++++++++++++++++++++++
      END;
      //H1006  14.04.14  MBY  ----------------------------
    END;

    PROCEDURE FTPDownload@1000000014() : Boolean;
    VAR
      FTPClient@1000000000 : Automation "{42A8A505-1CD3-4CA4-A7EA-E6EBCC481DDC} 1.0:{B32A3669-654B-4CEF-980E-C7753F1FA524}:'FTPNav'.FTPNavClass";
    BEGIN
      IF ISCLEAR(FTPClient) THEN CREATE(FTPClient);
      IF NOT FTPClient.DownloadDirectory(
              Interface."FTP Import Address",
              Interface."FTP Import User",
              Interface."FTP Import Password",
              Interface."FTP Import Folder",
              Interface."Import Folder",
              TRUE,FALSE)
      THEN BEGIN
        InsertLogEntry('',Text006, 0, TRUE, FALSE);
        InsertLogEntry('',FTPClient.GetLastErrorText, 0, TRUE, FALSE);
        EXIT(FALSE);
      END;
      EXIT(TRUE);
    END;

    PROCEDURE UpdateLinesGER7@1000000011(p_SalesLine@1000000000 : Record 37;DHLShipment@1000000009 : Text[50];AccNo@1000000008 : Text[40];EventCode@1000000007 : Code[10];RICCode@1000000006 : Code[10];DeliveryDate@1000000005 : Text[10];CommitDate@1000000004 : Text[10];TimeStamp@1000000003 : Text[30];ProcEntry@1000000002 : Integer);
    VAR
      SalesLineLoc@1000000001 : Record 37;
      SalesHeaderLoc@1000000016 : Record 36;
      DHLParcelsStatusHistory@1000000010 : Record 50021;
      dateVar@1000000011 : Date;
      dayVar@1000000012 : Integer;
      MonthVar@1000000013 : Integer;
      YearVar@1000000014 : Integer;
      TimeVar@1000000015 : Time;
      InterfaceProcessMgt@1000000017 : Codeunit 50087;
      ParcelStatusHistory@1000000018 : Record 80013;
      RecRef@1000000019 : RecordRef;
      DateCommit@1000000020 : Date;
      DateDelivery@1000000021 : Date;
      "**** HME ****************"@1000000022 : Integer;
      InterfaceTimeStampL@1000000023 : DateTime;
    BEGIN
      //S/P1133
      FPCGeneralSetup.GET;
      //E/P1133

      SalesLineLoc.RESET;
      SalesLineLoc.SETRANGE("Document Type",p_SalesLine."Document Type");
      SalesLineLoc.SETRANGE("Document No.",p_SalesLine."Document No.");
      SalesLineLoc.SETRANGE(Type,SalesLineLoc.Type::Item);
      SalesLineLoc.SETFILTER("No.",'<>%1','');
      // S/P1142
      {
      SalesLineLoc.SETRANGE("Vendor No.",p_SalesLine."Vendor No.");
      //A/gob-rste/31.10.12/P0538
      //SalesLineLoc.SETRANGE("Purchasing Code",'GER-7');
      // A/gob-lku/08.01.2013/P0726
      //SalesLineLoc.SETFILTER("Purchasing Code",'GER-7|GER-12');
      // S/gob-lku/13.06.13/P0963
      //SalesLineLoc.SETFILTER("Purchasing Code",'*-7|*-12');
      SalesLineLoc.SETFILTER("Purchasing Code",'*-7|*-12|*-13');
      // E/gob-lku/13.06.13/P0963
      // E/gob-lku/08.01.2013/P0726
      //E/gob-rste/31.10.12/P0538
      }
      SalesLineLoc.SETRANGE("Line No.",p_SalesLine."Line No.");

      //H0733  26.11.13  ABR  +++++++++++++++++++++++++++++++++
      IF SalesLineLoc.FINDFIRST THEN;
      //H0733  26.11.13  ABR  ---------------------------------

      IF ((EventCode IN ['CNRFC','DLVRD','DLVRF','HLDCC','HNDDE','HNDND','OFWRD'])
      OR ((EventCode = 'NTDEL') AND (RICCode IN ['CNCNR','CPUNK','MOVED','NHOME','NTCCN','NTORD','OTHER']))
      OR ((EventCode = 'RETRN') AND (RICCode IN ['CNCNR','NTCCN','NTORD']))) THEN
        CheckOtherSalesLines(SalesLineLoc);
      // E/P1142

      IF SalesLineLoc.FIND('-') THEN BEGIN
        REPEAT
          SalesLineLoc."DHL Shipment Number" := DHLShipment;
          SalesLineLoc."Status Event Code" := EventCode;
          SalesLineLoc."Status Code" := RICCode;
          SalesLineLoc.MODIFY;
          //A/P0564
          IF (EventCode <> 'DLVRD') AND (SalesLineLoc."Purchasing Code" <> '') THEN BEGIN
            CLEAR(InterfaceProcessMgt);
            FPCGeneralSetup.GET;
            FPCGeneralSetup.TESTFIELD("Status Transport");
            FPCGeneralSetup.TESTFIELD("Status Pick");
            IF InterfaceProcessMgt.TriggerActive(FPCGeneralSetup."Trigger DHL Pro Active") THEN
              InterfaceProcessMgt.UpdateProcessLogForInterface(SalesLineLoc."Document No.",
                                                               SalesLineLoc."Line No.",
                                                               InterfaceProcessMgt.GetInterfaceFromPurchCode
                                                                                   (SalesLineLoc."Purchasing Code"),
                                                               FPCGeneralSetup."Status Pick",
                                                               FPCGeneralSetup."Status Transport",
                                                               FPCGeneralSetup."Trigger DHL Pro Active");
          END;
          //E/P0564
          //S/P1117
          //S/P1133
          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New"]
          THEN BEGIN
          //E/P1133
            CLEAR(DHLParcelsStatusHistory);
            DHLParcelsStatusHistory.RESET;
            //A/gob-adb/16.05.13
            DHLParcelsStatusHistory.SETCURRENTKEY("Document No.");
            //E/gob-adb/16.05.13
            DHLParcelsStatusHistory.SETRANGE("DHL Shipment Code",UPPERCASE(DHLShipment));
            // A/gob-lku/04.09.2012/P0276
            //DHLParcelsStatusHistory.SETRANGE("Account Number",AccNo);
            // E/gob-lku/04.09.2012/P0276
            DHLParcelsStatusHistory.SETRANGE("Document Line No.",SalesLineLoc."Line No.");
            DHLParcelsStatusHistory.SETRANGE("Document No.",SalesLineLoc."Document No.");
            DHLParcelsStatusHistory.SETRANGE("Status Event",EventCode);
            DHLParcelsStatusHistory.SETRANGE("Status Code",RICCode);

            // A/gob-lku/19.09.12/P0353
            dateVar := WORKDATE;
            //19.07.12  nas changed date format >>
            IF STRLEN(TimeStamp) > 13 THEN
              IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                IF EVALUATE(MonthVar,COPYSTR(TimeStamp,6,2))THEN
                  IF EVALUATE(YearVar,COPYSTR(TimeStamp,1,4)) THEN
                    dateVar := DMY2DATE(dayVar,MonthVar,YearVar);
            //19.07.12  nas changed date format <<
            IF NOT EVALUATE(TimeVar,COPYSTR(TimeStamp,12,8)) THEN
              TimeVar := TIME;

            // A/gob-lku/26.10.12/P0524
            //ParcelStatusDHL.SETRANGE("Time Stamp",CREATEDATETIME(dateVar,timeVar));
            DHLParcelsStatusHistory.SETRANGE("Time Stamp",ROUNDDATETIME(CREATEDATETIME(dateVar,TimeVar),100000,'<')
                ,ROUNDDATETIME(CREATEDATETIME(dateVar,TimeVar),100000,'>'));
            // E/gob-lku/26.10.12/P0524

            // E/gob-lku/19.09.12/P0353

            IF NOT DHLParcelsStatusHistory.FINDFIRST THEN BEGIN
              DHLParcelsStatusHistory."Entry No." := 0;
              DHLParcelsStatusHistory."DHL Shipment Code" := UPPERCASE(DHLShipment);
              DHLParcelsStatusHistory."Account Number" := AccNo;
              DHLParcelsStatusHistory."Document Line No." := SalesLineLoc."Line No.";
              DHLParcelsStatusHistory."Document No." := SalesLineLoc."Document No.";
              DHLParcelsStatusHistory."Document Type" := DHLParcelsStatusHistory."Document Type"::Order;

              // A/gob-lku/19.09.12/P0353     Vorgelagert fr Filterung nach Time Stamp
              {
              dateVar := WORKDATE;
              IF STRLEN(TimeStamp) > 13 THEN
                IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                  IF EVALUATE(MonthVar,COPYSTR(TimeStamp,6,2))THEN
                    IF EVALUATE(YearVar,COPYSTR(TimeStamp,1,4)) THEN
                      dateVar := DMY2DATE(dayVar,MonthVar,YearVar);
              IF NOT EVALUATE(TimeVar,COPYSTR(TimeStamp,12,8)) THEN
                TimeVar := TIME;
              }
              // E/gob-lku/19.09.12/P0353     Vorgelagert fr Filterung nach Time Stamp

              DHLParcelsStatusHistory."Time Stamp" := CREATEDATETIME(dateVar,TimeVar);

              // A/10.10.12/gob-lku/P0429
              DHLParcelsStatusHistory."Import Time Stamp" := CURRENTDATETIME;
              DHLParcelsStatusHistory."Time Difference" := DHLParcelsStatusHistory."Time Stamp"
                                                          - DHLParcelsStatusHistory."Import Time Stamp";
              DHLParcelsStatusHistory."Status DHL" := TRUE;
              IF SalesHeaderLoc.GET(SalesLineLoc."Document Type",SalesLineLoc."Document No.") THEN
                DHLParcelsStatusHistory."Order Date" := SalesHeaderLoc."Order Date";
              DHLParcelsStatusHistory."Shipment through" := DHLParcelsStatusHistory."Shipment through"::DHL;
              // E/10.10.12/gob-lku/P0429
              // S/gob-lku/13.08.2013/P1051
              DHLParcelsStatusHistory."Shipping Agent" := 'DHL';
              // E/gob-lku/13.08.2013/P1051

              DHLParcelsStatusHistory."Current Status" := TRUE;
              DHLParcelsStatusHistory."Status Event" := EventCode;
              DHLParcelsStatusHistory."Status Code" := RICCode;

              IF EVALUATE(dayVar,COPYSTR(CommitDate,7,2)) THEN
                IF EVALUATE(MonthVar,COPYSTR(CommitDate,5,2))THEN
                  IF EVALUATE(YearVar,COPYSTR(CommitDate,1,4)) THEN
                    DHLParcelsStatusHistory."Commit at Date" := DMY2DATE(dayVar,MonthVar,YearVar);

              IF EVALUATE(dayVar,COPYSTR(DeliveryDate,7,2)) THEN
                IF EVALUATE(MonthVar,COPYSTR(DeliveryDate,5,2))THEN
                  IF EVALUATE(YearVar,COPYSTR(DeliveryDate,1,4)) THEN
                    DHLParcelsStatusHistory."Delivery Date" := DMY2DATE(dayVar,MonthVar,YearVar);

              // S/gob-lku/13.06.13/P0963
              IF SalesLineLoc."Drop Shipment" THEN BEGIN
                DHLParcelsStatusHistory."Purchase Order Code" := SalesLineLoc."Purchase Order No.";
                DHLParcelsStatusHistory."PO Line No." := SalesLineLoc."Purch. Order Line No.";
              END;
              // E/gob-lku/13.06.13/P0963

              //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
              {
              //H0686  04.12.13  MBY  ----------------------------
              DHLParcelsStatusHistory.INSERT;
              //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
              }
              DHLParcelsStatusHistory.INSERT(TRUE);
              //H0686  04.12.13  MBY  ----------------------------
              //S/P1133
              IF FPCGeneralSetup."Active Parcel Status History" IN
                [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
                FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old"]
              THEN
              //E/P1133
                InsertLogEntry(SalesLineLoc."Document No.",STRSUBSTNO(Text007,SalesLineLoc."Document No."), ProcEntry, FALSE, FALSE);
            END;
          //S/P1133
          END;

          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
            FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
          THEN BEGIN
          //E/P1133
            CLEAR(ParcelStatusHistory);
            WITH ParcelStatusHistory DO BEGIN
              SETCURRENTKEY("Document No.","Document Line No.","Document Type");
              SETRANGE("Document No.",SalesLineLoc."Document No.");
              SETRANGE("Document Line No.",SalesLineLoc."Line No.");
              SETRANGE("Document Type",SalesLineLoc."Document Type");
              SETRANGE("Tracking Code",UPPERCASE(DHLShipment));
              SETRANGE("Status Code",EventCode);
              SETRANGE("Status Sub Code",RICCode);
              dateVar := WORKDATE;
              IF STRLEN(TimeStamp) > 13 THEN
                IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                  IF EVALUATE(MonthVar,COPYSTR(TimeStamp,6,2))THEN
                    IF EVALUATE(YearVar,COPYSTR(TimeStamp,1,4)) THEN
                      dateVar := DMY2DATE(dayVar,MonthVar,YearVar);
              IF NOT EVALUATE(TimeVar,COPYSTR(TimeStamp,12,8)) THEN
                TimeVar := TIME;
              //H1379 18.09.14 EHN +++++++++++++++++++++++++++++++++
              InterfaceTimeStampL := CREATEDATETIME(dateVar,TimeVar);
              //H1379 18.09.14 EHN ---------------------------------
              SETRANGE("Timestamp Insert",
                ROUNDDATETIME(CREATEDATETIME(dateVar,TimeVar),100000,'<'),
                ROUNDDATETIME(CREATEDATETIME(dateVar,TimeVar),100000,'>'));
              IF ISEMPTY THEN BEGIN
                CLEAR(CUParcelStatusHistoryMgmt);
                CLEAR(DateCommit);
                CLEAR(DateDelivery);
                RecRef.GETTABLE(SalesLineLoc);
                IF EVALUATE(dayVar,COPYSTR(CommitDate,7,2)) THEN
                  IF EVALUATE(MonthVar,COPYSTR(CommitDate,5,2))THEN
                    IF EVALUATE(YearVar,COPYSTR(CommitDate,1,4)) THEN
                      DateCommit := DMY2DATE(dayVar,MonthVar,YearVar);
                IF EVALUATE(dayVar,COPYSTR(DeliveryDate,7,2)) THEN
                  IF EVALUATE(MonthVar,COPYSTR(DeliveryDate,5,2))THEN
                    IF EVALUATE(YearVar,COPYSTR(DeliveryDate,1,4)) THEN
                      DateDelivery := DMY2DATE(dayVar,MonthVar,YearVar);
                CUParcelStatusHistoryMgmt.SetDateGlobals(0D,DateDelivery,DateCommit);
                CUParcelStatusHistoryMgmt.SetAccountNo(AccNo);
                //H1379 18.09.14 EHN +++++++++++++++++++++++++++++++++++++++++
                //CUParcelStatusHistoryMgmt.SetDateTimeGlobal(CURRENTDATETIME);
                CUParcelStatusHistoryMgmt.SetDateTimeGlobal(InterfaceTimeStampL);
                //H1379 18.09.14 EHN -----------------------------------------
                CUParcelStatusHistoryMgmt.FillHistoryByDocLine(
                  RecRef,                 // Rec
                  1,                      // p_Command
                  0,                      // p_InfoDirection::  Incoming,Outgoing
                  2,                      // p_UsedInterface::  ,EDI,DHL,DocData,Drop Shipment,Rhenus,UPS
                  'DHL',                  // p_ShippingAgentCode
                  UPPERCASE(DHLShipment), // p_TrackingCode
                  '',                     // p_PieceCode
                  EventCode,              // p_StatusCode
                  RICCode,                // p_StatusRICCode
                  '',                     // p_Comment
                  0);                     // p_HandleStatusDescription
            //S/P1133
            END;
            IF FPCGeneralSetup."Active Parcel Status History" IN
              [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
              FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
            THEN
              InsertLogEntry(SalesLineLoc."Document No.",STRSUBSTNO(Text007,SalesLineLoc."Document No."), ProcEntry, FALSE, FALSE);
            //E/P1133
            END;
          END;
          //E/P1117
        UNTIL SalesLineLoc.NEXT = 0;
      END;
    END;

    PROCEDURE UpdateLinesGER9@1000000006(p_SalesLine@1000000000 : Record 37;DHLShipment@1000000009 : Text[50];AccNo@1000000008 : Text[40];EventCode@1000000007 : Code[10];RICCode@1000000006 : Code[10];DeliveryDate@1000000005 : Text[10];CommitDate@1000000004 : Text[10];TimeStamp@1000000003 : Text[30];ProcEntry@1000000002 : Integer);
    VAR
      SalesLineLoc@1000000001 : Record 37;
      SalesHeaderLoc@1000000016 : Record 36;
      DHLParcelsStatusHistory@1000000010 : Record 50021;
      dateVar@1000000011 : Date;
      dayVar@1000000012 : Integer;
      MonthVar@1000000013 : Integer;
      YearVar@1000000014 : Integer;
      TimeVar@1000000015 : Time;
      FPCMgt@1000000017 : Codeunit 50003;
      FPCGeneralSetup@1000000018 : Record 50055;
      InterfaceProcessMgt@1000000019 : Codeunit 50087;
      ParcelStatusHistory@1000000020 : Record 80013;
      RecRef@1000000021 : RecordRef;
      DateDelivery@1000000022 : Date;
      DateCommit@1000000023 : Date;
      ShippingAgent@1000000024 : Code[10];
      "**** HME ****************"@1000000026 : Integer;
      InterfaceTimeStampL@1000000025 : DateTime;
    BEGIN
      //S/P1133
      FPCGeneralSetup.GET;
      //E/P1133

      SalesLineLoc.RESET;
      SalesLineLoc.SETRANGE("Document Type",p_SalesLine."Document Type");
      SalesLineLoc.SETRANGE("Document No.",p_SalesLine."Document No.");
      SalesLineLoc.SETRANGE(Type,SalesLineLoc.Type::Item);
      SalesLineLoc.SETFILTER("No.",'<>%1','');
      // A/gob-lku/08.11.2012/P0566
      //SalesLineLoc.SETRANGE("Vendor No.",p_SalesLine."Vendor No.");
      // E/gob-lku/08.11.2012/P0566

      // A/gob-lku/30.10.2012/P0531
      //SalesLineLoc.SETRANGE("Purchasing Code",'GER-9');
      // A/gob-lku/08.01.2013/P0726
      //SalesLineLoc.SETFILTER("Purchasing Code",'GER-9|NL-9|FRA-9');
      // S/P1142
      //SalesLineLoc.SETFILTER("Purchasing Code",'*-9');
      // E/gob-lku/08.01.2013/P0726
      // E/gob-lku/30.10.2012/P0531

      SalesLineLoc.SETRANGE("Line No.",p_SalesLine."Line No.");

      //H0733  26.11.13  ABR  +++++++++++++++++++++++++++++++++
      IF SalesLineLoc.FINDFIRST THEN;
      //H0733  26.11.13  ABR  ---------------------------------

      IF ((EventCode IN ['CNRFC','DLVRD','DLVRF','HLDCC','HNDDE','HNDND','OFWRD'])
      OR ((EventCode = 'NTDEL') AND (RICCode IN ['CNCNR','CPUNK','MOVED','NHOME','NTCCN','NTORD','OTHER']))
      OR ((EventCode = 'RETRN') AND (RICCode IN ['CNCNR','NTCCN','NTORD']))) THEN
        CheckOtherSalesLines(SalesLineLoc);
      // E/P1142

      IF SalesLineLoc.FIND('-') THEN BEGIN
        REPEAT
          SalesLineLoc."DHL Shipment Number" := DHLShipment;
          SalesLineLoc."Status Event Code" := EventCode;
          SalesLineLoc."Status Code" := RICCode;
          SalesLineLoc.MODIFY;
          //A/P0564
          IF (EventCode <> 'DLVRD') AND (SalesLineLoc."Purchasing Code" <> '') THEN BEGIN
            CLEAR(InterfaceProcessMgt);
            FPCGeneralSetup.GET;
            FPCGeneralSetup.TESTFIELD("Status Transport");
            FPCGeneralSetup.TESTFIELD("Status Pick");
            IF InterfaceProcessMgt.TriggerActive(FPCGeneralSetup."Trigger DHL Pro Active") THEN
              InterfaceProcessMgt.UpdateProcessLogForInterface(SalesLineLoc."Document No.",
                                                               SalesLineLoc."Line No.",
                                                               InterfaceProcessMgt.GetInterfaceFromPurchCode(
                                                                                   SalesLineLoc."Purchasing Code"),
                                                               FPCGeneralSetup."Status Pick",
                                                               FPCGeneralSetup."Status Transport",
                                                               FPCGeneralSetup."Trigger DHL Pro Active");
          END;
          //E/P0564

          //S/P1117
          //S/P1133
          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New"]
          THEN BEGIN
          //E/P1133
            CLEAR(DHLParcelsStatusHistory);
            DHLParcelsStatusHistory.RESET;
            //A/gob-adb/16.05.13
            DHLParcelsStatusHistory.SETCURRENTKEY("Document No.");
            //E/gob-adb/16.05.13
            DHLParcelsStatusHistory.SETRANGE("DHL Shipment Code",UPPERCASE(DHLShipment));
            // A/gob-lku/04.09.2012/P0276
            //DHLParcelsStatusHistory.SETRANGE("Account Number",AccNo);
            // E/gob-lku/04.09.2012/P0276
            DHLParcelsStatusHistory.SETRANGE("Document Line No.",SalesLineLoc."Line No.");
            DHLParcelsStatusHistory.SETRANGE("Document No.",SalesLineLoc."Document No.");
            DHLParcelsStatusHistory.SETRANGE("Status Event",EventCode);
            DHLParcelsStatusHistory.SETRANGE("Status Code",RICCode);

            // A/gob-lku/19.09.12/P0353
            dateVar := WORKDATE;
            //19.07.12  nas changed date format >>
            IF STRLEN(TimeStamp) > 13 THEN
              IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                IF EVALUATE(MonthVar,COPYSTR(TimeStamp,6,2))THEN
                  IF EVALUATE(YearVar,COPYSTR(TimeStamp,1,4)) THEN
                    dateVar := DMY2DATE(dayVar,MonthVar,YearVar);
            //19.07.12  nas changed date format <<
            IF NOT EVALUATE(TimeVar,COPYSTR(TimeStamp,12,8)) THEN
              TimeVar := TIME;

            // A/gob-lku/26.10.12/P0524
            //ParcelStatusDHL.SETRANGE("Time Stamp",CREATEDATETIME(dateVar,timeVar));
            DHLParcelsStatusHistory.SETRANGE("Time Stamp",ROUNDDATETIME(CREATEDATETIME(dateVar,TimeVar),100000,'<')
                ,ROUNDDATETIME(CREATEDATETIME(dateVar,TimeVar),100000,'>'));
            // E/gob-lku/26.10.12/P0524

            // E/gob-lku/19.09.12/P0353

            IF NOT DHLParcelsStatusHistory.FINDFIRST THEN BEGIN
              DHLParcelsStatusHistory."Entry No." := 0;
              DHLParcelsStatusHistory."DHL Shipment Code" := UPPERCASE(DHLShipment);
              DHLParcelsStatusHistory."Account Number" := AccNo;
              DHLParcelsStatusHistory."Document Line No." := SalesLineLoc."Line No.";
              DHLParcelsStatusHistory."Document No." := SalesLineLoc."Document No.";
              DHLParcelsStatusHistory."Document Type" := DHLParcelsStatusHistory."Document Type"::Order;

              // A/gob-lku/19.09.12/P0353     Vorgelagert fr Filterung nach Time Stamp
              {
              dateVar := WORKDATE;
              IF STRLEN(TimeStamp) > 13 THEN
                IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                  IF EVALUATE(MonthVar,COPYSTR(TimeStamp,6,2))THEN
                    IF EVALUATE(YearVar,COPYSTR(TimeStamp,1,4)) THEN
                      dateVar := DMY2DATE(dayVar,MonthVar,YearVar);
              IF NOT EVALUATE(TimeVar,COPYSTR(TimeStamp,12,8)) THEN
                TimeVar := TIME;
              }
              // E/gob-lku/19.09.12/P0353     Vorgelagert fr Filterung nach Time Stamp

              DHLParcelsStatusHistory."Time Stamp" := CREATEDATETIME(dateVar,TimeVar);

              // A/10.10.12/gob-lku/P0429
              DHLParcelsStatusHistory."Import Time Stamp" := CURRENTDATETIME;
              DHLParcelsStatusHistory."Time Difference" := DHLParcelsStatusHistory."Time Stamp"
                                                          - DHLParcelsStatusHistory."Import Time Stamp";
              DHLParcelsStatusHistory."Status DHL" := TRUE;
              IF SalesHeaderLoc.GET(SalesLineLoc."Document Type",SalesLineLoc."Document No.") THEN
                DHLParcelsStatusHistory."Order Date" := SalesHeaderLoc."Order Date";
              DHLParcelsStatusHistory."Shipment through" := DHLParcelsStatusHistory."Shipment through"::DHL;
              // E/10.10.12/gob-lku/P0429
              // S/gob-lku/13.08.2013/P1051
              DHLParcelsStatusHistory."Shipping Agent" := 'DHL';
              // E/gob-lku/13.08.2013/P1051

              DHLParcelsStatusHistory."Current Status" := TRUE;
              DHLParcelsStatusHistory."Status Event" := EventCode;
              DHLParcelsStatusHistory."Status Code" := RICCode;

              //A,gob-dst,21.08.2012,P0217
              //A,gob-dst,23.08.2012,P0227
              //DHLParcelsStatusHistory."Docdata Status Description" := DHLParcelsStatusHistory."Status Event";
              DHLParcelsStatusHistory.CALCFIELDS("Status Event Name");
              DHLParcelsStatusHistory."Docdata Status Description" := DHLParcelsStatusHistory."Status Event Name";
              //E,gob-dst,23.08.2012,P0227
              //E,gob-dst,21.08.2012,P0217

              IF EVALUATE(dayVar,COPYSTR(CommitDate,7,2)) THEN
                IF EVALUATE(MonthVar,COPYSTR(CommitDate,5,2))THEN
                  IF EVALUATE(YearVar,COPYSTR(CommitDate,1,4)) THEN
                    DHLParcelsStatusHistory."Commit at Date" := DMY2DATE(dayVar,MonthVar,YearVar);

              IF EVALUATE(dayVar,COPYSTR(DeliveryDate,7,2)) THEN
                IF EVALUATE(MonthVar,COPYSTR(DeliveryDate,5,2))THEN
                  IF EVALUATE(YearVar,COPYSTR(DeliveryDate,1,4)) THEN
                    DHLParcelsStatusHistory."Delivery Date" := DMY2DATE(dayVar,MonthVar,YearVar);

              // A/gob-lku/11.01.2013/P0734
              DHLParcelsStatusHistory."Shipping Agent" := FPCMgt.GetShippingAgentSalesLine(SalesLineLoc,'DOCDATA');
              // E/gob-lku/11.01.2013/P0734

              // S/gob-lku/13.06.13/P0963
              IF SalesLineLoc."Drop Shipment" THEN BEGIN
                DHLParcelsStatusHistory."Purchase Order Code" := SalesLineLoc."Purchase Order No.";
                DHLParcelsStatusHistory."PO Line No." := SalesLineLoc."Purch. Order Line No.";
              END;
              // E/gob-lku/13.06.13/P0963

              //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
              {
              //H0686  04.12.13  MBY  ----------------------------
              DHLParcelsStatusHistory.INSERT;
              //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
              }
              DHLParcelsStatusHistory.INSERT(TRUE);
              //H0686  04.12.13  MBY  ----------------------------
              //S/P1133
              IF FPCGeneralSetup."Active Parcel Status History" IN
                [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
                FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old"]
              THEN
              //E/P1133
                InsertLogEntry(SalesLineLoc."Document No.",STRSUBSTNO(Text007,SalesLineLoc."Document No."), ProcEntry, FALSE, FALSE);
            END;
          //S/P1133
          END;

          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
            FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
          THEN BEGIN
          //E/P1133
            CLEAR(ParcelStatusHistory);
            WITH ParcelStatusHistory DO BEGIN
              SETCURRENTKEY("Document No.","Document Line No.","Document Type");
              SETRANGE("Document No.",SalesLineLoc."Document No.");
              SETRANGE("Document Line No.",SalesLineLoc."Line No.");
              SETRANGE("Document Type",SalesLineLoc."Document Type");
              SETRANGE("Tracking Code",UPPERCASE(DHLShipment));
              SETRANGE("Status Code",EventCode);
              SETRANGE("Status Sub Code",RICCode);
              dateVar := WORKDATE;
              IF STRLEN(TimeStamp) > 13 THEN
                IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                  IF EVALUATE(MonthVar,COPYSTR(TimeStamp,6,2))THEN
                    IF EVALUATE(YearVar,COPYSTR(TimeStamp,1,4)) THEN
                      dateVar := DMY2DATE(dayVar,MonthVar,YearVar);
              IF NOT EVALUATE(TimeVar,COPYSTR(TimeStamp,12,8)) THEN
                TimeVar := TIME;
              //H1379 18.09.14 EHN +++++++++++++++++++++++++++++++++
              InterfaceTimeStampL := CREATEDATETIME(dateVar,TimeVar);
              //H1379 18.09.14 EHN ---------------------------------
              SETRANGE("Timestamp Insert",
                ROUNDDATETIME(CREATEDATETIME(dateVar,TimeVar),100000,'<'),
                ROUNDDATETIME(CREATEDATETIME(dateVar,TimeVar),100000,'>'));
              IF ISEMPTY THEN BEGIN
                CLEAR(CUParcelStatusHistoryMgmt);
                CLEAR(DateCommit);
                CLEAR(DateDelivery);
                RecRef.GETTABLE(SalesLineLoc);
                ShippingAgent := FPCMgt.GetShippingAgentSalesLine(SalesLineLoc,'DOCDATA');
                IF EVALUATE(dayVar,COPYSTR(CommitDate,7,2)) THEN
                  IF EVALUATE(MonthVar,COPYSTR(CommitDate,5,2))THEN
                    IF EVALUATE(YearVar,COPYSTR(CommitDate,1,4)) THEN
                      DateCommit := DMY2DATE(dayVar,MonthVar,YearVar);
                IF EVALUATE(dayVar,COPYSTR(DeliveryDate,7,2)) THEN
                  IF EVALUATE(MonthVar,COPYSTR(DeliveryDate,5,2))THEN
                    IF EVALUATE(YearVar,COPYSTR(DeliveryDate,1,4)) THEN
                      DateDelivery := DMY2DATE(dayVar,MonthVar,YearVar);
                CUParcelStatusHistoryMgmt.SetDateGlobals(0D,DateDelivery,DateCommit);
                CUParcelStatusHistoryMgmt.SetAccountNo(AccNo);
                //H1379 18.09.14 EHN +++++++++++++++++++++++++++++++++++++++++
                //CUParcelStatusHistoryMgmt.SetDateTimeGlobal(CURRENTDATETIME);
                CUParcelStatusHistoryMgmt.SetDateTimeGlobal(InterfaceTimeStampL);
                //H1379 18.09.14 EHN -----------------------------------------
                CUParcelStatusHistoryMgmt.FillHistoryByDocLine(
                  RecRef,                 // Rec
                  1,                      // p_Command
                  0,                      // p_InfoDirection::  Incoming,Outgoing
                  3,                      // p_UsedInterface::  ,EDI,DHL,DocData,Drop Shipment,Rhenus,UPS
                  ShippingAgent,          // p_ShippingAgentCode
                  UPPERCASE(DHLShipment), // p_TrackingCode
                  '',                     // p_PieceCode
                  EventCode,              // p_StatusCode
                  RICCode,                // p_StatusRICCode
                  '',                     // p_Comment
                  0);                     // p_HandleStatusDescription
               END;
             END;
             IF FPCGeneralSetup."Active Parcel Status History" IN
               [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
               FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
             THEN
               InsertLogEntry(SalesLineLoc."Document No.",STRSUBSTNO(Text007,SalesLineLoc."Document No."), ProcEntry, FALSE, FALSE);
          END;
          //E/P1133
          //E/P1117
        UNTIL SalesLineLoc.NEXT = 0;
      END;
    END;

    PROCEDURE UpdateArchiveLinesGER9@1000000010(p_SalesLine@1000000000 : Record 5108;DHLShipment@1000000009 : Text[50];AccNo@1000000008 : Text[40];EventCode@1000000007 : Code[10];RICCode@1000000006 : Code[10];DeliveryDate@1000000005 : Text[10];CommitDate@1000000004 : Text[10];TimeStamp@1000000003 : Text[30];ProcEntry@1000000002 : Integer);
    VAR
      SalesLineLoc@1000000001 : Record 5108;
      SalesHeaderLoc@1000000016 : Record 5107;
      DHLParcelsStatusHistory@1000000010 : Record 50021;
      dateVar@1000000011 : Date;
      dayVar@1000000012 : Integer;
      MonthVar@1000000013 : Integer;
      YearVar@1000000014 : Integer;
      TimeVar@1000000015 : Time;
      FPCGeneralSetup@1000000017 : Record 50055;
      InterfaceProcessMgt@1000000018 : Codeunit 50087;
      ParcelStatusHistory@1000000019 : Record 50187;
      RecRef@1000000020 : RecordRef;
      DateCommit@1000000021 : Date;
      DateDelivery@1000000022 : Date;
      "**** HME ****************"@1000000024 : Integer;
      InterfaceTimeStampL@1000000023 : DateTime;
    BEGIN
      //S/P1133
      FPCGeneralSetup.GET;
      //E/P1133
      // A/gob-lku/30.10.2012/P0531
      SalesLineLoc.RESET;
      SalesLineLoc.SETRANGE("Document Type",p_SalesLine."Document Type");
      SalesLineLoc.SETRANGE("Document No.",p_SalesLine."Document No.");
      SalesLineLoc.SETRANGE(Type,SalesLineLoc.Type::Item);
      SalesLineLoc.SETFILTER("No.",'<>%1','');
      // A/gob-lku/08.11.2012/P0566
      //SalesLineLoc.SETRANGE("Vendor No.",p_SalesLine."Vendor No.");
      // E/gob-lku/08.11.2012/P0566
      // A/gob-lku/08.01.2013/P0726
      //SalesLineLoc.SETFILTER("Purchasing Code",'GER-9|NL-9|FRA-9');
      // S/P1142
      //SalesLineLoc.SETFILTER("Purchasing Code",'*-9');
      // E/gob-lku/08.01.2013/P0726

      SalesLineLoc.SETRANGE("Line No.",p_SalesLine."Line No.");

      //H0733  26.11.13  ABR  +++++++++++++++++++++++++++++++++
      IF SalesLineLoc.FINDFIRST THEN;
      //H0733  26.11.13  ABR  ---------------------------------

      IF ((EventCode IN ['CNRFC','DLVRD','DLVRF','HLDCC','HNDDE','HNDND','OFWRD'])
      OR ((EventCode = 'NTDEL') AND (RICCode IN ['CNCNR','CPUNK','MOVED','NHOME','NTCCN','NTORD','OTHER']))
      OR ((EventCode = 'RETRN') AND (RICCode IN ['CNCNR','NTCCN','NTORD']))) THEN
        CheckOtherArchivedSalesLines(SalesLineLoc);
      // E/P1142

      IF SalesLineLoc.FIND('-') THEN BEGIN
        REPEAT
          SalesLineLoc."DHL Shipment Number" := DHLShipment;
          SalesLineLoc."Status Event Code" := EventCode;
          SalesLineLoc."Status Code" := RICCode;
          SalesLineLoc.MODIFY;
          //A/P0564
          IF (EventCode <> 'DLVRD') AND (SalesLineLoc."Purchasing Code" <> '') THEN BEGIN
            CLEAR(InterfaceProcessMgt);
            FPCGeneralSetup.GET;
            FPCGeneralSetup.TESTFIELD("Status Transport");
            FPCGeneralSetup.TESTFIELD("Status Pick");
            IF InterfaceProcessMgt.TriggerActive(FPCGeneralSetup."Trigger DHL Pro Active") THEN
              InterfaceProcessMgt.UpdateProcessLogForInterface(SalesLineLoc."Document No.",
                                                               SalesLineLoc."Line No.",
                                                               InterfaceProcessMgt.GetInterfaceFromPurchCode(
                                                                                   SalesLineLoc."Purchasing Code"),
                                                               FPCGeneralSetup."Status Pick",
                                                               FPCGeneralSetup."Status Transport",
                                                               FPCGeneralSetup."Trigger DHL Pro Active");
          END;
          //E/P0564

          //S/P1117
          //S/P1133
          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New"]
          THEN BEGIN
          //E/P1133
            CLEAR(DHLParcelsStatusHistory);
            DHLParcelsStatusHistory.RESET;
            //A/gob-adb/16.05.13
            DHLParcelsStatusHistory.SETCURRENTKEY("Document No.");
            //E/gob-adb/16.05.13
            DHLParcelsStatusHistory.SETRANGE("DHL Shipment Code",UPPERCASE(DHLShipment));
            // A/gob-lku/04.09.2012/P0276
            //DHLParcelsStatusHistory.SETRANGE("Account Number",AccNo);
            // E/gob-lku/04.09.2012/P0276
            DHLParcelsStatusHistory.SETRANGE("Document Line No.",SalesLineLoc."Line No.");
            DHLParcelsStatusHistory.SETRANGE("Document No.",SalesLineLoc."Document No.");
            DHLParcelsStatusHistory.SETRANGE("Status Event",EventCode);
            DHLParcelsStatusHistory.SETRANGE("Status Code",RICCode);

            // A/gob-lku/19.09.12/P0353
            dateVar := WORKDATE;
            //19.07.12  nas changed date format >>
            IF STRLEN(TimeStamp) > 13 THEN
              IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                IF EVALUATE(MonthVar,COPYSTR(TimeStamp,6,2))THEN
                  IF EVALUATE(YearVar,COPYSTR(TimeStamp,1,4)) THEN
                    dateVar := DMY2DATE(dayVar,MonthVar,YearVar);
            //19.07.12  nas changed date format <<
            IF NOT EVALUATE(TimeVar,COPYSTR(TimeStamp,12,8)) THEN
              TimeVar := TIME;

            // A/gob-lku/26.10.12/P0524
            //ParcelStatusDHL.SETRANGE("Time Stamp",CREATEDATETIME(dateVar,timeVar));
            DHLParcelsStatusHistory.SETRANGE("Time Stamp",ROUNDDATETIME(CREATEDATETIME(dateVar,TimeVar),100000,'<')
                ,ROUNDDATETIME(CREATEDATETIME(dateVar,TimeVar),100000,'>'));
            // E/gob-lku/26.10.12/P0524

            // E/gob-lku/19.09.12/P0353

            IF NOT DHLParcelsStatusHistory.FINDFIRST THEN BEGIN
              DHLParcelsStatusHistory."Entry No." := 0;
              DHLParcelsStatusHistory."DHL Shipment Code" := UPPERCASE(DHLShipment);
              DHLParcelsStatusHistory."Account Number" := AccNo;
              DHLParcelsStatusHistory."Document Line No." := SalesLineLoc."Line No.";
              DHLParcelsStatusHistory."Document No." := SalesLineLoc."Document No.";
              DHLParcelsStatusHistory."Document Type" := DHLParcelsStatusHistory."Document Type"::Order;

              // A/gob-lku/19.09.12/P0353     Vorgelagert fr Filterung nach Time Stamp
              {
              dateVar := WORKDATE;
              IF STRLEN(TimeStamp) > 13 THEN
                IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                  IF EVALUATE(MonthVar,COPYSTR(TimeStamp,6,2))THEN
                    IF EVALUATE(YearVar,COPYSTR(TimeStamp,1,4)) THEN
                      dateVar := DMY2DATE(dayVar,MonthVar,YearVar);
              IF NOT EVALUATE(TimeVar,COPYSTR(TimeStamp,12,8)) THEN
                TimeVar := TIME;
              }
              // E/gob-lku/19.09.12/P0353     Vorgelagert fr Filterung nach Time Stamp

              DHLParcelsStatusHistory."Time Stamp" := CREATEDATETIME(dateVar,TimeVar);

              // A/10.10.12/gob-lku/P0429
              DHLParcelsStatusHistory."Import Time Stamp" := CURRENTDATETIME;
              DHLParcelsStatusHistory."Time Difference" := DHLParcelsStatusHistory."Time Stamp"
                                                          - DHLParcelsStatusHistory."Import Time Stamp";
              DHLParcelsStatusHistory."Status DHL" := TRUE;
              IF SalesHeaderLoc.GET(SalesLineLoc."Document Type",SalesLineLoc."Document No.",
                              SalesLineLoc."Doc. No. Occurrence",SalesLineLoc."Version No.") THEN
                DHLParcelsStatusHistory."Order Date" := SalesHeaderLoc."Order Date";
              DHLParcelsStatusHistory."Shipment through" := DHLParcelsStatusHistory."Shipment through"::DHL;
              // E/10.10.12/gob-lku/P0429
              // S/gob-lku/13.08.2013/P1051
              DHLParcelsStatusHistory."Shipping Agent" := 'DHL';
              // E/gob-lku/13.08.2013/P1051

              DHLParcelsStatusHistory."Current Status" := TRUE;
              DHLParcelsStatusHistory."Status Event" := EventCode;
              DHLParcelsStatusHistory."Status Code" := RICCode;

              //A,gob-dst,21.08.2012,P0217
              //A,gob-dst,23.08.2012,P0227
              //DHLParcelsStatusHistory."Docdata Status Description" := DHLParcelsStatusHistory."Status Event";
              DHLParcelsStatusHistory.CALCFIELDS("Status Event Name");
              DHLParcelsStatusHistory."Docdata Status Description" := DHLParcelsStatusHistory."Status Event Name";
              //E,gob-dst,23.08.2012,P0227
              //E,gob-dst,21.08.2012,P0217

              IF EVALUATE(dayVar,COPYSTR(CommitDate,7,2)) THEN
                IF EVALUATE(MonthVar,COPYSTR(CommitDate,5,2))THEN
                  IF EVALUATE(YearVar,COPYSTR(CommitDate,1,4)) THEN
                    DHLParcelsStatusHistory."Commit at Date" := DMY2DATE(dayVar,MonthVar,YearVar);

              IF EVALUATE(dayVar,COPYSTR(DeliveryDate,7,2)) THEN
                IF EVALUATE(MonthVar,COPYSTR(DeliveryDate,5,2))THEN
                  IF EVALUATE(YearVar,COPYSTR(DeliveryDate,1,4)) THEN
                    DHLParcelsStatusHistory."Delivery Date" := DMY2DATE(dayVar,MonthVar,YearVar);

              // S/gob-lku/13.06.13/P0963
              IF SalesLineLoc."Drop Shipment" THEN BEGIN
                DHLParcelsStatusHistory."Purchase Order Code" := SalesLineLoc."Purchase Order No.";
                DHLParcelsStatusHistory."PO Line No." := SalesLineLoc."Purch. Order Line No.";
              END;
              // E/gob-lku/13.06.13/P0963

              //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
              {
              //H0686  04.12.13  MBY  ----------------------------
              DHLParcelsStatusHistory.INSERT;
              //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
              }
              DHLParcelsStatusHistory.INSERT(TRUE);
              //H0686  04.12.13  MBY  ----------------------------
              //S/P1133
              IF FPCGeneralSetup."Active Parcel Status History" IN
                [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
                FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old"]
              THEN
              //E/P1133
                InsertLogEntry(SalesLineLoc."Document No.",STRSUBSTNO(Text007,SalesLineLoc."Document No."), ProcEntry, FALSE, FALSE);
            END;
          //S/P1133
          END;

          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
            FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
          THEN BEGIN
          //E/P1133
            CLEAR(ParcelStatusHistory);
            WITH ParcelStatusHistory DO BEGIN
              SETCURRENTKEY("Document No.","Document Line No.","Document Type");
              SETRANGE("Document No.",SalesLineLoc."Document No.");
              SETRANGE("Document Line No.",SalesLineLoc."Line No.");
              SETRANGE("Document Type",SalesLineLoc."Document Type");
              SETRANGE("Tracking Code",UPPERCASE(DHLShipment));
              SETRANGE("Status Code",EventCode);
              SETRANGE("Status Sub Code",RICCode);
              dateVar := WORKDATE;
              IF STRLEN(TimeStamp) > 13 THEN
                IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                  IF EVALUATE(MonthVar,COPYSTR(TimeStamp,6,2))THEN
                    IF EVALUATE(YearVar,COPYSTR(TimeStamp,1,4)) THEN
                      dateVar := DMY2DATE(dayVar,MonthVar,YearVar);
              IF NOT EVALUATE(TimeVar,COPYSTR(TimeStamp,12,8)) THEN
                TimeVar := TIME;
              //H1379 18.09.14 EHN +++++++++++++++++++++++++++++++++
              InterfaceTimeStampL := CREATEDATETIME(dateVar,TimeVar);
              //H1379 18.09.14 EHN ---------------------------------
              SETRANGE("Timestamp Insert",
                ROUNDDATETIME(CREATEDATETIME(dateVar,TimeVar),100000,'<'),
                ROUNDDATETIME(CREATEDATETIME(dateVar,TimeVar),100000,'>'));
              IF ISEMPTY THEN BEGIN
                CLEAR(CUParcelStatusHistoryMgmt);
                CLEAR(DateCommit);
                CLEAR(DateDelivery);
                RecRef.GETTABLE(SalesLineLoc);    // SalesLineLoc = Tbl. No. 5108
                IF EVALUATE(dayVar,COPYSTR(CommitDate,7,2)) THEN
                  IF EVALUATE(MonthVar,COPYSTR(CommitDate,5,2))THEN
                    IF EVALUATE(YearVar,COPYSTR(CommitDate,1,4)) THEN
                      DateCommit := DMY2DATE(dayVar,MonthVar,YearVar);
                IF EVALUATE(dayVar,COPYSTR(DeliveryDate,7,2)) THEN
                  IF EVALUATE(MonthVar,COPYSTR(DeliveryDate,5,2))THEN
                    IF EVALUATE(YearVar,COPYSTR(DeliveryDate,1,4)) THEN
                      DateDelivery := DMY2DATE(dayVar,MonthVar,YearVar);
                CUParcelStatusHistoryMgmt.SetDateGlobals(0D,DateDelivery,DateCommit);
                CUParcelStatusHistoryMgmt.SetAccountNo(AccNo);
                //H1379 18.09.14 EHN +++++++++++++++++++++++++++++++++++++++++
                //CUParcelStatusHistoryMgmt.SetDateTimeGlobal(CURRENTDATETIME);
                CUParcelStatusHistoryMgmt.SetDateTimeGlobal(InterfaceTimeStampL);
                //H1379 18.09.14 EHN -----------------------------------------
                CUParcelStatusHistoryMgmt.FillHistoryByDocLine(
                  RecRef,                 // Rec
                  1,                      // p_Command
                  0,                      // p_InfoDirection::  Incoming,Outgoing
                  2,                      // p_UsedInterface::  ,EDI,DHL,DocData,Drop Shipment,Rhenus,UPS
                  'DHL',                  // p_ShippingAgentCode
                  UPPERCASE(DHLShipment), // p_TrackingCode
                  '',                     // p_PieceCode
                  EventCode,              // p_StatusCode
                  RICCode,                // p_StatusRICCode
                  '',                     // p_Comment
                  0);                     // p_HandleStatusDescription
                //S/P1133
                IF FPCGeneralSetup."Active Parcel Status History" IN
                  [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
                  FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
                THEN
                //E/P1133
                  InsertLogEntry(SalesLineLoc."Document No.",STRSUBSTNO(Text007,SalesLineLoc."Document No."), ProcEntry, FALSE, FALSE);
                //S/P1129
                CUParcelStatusHistoryMgmt.MoveParcelInfosToArchive(
                  1,                            // p_Command::All,SalesDoc,PurchDoc,Date,EntryNo
                  SalesLineLoc."Document No.",  // p_DocNo
                  0,                            // p_LineNo
                  SalesLineLoc."Document Type", // p_DocType
                  '',                           // p_DateFilterString
                  0);                           // p_EntryNo
                //E/P1129
              END;
            END;
          //S/P1133
          END;
          //E/P1133
          //E/P1117
        UNTIL SalesLineLoc.NEXT = 0;
      END;
      // E/gob-lku/30.10.2012/P0531
    END;

    PROCEDURE UpdateArchiveLinesGER7@1000000024(p_SalesLine@1000000000 : Record 5108;DHLShipment@1000000009 : Text[50];AccNo@1000000008 : Text[40];EventCode@1000000007 : Code[10];RICCode@1000000006 : Code[10];DeliveryDate@1000000005 : Text[10];CommitDate@1000000004 : Text[10];TimeStamp@1000000003 : Text[30];ProcEntry@1000000002 : Integer);
    VAR
      SalesLineLoc@1000000001 : Record 5108;
      SalesHeaderLoc@1000000016 : Record 5107;
      DHLParcelsStatusHistory@1000000010 : Record 50021;
      dateVar@1000000011 : Date;
      dayVar@1000000012 : Integer;
      MonthVar@1000000013 : Integer;
      YearVar@1000000014 : Integer;
      TimeVar@1000000015 : Time;
      FPCGeneralSetup@1000000017 : Record 50055;
      InterfaceProcessMgt@1000000018 : Codeunit 50087;
      ParcelStatusHistoryArchive@1000000019 : Record 50187;
      RecRef@1000000020 : RecordRef;
      DateCommit@1000000021 : Date;
      DateDelivery@1000000022 : Date;
      "**** HME ****************"@1000000024 : Integer;
      InterfaceTimeStampL@1000000023 : DateTime;
    BEGIN
      //S/P1133
      FPCGeneralSetup.GET;
      //E/P1133

      // A/gob-lku/06.09.12/P0287
      SalesLineLoc.RESET;
      SalesLineLoc.SETRANGE("Document Type",p_SalesLine."Document Type");
      SalesLineLoc.SETRANGE("Document No.",p_SalesLine."Document No.");
      SalesLineLoc.SETRANGE(Type,SalesLineLoc.Type::Item);
      SalesLineLoc.SETFILTER("No.",'<>%1','');
      // S/P1142
      {
      SalesLineLoc.SETRANGE("Vendor No.",p_SalesLine."Vendor No.");
      //A/gob-rste/31.10.12/P0538
      //SalesLineLoc.SETRANGE("Purchasing Code",'GER-7');
      // A/gob-lku/08.01.2013/P0726
      //SalesLineLoc.SETFILTER("Purchasing Code",'GER-7|GER-12');
      // S/gob-lku/13.06.13/P0963
      //SalesLineLoc.SETFILTER("Purchasing Code",'*-7|*-12');
      SalesLineLoc.SETFILTER("Purchasing Code",'*-7|*-12|*-13');
      // E/gob-lku/13.06.13/P0963
      // E/gob-lku/08.01.2013/P0726
      //E/gob-rste/31.10.12/P0538
      }

      SalesLineLoc.SETRANGE("Line No.",p_SalesLine."Line No.");

      //H0733  26.11.13  ABR  +++++++++++++++++++++++++++++++++
      IF SalesLineLoc.FINDFIRST THEN;
      //H0733  26.11.13  ABR  ---------------------------------

      IF ((EventCode IN ['CNRFC','DLVRD','DLVRF','HLDCC','HNDDE','HNDND','OFWRD'])
      OR ((EventCode = 'NTDEL') AND (RICCode IN ['CNCNR','CPUNK','MOVED','NHOME','NTCCN','NTORD','OTHER']))
      OR ((EventCode = 'RETRN') AND (RICCode IN ['CNCNR','NTCCN','NTORD']))) THEN
        CheckOtherArchivedSalesLines(SalesLineLoc);
      // E/P1142
      IF SalesLineLoc.FIND('-') THEN BEGIN
        REPEAT
          SalesLineLoc."DHL Shipment Number" := DHLShipment;
          SalesLineLoc."Status Event Code" := EventCode;
          SalesLineLoc."Status Code" := RICCode;
          SalesLineLoc.MODIFY;
          //A/P0564
          IF (EventCode <> 'DLVRD') AND (SalesLineLoc."Purchasing Code" <> '') THEN BEGIN
            CLEAR(InterfaceProcessMgt);
            FPCGeneralSetup.GET;
            FPCGeneralSetup.TESTFIELD("Status Transport");
            FPCGeneralSetup.TESTFIELD("Status Pick");
            IF InterfaceProcessMgt.TriggerActive(FPCGeneralSetup."Trigger DHL Pro Active") THEN
              InterfaceProcessMgt.UpdateProcessLogForInterface(SalesLineLoc."Document No.",
                                                               SalesLineLoc."Line No.",
                                                               InterfaceProcessMgt.GetInterfaceFromPurchCode(
                                                                                   SalesLineLoc."Purchasing Code"),
                                                               FPCGeneralSetup."Status Pick",
                                                               FPCGeneralSetup."Status Transport",
                                                               FPCGeneralSetup."Trigger DHL Pro Active");
          END;

          //S/P1117
          //S/P1133
          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New"]
          THEN BEGIN
          //E/P1133
            //E/P0564
            CLEAR(DHLParcelsStatusHistory);
            DHLParcelsStatusHistory.RESET;
            //A/gob-adb/16.05.13
            DHLParcelsStatusHistory.SETCURRENTKEY("Document No.");
            //E/gob-adb/16.05.13
            DHLParcelsStatusHistory.SETRANGE("DHL Shipment Code",UPPERCASE(DHLShipment));
            // A/gob-lku/04.09.2012/P0276
            //DHLParcelsStatusHistory.SETRANGE("Account Number",AccNo);
            // E/gob-lku/04.09.2012/P0276
            DHLParcelsStatusHistory.SETRANGE("Document Line No.",SalesLineLoc."Line No.");
            DHLParcelsStatusHistory.SETRANGE("Document No.",SalesLineLoc."Document No.");
            DHLParcelsStatusHistory.SETRANGE("Status Event",EventCode);
            DHLParcelsStatusHistory.SETRANGE("Status Code",RICCode);

            // A/gob-lku/19.09.12/P0353
            dateVar := WORKDATE;
            //19.07.12  nas changed date format >>
            IF STRLEN(TimeStamp) > 13 THEN
              IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                IF EVALUATE(MonthVar,COPYSTR(TimeStamp,6,2))THEN
                  IF EVALUATE(YearVar,COPYSTR(TimeStamp,1,4)) THEN
                    dateVar := DMY2DATE(dayVar,MonthVar,YearVar);
            //19.07.12  nas changed date format <<
            IF NOT EVALUATE(TimeVar,COPYSTR(TimeStamp,12,8)) THEN
              TimeVar := TIME;

            // A/gob-lku/26.10.12/P0524
            //ParcelStatusDHL.SETRANGE("Time Stamp",CREATEDATETIME(dateVar,timeVar));
            DHLParcelsStatusHistory.SETRANGE("Time Stamp",ROUNDDATETIME(CREATEDATETIME(dateVar,TimeVar),100000,'<')
                ,ROUNDDATETIME(CREATEDATETIME(dateVar,TimeVar),100000,'>'));
            // E/gob-lku/26.10.12/P0524

            // E/gob-lku/19.09.12/P0353

            IF NOT DHLParcelsStatusHistory.FINDFIRST THEN BEGIN
              DHLParcelsStatusHistory."Entry No." := 0;
              DHLParcelsStatusHistory."DHL Shipment Code" := UPPERCASE(DHLShipment);
              DHLParcelsStatusHistory."Account Number" := AccNo;
              DHLParcelsStatusHistory."Document Line No." := SalesLineLoc."Line No.";
              DHLParcelsStatusHistory."Document No." := SalesLineLoc."Document No.";
              DHLParcelsStatusHistory."Document Type" := DHLParcelsStatusHistory."Document Type"::Order;

              // A/gob-lku/19.09.12/P0353     Vorgelagert fr Filterung nach Time Stamp
              {
              dateVar := WORKDATE;
              IF STRLEN(TimeStamp) > 13 THEN
                IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                  IF EVALUATE(MonthVar,COPYSTR(TimeStamp,6,2))THEN
                    IF EVALUATE(YearVar,COPYSTR(TimeStamp,1,4)) THEN
                      dateVar := DMY2DATE(dayVar,MonthVar,YearVar);
              IF NOT EVALUATE(TimeVar,COPYSTR(TimeStamp,12,8)) THEN
                TimeVar := TIME;
              }
              // E/gob-lku/19.09.12/P0353     Vorgelagert fr Filterung nach Time Stamp

              DHLParcelsStatusHistory."Time Stamp" := CREATEDATETIME(dateVar,TimeVar);

              // A/10.10.12/gob-lku/P0429
              DHLParcelsStatusHistory."Import Time Stamp" := CURRENTDATETIME;
              DHLParcelsStatusHistory."Time Difference" := DHLParcelsStatusHistory."Time Stamp"
                                                          - DHLParcelsStatusHistory."Import Time Stamp";
              DHLParcelsStatusHistory."Status DHL" := TRUE;
              IF SalesHeaderLoc.GET(SalesLineLoc."Document Type",SalesLineLoc."Document No.",
                            SalesLineLoc."Doc. No. Occurrence",SalesLineLoc."Version No.") THEN
                DHLParcelsStatusHistory."Order Date" := SalesHeaderLoc."Order Date";
              DHLParcelsStatusHistory."Shipment through" := DHLParcelsStatusHistory."Shipment through"::DHL;
              // E/10.10.12/gob-lku/P0429
              // S/gob-lku/13.08.2013/P1051
              DHLParcelsStatusHistory."Shipping Agent" := 'DHL';
              // E/gob-lku/13.08.2013/P1051

              DHLParcelsStatusHistory."Current Status" := TRUE;
              DHLParcelsStatusHistory."Status Event" := EventCode;
              DHLParcelsStatusHistory."Status Code" := RICCode;

              IF EVALUATE(dayVar,COPYSTR(CommitDate,7,2)) THEN
                IF EVALUATE(MonthVar,COPYSTR(CommitDate,5,2))THEN
                  IF EVALUATE(YearVar,COPYSTR(CommitDate,1,4)) THEN
                    DHLParcelsStatusHistory."Commit at Date" := DMY2DATE(dayVar,MonthVar,YearVar);

              IF EVALUATE(dayVar,COPYSTR(DeliveryDate,7,2)) THEN
                IF EVALUATE(MonthVar,COPYSTR(DeliveryDate,5,2))THEN
                  IF EVALUATE(YearVar,COPYSTR(DeliveryDate,1,4)) THEN
                    DHLParcelsStatusHistory."Delivery Date" := DMY2DATE(dayVar,MonthVar,YearVar);

              // S/gob-lku/13.06.13/P0963
              IF SalesLineLoc."Drop Shipment" THEN BEGIN
                DHLParcelsStatusHistory."Purchase Order Code" := SalesLineLoc."Purchase Order No.";
                DHLParcelsStatusHistory."PO Line No." := SalesLineLoc."Purch. Order Line No.";
              END;
              // E/gob-lku/13.06.13/P0963

              //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
              {
              //H0686  04.12.13  MBY  ----------------------------
              DHLParcelsStatusHistory.INSERT;
              //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
              }
              DHLParcelsStatusHistory.INSERT(TRUE);
              //H0686  04.12.13  MBY  ----------------------------
              //S/P1133
              IF FPCGeneralSetup."Active Parcel Status History" IN
                [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
                FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old"]
              THEN
              //E/P1133
                InsertLogEntry(SalesLineLoc."Document No.",STRSUBSTNO(Text007,SalesLineLoc."Document No."), ProcEntry, FALSE, FALSE);
            END;
          //S/P1133
          END;

          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
            FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
          THEN BEGIN
          //E/P1133
            CLEAR(ParcelStatusHistoryArchive);
            WITH ParcelStatusHistoryArchive DO BEGIN
              SETCURRENTKEY("Document No.","Document Line No.","Document Type");
              SETRANGE("Document No.",SalesLineLoc."Document No.");
              SETRANGE("Document Line No.",SalesLineLoc."Line No.");
              SETRANGE("Document Type",SalesLineLoc."Document Type");
              SETRANGE("Tracking Code",UPPERCASE(DHLShipment));
              SETRANGE("Status Code",EventCode);
              SETRANGE("Status Sub Code",RICCode);
              dateVar := WORKDATE;
              IF STRLEN(TimeStamp) > 13 THEN
                IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                  IF EVALUATE(MonthVar,COPYSTR(TimeStamp,6,2))THEN
                    IF EVALUATE(YearVar,COPYSTR(TimeStamp,1,4)) THEN
                      dateVar := DMY2DATE(dayVar,MonthVar,YearVar);
              IF NOT EVALUATE(TimeVar,COPYSTR(TimeStamp,12,8)) THEN
                TimeVar := TIME;
              //H1379 18.09.14 EHN +++++++++++++++++++++++++++++++++
              InterfaceTimeStampL := CREATEDATETIME(dateVar,TimeVar);
              //H1379 18.09.14 EHN ---------------------------------
              SETRANGE("Timestamp Insert",
                ROUNDDATETIME(CREATEDATETIME(dateVar,TimeVar),100000,'<'),
                ROUNDDATETIME(CREATEDATETIME(dateVar,TimeVar),100000,'>'));
              IF ISEMPTY THEN BEGIN
                CLEAR(CUParcelStatusHistoryMgmt);
                CLEAR(DateCommit);
                CLEAR(DateDelivery);
                RecRef.GETTABLE(SalesLineLoc);
                IF EVALUATE(dayVar,COPYSTR(CommitDate,7,2)) THEN
                  IF EVALUATE(MonthVar,COPYSTR(CommitDate,5,2))THEN
                    IF EVALUATE(YearVar,COPYSTR(CommitDate,1,4)) THEN
                      DateCommit := DMY2DATE(dayVar,MonthVar,YearVar);
                IF EVALUATE(dayVar,COPYSTR(DeliveryDate,7,2)) THEN
                  IF EVALUATE(MonthVar,COPYSTR(DeliveryDate,5,2))THEN
                    IF EVALUATE(YearVar,COPYSTR(DeliveryDate,1,4)) THEN
                      DateDelivery := DMY2DATE(dayVar,MonthVar,YearVar);
                CUParcelStatusHistoryMgmt.SetDateGlobals(0D,DateDelivery,DateCommit);
                CUParcelStatusHistoryMgmt.SetAccountNo(AccNo);
                //H1379 18.09.14 EHN +++++++++++++++++++++++++++++++++++++++++
                //CUParcelStatusHistoryMgmt.SetDateTimeGlobal(CURRENTDATETIME);
                CUParcelStatusHistoryMgmt.SetDateTimeGlobal(InterfaceTimeStampL);
                //H1379 18.09.14 EHN -----------------------------------------
                CUParcelStatusHistoryMgmt.FillHistoryByDocLine(
                  RecRef,                 // Rec
                  1,                      // p_Command
                  0,                      // p_InfoDirection::  Incoming,Outgoing
                  2,                      // p_UsedInterface::  ,EDI,DHL,DocData,Drop Shipment,Rhenus,UPS
                  'DHL',                  // p_ShippingAgentCode
                  UPPERCASE(DHLShipment), // p_TrackingCode
                  '',                     // p_PieceCode
                  EventCode,              // p_StatusCode
                  RICCode,                // p_StatusRICCode
                  '',                     // p_Comment
                  0);                     // p_HandleStatusDescription
              //S/P1133
              IF FPCGeneralSetup."Active Parcel Status History" IN
                [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
                FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
              THEN
                InsertLogEntry(SalesLineLoc."Document No.",STRSUBSTNO(Text007,SalesLineLoc."Document No."), ProcEntry, FALSE, FALSE);
              //E/P1133
              END;
              //S/P1129
              CUParcelStatusHistoryMgmt.MoveParcelInfosToArchive(
                1,                            // p_Command::All,SalesDoc,PurchDoc,Date,EntryNo
                SalesLineLoc."Document No.",  // p_DocNo
                0,                            // p_LineNo
                SalesLineLoc."Document Type", // p_DocType
                '',                           // p_DateFilterString
                0);                           // p_EntryNo
              //E/P1129
            //S/P1133
            END;
            //E/P1133
          END;
          //E/P1117
        UNTIL SalesLineLoc.NEXT = 0;
      END;
      // E/gob-lku/06.09.12/P0287
    END;

    PROCEDURE GetManuallyImportedFile@1000000023();
    VAR
      CommonDialogManagement@1000000000 : Codeunit 412;
    BEGIN
      // A/gob-lku/07.09.12/P0299
      Interface.GET('EASYLOG2');
      ProcessIntTable;

      FileName := CommonDialogManagement.OpenFile('Proactive Datei','',1,'',0);
      ReadFile2;
      InsertLogEntry('',Text003, 0, FALSE, FALSE);
      // E/gob-lku/07.09.12/P0299
    END;

    PROCEDURE FillImportTable@1000000009(SONo@1000000000 : Code[40];DHLShipment@1000000001 : Text[50];AccNo@1000000002 : Text[40];EventCode@1000000003 : Code[10];RICCode@1000000004 : Code[10];DeliveryDate@1000000005 : Text[10];CommitDate@1000000006 : Text[10];TimeStamp@1000000007 : Text[30];PLZ@1000000009 : Text[10];NormalImport@1000000010 : Boolean);
    VAR
      ImportDHLProactive@1000000008 : Record 50097;
    BEGIN
      // A/gob-lku/07.09.12/P0299
      ImportDHLProactive.INIT;
      ImportDHLProactive."Entry No." := Counter;
      ImportDHLProactive.INSERT;
      ImportDHLProactive."Account Number" := AccNo;
      ImportDHLProactive."Time Stamp" := TimeStamp;
      ImportDHLProactive."DHL Shipment" := DHLShipment;
      ImportDHLProactive."Commit Date" := CommitDate;
      ImportDHLProactive."Delivery Date" := DeliveryDate;
      ImportDHLProactive."Event Code" := EventCode;
      ImportDHLProactive."RIC Code" := RICCode;
      ImportDHLProactive."Sales Order No." := SONo;

      // A/gob-lku/26.10.12/P0522
      ImportDHLProactive."Import Timestamp" := CURRENTDATETIME;
      // E/gob-lku/26.10.12/P0522

      // A/gob-lku/08.11.2012/P0566
      ImportDHLProactive."Post Code" := PLZ;
      ImportDHLProactive."Normal Import" := NormalImport;
      // E/gob-lku/08.11.2012/P0566

      ImportDHLProactive.MODIFY;
      // E/gob-lku/07.09.12/P0299
    END;

    PROCEDURE ProcessFromImportTable@1000000016(LinestoImport@1000000011 : Integer);
    VAR
      ImportDHLProactive@1000000000 : Record 50097;
      ImportDHLProactive2@1000000014 : Record 50097;
      SONo@1000000008 : Code[40];
      DHLShipment@1000000007 : Text[50];
      AccNo@1000000006 : Text[40];
      EventCode@1000000005 : Code[10];
      RICCode@1000000004 : Code[10];
      DeliveryDate@1000000003 : Text[10];
      CommitDate@1000000002 : Text[10];
      TimeStamp@1000000001 : Text[30];
      i@1000000009 : Integer;
      PLZ@1000000010 : Text[10];
      j@1000000012 : Integer;
      k@1000000013 : Integer;
    BEGIN
      //A/P0841
      ImportDHLProactive.SETCURRENTKEY(Done,"Process Error","Normal Import");
      //E/P0841

      // A/gob-lku/07.09.12/P0299
      ImportDHLProactive.SETRANGE(Done,FALSE);
      // A/gob-lku/19.09.12/P0353
      ImportDHLProactive.SETRANGE("Process Error",FALSE);
      // A/gob-lku/21.09.12/P0365
      //FPCGeneralSetup.GET;
      // E/gob-lku/21.09.12/P0365
      // E/gob-lku/19.09.12/P0353

      // A/gob-lku/08.11.2012/P0566
      ImportDHLProactive.SETRANGE("Normal Import",TRUE);
      IF ImportDHLProactive.ISEMPTY THEN
        ImportDHLProactive.SETRANGE("Normal Import");
      // E/gob-lku/08.11.2012/P0566

      //A/P0841
      IF ImportDHLProactive.FIND('-') THEN BEGIN
      //IF ImportDHLProactive.FINDSET(TRUE,TRUE) THEN BEGIN
      //E/P0841
        i := 1;
        REPEAT
          SONo := ImportDHLProactive."Sales Order No.";
          DHLShipment := ImportDHLProactive."DHL Shipment";
          AccNo := ImportDHLProactive."Account Number";
          EventCode := ImportDHLProactive."Event Code";
          RICCode := ImportDHLProactive."RIC Code";
          DeliveryDate := ImportDHLProactive."Delivery Date";
          CommitDate := ImportDHLProactive."Commit Date";
          TimeStamp := ImportDHLProactive."Time Stamp";

          // A/gob-lku/08.11.2012/P0566
          PLZ := ImportDHLProactive."Post Code";
          // E/gob-lku/08.11.2012/P0566

          // A/gob-lku/08.01.2013/P0726
          CLEARLASTERROR;
          // E/gob-lku/08.01.2013/P0726
          IF Process(SONo,DHLShipment,AccNo,EventCode,RICCode,DeliveryDate,CommitDate,TimeStamp,0,PLZ) THEN BEGIN
            //A/P0841
            ImportDHLProactive2 := ImportDHLProactive;
            ImportDHLProactive2.Done := TRUE;
            ImportDHLProactive2.MODIFY;
            //ImportDHLProactive.Done := TRUE;
            //ImportDHLProactive.MODIFY;
            //E/P0841
          // A/gob-lku/19.09.12/P0353
          //END;
          END ELSE BEGIN
            //A/P0841
            ImportDHLProactive2 := ImportDHLProactive;
            //E/P0841
            // A/gob-lku/08.01.2013/P0726
            IF (STRPOS(GETLASTERRORTEXT,'There is nothing to post.') = 1) OR (STRPOS(GETLASTERRORTEXT,'Es gibt nichts zu buchen.') = 1)
            THEN
              //A/P0841
              //ImportDHLProactive.Done := TRUE
              ImportDHLProactive2.Done := TRUE
              //E/P0841
            ELSE
            // E/gob-lku/08.01.2013/P0726
            //A/P0841
              ImportDHLProactive2."Process Error" := TRUE;

            ImportDHLProactive2.MODIFY;
            //ImportDHLProactive.ProcessError := TRUE;
            //ImportDHLProactive.MODIFY;
            //E/P0841
          END;
          // E/gob-lku/19.09.12/P0353
          i += 1;

          // A/gob-lku/15.11.12/P0590
          COMMIT;
          // E/gob-lku/15.11.12/P0590

        // A/gob-lku/19.09.12/P0353
        //UNTIL (ImportDHLProactive.NEXT = 0) OR (i = 1000);
        // A/gob-lku/14.11.12/P0583
        //UNTIL (ImportDHLProactive.NEXT = 0) OR (i = FPCGeneralSetup."No. Lines per man. DHL Import");
        UNTIL (ImportDHLProactive.NEXT = 0) OR (i = LinestoImport);
        // E/gob-lku/14.11.12/P0583
        // E/gob-lku/19.09.12/P0353
      END;
      // E/gob-lku/07.09.12/P0299
    END;

    PROCEDURE UpdateLinesReturnOrder@1000000026(p_SalesLine@1000000000 : Record 37;DHLShipment@1000000009 : Text[50];AccNo@1000000008 : Text[40];EventCode@1000000007 : Code[10];RICCode@1000000006 : Code[10];DeliveryDate@1000000005 : Text[10];CommitDate@1000000004 : Text[10];TimeStamp@1000000003 : Text[30];ProcEntry@1000000002 : Integer);
    VAR
      SalesLineLoc@1000000001 : Record 37;
      SalesHeaderLoc@1000000016 : Record 36;
      DHLParcelsStatusHistory@1000000010 : Record 50021;
      dateVar@1000000011 : Date;
      dayVar@1000000012 : Integer;
      MonthVar@1000000013 : Integer;
      YearVar@1000000014 : Integer;
      TimeVar@1000000015 : Time;
      FPCGeneralSetup@1000000017 : Record 50055;
      InterfaceProcessMgt@1000000018 : Codeunit 50087;
      ParcelStatusHistory@1000000019 : Record 80013;
      RecRef@1000000022 : RecordRef;
      DateCommit@1000000020 : Date;
      DateDelivery@1000000021 : Date;
      "**** HME ****************"@1000000024 : Integer;
      InterfaceTimeStampL@1000000023 : DateTime;
    BEGIN
      //S/P1133
      FPCGeneralSetup.GET;
      //E/P1133

      SalesLineLoc.RESET;
      SalesLineLoc.SETRANGE("Document Type",p_SalesLine."Document Type");
      SalesLineLoc.SETRANGE("Document No.",p_SalesLine."Document No.");
      SalesLineLoc.SETRANGE(Type,SalesLineLoc.Type::Item);
      SalesLineLoc.SETFILTER("No.",'<>%1','');

      // S/P1142
      SalesLineLoc.SETRANGE("Line No.",p_SalesLine."Line No.");

      //H0733  26.11.13  ABR  +++++++++++++++++++++++++++++++++
      IF SalesLineLoc.FINDFIRST THEN;
      //H0733  26.11.13  ABR  ---------------------------------

      IF ((EventCode IN ['CNRFC','DLVRD','DLVRF','HLDCC','HNDDE','HNDND','OFWRD'])
      OR ((EventCode = 'NTDEL') AND (RICCode IN ['CNCNR','CPUNK','MOVED','NHOME','NTCCN','NTORD','OTHER']))
      OR ((EventCode = 'RETRN') AND (RICCode IN ['CNCNR','NTCCN','NTORD']))) THEN
        CheckOtherSalesLines(SalesLineLoc);
      // E/P1142
      IF SalesLineLoc.FIND('-') THEN BEGIN
        REPEAT
          SalesLineLoc."DHL Shipment Number" := DHLShipment;
          SalesLineLoc."Status Event Code" := EventCode;
          SalesLineLoc."Status Code" := RICCode;
          SalesLineLoc.MODIFY;
          //A/P0564
          IF (EventCode <> 'DLVRD') AND (SalesLineLoc."Purchasing Code" <> '') THEN BEGIN
            CLEAR(InterfaceProcessMgt);
            FPCGeneralSetup.GET;
            FPCGeneralSetup.TESTFIELD("Status Transport");
            FPCGeneralSetup.TESTFIELD("Status Pick");
            IF InterfaceProcessMgt.TriggerActive(FPCGeneralSetup."Trigger DHL Pro Active") THEN
              InterfaceProcessMgt.UpdateProcessLogForInterface(SalesLineLoc."Document No.",
                                                               SalesLineLoc."Line No.",
                                                               InterfaceProcessMgt.GetInterfaceFromPurchCode(
                                                                                   SalesLineLoc."Purchasing Code"),
                                                               FPCGeneralSetup."Status Pick",
                                                               FPCGeneralSetup."Status Transport",
                                                               FPCGeneralSetup."Trigger DHL Pro Active");
          END;
          //E/P0564

          //S/P1117
          //S/P1133
          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New"]
          THEN BEGIN
          //E/P1133
            CLEAR(DHLParcelsStatusHistory);
            DHLParcelsStatusHistory.RESET;
            //A/gob-adb/16.05.13
            DHLParcelsStatusHistory.SETCURRENTKEY("Document No.");
            //E/gob-adb/16.05.13
            DHLParcelsStatusHistory.SETRANGE("DHL Shipment Code",UPPERCASE(DHLShipment));
            DHLParcelsStatusHistory.SETRANGE("Document Line No.",SalesLineLoc."Line No.");
            DHLParcelsStatusHistory.SETRANGE("Document No.",SalesLineLoc."Document No.");
            DHLParcelsStatusHistory.SETRANGE("Status Event",EventCode);
            DHLParcelsStatusHistory.SETRANGE("Status Code",RICCode);

            // A/gob-lku/19.09.12/P0353
            dateVar := WORKDATE;
            //19.07.12  nas changed date format >>
            IF STRLEN(TimeStamp) > 13 THEN
              IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                IF EVALUATE(MonthVar,COPYSTR(TimeStamp,6,2))THEN
                  IF EVALUATE(YearVar,COPYSTR(TimeStamp,1,4)) THEN
                    dateVar := DMY2DATE(dayVar,MonthVar,YearVar);
            //19.07.12  nas changed date format <<
            IF NOT EVALUATE(TimeVar,COPYSTR(TimeStamp,12,8)) THEN
              TimeVar := TIME;

            // A/gob-lku/26.10.12/P0524
            //ParcelStatusDHL.SETRANGE("Time Stamp",CREATEDATETIME(dateVar,timeVar));
            DHLParcelsStatusHistory.SETRANGE("Time Stamp",ROUNDDATETIME(CREATEDATETIME(dateVar,TimeVar),100000,'<')
                ,ROUNDDATETIME(CREATEDATETIME(dateVar,TimeVar),100000,'>'));
            // E/gob-lku/26.10.12/P0524

            // E/gob-lku/19.09.12/P0353

            IF NOT DHLParcelsStatusHistory.FINDFIRST THEN BEGIN
              DHLParcelsStatusHistory."Entry No." := 0;
              DHLParcelsStatusHistory."DHL Shipment Code" := UPPERCASE(DHLShipment);
              DHLParcelsStatusHistory."Account Number" := AccNo;
              DHLParcelsStatusHistory."Document Line No." := SalesLineLoc."Line No.";
              DHLParcelsStatusHistory."Document No." := SalesLineLoc."Document No.";
              DHLParcelsStatusHistory."Document Type" := DHLParcelsStatusHistory."Document Type"::"Return Order";

              // A/gob-lku/19.09.12/P0353     Vorgelagert fr Filterung nach Time Stamp
              {
              dateVar := WORKDATE;
              IF STRLEN(TimeStamp) > 13 THEN
                IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                  IF EVALUATE(MonthVar,COPYSTR(TimeStamp,6,2))THEN
                    IF EVALUATE(YearVar,COPYSTR(TimeStamp,1,4)) THEN
                      dateVar := DMY2DATE(dayVar,MonthVar,YearVar);
              IF NOT EVALUATE(TimeVar,COPYSTR(TimeStamp,12,8)) THEN
                TimeVar := TIME;
              }
              // E/gob-lku/19.09.12/P0353     Vorgelagert fr Filterung nach Time Stamp

              DHLParcelsStatusHistory."Time Stamp" := CREATEDATETIME(dateVar,TimeVar);

              // A/10.10.12/gob-lku/P0429
              DHLParcelsStatusHistory."Import Time Stamp" := CURRENTDATETIME;
              DHLParcelsStatusHistory."Time Difference" := DHLParcelsStatusHistory."Time Stamp"
                                                          - DHLParcelsStatusHistory."Import Time Stamp";
              DHLParcelsStatusHistory."Status DHL" := TRUE;
              IF SalesHeaderLoc.GET(SalesLineLoc."Document Type",SalesLineLoc."Document No.") THEN
                DHLParcelsStatusHistory."Order Date" := SalesHeaderLoc."Order Date";
              DHLParcelsStatusHistory."Shipment through" := DHLParcelsStatusHistory."Shipment through"::DHL;
              // E/10.10.12/gob-lku/P0429
              // S/gob-lku/13.08.2013/P1051
              DHLParcelsStatusHistory."Shipping Agent" := 'DHL';
              // E/gob-lku/13.08.2013/P1051

              DHLParcelsStatusHistory."Current Status" := TRUE;
              DHLParcelsStatusHistory."Status Event" := EventCode;
              DHLParcelsStatusHistory."Status Code" := RICCode;

              IF EVALUATE(dayVar,COPYSTR(CommitDate,7,2)) THEN
                IF EVALUATE(MonthVar,COPYSTR(CommitDate,5,2))THEN
                  IF EVALUATE(YearVar,COPYSTR(CommitDate,1,4)) THEN
                    DHLParcelsStatusHistory."Commit at Date" := DMY2DATE(dayVar,MonthVar,YearVar);

              IF EVALUATE(dayVar,COPYSTR(DeliveryDate,7,2)) THEN
                IF EVALUATE(MonthVar,COPYSTR(DeliveryDate,5,2))THEN
                  IF EVALUATE(YearVar,COPYSTR(DeliveryDate,1,4)) THEN
                    DHLParcelsStatusHistory."Delivery Date" := DMY2DATE(dayVar,MonthVar,YearVar);

              // S/gob-lku/13.06.13/P0963
              IF SalesLineLoc."Drop Shipment" THEN BEGIN
                DHLParcelsStatusHistory."Purchase Order Code" := SalesLineLoc."Purchase Order No.";
                DHLParcelsStatusHistory."PO Line No." := SalesLineLoc."Purch. Order Line No.";
              END;
              // E/gob-lku/13.06.13/P0963

              //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
              {
              //H0686  04.12.13  MBY  ----------------------------
              DHLParcelsStatusHistory.INSERT;
              //H0686  04.12.13  MBY  ++++++++++++++++++++++++++++
              }
              DHLParcelsStatusHistory.INSERT(TRUE);
              //H0686  04.12.13  MBY  ----------------------------
              //S/P1133
              IF FPCGeneralSetup."Active Parcel Status History" IN
                [FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
                FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old"]
              THEN
              //E/P1133
                InsertLogEntry(SalesLineLoc."Document No.",STRSUBSTNO(Text009,SalesLineLoc."Document No."), ProcEntry, FALSE, FALSE);
            END;
          //S/P1133
          END;

          IF FPCGeneralSetup."Active Parcel Status History" IN
            [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old",
            FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
            FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
          THEN BEGIN
          //E/P1133
            CLEAR(ParcelStatusHistory);
            WITH ParcelStatusHistory DO BEGIN
              SETCURRENTKEY("Document No.","Document Line No.","Document Type");
              SETRANGE("Document No.",SalesLineLoc."Document No.");
              SETRANGE("Document Line No.",SalesLineLoc."Line No.");
              SETRANGE("Document Type",SalesLineLoc."Document Type");
              SETRANGE("Tracking Code",UPPERCASE(DHLShipment));
              SETRANGE("Status Code",EventCode);
              SETRANGE("Status Sub Code",RICCode);
              dateVar := WORKDATE;
              IF STRLEN(TimeStamp) > 13 THEN
                IF EVALUATE(dayVar,COPYSTR(TimeStamp,9,2)) THEN
                  IF EVALUATE(MonthVar,COPYSTR(TimeStamp,6,2))THEN
                    IF EVALUATE(YearVar,COPYSTR(TimeStamp,1,4)) THEN
                      dateVar := DMY2DATE(dayVar,MonthVar,YearVar);
              IF NOT EVALUATE(TimeVar,COPYSTR(TimeStamp,12,8)) THEN
                TimeVar := TIME;
              //H1379 18.09.14 EHN +++++++++++++++++++++++++++++++++
              InterfaceTimeStampL := CREATEDATETIME(dateVar,TimeVar);
              //H1379 18.09.14 EHN ---------------------------------
              SETRANGE("Timestamp Insert",
                ROUNDDATETIME(CREATEDATETIME(dateVar,TimeVar),100000,'<'),
                ROUNDDATETIME(CREATEDATETIME(dateVar,TimeVar),100000,'>'));
              IF ISEMPTY THEN BEGIN
                CLEAR(CUParcelStatusHistoryMgmt);
                CLEAR(DateCommit);
                CLEAR(DateDelivery);
                RecRef.GETTABLE(SalesLineLoc);
                IF EVALUATE(dayVar,COPYSTR(CommitDate,7,2)) THEN
                  IF EVALUATE(MonthVar,COPYSTR(CommitDate,5,2))THEN
                    IF EVALUATE(YearVar,COPYSTR(CommitDate,1,4)) THEN
                      DateCommit := DMY2DATE(dayVar,MonthVar,YearVar);
                IF EVALUATE(dayVar,COPYSTR(DeliveryDate,7,2)) THEN
                  IF EVALUATE(MonthVar,COPYSTR(DeliveryDate,5,2))THEN
                    IF EVALUATE(YearVar,COPYSTR(DeliveryDate,1,4)) THEN
                      DateDelivery := DMY2DATE(dayVar,MonthVar,YearVar);
                CUParcelStatusHistoryMgmt.SetDateGlobals(0D,DateDelivery,DateCommit);
                CUParcelStatusHistoryMgmt.SetAccountNo(AccNo);
                //H1379 18.09.14 EHN +++++++++++++++++++++++++++++++++++++++++
                //CUParcelStatusHistoryMgmt.SetDateTimeGlobal(CURRENTDATETIME);
                CUParcelStatusHistoryMgmt.SetDateTimeGlobal(InterfaceTimeStampL);
                //H1379 18.09.14 EHN -----------------------------------------
                CUParcelStatusHistoryMgmt.FillHistoryByDocLine(
                  RecRef,                 // Rec
                  1,                      // p_Command
                  0,                      // p_InfoDirection::  Incoming,Outgoing
                  2,                      // p_UsedInterface::  ,EDI,DHL,DocData,Drop Shipment,Rhenus,UPS
                  'DHL',                  // p_ShippingAgentCode
                  UPPERCASE(DHLShipment), // p_TrackingCode
                  '',                     // p_PieceCode
                  EventCode,              // p_StatusCode
                  RICCode,                // p_StatusRICCode
                  '',                     // p_Comment
                  0);                     // p_HandleStatusDescription
              END;
              //S/P1133
              IF FPCGeneralSetup."Active Parcel Status History" IN
                [FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
                FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History"]
              THEN
              //E/P1133
                InsertLogEntry(SalesLineLoc."Document No.",STRSUBSTNO(Text009,SalesLineLoc."Document No."), ProcEntry, FALSE, FALSE);
            END;
          //S/P1133
          END;
          //E/P1133
          //E/P1117
        UNTIL SalesLineLoc.NEXT = 0;
      END;
    END;

    PROCEDURE CheckOtherSalesLines@1000000013(VAR SOLine@1000000000 : Record 37) : Boolean;
    VAR
      DHLParcelStatusHistory@1000000003 : Record 50021;
      Item_l@1000000002 : Record 27;
      Filter_l@1000000001 : Text[1024];
      ParcelStatusHistory@1000000004 : Record 80013;
    BEGIN
      // S/P1142
      IF (SOLine."Purchasing Code" = 'GER-1') OR (SOLine."Purchasing Code" = 'GER-2')
          OR (SOLine."Purchasing Code" = 'FRA-1') OR (SOLine."Purchasing Code" = 'FRA-2')
          OR (SOLine."Purchasing Code" = 'AT-1') OR (SOLine."Purchasing Code" = 'AT-2')
          OR (SOLine."Purchasing Code" = 'NL-1') OR (SOLine."Purchasing Code" = 'NL-2') THEN BEGIN
        SOLine.SETFILTER("Purchasing Code",Kanal1und2);
        Filter_l := FORMAT(SOLine."Line No.");
        SOLine.SETRANGE("Line No.");
        IF SOLine.FINDSET THEN
          REPEAT
            IF Item_l.GET(SOLine."No.") THEN BEGIN
              IF (Item_l."Shipping Code" = '1918') OR (SOLine."Purchasing Code" = 'GER-2')
                  OR (SOLine."Purchasing Code" = 'AT-2')
                  OR (SOLine."Purchasing Code" = 'FRA-2') OR (SOLine."Purchasing Code" = 'NL-2') THEN
                //S/P1133
                CASE FPCGeneralSetup."Active Parcel Status History" OF
                  FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
                  FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old":
                    BEGIN
                //E/P1133
                      DHLParcelStatusHistory.RESET;
                      DHLParcelStatusHistory.SETRANGE("Document No.",SOLine."Document No.");
                      DHLParcelStatusHistory.SETRANGE("Document Line No.",SOLine."Line No.");
                      DHLSetup.GET;
                      DHLParcelStatusHistory.SETFILTER("Status Code",'<>%1&<>%2',DHLSetup."Status Code Label Send",'');
                      IF DHLParcelStatusHistory.ISEMPTY THEN
                        IF Filter_l = '' THEN
                          Filter_l := FORMAT(SOLine."Line No.")
                        ELSE
                          Filter_l += '|' + FORMAT(SOLine."Line No.");
                //S/P1133
                    END;
                  FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
                  FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History":
                    BEGIN
                      ParcelStatusHistory.RESET;
                      ParcelStatusHistory.SETCURRENTKEY("Document No.","Document Line No.","Document Type");
                      ParcelStatusHistory.SETRANGE("Document No.",SOLine."Document No.");
                      ParcelStatusHistory.SETRANGE("Document Line No.",SOLine."Line No.");
                      DHLSetup.GET;
                      ParcelStatusHistory.SETFILTER("Status Code",'<>%1&<>%2',DHLSetup."Status Code Label Send",'');
                      IF ParcelStatusHistory.ISEMPTY THEN
                        IF Filter_l = '' THEN
                          Filter_l := FORMAT(SOLine."Line No.")
                        ELSE
                          Filter_l += '|' + FORMAT(SOLine."Line No.");
                    END;
                END;
                //E/P1133
            END;
          UNTIL SOLine.NEXT = 0;
        SOLine.SETFILTER("Line No.",Filter_l);
      END;
      IF (SOLine."Purchasing Code" = 'GER-7')
          OR (SOLine."Purchasing Code" = 'GER-13')
          OR (SOLine."Purchasing Code" = 'FRA-13')
          OR (SOLine."Purchasing Code" = 'NL-13')
          OR (SOLine."Purchasing Code" = 'AT-13')
          OR (SOLine."Purchasing Code" = 'GER-12')
          OR (SOLine."Purchasing Code" = 'FRA-12')
          OR (SOLine."Purchasing Code" = 'NL-12')
          OR (SOLine."Purchasing Code" = 'AT-7')
          OR (SOLine."Purchasing Code" = 'AT-12')
          OR (SOLine."Purchasing Code" = 'FRA-7')
          OR (SOLine."Purchasing Code" = 'NL-7') THEN BEGIN
        SOLine.SETRANGE("Purchasing Code",SOLine."Purchasing Code");
        SOLine.SETRANGE("Vendor No.",SOLine."Vendor No.");
        Filter_l := FORMAT(SOLine."Line No.");
        SOLine.SETRANGE("Line No.");
        IF SOLine.FINDSET THEN
          REPEAT
            //S/P1133
            CASE FPCGeneralSetup."Active Parcel Status History" OF
              FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old":
                BEGIN
            //E/P1133
                  DHLParcelStatusHistory.RESET;
                  DHLParcelStatusHistory.SETRANGE("Document No.",SOLine."Document No.");
                  DHLParcelStatusHistory.SETRANGE("Document Line No.",SOLine."Line No.");
                  DHLSetup.GET;
                  DHLParcelStatusHistory.SETFILTER("Status Code",'<>%1&<>%2',DHLSetup."Status Code Label Send",'');
                  IF DHLParcelStatusHistory.ISEMPTY THEN
                    IF Filter_l = '' THEN
                      Filter_l := FORMAT(SOLine."Line No.")
                    ELSE
                      Filter_l += '|' + FORMAT(SOLine."Line No.");
            //S/P1133
                END;
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
              FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History":
                BEGIN
                  ParcelStatusHistory.RESET;
                  ParcelStatusHistory.SETCURRENTKEY("Document No.","Document Line No.","Document Type");
                  ParcelStatusHistory.SETRANGE("Document No.",SOLine."Document No.");
                  ParcelStatusHistory.SETRANGE("Document Line No.",SOLine."Line No.");
                  DHLSetup.GET;
                  ParcelStatusHistory.SETFILTER("Status Code",'<>%1&<>%2',DHLSetup."Status Code Label Send",'');
                  IF ParcelStatusHistory.ISEMPTY THEN
                    IF Filter_l = '' THEN
                      Filter_l := FORMAT(SOLine."Line No.")
                    ELSE
                      Filter_l += '|' + FORMAT(SOLine."Line No.");
                END;
            END;
            //E/P1133
          UNTIL SOLine.NEXT = 0;
        SOLine.SETRANGE("Purchasing Code");
        SOLine.SETRANGE("Vendor No.");
        SOLine.SETFILTER("Line No.",Filter_l);
      END;
      //H1980 04.02.15 EHN ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
      IF SOLine."Purchasing Code" IN
        ['GER-9','FRA-9','AT-9','NL-9','BE-9','IT-9','GER-14','FRA-14','AT-14','NL-14','BE-14','IT-14']
      THEN BEGIN
        SOLine.SETRANGE("DHL Shipment Number",SOLine."DHL Shipment Number");
      //H1980 04.02.15 EHN ----------------------------------------------------------------------
        SOLine.SETRANGE("Purchasing Code",SOLine."Purchasing Code");
        Filter_l := FORMAT(SOLine."Line No.");
        SOLine.SETRANGE("Line No.");
        IF SOLine.FINDSET THEN
          REPEAT
            //S/P1133
            CASE FPCGeneralSetup."Active Parcel Status History" OF
              FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old":
                BEGIN
            //E/P1133
                  DHLParcelStatusHistory.RESET;
                  DHLParcelStatusHistory.SETRANGE("Document No.",SOLine."Document No.");
                  DHLParcelStatusHistory.SETRANGE("Document Line No.",SOLine."Line No.");
                  DHLSetup.GET;
                  DHLParcelStatusHistory.SETFILTER("Status Code",'<>%1&<>%2',DHLSetup."Status Code Label Send",'');
                  IF DHLParcelStatusHistory.ISEMPTY THEN
                    IF Filter_l = '' THEN
                      Filter_l := FORMAT(SOLine."Line No.")
                    ELSE
                      Filter_l += '|' + FORMAT(SOLine."Line No.");
            //S/P1133
                END;
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
              FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History":
                BEGIN
                  ParcelStatusHistory.RESET;
                  ParcelStatusHistory.SETCURRENTKEY("Document No.","Document Line No.","Document Type");
                  ParcelStatusHistory.SETRANGE("Document No.",SOLine."Document No.");
                  ParcelStatusHistory.SETRANGE("Document Line No.",SOLine."Line No.");
                  DHLSetup.GET;
                  ParcelStatusHistory.SETFILTER("Status Code",'<>%1&<>%2',DHLSetup."Status Code Label Send",'');
                  IF ParcelStatusHistory.ISEMPTY THEN
                    IF Filter_l = '' THEN
                      Filter_l := FORMAT(SOLine."Line No.")
                    ELSE
                      Filter_l += '|' + FORMAT(SOLine."Line No.");
                END;
            END;
            //E/P1133
          UNTIL SOLine.NEXT = 0;
        SOLine.SETRANGE("Purchasing Code");
        SOLine.SETFILTER("Line No.",Filter_l);
      END;
      // E/P1142
    END;

    PROCEDURE CheckOtherArchivedSalesLines@1000000015(VAR SOLineArchive@1000000000 : Record 5108) : Boolean;
    VAR
      DHLParcelStatusHistory@1000000003 : Record 50021;
      Item_l@1000000001 : Record 27;
      Filter_l@1000000002 : Text[1024];
      ParcelStatusHistoryArchive@1000000004 : Record 50187;
    BEGIN
      // S/P1142
      IF (SOLineArchive."Purchasing Code" = 'GER-1') OR (SOLineArchive."Purchasing Code" = 'GER-2')
          OR (SOLineArchive."Purchasing Code" = 'FRA-1') OR (SOLineArchive."Purchasing Code" = 'FRA-2')
          OR (SOLineArchive."Purchasing Code" = 'AT-1') OR (SOLineArchive."Purchasing Code" = 'AT-2')
          OR (SOLineArchive."Purchasing Code" = 'NL-1') OR (SOLineArchive."Purchasing Code" = 'NL-2') THEN BEGIN
        SOLineArchive.SETFILTER("Purchasing Code",Kanal1und2);
        Filter_l := FORMAT(SOLineArchive."Line No.");
        SOLineArchive.SETRANGE("Line No.");
        IF SOLineArchive.FINDSET THEN
          REPEAT
            IF Item_l.GET(SOLineArchive."No.") THEN BEGIN
              IF (Item_l."Shipping Code" = '1918') OR (SOLineArchive."Purchasing Code" = 'GER-2')
                  OR (SOLineArchive."Purchasing Code" = 'AT-2')
                  OR (SOLineArchive."Purchasing Code" = 'FRA-2') OR (SOLineArchive."Purchasing Code" = 'NL-2')
              THEN BEGIN
                //S/P1133
                CASE FPCGeneralSetup."Active Parcel Status History" OF
                  FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
                  FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old":
                    BEGIN
                //E/P1133
                      DHLParcelStatusHistory.RESET;
                      DHLParcelStatusHistory.SETRANGE("Document No.",SOLineArchive."Document No.");
                      DHLParcelStatusHistory.SETRANGE("Document Line No.",SOLineArchive."Line No.");
                      DHLSetup.GET;
                      DHLParcelStatusHistory.SETFILTER("Status Code",'<>%1&<>%2',DHLSetup."Status Code Label Send",'');
                      IF DHLParcelStatusHistory.ISEMPTY THEN
                        IF Filter_l = '' THEN
                          Filter_l := FORMAT(SOLineArchive."Line No.")
                        ELSE
                          Filter_l += '|' + FORMAT(SOLineArchive."Line No.");
                //S/P1133
                    END;
                  FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
                  FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History":
                    BEGIN
                      ParcelStatusHistoryArchive.RESET;
                      ParcelStatusHistoryArchive.SETCURRENTKEY("Document No.","Document Line No.","Document Type");
                      ParcelStatusHistoryArchive.SETRANGE("Document No.",SOLineArchive."Document No.");
                      ParcelStatusHistoryArchive.SETRANGE("Document Line No.",SOLineArchive."Line No.");
                      DHLSetup.GET;
                      ParcelStatusHistoryArchive.SETFILTER("Status Code",'<>%1&<>%2',DHLSetup."Status Code Label Send",'');
                      IF ParcelStatusHistoryArchive.ISEMPTY THEN
                        IF Filter_l = '' THEN
                          Filter_l := FORMAT(SOLineArchive."Line No.")
                        ELSE
                          Filter_l += '|' + FORMAT(SOLineArchive."Line No.");
                    END;
                END;
                //E/P1133
              END;
            END;
          UNTIL SOLineArchive.NEXT = 0;
        SOLineArchive.SETFILTER("Line No.",Filter_l);
      END;
      IF (SOLineArchive."Purchasing Code" = 'GER-7')
          OR (SOLineArchive."Purchasing Code" = 'GER-13')
          OR (SOLineArchive."Purchasing Code" = 'FRA-13')
          OR (SOLineArchive."Purchasing Code" = 'NL-13')
          OR (SOLineArchive."Purchasing Code" = 'AT-13')
          OR (SOLineArchive."Purchasing Code" = 'GER-12')
          OR (SOLineArchive."Purchasing Code" = 'FRA-12')
          OR (SOLineArchive."Purchasing Code" = 'NL-12')
          OR (SOLineArchive."Purchasing Code" = 'AT-7')
          OR (SOLineArchive."Purchasing Code" = 'AT-12')
          OR (SOLineArchive."Purchasing Code" = 'FRA-7')
          OR (SOLineArchive."Purchasing Code" = 'NL-7') THEN BEGIN
        SOLineArchive.SETRANGE("Purchasing Code",SOLineArchive."Purchasing Code");
        SOLineArchive.SETRANGE("Vendor No.",SOLineArchive."Vendor No.");
        Filter_l := FORMAT(SOLineArchive."Line No.");
        SOLineArchive.SETRANGE("Line No.");
        IF SOLineArchive.FIND('-') THEN
          REPEAT
            //S/P1133
            CASE FPCGeneralSetup."Active Parcel Status History" OF
              FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old":
                BEGIN
            //E/P1133
                  DHLParcelStatusHistory.RESET;
                  DHLParcelStatusHistory.SETRANGE("Document No.",SOLineArchive."Document No.");
                  DHLParcelStatusHistory.SETRANGE("Document Line No.",SOLineArchive."Line No.");
                  DHLSetup.GET;
                  DHLParcelStatusHistory.SETFILTER("Status Code",'<>%1&<>%2',DHLSetup."Status Code Label Send",'');
                  IF DHLParcelStatusHistory.ISEMPTY THEN
                    IF Filter_l = '' THEN
                      Filter_l := FORMAT(SOLineArchive."Line No.")
                    ELSE
                      Filter_l += '|' + FORMAT(SOLineArchive."Line No.");
            //S/P1133
                END;
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
              FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History":
                BEGIN
                  ParcelStatusHistoryArchive.RESET;
                  ParcelStatusHistoryArchive.SETCURRENTKEY("Document No.","Document Line No.","Document Type");
                  ParcelStatusHistoryArchive.SETRANGE("Document No.",SOLineArchive."Document No.");
                  ParcelStatusHistoryArchive.SETRANGE("Document Line No.",SOLineArchive."Line No.");
                  DHLSetup.GET;
                  ParcelStatusHistoryArchive.SETFILTER("Status Code",'<>%1&<>%2',DHLSetup."Status Code Label Send",'');
                  IF ParcelStatusHistoryArchive.ISEMPTY THEN
                    IF Filter_l = '' THEN
                      Filter_l := FORMAT(SOLineArchive."Line No.")
                    ELSE
                      Filter_l += '|' + FORMAT(SOLineArchive."Line No.");
                END;
            END;
            //E/P1133
          UNTIL SOLineArchive.NEXT = 0;
        SOLineArchive.SETRANGE("Purchasing Code");
        SOLineArchive.SETRANGE("Vendor No.");
        SOLineArchive.SETFILTER("Line No.",Filter_l);
      END;
      IF (SOLineArchive."Purchasing Code" = 'GER-9')
          OR (SOLineArchive."Purchasing Code" = 'FRA-9')
          OR (SOLineArchive."Purchasing Code" = 'AT-9')
          OR (SOLineArchive."Purchasing Code" = 'NL-9') THEN BEGIN
        SOLineArchive.SETRANGE("Purchasing Code",SOLineArchive."Purchasing Code");
        Filter_l := FORMAT(SOLineArchive."Line No.");
        SOLineArchive.SETRANGE("Line No.");
        IF SOLineArchive.FIND('-') THEN
          REPEAT
            //S/P1133
            CASE FPCGeneralSetup."Active Parcel Status History" OF
              FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old":
                BEGIN
            //E/P1133
                  DHLParcelStatusHistory.RESET;
                  DHLParcelStatusHistory.SETRANGE("Document No.",SOLineArchive."Document No.");
                  DHLParcelStatusHistory.SETRANGE("Document Line No.",SOLineArchive."Line No.");
                  DHLSetup.GET;
                  DHLParcelStatusHistory.SETFILTER("Status Code",'<>%1&<>%2',DHLSetup."Status Code Label Send",'');
                  IF DHLParcelStatusHistory.ISEMPTY THEN
                    IF Filter_l = '' THEN
                      Filter_l := FORMAT(SOLineArchive."Line No.")
                    ELSE
                      Filter_l += '|' + FORMAT(SOLineArchive."Line No.");
            //S/P1133
                END;
              FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
              FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History":
                BEGIN
                  ParcelStatusHistoryArchive.RESET;
                  ParcelStatusHistoryArchive.SETCURRENTKEY("Document No.","Document Line No.","Document Type");
                  ParcelStatusHistoryArchive.SETRANGE("Document No.",SOLineArchive."Document No.");
                  ParcelStatusHistoryArchive.SETRANGE("Document Line No.",SOLineArchive."Line No.");
                  DHLSetup.GET;
                  ParcelStatusHistoryArchive.SETFILTER("Status Code",'<>%1&<>%2',DHLSetup."Status Code Label Send",'');
                  IF ParcelStatusHistoryArchive.ISEMPTY THEN
                    IF Filter_l = '' THEN
                      Filter_l := FORMAT(SOLineArchive."Line No.")
                    ELSE
                      Filter_l += '|' + FORMAT(SOLineArchive."Line No.");
                END;
            END;
            //E/P1133
          UNTIL SOLineArchive.NEXT = 0;
        SOLineArchive.SETRANGE("Purchasing Code");
        SOLineArchive.SETFILTER("Line No.",Filter_l);
      END;
      // E/P1142
    END;

    PROCEDURE "************* HME ************"@1000000018();
    BEGIN
    END;

    PROCEDURE ProcessFiegeEntries@1000000019();
    VAR
      SalesHeaderL@1000000008 : Record 36;
      DHLParcelStatusL@1000000003 : Record 50021;
      DHLParcelStatusL2@1000000009 : Record 50021;
      ImportDHLProactiveL@1000000000 : Record 50097;
      Text001@1000000001 : TextConst 'ENU=There is nothing to post.';
      Text002@1000000002 : TextConst 'ENU=Es gibt nichts zu buchen.';
      ImportDHLProactiveL2@1000000004 : Record 50097;
      DD@1000000005 : Integer;
      MM@1000000006 : Integer;
      YYYY@1000000007 : Integer;
    BEGIN
      // H0730 FX 06.12.13 ++++++++++++++++++++++++++++++++++++++++++++
      ImportDHLProactiveL.SETCURRENTKEY(Done,"Process Error","Normal Import");
      ImportDHLProactiveL.SETRANGE("Shipping Agent", 'FIEGE');
      ImportDHLProactiveL.SETRANGE(Done, FALSE);
      ImportDHLProactiveL.SETRANGE("Process Error", FALSE);
      ImportDHLProactiveL.SETRANGE("Normal Import", TRUE);
      IF ImportDHLProactiveL.FIND('-') THEN BEGIN
        REPEAT
          DHLParcelStatusL.RESET;
          DHLParcelStatusL2.FINDLAST;
          DHLParcelStatusL."Entry No." := DHLParcelStatusL2."Entry No." + 1;
          DHLParcelStatusL."DHL Shipment Code" := ImportDHLProactiveL."DHL Shipment";
          DHLParcelStatusL."Account Number" := ImportDHLProactiveL."Account Number";
          DHLParcelStatusL."Time Stamp" := CREATEDATETIME(ConvertFiegeDate(ImportDHLProactiveL."Time Stamp"), 0T);
          DHLParcelStatusL."Status Event" := ImportDHLProactiveL."Event Code";
          DHLParcelStatusL."Document Type" := DHLParcelStatusL."Document Type"::Order;
          DHLParcelStatusL."Document No." := ImportDHLProactiveL."Sales Order No.";
          DHLParcelStatusL."Document Line No." := ImportDHLProactiveL."Line No.";
          DHLParcelStatusL."Delivery Date" := ConvertFiegeDate(ImportDHLProactiveL."Delivery Date");
          DHLParcelStatusL."Import Time Stamp" := ImportDHLProactiveL."Import Timestamp";
          EVALUATE(DHLParcelStatusL."Shipment through", ImportDHLProactiveL."Shipment through");
          DHLParcelStatusL."Shipping Agent" := ImportDHLProactiveL."Shipping Agent";
          DHLParcelStatusL."Imported over JOBQUEUE" := TRUE;
          DHLParcelStatusL."Time Difference" := DHLParcelStatusL."Time Stamp" - DHLParcelStatusL."Import Time Stamp";
          IF SalesHeaderL.GET(SalesHeaderL."Document Type"::Order, ImportDHLProactiveL."Sales Order No.") THEN
            DHLParcelStatusL."Order Date" := SalesHeaderL."Order Date";
          CLEARLASTERROR;
          //H0875  18.02.14  MBY  ++++++++++++++++++++++++++++
          {
          //H0875  18.02.14  MBY  ----------------------------
          IF DHLParcelStatusL.INSERT THEN BEGIN
          //H0875  18.02.14  MBY  ++++++++++++++++++++++++++++
          }
          IF DHLParcelStatusL.INSERT(TRUE) THEN BEGIN
          //H0875  18.02.14  MBY  ----------------------------
            ImportDHLProactiveL2 := ImportDHLProactiveL;
            ImportDHLProactiveL2.Done := TRUE;
            ImportDHLProactiveL2.MODIFY;
            InsertLogEntry('', Text003, 0, FALSE, FALSE);
          END ELSE BEGIN
            ImportDHLProactiveL2 := ImportDHLProactiveL;
            ImportDHLProactiveL2."Process Error" := TRUE;
            ImportDHLProactiveL2.MODIFY;
            InsertLogEntry('', Text011, 0, TRUE, FALSE);
          END;
        UNTIL ImportDHLProactiveL.NEXT = 0;
      END;
      // H0730 FX 06.12.13 --------------------------------------------
    END;

    PROCEDURE ConvertFiegeDate@1000000027(DateText@1000000003 : Text[12]) : Date;
    VAR
      YYYY@1000000002 : Integer;
      MM@1000000001 : Integer;
      DD@1000000000 : Integer;
    BEGIN
      // H0730 FX 06.12.13 +++++++++++++++++++++++
      IF STRLEN(DateText) <> 10 THEN
        EXIT;
      IF NOT EVALUATE(YYYY, COPYSTR(DateText, 7, 4)) THEN
        EXIT(0D);
      IF YYYY < 100 THEN
        YYYY := 2000 + YYYY;
      IF NOT EVALUATE(MM, COPYSTR(DateText, 4, 2)) THEN
        EXIT(0D);
      IF NOT EVALUATE(DD, COPYSTR(DateText, 1, 2)) THEN
        EXIT(0D);
      IF DD * MM * YYYY = 0 THEN
        EXIT(0D);

      EXIT(DMY2DATE(DD, MM, YYYY));
      // H0730 FX 06.12.13 ----------------------------
    END;

    BEGIN
    {
      31.10.11 Import EasyLog files
      24.01.12 Change Easylog to DHL
      10.07.12  chrmu change hardcoded old purch codes to new (PAKET-LAG to GER-2)
      19.07.12  nas changed date format
      23.07.12  nas - remove sequence number from the order no
      24.07.12  nas filter by Parcel Channel
      25.07.12  nas remove old code
      DYN0007  08.08.12  nas  removed filtering by Account No.
      DYN0008  08.08.12  nas  run only new entrie
      03.08.12  P0133 gob-rste  New Code for GER-7
      20.08.12  P0217 gob-dst   Change in GER-9 function
      23.08.12  P0227 gob-dst   Further Change in GER-9 function
      29.08.12  P0246 gob-lku   Second run with different setup for manually imported data
      30.08.12  P0259 gob-lku   Bugfix: Qty. to Ship = 0 for all Lines before setting Qty. to Ship
      04.09.12  P0275 gob-lku   Do not fill negative Outstanding Qty. into Qty. to Ship
      04.09.12  P0276 gob-lku   Ignore Account No. for checking existing DHLParcelsStatusHistory (Update functions)
      05.09.12  P0287 gob-lku   Check Sales Archive for SONo if Sales Order doesn't exist
      07.09.12  P0299 gob-lku   DHL Proactive man. import with new import table and second job queue entry
      10.09.12  P0302 gob-rste  New Code for Import Return Order Tracking
      18.09.12  P0334 gob-lku   Check SONo Length before reducing its length / ignore STA Import Filter
      19.09.12  P0353 gob-lku   several changes
      21.09.12  P0365 gob-lku   GET FCP Setup earlier
      10.10.12  P0425 gob-lku   Don't check for Komm. and further changes
      10.10.12  P0429 gob-lku   Fill new DHL Parcels History fields
      11.10.12  P0443 gob-Fuchs Fehlerhaftes INIT entfernt
      17.10.12  P0455 gob-lku   Fix modifying wrong "Posting Date" in Sales Header
      23.10.12  P0480 gob-lku   Abfangen der Validierungsprfung von Qty. to Ship
      23.10.12  P0486 gob-lku   Erm”glichen eines nachtr„glichen Imports der normalen DHL Dateien
      24.10.12  P0490 gob-lku   Anpassung der Filterung fr Sales Line
      26.10.12  P0522 gob-lku   Neues Feld "Import Timestamp" bei man. DHL Import fllen
      26.10.12  P0524 gob-lku   Check TimeStamp without seconds
      29.10.12  P0528 gob-lku   Kanal 9 auch fr NL / FR und auch Status in DocData, wenn mit SO bermittelt
      30.10.12  P0531 gob-lku   Fix Kanal 9 Archive / TimeStamp
      31.10.12  P0538 gob-rste  New Code GER-12 for Partnerprogramm 2.0
      06.11.12  P0553 gob-lku   GER-7: Filter Sales Line with TimeStamp
      08.11.12  P0566 gob-lku   Filter PLZ / normal Import into table 50097
      13.11.12  P0579 gob-lku   Bugfix: Getten des Headers abfangen, da bei l”schen alter Archiv-Auftr„ge nur Header gel”scht wurde
      14.11.12  P0583 gob-lku   man. Importaufruf durch 2 Jobs (Unterscheidung der Anzahl Tags / Nachts)
      15.11.12  P0590 gob-lku   COMMIT nach jeder Zeile
      04.12.12  P0638 gob-lku   Fix DHL Import Kanal 2 -> keine Filterung auf Artikel
      11.12.12  P0661 gob-lku   Logik der Lieferungsbuchung erweitert
      11.12.12  P0664 gob-lku   Tats„chliches Lieferdatum fllen
      17.12.12  P0683 gob-lku   Fix: SONo ggf. auf L„nge 20 krzen
      20.12.12  P0709 gob-lku   Fix: DHL-Beschreibungsfelder in der Importdatei abfangen
      08.01.13  P0726 gob-lku   Status Error bei Import: Neue Bedingungen fr Error / Kanal-Filterung anpassen
      11.01.13  P0734 gob-lku   Fill in Shipping Agent in Tbl 50021
      23.01.13  P0761 gob-lku   Actual Delivery Date nicht mehr fllen
      25.01.13  P0770 gob-lku   Bugfix Kanal 9
      14.02.13  P0564 gob-rste  Fill Interface Process Log INDELIVERY
      01.03.12  P0841 gob-rste  New Keys for MANUALIMPORT
      15.05.13  P0916 gob-lku   Bugfix fr Import ohne PLZ und ohne SONo
      15.05.13  P0914 gob-adb   Performance
      13.06.13  P0963 gob-lku   Fill in PO Number in DHL Parcel Status History (Dropship) & Filter for Channel 13
      27.06.13  P0998 gob-mab   PLZ bei Int. DS Aufgrund fiktiver PLZ aus
      06.08.13  P1014 gob-adb   Setcurrentkeys eingefgt
      13.08.13  P1051 gob-lku   Anpassungen fr IFTMIN / Import mehrerer Sendungsnummern pro Zeile
      24.09.13  P1113 gob-lku   Bugfix: Bei archivierten Ordern ebenfalls PLZ bercksichtigen
      24.09.13  P1115 gob-lku   Bugfix: Filterung der DHL Shiptment No.
      28.10.13  P1135 gob-rste  Bugfix: Wrong trackingstatus Channel 11 -> Channel 9
      29.10.13  P1139 gob-lku   Bugfix: durch andere Sendungsnummern gelieferte Zeilen ebenfalls suchen
      05.11.13  P1142 gob-lku   Erst bei Lieferung andere Zeilen bercksichtigen
      20.11.13  P1155 gob-lku   Bugfix Get Archive

      +--------------------------------------------+
      |                                            |
      |                  Home24                    |
      |     Cooperation GOB & Home24 NAV Team      |
      |                                            |
      +--------------------------------------------+

      Project No. Date      Shortcut  Description
      _____________________________________________
      P1117       14.10.13  gob-mlan  - Redesign of "DHL Parcel Status History"
                                      - Code within with //S/P1117/++S+++++++ and //E/P1117/--E-------
                                        will be replaced by the new code and/or it will be deactivated
      P1129       21.10.13  gob-mlan  - Redesign of "DHL Parcel Status History" Phase 2
                                      - Code within with //S/P1129/++S+++++++ and //E/P1129/--E-------
                                        will be replaced by the new code and/or it will be deactivated
      P1133       07.11.13  gob-mlan  - Redesign of "DHL Parcel Status History"
      P1179       16.01.14  gob-mlan  - Fix after test response M. Matyushenko

      +--------------------------------------------+
      |                                            |
      |                  Home24                    |
      |       Internal Customizing by NAV-Team     |
      |                                            |
      +--------------------------------------------+

      Project No. Date      Shortcut  Description
      _____________________________________________
      H0686       04.12.13  MBY       Execute OnInsert trigger in "DHL Parcels Status History" table
      H0875       18.02.14  MBY       Execute OnInsert trigger in "DHL Parcels Status History" table
      H0977       31.03.14  MBY       Shipment Consolidation Phase I + CLEANUP
      H1006       14.04.14  MBY       Stop Filling Import Framework Log
      H1057       23.04.14  MBY       Shipment Consolidation Phase III
      H0550       09.09.13  ARI       Dialog only if GUIALLOWED
      H0733       26.11.13  ABR       Find unique Sales Line
      H1379       18.09.14  EHN       DHL EasyLog Import: Timestamp Interface is not filled all the time
      H1952       06.01.14  DMA       BUG: DHL Tracking is incomplete in  parcel status history table, CODECHANGE
      H1980       04.02.15  EHN       Set ADD for LF lines without tracking information - Filter for correct sales lines
    }
    END.
  }
}

