OBJECT Codeunit 50003 FPC Management
{
  OBJECT-PROPERTIES
  {
    Date=08.07.15;
    Time=10:02:42;
    Modified=Yes;
    Version List=GOB1.00,SII,HME2103,T0096,HME4307;
  }
  PROPERTIES
  {
    OnRun=VAR
            SalesLineL@1000000001 : Record 37;
            SalesHeaderL@1000000000 : Record 36;
            ChannelManagementL@1000000002 : Codeunit 50093;
          BEGIN
            // P1224, H0587 19.06.14 HCN +++++++++++++++++++++++++++++
            IF GlobOrderNo <> '' THEN BEGIN
              IF GlobLineNo <> 0 THEN BEGIN
                SalesLineL.RESET;
                SalesLineL.GET(SalesLineL."Document Type"::Order,GlobOrderNo,GlobLineNo);
                CASE CancellationMode OF
                  CancellationMode::ManualRequestCancel:
                    BEGIN
                      SalesLineL.SetCancellationMode(CancellationMode);
                      SalesLineL.MagentoCancel(FALSE,FALSE);
                    END;
                  CancellationMode::" ",
                  CancellationMode::ManualConfirmCancel:
                    BEGIN
                      //H0587 22.07.14 HCN +++++++++++++++++++++++++++++
                      IF ChannelManagementL.CheckIfDropShipmentOrCrossDock(SalesLineL) THEN BEGIN
                      //H0587 22.07.14 HCN -----------------------------
                        ChannelManagementL.SetCancellationMode(CancellationMode);
                        ChannelManagementL.CancelDropShipment(SalesLineL,FALSE)
                      END ELSE BEGIN
                        SalesLineL.SetCancellationMode(CancellationMode);
                        SalesLineL.MagentoCancel(FALSE,FALSE);
                      END;
                    END;
                END;
              END ELSE BEGIN
                SalesHeaderL.SetCancellationMode(CancellationMode);
                SalesHeaderL.GET(SalesHeaderL."Document Type"::Order,GlobOrderNo);
                SalesHeaderL.MagentoCancel;
              END;
            END;
            // P1224, H0587 19.06.14 HCN -----------------------------
          END;

  }
  CODE
  {
    VAR
      Text001@1108200000 : TextConst 'DEU=Umtausch Folgeauftrag %1 wurde erstellt!;ENU=Change Follow-up Order %1 has been created.';
      Text002@1000000004 : TextConst 'DEU=Sie sollten nur ein Drop Shipment stornieren wenn Sie bereits eine Best‚Äûtigung des Herstellers per E-Mail/Phone erhalten haben.\Haben Sie diese erhalten und m‚Äùchten Sie jetzt stornieren?;ENU=You should only cancel this drop shipment if you have received a confirmation from the manufacturer/supplier.\Do you have received it? Do you really want to cancel now?';
      Text003@1000000006 : TextConst 'DEU=<Es gibt keine Bestellung zur Archivierung!!>;ENU=There is no order for archiving.';
      Text004@1000000008 : TextConst 'DEU="Die %1 dieses DS-Auftrags wurde storniert am ";ENU="Line %1 of this Drop-Ship-Order was cancelled at "';
      Error001@1108200001 : TextConst 'DEU=Zu der Reklamationszeile gibt es schon einen Folgeauftrag!;ENU=A Follow-up Order does exist already for this Return Order Line!';
      Error002@1108200002 : TextConst 'DEU=Vermeidungsrabatt kann nicht berechnet werden, da bereits ein Folgeauftrag erstellt wurde (Zeilennr. %1)!;ENU=The prevention discount cannot be calculated because a follow-up order has been created already (Line No. %1).';
      Error003@1108200003 : TextConst 'DEU=Der Rabattbetrag ist zu hoch (Zeilennr. %1) !;ENU=The discount amount is too high (Line No. %1).';
      Error004@1108200004 : TextConst 'DEU=Auftragsnummer darf nicht leer sein!;ENU=Order number can not be empty.';
      Error005@1108200005 : TextConst 'DEU=%1 darf nicht leer sein (Zeilennr. %2).;ENU=%1 must not be empty (Line No. %2).';
      Error006@1108200006 : TextConst 'DEU=Sie m¬Åssen den Vermeidungsrabatt angeben (Betrag oder Prozent)(Zeilennr. %2) !;ENU=You must specify the prevention discount (amount or percentage)(Line No.%1) !';
      Error010@1108200016 : TextConst 'DEU=Vermeidung angenommen darf nicht ja bei %1 sein!;ENU=Prevention may not even be accepted at %1.';
      Error011@1108200017 : TextConst 'DEU=Auftrag %1 mit Zeilennr. %2 wurde noch nicht geliefert, daher kann keine Umtauschanfrage erstellt werden!;ENU=Order %1 with Line no. %2 has not yet been delivered, therefore no conversion request will be created.';
      Error013@1108200019 : TextConst 'DEU=Kulanzbetrag oder Kulanz Prozentsatz muss bei Kulanz gef¬Ållt sein!;ENU=Goodwill amount or percentage of goodwill must be filled with grace!';
      Error015@1108200021 : TextConst 'DEU=Mit Artikel %1 ist eine Resource verkn¬Åpft. Bitte ¬Åbernehmen Sie diese ebenfalls!!!;ENU=With item %1 is one linked Resource. Please accept this as well.';
      Error016@1108200022 : TextConst 'DEU=Zum Auftrag "%1", Zeilennr. "%2" existiert bereits eine ungebuchte Return Order "%3" !\Bitte ‚Äûnderen Sie Ihre Auswahl.;ENU=There is already an unposted return order "%3" for Sales Order "%1", Line No. "%2" !\Please change your selection.';
      Error017@1000000000 : TextConst 'DEU=F¬År die Zeile %1 im Auftrag %2 existiert bereits eine Reklamation!;ENU=Return Order exists for Order %2 and Line No %1';
      Error018@1000000001 : TextConst 'DEU=In %1 %2 sind keine Artikelmengen vorhanden! Erstellung E-Mail fehlgeschlagen!;ENU=%1 %2 without quantities. Creating e-mail failed.';
      Error019@1000000005 : TextConst 'DEU=Der Kommissionierkanal %1 ist kein Drop Shipment!;ENU=%1 is not a drop shipment channel.';
      LineStatus001@1108200010 : TextConst 'DEU=Retoure %1 wurde erstellt!;ENU=Return %1 has been created.';
      LineStatus002@1108200011 : TextConst 'DEU=Stornoanfrage wurde erstellt!;ENU=Cancellation request has been created.';
      LineStatus003@1108200012 : TextConst 'DEU=Kulanzanfrage wurde erstellt!;ENU=Goodwill request has been created.';
      LineStatus004@1108200013 : TextConst 'ENU=Reclamation %1 has been created.';
      LineStatus005@1108200014 : TextConst 'DEU=Umtauschanfrage %1 wurde erstellt!;ENU=Exchange request %1 has been created.';
      LineStatus006@1108200015 : TextConst 'DEU=Ersatzteilauftrag %1 wurde erstellt!;ENU=Spare Parts Order %1 has been created.';
      FPCGeneralSetup@1000000044 : Record 50055;
      SalesReceivablesSetup@1000000029 : Record 311;
      ReturnOrderPreventionTemp@1000000033 : TEMPORARY Record 36;
      PurchaseHeaderTmp@1000000068 : TEMPORARY Record 38;
      PurchaseHeaderDropShipTmp@1000000070 : TEMPORARY Record 38;
      PurchaseHeaderSpecOrdTmp@1000000069 : TEMPORARY Record 38;
      SalesHeader@1000000074 : Record 36;
      SalesLineDSTmp@1000000075 : TEMPORARY Record 37;
      SalesLineDSCDTmp@1000000096 : TEMPORARY Record 37;
      SalesLineToBeCancelled@1000000100 : Record 37;
      SalesLineToBeProcessedTmp@1000000076 : TEMPORARY Record 37;
      SalesLineToBeProcessedTmp2@1000000088 : TEMPORARY Record 37;
      SalesLineToBeProcessedTmp3@1000000091 : TEMPORARY Record 37;
      SalesHeaderArchive@1000000067 : Record 5107;
      SalesLineArchToBeProcessedTmp@1000000082 : TEMPORARY Record 5108;
      SalesLineArchToBeProcessedTmp2@1000000089 : TEMPORARY Record 5108;
      SalesLineArchToBeProcessedTmp3@1000000090 : TEMPORARY Record 5108;
      UserSetup@1000000073 : Record 91;
      POCancInquiry_Functions@1000000072 : Codeunit 50146;
      GlobOrderNo@1000000002 : Code[20];
      GlobLineNo@1000000003 : Integer;
      Confirm001@1000000007 : TextConst 'DEU=F¬År die Auftragszeile %1 %2 wurde bereits ein Vermeidungsrabatt gebucht (Gutschrift). Wollen Sie fortfahren?;ENU=Order line %1 %2 already has been granted a prevention discount (posted credit memo). Do you want proceed?';
      Error020@1000000009 : TextConst 'DEU=Funktionsausf¬Åhrung abgebrochen.;ENU=Execution of function aborted.';
      Message001@1000000010 : TextConst 'DEU=Reklamation %1 erstellt!;ENU=Return Order %1 created.';
      GlobRecRef@1000000011 : RecordRef;
      Text005@1000000012 : TextConst 'DEU=Return Order for Change Order %1;ENU=Return Order for Change Order %1';
      SalesLineRecRef@1000000087 : RecordRef;
      HideValidationDialog@1000000013 : Boolean;
      Text006@1000000023 : TextConst 'ENU=No Return Order was created.';
      Text007@1000000024 : TextConst 'ENU=No Return Order was created because there are no lines in this Sales Order.';
      Error021@1000000014 : TextConst 'DEU=Der Dimensionswert %1 f¬År Auftragszeile %2 ist keine g¬Åltige Auftragsnummer!;ENU=Dimension Value %1 to Order Line %2 is not valid.';
      Error022@1000000016 : TextConst 'DEU=Der Dimensionswert %1 f¬År Auftrag %2 ist keine g¬Åltige Auftragsnummer!;ENU=Dimension Value %1 to Order %2 is not valid.';
      Error023@1000000017 : TextConst 'DEU=Der Dimensionswert %1 f¬År Auftragszeile %2 ist keine g¬Åltige Auftragsnummer und muss manuell in der Reklamation ge‚Äûndert werden!;ENU=Dimension Value %1 to Order Line %2 is not valid and has to be change in return document.';
      Error024@1000000015 : TextConst 'DEU=Der Dimensionswert %1 f¬År Auftrag %2 ist keine g¬Åltige Auftragsnummer und muss manuell in der Reklamation ge‚Äûndert werden!;ENU=Dimension Value %1 to Order %2 is not valid and has to be changed in retrun document.';
      Error025@1000000018 : TextConst 'DEU=F¬År Artikel %1 (Auftragnr.: %2, Zeilennr.: %3) existiert bereits eine ungebuchte Return Order.\Bitte buchen Sie den Beleg zuerst (wenn sinnvoll).;ENU=Item %1 (Order No.: %2, Line No.: %3) is already subject of an unposted return order.\If possible, please post it first.';
      ChangeOrderNo@1000000019 : Code[20];
      Error026@1000000020 : TextConst 'DEU=Vorgang durch den Anwender unterbrochen!;ENU=Is interrupted by the user!';
      Confirm002@1000000021 : TextConst 'DEU=Zeilenbetrag der Reklamationszeile (%1, %2) stimmt nicht mit der Verkaufszeile ¬Åberein! Wollen Sie fortfahren?;ENU=Line Amount in Return Line (%1, %2) different to Sales line. Do you want to continue?';
      Error027@1000000022 : TextConst 'DEU=Vermeidungsrabatt darf nicht gr‚Äù√°er als Ursprungsartikelbetrag sein!;ENU=Prevention Discount can not be greather than the source item amount!';
      TextHME001@1000000025 : TextConst 'ENU="Balancing Interim Cr.Memo No. "';
      TextHME002@1000000026 : TextConst 'ENU=Interim Cr.Memo';
      TextHME003@1000000027 : TextConst 'ENU=Balancing Interim Cr.Memo';
      TextHME004@1000000028 : TextConst 'ENU="%1 %2 cannot be counter-posted. "';
      TextHME005@1000000031 : TextConst 'ENU=Order %1 with Line no. %2 has already been delivered, so no prevention will be created.';
      TextHME006@1000000036 : TextConst 'DEU=Es konnte keine Kundenreklamation erfa√°t werden.;ENU=No Customer Complaint has been processed.';
      TextHME007@1000000037 : TextConst 'DEU=Bei der Reklamationsart "Retour" darf das Feld "%1" nicht auf "leer" oder "angeboten" gesetzt sein (Zeilennr. %2). (Zeile wird ¬Åbersprungen.);ENU=For customer complaint type "Return" field "%1" must not be set to "blank" or "offered" (Line No. %2). (Line will be skipped.)';
      TextHME008@1000000038 : TextConst 'DEU=Bei der Reklamationsart "Retoure" darf das Feld "%1" nicht auf "akzeptiert" gesetzt sein (Zeilennr. %2).;ENU=For customer complaint type "Return" field "%1" must not be set to "accepted" (Line No. %2).';
      TextHME009@1000000039 : TextConst 'DEU=Bei der Reklamationsart "Umtausch" darf das Feld "%1" nicht auf "akzeptiert" gesetzt sein (Zeilennr. %2). (Zeile wird ¬Åbersprungen.);ENU=For customer complaint type "change" field "%1" must not be set to "accepted" (Line No. %2). (Line will be skipped.)';
      TextHME010@1000000040 : TextConst 'DEU=Bei der Reklamationsart "Ersatzteil" darf das Feld "%1" nicht auf "akzeptiert" gesetzt sein (Zeilennr. %2). (Zeile wird ¬Åbersprungen.);ENU=For customer complaint type "spare part" field "%1" must not be set to "accepted" (Line No. %2). (Line will be skipped.)';
      TextHME011@1000000042 : TextConst 'DEU=Unzul‚Äûssige Option in Feld "%1" (Zeilennr. %2). (Zeile wird ¬Åbersprungen.);ENU=Impermissible Option of field "%1" in Line %2. (Line will be skipped.)';
      TextHME012@1000000041 : TextConst 'DEU=Zeile %1 wurde bereits rabattiert (Vermeidung vor Lieferung) und wird daher ¬Åbersprungen.;ENU=Line No. %1 has been subject to a prevention before shipment already and thus will be skipped.';
      TextHME013@1000000043 : TextConst 'DEU=Return Order %1 erstellt und vollst‚Äûndig gebucht.;ENU=Return Order %1 has been created and completely posted.';
      TextHME014@1000000045 : TextConst 'DEU=Zeile %1 wurde bereits storniert oder zwecks Stornierung angefragt. (Zeile wird ¬Åbersprungen.);ENU=Line %1 has been cancelled or requested for cancellation already. (Line will be skipped.)';
      TextHME015@1000000046 : TextConst 'DEU=Zeile %1 wurde bereits zur¬Åckgeschickt. Keine weitere Reklamation m‚Äùglich!;ENU=Line %1 has been already been returned. No more customer complaints possible!';
      TextHME016@1000000047 : TextConst 'DEU=F¬År Zeile %1 wurde bereits Umtauschauftrag gebucht. Keine weitere Reklamation m‚Äùglich!;ENU=Line %1 has been already been returned (change). No more customer complaints possible!';
      TextHME017@1000000050 : TextConst 'DEU=Sie k‚Äùnnen keinen bezahlten Auftrag %1 mit K‚Äûuferschutz stornieren.;ENU=You can''t Cancel a payed Order %1 with Trusted Shop.';
      TextHME018@1000000049 : TextConst 'DEU=Line No. %1: Sie k‚Äùnnen diese Auftrag nicht mehr automatisiert ¬Åber die Rhenus Schnittstelle stornieren.\ Sie m¬Åssen bei Rhenus erfragen, ob eine Stornierung noch m‚Äùglich ist. Wollen Sie fortfahren?;ENU=Zeilennr. %1: You cannot cancel this order via Rhenus interface. You have to check, if a cancelation is still possible. Do you wish to continue?';
      TextHME019@1000000048 : TextConst 'DEU=Sie k‚Äùnnen diese Position (%1) nicht mehr automatisiert ¬Åber das DocData Interface stornieren.\ Sie m¬Åssen bei DocData erfragen, ob eine Stornierung noch m‚Äùglich ist. Wollen Sie fortfahren?;ENU=You cannot cancel this order line (%1) via DocData interface. You have to check, if a cancelation is still possible. Do you want to continue?';
      TextHME021@1000000066 : TextConst 'ENU=No records have been highlighted or marked.';
      TextHME022@1000000065 : TextConst 'ENU=Sales Line No. %1 must be either marked as drop shipment or special order.';
      TextHME023@1000000064 : TextConst 'ENU=Sales Line No. %1: Field "%2" must not be set to "%3". (Line will be skipped.)';
      TextHME024@1000000063 : TextConst 'ENU=No e-mail-address has been specified for vendor no. %1, %2.';
      TextHME025@1000000062 : TextConst 'ENU=No Pretext with language code "%1" has been specified (Vendor %2 %3).';
      TextHME026@1000000061 : TextConst 'ENU=No Posttext with language code "%1" has been specified (Vendor %2 %3).';
      TextHME027@1000000060 : TextConst 'ENU=Sales Line No. %1: Field "%2" must not be set to zero.';
      TextHME028@1000000059 : TextConst 'ENU=The sales line(s) marked do not qualify for this function.';
      TextHME029@1000000058 : TextConst 'ENU=No Pretext marked for all languages has been found.';
      TextHME030@1000000057 : TextConst 'ENU=No Posttext marked for all languages has been found.';
      TextHME031@1000000056 : TextConst 'ENU=Sales Line No. %1: Field "%2" must not be set to "yes".';
      TextHME032@1000000055 : TextConst 'ENU=SalesLine %1 has been set up for a cancellation inquiry already (Status: %2).';
      TextHME033@1000000054 : TextConst 'ENU=%1 Drop shipment cancellation inquiry e-mail(s) has (have) been queued for sending.';
      TextHME034@1000000053 : TextConst 'ENU=%1 Cross docking cancellation inquiry e-mail(s) has (have) been queued for sending.';
      TextHME035@1000000077 : TextConst 'DEU=F¬År Zeilennr. "%1" existiert bereits eine ungebuchte Return Order "%2" ! (Zeile wird ¬Åbersprungen.);ENU=There is already an unposted return order "%2" for Line No. "%1" ! (Line will be skipped.)';
      TextHME036@1000000078 : TextConst 'DEU=Sie m¬Åssen einen Reklamationsgrund angeben (Zeilennr. %1) ! (Zeile wird ¬Åbersprungen.);ENU=You must specify a reason for the complaint (Line No. %1) ! (Line will be skipped.)';
      TextHME037@1000000079 : TextConst 'DEU=%1 darf nicht leer sein (Zeilennr. %2). (Zeile wird ¬Åbersprungen.);ENU=%1 must not be empty (Line No. %2). (Line will be skipped.)';
      TextHME038@1000000080 : TextConst 'DEU=Sie m¬Åssen den Vermeidungsrabatt angeben (Betrag oder Prozent)(Zeilennr. %2) ! (Zeile wird ¬Åbersprungen.);ENU=You must specify the prevention discount (amount or percentage)(Line No.%1) ! (Line will be skipped.)';
      TextHME039@1000000081 : TextConst 'DEU=Archivierte Verkaufauftragszeilen k‚Äùnnen nicht storniert werden (Zeilennr. %1). (Zeile wird ¬Åbersprungen.);ENU=Archived sales lines must not be canceled (Line No. %1). (Line will be skipped.)';
      TextHME040@1000000084 : TextConst 'DEU=Auftrag %1 mit Zeilennr. %2 wurde noch nicht geliefert, daher kann keine Return Order erstellt werden! (Zeile wird ¬Åbersprungen.);ENU=Order %1 with Line no. %2 has not yet been shipped, therefore, no return order can be created ! (Line will be skipped.)';
      TextHME041@1000000085 : TextConst 'DEU=Auftrag %1 mit Zeilennr. %2 wurde bereits geliefert, daher kann kein Storno erstellt werden! (Zeile wird ¬Åbersprungen.);ENU=Order %1 with Line no. %2 has already been shipped, therefore no cancellation can be created ! (Line will be skipped.)';
      TextHME042@1000000086 : TextConst 'DEU=Auftrag %1 mit Zeilennr. %2 wurde noch nicht geliefert, daher kann keine Ersatzteilanfrage erstellt werden! (Zeile wird ¬Åbersprungen.);ENU=Order %1 with Line no. %2 has not yet been delivered, therefore, no spare part request will be created. (Line will be skipped.)';
      TextHME043@1000000093 : TextConst 'DEU=Die Felder "%" und "%2" m¬Åssen bei Dropshipment gef¬Ållt sein. (Zeile %3 wird ¬Åbersprungen).;ENU=The fields "%1" and "%2" must be filled for Dropshipment. (Line %3 will skipped.)';
      TextHME044@1000000094 : TextConst 'DEU=Die Felder "%" und "%2" m¬Åssen bei Crossdocking gef¬Ållt sein. (Zeile %3 wird ¬Åbersprungen).;ENU=The fields "%1" and "%2" must be filled for Crossdocking. (Line %3 will skipped.)';
      TextHME045@1000000095 : TextConst 'DEU=Zeile %1 wird ¬Åbersprungen.;ENU=Line %1 will skipped.';
      TextHME046@1000000101 : TextConst 'ENU=Cancellation of Sales Order %1, Line No. %2 not possible for the reason(s) shown before.';
      TextHME047@1000000103 : TextConst 'ENU=No cancelable sales line found for sales order no. %1.';
      TextHME048@1000000104 : TextConst 'ENU=A Follow-up Order can only be created for a Change-Return Order.';
      TextHME049@1000000105 : TextConst 'ENU=A Follow-up Order (%1) for Return Order "%2" does exist already. Function aborted.';
      TextHME050@1000000107 : TextConst 'ENU=As requested Line %1 will be skipped.';
      TextHME051@1000000110 : TextConst 'ENU=Translation for month %1 language %2 is missing in table %3';
      TextHME052@1000000111 : TextConst 'DEU=Ersatzteilauftrag %1 erstellt!;ENU=Sparepart Order %1 created.';
      TextHME053@1000000112 : TextConst 'DEU=%1 ErsatzteilauftrÑge erstellt!;ENU=%1 Sparepart Orders created.';
      "*** P1182 ***"@1000000030 : TextConst;
      Error028@1000000032 : TextConst 'DEU=Zeilennr. %1 wurde durch den EDI Partner %2 physisch noch nicht ausgeliefert. Bitte stornieren Sie diese Zeile (die Lieferung wird dadurch r¬Åckg‚Äûngig gemacht)!\Zeile wird erst einmal ¬Åbersprungen.;ENU=Line No. %1 has not been delivered by EDI partner %2 yet. Please cancel this line (thereby the shipment will be undone)!\Line will be skipped during the execution of this function.';
      Error029@1000000051 : TextConst 'DEU=Zeilennr. %1 wurde noch nicht ausgeliefert. Bitte stornieren Sie diese Zeile!;ENU=Line No. %1 has already been delivered. Please create a return order for this line!';
      "*** H0866 ***"@1000000034 : TextConst;
      FITLER_STRING_TOO_LONG@1000000035 : TextConst 'ENU=Filter string too long.';
      bIFTMINSendOnlyOnce@1000000052 : Boolean;
      BypassDSCDCheck@1000000102 : Boolean;
      DoProcessCurrentLine@1000000083 : Boolean;
      IsFirstLineToCancel@1000000098 : Boolean;
      IsFirstLoop@1000000092 : Boolean;
      SalLineDSCDToBeCancelledExists@1000000071 : Boolean;
      CancellationCase@1000000097 : ' ,CancelNothing,CancelOneLine,CancelSeveralLines,CancelOrder';
      DoCancelWhat@1000000099 : ' ,CancelOrder,CancelLine';
      CreateReturnOrderNo@1000000106 : Code[20];
      CalledRecursive@1000000108 : Boolean;
      CancellationMode@1000000109 : ' ,ManualRequestCancel,ManualConfirmCancel';
      InvH24Mgt@1000001111 : Codeunit 50321;
      "*TEC**************************"@1100409000 : Integer;
      MPCommissionMgt@1100409001 : Codeunit 50502;
      "* HME ************************"@1000001112 : Integer;
      SkipUpdateDeliveryDaysOnSO@1000001113 : Boolean;
      AppliedFromItemEntry@1000000113 : Integer;

    PROCEDURE QtyStringUsedInString@1108200001(p_String@1108200000 : Text[1024];p_SearchString@1108200001 : Text[1024];p_UseUppercase@1108200002 : Boolean) r_QtyUsed : Integer;
    BEGIN
      r_QtyUsed := 0;
      IF (p_String <> '') AND (p_SearchString <>'') THEN BEGIN
        IF p_UseUppercase THEN BEGIN
          p_String := UPPERCASE(p_String);
          p_SearchString := UPPERCASE(p_SearchString);
        END;
        IF STRPOS(p_String,p_SearchString) <> 0 THEN BEGIN
          REPEAT
            IF STRPOS(p_String,p_SearchString) <> 0 THEN BEGIN
              r_QtyUsed +=1;
              p_String := COPYSTR(p_String,STRPOS(p_String,p_SearchString) +1,STRLEN(p_String));
            END;
          UNTIL STRPOS(p_String,p_SearchString) = 0;
        END;
      END;

      EXIT(r_QtyUsed);
    END;

    PROCEDURE CheckForPickingInterruption@1108200000(VAR p_SalesHeader@1108200000 : Record 36);
    VAR
      StreetSearchNameLoc@1108200001 : Code[30];
      DHLStreetcodes@1108200002 : Record 50047;
      FPCGeneralSetup@1108200003 : Record 50055;
      SalesCommentLine@1000000000 : Record 44;
      CheckComment@1000000001 : Boolean;
      CheckAddress@1000000002 : Boolean;
    BEGIN
      FPCGeneralSetup.GET;
      //A/gob-rste/06.09.12/P0292
      CheckComment := FALSE;
      CheckAddress := FALSE;
      //E/gob-rste/06.09.12/P0292
      // Check Comment
      IF FPCGeneralSetup."Check Comment NAV Connector" THEN BEGIN
        //A/gob-rste/31.07.12/P0115
        //p_SalesHeader.CALCFIELDS(Comment);
        //IF p_SalesHeader.Comment = TRUE THEN BEGIN
        SalesCommentLine.RESET;
        SalesCommentLine.SETRANGE("Document Type",SalesCommentLine."Document Type"::Order);
        SalesCommentLine.SETRANGE("No.",p_SalesHeader."No.");
        //A/gob-rste/12.09.12/P0313
        //SalesCommentLine.SETRANGE("Anveo User",'');
        SalesCommentLine.SETRANGE("Customer Comment Shop",TRUE);
        //E/gob-rste/12.09.12/P0313
        IF NOT SalesCommentLine.ISEMPTY THEN BEGIN
        //E/gob-rste/31.07.12/P0115
          //A/gob-rste/06.09.12/P0292
          CheckComment := TRUE;
          //p_SalesHeader."Processing interrupted" := p_SalesHeader."Processing interrupted"::"Check Comment";
          //p_SalesHeader.MODIFY;
          //EXIT;
          //E/gob-rste/06.09.12/P0292
        END;
      END;

      // Check Address
      IF FPCGeneralSetup."Check Address NAV Connector" THEN BEGIN
        //A/P0316
        //p_SalesHeader.CALCFIELDS("Website No.");
        //E/P0316
        IF p_SalesHeader."Website No." = 1 THEN BEGIN
          StreetSearchNameLoc := GetStreetSearchName(p_SalesHeader."Ship-to Address");
          DHLStreetcodes.RESET;
          DHLStreetcodes.SETRANGE(plz,p_SalesHeader."Ship-to Post Code");
          DHLStreetcodes.SETRANGE(str_name_sort,StreetSearchNameLoc);
          IF DHLStreetcodes.ISEMPTY THEN BEGIN
            //A/gob-rste/06.09.12/P0292
            CheckAddress := TRUE;
            //p_SalesHeader."Processing interrupted" := p_SalesHeader."Processing interrupted"::"Address Check";
            //p_SalesHeader.MODIFY;
            //EXIT;
            //E/gob-rste/06.09.12/P0292
          END;
        END;
      END;
      //A/gob-rste/06.09.12/P0292
      IF CheckAddress AND NOT CheckComment THEN BEGIN
        p_SalesHeader."Processing interrupted" := p_SalesHeader."Processing interrupted"::"Address Check";
        p_SalesHeader.MODIFY;
      END;
      IF CheckComment AND NOT CheckAddress THEN BEGIN
        p_SalesHeader."Processing interrupted" := p_SalesHeader."Processing interrupted"::"Check Comment";
        p_SalesHeader.MODIFY;
      END;
      IF CheckAddress AND CheckComment THEN BEGIN
        p_SalesHeader."Processing interrupted" := p_SalesHeader."Processing interrupted"::"Check Comment and Address";
        p_SalesHeader.MODIFY;
      END;

      EXIT;
      //E/gob-rste/06.09.12/P0292
    END;

    PROCEDURE GetStreetSearchName@1108200002(p_Address@1108200000 : Text[50]) : Code[30];
    VAR
      GeneralMgt@1000000000 : Codeunit 11501;
      i@1108200001 : Integer;
    BEGIN
      FOR i := 1 TO 10 DO BEGIN
        IF STRPOS(p_Address,FORMAT(i)) > 0 THEN BEGIN
          p_Address := COPYSTR(p_Address,1,STRPOS(p_Address,FORMAT(i)));
          i := 10;
        END;
      END;

      p_Address := DELCHR(p_Address,'=','1234567890.,;:-_#+*~!"ı$%&/()=');
      p_Address := DELCHR(p_Address,'=',' ');
      p_Address := CONVERTSTR(p_Address,'|<>()&=?*','?????????');
      p_Address := UPPERCASE(p_Address);
      //H1876  02.12.14  MIK  ++++++++++++++++++++++++++++++++++
      p_Address := CONVERTSTR(p_Address, '''', '.');
      p_Address := CONVERTSTR(p_Address, ',', '.');
      p_Address := CONVERTSTR(p_Address, ':', '.');
      p_Address := COPYSTR(GeneralMgt.ConvertSpecialCharacters(p_Address),1,50);
      //H1876  02.12.14  MIK  ----------------------------------
      p_Address := DELCHR(p_Address,'=',' ');
      IF STRPOS(p_Address,'STRASSE') <> 0 THEN
        IF STRPOS(p_Address,'STRASSE') = STRLEN(p_Address) - 6 THEN
         p_Address := ReplaceString(p_Address,'STRASSE','STR');

      //H0249  13.03.13  ABR  ++++++++++++++++++++++++++++++++++++
      IF STRLEN(p_Address) > 30 THEN
        p_Address := COPYSTR(p_Address,1,30);
      //H0249  13.03.13  ABR  ------------------------------------

      EXIT(p_Address);
    END;

    PROCEDURE SeparateStreetNameAndHouseNo@1000000028(AddressV@1000000000 : Text[50];VAR StreetNameR@1000000001 : Text[50];VAR HouseNoR@1000000002 : Text[10]);
    VAR
      NoCheckL@1000000011 : Text[1];
      FirstPosNoCheckL@1000000005 : Text[1];
      StrlenStreetL@1000000009 : Integer;
      CounterL@1000000008 : Integer;
      NoStartPositionL@1000000010 : Integer;
      NoFoundL@1000000007 : Boolean;
      FirstPosNoL@1000000003 : Boolean;
    BEGIN
      //H1682 21.11.14 EHN +++++++++++++++++++++++++
      //Stra·e und Hausnr. Trennen
      StreetNameR := '';
      HouseNoR := '';
      StrlenStreetL := STRLEN(AddressV);
      //erste Position eine Zahl?
      FirstPosNoCheckL := COPYSTR(AddressV,1,1);
      IF FirstPosNoCheckL IN ['0','1','2','3','4','5','6','7','8','9'] THEN
        FirstPosNoL := TRUE
      ELSE
        FirstPosNoL := FALSE;

      IF (StrlenStreetL <> 0) AND NOT FirstPosNoL THEN BEGIN //Hausnr. am Ende...
        NoFoundL := FALSE;
        CounterL := 0;
        REPEAT
          CounterL := CounterL + 1;
          //Jede Position auf Nr. ÅberprÅfen...
          NoCheckL := COPYSTR(AddressV,CounterL,1);
          IF NoCheckL IN ['0','1','2','3','4','5','6','7','8','9'] THEN BEGIN
            NoFoundL := TRUE;
            NoStartPositionL := CounterL;
          END;
        UNTIL (StrlenStreetL = CounterL) OR NoFoundL;
        StreetNameR := COPYSTR(AddressV,1,NoStartPositionL-1);
        HouseNoR := COPYSTR(AddressV,NoStartPositionL,StrlenStreetL);
      END ELSE BEGIN //fÅhrende Hausnr. ...
        NoFoundL := FALSE;
        CounterL := 0;
        REPEAT
          CounterL := CounterL + 1;
          //Jede Position auf Leerzeichen ÅberprÅfen...
          NoCheckL := COPYSTR(AddressV,CounterL,1);
          IF (NoCheckL = ' ') OR (NoCheckL = ',') THEN BEGIN
            NoFoundL := TRUE;
            NoStartPositionL := CounterL;
          END;
        UNTIL (StrlenStreetL = CounterL) OR NoFoundL;
        StreetNameR := COPYSTR(AddressV,NoStartPositionL+1,StrlenStreetL);
        HouseNoR := COPYSTR(AddressV,1,NoStartPositionL-1);
      END;

      //H1682 21.11.14 EHN -------------------------
    END;

    PROCEDURE ReplaceString@2(TextV@1108200000 : Text[250];SearchTextV@1108200001 : Text[50];ReplaceTextV@1108200002 : Text[50]) ResultO : Text[1024];
    VAR
      DummyL@1108200003 : Text[1024];
    BEGIN
      //H1876  02.12.14  MIK  ++++++++++++++++++++++++++++++++++
      ResultO := TextV;
      WHILE (STRPOS(TextV,SearchTextV) < STRLEN(TextV)) AND (STRPOS(TextV,SearchTextV) > 0) DO BEGIN
        DummyL := DELSTR(TextV,STRPOS(TextV,SearchTextV),STRLEN(SearchTextV));
        ResultO := PADSTR(INSSTR(DummyL,ReplaceTextV,STRPOS(TextV,SearchTextV)),30,' ');
        TextV := ResultO;
      END;
      //H1876  02.12.14  MIK  ----------------------------------
    END;

    PROCEDURE getDateCountryFormat@1108200003(p_Date@1108200000 : Date;p_CountryCode@1108200001 : Code[10]) r_DateText : Text[50];
    VAR
      YearInt@1108200002 : Integer;
      MonthInt@1108200003 : Integer;
      DayInt@1108200004 : Integer;
      MonthText@1108200005 : Text[30];
      "**** HME ************"@1000000001 : Integer;
      ExtendedTextLineL@1000000000 : Record 280;
    BEGIN
      YearInt := 0;
      MonthInt := 0;
      DayInt := 0;
      MonthText := '';

      //H1447, H1581 04.11.14 EHN +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
      IF p_CountryCode IN ['DEA','DES','DEU','FRA','FRB','FRS','NLB','NLD'] THEN BEGIN
        YearInt := DATE2DMY(p_Date,3);
        MonthInt := DATE2DMY(p_Date,2);
        DayInt := DATE2DMY(p_Date,1);
        ExtendedTextLineL.RESET;
        ExtendedTextLineL.SETRANGE("Table Name",ExtendedTextLineL."Table Name"::"Standard Text");
        ExtendedTextLineL.SETRANGE("No.",'MONTH');
        ExtendedTextLineL.SETRANGE("Language Code",p_CountryCode);
        ExtendedTextLineL.SETRANGE("Text No.",MonthInt);
        IF ExtendedTextLineL.FINDFIRST THEN
          MonthText := ExtendedTextLineL.Text
        ELSE
          ERROR(TextHME051,MonthInt,p_CountryCode,ExtendedTextLineL.TABLENAME);
        r_DateText := FORMAT(DayInt) + '. ' + MonthText + ' ' + FORMAT(YearInt);
      END ELSE IF p_CountryCode = 'ITA' THEN BEGIN
        YearInt := DATE2DMY(p_Date,3);
        MonthInt := DATE2DMY(p_Date,2);
        DayInt := DATE2DMY(p_Date,1);
        ExtendedTextLineL.RESET;
        ExtendedTextLineL.SETRANGE("Table Name",ExtendedTextLineL."Table Name"::"Standard Text");
        ExtendedTextLineL.SETRANGE("No.",'MONTH');
        ExtendedTextLineL.SETRANGE("Language Code",'ITA');
        ExtendedTextLineL.SETRANGE("Text No.",MonthInt);
        IF ExtendedTextLineL.FINDFIRST THEN
          MonthText := ExtendedTextLineL.Text
        ELSE
          ERROR(TextHME051,MonthInt,p_CountryCode,ExtendedTextLineL.TABLENAME);
        r_DateText := FORMAT(DayInt) + ' ' + MonthText + ' ' + FORMAT(YearInt);
      END ELSE IF p_CountryCode = '' THEN BEGIN
        YearInt := DATE2DMY(p_Date,3);
        MonthInt := DATE2DMY(p_Date,2);
        DayInt := DATE2DMY(p_Date,1);
        ExtendedTextLineL.RESET;
        ExtendedTextLineL.SETRANGE("Table Name",ExtendedTextLineL."Table Name"::"Standard Text");
        ExtendedTextLineL.SETRANGE("No.",'MONTH');
        ExtendedTextLineL.SETRANGE("Language Code",'DEU');
        ExtendedTextLineL.SETRANGE("Text No.",MonthInt);
        IF ExtendedTextLineL.FINDFIRST THEN
          MonthText := ExtendedTextLineL.Text
        ELSE
          ERROR(TextHME051,MonthInt,p_CountryCode,ExtendedTextLineL.TABLENAME);
        r_DateText := FORMAT(DayInt) + '. ' + MonthText + ' ' + FORMAT(YearInt);
      END ELSE
        r_DateText := FORMAT(p_Date,0,4);
      //H1447, H1581 04.11.14 EHN -------------------------------------------------------------

      //H1447 07.08.14 EHN +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
      {
      CASE p_CountryCode OF

        'NLD': BEGIN
          YearInt := DATE2DMY(p_Date,3);
          MonthInt := DATE2DMY(p_Date,2);
          DayInt := DATE2DMY(p_Date,1);
          CASE MonthInt OF
            1: MonthText := 'januari';
            2: MonthText := 'februari';
            3: MonthText := 'maart';
            4: MonthText := 'april';
            5: MonthText := 'mei';
            6: MonthText := 'juni';
            7: MonthText := 'juli';
            8: MonthText := 'augustus';
            9: MonthText := 'september';
            10: MonthText := 'oktober';
            11: MonthText := 'november';
            12: MonthText := 'decemeber';
          END;
          r_DateText := FORMAT(DayInt) + ' ' + MonthText + ' ' + FORMAT(YearInt);
        END;

        'FRA': BEGIN
          YearInt := DATE2DMY(p_Date,3);
          MonthInt := DATE2DMY(p_Date,2);
          DayInt := DATE2DMY(p_Date,1);
          CASE MonthInt OF
            1: MonthText := 'janvier';
            2: MonthText := 'f‚Äövrier';
            3: MonthText := 'mars';
            4: MonthText := 'avril';
            5: MonthText := 'mai';
            6: MonthText := 'juin';
            7: MonthText := 'juillet';
            8: MonthText := 'ao‚Äìt';
            9: MonthText := 'septembre';
            10: MonthText := 'octobre';
            11: MonthText := 'novembre';
            12: MonthText := 'd‚Äöcembre';
          END;
          r_DateText := FORMAT(DayInt) + ' ' + MonthText + ' ' + FORMAT(YearInt);
        END;

        'DEU': BEGIN
          YearInt := DATE2DMY(p_Date,3);
          MonthInt := DATE2DMY(p_Date,2);
          DayInt := DATE2DMY(p_Date,1);
          CASE MonthInt OF
            1: MonthText := 'Januar';
            2: MonthText := 'Februar';
            3: MonthText := 'M‚Äûrz';
            4: MonthText := 'April';
            5: MonthText := 'Mai';
            6: MonthText := 'Juni';
            7: MonthText := 'Juli';
            8: MonthText := 'August';
            9: MonthText := 'September';
            10: MonthText := 'Oktober';
            11: MonthText := 'November';
            12: MonthText := 'Dezember';
          END;
          r_DateText := FORMAT(DayInt) + '. ' + MonthText + ' ' + FORMAT(YearInt);
        END;

        //H0142 09.01.13 ARU +++++++++++++++++++++++++++++++++++++++++++++++++++++
        'DEA': BEGIN
          YearInt := DATE2DMY(p_Date,3);
          MonthInt := DATE2DMY(p_Date,2);
          DayInt := DATE2DMY(p_Date,1);
          CASE MonthInt OF
            1: MonthText := 'J‚Äûnner';
            2: MonthText := 'Feber';
            3: MonthText := 'M‚Äûrz';
            4: MonthText := 'April';
            5: MonthText := 'Mai';
            6: MonthText := 'Juni';
            7: MonthText := 'Juli';
            8: MonthText := 'August';
            9: MonthText := 'September';
            10: MonthText := 'Oktober';
            11: MonthText := 'November';
            12: MonthText := 'Dezember';
          END;
          r_DateText := FORMAT(DayInt) + '. ' + MonthText + ' ' + FORMAT(YearInt);
        END;
        //H0142 09.01.13 ARU -----------------------------------------------------

        //H1023 04.04.14 FF +++++++++++++++++++++++++++++++++++++++++++++++++++++
        'FRS': BEGIN
          YearInt := DATE2DMY(p_Date,3);
          MonthInt := DATE2DMY(p_Date,2);
          DayInt := DATE2DMY(p_Date,1);
          CASE MonthInt OF
            1: MonthText := 'janvier';
            2: MonthText := 'f‚Äövrier';
            3: MonthText := 'mars';
            4: MonthText := 'avril';
            5: MonthText := 'mai';
            6: MonthText := 'juin';
            7: MonthText := 'juillet';
            8: MonthText := 'ao‚Äìt';
            9: MonthText := 'septembre';
            10: MonthText := 'octobre';
            11: MonthText := 'novembre';
            12: MonthText := 'd‚Äöcembre';
          END;
          r_DateText := FORMAT(DayInt) + ' ' + MonthText + ' ' + FORMAT(YearInt);
        END;
        //H1023 04.04.14 FF -----------------------------------------------------

        '': BEGIN
          YearInt := DATE2DMY(p_Date,3);
          MonthInt := DATE2DMY(p_Date,2);
          DayInt := DATE2DMY(p_Date,1);
          CASE MonthInt OF
            1: MonthText := 'Januar';
            2: MonthText := 'Februar';
            3: MonthText := 'M‚Äûrz';
            4: MonthText := 'April';
            5: MonthText := 'Mai';
            6: MonthText := 'Juni';
            7: MonthText := 'Juli';
            8: MonthText := 'August';
            9: MonthText := 'September';
            10: MonthText := 'Oktober';
            11: MonthText := 'November';
            12: MonthText := 'Dezember';
          END;
          r_DateText := FORMAT(DayInt) + '. ' + MonthText + ' ' + FORMAT(YearInt);
        END;
      ELSE
        r_DateText := FORMAT(p_Date,0,4)
      END;
      }
      //H1447 07.08.14 EHN -------------------------------------------------------------

      EXIT(r_DateText);
    END;

    PROCEDURE CheckOrderCancelOrParking@1108200005(VAR p_SalesHeader@1108200000 : Record 36);
    VAR
      CancelOrder@1108200001 : Boolean;
      SalesCommentLine@1108200002 : Record 44;
      SalesLine@1108200003 : Record 37;
      SalesLineL@1000000000 : Record 37;
      FPCManagementL@1000000001 : Codeunit 50003;
    BEGIN
      // CheckOrderCancelOrParking, called nowhere

      CancelOrder := FALSE;
      IF (QtyStringUsedInString(p_SalesHeader."Sell-to Customer Name",'TEST',TRUE) >= 2) OR
         (QtyStringUsedInString(p_SalesHeader."Sell-to Customer Name 2",'TEST',TRUE) >=2) OR
         (QtyStringUsedInString(p_SalesHeader."Bill-to Name",'TEST',TRUE) >= 2) OR
         (QtyStringUsedInString(p_SalesHeader."Bill-to Name 2",'TEST',TRUE) >= 2) OR
         (QtyStringUsedInString(p_SalesHeader."Ship-to Name",'TEST',TRUE) >= 2) OR
         (QtyStringUsedInString(p_SalesHeader."Ship-to Name 2",'TEST',TRUE) >= 2) THEN
        CancelOrder := TRUE;

      SalesCommentLine.RESET;
      SalesCommentLine.SETRANGE("Document Type",SalesCommentLine."Document Type"::Order);
      SalesCommentLine.SETRANGE("No.",p_SalesHeader."No.");
      SalesCommentLine.SETRANGE("Document Line No.",0);
      IF (SalesCommentLine.FINDFIRST) AND (QtyStringUsedInString(SalesCommentLine.Comment,'TEST',TRUE) >= 1) THEN
        CancelOrder := TRUE;

      IF CancelOrder THEN BEGIN
        SalesLine.SETRANGE("Document No.",p_SalesHeader."No.");
        SalesLine.SETRANGE("Document Type",p_SalesHeader."Document Type");

        //H0587 02.06.14 HCN +++++++++++++++++++++++++++++
        IF SalesLine.FIND('-') THEN BEGIN
          CLEAR(SalesLineL);
          SalesLineL := SalesLine;
          REPEAT
            SalesLine."Cancellation Reason Code" := 'TEST';
            SalesLine.MODIFY;
          UNTIL SalesLine.NEXT = 0;
        END;
        //H0587 02.06.14 HCN -----------------------------
        p_SalesHeader.MagentoCancel;
        EXIT;
      END;

      CheckForPickingInterruption(p_SalesHeader);
    END;

    PROCEDURE CreateFollowUpSalesOrder@1108200006(ReturnOrderHeaderV@1108200000 : Record 36);
    VAR
      FollowUpSalesHeaderL@1108200002 : Record 36;
      FollowUpSalesLineL@1108200006 : Record 37;
      ReturnOrderLineL@1000000000 : Record 37;
    BEGIN
      // CreateFollowUpSalesOrder
      //H1202 04.06.14 HCN +++++++++++++++++++++++++++++

      IF (ReturnOrderHeaderV."Return Type" <> ReturnOrderHeaderV."Return Type"::Change) THEN BEGIN
        ERROR(TextHME048);
      END;

      // Get Follow-up-SalesHeader or insert one
      FollowUpSalesLineL.SETCURRENTKEY("Item Change Return No.","Item Change Return Line No.");
      FollowUpSalesLineL.SETRANGE("Item Change Return No.",ReturnOrderHeaderV."No.");
      IF FollowUpSalesLineL.FINDFIRST THEN BEGIN
        ERROR(TextHME049,FollowUpSalesLineL."Document No.",ReturnOrderHeaderV."No.");
      END ELSE BEGIN
        CreateFollowUpSalesHeader(ReturnOrderHeaderV,FollowUpSalesHeaderL);
      END;

      // Insert Follow-up-SalesLines
      CLEAR(ReturnOrderLineL);
      ReturnOrderLineL.SETCURRENTKEY("Document Type","Document No.","Line No.");
      ReturnOrderLineL.SETRANGE("Document Type",ReturnOrderHeaderV."Document Type");
      ReturnOrderLineL.SETRANGE("Document No.",ReturnOrderHeaderV."No.");
      IF ReturnOrderLineL.FIND('-') THEN BEGIN
        REPEAT
          CreateFollowUpSalesLine(ReturnOrderLineL,FollowUpSalesHeaderL);
        UNTIL ReturnOrderLineL.NEXT = 0;
      END;
      //H2015 23.02.15 EHN +++++++++++++++++++++++++++
      IF NOT SkipUpdateDeliveryDaysOnSO THEN
        UpdateDeliveryDaysOnSalesLine(FollowUpSalesHeaderL);
      //H2015 23.02.15 EHN ---------------------------

      //H1390 21.08.14 MSL +++++++++++++++++++++++++++++
      FollowUpSalesHeaderL.ConsolidateShippingAgent;
      //H1390 21.08.14 MSL -----------------------------

      SetChangeOrderNo(FollowUpSalesHeaderL."No.");

      MESSAGE(Text001,FollowUpSalesHeaderL."No.");
      //H1202 04.06.14 HCN -----------------------------
    END;

    PROCEDURE CreateItemChangeOrderMail@1000000012(parSalesHeader@1108200002 : Record 36);
    VAR
      BatchPostDoc@1108200000 : Record 50043;
      EntryNo@1108200001 : Integer;
      locSalesLine@1000000000 : Record 37;
    BEGIN
      //S/P0600

      IF parSalesHeader."Document Type" <> parSalesHeader."Document Type"::Order THEN
        EXIT;

      locSalesLine.RESET;
      locSalesLine.SETCURRENTKEY("Document Type","Document No.","Line No.");
      locSalesLine.SETRANGE("Document Type",parSalesHeader."Document Type");
      locSalesLine.SETRANGE("Document No.",parSalesHeader."No.");
      locSalesLine.SETRANGE(Type,locSalesLine.Type::Item);
      locSalesLine.SETFILTER(Quantity,'<>%1',0);
      IF locSalesLine.ISEMPTY THEN
        ERROR(Error018,parSalesHeader."Document Type",parSalesHeader."No.");

      BatchPostDoc.RESET;
      BatchPostDoc.SETCURRENTKEY("Document No.","Document Type","Action Type");
      BatchPostDoc.SETRANGE("Document No.",parSalesHeader."No.");
      BatchPostDoc.SETRANGE("Document Type",parSalesHeader."Document Type");
      BatchPostDoc.SETRANGE("Action Type",BatchPostDoc."Action Type"::"Sales EMail");
      BatchPostDoc.SETRANGE("Return E-Mail Type",BatchPostDoc."Return E-Mail Type"::ChangeOrderMail);
      IF BatchPostDoc.ISEMPTY THEN BEGIN
        //A/gob-adb/11.11.13
        {
        BatchPostDoc.LOCKTABLE;
        BatchPostDoc.RESET;
        IF BatchPostDoc.FINDLAST THEN
          EntryNo := BatchPostDoc."Entry No." + 1
        ELSE
          EntryNo := 1;
        }
        //E/gob-adb/11.11.13

        BatchPostDoc.INIT;
        //A/gob-adb/11.11.13
        //BatchPostDoc."Entry No." := EntryNo;
        BatchPostDoc."Entry No." := 0;
        //E/gob-adb/11.11.13
        BatchPostDoc."Document No." := parSalesHeader."No.";
        BatchPostDoc."Document Type" := parSalesHeader."Document Type";
        BatchPostDoc."Action Type" := BatchPostDoc."Action Type"::"Sales EMail";
        BatchPostDoc."Document Type" := BatchPostDoc."Document Type"::Order;
        BatchPostDoc."Scheduled at" := CURRENTDATETIME;
        BatchPostDoc."Scheduled by" := USERID;
        BatchPostDoc."Return E-Mail Type" := BatchPostDoc."Return E-Mail Type"::ChangeOrderMail;
        BatchPostDoc.INSERT;
      END;
      //E/P0600
    END;

    PROCEDURE CreateCreditMemoMail@1106900000(SalesCrMemoHeaderV@1106900000 : Record 114;IsMailManuallyCreatedV@1106900001 : Boolean);
    VAR
      SIISetupL@1106900002 : Record 50140;
    BEGIN
      //T0009 02.07.14 tec-sf +++++++++++++++++++++++++++++
      IF NOT IsMailManuallyCreatedV AND (SalesCrMemoHeaderV."Return Type" = SalesCrMemoHeaderV."Return Type"::Change) THEN
        EXIT;

      SIISetupL.GET;
      //T0019 08.10.14 ++++++++++++++++++++++++++++++
      // Credit Memo Mail Shop is now a flowfield
      //IF (SIISetupL."Credit Memo Mail NAV" <> '') AND (SIISetupL."Credit Memo Mail Shop" <> '')
      IF (SIISetupL."Credit Memo Mail NAV" <> '')
      //T0019 08.10.14 ------------------------------
      AND SIISetupL."Tr. Cr. Memo Mail Active"
        THEN BEGIN
        CreateCreditMemoMailByShop(SalesCrMemoHeaderV,IsMailManuallyCreatedV);
      END ELSE BEGIN
        CreateCreditMemoMailByBatch(SalesCrMemoHeaderV);
      END;

      //T0009 02.07.14 tec-sf -----------------------------
    END;

    PROCEDURE CreateCreditMemoMailByBatch@1106900001(SalesCrMemoHeaderV@1106900000 : Record 114);
    VAR
      BatchPostDoc@1106900001 : Record 50043;
    BEGIN
      //T0009 02.07.14 tec-sf +++++++++++++++++++++++++++++
      BatchPostDoc.RESET;
      BatchPostDoc.SETCURRENTKEY("Document No.","Document Type","Action Type");
      BatchPostDoc.SETRANGE("Document No.",SalesCrMemoHeaderV."No.");
      BatchPostDoc.SETRANGE("Document Type",BatchPostDoc."Document Type"::"Credit Memo");
      BatchPostDoc.SETRANGE("Action Type",BatchPostDoc."Action Type"::"Sales EMail");
      IF BatchPostDoc.ISEMPTY THEN BEGIN
        BatchPostDoc.INIT;
        BatchPostDoc."Entry No." := 0;
        BatchPostDoc."Document No." := SalesCrMemoHeaderV."No.";
        BatchPostDoc."Document Type" := BatchPostDoc."Document Type"::"Credit Memo";
        BatchPostDoc."Action Type" := BatchPostDoc."Action Type"::"Sales EMail";
        BatchPostDoc."Scheduled at" := CURRENTDATETIME;
        BatchPostDoc."Scheduled by" := USERID;
        BatchPostDoc."Posted Document No." := SalesCrMemoHeaderV."No.";
        BatchPostDoc.INSERT;
      END;
      //T0009 02.07.14 tec-sf -----------------------------
    END;

    PROCEDURE CreateCreditMemoMailByShop@1106900002(SalesCrMemoHeaderV@1106900000 : Record 114;IsMailManuallyCreatedV@1000000000 : Boolean);
    VAR
      SIIFillLogL@1106900001 : Codeunit 50123;
    BEGIN
      //T0009 02.07.14 tec-sf +++++++++++++++++++++++++++++
      SIIFillLogL.Triggered_SetManually(IsMailManuallyCreatedV);
      SIIFillLogL.Triggered_CreditMemo(SalesCrMemoHeaderV,IsMailManuallyCreatedV);
      //T0009 02.07.14 tec-sf -----------------------------
    END;

    PROCEDURE CreateReturnOrderMail@1000000071(parSalesHeader@1108200002 : Record 36;parMailType@1108200003 : ' ,ReturnLabel&ReturnList,ReturnConfirmation,ChangeOrder';manuallyTriggeredV@1000000002 : Boolean);
    VAR
      BatchPostDoc@1108200000 : Record 50043;
      EntryNo@1108200001 : Integer;
      locSalesLine@1000000000 : Record 37;
      SIISetupL@1000000001 : Record 50140;
      AutomEMailProcesses@1000000003 : Codeunit 50030;
      MailITSetup@1000000004 : Record 75402;
    BEGIN
      // CreateReturnOrderMail
      IF parSalesHeader."Document Type" <> parSalesHeader."Document Type"::"Return Order" THEN
        EXIT;

      IF parMailType = parMailType::" " THEN
        EXIT;

      //T0003 10.06.14 tec-sf +++++++++++++++++++++++++++++
      // Copied the original CreateReturnOrderMail to CreateReturnOrderMailByBatch
      // Use old or new behaviour based on SII Setup
      SIISetupL.GET;
      //H1783 14.11.14 MIK +++++++++++++++++++++++++++++
      IF (parSalesHeader."Return Type" = parSalesHeader."Return Type"::Return) OR
         (parSalesHeader."Return Type" = parSalesHeader."Return Type"::Change) THEN BEGIN
        //T0028 24.07.14 tec-cs +++++++++++++++++++++++++++++
        CreateReturnOrderMailByShop(parSalesHeader);
        //T0028 24.07.14 tec-cs -----------------------------
      //H1783 14.11.14 MIK -----------------------------
      //T0044 27.08.14 tec-cs +++++++++++++++++++++++++++++
      END ELSE IF parSalesHeader."Return Type" = parSalesHeader."Return Type"::"Spare Part" THEN BEGIN
        AutomEMailProcesses.Proceed_FTTC_TriggerMsg(parSalesHeader, manuallyTriggeredV);
        MailITSetup.GET;
        IF MailITSetup."Create BatchPost for Sparepart" THEN BEGIN
          CreateReturnOrderMailByBatch(parSalesHeader,parMailType);
        END;
      //T0044 27.08.14 tec-cs -----------------------------
      END ELSE BEGIN
        CreateReturnOrderMailByBatch(parSalesHeader,parMailType);
      END;
      //T0003 10.06.14 tec-sf -----------------------------
    END;

    PROCEDURE CreateReturnOrderMailByBatch@1000000070(parSalesHeader@1108200002 : Record 36;parMailType@1108200003 : ' ,ReturnLabel&ReturnList,ReturnConfirmation,ChangeOrder');
    VAR
      BatchPostDoc@1108200000 : Record 50043;
      EntryNo@1108200001 : Integer;
      locSalesLine@1000000000 : Record 37;
      SIISetupL@1000000001 : Record 50140;
    BEGIN
      // CreateReturnOrderMail

      IF parSalesHeader."Document Type" <> parSalesHeader."Document Type"::"Return Order" THEN
        EXIT;

      IF parMailType = parMailType::" " THEN
        EXIT;

      locSalesLine.RESET;
      locSalesLine.SETCURRENTKEY("Document Type","Document No.","Line No.");
      locSalesLine.SETRANGE("Document Type",parSalesHeader."Document Type");
      locSalesLine.SETRANGE("Document No.",parSalesHeader."No.");
      locSalesLine.SETRANGE(Type,locSalesLine.Type::Item);
      locSalesLine.SETFILTER(Quantity,'<>%1',0);
      IF locSalesLine.ISEMPTY THEN
        ERROR(Error018,parSalesHeader."Document Type",parSalesHeader."No.");

      BatchPostDoc.RESET;
      BatchPostDoc.SETCURRENTKEY("Document No.","Document Type","Action Type");
      BatchPostDoc.SETRANGE("Document No.",parSalesHeader."No.");
      BatchPostDoc.SETRANGE("Document Type",parSalesHeader."Document Type");
      BatchPostDoc.SETRANGE("Action Type",BatchPostDoc."Action Type"::"Sales EMail");
      CASE parMailType OF
        parMailType::"ReturnLabel&ReturnList":
          BatchPostDoc.SETRANGE("Return E-Mail Type",BatchPostDoc."Return E-Mail Type"::"ReturnLabel&ReturnList");
        parMailType::ReturnConfirmation:
          BatchPostDoc.SETRANGE("Return E-Mail Type",BatchPostDoc."Return E-Mail Type"::ReturnConfirmation);
      END;
      IF BatchPostDoc.ISEMPTY THEN BEGIN
        //A/gob-adb/11.11.13
        {
        BatchPostDoc.LOCKTABLE;
        BatchPostDoc.RESET;
        IF BatchPostDoc.FINDLAST THEN
          EntryNo := BatchPostDoc."Entry No." + 1
        ELSE
          EntryNo := 1;
        }
        //E/gob-adb/11.11.13

        BatchPostDoc.INIT;
        //A/gob-adb/11.11.13
        //BatchPostDoc."Entry No."     := EntryNo;
        BatchPostDoc."Entry No." := 0;
        //E/gob-adb/11.11.13
        BatchPostDoc."Document No."  := parSalesHeader."No.";
        BatchPostDoc."Document Type" := parSalesHeader."Document Type";
        BatchPostDoc."Action Type"   := BatchPostDoc."Action Type"::"Sales EMail";
        BatchPostDoc."Document Type" := BatchPostDoc."Document Type"::"Return Order";
        BatchPostDoc."Scheduled at"  := CURRENTDATETIME;
        BatchPostDoc."Scheduled by"  := USERID;
        CASE parMailType OF
          parMailType::"ReturnLabel&ReturnList":
            BatchPostDoc."Return E-Mail Type" := BatchPostDoc."Return E-Mail Type"::"ReturnLabel&ReturnList";
          parMailType::ReturnConfirmation:
            BatchPostDoc."Return E-Mail Type" := BatchPostDoc."Return E-Mail Type"::ReturnConfirmation;
        END;
        BatchPostDoc.INSERT;
      END;

      CASE parMailType OF
        parMailType::"ReturnLabel&ReturnList":
          parSalesHeader."Status Return E-Mail" := parSalesHeader."Status Return E-Mail"::"Confirmation & Label send";
        parMailType::ReturnConfirmation:
          parSalesHeader."Status Return E-Mail" := parSalesHeader."Status Return E-Mail"::"Confirmation send";
      END;
      parSalesHeader.MODIFY;
    END;

    PROCEDURE CreateReturnOrderMailByShop@1000000068(VAR SalesHeaderR@1000000001 : Record 36);
    VAR
      SIISetupL@1000000002 : Record 50140;
      SalesLineL@1000000004 : Record 37;
      ReturnReasonL@1000000000 : Record 6635;
      SIIFillLogCreateL@1000000003 : Codeunit 50169;
      IsParcelOnlyL@1000000007 : Boolean;
      IsSalesLineExistsL@1000000005 : Boolean;
    BEGIN
      //H1783,T0030,T0028,T0003 14.11.14 MIK +++++++++++++++++++++++++++++
      SIISetupL.GET;

      //Is there any NON parcel Item in the order?
      IsParcelOnlyL := TRUE;
      IsSalesLineExistsL := FALSE;
      SalesLineL.RESET;
      SalesLineL.SETRANGE("Document Type",SalesHeaderR."Document Type");
      SalesLineL.SETRANGE("Document No.",SalesHeaderR."No.");
      SalesLineL.SETRANGE(Type,SalesLineL.Type::Item);
      SalesLineL.SETFILTER("No.",'<>%1','');
      SalesLineL.SETFILTER(Quantity,'>%1',0);
      IF SalesLineL.FINDSET(FALSE,FALSE) THEN
        REPEAT
          SalesLineL.TESTFIELD("Return Reason Code");
          ReturnReasonL.GET(SalesLineL."Return Reason Code");
          IF SalesHeaderR."Return Type" = SalesHeaderR."Return Type"::Return THEN
            IF ReturnReasonL."Use in FTTC Return Trigger" THEN BEGIN
              IsSalesLineExistsL := TRUE;
              IF (SalesLineL."Transp. Type" <> SalesLineL."Transp. Type"::"Parcel Service") THEN
                IsParcelOnlyL := FALSE;
            END;
          IF SalesHeaderR."Return Type" = SalesHeaderR."Return Type"::Change THEN
            IF ReturnReasonL."Use in FTTC Change Trigger" THEN BEGIN
              IsSalesLineExistsL := TRUE;
              IF (SalesLineL."Transp. Type" <> SalesLineL."Transp. Type"::"Parcel Service") THEN
                IsParcelOnlyL := FALSE;
            END
        UNTIL (SalesLineL.NEXT = 0) OR (IsParcelOnlyL = FALSE);

      //If there is no Sales Line with appropriate Return Reason Code, do not send anything to a customer (do not generate message)
      IF NOT IsSalesLineExistsL THEN
        EXIT;

      CASE TRUE OF
        (SalesHeaderR."Return Type" = SalesHeaderR."Return Type"::Return) AND
        (IsParcelOnlyL) :
          BEGIN
            SIIFillLogCreateL.CreateReturnOrderLabel(SalesHeaderR);
            SalesHeaderR."Status Return E-Mail" := SalesHeaderR."Status Return E-Mail"::"Confirmation & Label send";
            SalesHeaderR.VALIDATE("Status Return Order", SalesHeaderR."Status Return Order"::"Label sent");
            SalesHeaderR.MODIFY;
          END;
        (SalesHeaderR."Return Type" = SalesHeaderR."Return Type"::Return) AND
        (NOT IsParcelOnlyL) :
          BEGIN
            SIIFillLogCreateL.CreateReturnOrderInstruction(SalesHeaderR);
            SalesHeaderR."Status Return E-Mail" := SalesHeaderR."Status Return E-Mail"::"Confirmation send";
            SalesHeaderR.VALIDATE("Status Return Order", SalesHeaderR."Status Return Order"::"Label sent");
            SalesHeaderR.MODIFY;
          END;
        (SalesHeaderR."Return Type" = SalesHeaderR."Return Type"::Change) AND
        (IsParcelOnlyL) :
          BEGIN
            SIIFillLogCreateL.CreateChangeOrderLabel(SalesHeaderR);
            SalesHeaderR."Status Return E-Mail" := SalesHeaderR."Status Return E-Mail"::"Confirmation & Label send";
            SalesHeaderR.VALIDATE("Status Return Order", SalesHeaderR."Status Return Order"::"Label sent");
            SalesHeaderR.MODIFY;
          END;
        (SalesHeaderR."Return Type" = SalesHeaderR."Return Type"::Change) AND
        (NOT IsParcelOnlyL) :
          BEGIN
            SIIFillLogCreateL.CreateChangeOrderInstruction(SalesHeaderR);
            SalesHeaderR."Status Return E-Mail" := SalesHeaderR."Status Return E-Mail"::"Confirmation send";
            SalesHeaderR.VALIDATE("Status Return Order", SalesHeaderR."Status Return Order"::"Label sent");
            SalesHeaderR.MODIFY;
          END
      END;
      //H1783,T0030,T0028,T0003 14.11.14 MIK -----------------------------
    END;

    PROCEDURE CalcPreventionDiscountLine@1108200008(parSalesLine@1108200000 : Record 37;parSourceDocNo@1000000002 : Code[20];parSourceLineNo@1000000003 : Integer);
    VAR
      locSalesLine@1108200001 : Record 37;
      "locPreventionDiscount%"@1108200003 : Record 50068;
      locFPCGeneralSetup@1108200004 : Record 50055;
      locSalesInvoiceHeader@1108200005 : Record 112;
      BatchSalesPostHeaderL@1000000009 : Record 50225;
      locTotalAmountIncludingVAT@1108200006 : Decimal;
      locSalesShipmentLine@1108200002 : Record 111;
      ItemChargeAssgntSales@1108200007 : Record 5809;
      AssignItemChargeSales@1108200008 : Codeunit 5807;
      locPrevention@1000000005 : Boolean;
      locPreventionAmount@1108200009 : Decimal;
      locSalesLine2@1108200010 : Record 37;
      locLineNo@1108200011 : Integer;
      locItemChargeLineNo@1108200012 : Integer;
      locCurrency@1108200013 : Record 4;
      locItemCharge@1108200015 : Code[20];
      locSalesHeader@1108200016 : Record 36;
      ReleaseSalesDoc@1108200018 : Codeunit 414;
      SalesPostPrepayments@1108200017 : Codeunit 442;
      locCalcAmount@1000000000 : Decimal;
      locItemChargeAssign@1000000001 : Record 5809;
      locCancRetOrderHistory@1000000004 : Record 50037;
      MarketPlaceSetupL@1000000008 : Record 50500;
      "****TEC***********************"@1000000007 : Boolean;
      MPDocumentMgtL@1000000006 : Codeunit 50500;
    BEGIN
      // CalcPreventionDiscountLine

      CLEAR(locTotalAmountIncludingVAT);
      CLEAR(locSalesInvoiceHeader);
      CLEAR(locSalesLine);
      CLEAR(locCalcAmount);
      locPrevention := TRUE;

      SalesReceivablesSetup.GET();

      IF parSalesLine."Return Type" = parSalesLine."Return Type"::Change THEN BEGIN
        locSalesLine.SETCURRENTKEY("Item Change Return No.","Item Change Return Line No.");
        locSalesLine.SETRANGE("Item Change Return No.",parSalesLine."Document No.");
        locSalesLine.SETRANGE("Document Type",locSalesLine."Document Type"::Order);
        IF NOT locSalesLine.ISEMPTY THEN BEGIN
          ERROR(Error002,parSalesLine."Line No.");
        END;
      END;

      locItemChargeAssign.SETCURRENTKEY("Applies-to Doc. Type","Applies-to Doc. No.","Applies-to Doc. Line No.");
      locItemChargeAssign.SETRANGE("Applies-to Doc. Type",locItemChargeAssign."Applies-to Doc. Type"::Order);
      locItemChargeAssign.SETRANGE("Applies-to Doc. No.",parSalesLine."Document No.");
      locItemChargeAssign.SETRANGE("Applies-to Doc. Line No.",parSalesLine."Line No.");
      IF locItemChargeAssign.FINDFIRST THEN
        EXIT;

      parSalesLine.TESTFIELD("Customer Prevention",parSalesLine."Customer Prevention"::Accepted);

      //H1511 10.11.2014 ARI +++++++++++++++++++++++++++++++++++++
      IF parSalesLine."Market Place" THEN BEGIN
        MarketPlaceSetupL.GET;
        MarketPlaceSetupL.TESTFIELD("Item Charge Prevent. Reb.");
        locItemCharge := MarketPlaceSetupL."Item Charge Prevent. Reb.";
      END ELSE BEGIN
        locFPCGeneralSetup.GET();
        locFPCGeneralSetup.TESTFIELD("Item Charge Prevention Disc.");
        locItemCharge := locFPCGeneralSetup."Item Charge Prevention Disc.";
      END;
      //H1511 10.11.2014 ARI -------------------------------------

      // Zu/Abschlag in Auftrag schreiben
      IF parSalesLine."Document Type"IN[parSalesLine."Document Type"::"Return Order",
                                        parSalesLine."Document Type"::"Credit Memo"] THEN BEGIN
        CLEAR(locSalesLine);
        locSalesLine.INIT;
        locSalesLine."Document Type" := parSalesLine."Document Type";
        locSalesLine."Document No." := parSalesLine."Document No.";
      //H1511 12.11.14 ARI ++++++++++++++++++++++++++++++++
        locSalesLine."Line No." :=  parSalesLine.GetLineNo(parSalesLine);
      //H1511 12.11.14 ARI --------------------------------
        locSalesLine.VALIDATE("Sell-to Customer No.",parSalesLine."Sell-to Customer No.");
        locSalesLine.VALIDATE(Type,locSalesLine.Type::"Charge (Item)");
        locSalesLine.VALIDATE("No.",locItemCharge);
        locSalesLine.VALIDATE(Quantity,1);
        locSalesLine."Location Code" := parSalesLine."Location Code";
        locSalesLine."Linked to Sales Order No." := parSourceDocNo;
        locSalesLine."Linked to Sales Order Line No." := parSourceLineNo;
        locSalesLine."Return Reason Code" := parSalesLine."Return Reason Code";
        locSalesLine."Return Type" := parSalesLine."Return Type";
        locCalcAmount := parSalesLine."Line Amount" - parSalesLine."Inv. Discount Amount";

        IF parSalesLine."Prevention discount Amount" <> 0 THEN BEGIN
          IF parSalesLine."Prevention discount Amount" > locCalcAmount THEN BEGIN
            ERROR(Error003,parSalesLine."Line No.");
          END;
          locPreventionAmount := parSalesLine."Prevention discount Amount";
        END ELSE BEGIN
          //T0016 02.07.14 tec-cs +++++++++++++++++++++++++++++
          locPreventionAmount := locCalcAmount * parSalesLine."Prevention discount (%)" / 100;
          //T0016 02.07.14 tec-cs -----------------------------
        END;
        CheckDiscountAmount(locPreventionAmount);

        locSalesLine.VALIDATE("Unit Price",locPreventionAmount);
        IF locSalesLine."Document Type" = locSalesLine."Document Type"::"Return Order" THEN
          locSalesLine.VALIDATE("Return Qty. to Receive",1)
        ELSE
          locSalesLine.VALIDATE("Qty. to Ship",1);
        locSalesLine.INSERT(TRUE);

        // Zu/Abschlag Zuweisung
        ItemChargeAssgntSales.INIT;
        ItemChargeAssgntSales."Document Type" := locSalesLine."Document Type";
        ItemChargeAssgntSales."Document No." := locSalesLine."Document No.";
        ItemChargeAssgntSales."Document Line No." := locSalesLine."Line No.";
        ItemChargeAssgntSales."Line No." := locSalesLine."Line No.";
        ItemChargeAssgntSales."Item Charge No." := locSalesLine."No.";
        ItemChargeAssgntSales."Item No." := parSalesLine."No.";
        ItemChargeAssgntSales.Description := parSalesLine.Description;
        ItemChargeAssgntSales."Unit Cost" := locSalesLine."Unit Price";
        ItemChargeAssgntSales."Applies-to Doc. Line No." := parSalesLine."Line No.";
        ItemChargeAssgntSales."Applies-to Doc. No." := parSalesLine."Document No.";
        ItemChargeAssgntSales."Qty. to Assign" := locSalesLine."Quantity (Base)";
        ItemChargeAssgntSales."Amount to Assign" := locSalesLine."Unit Price";

        locSalesHeader.GET(locSalesLine."Document Type",locSalesLine."Document No.");
        locSalesShipmentLine.RESET;
        locSalesShipmentLine.SETCURRENTKEY("Order No.","Order Line No.","Posting Date");
        locSalesShipmentLine.SETRANGE("Order No.",parSourceDocNo);
        locSalesShipmentLine.SETRANGE("Order Line No.",parSourceLineNo);
        locSalesShipmentLine.SETFILTER(Quantity,'<>0');
        IF locSalesShipmentLine.FINDFIRST THEN BEGIN
          ItemChargeAssgntSales."Applies-to Doc. Type" := ItemChargeAssgntSales."Applies-to Doc. Type"::Shipment;
          ItemChargeAssgntSales."Applies-to Doc. No." := locSalesShipmentLine."Document No.";
          ItemChargeAssgntSales."Applies-to Doc. Line No." := locSalesShipmentLine."Line No.";
        END ELSE BEGIN
          locSalesShipmentLine.RESET;
          locSalesShipmentLine.SETRANGE(locSalesShipmentLine."Document No.",locSalesHeader."Last Shipping No.");
          locSalesShipmentLine.SETRANGE(Type,locSalesShipmentLine.Type::Item);
          ItemChargeAssgntSales.SETRANGE("Item No.",parSalesLine."No.");
          locSalesShipmentLine.SETFILTER(Quantity,'<>0');
          IF locSalesShipmentLine.FINDFIRST THEN BEGIN
            ItemChargeAssgntSales."Applies-to Doc. Type" := ItemChargeAssgntSales."Applies-to Doc. Type"::Shipment;
            ItemChargeAssgntSales."Applies-to Doc. No." := locSalesShipmentLine."Document No.";
            ItemChargeAssgntSales."Applies-to Doc. Line No." := locSalesShipmentLine."Line No.";
          END;
        END;

        ItemChargeAssgntSales.INSERT;
        CreateDocDimForSalesLine(locSalesLine,parSalesLine);
        locSalesLine.UpdateItemChargeAssgnt;

      END ELSE BEGIN

        locSalesLine2.RESET;
        locSalesLine2.SETRANGE("Document Type",parSalesLine."Document Type");
        locSalesLine2.SETRANGE("Document No.",parSalesLine."No.");
        IF locSalesLine2.FINDLAST THEN BEGIN
          locLineNo := locSalesLine2."Line No." + 10000
        END ELSE BEGIN
          locLineNo := 10000;
        END;
        CLEAR(locSalesLine);
        locSalesLine.INIT;
        locSalesLine."Document Type" := parSalesLine."Document Type";
        locSalesLine."Document No." := parSalesLine."Document No.";
      //H1511 12.11.14 ARI ++++++++++++++++++++++++++++++++
        locSalesLine."Line No." := parSalesLine.GetLineNo(parSalesLine);
      //H1511 12.11.14 ARI --------------------------------
        locSalesLine.VALIDATE("Sell-to Customer No.",parSalesLine."Sell-to Customer No.");
        locSalesLine.VALIDATE(Type,locSalesLine.Type::"Charge (Item)");
        locSalesLine.VALIDATE("No.",locItemCharge);
        locSalesLine.VALIDATE(Quantity,1);
        locSalesLine."Location Code" := parSalesLine."Location Code";
        locSalesLine."Return Reason Code" := parSalesLine."Return Reason Code";
        locSalesLine."Linked to Sales Order No." := parSourceDocNo;
        locSalesLine."Linked to Sales Order Line No." := parSourceLineNo;
        locSalesLine."Return Reason Code" := parSalesLine."Return Reason Code";
        locSalesLine."Return Type" := parSalesLine."Return Type";
        locCalcAmount := parSalesLine."Line Amount" - parSalesLine."Inv. Discount Amount";
        //T0096 28.01.15 CC-GH +++++++++++++++++++++++++++++++++++++++++++++++++++
        locCalcAmount := MPDocumentMgtL.CalcMPLineAmountSL(parSalesLine) - parSalesLine."Inv. Discount Amount";
        //T0096 28.01.15 CC-GH ---------------------------------------------------

        IF parSalesLine."Prevention discount Amount" <> 0 THEN BEGIN
          IF parSalesLine."Prevention discount Amount" > locCalcAmount THEN BEGIN
            ERROR(Error003,parSalesLine."Line No.");
          END;
          locPreventionAmount := parSalesLine."Prevention discount Amount";
        END ELSE BEGIN
          //T0016 02.07.14 tec-cs +++++++++++++++++++++++++++++
          locPreventionAmount := locCalcAmount * parSalesLine."Prevention discount (%)" / 100;
          //T0016 02.07.14 tec-cs -----------------------------
        END;

        locSalesLine.VALIDATE("Unit Price",-locPreventionAmount);
        IF locSalesLine."Document Type" = locSalesLine."Document Type"::"Return Order" THEN BEGIN
          locSalesLine.VALIDATE("Return Qty. to Receive",1)
        END ELSE BEGIN
          locSalesLine.VALIDATE("Qty. to Ship",1);
        END;

        locSalesLine.INSERT(TRUE);

        ItemChargeAssgntSales.INIT;
        ItemChargeAssgntSales."Document Type" := locSalesLine."Document Type";
        ItemChargeAssgntSales."Document No." := locSalesLine."Document No.";
        ItemChargeAssgntSales."Document Line No." := locSalesLine."Line No.";
        ItemChargeAssgntSales."Line No." := locLineNo;
        ItemChargeAssgntSales."Item Charge No." := locSalesLine."No.";
        ItemChargeAssgntSales."Item No." := parSalesLine."No.";
        ItemChargeAssgntSales.Description := parSalesLine.Description;
        ItemChargeAssgntSales."Unit Cost" := locSalesLine."Unit Price";
        ItemChargeAssgntSales."Applies-to Doc. Line No." := parSalesLine."Line No.";
        ItemChargeAssgntSales."Applies-to Doc. No." := parSalesLine."Document No.";
        ItemChargeAssgntSales."Qty. to Assign" := locSalesLine."Quantity (Base)";
        ItemChargeAssgntSales."Amount to Assign" := locSalesLine."Unit Price";
        ItemChargeAssgntSales."Applies-to Doc. Type" := parSalesLine."Document Type";
        ItemChargeAssgntSales."Applies-to Doc. No." := parSalesLine."Document No.";

        locSalesHeader.GET(locSalesLine."Document Type",locSalesLine."Document No.");
        locSalesShipmentLine.RESET;
        locSalesShipmentLine.SETCURRENTKEY("Order No.","Order Line No.","Posting Date");
        locSalesShipmentLine.SETRANGE("Order No.",parSourceDocNo);
        locSalesShipmentLine.SETRANGE("Order Line No.",parSourceLineNo);
        locSalesShipmentLine.SETFILTER(Quantity,'<>0');

        IF locSalesShipmentLine.FINDFIRST THEN BEGIN
          ItemChargeAssgntSales."Applies-to Doc. Type" := ItemChargeAssgntSales."Applies-to Doc. Type"::Shipment;
          ItemChargeAssgntSales."Applies-to Doc. No." := locSalesShipmentLine."Document No.";
          ItemChargeAssgntSales."Applies-to Doc. Line No." := locSalesShipmentLine."Line No.";
        END ELSE BEGIN
          locSalesShipmentLine.RESET;
          locSalesShipmentLine.SETRANGE(locSalesShipmentLine."Document No.",locSalesHeader."Last Shipping No.");
          locSalesShipmentLine.SETRANGE(Type,locSalesShipmentLine.Type::Item);
          ItemChargeAssgntSales.SETRANGE("Item No.",parSalesLine."No.");
          locSalesShipmentLine.SETFILTER(Quantity,'<>0');
          IF locSalesShipmentLine.FINDFIRST THEN BEGIN
            ItemChargeAssgntSales."Applies-to Doc. Type" := ItemChargeAssgntSales."Applies-to Doc. Type"::Shipment;
            ItemChargeAssgntSales."Applies-to Doc. No." := locSalesShipmentLine."Document No.";
            ItemChargeAssgntSales."Applies-to Doc. Line No." := locSalesShipmentLine."Line No.";
          END;
        END;
        ItemChargeAssgntSales.INSERT;

        CreateDocDimForSalesLine(locSalesLine,parSalesLine);
        locSalesLine.UpdateItemChargeAssgnt;
      END;
    END;

    PROCEDURE CreateReturnOrder@1108200009(parOrderNo@1108200000 : Code[20];parOrderType@1108200002 : 'SalesOrder,SalesOrderArchive') : Boolean;
    VAR
      InterfaceProcessLogL@1000000016 : Record 50087;
      ReturnOrderPreventionL@1000000012 : Record 36;
      SalesLineL@1000000009 : Record 37;
      locSalesLineArch@1108200003 : Record 5108;
      SalesLineArchL@1000000010 : Record 5108;
      logOrderStatusLog@1108200007 : Record 50069;
      locSalesHeader2@1108200008 : Record 36;
      locSalesLine2@1000000000 : Record 37;
      AdminMailQueueSetup@1000000005 : Record 50092;
      locPaymMethod@1000000003 : Record 289;
      OrderStatusLogL@1000000015 : Record 50069;
      ReleaseSalesDoc@1000000002 : Codeunit 414;
      SalesPost@1000000011 : Codeunit 80;
      SalesPostPrepayments@1000000001 : Codeunit 442;
      AdminMailQueueFunctions@1000000004 : Codeunit 50019;
      LC_SalesPostPrepayments@1000000006 : Codeunit 442;
      locRecRef@1000000014 : RecordRef;
      AtLeastOneSLprocessedL@1000000013 : Boolean;
      LastOrderStatusL@1000000007 : 'Open,Released,Pending Approval,Pending Prepayment,,,Canceled';
      external_consultant@1000000008 : Text[250];
      ReturnTypeLastL@1000000017 : Option;
      IntegerL@1000000018 : Integer;
      AutomReturnProcessL@1000000019 : Codeunit 50141;
    BEGIN
      // CreateReturnOrder
      IF (parOrderNo = '') THEN BEGIN
        ERROR(Error004);
      END;

      //T0012 18.06.14 tec-sf +++++++++++++++++++++++++++++
      IF NOT CalledRecursive THEN BEGIN
        // >> T0079
        IF AutomReturnProcessL.ProcessAutomReturnOrder(parOrderNo, FALSE) THEN BEGIN
          EXIT;
        END;
        {
        AutomReturnProcessL.SetSalesHeaderNo(parOrderNo,parOrderType);
        IF AutomReturnProcessL.CheckConditions THEN BEGIN
          AutomReturnProcessL.RUN;
          EXIT;
        END;
        }
        // << T0079
      END;
      //T0012 18.06.14 tec-sf -----------------------------

      CLEAR(ReturnOrderPreventionTemp);
      ReturnOrderPreventionTemp.DELETEALL;
      SalLineDSCDToBeCancelledExists := FALSE;
      DeleteTempRecords();

      FPCGeneralSetup.GET();
      // next line to be activated in a later phase of redesign cancellation process
      // POCancInquiry_Functions.CheckPOCancInquirySetup(FPCGeneralSetup,UserSetup);

      // ALL (!!!) error handling MUST be taken care before CASE parOrderType OF
      CheckReturnOrderLines(parOrderNo,parOrderType);

      CASE parOrderType OF
        parOrderType::SalesOrder:
          BEGIN
            // SalesLineToBeProcessedTmp: see function "CheckReturnOrderLines"
            CLEAR(SalesLineToBeProcessedTmp);
            SalesLineToBeProcessedTmp.SETCURRENTKEY("Return Type");
            IF SalesLineToBeProcessedTmp.FIND('-') THEN BEGIN
              AtLeastOneSLprocessedL := FALSE;
              LastOrderStatusL := SalesHeader.Status;
              REPEAT
                GlobRecRef.GETTABLE(SalesLineToBeProcessedTmp);
                locRecRef.GETTABLE(SalesHeader);
                IF (SalesLineToBeProcessedTmp."Return Type" = SalesLineToBeProcessedTmp."Return Type"::Cancelation) THEN BEGIN
                  // Customer Complaint: Prevention before Shipment, cancellation

                  IF (SalesLineToBeProcessedTmp."Quantity Shipped" = 0) THEN BEGIN
                    // Prevention before Shipment
                    IF (SalesLineToBeProcessedTmp."Customer Prevention" =
                        SalesLineToBeProcessedTmp."Customer Prevention"::Accepted) THEN BEGIN
                      IF CheckIPLcancelled(SalesLineToBeProcessedTmp."Document No.",
                                           SalesLineToBeProcessedTmp."Line No.")
                      THEN BEGIN
                        IF CheckItemChargeAssignment(SalesLineToBeProcessedTmp) THEN BEGIN
                          locSalesHeader2.GET(SalesHeader."Document Type",SalesHeader."No.");
                          locSalesHeader2."Cancel Without Interfaces" := TRUE;
                          locSalesHeader2.MODIFY;
                          IF SalesHeader.Status <> SalesHeader.Status::Open THEN BEGIN
                            ReleaseSalesDoc.PerformManualReopen(locSalesHeader2);
                          END;
                          CalcPreventionDiscountLine(SalesLineToBeProcessedTmp,
                                                     SalesLineToBeProcessedTmp."Document No.",
                                                     SalesLineToBeProcessedTmp."Line No.");

                          locSalesHeader2.GET(SalesHeader."Document Type",SalesHeader."No.");
                          locSalesHeader2."Return Type" := locSalesHeader2."Return Type"::Cancelation;
                          locSalesHeader2.MODIFY;
                          AtLeastOneSLprocessedL := TRUE;
                        END;  // IF CheckItemChargeAssignment(locSalesLine) THEN BEGIN
                      END;
                    END ELSE BEGIN  // IF (locSalesLine."Customer Prevention" = "Customer Prevention"::accepted) THEN BEGIN
                      IF (SalesLineToBeProcessedTmp."Customer Prevention" IN
                            [SalesLineToBeProcessedTmp."Customer Prevention"::Declined,
                             SalesLineToBeProcessedTmp."Customer Prevention"::"Not offered"])
                         AND
                         (SalesLineToBeProcessedTmp."Status Return Order" =
                            SalesLineToBeProcessedTmp."Status Return Order"::" ")
                      THEN BEGIN
                        // Customer Complaint: Cancellation
                        CLEAR(OrderStatusLogL);
                        OrderStatusLogL.SETCURRENTKEY("Document Type","Document No.","Line No.");
                        OrderStatusLogL.SETRANGE("Document Type",OrderStatusLogL."Document Type"::"Sales Order");
                        OrderStatusLogL.SETRANGE("Document No.",SalesHeader."No.");
                        OrderStatusLogL.SETRANGE("Line No.",SalesLineToBeProcessedTmp."Line No.");
                        IF OrderStatusLogL.FINDLAST THEN BEGIN
                          IF (OrderStatusLogL.Code < '40') THEN BEGIN
                            logOrderStatusLog.CreateOrderStatus(0,
                                                                SalesLineToBeProcessedTmp."Document No.",
                                                                SalesLineToBeProcessedTmp."Line No.",
                                                                '40',
                                                                STRSUBSTNO(LineStatus002));
                            locSalesHeader2.GET(SalesHeader."Document Type",SalesHeader."No.");
                            locSalesHeader2."Return Type" := locSalesHeader2."Return Type"::Cancelation;
                            locSalesHeader2.MODIFY;
                            AtLeastOneSLprocessedL := TRUE;
                          END;
                        END ELSE BEGIN
                          logOrderStatusLog.CreateOrderStatus(0,
                                                              SalesLineToBeProcessedTmp."Document No.",
                                                              SalesLineToBeProcessedTmp."Line No.",
                                                              '40',
                                                              STRSUBSTNO(LineStatus002));
                          locSalesHeader2.GET(SalesHeader."Document Type",SalesHeader."No.");
                          locSalesHeader2."Return Type" := locSalesHeader2."Return Type"::Cancelation;
                          locSalesHeader2.MODIFY;
                          AtLeastOneSLprocessedL := TRUE;
                        END;
                      END;
                    END;  // IF (locSalesLine."Customer Prevention" = locSalesLine."Customer Prevention"::accepted) THEN BEGIN
                  END;  // IF (locSalesLine."Quantity shipped" = 0) THEN BEGIN

                END ELSE BEGIN  // IF (locSalesLine."Return Type" = locSalesLine."Return Type"::Cancelation) THEN BEGIN
                  //  Customer Complaint Return, Change :
                  IF (SalesLineToBeProcessedTmp."Quantity Shipped" <> 0) THEN BEGIN
                    IF (ReturnTypeLastL <> SalesLineToBeProcessedTmp."Return Type") THEN BEGIN
                      ReturnTypeLastL := SalesLineToBeProcessedTmp."Return Type";
                      GlobRecRef.GETTABLE(SalesLineToBeProcessedTmp);
                      CreateReturnDocument(locRecRef,SalesLineToBeProcessedTmp."Return Type");
                      AtLeastOneSLprocessedL := TRUE;
                    END;
                  END;
                END;  // IF (locSalesLine."Return Type" = locSalesLine."Return Type"::Cancelation) THEN BEGIN

              UNTIL SalesLineToBeProcessedTmp.NEXT = 0;

              IF AtLeastOneSLprocessedL THEN BEGIN
                SalesHeader.GET(SalesHeader."Document Type"::Order,parOrderNo);
                IF SalesHeader.Status = SalesHeader.Status::Open THEN BEGIN
                  CASE LastOrderStatusL OF
                    LastOrderStatusL::"Pending Prepayment":
                      BEGIN
                        ReleaseSalesDoc.CalledbyMagentoCancel(TRUE);
                        LC_SalesPostPrepayments.Invoice(SalesHeader);
                      END;
                    LastOrderStatusL::Released:
                      BEGIN
                        IF (CancellationCase <> CancellationCase::CancelOrder) THEN BEGIN
                          ReleaseSalesDoc.CalledbyMagentoCancel(TRUE);
                          ReleaseSalesDoc.PerformManualRelease(SalesHeader);
                        END;
                      END;
                  END;
                END;
              END ELSE BEGIN
                // T0080 18.11.2014 tec-cs +++++++++++++++++++++++
                //DisplayMessage(TextHME006,0,'','','');
                // T0080 18.11.2014 tec-cs -----------------------
                EXIT(FALSE);
              END;

              locSalesHeader2.GET(SalesHeader."Document Type",SalesHeader."No.");
              locSalesHeader2."Cancel Without Interfaces" := FALSE;
              locSalesHeader2.MODIFY;

            END ELSE BEGIN // IF locSalesLine.FIND('-') THEN BEGIN
              // T0080 18.11.2014 tec-cs +++++++++++++++++++++++
              //DisplayMessage(TextHME006,0,'','','');
              // T0080 18.11.2014 tec-cs -----------------------
              EXIT(FALSE);
            END;  // IF locSalesLine.FIND('-') THEN BEGIN
          END;  // parOrderType::SalesOrder: BEGIN

        parOrderType::SalesOrderArchive:
          BEGIN
            SalesLineArchToBeProcessedTmp.RESET;
            SalesLineArchToBeProcessedTmp.SETCURRENTKEY("Return Type");
            IF SalesLineArchToBeProcessedTmp.FIND('-') THEN BEGIN
              REPEAT
                IF (ReturnTypeLastL <> SalesLineArchToBeProcessedTmp."Return Type") THEN BEGIN
                  ReturnTypeLastL := SalesLineArchToBeProcessedTmp."Return Type";
                  locRecRef.GETTABLE(SalesHeaderArchive);
                  GlobRecRef.GETTABLE(SalesLineArchToBeProcessedTmp);
                  CreateReturnDocument(locRecRef,SalesLineArchToBeProcessedTmp."Return Type");
                END;
              UNTIL SalesLineArchToBeProcessedTmp.NEXT = 0;
            END ELSE BEGIN // IF locSalesLineArch.FINDFIRST THEN BEGIN
              // T0080 18.11.2014 tec-cs +++++++++++++++++++++++
              //DisplayMessage(TextHME006,0,'','','');
              // T0080 18.11.2014 tec-cs -----------------------
              EXIT(FALSE);
            END;  // IF SalesLineArchToBeProcessedTmp.FIND('-') THEN BEGIN
          END;  // parOrderType::SalesOrderArchive: BEGIN
      END;  // CASE parOrderType OF


      // Update "Status Return Order" for all lines and header affected
      COMMIT;
      UpdateStatusReturnOrder();

      // Post Return Orders for prevention after shipment
      COMMIT;
      PostReturnOrdersPrevAfterShpt();

      EXIT(TRUE);
    END;

    PROCEDURE CreateReturnDocument@1108200012(SalesHeaderRecRefV@1108200001 : RecordRef;parReturnType@1108200000 : Option);
    VAR
      NewSalesHeader@1108200002 : Record 36;
      locLineno@1108200004 : Integer;
      NewSalesLine@1108200005 : Record 37;
      locSalesHeader@1108200006 : Record 36;
      locSalesHeaderArch@1108200007 : Record 5107;
      locSalesLineArch@1108200008 : Record 5108;
      logOrderStatusLog@1108200009 : Record 50069;
      locResSalesLineArch@1108200010 : Record 5108;
      locFPCGeneralSetup@1108200012 : Record 50055;
      locLastLineNo@1000000000 : Record 37;
      locWebDeskMgt@1000000001 : Codeunit 5327126;
      locResLine@1000000002 : Record 37;
      locRecRef2@1000000003 : RecordRef;
      locResLineArch@1000000004 : Record 5108;
      locCancRetOrderHistory@1000000006 : Record 50037;
      NextEntryNo@1000000005 : Integer;
      GetReturnHeader@1000000007 : Record 36;
      GetReturnHeaderArch@1000000008 : Record 5107;
      locSalesCommentLine@1000000009 : Record 44;
      locSalesCommentLineArch@1000000010 : Record 5126;
      "***HME************************"@1000000014 : Integer;
      eBayNavCWebshopItemL@1000000013 : Record 5251566;
      ReturnShippingAgentsSetupL@1000000016 : Record 50246;
      SalesReceivablesSetupL@1000000012 : Record 311;
      IsPreventionAfterShipmentL@1000000011 : Boolean;
      SparePartMgtL@1000000017 : Codeunit 50322;
      CountSalesLinesL@1000000018 : Integer;
      "***CC*************************"@1000010015 : Integer;
      MPDocumentMgtL@1000010017 : Codeunit 50500;
    BEGIN
      // CreateReturnDocument
      CLEAR(locSalesHeader);
      CLEAR(locSalesHeaderArch);
      CLEAR(locSalesLineArch);
      //H1472 30.10.14 rst +++++++++++++++++++++++++++++++++++
      CLEAR(CountSalesLinesL);
      //H1472 30.10.14 rst --------------------------------------------------------------

      locFPCGeneralSetup.GET();
      locFPCGeneralSetup.TESTFIELD("Return Location Code");

      CASE SalesHeaderRecRefV.NUMBER OF
        DATABASE::"Sales Header":
          BEGIN
            SalesHeaderRecRefV.SETTABLE(locSalesHeader);
            SalesLineToBeProcessedTmp2.RESET;
            SalesLineToBeProcessedTmp2.SETCURRENTKEY("Return Type");
            SalesLineToBeProcessedTmp2.SETRANGE("Return Type",parReturnType);
            IF SalesLineToBeProcessedTmp2.FIND('-') THEN BEGIN
              IsPreventionAfterShipmentL := FALSE;
              //H1472 30.10.14 rst +++++++++++++++++++++++++++++++++++
              IF SalesLineToBeProcessedTmp2."Return Type" = SalesLineToBeProcessedTmp2."Return Type"::"Spare Part" THEN BEGIN
                SparePartMgtL.InsertSOrderFromSalesHeader(locSalesHeader,NewSalesHeader);
                CountSalesLinesL += 1;
              END ELSE BEGIN
              //H1472 30.10.14 rst --------------------------------------------------------------
                NewSalesHeader.INIT;
                NewSalesHeader."No." := '';
                NewSalesHeader."Document Type" := NewSalesHeader."Document Type"::"Return Order";
                NewSalesHeader.INSERT(TRUE);
                //H0584 19.02.14 HCN +++++++++++++++++++++++++++++
                // memorize return order with prevention after shipment for immediate posting
                IF (SalesLineToBeProcessedTmp2."Return Type" = SalesLineToBeProcessedTmp2."Return Type"::Return) AND
                   (SalesLineToBeProcessedTmp2."Customer Prevention" = SalesLineToBeProcessedTmp2."Customer Prevention"::Accepted)
                THEN BEGIN
                  IsPreventionAfterShipmentL := TRUE;
                  ReturnOrderPreventionTemp.INIT;
                  ReturnOrderPreventionTemp := NewSalesHeader;
                  ReturnOrderPreventionTemp."Status Return Order" := SalesLineToBeProcessedTmp2."Line No.";
                  ReturnOrderPreventionTemp.INSERT;
                END;
                //H0584 19.02.14 HCN -----------------------------
                NewSalesHeader.VALIDATE("Sell-to Customer No.",locSalesHeader."Sell-to Customer No.");
                NewSalesHeader.VALIDATE("Bill-to Customer No.",locSalesHeader."Bill-to Customer No.");
                NewSalesHeader."Sell-to Customer Name"       := locSalesHeader."Ship-to Name";
                NewSalesHeader."Sell-to Customer Name 2"     := locSalesHeader."Ship-to Name 2";
                NewSalesHeader."Sell-to Address"             := locSalesHeader."Ship-to Address";
                NewSalesHeader."Sell-to Address 2"           := locSalesHeader."Ship-to Address 2";
                NewSalesHeader."Sell-to City"                := locSalesHeader."Ship-to City";
                NewSalesHeader."Sell-to Contact"             := locSalesHeader."Ship-to Contact";
                NewSalesHeader."Sell-to Post Code"           := locSalesHeader."Ship-to Post Code";
                NewSalesHeader."Sell-to Country/Region Code" := locSalesHeader."Ship-to Country/Region Code";
                NewSalesHeader."Ship-to Code"                := locSalesHeader."Ship-to Code";
                NewSalesHeader."Ship-to Name"                := locSalesHeader."Ship-to Name";
                NewSalesHeader."Ship-to Name 2"              := locSalesHeader."Ship-to Name 2";
                NewSalesHeader."Ship-to Address"             := locSalesHeader."Ship-to Address";
                NewSalesHeader."Ship-to Address 2"           := locSalesHeader."Ship-to Address 2";
                NewSalesHeader."Ship-to City"                := locSalesHeader."Ship-to City";
                NewSalesHeader."Posting Date"                := TODAY;
                NewSalesHeader."Account Holder"              := locSalesHeader."Account Holder";
                NewSalesHeader."Account No."                 := locSalesHeader."Account No.";
                NewSalesHeader."Account BLZ"                 := locSalesHeader."Account BLZ";
                NewSalesHeader."Payment Method Code"         := locSalesHeader."Payment Method Code";
                //H1200 13.08.14 DMA ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
                SalesReceivablesSetupL.GET;
                IF SalesReceivablesSetupL."Use Only Def. Location For SR"
                  OR (SalesReceivablesSetupL."Default Sales Return Location" <> '') THEN BEGIN
                  NewSalesHeader.VALIDATE("Location Code",SalesReceivablesSetupL."Default Sales Return Location");
                END ELSE BEGIN
                //H1200 13.08.14 DMA --------------------------------------------------------------
                 NewSalesHeader.VALIDATE("Location Code",locFPCGeneralSetup."Return Location Code");
                //H1200 13.08.14 DMA ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
                END;
                //H1200 13.08.14 DMA --------------------------------------------------------------
                NewSalesHeader."Prices Including VAT"        := locSalesHeader."Prices Including VAT";
                NewSalesHeader."Gen. Bus. Posting Group"     := locSalesHeader."Gen. Bus. Posting Group";
                NewSalesHeader."VAT Bus. Posting Group"      := locSalesHeader."VAT Bus. Posting Group";
                NewSalesHeader."Return Type"                 := parReturnType;
                //H1184 21.05.14 HCN +++++++++++++++++++++++++++++
                NewSalesHeader."Status Return Order"         := NewSalesHeader."Status Return Order"::open;
                //H1184 21.05.14 HCN -----------------------------

                IF locSalesHeader."External Document No." = '' THEN BEGIN
                  NewSalesHeader."External Document No." := locSalesHeader."No.";
                  locSalesHeader."External Document No." := locSalesHeader."No.";
                  locSalesHeader.MODIFY(FALSE);
                END ELSE BEGIN
                  NewSalesHeader."External Document No." := locSalesHeader."External Document No.";
                END;
                IF locSalesHeader."Is Follow-up Sales Order" THEN BEGIN
                  locSalesCommentLine.INIT;
                  locSalesCommentLine."Document Type"     := NewSalesHeader."Document Type";
                  locSalesCommentLine."No."               := NewSalesHeader."No.";
                  locSalesCommentLine."Document Line No." := 0;
                  locSalesCommentLine."Line No."          := 10000;
                  locSalesCommentLine.Date                := TODAY;
                  locSalesCommentLine.Comment             := STRSUBSTNO(Text005,locSalesHeader."No.");
                  locSalesCommentLine.INSERT;
                END;

              IF NewSalesHeader."Return Type" = NewSalesHeader."Return Type"::Change THEN
                NewSalesHeader."On Hold" := 'UM';
              NewSalesHeader."Website No." := locSalesHeader."Website No.";
              CreateDocDimForSalesHeader(NewSalesHeader,locSalesHeader);
              NewSalesHeader.MODIFY;
              locLineno := 10000;
              REPEAT
                IF locCancRetOrderHistory.FINDLAST THEN
                  NextEntryNo := locCancRetOrderHistory."Entry No." + 1
                ELSE
                  NextEntryNo := 1;

                locLineno := GetLineNo(NewSalesLine);
                NewSalesLine.INIT;
                NewSalesLine."Document Type" := NewSalesHeader."Document Type";
                NewSalesLine."Document No." := NewSalesHeader."No.";
                NewSalesLine."Line No." := locLineno;
                NewSalesLine.INSERT(TRUE);
                NewSalesLine.VALIDATE("Sell-to Customer No.",SalesLineToBeProcessedTmp2."Sell-to Customer No.");
                NewSalesLine.VALIDATE(Type,SalesLineToBeProcessedTmp2.Type);
                NewSalesLine.VALIDATE("No.",SalesLineToBeProcessedTmp2."No.");
                NewSalesLine.Description := SalesLineToBeProcessedTmp2.Description;
                NewSalesLine.VALIDATE("Purchasing Code",SalesLineToBeProcessedTmp2."Purchasing Code");
                //T0060 19.02.15 CC-GH +++++++++++++++++++++++++++++++++++++++++++++++++++
                IF NOT MPDocumentMgtL.SetMPSalesRetLocationCode(NewSalesLine, SalesLineToBeProcessedTmp2) THEN BEGIN
                  NewSalesLine.VALIDATE("Location Code",NewSalesHeader."Location Code");
                END;
                //T0060 19.02.15 CC-GH ---------------------------------------------------
                NewSalesLine.VALIDATE(Quantity,SalesLineToBeProcessedTmp2.Quantity);
                NewSalesLine.VALIDATE("Unit Price",SalesLineToBeProcessedTmp2."Unit Price");
                NewSalesLine.VALIDATE("Line Discount %",SalesLineToBeProcessedTmp2."Line Discount %");
                NewSalesLine.VALIDATE("Inv. Discount Amount",SalesLineToBeProcessedTmp2."Inv. Discount Amount");
                NewSalesLine."Gen. Bus. Posting Group"        := SalesLineToBeProcessedTmp2."Gen. Bus. Posting Group";
                NewSalesLine."VAT Bus. Posting Group"         := SalesLineToBeProcessedTmp2."VAT Bus. Posting Group";
                NewSalesLine."Return Type"                    := SalesLineToBeProcessedTmp2."Return Type";
                NewSalesLine."Customer Prevention"            := SalesLineToBeProcessedTmp2."Customer Prevention";
                //T0016 02.07.14 tec-cs +++++++++++++++++++++++++++++
                NewSalesLine."Prevention discount (%)"        := SalesLineToBeProcessedTmp2."Prevention discount (%)";
                //T0016 02.07.14 tec-cs -----------------------------
                NewSalesLine."Prevention discount Amount"     := SalesLineToBeProcessedTmp2."Prevention discount Amount";
                NewSalesLine."Return Reason Code"             := SalesLineToBeProcessedTmp2."Return Reason Code";
                NewSalesLine."Transp. Type"                   := SalesLineToBeProcessedTmp2."Transp. Type";
                NewSalesLine."Linked to Sales Order No."      := SalesLineToBeProcessedTmp2."Document No.";
                NewSalesLine."Linked to Sales Order Line No." := SalesLineToBeProcessedTmp2."Line No.";
                //H1202, H1184 04.06.14 HCN +++++++++++++++++++++++++++++
                NewSalesLine."Status Return Order"            := NewSalesLine."Status Return Order"::open;
                //H1734  05.11.14  MIK +++++++++++++++++++++++++++++
                NewSalesLine.ID                               := SalesLineToBeProcessedTmp2.ID;
                //H1734  05.11.14  MIK -----------------------------
                //H1202, H1184 04.06.14 HCN -----------------------------
                //H1389 11.08.14 MSL +++++++++++++++++++++++++++++
                //H4307 26.06.2015 gob-dah ++++++++++++++++++++++++++
                AppliedFromItemEntry := GetShippedItemLedgerEntry(NewSalesLine."Linked to Sales Order No.",
                                                                  NewSalesLine."Linked to Sales Order Line No.",
                                                                  NewSalesLine."No.");
                NewSalesLine.VALIDATE("Appl.-from Item Entry",AppliedFromItemEntry);
                //H4307 26.06.2015 gob-dah --------------------------

                eBayNavCWebshopItemL.GET(FORMAT(NewSalesHeader."Website No."),SalesLineToBeProcessedTmp2."No.");
                ReturnShippingAgentsSetupL.SETCURRENTKEY(Priority);
                ReturnShippingAgentsSetupL.SETRANGE("Website No.",NewSalesHeader."Website No.");
                ReturnShippingAgentsSetupL.SETRANGE("Transp. Type",SalesLineToBeProcessedTmp2."Transp. Type");
                ReturnShippingAgentsSetupL.SETRANGE("Shipping Agent Code",eBayNavCWebshopItemL."Shipping Agent Code");
                IF ReturnShippingAgentsSetupL.FINDFIRST THEN
                  NewSalesLine."Shipping Agent Code" := eBayNavCWebshopItemL."Shipping Agent Code"
                ELSE BEGIN
                  ReturnShippingAgentsSetupL.SETRANGE("Shipping Agent Code");
                  IF ReturnShippingAgentsSetupL.FINDLAST THEN
                    NewSalesLine."Shipping Agent Code" := ReturnShippingAgentsSetupL."Shipping Agent Code";
                END;
                NewSalesLine.MODIFY;
                //H1389 11.08.14 MSL -----------------------------
                //T0062 24.10.14  tec-sh++++++++++++++
                MPCommissionMgt.InsertModifyMPCommissionLine(NewSalesLine);
                //T0062 24.10.14  tec-sh--------------

                //H1390 21.08.14 MSL +++++++++++++++++++++++++++++
                NewSalesHeader.ConsolidateShippingAgent;
                //H1390 21.08.14 MSL -----------------------------
                // H1241       12.09.14  JM ++++++++++++++++++++++
                InvH24Mgt.CreateDunningEntry(NewSalesLine);
                // H1241       12.09.14  JM ----------------------
                CreateDocDimForSalesLine(NewSalesLine,SalesLineToBeProcessedTmp2);

                locCancRetOrderHistory.INIT;
                locCancRetOrderHistory."Entry No."                    := NextEntryNo;
                locCancRetOrderHistory."Document Type"                := locCancRetOrderHistory."Document Type"::"Return Order";
                locCancRetOrderHistory."Document No."                 := NewSalesLine."Document No.";
                locCancRetOrderHistory."Line No."                     := NewSalesLine."Line No.";
                locCancRetOrderHistory."Return Type"                  := SalesLineToBeProcessedTmp2."Return Type";
                locCancRetOrderHistory.Type                           := SalesLineToBeProcessedTmp2.Type;
                locCancRetOrderHistory."No."                          := SalesLineToBeProcessedTmp2."No.";
                locCancRetOrderHistory.Amount                         := ABS(SalesLineToBeProcessedTmp2."Line Amount" -
                                                                             SalesLineToBeProcessedTmp2."Inv. Discount Amount");
                locCancRetOrderHistory."Related to Document Type"     := locCancRetOrderHistory."Related to Document Type"::Order;
                locCancRetOrderHistory."Related to Document No."      := SalesLineToBeProcessedTmp2."Document No.";
                locCancRetOrderHistory."Related to Document Line No." := SalesLineToBeProcessedTmp2."Line No.";
                locCancRetOrderHistory."Date/Time"                    := CURRENTDATETIME;
                locCancRetOrderHistory."User ID"                      := USERID;
                locCancRetOrderHistory.INSERT;

                CASE NewSalesLine."Return Type" OF
                  NewSalesLine."Return Type"::Return:
                    BEGIN
                      IF (NewSalesLine."Customer Prevention" = NewSalesLine."Customer Prevention"::Accepted) THEN BEGIN
                        CalcPreventionDiscountLine(NewSalesLine,
                                                   SalesLineToBeProcessedTmp2."Document No.",
                                                   SalesLineToBeProcessedTmp2."Line No.");
                        ClearSalesAmount(NewSalesLine);
                        logOrderStatusLog.CreateOrderStatus(0,
                                                            SalesLineToBeProcessedTmp2."Document No.",
                                                            SalesLineToBeProcessedTmp2."Line No.",
                                                            '50',
                                                            STRSUBSTNO(LineStatus004,NewSalesHeader."No."));
                      END ELSE BEGIN
                        IF (NewSalesLine."Customer Prevention" = NewSalesLine."Customer Prevention"::Declined) THEN BEGIN

                          CopyItemChargeToReturnOrder(SalesLineToBeProcessedTmp2,NewSalesLine);

                          logOrderStatusLog.CreateOrderStatus(0,
                                                              SalesLineToBeProcessedTmp2."Document No.",
                                                              SalesLineToBeProcessedTmp2."Line No.",
                                                              '50',
                                                              STRSUBSTNO(LineStatus001,NewSalesHeader."No."));
                        END;
                      END;
                    END;

                  NewSalesLine."Return Type"::Change:
                    BEGIN
                      //H1202 04.06.14 HCN +++++++++++++++++++++++++++++
                      CopyItemChargeToReturnOrder(SalesLineToBeProcessedTmp2,NewSalesLine);
                      //H1202 04.06.14 HCN -----------------------------
                      logOrderStatusLog.CreateOrderStatus(0,
                                                          SalesLineToBeProcessedTmp2."Document No.",
                                                          SalesLineToBeProcessedTmp2."Line No.",
                                                          '60',
                                                          STRSUBSTNO(LineStatus005,NewSalesHeader."No."));
                    END;
                //H1472 29.09.14 rst +++++++++++++++++++++++++++++++++++++++++++++
                {
                  NewSalesLine."Return Type"::"Spare Part":
                    BEGIN
                      //H1202 04.06.14 HCN +++++++++++++++++++++++++++++
                      IF (NewSalesLine."Customer Prevention" = NewSalesLine."Customer Prevention"::Accepted) THEN BEGIN
                        CalcPreventionDiscountLine(NewSalesLine,
                                                   SalesLineArchToBeProcessedTmp2."Document No.",
                                                   SalesLineArchToBeProcessedTmp2."Line No.");
                        ClearSalesAmount(NewSalesLine);
                      END;
                      logOrderStatusLog.CreateOrderStatus(0,
                                                          SalesLineToBeProcessedTmp2."Document No.",
                                                          SalesLineToBeProcessedTmp2."Line No.",
                                                          '80',
                                                          STRSUBSTNO(LineStatus004,NewSalesHeader."No."));
                      //H1202 04.06.14 HCN -----------------------------
                    END;
                }
                //H1472 29.09.14 rst ----------------------------------
                END;  // CASE NewSalesLine."Return Type" OF

                //H1202 04.06.14 HCN +++++++++++++++++++++++++++++
                IF (NewSalesLine."Return Type" IN [NewSalesLine."Return Type"::Return,
                                                   NewSalesLine."Return Type"::Change])
                THEN BEGIN
                  CheckCopyResourceToReturnOrder(SalesHeaderRecRefV,
                                                 NewSalesHeader,
                                                 NewSalesLine,
                                                 parReturnType);
                END;
                //H1202 04.06.14 HCN -----------------------------

                //T0060 19.02.15 CC-GH +++++++++++++++++++++++++++++++++++++++++++++++++++
                MPDocumentMgtL.CheckCopyMPChargeToReturnOrder(SalesHeaderRecRefV,
                  SalesLineToBeProcessedTmp2,
                  SalesLineArchToBeProcessedTmp2,
                  NewSalesHeader,
                  NewSalesLine,
                  parReturnType);
                //T0060 19.02.15 CC-GH ---------------------------------------------------

              UNTIL SalesLineToBeProcessedTmp2.NEXT = 0;
              //H1472 29.09.14 rst ++++++++++++++++++++++++++++++++++
              END;
              //H1472 29.09.14 rst ----------------------------------
            END;  // IF SalesLineToBeProcessedTmp2.FIND('-') THEN BEGIN

            CheckRessourceToReturnOrder(SalesHeaderRecRefV,NewSalesHeader,locLineno);
            SetReturnTypeSourceDoc(SalesHeaderRecRefV);

            IF IsPreventionAfterShipmentL THEN BEGIN
              DisplayMessage(TextHME013,1,NewSalesHeader."No.",'','');
            END ELSE BEGIN
              //H1472 30.10.14 rst ++++++++++++++++++++++++++++++++++
              IF parReturnType = 3 THEN BEGIN // Spare Part
                IF CountSalesLinesL = 1 THEN BEGIN
                  DisplayMessage(TextHME052,1,NewSalesHeader."No.",'','');
                END ELSE BEGIN
                  DisplayMessage(TextHME053,1,FORMAT(CountSalesLinesL),'','');
                END;
              END ELSE BEGIN
              //H1472 30.10.14 rst ----------------------------------
                DisplayMessage(Message001,1,NewSalesHeader."No.",'','');
              //H1472 30.10.14 rst ++++++++++++++++++++++++++++++++++
              END;
              //H1472 30.10.14 rst ----------------------------------
            END;

          END;  // DATABASE::"Sales Header": BEGIN

        DATABASE::"Sales Header Archive":
          BEGIN
            SalesHeaderRecRefV.SETTABLE(locSalesHeaderArch);
            SalesLineArchToBeProcessedTmp2.RESET;
            SalesLineArchToBeProcessedTmp2.SETCURRENTKEY("Return Type");
            SalesLineArchToBeProcessedTmp2.SETRANGE("Return Type",parReturnType);
            IF SalesLineArchToBeProcessedTmp2.FIND('-') THEN BEGIN
              IsPreventionAfterShipmentL := FALSE;
              //H1472 30.10.14 rst +++++++++++++++++++++++++++++++++++
              IF SalesLineArchToBeProcessedTmp2."Return Type" = SalesLineArchToBeProcessedTmp2."Return Type"::"Spare Part" THEN BEGIN
                SparePartMgtL.InsertSOrderFromSalesHeaderArc(locSalesHeaderArch,NewSalesHeader);
                CountSalesLinesL += 1;
              END ELSE BEGIN
              //H1472 30.10.14 rst --------------------------------------------------------------
                NewSalesHeader.INIT;
                NewSalesHeader."No." := '';
                NewSalesHeader."Document Type" := NewSalesHeader."Document Type"::"Return Order";
                NewSalesHeader.INSERT(TRUE);
                // memorize return order for prevention after shipment for immediate posting
                IF (SalesLineArchToBeProcessedTmp2."Return Type" = SalesLineArchToBeProcessedTmp2."Return Type"::Return) AND
                   (SalesLineArchToBeProcessedTmp2."Customer Prevention" = SalesLineArchToBeProcessedTmp2."Customer Prevention"::
      Accepted)
                THEN BEGIN
                  IsPreventionAfterShipmentL := TRUE;
                  ReturnOrderPreventionTemp.INIT;
                  ReturnOrderPreventionTemp := NewSalesHeader;
                  ReturnOrderPreventionTemp."Status Return Order" := SalesLineArchToBeProcessedTmp2."Line No.";
                  ReturnOrderPreventionTemp.INSERT;
                END;
                NewSalesHeader.VALIDATE("Sell-to Customer No.",locSalesHeaderArch."Sell-to Customer No.");
                NewSalesHeader.VALIDATE("Bill-to Customer No.",locSalesHeaderArch."Bill-to Customer No.");
                NewSalesHeader."Sell-to Customer Name"       := locSalesHeaderArch."Ship-to Name";
                NewSalesHeader."Sell-to Customer Name 2"     := locSalesHeaderArch."Ship-to Name 2";
                NewSalesHeader."Sell-to Address"             := locSalesHeaderArch."Ship-to Address";
                NewSalesHeader."Sell-to Address 2"           := locSalesHeaderArch."Ship-to Address 2";
                NewSalesHeader."Sell-to City"                := locSalesHeaderArch."Ship-to City";
                NewSalesHeader."Sell-to Contact"             := locSalesHeaderArch."Ship-to Contact";
                NewSalesHeader."Sell-to Post Code"           := locSalesHeaderArch."Ship-to Post Code";
                NewSalesHeader."Sell-to Country/Region Code" := locSalesHeaderArch."Ship-to Country/Region Code";
                NewSalesHeader."Ship-to Code"        := locSalesHeaderArch."Ship-to Code";
                NewSalesHeader."Ship-to Name"        := locSalesHeaderArch."Ship-to Name";
                NewSalesHeader."Ship-to Name 2"      := locSalesHeaderArch."Ship-to Name 2";
                NewSalesHeader."Ship-to Address"     := locSalesHeaderArch."Ship-to Address";
                NewSalesHeader."Ship-to Address 2"   := locSalesHeaderArch."Ship-to Address 2";
                NewSalesHeader."Ship-to City"        := locSalesHeaderArch."Ship-to City";
                NewSalesHeader."Sell-to Post Code"   := locSalesHeaderArch."Ship-to Post Code";
                NewSalesHeader."Posting Date"        := TODAY;
                NewSalesHeader."Return Type"         := parReturnType;
                //H1184 21.05.14 HCN +++++++++++++++++++++++++++++
                NewSalesHeader."Status Return Order" := NewSalesHeader."Status Return Order"::open;
                //H1184 21.05.14 HCN -----------------------------

                NewSalesHeader."Account Holder"      := locSalesHeaderArch."Account Holder";
                NewSalesHeader."Account No."         := locSalesHeaderArch."Account No.";
                NewSalesHeader."Account BLZ"         := locSalesHeaderArch."Account BLZ";
                NewSalesHeader."Payment Method Code" := locSalesHeaderArch."Payment Method Code";

                //H1200 13.08.14 DMA ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
                SalesReceivablesSetupL.GET;
                IF SalesReceivablesSetupL."Use Only Def. Location For SR"
                  OR (SalesReceivablesSetupL."Default Sales Return Location" <> '') THEN BEGIN
                  NewSalesHeader.VALIDATE("Location Code",SalesReceivablesSetupL."Default Sales Return Location");
                END ELSE BEGIN
                //H1200 13.08.14 DMA --------------------------------------------------------------
                NewSalesHeader.VALIDATE("Location Code",locFPCGeneralSetup."Return Location Code");
                //H1200 13.08.14 DMA ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
                END;
                //H1200 13.08.14 DMA --------------------------------------------------------------

                NewSalesHeader."Prices Including VAT"    := locSalesHeaderArch."Prices Including VAT";
                NewSalesHeader."Gen. Bus. Posting Group" := locSalesHeaderArch."Gen. Bus. Posting Group";
                NewSalesHeader."VAT Bus. Posting Group"  := locSalesHeaderArch."VAT Bus. Posting Group";

                IF locSalesHeaderArch."External Document No." = '' THEN BEGIN
                  NewSalesHeader."External Document No." := locSalesHeaderArch."No.";
                  locSalesHeaderArch."External Document No." := locSalesHeaderArch."No.";
                  locSalesHeaderArch.MODIFY(FALSE);
                END ELSE BEGIN
                  NewSalesHeader."External Document No." := locSalesHeaderArch."External Document No.";
                END;
                IF locSalesHeader."Is Follow-up Sales Order" THEN BEGIN
                  locSalesCommentLine.INIT;
                  locSalesCommentLine."Document Type"     := NewSalesHeader."Document Type";
                  locSalesCommentLine."No."               := NewSalesHeader."No.";
                  locSalesCommentLine."Document Line No." := 0;
                  locSalesCommentLine."Line No."          := 10000;
                  locSalesCommentLine.Date                := WORKDATE;
                  locSalesCommentLine.Comment             := STRSUBSTNO(Text005,locSalesHeaderArch."No.");
                  locSalesCommentLine.INSERT;
                END;

              IF NewSalesHeader."Return Type" = NewSalesHeader."Return Type"::Change THEN
                NewSalesHeader."On Hold" := 'UM';

              NewSalesHeader."Website No." := locSalesHeaderArch."Website No.";
              CreateDocDimForSalesHeaderArch(NewSalesHeader,locSalesHeaderArch);

              NewSalesHeader."Return Type" := parReturnType;

              NewSalesHeader.MODIFY;
              locLineno := 10000;
              REPEAT
                IF locCancRetOrderHistory.FINDLAST THEN
                  NextEntryNo := locCancRetOrderHistory."Entry No." + 1
                ELSE
                  NextEntryNo := 1;
                locLineno := GetLineNo(NewSalesLine);
                NewSalesLine.INIT;
                NewSalesLine."Document Type" := NewSalesHeader."Document Type";
                NewSalesLine."Document No." := NewSalesHeader."No.";
                NewSalesLine."Line No." := locLineno;
                NewSalesLine.INSERT(TRUE);
                NewSalesLine.VALIDATE("Sell-to Customer No.",SalesLineArchToBeProcessedTmp2."Sell-to Customer No.");
                NewSalesLine.VALIDATE(Type,SalesLineArchToBeProcessedTmp2.Type);
                NewSalesLine.VALIDATE("No.",SalesLineArchToBeProcessedTmp2."No.");
                NewSalesLine.Description := SalesLineArchToBeProcessedTmp2.Description;
                NewSalesLine.VALIDATE("Purchasing Code",SalesLineArchToBeProcessedTmp2."Purchasing Code");
                //T0060 19.02.15 CC-GH +++++++++++++++++++++++++++++++++++++++++++++++++++
                IF NOT MPDocumentMgtL.SetMPSalesRetLocationCodeArch(NewSalesLine, SalesLineArchToBeProcessedTmp2) THEN BEGIN
                  NewSalesLine.VALIDATE("Location Code",NewSalesHeader."Location Code");
                END;
                //T0060 19.02.15 CC-GH ---------------------------------------------------
                NewSalesLine.VALIDATE(Quantity,SalesLineArchToBeProcessedTmp2.Quantity);
                NewSalesLine.VALIDATE("Unit Price",SalesLineArchToBeProcessedTmp2."Unit Price");
                NewSalesLine.VALIDATE("Line Discount %",SalesLineArchToBeProcessedTmp2."Line Discount %");
                NewSalesLine.VALIDATE("Inv. Discount Amount",SalesLineArchToBeProcessedTmp2."Inv. Discount Amount");
                NewSalesLine."Gen. Bus. Posting Group"        := SalesLineArchToBeProcessedTmp2."Gen. Bus. Posting Group";
                NewSalesLine."VAT Bus. Posting Group"         := SalesLineArchToBeProcessedTmp2."VAT Bus. Posting Group";
                NewSalesLine."Return Type"                    := SalesLineArchToBeProcessedTmp2."Return Type";
                NewSalesLine."Customer Prevention"            := SalesLineArchToBeProcessedTmp2."Customer Prevention";
                //T0016 02.07.14 tec-cs +++++++++++++++++++++++++++++
                NewSalesLine."Prevention discount (%)"        := SalesLineArchToBeProcessedTmp2."Prevention discount (%)";
                //T0016 02.07.14 tec-cs -----------------------------
                NewSalesLine."Prevention discount Amount"     := SalesLineArchToBeProcessedTmp2."Prevention discount Amount";
                NewSalesLine."Return Reason Code"             := SalesLineArchToBeProcessedTmp2."Return Reason Code";
                NewSalesLine."Transp. Type"                   := SalesLineArchToBeProcessedTmp2."Transp. Type";
                NewSalesLine."Linked to Sales Order No."      := SalesLineArchToBeProcessedTmp2."Document No.";
                NewSalesLine."Linked to Sales Order Line No." := SalesLineArchToBeProcessedTmp2."Line No.";

                //H1202, H1184 04.06.14 HCN +++++++++++++++++++++++++++++
                NewSalesLine."Status Return Order"            := NewSalesLine."Status Return Order"::open;
                NewSalesLine.ID                               := SalesLineArchToBeProcessedTmp2.ID;
                //H1202, H1184 04.06.14 HCN -----------------------------

                //H4307 26.06.2015 gob-dah ++++++++++++++++++++++++++
                AppliedFromItemEntry := GetShippedItemLedgerEntry(NewSalesLine."Linked to Sales Order No.",
                                                                  NewSalesLine."Linked to Sales Order Line No.",
                                                                  NewSalesLine."No.");
                NewSalesLine.VALIDATE("Appl.-from Item Entry",AppliedFromItemEntry);
                //H4307 26.06.2015 gob-dah --------------------------

                //H1389 11.08.14 MSL +++++++++++++++++++++++++++++
                eBayNavCWebshopItemL.GET(FORMAT(NewSalesHeader."Website No."),SalesLineArchToBeProcessedTmp2."No.");
                ReturnShippingAgentsSetupL.SETCURRENTKEY(Priority);
                ReturnShippingAgentsSetupL.SETRANGE("Website No.",NewSalesHeader."Website No.");
                ReturnShippingAgentsSetupL.SETRANGE("Transp. Type",SalesLineArchToBeProcessedTmp2."Transp. Type");
                ReturnShippingAgentsSetupL.SETRANGE("Shipping Agent Code",eBayNavCWebshopItemL."Shipping Agent Code");
                IF ReturnShippingAgentsSetupL.FINDFIRST THEN
                  NewSalesLine."Shipping Agent Code" := eBayNavCWebshopItemL."Shipping Agent Code"
                ELSE BEGIN
                  ReturnShippingAgentsSetupL.SETRANGE("Shipping Agent Code");
                  IF ReturnShippingAgentsSetupL.FINDLAST THEN
                    NewSalesLine."Shipping Agent Code" := ReturnShippingAgentsSetupL."Shipping Agent Code";
                END;
                //H1389 11.08.14 MSL -----------------------------

                CreateDocDimForSalesLineArch(NewSalesLine,SalesLineArchToBeProcessedTmp2);
                NewSalesLine.MODIFY;
                //T0062 24.10.14  tec-sh++++++++++++++
                MPCommissionMgt.InsertModifyMPCommissionLine(NewSalesLine);
                //T0062 24.10.14  tec-sh--------------
                //H1390 21.08.14 MSL +++++++++++++++++++++++++++++
                NewSalesHeader.ConsolidateShippingAgent;
                //H1390 21.08.14 MSL -----------------------------
                // H1241       12.09.14  JM ++++++++++++++++++++++
                InvH24Mgt.CreateDunningEntry(NewSalesLine);
                // H1241       12.09.14  JM ----------------------

                locCancRetOrderHistory.INIT;
                locCancRetOrderHistory."Entry No."                    := NextEntryNo;
                locCancRetOrderHistory."Document Type"                := locCancRetOrderHistory."Document Type"::"Return Order";
                locCancRetOrderHistory."Document No."                 := NewSalesLine."Document No.";
                locCancRetOrderHistory."Line No."                     := NewSalesLine."Line No.";
                locCancRetOrderHistory."Return Type"                  := SalesLineArchToBeProcessedTmp2."Return Type";
                locCancRetOrderHistory.Type                           := SalesLineArchToBeProcessedTmp2.Type;
                locCancRetOrderHistory."No."                          := SalesLineArchToBeProcessedTmp2."No.";
                locCancRetOrderHistory.Amount                         := ABS(SalesLineArchToBeProcessedTmp2."Line Amount" -
                                                                             SalesLineArchToBeProcessedTmp2."Inv. Discount Amount");
                locCancRetOrderHistory."Related to Document Type"     :=
                  locCancRetOrderHistory."Related to Document Type"::"Archiv. Order";
                locCancRetOrderHistory."Related to Document No."      := SalesLineArchToBeProcessedTmp2."Document No.";
                locCancRetOrderHistory."Related to Document Line No." := SalesLineArchToBeProcessedTmp2."Line No.";
                locCancRetOrderHistory."Date/Time" := CURRENTDATETIME;
                locCancRetOrderHistory."User ID" := USERID;
                locCancRetOrderHistory.INSERT;

                CASE NewSalesLine."Return Type" OF
                  NewSalesLine."Return Type"::Return:
                    BEGIN
                      IF (NewSalesLine."Customer Prevention" = NewSalesLine."Customer Prevention"::Accepted) THEN BEGIN
                        // Prevention after shipment
                        CalcPreventionDiscountLine(NewSalesLine,
                                                   SalesLineArchToBeProcessedTmp2."Document No.",
                                                   SalesLineArchToBeProcessedTmp2."Line No.");
                        ClearSalesAmount(NewSalesLine);
                        logOrderStatusLog.CreateOrderStatus(0,
                                                            SalesLineArchToBeProcessedTmp2."Document No.",
                                                            SalesLineArchToBeProcessedTmp2."Line No.",
                                                            '50',
                                                            STRSUBSTNO(LineStatus004,NewSalesHeader."No."));
                      END ELSE BEGIN
                        IF (NewSalesLine."Customer Prevention" = NewSalesLine."Customer Prevention"::Declined) OR
                           (NewSalesLine."Customer Prevention" = NewSalesLine."Customer Prevention"::"Not offered")
                        THEN BEGIN
                          // Return
                          CopyArchItemChargeToReturnOrd(SalesLineArchToBeProcessedTmp2,NewSalesLine);

                          logOrderStatusLog.CreateOrderStatus(0,
                                                              SalesLineArchToBeProcessedTmp2."Document No.",
                                                              SalesLineArchToBeProcessedTmp2."Line No.",
                                                              '50',
                                                              STRSUBSTNO(LineStatus001,NewSalesHeader."No."));
                        END;
                      END;
                    END;

                  NewSalesLine."Return Type"::Change:
                    BEGIN
                      IF (NewSalesLine."Customer Prevention" = NewSalesLine."Customer Prevention"::Accepted) THEN BEGIN
                        CalcPreventionDiscountLine(NewSalesLine,
                                                   SalesLineArchToBeProcessedTmp2."Document No.",
                                                   SalesLineArchToBeProcessedTmp2."Line No.");
                        ClearSalesAmount(NewSalesLine);
                        //H1202 04.06.14 HCN +++++++++++++++++++++++++++++
                        CopyArchItemChargeToReturnOrd(SalesLineArchToBeProcessedTmp2,NewSalesLine);
                        //H1202 04.06.14 HCN -----------------------------
                        logOrderStatusLog.CreateOrderStatus(0,
                                                            SalesLineToBeProcessedTmp2."Document No.",
                                                            SalesLineToBeProcessedTmp2."Line No.",'60',
                                                            STRSUBSTNO(LineStatus004,NewSalesHeader."No."));
                      END ELSE BEGIN
                        //H1202 04.06.14 HCN +++++++++++++++++++++++++++++
                        IF (NewSalesLine."Customer Prevention" = NewSalesLine."Customer Prevention"::Declined) OR
                           (NewSalesLine."Customer Prevention" = NewSalesLine."Customer Prevention"::"Not offered")
                        THEN BEGIN
                        //H1202 04.06.14 HCN -----------------------------
                          CopyArchItemChargeToReturnOrd(SalesLineArchToBeProcessedTmp2,NewSalesLine);
                          logOrderStatusLog.CreateOrderStatus(0,
                                                              SalesLineToBeProcessedTmp2."Document No.",
                                                              SalesLineToBeProcessedTmp2."Line No.",
                                                              '60',
                                                              STRSUBSTNO(LineStatus005,NewSalesHeader."No."));
                        END;
                      END;
                    END;
                  //H1472 29.09.14 rst +++++++++++++++++++++++++++++++++++
                  {
                  NewSalesLine."Return Type"::"Spare Part":
                    BEGIN
                      IF (NewSalesLine."Customer Prevention" = NewSalesLine."Customer Prevention"::Accepted) THEN BEGIN
                        CalcPreventionDiscountLine(NewSalesLine,
                                                   SalesLineArchToBeProcessedTmp2."Document No.",
                                                   SalesLineArchToBeProcessedTmp2."Line No.");
                        ClearSalesAmount(NewSalesLine);
                        logOrderStatusLog.CreateOrderStatus(0,
                                                            SalesLineToBeProcessedTmp2."Document No.",
                                                            SalesLineToBeProcessedTmp2."Line No.",
                                                            '80',
                                                            STRSUBSTNO(LineStatus004,NewSalesHeader."No."));
                      END ELSE BEGIN
                        //H1202 04.06.14 HCN +++++++++++++++++++++++++++++
                        IF (NewSalesLine."Customer Prevention" = NewSalesLine."Customer Prevention"::Declined) OR
                           (NewSalesLine."Customer Prevention" = NewSalesLine."Customer Prevention"::"Not offered")
                        THEN BEGIN
                        //H1202 04.06.14 HCN -----------------------------
                          logOrderStatusLog.CreateOrderStatus(0,
                                                              SalesLineToBeProcessedTmp2."Document No.",
                                                              SalesLineToBeProcessedTmp2."Line No.",
                                                              '80',
                                                              STRSUBSTNO(LineStatus006,NewSalesHeader."No."));
                        END;
                      END;
                    END;
                   }
                  //H1472 29.09.14 rst ----------------------------------------
                END;  // CASE NewSalesLine."Return Type" OF

                //H1202 04.06.14 HCN +++++++++++++++++++++++++++++
                IF (NewSalesLine."Return Type" IN [NewSalesLine."Return Type"::Return,
                                                   NewSalesLine."Return Type"::Change])
                THEN BEGIN
                  CheckCopyResourceToReturnOrder(SalesHeaderRecRefV,
                                                 NewSalesHeader,
                                                 NewSalesLine,
                                                 parReturnType);
                END;
                //H1202 04.06.14 HCN -----------------------------

                //T0060 19.02.15 CC-GH +++++++++++++++++++++++++++++++++++++++++++++++++++
                MPDocumentMgtL.CheckCopyMPChargeToReturnOrder(SalesHeaderRecRefV,
                  SalesLineToBeProcessedTmp2,
                  SalesLineArchToBeProcessedTmp2,
                  NewSalesHeader,
                  NewSalesLine,
                  parReturnType);
                //T0060 19.02.15 CC-GH ---------------------------------------------------

              UNTIL SalesLineArchToBeProcessedTmp2.NEXT = 0;
              //H1472 29.09.14 rst +++++++++++++++++++++++++++++++++++
              END;
              //H1472 29.09.14 rst ----------------------------------------
              CheckRessourceToReturnOrder(SalesHeaderRecRefV,NewSalesHeader,locLineno);
              SetReturnTypeSourceDoc(SalesHeaderRecRefV);

              IF IsPreventionAfterShipmentL THEN BEGIN
                DisplayMessage(TextHME013,1,NewSalesHeader."No.",'','');
              END ELSE BEGIN
              //H1472 30.10.14 rst ++++++++++++++++++++++++++++++++++
                IF parReturnType = 3 THEN BEGIN // Spare Part
                  IF CountSalesLinesL = 1 THEN BEGIN
                    DisplayMessage(TextHME052,1,NewSalesHeader."No.",'','');
                  END ELSE BEGIN
                    DisplayMessage(TextHME053,1,FORMAT(CountSalesLinesL),'','');
                  END;
                END ELSE BEGIN
                //H1472 30.10.14 rst ----------------------------------
                  DisplayMessage(Message001,1,NewSalesHeader."No.",'','');
                //H1472 30.10.14 rst ++++++++++++++++++++++++++++++++++
                END;
                //H1472 30.10.14 rst ----------------------------------
              END;
            END;  // IF SalesLineArchToBeProcessedTmp2.FIND('-') THEN BEGIN


          END;  // DATABASE::"Sales Line Archive":  BEGIN

      END; // CASE parRecRef.NUMBER OF

      //T0012 18.06.14 tec-sf +++++++++++++++++++++++++++++
      CreateReturnOrderNo := NewSalesHeader."No.";
      //T0012 18.06.14 tec-sf -----------------------------
    END;

    PROCEDURE CheckReturnOrderLines@1108200014(parOrderNo@1108200001 : Code[20];parOrderType@1108200000 : 'SalesOrder,SalesOrderArchive');
    VAR
      locSalesHeader@1108200002 : Record 36;
      locSalesLine@1108200003 : Record 37;
      locSalesHeaderArch@1108200004 : Record 5107;
      locSalesLineArch@1108200005 : Record 5108;
      locCheckReturnOrder@1108200006 : Record 37;
      locRecRef@1000000000 : RecordRef;
      "***HME************************"@1000000009 : Integer;
      ReturnOrderHeaderL@1000000012 : Record 36;
      SalesLineL@1000000011 : Record 37;
      POCancInquiry_FunctionsL@1000000010 : Codeunit 50146;
      SalesHeaderRecRefL@1000000014 : RecordRef;
      SalesLineRecRefL@1000000001 : RecordRef;
    BEGIN
      // CheckReturnOrderLines
      CLEAR(locSalesHeader);
      CLEAR(locSalesHeaderArch);
      CLEAR(locSalesLine);
      CLEAR(locSalesLineArch);
      CASE parOrderType OF
        parOrderType::SalesOrder:
          BEGIN
            locSalesHeader.RESET;
            locSalesHeader.SETRANGE("Document Type",locSalesHeader."Document Type"::Order);
            locSalesHeader.SETRANGE("No.", parOrderNo);
            IF locSalesHeader.FINDFIRST THEN BEGIN
              SalesHeaderRecRefL.GETTABLE(locSalesHeader);
              locSalesLine.RESET;
              locSalesLine.SETCURRENTKEY("Return Type");
              locSalesLine.SETRANGE("Document Type",locSalesLine."Document Type"::Order);
              locSalesLine.SETRANGE("Document No.",parOrderNo);
              locSalesLine.SETRANGE(Type,locSalesLine.Type::Item);
              //H0587 12.05.14 HCN +++++++++++++++++++++++++++++
              CASE DoCancelWhat OF
                DoCancelWhat::" ":
                  BEGIN
                    locSalesLine.SETFILTER("Return Type",'<>%1',locSalesLine."Return Type"::" ");
                  END;
                DoCancelWhat::CancelLine,
                DoCancelWhat::CancelOrder:
                  BEGIN
                    locSalesLine.SETRANGE("Return Type",locSalesLine."Return Type"::Cancelation);
                    locSalesLine.SETFILTER("Customer Prevention",'%1|%2',
                                           locSalesLine."Customer Prevention"::"Not offered",
                                           locSalesLine."Customer Prevention"::Declined);
                    IF (DoCancelWhat = DoCancelWhat::CancelLine) THEN BEGIN
                      locSalesLine.SETRANGE("Line No.",SalesLineToBeCancelled."Line No.");
                    END;
                  END;
              END;
              //H0587 12.05.14 HCN -----------------------------
              IF locSalesLine.FIND('-') THEN BEGIN
                GetSalesHeader(locSalesLine);
                DetermineCancellationCase();
                REPEAT
                  DoProcessCurrentLine := TRUE;
                  SalesLineRecRefL.GETTABLE(locSalesLine);
                  CheckExistingCrMemo(SalesHeaderRecRefL,SalesLineRecRefL);

                  // Verify fields in Sales Line
                  IF POCancInquiry_FunctionsL.GetUnpostedReturnOrder(SalesLineRecRefL,ReturnOrderHeaderL) THEN BEGIN
                    DisplayMessage(TextHME035,1,FORMAT(locSalesLine."Line No."),ReturnOrderHeaderL."No.",'');
                    DoProcessCurrentLine := FALSE;
                  END;

                  IF locSalesLine."Return Reason Code" = '' THEN BEGIN
                    DisplayMessage(TextHME036,1,FORMAT(locSalesLine."Line No."),'','');
                    DoProcessCurrentLine := FALSE;
                  END;

                  IF locSalesLine."Customer Prevention" = locSalesLine."Customer Prevention"::" " THEN BEGIN
                    DisplayMessage(TextHME037,2,
                                   locSalesLine.FIELDCAPTION("Customer Prevention"),
                                   FORMAT(locSalesLine."Line No."),'');
                    DoProcessCurrentLine := FALSE;
                  END;

                  IF (locSalesLine."Customer Prevention" = locSalesLine."Customer Prevention"::Offered)
                  THEN BEGIN
                    DisplayMessage(TextHME011,2,
                                   locSalesLine.FIELDCAPTION("Customer Prevention"),
                                   FORMAT(locSalesLine."Line No."),'');
                    DoProcessCurrentLine := FALSE;
                  END;

                  CASE locSalesLine."Return Type" OF
                    locSalesLine."Return Type"::Return:
                      BEGIN
                        IF (locSalesLine."Quantity Shipped" = 0) THEN BEGIN
                          DisplayMessage(TextHME040,2,
                                         locSalesLine."Document No.",
                                         FORMAT(locSalesLine."Line No."),'');
                          DoProcessCurrentLine := FALSE;
                        END;
                      END;


                    locSalesLine."Return Type"::Cancelation:
                      BEGIN
                        IF (locSalesLine."Quantity Shipped" > 0) THEN BEGIN
                          DisplayMessage(TextHME041,2,
                                         locSalesLine."Document No.",
                                         FORMAT(locSalesLine."Line No."),'');
                          DoProcessCurrentLine := FALSE;
                        END;

                        //H0584 06.05.14 HCN +++++++++++++++++++++++++++++
                        // sales lines must not be set to "Status Return Order"::Requested
                        IF (locSalesLine."Status Return Order" IN [locSalesLine."Status Return Order"::requested])
                        THEN BEGIN
                          CLEAR(SalesLineL);
                          SalesLineL."Status Return Order" := locSalesLine."Status Return Order";
                          DisplayMessage(TextHME023,3,
                                         FORMAT(locSalesLine."Line No."),
                                         locSalesLine.FIELDCAPTION("Status Return Order"),
                                         FORMAT(SalesLineL."Status Return Order"));
                          DoProcessCurrentLine := FALSE;
                        END;
                        //H0584 06.05.14 HCN -----------------------------

                        //H0587 01.04.14 HCN +++++++++++++++++++++++++++++
                        IF (locSalesLine."Customer Prevention" = locSalesLine."Customer Prevention"::"Not offered") OR
                           (locSalesLine."Customer Prevention" = locSalesLine."Customer Prevention"::Declined)
                        THEN BEGIN
                          CheckSalesLineToBeCancelled(locSalesLine);
                        END;
                        //H0587 01.04.14 HCN -----------------------------

                        //H0584, H0587 20.06.14 HCN +++++++++++++++++++++++++++++
                          IF (locSalesLine."Customer Prevention" = locSalesLine."Customer Prevention"::Accepted)
                          THEN BEGIN
                            IF CheckIPLcancelled(locSalesLine."Document No.",locSalesLine."Line No.") THEN BEGIN
                              IF NOT CheckItemChargeAssignment(locSalesLine) THEN BEGIN
                                DisplayMessage(TextHME012,1,
                                               FORMAT(locSalesLine."Line No."),'','');
                                DoProcessCurrentLine := FALSE;
                              END;
                            END ELSE BEGIN
                              DisplayMessage(TextHME014,1,
                                             FORMAT(locSalesLine."Line No."),'','');
                              DoProcessCurrentLine := FALSE;
                            END;
                          END;
                        //H0584, H0587 20.06.14 HCN -----------------------------

                      END;

                    locSalesLine."Return Type"::Change:
                      BEGIN
                        IF (locSalesLine."Customer Prevention" = locSalesLine."Customer Prevention"::Accepted) THEN BEGIN
                          DisplayMessage(TextHME009,2,
                                         locSalesLine.FIELDCAPTION("Customer Prevention"),
                                         FORMAT(locSalesLine."Line No."),'');
                          DoProcessCurrentLine := FALSE;
                        END;
                        IF (locSalesLine."Quantity Shipped" = 0) THEN BEGIN
                          DisplayMessage(TextHME040,2,
                                         locSalesLine."Document No.",
                                         FORMAT(locSalesLine."Line No."),'');
                          DoProcessCurrentLine := FALSE;
                        END;
                      END;

                    locSalesLine."Return Type"::"Spare Part":
                      BEGIN
                        IF (locSalesLine."Customer Prevention" = locSalesLine."Customer Prevention"::Accepted) THEN BEGIN
                          DisplayMessage(TextHME010,2,
                                         locSalesLine.FIELDCAPTION("Customer Prevention"),
                                         FORMAT(locSalesLine."Line No."),'');
                          DoProcessCurrentLine := FALSE;
                        END;
                        IF (locSalesLine."Quantity Shipped" = 0) THEN BEGIN
                          DisplayMessage(TextHME042,2,
                                         locSalesLine."Document No.",
                                         FORMAT(locSalesLine."Line No."),'');
                          DoProcessCurrentLine := FALSE;
                        END;
                      END;
                  END;  // CASE locSalesLine."Return Type" OF

                  IF (locSalesLine."Customer Prevention" = locSalesLine."Customer Prevention"::Accepted)
                  THEN BEGIN
                    //T0016 02.07.14 tec-cs +++++++++++++++++++++++++++++
                    IF (locSalesLine."Prevention discount (%)" = 0) AND
                       (locSalesLine."Prevention discount Amount" = 0)
                    //T0016 02.07.14 tec-cs -----------------------------
                    THEN BEGIN
                      DisplayMessage(TextHME038,1,
                                     FORMAT(locSalesLine."Line No."),'','');
                      DoProcessCurrentLine := FALSE;
                    END;
                  END;


                  IF DoProcessCurrentLine THEN BEGIN
                    SalesLineRecRef.GETTABLE(locSalesLine);
                    InsertTemporarySalesLine()
                  END;

                UNTIL locSalesLine.NEXT = 0;
              END;  // IF locSalesLine.FIND('-') THEN BEGIN
            END;  // IF locSalesHeader.FINDFIRST THEN BEGIN
          END;  // parOrderType::SalesOrder: BEGIN

        parOrderType::SalesOrderArchive:
          BEGIN
            locSalesHeaderArch.RESET;
            locSalesHeaderArch.SETRANGE("Document Type",locSalesHeaderArch."Document Type"::Order);
            locSalesHeaderArch.SETRANGE("No.",parOrderNo);
            IF locSalesHeaderArch.FINDLAST THEN BEGIN
              SalesHeaderRecRefL.GETTABLE(locSalesHeaderArch);
              locSalesLineArch.RESET;
              locSalesLineArch.SETCURRENTKEY("Return Type");
              locSalesLineArch.SETRANGE("Document Type",locSalesHeaderArch."Document Type"::Order);
              locSalesLineArch.SETRANGE("Document No.",locSalesHeaderArch."No.");
              locSalesLineArch.SETRANGE("Version No.",locSalesHeaderArch."Version No.");
              locSalesLineArch.SETRANGE("Doc. No. Occurrence",locSalesHeaderArch."Doc. No. Occurrence");
              locSalesLineArch.SETRANGE(Type,locSalesLineArch.Type::Item);
              locSalesLineArch.SETFILTER("Return Type",'<>%1',locSalesLineArch."Return Type"::" ");
              IF locSalesLineArch.FIND('-') THEN BEGIN
                GetSalesHeaderArchive(locSalesLineArch);
                REPEAT
                  DoProcessCurrentLine := TRUE;
                  SalesLineRecRefL.GETTABLE(locSalesLineArch);
                  CheckExistingCrMemo(SalesHeaderRecRefL,SalesLineRecRefL);

                  // Pr¬Åfungen auf Felder in Verkaufszeile
                  IF POCancInquiry_FunctionsL.GetUnpostedReturnOrder(SalesLineRecRefL,ReturnOrderHeaderL) THEN BEGIN
                    DisplayMessage(TextHME035,2,
                                   FORMAT(locSalesLineArch."Line No."),
                                   ReturnOrderHeaderL."No.",'');
                    DoProcessCurrentLine := FALSE;
                  END;

                  IF locSalesLineArch."Return Reason Code" = '' THEN BEGIN
                    DisplayMessage(TextHME036,1,FORMAT(locSalesLineArch."Line No."),'','');
                    DoProcessCurrentLine := FALSE;
                  END;

                  IF locSalesLineArch."Customer Prevention" = locSalesLineArch."Customer Prevention"::" " THEN BEGIN
                    DisplayMessage(TextHME037,2,
                                   locSalesLine.FIELDCAPTION("Customer Prevention"),
                                   FORMAT(locSalesLineArch."Line No."),'');
                    DoProcessCurrentLine := FALSE;
                  END;

                  IF (locSalesLineArch."Customer Prevention" = locSalesLineArch."Customer Prevention"::Accepted)
                  THEN BEGIN
                    //T0016 02.07.14 tec-cs +++++++++++++++++++++++++++++
                    IF (locSalesLineArch."Prevention discount (%)" = 0) AND
                       (locSalesLineArch."Prevention discount Amount" = 0)
                    //T0016 02.07.14 tec-cs -----------------------------
                    THEN BEGIN
                    DisplayMessage(TextHME038,1,FORMAT(locSalesLineArch."Line No."),'','');
                      DoProcessCurrentLine := FALSE;
                    END;
                  END;

                  IF (locSalesLineArch."Customer Prevention" = locSalesLineArch."Customer Prevention"::Offered)
                  THEN BEGIN
                    DisplayMessage(TextHME011,2,
                                   locSalesLine.FIELDCAPTION("Customer Prevention"),
                                   FORMAT(locSalesLineArch."Line No."),'');
                    DoProcessCurrentLine := FALSE;
                  END;

                  CASE locSalesLineArch."Return Type" OF
                    locSalesLineArch."Return Type"::Return:
                      BEGIN
                        IF (locSalesLineArch."Customer Prevention" IN [locSalesLineArch."Customer Prevention"::" ",
                                                                       locSalesLineArch."Customer Prevention"::Offered])
                        THEN BEGIN
                          DisplayMessage(TextHME007,2,
                                         locSalesLine.FIELDCAPTION("Customer Prevention"),
                                         FORMAT(locSalesLineArch."Line No."),'');
                          DoProcessCurrentLine := FALSE;
                        END;
                      END;

                    locSalesLineArch."Return Type"::Cancelation:
                      BEGIN
                        DoProcessCurrentLine := FALSE;
                      END;

                    locSalesLineArch."Return Type"::Change:
                      BEGIN
                        IF (locSalesLineArch."Customer Prevention" = locSalesLineArch."Customer Prevention"::Accepted) THEN BEGIN
                          DisplayMessage(TextHME009,2,
                                         locSalesLine.FIELDCAPTION("Customer Prevention"),
                                         FORMAT(locSalesLineArch."Line No."),'');
                          DoProcessCurrentLine := FALSE;
                        END;
                      END;

                    locSalesLineArch."Return Type"::"Spare Part":
                      BEGIN
                      END;
                  END;  // CASE locSalesLineArch."Return Type" OF

                  IF DoProcessCurrentLine THEN BEGIN
                    SalesLineRecRef.GETTABLE(locSalesLineArch);
                    InsertTemporarySalesLine()
                  END;
                UNTIL locSalesLineArch.NEXT = 0;
              END;  // IF locSalesLineArch.FIND('-') THEN BEGIN
            END;  // IF locSalesHeaderArch.FINDLAST THEN BEGIN
          END;  // parOrderType::SalesOrderArchive: BEGIN
      END;  // CASE parOrderType OF
    END;

    PROCEDURE InsertItemChargeDimension@1108200010(parItemChargeLine@1108200000 : Record 37;parSalesLine@1108200003 : Record 37);
    VAR
      locDocumentDimension@1108200001 : Record 357;
      locGLSetup@1108200002 : Record 98;
    BEGIN
      //A/P0011
      CLEAR(locDocumentDimension);
      CLEAR(locGLSetup);

      locGLSetup.GET();
      locGLSetup.TESTFIELD(locGLSetup."Global Dimension 2 Code");

      locDocumentDimension.RESET;
      locDocumentDimension.SETRANGE("Table ID",37);
      locDocumentDimension.SETRANGE("Document Type",parItemChargeLine."Document Type");
      locDocumentDimension.SETRANGE("Document No.",parItemChargeLine."Document No.");
      locDocumentDimension.SETRANGE("Line No.",parItemChargeLine."Line No.");
      locDocumentDimension.SETRANGE("Dimension Code",locGLSetup."Global Dimension 2 Code");
      IF locDocumentDimension.ISEMPTY THEN BEGIN
        locDocumentDimension.INIT;
        locDocumentDimension."Table ID" := 37;
        locDocumentDimension."Document Type" := parItemChargeLine."Document Type";
        locDocumentDimension."Document No." := parItemChargeLine."Document No.";
        locDocumentDimension."Line No." := parItemChargeLine."Line No.";
        locDocumentDimension."Dimension Code" := locGLSetup."Global Dimension 2 Code";
        locDocumentDimension."Dimension Value Code" := parSalesLine."No.";
        locDocumentDimension.INSERT;
      END;
      //E/P0011
    END;

    PROCEDURE ClearSalesAmount@1108200011(VAR parSalesLine@1108200000 : Record 37);
    BEGIN
      //A/P0011
      parSalesLine.Quantity := 0;
      parSalesLine."Qty. to Invoice" := 0;
      parSalesLine."Qty. to Ship" := 0;
      parSalesLine."Qty. to Invoice (Base)" := 0;
      parSalesLine."Qty. to Ship (Base)" := 0;
      parSalesLine."Unit Price" := 0;
      parSalesLine."Line Amount" := 0;
      //A/P0862
      parSalesLine."Line Discount %" := 0;
      parSalesLine."Line Discount Amount" := 0;
      parSalesLine."Inv. Discount Amount" := 0;
      //E/P0862
      parSalesLine.Amount := 0;
      parSalesLine."Amount Including VAT" := 0;
      parSalesLine."Outstanding Amount" := 0;
      parSalesLine."Outstanding Quantity" := 0;
      parSalesLine."Outstanding Amount (LCY)" := 0;
      parSalesLine."Quantity (Base)":= 0;
      parSalesLine."Outstanding Qty. (Base)":= 0;
      parSalesLine.MODIFY;
      //E/P0011
    END;

    PROCEDURE CheckLinkedRessoruce@1108200013(parSalesLineArch@1108200000 : Record 5108) : Boolean;
    VAR
      locSalesLineArch@1108200001 : Record 5108;
    BEGIN
      //A/P0011

      CLEAR(locSalesLineArch);

      locSalesLineArch.SETRANGE("Document Type",parSalesLineArch."Document Type");
      locSalesLineArch.SETRANGE("Document No.",parSalesLineArch."Document No.");
      locSalesLineArch.SETRANGE("Doc. No. Occurrence",parSalesLineArch."Doc. No. Occurrence");
      locSalesLineArch.SETRANGE("Version No.",parSalesLineArch."Version No.");
      locSalesLineArch.SETRANGE("Parent ID",parSalesLineArch.ID);
      IF locSalesLineArch.FINDFIRST THEN
        IF parSalesLineArch.ID <> 0 THEN
          IF locSalesLineArch."Return Type" <> parSalesLineArch."Return Type" THEN
            EXIT(TRUE)
          ELSE
            EXIT(FALSE);
      //E/P0011
    END;

    PROCEDURE CheckRessourceToReturnOrder@1108200016(parRecRef@1108200000 : RecordRef;parReturnHeader@1108200006 : Record 36;parLineNo@1108200007 : Integer);
    VAR
      locSalesLine@1108200001 : Record 37;
      locSalesLineArch@1108200002 : Record 5108;
      locSalesHeader@1108200003 : Record 36;
      locSalesHeaderArch@1108200004 : Record 5107;
      locRecRef@1108200005 : RecordRef;
      NewSalesLine@1108200008 : Record 37;
      locRecRef2@1108200009 : RecordRef;
      FPCSetup@1000000000 : Record 50055;
    BEGIN
      // CheckRessourceToReturnOrder
      FPCSetup.GET();

      // Besteht eine Reklamation nur aus nachtr‚Äûglichen Rabatten / Kulanzen
      // werden keine Ressourcen aus dem urspr. Auftrag ¬Åbertragen.
      locSalesLine.RESET;
      locSalesLine.SETRANGE("Document Type",parReturnHeader."Document Type");
      locSalesLine.SETRANGE("Document No.",parReturnHeader."No.");
      locSalesLine.SETRANGE(Type,locSalesLine.Type::Item);
      locSalesLine.SETRANGE(Quantity,1);
      IF locSalesLine.ISEMPTY THEN
        EXIT;

      // Pr¬Åfung auf K‚Äûuferschutz
      IF FPCSetup."Trusted Shop to Return Order" THEN BEGIN
        CASE parRecRef.NUMBER OF
          36:
            BEGIN
              parRecRef.SETTABLE(locSalesHeader);
              locSalesLine.SETRANGE("Document Type",locSalesHeader."Document Type");
              locSalesLine.SETRANGE("Document No.",locSalesHeader."No.");
              locSalesLine.SETRANGE(Type,locSalesLine.Type::Resource);
              locSalesLine.SETRANGE("Resource Type",locSalesLine."Resource Type"::"Trusted Shop");
              IF locSalesLine.FIND('-') THEN BEGIN
                REPEAT
                  IF CheckCompleteReturnOrder(parRecRef) THEN BEGIN
                    locRecRef2.GETTABLE(locSalesLine);
                    parLineNo += 10000;
                    CopyRessourceToReturnOrder(locRecRef2,parReturnHeader,parLineNo);
                  END;
                UNTIL locSalesLine.NEXT = 0;
              END;
            END;

          5107:
            BEGIN
              parRecRef.SETTABLE(locSalesHeaderArch);
              locSalesLineArch.SETRANGE("Document Type",locSalesHeaderArch."Document Type");
              locSalesLineArch.SETRANGE("Document No.",locSalesHeaderArch."No.");
              locSalesLineArch.SETRANGE("Doc. No. Occurrence",locSalesHeaderArch."Doc. No. Occurrence");
              locSalesLineArch.SETRANGE("Version No.",locSalesHeaderArch."Version No.");
              locSalesLineArch.SETRANGE(Type,locSalesLine.Type::Resource);
              locSalesLineArch.SETRANGE("Resource Type",locSalesLineArch."Resource Type"::"Trusted Shop");
              IF locSalesLineArch.FIND('-') THEN BEGIN
                REPEAT
                  IF CheckCompleteReturnOrder(parRecRef) THEN BEGIN
                    locRecRef2.GETTABLE(locSalesLineArch);
                    parLineNo += 10000;
                    CopyRessourceToReturnOrder(locRecRef2,parReturnHeader,parLineNo);
                  END;
                UNTIL locSalesLineArch.NEXT = 0;
              END;
            END;
        END;  //CASE parRecRef.NUMBER OF
      END;

      // Pr¬Åfung Rabattgutschein
      // Aktuell deaktiviert, da im Fall einer Retoure immer ausgezahlt werden soll
      IF FPCSetup."Credit Bon to Return Order" THEN BEGIN
        CASE parRecRef.NUMBER OF

          36:
            BEGIN
              parRecRef.SETTABLE(locSalesHeader);
              locSalesLine.SETRANGE("Document Type",locSalesHeader."Document Type");
              locSalesLine.SETRANGE("Document No.",locSalesHeader."No.");
              locSalesLine.SETRANGE("Resource Type",locSalesLine."Resource Type"::"Credit Bon");
              // locSalesLine.SETRANGE("Process Customer Complaint",TRUE);
              IF locSalesLine.FIND('-') THEN BEGIN
                REPEAT
                  locRecRef2.GETTABLE(locSalesLine);
                  parLineNo += 10000;
                  CopyRessourceToReturnOrder(locRecRef2,parReturnHeader,parLineNo);
                UNTIL locSalesLine.NEXT = 0;
              END;
            END;

          5107:
            BEGIN
              parRecRef.SETTABLE(locSalesHeaderArch);
              locSalesLineArch.SETRANGE("Document Type",locSalesHeaderArch."Document Type");
              locSalesLineArch.SETRANGE("Document No.",locSalesHeaderArch."No.");
              locSalesLineArch.SETRANGE("Doc. No. Occurrence",locSalesHeaderArch."Doc. No. Occurrence");
              locSalesLineArch.SETRANGE("Version No.",locSalesHeaderArch."Version No.");
              locSalesLineArch.SETRANGE("Resource Type",locSalesLineArch."Resource Type"::"Credit Bon");
              // locSalesLineArch.SETRANGE("Process Customer Complaint",TRUE);
              IF locSalesLineArch.FIND('-') THEN BEGIN
                REPEAT
                  locRecRef2.GETTABLE(locSalesLineArch);
                  parLineNo += 10000;
                  CopyRessourceToReturnOrder(locRecRef2,parReturnHeader,parLineNo);
                UNTIL locSalesLineArch.NEXT = 0;
              END;
            END;
        END;
      END;

      // Pr¬Åfung Geschenkgutschein
      IF FPCSetup."Sales Bon to Return Order" THEN BEGIN
        CASE parRecRef.NUMBER OF
          36:
            BEGIN
              parRecRef.SETTABLE(locSalesHeader);
              locSalesLine.SETRANGE("Document Type",locSalesHeader."Document Type");
              locSalesLine.SETRANGE("Document No.",locSalesHeader."No.");
              locSalesLine.SETRANGE("Resource Type",locSalesLine."Resource Type"::"Sales Bon");
              //locSalesLine.SETRANGE("Process Customer Complaint",TRUE);
              locSalesLine.SETRANGE(Type,locSalesLine.Type::Resource);
              IF locSalesLine.FIND('-') THEN BEGIN
                REPEAT
                  locRecRef2.GETTABLE(locSalesLine);
                  parLineNo += 10000;
                  CopyRessourceToReturnOrder(locRecRef2,parReturnHeader,parLineNo);
                UNTIL locSalesLine.NEXT = 0;
              END;
            END;

          5107:
            BEGIN
              parRecRef.SETTABLE(locSalesHeaderArch);
              locSalesLineArch.SETRANGE("Document Type",locSalesHeaderArch."Document Type");
              locSalesLineArch.SETRANGE("Document No.",locSalesHeaderArch."No.");
              locSalesLineArch.SETRANGE("Doc. No. Occurrence",locSalesHeaderArch."Doc. No. Occurrence");
              locSalesLineArch.SETRANGE("Version No.",locSalesHeaderArch."Version No.");
              locSalesLineArch.SETRANGE("Resource Type",locSalesLineArch."Resource Type"::"Sales Bon");
              locSalesLineArch.SETRANGE(Type,locSalesLine.Type::Resource);
              //locSalesLineArch.SETRANGE("Process Customer Complaint",TRUE);
              IF locSalesLineArch.FIND('-') THEN BEGIN
                REPEAT
                  locRecRef2.GETTABLE(locSalesLineArch);
                  parLineNo += 10000;
                  CopyRessourceToReturnOrder(locRecRef2,parReturnHeader,parLineNo);
                UNTIL locSalesLineArch.NEXT = 0;
              END;
            END;
        END;  // CASE parRecRef.NUMBER OF
      END;  // IF FPCSetup."Sales Bon to Return Order" THEN BEGIN
    END;

    PROCEDURE CheckCompleteReturnOrder@1108200018(parRecRef@1108200001 : RecordRef) : Boolean;
    VAR
      locSalesLine@1108200004 : Record 37;
      locSalesLineArch@1108200003 : Record 5108;
      locSalesHeader@1108200002 : Record 36;
      locSalesHeaderArch@1108200000 : Record 5107;
    BEGIN
      // CheckCompleteReturnOrder
      CASE parRecRef.NUMBER OF
        36:
          BEGIN
            CLEAR(SalesLineToBeProcessedTmp3);
            IF NOT SalesLineToBeProcessedTmp3.ISEMPTY THEN BEGIN
              EXIT(FALSE)
            END ELSE BEGIN
              EXIT(TRUE);
            END;
          END;

        5107:
          BEGIN
            CLEAR(SalesLineArchToBeProcessedTmp3);
            IF NOT SalesLineArchToBeProcessedTmp3.ISEMPTY THEN BEGIN
              EXIT(FALSE)
            END ELSE BEGIN
              EXIT(TRUE);
            END;
          END;
      END;
    END;

    PROCEDURE CopyRessourceToReturnOrder@1108200015(parRecRef@1108200000 : RecordRef;parReturnHeader@1108200003 : Record 36;parLineNo@1108200001 : Integer);
    VAR
      locSalesLine@1108200002 : Record 37;
      locSalesLineArch@1108200004 : Record 5108;
      NewSalesLine@1108200005 : Record 37;
      locUnitPrice@1108200006 : Decimal;
      locCancRetOrderHistory@1000000000 : Record 50037;
      NextEntryNo@1000000001 : Integer;
    BEGIN
      // CopyRessourceToReturnOrder
      IF locCancRetOrderHistory.FINDLAST THEN
        NextEntryNo := locCancRetOrderHistory."Entry No." + 1
      ELSE
        NextEntryNo := 1;

      CASE parRecRef.NUMBER OF
        37:
          BEGIN
            parRecRef.SETTABLE(locSalesLine);
            NewSalesLine.INIT;
            NewSalesLine."Document Type" := parReturnHeader."Document Type";
            NewSalesLine."Document No." := parReturnHeader."No.";
            NewSalesLine."Line No." := GetLineNo(NewSalesLine);
            NewSalesLine.INSERT(TRUE);
            NewSalesLine.VALIDATE("Sell-to Customer No.",parReturnHeader."Sell-to Customer No.");
            NewSalesLine.VALIDATE(Type,locSalesLine.Type);
            NewSalesLine.VALIDATE("No.",locSalesLine."No.");
            NewSalesLine.VALIDATE("Location Code",parReturnHeader."Location Code");
            NewSalesLine.VALIDATE(Quantity,locSalesLine.Quantity);
            locUnitPrice := locSalesLine."Amount Including VAT";
            IF (locSalesLine."Resource Type" = locSalesLine."Resource Type"::"Credit Bon") OR
               (locSalesLine."Resource Type" = locSalesLine."Resource Type"::"Sales Bon")
            THEN BEGIN
              CalcRessourceBonPrice(locSalesLine."Document No.",
                                    parReturnHeader."No.",
                                    locSalesLine."No.",
                                    locUnitPrice);
            END;
            NewSalesLine.VALIDATE("Unit Price",locUnitPrice);
            NewSalesLine.VALIDATE("Line Discount %",locSalesLine."Line Discount %");
            NewSalesLine."Return Type" := locSalesLine."Return Type";
            NewSalesLine."Customer Prevention" := locSalesLine."Customer Prevention";
            //T0016 02.07.14 tec-cs +++++++++++++++++++++++++++++
            NewSalesLine."Prevention discount (%)" := locSalesLine."Prevention discount (%)";
            //T0016 02.07.14 tec-cs -----------------------------
            NewSalesLine."Prevention discount Amount" := locSalesLine."Prevention discount Amount";
            NewSalesLine."Return Reason Code" := locSalesLine."Return Reason Code";
            NewSalesLine."Resource Type" := locSalesLine."Resource Type";
            NewSalesLine."Linked to Sales Order No." := locSalesLine."Document No.";
            NewSalesLine."Linked to Sales Order Line No." := locSalesLine."Line No.";

            //H1202 04.06.14 HCN +++++++++++++++++++++++++++++
            NewSalesLine."Parent ID" := locSalesLine."Parent ID";
            //H1202 04.06.14 HCN -----------------------------

            NewSalesLine.MODIFY;

            CreateDocDimForSalesLine(NewSalesLine,locSalesLine);

            locSalesLine.MODIFY;

            // Eintrag in History Tabelle erzeugen mit Gutscheinbetrag
            locCancRetOrderHistory.INIT;
            locCancRetOrderHistory."Entry No." := NextEntryNo;
            locCancRetOrderHistory."Document Type" := locCancRetOrderHistory."Document Type"::"Return Order";
            locCancRetOrderHistory."Document No." := NewSalesLine."Document No.";
            locCancRetOrderHistory."Line No." := NewSalesLine."Line No.";
            locCancRetOrderHistory."Return Type" := locSalesLine."Return Type";
            locCancRetOrderHistory.Type := locSalesLine.Type;
            locCancRetOrderHistory."No." := locSalesLine."No.";
            locCancRetOrderHistory.Amount := ABS(locUnitPrice);
            locCancRetOrderHistory."Related to Document Type" := locCancRetOrderHistory."Related to Document Type"::Order;
            locCancRetOrderHistory."Related to Document No." := locSalesLine."Document No.";
            locCancRetOrderHistory."Related to Document Line No." := locSalesLine."Line No.";
            locCancRetOrderHistory."Date/Time" := CURRENTDATETIME;
            locCancRetOrderHistory."User ID" := USERID;
            locCancRetOrderHistory.INSERT;

          END;

        5108:
          BEGIN
            parRecRef.SETTABLE(locSalesLineArch);
            NewSalesLine.INIT;
            NewSalesLine."Document Type" := parReturnHeader."Document Type";
            NewSalesLine."Document No." := parReturnHeader."No.";
            NewSalesLine."Line No." := GetLineNo(NewSalesLine);
            NewSalesLine.INSERT(TRUE);
            NewSalesLine.VALIDATE("Sell-to Customer No.",parReturnHeader."Sell-to Customer No.");
            NewSalesLine.VALIDATE(Type,locSalesLineArch.Type);
            NewSalesLine.VALIDATE("No.",locSalesLineArch."No.");
            NewSalesLine.VALIDATE("Location Code",parReturnHeader."Location Code");
            NewSalesLine.VALIDATE(Quantity,locSalesLineArch.Quantity);
            locUnitPrice := locSalesLineArch."Unit Price";
            IF (locSalesLineArch."Resource Type" = locSalesLineArch."Resource Type"::"Credit Bon") OR
               (locSalesLineArch."Resource Type" = locSalesLineArch."Resource Type"::"Sales Bon")
            THEN BEGIN
              CalcRessourceBonPrice(locSalesLineArch."Document No.",
                                    parReturnHeader."No.",
                                    locSalesLineArch."No.",
                                    locUnitPrice);
            END;
            NewSalesLine.VALIDATE("Unit Price",locUnitPrice);
            NewSalesLine.VALIDATE("Line Discount %",locSalesLineArch."Line Discount %");
            NewSalesLine."Return Type" := locSalesLineArch."Return Type";
            NewSalesLine."Customer Prevention" := locSalesLineArch."Customer Prevention";
            //T0016 02.07.14 tec-cs +++++++++++++++++++++++++++++
            NewSalesLine."Prevention discount (%)" := locSalesLineArch."Prevention discount (%)";
            //T0016 02.07.14 tec-cs -----------------------------
            NewSalesLine."Prevention discount Amount" := locSalesLineArch."Prevention discount Amount";
            NewSalesLine."Return Reason Code" := locSalesLineArch."Return Reason Code";
            NewSalesLine."Resource Type" := locSalesLineArch."Resource Type";
            //H1202 04.06.14 HCN +++++++++++++++++++++++++++++
            NewSalesLine."Linked to Sales Order No." := locSalesLineArch."Document No.";
            NewSalesLine."Linked to Sales Order Line No." := locSalesLineArch."Line No.";
            NewSalesLine."Parent ID" := locSalesLineArch."Parent ID";
            //H1202 04.06.14 HCN -----------------------------
            NewSalesLine.MODIFY;

            CreateDocDimForSalesLineArch(NewSalesLine,locSalesLineArch);

            // Eintrag in History Tabelle erzeugen mit Gutscheinbetrag
            locCancRetOrderHistory.INIT;
            locCancRetOrderHistory."Entry No." := NextEntryNo;
            locCancRetOrderHistory."Document Type" := locCancRetOrderHistory."Document Type"::"Return Order";
            locCancRetOrderHistory."Document No." := NewSalesLine."Document No.";
            locCancRetOrderHistory."Line No." := NewSalesLine."Line No.";
            locCancRetOrderHistory."Return Type" := locSalesLineArch."Return Type";
            locCancRetOrderHistory.Type := locSalesLineArch.Type;
            locCancRetOrderHistory."No." := locSalesLineArch."No.";
            locCancRetOrderHistory.Amount := locUnitPrice;
            locCancRetOrderHistory."Related to Document Type" := locCancRetOrderHistory."Related to Document Type"::"Archiv. Order";
            locCancRetOrderHistory."Related to Document No." := locSalesLineArch."Document No.";
            locCancRetOrderHistory."Related to Document Line No." := locSalesLineArch."Line No.";
            locCancRetOrderHistory."Date/Time" := CURRENTDATETIME;
            locCancRetOrderHistory."User ID" := USERID;
            locCancRetOrderHistory.INSERT;
          END;
      END;
    END;

    PROCEDURE SetReturnTypeSourceDoc@1108200020(parRecRef@1108200000 : RecordRef);
    VAR
      locSalesLine@1108200001 : Record 37;
      locSalesLineArch@1108200002 : Record 5108;
      locSalesHeader@1108200003 : Record 36;
      locSalesHeaderArch@1108200004 : Record 5107;
    BEGIN
      //A/P0011
      CLEAR(locSalesLine);
      CLEAR(locSalesLineArch);
      CLEAR(locSalesLine);
      CLEAR(locSalesLineArch);

      //A/P0128
      EXIT;
      //E/P0128

      CASE parRecRef.NUMBER OF
        36: BEGIN
          parRecRef.SETTABLE(locSalesHeader);
          locSalesLine.RESET;
          locSalesLine.SETRANGE("Document Type",locSalesHeader."Document Type");
          locSalesLine.SETRANGE("Document No.",locSalesHeader."No.");
          IF locSalesLine.FIND('-') THEN BEGIN
            REPEAT
              locSalesLine."Return Type" := locSalesLine."Return Type"::" ";
              locSalesLine.MODIFY;
            UNTIL locSalesLine.NEXT = 0;
          END;
        END;
        5107: BEGIN
          parRecRef.SETTABLE(locSalesHeaderArch);
          locSalesLineArch.RESET;
          locSalesLineArch.SETRANGE("Document Type",locSalesHeaderArch."Document Type");
          locSalesLineArch.SETRANGE("Document No.",locSalesHeaderArch."No.");
          IF locSalesLineArch.FIND('-') THEN BEGIN
            REPEAT
              locSalesLineArch."Return Type" := locSalesLineArch."Return Type"::" ";
              locSalesLineArch.MODIFY;
            UNTIL locSalesLineArch.NEXT = 0;
          END;
        END;
      END;

      //E/P0011
    END;

    PROCEDURE CalcRessourceBonPrice@1108200017(parOrderNo@1108200001 : Code[20];parReturnHeaderNo@1108200009 : Code[20];parResource@1108200002 : Code[20];VAR parUnitPrice@1108200000 : Decimal);
    VAR
      locCreditMemoHeader@1108200006 : Record 114;
      locCreditMemoLine@1108200004 : Record 115;
      locSalesHeader@1108200007 : Record 36;
      locSalesLine@1108200005 : Record 37;
      locCalcPrice@1108200003 : Decimal;
      locLineAmount@1108200008 : Decimal;
    BEGIN
      // CalcRessourceBonPrice
      //A/P0011
      CLEAR(locCreditMemoHeader);
      CLEAR(locCreditMemoLine);
      CLEAR(locSalesHeader);
      CLEAR(locSalesLine);
      CLEAR(locCalcPrice);

      // Rabattbetrag um gebuchte Gutschriften reduzieren
      locCreditMemoHeader.RESET;
      locCreditMemoHeader.SETCURRENTKEY("External Document No.");
      locCreditMemoHeader.SETRANGE("External Document No.",parOrderNo);
      IF locCreditMemoHeader.FIND('-') THEN BEGIN
        REPEAT
          locCreditMemoLine.SETRANGE("Document No.",locCreditMemoHeader."No.");
          locCreditMemoLine.SETRANGE(Type,locCreditMemoLine.Type::Resource);
          locCreditMemoLine.SETRANGE("No.",parResource);
          IF locCreditMemoLine.FIND('-') THEN BEGIN
            REPEAT
              // A/P0418
              // parUnitPrice -= locCreditMemoLine."Unit Price";
              parUnitPrice -= locCreditMemoLine."Amount Including VAT";
              // E/P0418
            UNTIL locCreditMemoLine.NEXT = 0;
          END;
        UNTIL locCreditMemoHeader.NEXT = 0;
      END;

      // Rabattbetrag um ungebuchte Rekl. reduzieren
      locSalesHeader.RESET;
      locSalesHeader.SETCURRENTKEY("Sell-to Customer No.","External Document No.");
      locSalesHeader.SETFILTER("Sell-to Customer No.",'<>%1','');
      locSalesHeader.SETRANGE("External Document No.",parOrderNo);
      IF locSalesHeader.FIND('-') THEN BEGIN
        // A/P0437
        REPEAT
        // E/P0437
          locSalesLine.SETRANGE("Document Type",locSalesHeader."Document Type");
          locSalesLine.SETRANGE("Document No.",locSalesHeader."No.");
          locSalesLine.SETRANGE(Type,locSalesLine.Type::Resource);
          locSalesLine.SETRANGE("No.",parResource);
          IF locSalesLine.FIND('-') THEN BEGIN
            REPEAT
              // A/P0418
              // parUnitPrice -= locSalesLine."Unit Price";
              parUnitPrice -= locSalesLine."Amount Including VAT";
              // E/P0418
            UNTIL locSalesLine.NEXT = 0;
          END;
        // A/P0437
        UNTIL locSalesHeader.NEXT = 0;
        // E/P0437
      END;

      // Rabattbetrag auf max Reklamationsbetrag setzen
      locSalesHeader.RESET;
      locSalesHeader.SETRANGE("Document Type",locSalesHeader."Document Type"::"Return Order");
      locSalesHeader.SETRANGE("No.",parReturnHeaderNo);
      IF locSalesHeader.FIND('-') THEN BEGIN
        locSalesLine.RESET;
        locSalesLine.SETRANGE("Document Type",locSalesHeader."Document Type");
        locSalesLine.SETRANGE("Document No.",locSalesHeader."No.");
        IF locSalesLine.FIND('-') THEN BEGIN
          REPEAT
            // A/P0418
            // locLineAmount += locSalesLine."Line Amount";
            locLineAmount += locSalesLine."Outstanding Amount";
            // E/P0418
          UNTIL locSalesLine.NEXT = 0;

          IF (parUnitPrice + locLineAmount) < 0 THEN
            parUnitPrice := -locLineAmount

        END;
      END;
      //E/P0011
    END;

    PROCEDURE CheckLastDocNoInteger@1000000000(DocNo@1000000000 : Code[20]) : Boolean;
    VAR
      lastno@1000000001 : Code[1];
      testinteger@1000000002 : Integer;
    BEGIN
      //a/p0072
      lastno := COPYSTR(DocNo,STRLEN(DocNo),1);
      IF NOT EVALUATE(testinteger,lastno) THEN
        //letzte Pos. ist ein Buchstabe...
        EXIT(FALSE)
      ELSE
        EXIT(TRUE);
      //e/p0072
    END;

    PROCEDURE GetReturnOrderLineType@1108200021(parReturnLine@1108200000 : Record 37;VAR parReturnType@1108200002 : ' ,Return,Change,Fitting,Cancelation,Amiability,Discount');
    VAR
      locReturnLine@1108200001 : Record 37;
    BEGIN
      //A/P0011
      CLEAR(locReturnLine);
      locReturnLine.RESET;
      locReturnLine.SETRANGE("Document Type",parReturnLine."Document Type");
      locReturnLine.SETRANGE("Document No.",parReturnLine."Document No.");
      //locReturnLine.SETFILTER("Line No.",'<>%1',parReturnLine."Line No.");
      locReturnLine.SETRANGE(Type,locReturnLine.Type::Item);
      IF locReturnLine.FIND('-') THEN
        parReturnType := locReturnLine."Return Type"
      ELSE
        parReturnType := parReturnType::" ";
      //E/P0011
    END;

    PROCEDURE ResendDropshipMail@1108200022(parPurchaseLine@1108200002 : Record 39);
    VAR
      BatchPostDoc@1108200000 : Record 50043;
      EntryNo@1108200001 : Integer;
    BEGIN
      //S/P0113
      IF parPurchaseLine."Document Type" <> parPurchaseLine."Document Type"::Order THEN
        EXIT;

      IF (parPurchaseLine."Purchasing Code" <> 'GER-4') OR (parPurchaseLine."Purchasing Code" <> 'GER-7') THEN
        EXIT;

      BatchPostDoc.RESET;
      BatchPostDoc.SETCURRENTKEY("Document No.","Document Type","Action Type");
      BatchPostDoc.SETRANGE("Document No.",parPurchaseLine."Document No.");
      BatchPostDoc.SETRANGE("Document Type",parPurchaseLine."Document Type");
      BatchPostDoc.SETRANGE("Action Type",BatchPostDoc."Action Type"::"Purch. EMail");
      IF BatchPostDoc.ISEMPTY THEN BEGIN
        //A/gob-adb/11.11.13
        {
        BatchPostDoc.LOCKTABLE;
        BatchPostDoc.RESET;
        IF BatchPostDoc.FINDLAST THEN
          EntryNo := BatchPostDoc."Entry No." + 1
        ELSE
          EntryNo := 1;
        }
        //E/gob-adb/11.11.13

        BatchPostDoc.INIT;
        //A/gob-adb/11.11.13
        //BatchPostDoc."Entry No." := EntryNo;
        BatchPostDoc."Entry No." := 0;
        //E/gob-adb/11.11.13
        BatchPostDoc."Document No." := parPurchaseLine."Document No.";
        BatchPostDoc."Document Type" := parPurchaseLine."Document Type";
        BatchPostDoc."Action Type" := BatchPostDoc."Action Type"::"Purch. EMail";
        BatchPostDoc."Scheduled at" := CURRENTDATETIME;
        BatchPostDoc."Scheduled by" := USERID;
        BatchPostDoc.INSERT;
      END;
      //E/P0113
    END;

    PROCEDURE DeleteCRLF@1000000002(p_Text@1000000000 : Text[1024];Use_UpperCase@1000000004 : Boolean) : Text[1024];
    VAR
      CR@1000000001 : Char;
      LF@1000000002 : Char;
      TAB@1000000003 : Char;
    BEGIN
      //A/P0124
      IF p_Text <> '' THEN BEGIN
        CR := 13;
        LF := 10;
        //A/P0188
        TAB := 9;
        //E/P0188
        IF Use_UpperCase THEN BEGIN
          p_Text := DELCHR(UPPERCASE(p_Text),'=',FORMAT(CR,0,'<Char>'));
          p_Text := DELCHR(UPPERCASE(p_Text),'=',FORMAT(LF,0,'<Char>'));
        //a/P0615/
        END ELSE BEGIN
          p_Text := DELCHR(p_Text,'=',FORMAT(CR,0,'<Char>'));
          p_Text := DELCHR(p_Text,'=',FORMAT(LF,0,'<Char>'));
        END;
        //e/P0615/
          //A/P0188
        p_Text := CONVERTSTR(p_Text,FORMAT(TAB,0,'<Char>'),' ');
        //E/P0188
        EXIT(p_Text);
      END;
      //E/P0124
    END;

    PROCEDURE ChangeChannel@1000000001(p_SalesLine@1000000000 : Record 37) r_PurchCode : Code[10];
    VAR
      ChangeChannel@1000000001 : Record 80021;
      FormChangeChannel@1000000002 : Form 50094;
      NewPuchasingCode@1000000003 : Code[10];
      ReleaseSalesDocument@1000000004 : Codeunit 414;
      SalesHeader@1000000005 : Record 36;
      SalesLine@1000000006 : Record 37;
      OldStatus@1000000007 : Integer;
      LocText003@1000000014 : TextConst 'DEU=Bitte ¬Åberpr¬Åfen Sie den Zeilenstatus ob der Artikel noch nicht verarbeitet wurde und somit nicht automatisch storniert werden kann. Wollen Sie fortfahren?;ENU=Please check line status if articles are not already being processed and can thus not be automatically cancelled. Continue?';
      LocText004@1000000013 : TextConst 'DEU=Channel Change canceled.;ENU=Kanal‚Äûnderung abgebrochen.';
      LocText001@1000000008 : TextConst 'DEU=Verkaufsauftrag %1 muss den Status %2, %3 oder %4 haben.;ENU=Sales Order %1 Status must be %2, %3 or %4.';
      SalesPostPrepayments@1000000009 : Codeunit 442;
      CommentLine@1000000010 : Record 97;
      LocText002@1000000011 : TextConst 'DEU=Kanal‚Äûnderung Zeile %3 von %1 auf %2.;ENU=Channel change from %1 to %2.';
      CommentLine2@1000000012 : Record 97;
      "****HME***********************"@1000000015 : Integer;
      FPCManagementL@1000000016 : Codeunit 50003;
    BEGIN
      // ChangeChannel

      IF NOT CONFIRM(LocText003,FALSE) THEN
        ERROR(LocText004);

      NewPuchasingCode := '';
      IF p_SalesLine."Purchasing Code" <> '' THEN BEGIN
        ChangeChannel.RESET;
        ChangeChannel.FILTERGROUP(2);
        ChangeChannel.SETFILTER("From Channel",p_SalesLine."Purchasing Code");
        ChangeChannel.SETFILTER("To Channel",'<>%1','');
        IF ChangeChannel.FIND('-') THEN BEGIN
          CLEAR(FormChangeChannel);
          FormChangeChannel.SetFilterGroup(p_SalesLine."Purchasing Code");
          //FormChangeChannel.SETTABLEVIEW(ChangeChannel);
          FormChangeChannel.EDITABLE := FALSE;
          FormChangeChannel.LOOKUPMODE := TRUE;
          IF FormChangeChannel.RUNMODAL = ACTION::LookupOK THEN BEGIN
            FormChangeChannel.GETRECORD(ChangeChannel);
            NewPuchasingCode := ChangeChannel."To Channel";
          END;
        END;
      END;

      IF NewPuchasingCode <> '' THEN BEGIN
        SalesHeader.GET(p_SalesLine."Document Type",p_SalesLine."Document No.");
        SalesHeader.TESTFIELD(Status,SalesHeader.Status::Released);
        IF (SalesHeader.Status <> SalesHeader.Status::Open) AND
           (SalesHeader.Status <> SalesHeader.Status::Released) AND
           (SalesHeader.Status <> SalesHeader.Status::"Pending Prepayment")
        THEN
          ERROR(LocText001,
                SalesHeader."No.",
                FORMAT(SalesHeader.Status::Open),
                FORMAT(SalesHeader.Status::Released),
                FORMAT(SalesHeader.Status::"Pending Prepayment"));
        OldStatus := SalesHeader.Status;
        SalesLine.GET(p_SalesLine."Document Type",p_SalesLine."Document No.",p_SalesLine."Line No.");
        SalesLine."Cancellation Reason Code" := 'CHANCHANGE';
        SalesLine.MODIFY;

        SalesLine.MagentoCancel(FALSE,FALSE);

        SalesLine.MODIFY;
        SalesHeader.RESET;
        SalesHeader.GET(p_SalesLine."Document Type",p_SalesLine."Document No.");
        IF SalesHeader.Status <> SalesHeader.Status::Open THEN BEGIN
          ReleaseSalesDocument.PerformManualReopen(SalesHeader);
          SalesHeader.MODIFY;
          COMMIT;
        END;
        SalesLine.RESET;
        SalesLine.GET(p_SalesLine."Document Type",p_SalesLine."Document No.",p_SalesLine."Line No.");
        SalesLine."Cancellation Reason Code" := '';
        SalesLine."Cancellation Date" := 0DT;
        SalesLine."Cancellation Qty." := 0;
        SalesLine."Qty. to Cancel" := 0;
        SalesLine."Line Status" := '';
        SalesLine."Old Purchasing Code" := SalesLine."Purchasing Code";
        SalesLine.VALIDATE("Purchasing Code",NewPuchasingCode);
        SalesLine.VALIDATE(Quantity,1);
        SalesLine.MODIFY;
        CASE OldStatus OF
          1: BEGIN
            CLEAR(ReleaseSalesDocument);
            ReleaseSalesDocument.RUN(SalesHeader);
          END;
          3: BEGIN
            CLEAR(SalesPostPrepayments);
            SalesPostPrepayments.Invoice(SalesHeader);
          END;
        END;
        CommentLine.InsertOrderHistory(p_SalesLine."Document No.",
                                       'CHANCHANGE',
                                       STRSUBSTNO(LocText002,
                                                  SalesLine."Old Purchasing Code",
                                                  SalesLine."Purchasing Code",
                                                  SalesLine."Line No."));

      END;
    END;

    PROCEDURE ChangeChannel2@1000000003(p_SalesHeader@1000000001 : Record 36);
    VAR
      SalesLine@1000000002 : Record 37;
      ChangeChannelForm@1000000003 : Form 50143;
      SalesHeader@1000000004 : Record 36;
      ReleaseSalesDocument@1000000005 : Codeunit 414;
      SalesLine2@1000000000 : Record 37;
      CommentLine@1000000006 : Record 97;
      LocText001@1000000009 : TextConst 'ENU=Not all orders Rhenus Interface Records are porcessed. Please try again later.';
      LocText002@1000000007 : TextConst 'DEU=Kanal‚Äûnderung Zeile %3 von %1 auf %2.;ENU=Channel change from %1 to %2.';
      RhenusChangeLog@1000000008 : Record 50070;
      LocText003@1000000011 : TextConst 'DEU=Bitte ¬Åberpr¬Åfen Sie den Zeilenstatus ob der Artikel noch nicht verarbeitet wurde und somit nicht automatisch storniert werden kann. Wollen Sie fortfahren?;ENU=Please check line status if articles are not already being processed and can thus not be automatically cancelled. Continue?';
      LocText004@1000000010 : TextConst 'DEU=Channel Change canceled.;ENU=Kanal‚Äûnderung abgebrochen.';
      LocText005@1000000012 : TextConst 'DEU=Kanalumbuchungen sind nur 1 mal pro Auftrag m‚Äùglich.\Vorgang abgebrochen.;ENU=Channel change is only allowed once.\Change canceled.';
      LocText006@1000000014 : TextConst 'DEU=Das Auftragsdatum liegt vor dem 05.09.12. \Umbuchungen d¬Årfen nur in Abstimmung mit Andre Beckmann stattfinden. \Haben Sie mit Andre Beckmann gefragt?;ENU=The order date is before 05.09.12. \Change Channel is only allowed in consultation with Andre Beckmann.\Have you asked Andre Beckmann?';
      LocText007@1000000013 : TextConst 'DEU=Sie k‚Äùnnen diese Auftrag nicht mehr automatisiert ¬Åber die Rhenus Schnittstelle stornieren.\ Sie m¬Åssen bei Rhenus erfragen, ob eine Stornierung weiterhin m‚Äùglich ist. Wollen Sie fortfahren?;ENU=You can''t canceld this order via Rhenus interface. You have to check if a cancelation is still possible. Continue?';
      HasBadRhenusPos@1000000015 : Boolean;
    BEGIN
      //A/gob-rste/09.05.12/
      IF p_SalesHeader."Order Date" <= 050912D THEN
        IF NOT CONFIRM(LocText006,FALSE) THEN
          ERROR(LocText004);
      //E/gob-rste/09.05.12/
      IF NOT CONFIRM(LocText003,FALSE) THEN
        ERROR(LocText004);
      p_SalesHeader.CALCFIELDS("Order History");
      //IF p_SalesHeader."Order History" THEN
        //ERROR(LocText005);
      RhenusChangeLog.RESET;
      RhenusChangeLog.SETRANGE("Source Type",RhenusChangeLog."Source Type"::Sales);
      RhenusChangeLog.SETRANGE("Document Type",RhenusChangeLog."Document Type"::Order);
      RhenusChangeLog.SETRANGE("Document No.",p_SalesHeader."No.");
      RhenusChangeLog.SETRANGE(Processed,FALSE);
      IF NOT RhenusChangeLog.ISEMPTY THEN
        ERROR(LocText001);

      SalesLine.RESET;
      SalesLine.SETRANGE("Document Type",p_SalesHeader."Document Type");
      SalesLine.SETRANGE("Document No.",p_SalesHeader."No.");
      IF SalesLine.FIND('-') THEN BEGIN
        CLEAR(ChangeChannelForm);
        ChangeChannelForm.SETTABLEVIEW(SalesLine);
        ChangeChannelForm.LOOKUPMODE := TRUE;
        IF ChangeChannelForm.RUNMODAL = ACTION::LookupOK THEN BEGIN
          ChangeChannelForm.GETRECORD(SalesLine);
          SalesLine.RESET;
          SalesLine.SETRANGE("Document Type",p_SalesHeader."Document Type");
          SalesLine.SETRANGE("Document No.",p_SalesHeader."No.");
          SalesLine.SETFILTER("New Purchasing Code",'<>%1','');
          IF SalesLine.FIND('-') THEN BEGIN
            HasBadRhenusPos := FALSE;
            SalesLine.SETRANGE("Status Code");
            SalesLine.SETRANGE("Status Code",'50');
            IF SalesLine.FINDFIRST THEN
              HasBadRhenusPos := TRUE;
            SalesLine.SETRANGE("Status Code");
            SalesLine.SETRANGE("Status Code",'11');
            IF SalesLine.FINDFIRST THEN
              HasBadRhenusPos := TRUE;
            SalesLine.SETRANGE("Status Code");
            SalesLine.SETRANGE("Status Code",'10');
            IF SalesLine.FINDFIRST THEN
              HasBadRhenusPos := TRUE;
            SalesLine.SETRANGE("Status Code");
            SalesLine.SETRANGE("Status Code",'1');
            IF SalesLine.FINDFIRST THEN
              HasBadRhenusPos := TRUE;
            IF HasBadRhenusPos THEN
              IF NOT CONFIRM(LocText007,FALSE) THEN
                ERROR(LocText004);
            //E/temp
            //A/P0296
            SalesLine.SETRANGE("Status Code");
            IF SalesLine.FIND('-') THEN;
            //E/P0296
            SalesHeader.RESET;
            SalesHeader.GET(p_SalesHeader."Document Type",p_SalesHeader."No.");
            SalesHeader.TESTFIELD(Status,SalesHeader.Status::Released);
            IF SalesHeader.Status <> SalesHeader.Status::Open THEN BEGIN
              ReleaseSalesDocument.PerformManualReopen(SalesHeader);
              SalesHeader.MODIFY;

              //A,gob-dst,02.10.2012,P0361
              // !!! Sollte in dieser Funktion MagentoCancel der SalesLine aufgerufen werden, muss gepr¬Åft werden, ob diese
              // Aufrufe noch ben‚Äùtigt werden (ggf. doppelter Aufruf?) !!!
              IF SalesHeader.Kommissionierung THEN BEGIN
                CLEAR(ReleaseSalesDocument);
                ReleaseSalesDocument.CalledFromCancel(TRUE);
                ReleaseSalesDocument.InitiateOrder2DDInterface(SalesHeader,2);
              END;
              //E,gob-dst,02.10.2012,P0361

              COMMIT;
            END;
            REPEAT
              IF SalesLine."Purchasing Code" <> SalesLine."New Purchasing Code" THEN BEGIN
                SalesLine2.GET(SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.");
                // umbuchung
                SalesLine2.RESET;
                SalesLine2.GET(SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.");
                SalesLine2."Line Status" := '';
                SalesLine2."Old Purchasing Code" := SalesLine."Purchasing Code";
                SalesLine2.VALIDATE("Purchasing Code",SalesLine."New Purchasing Code");
                SalesLine2.VALIDATE(Quantity,1);
                SalesLine2."New Purchasing Code" := '';
                SalesLine2.MODIFY;
                CommentLine.InsertOrderHistory(SalesLine2."Document No.",
                                               'CHANCHANGE',
                                               STRSUBSTNO(LocText002,
                                                          SalesLine2."Old Purchasing Code",
                                                          SalesLine2."Purchasing Code",
                                                          SalesLine2."Line No."));
              END;
            UNTIL SalesLine.NEXT = 0;
            CLEAR(ReleaseSalesDocument);
            ReleaseSalesDocument.RUN(SalesHeader);
          END;
        END;
      END;
    END;

    PROCEDURE CancelRhenusSeq@1000000004(p_SalesLine@1000000000 : Record 37);
    VAR
      RhenusChangeLog@1000000001 : Record 50070;
      RhenusChangeLog2@1000000002 : Record 50070;
      RhenusChangeLogLoc@1000000003 : Record 50070;
      RhenusChangeLogLoc2@1000000004 : Record 50070;
    BEGIN
      //S/P1215
      EXIT;
      //E/P1215
      IF (p_SalesLine."Location Code" <> '') AND (STRPOS(p_SalesLine."Location Code",'RHE') = 1) THEN BEGIN
        RhenusChangeLog.RESET;
        RhenusChangeLog.SETRANGE("Source Type",RhenusChangeLog."Source Type"::Sales);
        RhenusChangeLog.SETRANGE("Document Type",RhenusChangeLog."Document Type"::Order);
        RhenusChangeLog.SETRANGE("Document No.",p_SalesLine."Document No.");
        RhenusChangeLog.SETRANGE("Line No.",p_SalesLine."Line No.");
        RhenusChangeLog.SETRANGE(Processed,TRUE);
        IF RhenusChangeLog.FINDLAST THEN BEGIN
          RhenusChangeLog2.RESET;
          RhenusChangeLog2.SETRANGE("Source Type",RhenusChangeLog."Source Type");
          RhenusChangeLog2.SETRANGE("Document Type",RhenusChangeLog."Document Type");
          RhenusChangeLog2.SETRANGE("Document No.",RhenusChangeLog."Document No.");
          RhenusChangeLog2.SETRANGE("Seq. Code",RhenusChangeLog."Seq. Code");
          RhenusChangeLog2.SETRANGE("Line No.",0);
          //RhenusChangeLog2.SETRANGE(Action,RhenusChangeLog.Action);
          RhenusChangeLog2.SETRANGE("Branch Code",RhenusChangeLog."Branch Code");
          IF NOT RhenusChangeLog2.FINDFIRST THEN
            RhenusChangeLog2.RESET;
            RhenusChangeLog2.TRANSFERFIELDS(RhenusChangeLog);
            RhenusChangeLog2."Source Type" := RhenusChangeLog."Source Type";
            RhenusChangeLog2."Document Type" := RhenusChangeLog."Document Type";
            RhenusChangeLog2."Document No." := RhenusChangeLog."Document No.";
            RhenusChangeLog2."Seq. Code" := RhenusChangeLog."Seq. Code";
            RhenusChangeLog2."Line No." := 0;
            RhenusChangeLog2.Action := RhenusChangeLog.Action;
            RhenusChangeLog2."Branch Code" := RhenusChangeLog."Branch Code";
            IF RhenusChangeLog2.INSERT THEN;
        END;
      END;

      RhenusChangeLogLoc.RESET;
      RhenusChangeLogLoc.SETRANGE("Source Type",RhenusChangeLogLoc."Source Type"::Sales);
      RhenusChangeLogLoc.SETRANGE("Document Type",RhenusChangeLogLoc."Document Type"::Order);
      RhenusChangeLogLoc.SETRANGE("Document No.",p_SalesLine."Document No.");
      RhenusChangeLogLoc.SETRANGE(Processed,FALSE);
      RhenusChangeLogLoc.SETRANGE("Line No.",0);
      IF RhenusChangeLogLoc.FINDLAST THEN BEGIN
        RhenusChangeLogLoc2.RESET;
        RhenusChangeLogLoc2.SETRANGE("Source Type",RhenusChangeLogLoc2."Source Type"::Sales);
        RhenusChangeLogLoc2.SETRANGE("Document Type",RhenusChangeLogLoc2."Document Type"::Order);
        RhenusChangeLogLoc2.SETRANGE("Document No.",p_SalesLine."Document No.");
        RhenusChangeLogLoc2.SETRANGE(Processed,FALSE);
        RhenusChangeLogLoc2.SETRANGE("Line No.",p_SalesLine."Line No.");
        RhenusChangeLogLoc2.SETRANGE("Branch Code",RhenusChangeLogLoc."Branch Code");
        IF RhenusChangeLogLoc2.FINDLAST THEN
          IF RhenusChangeLogLoc2.DELETE THEN;
      END;
    END;

    PROCEDURE InitCancelWithoutInterfaces@1000000008(p_OrderNo@1000000000 : Code[20];p_LineNo@1000000001 : Integer);
    BEGIN
      // InitCancelWithoutInterfaces

      GlobOrderNo := '';
      GlobLineNo := 0;
      GlobOrderNo := p_OrderNo;
      GlobLineNo := p_LineNo;
    END;

    PROCEDURE AddRhenusLog@1000000005(p_SalesHeader@1000000000 : Record 36);
    VAR
      LatestLogRec@1000000001 : Record 50070;
      CancelAllSequences@1000000002 : Boolean;
      PaymentUpdate@1000000003 : Boolean;
    BEGIN
      LatestLogRec.SETRANGE("Source Type",LatestLogRec."Source Type"::Sales);
      LatestLogRec.SETRANGE("Document Type",LatestLogRec."Document Type"::Order);
      LatestLogRec.SETRANGE("Document No.",p_SalesHeader."No.");
      IF LatestLogRec.FINDLAST THEN BEGIN
        IF (LatestLogRec."Ship-to Name" <> p_SalesHeader."Ship-to Name") OR
           (LatestLogRec."Ship-to Name 2" <> p_SalesHeader."Ship-to Name 2") OR
           (LatestLogRec."Ship-to Address" <> p_SalesHeader."Ship-to Address") OR
           (LatestLogRec."Ship-to Address 2" <> p_SalesHeader."Ship-to Address 2") OR
           (LatestLogRec."Ship-to City" <> p_SalesHeader."Ship-to City") OR
           (LatestLogRec."Ship-to Contact" <> p_SalesHeader."Ship-to Contact") OR
           (LatestLogRec."Ship-to Country/Region Code" <> p_SalesHeader."Ship-to Country/Region Code") OR
           (LatestLogRec."Ship-to Post Code" <> p_SalesHeader."Ship-to Post Code") OR
           (LatestLogRec."Ship-to Code" <> p_SalesHeader."Ship-to Code")
        THEN
          CancelAllSequences := TRUE;

        IF (LatestLogRec."Shipment Date" = 11112911D) AND (p_SalesHeader.Status = p_SalesHeader.Status::Released) THEN
          PaymentUpdate := TRUE;
           //LastestLogRec."Website No."

         // bei lines check welche sequens to cancel viA bool
      END;
    END;

    PROCEDURE InsertCommentLineAnveo@1000000006(parString@1000000000 : Text[250];parAnveoUser@1000000008 : Code[20];VAR parCommentLine@1000000009 : Record 44;VAR parCommentLineArch@1000000013 : Record 5126);
    VAR
      locCommentLine@1000000001 : Record 44;
      locSubString@1000000002 : Text[80];
      locSubStringTurn@1000000003 : Text[80];
      locPosition@1000000004 : Integer;
      i@1000000005 : Integer;
      y@1000000006 : Integer;
      array_counter@1000000007 : Integer;
      locLineNo@1000000010 : Integer;
      newString@1000000011 : ARRAY [10] OF Text[80];
      z@1000000012 : Integer;
    BEGIN
      i := 1;
      WHILE i < STRLEN(parString) DO BEGIN
        CLEAR(locPosition);
        CLEAR(y);
        CLEAR(locSubStringTurn);

        array_counter +=1 ;

        locSubString := COPYSTR(parString,i,80);

        // teiltext umdrehen
        IF STRLEN(locSubString) = 80 THEN BEGIN
          WHILE y < STRLEN(locSubString) DO BEGIN
            locSubStringTurn += COPYSTR(locSubString,STRLEN(locSubString)-y,1);
            y += 1;
          END;
          // teiltext nach leerzeichen suchen
          locPosition := STRPOS(locSubStringTurn, ' ');
        END;

        // teiltext abschneiden
        IF STRLEN(locSubString) > locPosition THEN BEGIN
          newString[array_counter] := COPYSTR(locSubString,1,STRLEN(locSubString)-locPosition);
          i += STRLEN(locSubString)-locPosition;
        END ELSE BEGIN
          newString[array_counter] := COPYSTR(locSubString,1,locPosition);
          i += locPosition;
        END;
        i +=1;
      END;


      IF NOT parCommentLine.ISEMPTY THEN BEGIN
        locLineNo := parCommentLine."Line No.";

        CLEAR(z);
        z := 2;
        parCommentLine.Date := TODAY;
        parCommentLine.Comment := newString[1];
        parCommentLine."Anveo User" := parAnveoUser;
        parCommentLine."Comment Input" := '';

        WHILE z < ARRAYLEN(newString) DO BEGIN
          IF newString[z] <> '' THEN BEGIN
            locLineNo += 10000;
            locCommentLine.INIT;
            locCommentLine."Document Type" := locCommentLine."Document Type"::Order;
            locCommentLine."No." := parCommentLine."No.";
            locCommentLine."Document Line No." := 0;
            locCommentLine."Line No." := locLineNo;
            locCommentLine.Date := TODAY;
            locCommentLine.Comment := newString[z];
            locCommentLine."Anveo User" := parAnveoUser;
            locCommentLine.INSERT;
          END;
          z +=1;
        END;
      END;
      IF NOT parCommentLineArch.ISEMPTY THEN BEGIN
        locLineNo := parCommentLineArch."Line No.";

        CLEAR(z);
        z := 2;
        parCommentLineArch.Date := TODAY;
        parCommentLineArch.Comment := newString[1];
        parCommentLineArch."Anveo User" := parAnveoUser;
      //  parCommentLineArch."Comment Input" := '';

        WHILE z < ARRAYLEN(newString) DO BEGIN
          IF newString[z] <> '' THEN BEGIN
            locLineNo += 10000;
            parCommentLineArch.INIT;
            parCommentLineArch."Document Type" := locCommentLine."Document Type"::Order;
            parCommentLineArch."No." := parCommentLine."No.";
            parCommentLineArch."Document Line No." := 0;
            parCommentLineArch."Line No." := locLineNo;
            parCommentLineArch.Date := TODAY;
            parCommentLineArch.Comment := newString[z];
            parCommentLineArch."Anveo User" := parAnveoUser;
            parCommentLineArch.INSERT;
          END;
          z +=1;
        END;
      END;
    END;

    PROCEDURE CopyItemChargeToReturnOrder@1000000009(parSalesLine@1000000000 : Record 37;parReturnOrderLine@1000000006 : Record 37);
    VAR
      locItemChargeAssign@1000000002 : Record 5809;
      locNewItemChargeAssign@1000000003 : Record 5809;
      locNewSalesLine@1000000004 : Record 37;
      locSalesLineItemCharge@1000000005 : Record 37;
      locLineNo@1000000001 : Integer;
      locSalesHeader@1000000007 : Record 36;
      locSalesShipmentLine@1000000008 : Record 111;
      locSalesLine@1000000009 : Record 37;
      locSalesCreditMemoLine@1000000010 : Record 115;
    BEGIN
      // CopyItemChargetoReturnOrder
      locLineNo := parReturnOrderLine."Line No.";

      // Gibt es bereits Rabatte / Kulanzen im Auftrag die bei einer Retoure abgezogen werden m¬Åssen?
      locSalesLine.RESET;
      locSalesLine.SETRANGE("Document Type",parSalesLine."Document Type");
      locSalesLine.SETRANGE("Document No.",parSalesLine."Document No.");
      locSalesLine.SETRANGE("Linked to Sales Order No.",parSalesLine."Document No.");
      locSalesLine.SETRANGE("Linked to Sales Order Line No.",parSalesLine."Line No.");
      locSalesLine.SETRANGE(Type,locSalesLine.Type::"Charge (Item)");
      IF locSalesLine.FIND('-') THEN BEGIN
        REPEAT
          locLineNo += 10000;

          locNewSalesLine.INIT;
          locNewSalesLine."Document Type" := locNewSalesLine."Document Type"::"Return Order";
          locNewSalesLine."Document No." := parReturnOrderLine."Document No.";
          locNewSalesLine."Line No." := locLineNo;
          locNewSalesLine.VALIDATE(Type,locSalesLine.Type);
          locNewSalesLine.VALIDATE("No.",locSalesLine."No.");
          locNewSalesLine.VALIDATE(Quantity,locSalesLine.Quantity);
          locNewSalesLine.VALIDATE("Unit Price",-ABS(locSalesLine."Unit Price"));
          locNewSalesLine."Linked to Sales Order No." := locSalesLine."Linked to Sales Order No.";
          locNewSalesLine."Linked to Sales Order Line No." := locSalesLine."Linked to Sales Order Line No.";
          locNewSalesLine."Return Reason Code" := locSalesLine."Return Reason Code";
          locNewSalesLine.INSERT;

          locNewItemChargeAssign.INIT;
          locNewItemChargeAssign."Document Type" := parReturnOrderLine."Document Type";
          locNewItemChargeAssign."Document No." := parReturnOrderLine."Document No.";
          locNewItemChargeAssign."Document Line No." := locLineNo;
          locNewItemChargeAssign."Line No." := locLineNo;
          locNewItemChargeAssign."Item Charge No." := locSalesLine."No.";
          locNewItemChargeAssign."Item No." := parSalesLine."No.";
          locNewItemChargeAssign.Description := parSalesLine.Description;
          locNewItemChargeAssign."Unit Cost" := locSalesLine."Unit Price";
          locNewItemChargeAssign."Qty. to Assign" := locNewSalesLine."Quantity (Base)";
          locNewItemChargeAssign."Amount to Assign" := locNewSalesLine."Unit Price";

          locSalesShipmentLine.RESET;
          locSalesShipmentLine.SETCURRENTKEY("Order No.","Order Line No.","Posting Date");
          locSalesShipmentLine.SETRANGE("Order No.",parSalesLine."Document No.");
          //H1202 05.06.14 HCN +++++++++++++++++++++++++++++
          locSalesShipmentLine.SETRANGE("Order Line No.",parSalesLine."Line No.");
          //H1202 05.06.14 HCN -----------------------------
          locSalesShipmentLine.SETRANGE(Type,locSalesShipmentLine.Type::Item);
          locSalesShipmentLine.SETFILTER(Quantity,'<>0');
          IF locSalesShipmentLine.FINDFIRST THEN BEGIN
            locNewItemChargeAssign."Applies-to Doc. Type" := locNewItemChargeAssign."Applies-to Doc. Type"::Shipment;
            locNewItemChargeAssign."Applies-to Doc. No." := locSalesShipmentLine."Document No.";
            locNewItemChargeAssign."Applies-to Doc. Line No." := locSalesShipmentLine."Line No.";

          //H1202 05.06.14 HCN +++++++++++++++++++++++++++++
            locNewItemChargeAssign.INSERT;
            CreateDocDimForSalesLine(locNewSalesLine,locSalesLine);
            locNewSalesLine.UpdateItemChargeAssgnt;
          END;
          {
          END ELSE BEGIN
            locSalesShipmentLine.RESET;
            locSalesShipmentLine.SETRANGE(Type,locSalesShipmentLine.Type::Item);
            locSalesShipmentLine.SETFILTER(Quantity,'<>0');
            IF locSalesShipmentLine.FINDFIRST THEN BEGIN
              locNewItemChargeAssign."Applies-to Doc. Type" := locNewItemChargeAssign."Applies-to Doc. Type"::Shipment;
              locNewItemChargeAssign."Applies-to Doc. No." := locSalesShipmentLine."Document No.";
              locNewItemChargeAssign."Applies-to Doc. Line No." := locSalesShipmentLine."Line No.";
            END;
          END;
          locNewItemChargeAssign.INSERT;

          CreateDocDimForSalesLine(locNewSalesLine,locSalesLine);
          locNewSalesLine.UpdateItemChargeAssgnt;
          }
          //H1202 05.06.14 HCN -----------------------------

        UNTIL locSalesLine.NEXT = 0;
      END;

      // Gibt Rabatte / Kulanzen in gebuchten Gutschriften die bei einer Retoure abgezogen werden m¬Åssen?
      locSalesCreditMemoLine.RESET;
      locSalesCreditMemoLine.SETCURRENTKEY("Linked to Sales Order No.","Linked to Sales Order Line No.");
      locSalesCreditMemoLine.SETRANGE("Linked to Sales Order No.",parSalesLine."Document No.");
      locSalesCreditMemoLine.SETRANGE("Linked to Sales Order Line No.",parSalesLine."Line No.");
      locSalesCreditMemoLine.SETRANGE(Type,locSalesCreditMemoLine.Type::"Charge (Item)");
      IF locSalesCreditMemoLine.FIND('-') THEN BEGIN
        REPEAT
          locLineNo += 10000;

          locNewSalesLine.INIT;
          locNewSalesLine."Document Type" := locNewSalesLine."Document Type"::"Return Order";
          locNewSalesLine."Document No." := parReturnOrderLine."Document No.";
          locNewSalesLine."Line No." := locLineNo;
          locNewSalesLine.VALIDATE(Type,locSalesCreditMemoLine.Type);
          locNewSalesLine.VALIDATE("No.",locSalesCreditMemoLine."No.");
          locNewSalesLine.VALIDATE(Quantity,locSalesCreditMemoLine.Quantity);
          locNewSalesLine.VALIDATE("Unit Price",-ABS(locSalesCreditMemoLine."Unit Price"));
          locNewSalesLine."Linked to Sales Order No." := locSalesCreditMemoLine."Linked to Sales Order No.";
          locNewSalesLine."Linked to Sales Order Line No." := locSalesCreditMemoLine."Linked to Sales Order Line No.";
          locNewSalesLine."Return Reason Code" := locSalesCreditMemoLine."Return Reason Code";
          locNewSalesLine.INSERT;

          locNewItemChargeAssign.INIT;
          locNewItemChargeAssign."Document Type" := parReturnOrderLine."Document Type";
          locNewItemChargeAssign."Document No." := parReturnOrderLine."Document No.";
          locNewItemChargeAssign."Document Line No." := locLineNo;
          locNewItemChargeAssign."Line No." := locLineNo;
          locNewItemChargeAssign."Item Charge No." := locSalesCreditMemoLine."No.";
          locNewItemChargeAssign."Item No." := parSalesLine."No.";
          locNewItemChargeAssign.Description := parSalesLine.Description;
          locNewItemChargeAssign."Unit Cost" := locSalesCreditMemoLine."Unit Price";
          locNewItemChargeAssign."Qty. to Assign" := locNewSalesLine."Quantity (Base)";
          locNewItemChargeAssign."Amount to Assign" := locNewSalesLine."Unit Price";

          locSalesShipmentLine.RESET;
          locSalesShipmentLine.SETCURRENTKEY("Order No.","Order Line No.","Posting Date");
          locSalesShipmentLine.SETRANGE("Order No.",parSalesLine."Document No.");
          //H1202 05.06.14 HCN +++++++++++++++++++++++++++++
          locSalesShipmentLine.SETRANGE("Order Line No.",parSalesLine."Line No.");
          //H1202 05.06.14 HCN -----------------------------
          locSalesShipmentLine.SETRANGE(Type,locSalesShipmentLine.Type::Item);
          locSalesShipmentLine.SETFILTER(Quantity,'<>0');
          IF locSalesShipmentLine.FINDFIRST THEN BEGIN
            locNewItemChargeAssign."Applies-to Doc. Type" := locNewItemChargeAssign."Applies-to Doc. Type"::Shipment;
            locNewItemChargeAssign."Applies-to Doc. No." := locSalesShipmentLine."Document No.";
            locNewItemChargeAssign."Applies-to Doc. Line No." := locSalesShipmentLine."Line No.";
          //H1202 05.06.14 HCN +++++++++++++++++++++++++++++
            locNewItemChargeAssign.INSERT;
            CreateDocDimForSalesLine(locNewSalesLine,locSalesLine);
            locNewSalesLine.UpdateItemChargeAssgnt;
          END;
          {
          END ELSE BEGIN
            locSalesShipmentLine.RESET;
            locSalesShipmentLine.SETRANGE(Type,locSalesShipmentLine.Type::Item);
            locSalesShipmentLine.SETFILTER(Quantity,'<>0');
            IF locSalesShipmentLine.FINDFIRST THEN BEGIN
              locNewItemChargeAssign."Applies-to Doc. Type" := locNewItemChargeAssign."Applies-to Doc. Type"::Shipment;
              locNewItemChargeAssign."Applies-to Doc. No." := locSalesShipmentLine."Document No.";
              locNewItemChargeAssign."Applies-to Doc. Line No." := locSalesShipmentLine."Line No.";
            END;
          END;
          locNewItemChargeAssign.INSERT;
          CreateDocDimForSalesLine(locNewSalesLine,locSalesLine);
          locNewSalesLine.UpdateItemChargeAssgnt;
          }
          //H1202 05.06.14 HCN -----------------------------
        UNTIL locSalesCreditMemoLine.NEXT = 0;
      END;
    END;

    PROCEDURE CopyArchItemChargeToReturnOrd@1000000010(parSalesLineArch@1000000000 : Record 5108;parReturnOrderLine@1000000006 : Record 37);
    VAR
      locNewItemChargeAssign@1000000003 : Record 5809;
      locNewSalesLine@1000000004 : Record 37;
      locSalesLineItemCharge@1000000005 : Record 37;
      locLineNo@1000000001 : Integer;
      locSalesHeader@1000000007 : Record 36;
      locSalesShipmentLine@1000000008 : Record 111;
      locValueEntry@1000000002 : Record 5802;
      locValueEntry2@1000000009 : Record 5802;
      locSalesLineArch@1000000010 : Record 5108;
      locSalesCreditMemoLine@1000000011 : Record 115;
    BEGIN
      // CopyArchItemChargeToReturnOrd

      locLineNo := parReturnOrderLine."Line No.";

      // Gibt es bereits Rabatte / Kulanzen im Auftrag die bei einer Retoure abgezogen werden m¬Åssen?
      locSalesLineArch.RESET;
      locSalesLineArch.SETRANGE("Document Type",parSalesLineArch."Document Type");
      locSalesLineArch.SETRANGE("Document No.",parSalesLineArch."Document No.");
      locSalesLineArch.SETRANGE("Doc. No. Occurrence",parSalesLineArch."Doc. No. Occurrence");
      locSalesLineArch.SETRANGE("Version No.",parSalesLineArch."Version No.");
      locSalesLineArch.SETRANGE("Linked to Sales Order No.",parSalesLineArch."Document No.");
      locSalesLineArch.SETRANGE("Linked to Sales Order Line No.",parSalesLineArch."Line No.");
      locSalesLineArch.SETRANGE(Type,locSalesLineArch.Type::"Charge (Item)");
      IF locSalesLineArch.FIND('-') THEN BEGIN
        REPEAT

          locLineNo += 10000;

          locNewSalesLine.INIT;
          locNewSalesLine."Document Type" := locNewSalesLine."Document Type"::"Return Order";
          locNewSalesLine."Document No." := parReturnOrderLine."Document No.";
          locNewSalesLine."Line No." := locLineNo;
          locNewSalesLine.VALIDATE(Type,locSalesLineArch.Type);
          locNewSalesLine.VALIDATE("No.",locSalesLineArch."No.");
          locNewSalesLine.VALIDATE(Quantity,locSalesLineArch.Quantity);
          locNewSalesLine.VALIDATE("Unit Price",-ABS(locSalesLineArch."Unit Price"));
          locNewSalesLine."Linked to Sales Order No." := locSalesLineArch."Linked to Sales Order No.";
          locNewSalesLine."Linked to Sales Order Line No." := locSalesLineArch."Linked to Sales Order Line No.";
          locNewSalesLine."Return Reason Code" := locSalesLineArch."Return Reason Code";
          locNewSalesLine.INSERT;

          locNewItemChargeAssign.INIT;
          locNewItemChargeAssign."Document Type" := parReturnOrderLine."Document Type";
          locNewItemChargeAssign."Document No." := parReturnOrderLine."Document No.";
          locNewItemChargeAssign."Document Line No." := locLineNo;
          locNewItemChargeAssign."Line No." := locLineNo;
          locNewItemChargeAssign."Item Charge No." := locSalesLineArch."No.";
          locNewItemChargeAssign."Item No." := parSalesLineArch."No.";
          locNewItemChargeAssign.Description := parSalesLineArch.Description;
          locNewItemChargeAssign."Unit Cost" := locSalesLineArch."Unit Price";
          locNewItemChargeAssign."Qty. to Assign" := locNewSalesLine."Quantity (Base)";
          locNewItemChargeAssign."Amount to Assign" := locNewSalesLine."Unit Price";

          locSalesShipmentLine.RESET;
          locSalesShipmentLine.SETCURRENTKEY("Order No.","Order Line No.","Posting Date");
          locSalesShipmentLine.SETRANGE("Order No.",parSalesLineArch."Document No.");
          //H1202 05.06.14 HCN +++++++++++++++++++++++++++++
          locSalesShipmentLine.SETRANGE("Order Line No.",parSalesLineArch."Line No.");
          //H1202 05.06.14 HCN -----------------------------
          locSalesShipmentLine.SETRANGE(Type,locSalesShipmentLine.Type::Item);
          locSalesShipmentLine.SETFILTER(Quantity,'<>0');
          IF locSalesShipmentLine.FINDFIRST THEN BEGIN
            locNewItemChargeAssign."Applies-to Doc. Type" := locNewItemChargeAssign."Applies-to Doc. Type"::Shipment;
            locNewItemChargeAssign."Applies-to Doc. No." := locSalesShipmentLine."Document No.";
            locNewItemChargeAssign."Applies-to Doc. Line No." := locSalesShipmentLine."Line No.";
          //H1202 05.06.14 HCN +++++++++++++++++++++++++++++
            locNewItemChargeAssign.INSERT;
            CreateDocDimForSalesLineArch(locNewSalesLine,parSalesLineArch);
            locNewSalesLine.UpdateItemChargeAssgnt;
          END;
          {
          END ELSE BEGIN
            locSalesShipmentLine.RESET;
            locSalesShipmentLine.SETRANGE(Type,locSalesShipmentLine.Type::Item);
            locSalesShipmentLine.SETFILTER(Quantity,'<>0');
            IF locSalesShipmentLine.FINDFIRST THEN BEGIN
              locNewItemChargeAssign."Applies-to Doc. Type" := locNewItemChargeAssign."Applies-to Doc. Type"::Shipment;
              locNewItemChargeAssign."Applies-to Doc. No." := locSalesShipmentLine."Document No.";
              locNewItemChargeAssign."Applies-to Doc. Line No." := locSalesShipmentLine."Line No.";
            END;
          END;
          locNewItemChargeAssign.INSERT;
          CreateDocDimForSalesLineArch(locNewSalesLine,parSalesLineArch);
          locNewSalesLine.UpdateItemChargeAssgnt;
          }
          //H1202 05.06.14 HCN -----------------------------
        UNTIL locSalesLineArch.NEXT = 0;
      END;

      // Gibt es Rabatte / Kulanzen in gebuchten Gutschriften die bei einer Retoure abgezogen werden m¬Åssen?
      locSalesCreditMemoLine.RESET;
      locSalesCreditMemoLine.SETCURRENTKEY("Linked to Sales Order No.","Linked to Sales Order Line No.");
      locSalesCreditMemoLine.SETRANGE("Linked to Sales Order No.",parSalesLineArch."Document No.");
      locSalesCreditMemoLine.SETRANGE("Linked to Sales Order Line No.",parSalesLineArch."Line No.");
      locSalesCreditMemoLine.SETRANGE(Type,locSalesCreditMemoLine.Type::"Charge (Item)");
      IF locSalesCreditMemoLine.FIND('-') THEN BEGIN
        REPEAT

          locLineNo += 10000;

          locNewSalesLine.INIT;
          locNewSalesLine."Document Type" := locNewSalesLine."Document Type"::"Return Order";
          locNewSalesLine."Document No." := parReturnOrderLine."Document No.";
          locNewSalesLine."Line No." := locLineNo;
          locNewSalesLine.VALIDATE(Type,locSalesCreditMemoLine.Type);
          locNewSalesLine.VALIDATE("No.",locSalesCreditMemoLine."No.");
          locNewSalesLine.VALIDATE(Quantity,locSalesCreditMemoLine.Quantity);
          locNewSalesLine.VALIDATE("Unit Price",-ABS(locSalesCreditMemoLine."Unit Price"));
          locNewSalesLine."Linked to Sales Order No." := locSalesCreditMemoLine."Linked to Sales Order No.";
          locNewSalesLine."Linked to Sales Order Line No." := locSalesCreditMemoLine."Linked to Sales Order Line No.";
          locNewSalesLine.INSERT;

          locNewItemChargeAssign.INIT;
          locNewItemChargeAssign."Document Type" := parReturnOrderLine."Document Type";
          locNewItemChargeAssign."Document No." := parReturnOrderLine."Document No.";
          locNewItemChargeAssign."Document Line No." := locLineNo;
          locNewItemChargeAssign."Line No." := locLineNo;
          locNewItemChargeAssign."Item Charge No." := locSalesCreditMemoLine."No.";
          locNewItemChargeAssign."Item No." := parSalesLineArch."No.";
          locNewItemChargeAssign.Description := parSalesLineArch.Description;
          locNewItemChargeAssign."Unit Cost" := locSalesCreditMemoLine."Unit Price";
          locNewItemChargeAssign."Qty. to Assign" := locNewSalesLine."Quantity (Base)";
          locNewItemChargeAssign."Amount to Assign" := locNewSalesLine."Unit Price";

          locSalesShipmentLine.RESET;
          locSalesShipmentLine.SETCURRENTKEY("Order No.","Order Line No.","Posting Date");
          locSalesShipmentLine.SETRANGE("Order No.",parSalesLineArch."Document No.");
          //H1202 05.06.14 HCN +++++++++++++++++++++++++++++
          locSalesShipmentLine.SETRANGE("Order Line No.",parSalesLineArch."Line No.");
          //H1202 05.06.14 HCN -----------------------------
          locSalesShipmentLine.SETRANGE(Type,locSalesShipmentLine.Type::Item);
          locSalesShipmentLine.SETFILTER(Quantity,'<>0');
          IF locSalesShipmentLine.FINDFIRST THEN BEGIN
            locNewItemChargeAssign."Applies-to Doc. Type" := locNewItemChargeAssign."Applies-to Doc. Type"::Shipment;
            locNewItemChargeAssign."Applies-to Doc. No." := locSalesShipmentLine."Document No.";
            locNewItemChargeAssign."Applies-to Doc. Line No." := locSalesShipmentLine."Line No.";
          //H1202 05.06.14 HCN +++++++++++++++++++++++++++++
            locNewItemChargeAssign.INSERT;
            CreateDocDimForSalesLineArch(locNewSalesLine,parSalesLineArch);
            locNewSalesLine.UpdateItemChargeAssgnt;
          END;
          {
          END ELSE BEGIN
            locSalesShipmentLine.RESET;
            locSalesShipmentLine.SETRANGE(Type,locSalesShipmentLine.Type::Item);
            locSalesShipmentLine.SETFILTER(Quantity,'<>0');
            IF locSalesShipmentLine.FINDFIRST THEN BEGIN
              locNewItemChargeAssign."Applies-to Doc. Type" := locNewItemChargeAssign."Applies-to Doc. Type"::Shipment;
              locNewItemChargeAssign."Applies-to Doc. No." := locSalesShipmentLine."Document No.";
              locNewItemChargeAssign."Applies-to Doc. Line No." := locSalesShipmentLine."Line No.";
            END;
          END;
          locNewItemChargeAssign.INSERT;
          CreateDocDimForSalesLineArch(locNewSalesLine,parSalesLineArch);
          locNewSalesLine.UpdateItemChargeAssgnt;
          }
          //H1202 05.06.14 HCN -----------------------------
        UNTIL locSalesCreditMemoLine.NEXT = 0;
      END;
    END;

    PROCEDURE GetLineNo@1000000011(parSalesLine@1000000000 : Record 37) : Integer;
    VAR
      locSalesLine@1000000001 : Record 37;
    BEGIN
      locSalesLine.RESET;
      locSalesLine.SETRANGE("Document Type",parSalesLine."Document Type");
      locSalesLine.SETRANGE("Document No.",parSalesLine."Document No.");
      IF locSalesLine.FINDLAST THEN
        EXIT(locSalesLine."Line No." + 10000)
      ELSE
        EXIT(10000);
    END;

    PROCEDURE CheckExistingCrMemo@1000000013(SalesHeaderRecRefV@1000000010 : RecordRef;SalesLineRecRefV@1000000002 : RecordRef);
    VAR
      SalesCrMemoHeaderL@1000000000 : Record 114;
      SalesCrMemoLineL@1000000001 : Record 115;
      locWebDeskMgt@1000000003 : Codeunit 5327126;
      locSalesLine@1000000004 : Record 37;
      locSalesLineArch@1000000005 : Record 5108;
      SalesHeaderL@1000000011 : Record 36;
      SalesHeaderArchiveL@1000000012 : Record 5107;
      locDocumentNo@1000000006 : Code[20];
      CustomerNoL@1000000013 : Code[20];
      locLineNo@1000000007 : Integer;
      locCancelReturnOrderHistory@1000000008 : Record 50037;
      locExit@1000000009 : Boolean;
    BEGIN
      // CheckExistingCrMemo

      CLEAR(SalesCrMemoHeaderL);
      CLEAR(SalesCrMemoLineL);

      CASE SalesLineRecRefV.NUMBER OF
        DATABASE::"Sales Line":
          BEGIN
            SalesHeaderRecRefV.SETTABLE(SalesHeaderL);
            SalesLineRecRefV.SETTABLE(locSalesLine);
            locDocumentNo := locSalesLine."Document No.";
            locLineNo := locSalesLine."Line No.";
            CustomerNoL := SalesHeaderL."Sell-to Customer No.";
          END;
        DATABASE::"Sales Line Archive":
          BEGIN
            SalesHeaderRecRefV.SETTABLE(SalesHeaderArchiveL);
            SalesLineRecRefV.SETTABLE(locSalesLineArch);
            locLineNo := locSalesLineArch."Line No.";
            locDocumentNo := locSalesLineArch."Document No.";
            CustomerNoL := SalesHeaderArchiveL."Sell-to Customer No.";
          END;
      END;

      SalesCrMemoHeaderL.RESET;
      SalesCrMemoHeaderL.SETCURRENTKEY("External Document No.","Sell-to Customer No.");
      SalesCrMemoHeaderL.SETRANGE("External Document No.",locDocumentNo);
      SalesCrMemoHeaderL.SETRANGE("Sell-to Customer No.",CustomerNoL);
      IF SalesCrMemoHeaderL.FIND('-') THEN BEGIN
        REPEAT
          SalesCrMemoLineL.RESET;
          SalesCrMemoLineL.SETRANGE("Linked to Sales Order No.",locDocumentNo);
          SalesCrMemoLineL.SETRANGE("Linked to Sales Order Line No.",locLineNo);
          IF SalesCrMemoLineL.FINDFIRST THEN BEGIN
            REPEAT
              CASE TRUE OF
                (SalesCrMemoLineL."Return Type" = SalesCrMemoLineL."Return Type"::Return)
                AND
                ((SalesCrMemoLineL."Customer Prevention" = SalesCrMemoLineL."Customer Prevention"::"Not offered") OR
                 (SalesCrMemoLineL."Customer Prevention" = SalesCrMemoLineL."Customer Prevention"::Declined)):
                  BEGIN
                    ERROR(TextHME015,locLineNo);
                  END;
                (SalesCrMemoLineL."Return Type" = SalesCrMemoLineL."Return Type"::Change):
                  BEGIN
                    ERROR(TextHME016,locLineNo);
                  END;

                (SalesCrMemoLineL."Return Type" = SalesCrMemoLineL."Return Type"::Return) AND
                (SalesCrMemoLineL."Customer Prevention" = SalesCrMemoLineL."Customer Prevention"::Accepted):
                  BEGIN
                    IF ISSERVICETIER THEN BEGIN
                      IF NOT locWebDeskMgt.CONFIRM2(Confirm001,FALSE,locDocumentNo,locLineNo) THEN BEGIN
                        ERROR(Error020)
                      END ELSE BEGIN
                        locExit := TRUE;
                      END;
                    END ELSE BEGIN
                      IF NOT HideValidationDialog THEN BEGIN
                        IF NOT CONFIRM(Confirm001,FALSE,locDocumentNo,locLineNo) THEN BEGIN
                          ERROR(Error020);
                        END ELSE BEGIN
                          locExit := TRUE;
                        END;
                      END;
                    END;
                  END;
              END;
            UNTIL (SalesCrMemoLineL.NEXT = 0) OR NOT DoProcessCurrentLine;
          END;
        UNTIL (SalesCrMemoHeaderL.NEXT = 0) OR (locExit);
      END;


      // unposted return orders
      locSalesLine.RESET;
      locSalesLine.SETCURRENTKEY("Linked to Sales Order No.","Linked to Sales Order Line No.");
      //H1472 30.10.14 tec-rh ++++++++++
      locSalesLine.SETRANGE("Document Type",locSalesLine."Document Type"::"Return Order");
      //H1472 30.10.14 tec-rh ----------
      locSalesLine.SETRANGE("Linked to Sales Order No.",locDocumentNo);
      locSalesLine.SETRANGE("Linked to Sales Order Line No.",locLineNo);
      locSalesLine.SETRANGE(Type,locSalesLine.Type::Item);
      locSalesLine.SETFILTER(Quantity,'<>%1',0);
      IF locSalesLine.FINDFIRST THEN BEGIN
        DisplayMessage(Error025,3,
                       locSalesLine."No.",
                       locDocumentNo,
                       FORMAT(locLineNo));
        DoProcessCurrentLine := FALSE;
      END;
    END;

    PROCEDURE CheckDiscountAmount@1000000007(parPreventionAmount@1000000001 : Decimal);
    VAR
      locSalesCreditMemoLine@1000000002 : Record 115;
      locSalesLine@1000000003 : Record 37;
      locSalesLineArchRecRef@1000000006 : Record 5108;
      locSalesLineRecRef@1000000000 : Record 37;
      SalesLineArchiveL@1000000007 : Record 5108;
      locPreventionAmount@1000000004 : Decimal;
      locCompareAmount@1000000005 : Decimal;
    BEGIN
      // CheckDiscountAmount

      CLEAR(locPreventionAmount);
      CLEAR(locCompareAmount);

      CASE GlobRecRef.NUMBER OF
        37: BEGIN
          GlobRecRef.SETTABLE(locSalesLineRecRef);
          // unposted return and sales orders
          locSalesLine.RESET;
          locSalesLine.SETCURRENTKEY("Linked to Sales Order No.","Linked to Sales Order Line No.");
          locSalesLine.SETRANGE("Linked to Sales Order No.",locSalesLineRecRef."Document No.");
          locSalesLine.SETRANGE("Linked to Sales Order Line No.",locSalesLineRecRef."Line No.");
          locSalesLine.SETRANGE(Type,locSalesLine.Type::"Charge (Item)");
          IF locSalesLine.FIND('-') THEN BEGIN
            REPEAT
              locPreventionAmount += ABS(locSalesLine."Unit Price");
            UNTIL locSalesLine.NEXT = 0;
          END;

          // posted credit memos
          locSalesCreditMemoLine.RESET;
          locSalesCreditMemoLine.SETCURRENTKEY("Linked to Sales Order No.","Linked to Sales Order Line No.");
          locSalesCreditMemoLine.SETRANGE("Linked to Sales Order No.",locSalesLineRecRef."Document No.");
          locSalesCreditMemoLine.SETRANGE("Linked to Sales Order Line No.",locSalesLineRecRef."Line No.");
          locSalesCreditMemoLine.SETRANGE(Type,locSalesCreditMemoLine.Type::"Charge (Item)");
          IF locSalesCreditMemoLine.FIND('-') THEN BEGIN
            REPEAT
              locPreventionAmount += locSalesCreditMemoLine."Unit Price";
            UNTIL locSalesCreditMemoLine.NEXT = 0;
          END;

          locCompareAmount := locSalesLineRecRef."Unit Price" - locPreventionAmount;

          IF parPreventionAmount > locCompareAmount  THEN BEGIN
            ERROR(Error003,locSalesLineRecRef."Line No.");
          END;
        END;

        5108: BEGIN
          GlobRecRef.SETTABLE(locSalesLineArchRecRef);
          // unposted return orders
          locSalesLine.RESET;
          locSalesLine.SETCURRENTKEY("Linked to Sales Order No.","Linked to Sales Order Line No.");
          locSalesLine.SETRANGE("Linked to Sales Order No.",locSalesLineArchRecRef."Document No.");
          locSalesLine.SETRANGE("Linked to Sales Order Line No.",locSalesLineArchRecRef."Line No.");
          locSalesLine.SETRANGE(Type,locSalesLine.Type::"Charge (Item)");
          IF locSalesLine.FIND('-') THEN BEGIN
            REPEAT
              locPreventionAmount += ABS(locSalesLine."Unit Price");
            UNTIL locSalesLine.NEXT = 0;
          END;

          // archived sales orders (prevention before shipment => no posted sales credit memo line)
          SalesLineArchiveL.RESET;
          SalesLineArchiveL.SETCURRENTKEY("Linked to Sales Order No.","Linked to Sales Order Line No.");
          SalesLineArchiveL.SETRANGE("Linked to Sales Order No.",locSalesLineArchRecRef."Document No.");
          SalesLineArchiveL.SETRANGE("Linked to Sales Order Line No.",locSalesLineArchRecRef."Line No.");
          SalesLineArchiveL.SETRANGE(Type,SalesLineArchiveL.Type::"Charge (Item)");
          SalesLineArchiveL.SETRANGE("Document Type",locSalesLineArchRecRef."Document Type");
          SalesLineArchiveL.SETRANGE("Doc. No. Occurrence",locSalesLineArchRecRef."Doc. No. Occurrence");
          SalesLineArchiveL.SETRANGE("Version No.",locSalesLineArchRecRef."Version No.");
          IF SalesLineArchiveL.FIND('-') THEN BEGIN
            REPEAT
              locPreventionAmount += ABS(SalesLineArchiveL."Unit Price");
            UNTIL SalesLineArchiveL.NEXT = 0;
          END;

          // posted credit memos
          locSalesCreditMemoLine.RESET;
          locSalesCreditMemoLine.SETCURRENTKEY("Linked to Sales Order No.","Linked to Sales Order Line No.");
          locSalesCreditMemoLine.SETRANGE("Linked to Sales Order No.",locSalesLineArchRecRef."Document No.");
          locSalesCreditMemoLine.SETRANGE("Linked to Sales Order Line No.",locSalesLineArchRecRef."Line No.");
          locSalesCreditMemoLine.SETRANGE(Type,locSalesCreditMemoLine.Type::"Charge (Item)");
          IF locSalesCreditMemoLine.FIND('-') THEN BEGIN
            REPEAT
              locPreventionAmount += locSalesCreditMemoLine."Unit Price";
            UNTIL locSalesCreditMemoLine.NEXT = 0;
          END;

          locCompareAmount := locSalesLineArchRecRef."Unit Price" - locPreventionAmount;

          IF parPreventionAmount > locCompareAmount  THEN BEGIN
            ERROR(Error003,locSalesLineArchRecRef."Line No.");
          END;
        END;
      END;
    END;

    PROCEDURE CalcShippingAgent@1000000014(SalesHeader@1000000000 : Record 36;Interface@1000000001 : Code[10]) : Code[10];
    VAR
      SalesLine@1000000002 : Record 37;
      ItemWebSitePurchRel@1000000003 : Record 50116;
      FPCInterfaces@1000000004 : Record 50014;
      PurchasingL@1000000007 : Record 5721;
      FPCGeneralSetup@1000000010 : Record 50055;
      ShippingAgentPrioTEMP@1000000011 : TEMPORARY Record 50223;
      ShippingAgentPrioritization@1000000012 : Record 50223;
    BEGIN
      //S/P1230
      FPCGeneralSetup.GET;
      FPCGeneralSetup.TESTFIELD("Interface Code DocData");

      CASE Interface OF
        FPCGeneralSetup."Interface Code DocData" :
          BEGIN
            SalesLine.RESET;
            SalesLine.SETRANGE("Document Type",SalesHeader."Document Type");
            SalesLine.SETRANGE("Document No.",SalesHeader."No.");
            SalesLine.SETRANGE(Type,SalesLine.Type::Item);
            SalesLine.SETFILTER(Quantity,'<>%1',0);
            IF SalesLine.FINDSET THEN BEGIN
              ShippingAgentPrioTEMP.DELETEALL;
              REPEAT
                IF PurchasingL.GET(SalesLine."Purchasing Code") AND
                   (PurchasingL."Interface Code" = FPCGeneralSetup."Interface Code DocData")
                THEN BEGIN
                  IF ShippingAgentPrioritization.GET(
                     0,
                     FPCGeneralSetup."Interface Code DocData",
                     SalesLine."Purchasing Code",
                     SalesLine."Shipping Agent Code")
                   THEN BEGIN
                     IF NOT ShippingAgentPrioTEMP.GET(
                        0,
                        FPCGeneralSetup."Interface Code DocData",
                        SalesLine."Purchasing Code",
                        SalesLine."Shipping Agent Code")
                     THEN BEGIN
                       ShippingAgentPrioTEMP.INIT;
                       ShippingAgentPrioTEMP.TRANSFERFIELDS(ShippingAgentPrioritization);
                       ShippingAgentPrioTEMP.INSERT;
                     END;
                   END;
                END;
              UNTIL SalesLine.NEXT = 0;
              IF NOT ShippingAgentPrioTEMP.ISEMPTY THEN BEGIN
                ShippingAgentPrioTEMP.SETCURRENTKEY(Priority);
                ShippingAgentPrioTEMP.FINDFIRST;
                EXIT(ShippingAgentPrioTEMP."Shipping Agent");
              END;
            END;

            //H1369 17.07.14 DMA ++++++++++++++++++++++++++++
            IF ItemWebSitePurchRel.GET(SalesLine."No.",SalesHeader."Website No.",SalesLine."Purchasing Code") THEN
              IF ItemWebSitePurchRel."Shipping Agent" <> '' THEN
                EXIT(ItemWebSitePurchRel."Shipping Agent");
            //H1369 17.07.14 DMA ----------------------------

            FPCInterfaces.GET(FPCGeneralSetup."Interface Code DocData");
            EXIT(FPCInterfaces."Default Shipping Agent");
          END;
      END;
      {********************Start Old Code ******************************
      //a/P0651/06.12.12/gob-sfe
      CASE Interface OF
        'DOCDATA': BEGIN
                     SalesLine.RESET;
                     SalesLine.SETRANGE("Document Type",SalesHeader."Document Type");
                     SalesLine.SETRANGE("Document No.",SalesHeader."No.");
                     SalesLine.SETRANGE(Type,SalesLine.Type::Item);
                     IF SalesLine.FINDSET THEN
                       REPEAT
                         IF ItemWebSitePurchRel.GET(SalesLine."No.",SalesHeader."Website No.",SalesLine."Purchasing Code") THEN
                           IF ItemWebSitePurchRel."Shipping Agent"='UPS' THEN
                             EXIT(ItemWebSitePurchRel."Shipping Agent");

                       UNTIL SalesLine.NEXT=0;
                     //a/P0783/gob-sfe/31.01.13
                     IF SalesLine.FINDSET THEN
                       REPEAT
                         IF ItemWebSitePurchRel.GET(SalesLine."No.",SalesHeader."Website No.",SalesLine."Purchasing Code") THEN
                           //A/P0845
                           //IF ItemWebSitePurchRel."Shipping Agent"='DGB' THEN
                           IF ItemWebSitePurchRel."Shipping Agent"='DBG' THEN
                           //E/P0845
                             EXIT(ItemWebSitePurchRel."Shipping Agent");

                       UNTIL SalesLine.NEXT=0;
                     //e/P0783/gob-sfe/31.01.13

                     // H0866 20140218 DMA ++++++++++++++++++++++++++
                     IF SalesLine.FINDSET THEN
                       REPEAT
                         IF ItemWebSitePurchRel.GET(SalesLine."No.",SalesHeader."Website No.",SalesLine."Purchasing Code") THEN
                           IF ItemWebSitePurchRel."Shipping Agent"='TBP' THEN
                             EXIT(ItemWebSitePurchRel."Shipping Agent");

                       UNTIL SalesLine.NEXT=0;
                     // H0866 20140218 DMA --------------------------

                     FPCInterfaces.GET(Interface);
                     EXIT(FPCInterfaces."Default Shipping Agent");
                   END;
      END;
      //e/P0651/06.12.12/gob-sfe
      **********************End Old Code ******************************}
      //E/P1230
    END;

    PROCEDURE GetShippingAgentSalesLine@1000000015(SalesLine@1000000000 : Record 37;Interface@1000000001 : Code[10]) : Code[10];
    VAR
      DDLine@1000000002 : Record 50062;
      DDHeader@1000000003 : Record 50061;
    BEGIN
      //H1390,P0651 25.08.14 MSL +++++++++++++++++++++++++++++++++++
      CASE Interface OF
        'DOCDATA': BEGIN
          IF DDLine.GET(SalesLine."DD Entry No.") THEN
            //IF DDHeader.GET(DDLine."Header Entry No.") THEN
            //  EXIT(DDHeader."Shipping Agent Code");
            EXIT(DDLine."Shipping Agent Code");
        END;
      END;
      //H1390,P0651 25.08.14 MSL -----------------------------------
    END;

    PROCEDURE SetHideValidationDialog@1000000099();
    BEGIN
      HideValidationDialog := TRUE;
    END;

    PROCEDURE CreateDocDimForSalesHeader@1000000018(VAR ToSalesHeader@1000000001 : Record 36;VAR FromSalesHeader@1000000000 : Record 36);
    VAR
      DocDim@1000000004 : Record 357;
      FromDocDim@1000000003 : Record 357;
      DimensionValue@1000000002 : Record 349;
      locGeneralLedgerSetup@1000000005 : Record 98;
      locDimValue@1000000006 : Record 349;
    BEGIN
      //A/P0745
      locGeneralLedgerSetup.GET();

      DocDim.SETRANGE("Table ID",DATABASE::"Sales Header");
      DocDim.SETRANGE("Document Type",ToSalesHeader."Document Type");
      DocDim.SETRANGE("Document No.",ToSalesHeader."No.");
      DocDim.SETRANGE("Line No.",0);
      //A/gob-adb/15.05.13
      IF NOT DocDim.ISEMPTY THEN
      //E/gob-adb/15.05.13
      DocDim.DELETEALL;
      ToSalesHeader."Shortcut Dimension 1 Code" := FromSalesHeader."Shortcut Dimension 1 Code";
      ToSalesHeader."Shortcut Dimension 2 Code" := FromSalesHeader."Shortcut Dimension 2 Code";
      FromDocDim.SETRANGE("Table ID",DATABASE::"Sales Header");
      FromDocDim.SETRANGE("Document Type",FromSalesHeader."Document Type");
      FromDocDim.SETRANGE("Document No.",FromSalesHeader."No.");
      IF FromDocDim.FIND('-') THEN BEGIN
        REPEAT
          DocDim.INIT;
          DocDim."Table ID" := DATABASE::"Sales Header";
          DocDim."Document Type" := ToSalesHeader."Document Type";
          DocDim."Document No." := ToSalesHeader."No.";
          DocDim."Line No." := 0;

          IF FromDocDim."Dimension Code" = locGeneralLedgerSetup."Shortcut Dimension 3 Code" THEN
            IF NOT CheckIsOrderNo(FromDocDim."Dimension Value Code") THEN
              ERROR(Error022,FromDocDim."Dimension Code",FromSalesHeader."No.");

          DocDim."Dimension Value Code" := FromDocDim."Dimension Value Code";
          DocDim."Dimension Code" := FromDocDim."Dimension Code";

          DocDim.INSERT;
        UNTIL FromDocDim.NEXT = 0;
      END;


      DocDim.RESET;
      DocDim.SETRANGE("Table ID",DATABASE::"Sales Header");
      DocDim.SETRANGE("Document Type",ToSalesHeader."Document Type");
      DocDim.SETRANGE("Document No.",ToSalesHeader."No.");
      DocDim.SETRANGE("Line No.",0);
      DocDim.SETRANGE("Dimension Code",locGeneralLedgerSetup."Shortcut Dimension 3 Code");
      IF DocDim.ISEMPTY THEN BEGIN
        DocDim.INIT;
        DocDim."Table ID" := DATABASE::"Sales Header";
        DocDim."Document Type" := ToSalesHeader."Document Type";
        DocDim."Document No." := ToSalesHeader."No.";
        DocDim."Line No." := 0;
        DocDim."Dimension Code" := locGeneralLedgerSetup."Shortcut Dimension 3 Code";
        IF CheckIsOrderNo(FromSalesHeader."External Document No.") THEN BEGIN
          // S/P0809
          // Wenn Dimensionswert nicht existiert, dann lege ihn an
          IF NOT locDimValue.GET(locGeneralLedgerSetup."Shortcut Dimension 3 Code",FromSalesHeader."External Document No.") THEN BEGIN
            locDimValue.INIT;
            locDimValue."Dimension Code" := locGeneralLedgerSetup."Shortcut Dimension 3 Code";
            locDimValue.Code := FromSalesHeader."External Document No.";
            locDimValue.Name := 'Order ' + FromSalesHeader."External Document No.";
            locDimValue."Shortcut Dimension No." := 3;
            locDimValue.INSERT;
          END;
          // E/P0809
          DocDim."Dimension Value Code" := FromSalesHeader."External Document No.";
        END ELSE
          ERROR(Error022,DocDim."Dimension Code",FromSalesHeader."No.");
        DocDim.INSERT;
      END;
      DocDim.SETRANGE("Dimension Code",locGeneralLedgerSetup."Shortcut Dimension 4 Code");
      IF DocDim.ISEMPTY THEN BEGIN
        DocDim.INIT;
        DocDim."Table ID" := DATABASE::"Sales Header";
        DocDim."Document Type" := ToSalesHeader."Document Type";
        DocDim."Document No." := ToSalesHeader."No.";
        DocDim."Line No." := 0;
        DocDim."Dimension Code" := locGeneralLedgerSetup."Shortcut Dimension 4 Code";
        DocDim."Dimension Value Code" := FromSalesHeader."VAT Country/Region Code";
        DocDim.INSERT;
      END;
      //E/P0745
    END;

    PROCEDURE CreateDocDimForSalesLine@1000000019(toSalesLine@1000000001 : Record 37;FromSalesLine@1000000005 : Record 37);
    VAR
      DocDim@1000000004 : Record 357;
      FromDocDim@1000000003 : Record 357;
      DimensionValue@1000000002 : Record 349;
      locGeneralLedgerSetup@1000000000 : Record 98;
      locSalesHeader@1000000006 : Record 36;
      locDimValue@1000000007 : Record 349;
      locSkip@1000000008 : Boolean;
    BEGIN
      //A/P0745
      locGeneralLedgerSetup.GET();

      DocDim.SETRANGE("Table ID",DATABASE::"Sales Line");
      DocDim.SETRANGE("Document Type",toSalesLine."Document Type");
      DocDim.SETRANGE("Document No.",toSalesLine."Document No.");
      DocDim.SETRANGE("Line No.",toSalesLine."Line No.");
      //A/gob-adb/15.05.13
      IF NOT DocDim.ISEMPTY THEN
      //E/gob-adb/15.05.13
      DocDim.DELETEALL;
      toSalesLine."Shortcut Dimension 1 Code" := FromSalesLine."Shortcut Dimension 1 Code";
      toSalesLine."Shortcut Dimension 2 Code" := FromSalesLine."Shortcut Dimension 2 Code";
      FromDocDim.SETRANGE("Table ID",DATABASE::"Sales Line");
      FromDocDim.SETRANGE("Document Type",FromSalesLine."Document Type");
      FromDocDim.SETRANGE("Document No.",FromSalesLine."Document No.");
      FromDocDim.SETRANGE("Line No.",FromSalesLine."Line No.");
      IF FromDocDim.FIND('-') THEN BEGIN
        REPEAT
          // S/P1003
          CLEAR(locSkip);

          IF toSalesLine.Type = toSalesLine.Type::Resource THEN
            IF toSalesLine."Resource Type"IN[toSalesLine."Resource Type"::"Credit Bon",
                                             toSalesLine."Resource Type"::"Sales Bon",
                                             toSalesLine."Resource Type"::Groupon,
                                             toSalesLine."Resource Type"::"Daily Deal"] THEN
              IF FromDocDim."Dimension Code" = locGeneralLedgerSetup."Shortcut Dimension 2 Code" THEN
                locSkip := TRUE
              ELSE
                locSkip := FALSE;

          IF NOT locSkip THEN BEGIN
          // E/P1003
            DocDim.INIT;
            DocDim."Table ID" := DATABASE::"Sales Line";
            DocDim."Document Type" := toSalesLine."Document Type";
            DocDim."Document No." := toSalesLine."Document No.";
            DocDim."Line No." := toSalesLine."Line No.";

            IF FromDocDim."Dimension Code" = locGeneralLedgerSetup."Shortcut Dimension 3 Code" THEN
              IF NOT CheckIsOrderNo(FromDocDim."Dimension Value Code") THEN
                ERROR(Error021,FromDocDim."Dimension Code",FromSalesLine."Line No.");

            DocDim."Dimension Code" := FromDocDim."Dimension Code";
            DocDim."Dimension Value Code" := FromDocDim."Dimension Value Code";
            DocDim.INSERT;
          // S/P1003
          END;
          // E/P1003
        UNTIL FromDocDim.NEXT = 0;
      END;


      DocDim.RESET;
      DocDim.SETRANGE("Table ID",DATABASE::"Sales Line");
      DocDim.SETRANGE("Document Type",toSalesLine."Document Type");
      DocDim.SETRANGE("Document No.",toSalesLine."Document No.");
      DocDim.SETRANGE("Line No.",toSalesLine."Line No.");
      DocDim.SETRANGE("Dimension Code",locGeneralLedgerSetup."Shortcut Dimension 2 Code");
      IF DocDim.ISEMPTY THEN BEGIN
        // A/P1003
          IF toSalesLine.Type = toSalesLine.Type::Resource THEN
            IF toSalesLine."Resource Type"IN[toSalesLine."Resource Type"::"Credit Bon",
                                             toSalesLine."Resource Type"::"Sales Bon",
                                             toSalesLine."Resource Type"::Groupon,
                                             toSalesLine."Resource Type"::"Daily Deal"] THEN
               locSkip := TRUE
             ELSE
               locSkip := FALSE;

        IF NOT locSkip THEN BEGIN
        // E/P1003
          DocDim.INIT;
          DocDim."Table ID" := DATABASE::"Sales Line";
          DocDim."Document Type" := toSalesLine."Document Type";
          DocDim."Document No." := toSalesLine."Document No.";
          DocDim."Line No." := toSalesLine."Line No.";
          DocDim."Dimension Code" := locGeneralLedgerSetup."Shortcut Dimension 2 Code";
          DocDim."Dimension Value Code" := toSalesLine."No.";
          DocDim.INSERT;
        // A/P1003
        END;
        // E/P1003
      END;
      DocDim.SETRANGE("Dimension Code",locGeneralLedgerSetup."Shortcut Dimension 3 Code");
      IF DocDim.ISEMPTY THEN BEGIN
        DocDim.INIT;
        DocDim."Table ID" := DATABASE::"Sales Line";
        DocDim."Document Type" := toSalesLine."Document Type";
        DocDim."Document No." := toSalesLine."Document No.";
        DocDim."Line No." := toSalesLine."Line No.";
        DocDim."Dimension Code" := locGeneralLedgerSetup."Shortcut Dimension 3 Code";
        locSalesHeader.GET(toSalesLine."Document Type",toSalesLine."Document No.");
        IF CheckIsOrderNo(locSalesHeader."External Document No.") THEN BEGIN
          // A/P0809
          // Wenn Dimensionswert nicht existiert, dann lege ihn an
          IF NOT locDimValue.GET(locGeneralLedgerSetup."Shortcut Dimension 3 Code",locSalesHeader."External Document No.") THEN BEGIN
            locDimValue.INIT;
            locDimValue."Dimension Code" := locGeneralLedgerSetup."Shortcut Dimension 3 Code";
            locDimValue.Code := locSalesHeader."External Document No.";
            locDimValue.Name := 'Order ' + locSalesHeader."External Document No.";
            locDimValue."Shortcut Dimension No." := 3;
            locDimValue.INSERT;
          END;
        // E/P0809
          DocDim."Dimension Value Code" := locSalesHeader."External Document No.";
        END ELSE
          ERROR(Error021,DocDim."Dimension Code",FromSalesLine."Line No.");
        DocDim.INSERT;
      END;
      DocDim.SETRANGE("Dimension Code",locGeneralLedgerSetup."Shortcut Dimension 4 Code");
      IF DocDim.ISEMPTY THEN BEGIN
        DocDim.INIT;
        DocDim."Table ID" := DATABASE::"Sales Line";
        DocDim."Document Type" := toSalesLine."Document Type";
        DocDim."Document No." := toSalesLine."Document No.";
        DocDim."Line No." := toSalesLine."Line No.";
        DocDim."Dimension Code" := locGeneralLedgerSetup."Shortcut Dimension 4 Code";
        // S/P0930
        //locSalesHeader.GET(locSalesHeader."Document Type"::Order,toSalesLine."Document No.");
        locSalesHeader.GET(toSalesLine."Document Type",toSalesLine."Document No.");
        // E/P0930
        DocDim."Dimension Value Code" := locSalesHeader."VAT Country/Region Code";
        DocDim.INSERT;
      END;
      IF (toSalesLine."Purchasing Code" <> '') AND (toSalesLine.Type = toSalesLine.Type::Item) THEN BEGIN
        DocDim.SETRANGE("Dimension Code",locGeneralLedgerSetup."Shortcut Dimension 5 Code");
        IF DocDim.ISEMPTY THEN BEGIN
          DocDim.INIT;
          DocDim."Table ID" := DATABASE::"Sales Line";
          DocDim."Document Type" := toSalesLine."Document Type";
          DocDim."Document No." := toSalesLine."Document No.";
          DocDim."Line No." := toSalesLine."Line No.";
          DocDim."Dimension Code" := locGeneralLedgerSetup."Shortcut Dimension 5 Code";
          DocDim."Dimension Value Code" := toSalesLine."Purchasing Code";
          DocDim.INSERT;
        END;
      END;

      //E/P0745
    END;

    PROCEDURE CreateDocDimForSalesHeaderArch@1000000024(VAR ToSalesHeader@1000000001 : Record 36;VAR FromSalesHeaderArch@1000000000 : Record 5107);
    VAR
      DocDim@1000000004 : Record 357;
      FromDocDimArch@1000000003 : Record 5106;
      DimensionValue@1000000002 : Record 349;
      locGeneralLedgerSetup@1000000005 : Record 98;
      locWebDeskMgt@1000000006 : Codeunit 5327126;
      locDimValue@1000000007 : Record 349;
    BEGIN
      //A/P0745
      locGeneralLedgerSetup.GET();

      DocDim.SETRANGE("Table ID",DATABASE::"Sales Header");
      DocDim.SETRANGE("Document Type",ToSalesHeader."Document Type");
      DocDim.SETRANGE("Document No.",ToSalesHeader."No.");
      DocDim.SETRANGE("Line No.",0);
      //A/gob-adb/15.05.13
      IF NOT DocDim.ISEMPTY THEN
      //E/gob-adb/15.05.13
      DocDim.DELETEALL;
      ToSalesHeader."Shortcut Dimension 1 Code" := FromSalesHeaderArch."Shortcut Dimension 1 Code";
      ToSalesHeader."Shortcut Dimension 2 Code" := FromSalesHeaderArch."Shortcut Dimension 2 Code";
      FromDocDimArch.SETRANGE("Table ID",DATABASE::"Sales Header Archive");
      FromDocDimArch.SETRANGE("Document Type",FromSalesHeaderArch."Document Type");
      FromDocDimArch.SETRANGE("Document No.",FromSalesHeaderArch."No.");
      FromDocDimArch.SETRANGE("Doc. No. Occurrence",FromSalesHeaderArch."Doc. No. Occurrence");
      FromDocDimArch.SETRANGE("Version No.",FromSalesHeaderArch."Version No.");
      IF FromDocDimArch.FIND('-') THEN BEGIN
        REPEAT
          DocDim.INIT;
          DocDim."Table ID" := DATABASE::"Sales Header";
          DocDim."Document Type" := ToSalesHeader."Document Type";
          DocDim."Document No." := ToSalesHeader."No.";
          DocDim."Line No." := 0;

          IF FromDocDimArch."Dimension Code" = locGeneralLedgerSetup."Shortcut Dimension 3 Code" THEN
            IF NOT CheckIsOrderNo(FromDocDimArch."Dimension Value Code") THEN
              IF ISSERVICETIER THEN
                locWebDeskMgt.MESSAGE2(Error024,FromDocDimArch."Dimension Code",FromSalesHeaderArch."No.")
              ELSE
                MESSAGE(Error022,FromDocDimArch."Dimension Code",FromSalesHeaderArch."No.");
          DocDim."Dimension Value Code" := FromDocDimArch."Dimension Value Code";
          DocDim."Dimension Code" := FromDocDimArch."Dimension Code";

          DocDim.INSERT;
        UNTIL FromDocDimArch.NEXT = 0;
      END;

      DocDim.RESET;
      DocDim.SETRANGE("Table ID",DATABASE::"Sales Header");
      DocDim.SETRANGE("Document Type",ToSalesHeader."Document Type");
      DocDim.SETRANGE("Document No.",ToSalesHeader."No.");
      DocDim.SETRANGE("Line No.",0);
      DocDim.SETRANGE("Dimension Code",locGeneralLedgerSetup."Shortcut Dimension 3 Code");
      IF DocDim.ISEMPTY THEN BEGIN
        DocDim.INIT;
        DocDim."Table ID" := DATABASE::"Sales Header";
        DocDim."Document Type" := ToSalesHeader."Document Type";
        DocDim."Document No." := ToSalesHeader."No.";
        DocDim."Line No." := 0;
        DocDim."Dimension Code" := locGeneralLedgerSetup."Shortcut Dimension 3 Code";

        IF CheckIsOrderNo(FromSalesHeaderArch."External Document No.") THEN BEGIN
          // A/P0809
          // Wenn Dimensionswert nicht existiert, dann lege ihn an
          IF NOT locDimValue.GET(locGeneralLedgerSetup."Shortcut Dimension 3 Code",FromSalesHeaderArch."External Document No.") THEN
      BEGIN
            locDimValue.INIT;
            locDimValue."Dimension Code" := locGeneralLedgerSetup."Shortcut Dimension 3 Code";
            locDimValue.Code := FromSalesHeaderArch."External Document No.";
            locDimValue.Name := 'Order ' + FromSalesHeaderArch."External Document No.";
            locDimValue."Shortcut Dimension No." := 3;
            locDimValue.INSERT;
          END;
          // E/P0809
          DocDim."Dimension Value Code" := FromSalesHeaderArch."External Document No.";
        END ELSE BEGIN
          IF CheckIsOrderNo(ToSalesHeader."External Document No.") THEN BEGIN
            // A/P0809
            // Wenn Dimensionswert nicht existiert, dann lege ihn an
            IF NOT locDimValue.GET(locGeneralLedgerSetup."Shortcut Dimension 3 Code",ToSalesHeader."External Document No.") THEN BEGIN
              locDimValue.INIT;
              locDimValue."Dimension Code" := locGeneralLedgerSetup."Shortcut Dimension 3 Code";
              locDimValue.Code := ToSalesHeader."External Document No.";
              locDimValue.Name := 'Order ' + ToSalesHeader."External Document No.";
              locDimValue."Shortcut Dimension No." := 3;
              locDimValue.INSERT;
            END;
            // E/P0809
            DocDim."Dimension Value Code" := ToSalesHeader."External Document No."
          END ELSE BEGIN
            IF ISSERVICETIER THEN
              locWebDeskMgt.MESSAGE2(Error024,DocDim."Dimension Code",FromSalesHeaderArch."No.")
            ELSE
              MESSAGE(Error024,DocDim."Dimension Code",FromSalesHeaderArch."No.");
          END;
        END;

        {
        IF CheckIsOrderNo(FromSalesHeaderArch."External Document No.") THEN
          DocDim."Dimension Value Code" := FromSalesHeaderArch."External Document No."
        ELSE
          IF ISSERVICETIER THEN
            locWebDeskMgt.MESSAGE2(Error024,DocDim."Dimension Code",FromSalesHeaderArch."No.")
          ELSE
            MESSAGE(Error024,DocDim."Dimension Code",FromSalesHeaderArch."No.");
        }

        DocDim.INSERT;
      END;
      DocDim.SETRANGE("Dimension Code",locGeneralLedgerSetup."Shortcut Dimension 4 Code");
      IF DocDim.ISEMPTY THEN BEGIN
        DocDim.INIT;
        DocDim."Table ID" := DATABASE::"Sales Header";
        DocDim."Document Type" := ToSalesHeader."Document Type";
        DocDim."Document No." := ToSalesHeader."No.";
        DocDim."Line No." := 0;
        DocDim."Dimension Code" := locGeneralLedgerSetup."Shortcut Dimension 4 Code";
        DocDim."Dimension Value Code" := FromSalesHeaderArch."VAT Country/Region Code";
        DocDim.INSERT;
      END;
      //E/P0745
    END;

    PROCEDURE CreateDocDimForSalesLineArch@1000000023(toSalesLine@1000000001 : Record 37;FromSalesLineArch@1000000005 : Record 5108);
    VAR
      DocDim@1000000004 : Record 357;
      FromDocDimArch@1000000003 : Record 5106;
      DimensionValue@1000000002 : Record 349;
      locGeneralLedgerSetup@1000000000 : Record 98;
      locSalesHeader@1000000006 : Record 36;
      locWebDeskMgt@1000000007 : Codeunit 5327126;
      locDimValue@1000000008 : Record 349;
      FromSalesHeaderArch@1000000009 : Record 5107;
      locSkip@1000000010 : Boolean;
    BEGIN
      //A/P0745
      locGeneralLedgerSetup.GET();

      DocDim.SETRANGE("Table ID",DATABASE::"Sales Line");
      DocDim.SETRANGE("Document Type",toSalesLine."Document Type");
      DocDim.SETRANGE("Document No.",toSalesLine."Document No.");
      DocDim.SETRANGE("Line No.",toSalesLine."Line No.");
      //A/gob-adb/15.05.13
      IF NOT DocDim.ISEMPTY THEN
      //E/gob-adb/15.05.13
      DocDim.DELETEALL;
      toSalesLine."Shortcut Dimension 1 Code" := FromSalesLineArch."Shortcut Dimension 1 Code";
      toSalesLine."Shortcut Dimension 2 Code" := FromSalesLineArch."Shortcut Dimension 2 Code";
      FromDocDimArch.SETRANGE("Table ID",DATABASE::"Sales Line Archive");
      FromDocDimArch.SETRANGE("Document Type",FromSalesLineArch."Document Type");
      FromDocDimArch.SETRANGE("Document No.",FromSalesLineArch."Document No.");
      FromDocDimArch.SETRANGE("Line No.",FromSalesLineArch."Line No.");
      FromDocDimArch.SETRANGE("Doc. No. Occurrence",FromSalesLineArch."Doc. No. Occurrence");
      FromDocDimArch.SETRANGE("Version No.",FromSalesLineArch."Version No.");
      IF FromDocDimArch.FIND('-') THEN BEGIN
        REPEAT
          // S/P1003
          CLEAR(locSkip);

          IF toSalesLine.Type = toSalesLine.Type::Resource THEN
            IF toSalesLine."Resource Type"IN[toSalesLine."Resource Type"::"Credit Bon",
                                             toSalesLine."Resource Type"::"Sales Bon",
                                             toSalesLine."Resource Type"::Groupon,
                                             toSalesLine."Resource Type"::"Daily Deal"] THEN
              IF FromDocDimArch."Dimension Code" = locGeneralLedgerSetup."Shortcut Dimension 2 Code" THEN
                locSkip := TRUE
              ELSE
                locSkip := FALSE;

          IF NOT locSkip THEN BEGIN
          // E/P1003
            DocDim.INIT;
            DocDim."Table ID" := DATABASE::"Sales Line";
            DocDim."Document Type" := toSalesLine."Document Type";
            DocDim."Document No." := toSalesLine."Document No.";
            DocDim."Line No." := toSalesLine."Line No.";

            IF FromDocDimArch."Dimension Code" = locGeneralLedgerSetup."Shortcut Dimension 3 Code" THEN
              IF NOT CheckIsOrderNo(FromDocDimArch."Dimension Value Code") THEN
                IF ISSERVICETIER THEN
                  locWebDeskMgt.MESSAGE2(Error023,FromDocDimArch."Dimension Code",FromSalesLineArch."Line No.")
                ELSE
                  MESSAGE(Error023,FromDocDimArch."Dimension Code",FromSalesLineArch."Line No.");
            DocDim."Dimension Code" := FromDocDimArch."Dimension Code";
            DocDim."Dimension Value Code" := FromDocDimArch."Dimension Value Code";
            DocDim.INSERT;
          // S/P1003
          END;
          // E/P1003
        UNTIL FromDocDimArch.NEXT = 0;
      END;

      DocDim.RESET;
      DocDim.SETRANGE("Table ID",DATABASE::"Sales Line");
      DocDim.SETRANGE("Document Type",toSalesLine."Document Type");
      DocDim.SETRANGE("Document No.",toSalesLine."Document No.");
      DocDim.SETRANGE("Line No.",toSalesLine."Line No.");
      DocDim.SETRANGE("Dimension Code",locGeneralLedgerSetup."Shortcut Dimension 2 Code");
      IF DocDim.ISEMPTY THEN BEGIN
        // S/P1003
        // A/P1003
          IF toSalesLine.Type = toSalesLine.Type::Resource THEN
            IF toSalesLine."Resource Type"IN[toSalesLine."Resource Type"::"Credit Bon",
                                             toSalesLine."Resource Type"::"Sales Bon",
                                             toSalesLine."Resource Type"::Groupon,
                                             toSalesLine."Resource Type"::"Daily Deal"] THEN
               locSkip := TRUE
             ELSE
               locSkip := FALSE;

        IF NOT locSkip THEN BEGIN
        // E/P1003
          DocDim.INIT;
          DocDim."Table ID" := DATABASE::"Sales Line";
          DocDim."Document Type" := toSalesLine."Document Type";
          DocDim."Document No." := toSalesLine."Document No.";
          DocDim."Line No." := toSalesLine."Line No.";
          DocDim."Dimension Code" := locGeneralLedgerSetup."Shortcut Dimension 2 Code";
          DocDim."Dimension Value Code" := toSalesLine."No.";
          DocDim.INSERT;
        // S/P1003
        END;
        // E/P1003
      END;
      DocDim.SETRANGE("Dimension Code",locGeneralLedgerSetup."Shortcut Dimension 3 Code");
      IF DocDim.ISEMPTY THEN BEGIN
        DocDim.INIT;
        DocDim."Table ID" := DATABASE::"Sales Line";
        DocDim."Document Type" := toSalesLine."Document Type";
        DocDim."Document No." := toSalesLine."Document No.";
        DocDim."Line No." := toSalesLine."Line No.";
        DocDim."Dimension Code" := locGeneralLedgerSetup."Shortcut Dimension 3 Code";
        locSalesHeader.GET(toSalesLine."Document Type",toSalesLine."Document No.");
        IF CheckIsOrderNo(locSalesHeader."External Document No.") THEN
        // A/P0809
        BEGIN
          // Wenn Dimensionswert nicht existiert, dann lege ihn an
          IF NOT locDimValue.GET(locGeneralLedgerSetup."Shortcut Dimension 3 Code",locSalesHeader."External Document No.") THEN BEGIN
            locDimValue.INIT;
            locDimValue."Dimension Code" := locGeneralLedgerSetup."Shortcut Dimension 3 Code";
            locDimValue.Code := locSalesHeader."External Document No.";
            locDimValue.Name := 'Order ' + locSalesHeader."External Document No.";
            locDimValue."Shortcut Dimension No." := 3;
            locDimValue.INSERT;
          END;
        // E/P0809
          DocDim."Dimension Value Code" := locSalesHeader."External Document No.";
        // A/P0809
        END
        // E/P0809
        ELSE
          IF ISSERVICETIER THEN
            locWebDeskMgt.MESSAGE2(Error023,DocDim."Dimension Code",FromSalesLineArch."Line No.")
          ELSE
            MESSAGE(Error023,DocDim."Dimension Code",FromSalesLineArch."Line No.");
        DocDim.INSERT;
      END;
      DocDim.SETRANGE("Dimension Code",locGeneralLedgerSetup."Shortcut Dimension 4 Code");
      IF DocDim.ISEMPTY THEN BEGIN
        DocDim.INIT;
        DocDim."Table ID" := DATABASE::"Sales Line";
        DocDim."Document Type" := toSalesLine."Document Type";
        DocDim."Document No." := toSalesLine."Document No.";
        DocDim."Line No." := toSalesLine."Line No.";
        DocDim."Dimension Code" := locGeneralLedgerSetup."Shortcut Dimension 4 Code";

        // A/P0877
        // locSalesHeader.GET(locSalesHeader."Document Type"::Order,toSalesLine."Document No.");
        // DocDim."Dimension Value Code" := locSalesHeader."VAT Country/Region Code";
        FromSalesHeaderArch.GET(FromSalesLineArch."Document Type",
                                FromSalesLineArch."Document No.",
                                FromSalesLineArch."Doc. No. Occurrence",
                                FromSalesLineArch."Version No.");

        DocDim."Dimension Value Code" := FromSalesHeaderArch."VAT Country/Region Code";
        // A/P0877

        DocDim.INSERT;

      END;
      IF (toSalesLine."Purchasing Code" <> '') AND (toSalesLine.Type = toSalesLine.Type::Item) THEN BEGIN
        DocDim.SETRANGE("Dimension Code",locGeneralLedgerSetup."Shortcut Dimension 5 Code");
        IF DocDim.ISEMPTY THEN BEGIN
          DocDim.INIT;
          DocDim."Table ID" := DATABASE::"Sales Line";
          DocDim."Document Type" := toSalesLine."Document Type";
          DocDim."Document No." := toSalesLine."Document No.";
          DocDim."Line No." := toSalesLine."Line No.";
          DocDim."Dimension Code" := locGeneralLedgerSetup."Shortcut Dimension 5 Code";
          DocDim."Dimension Value Code" := toSalesLine."Purchasing Code";
          DocDim.INSERT;
        END;
      END;

      //E/P0745
    END;

    PROCEDURE CheckIsOrderNo@1000000022(pOrderNo@1000000000 : Code[20]) : Boolean;
    VAR
      locSalesHeader@1000000001 : Record 36;
      locSalesHeaderArch@1000000002 : Record 5107;
    BEGIN
      //A/P0745
      IF pOrderNo = '' THEN
        EXIT(FALSE);

      locSalesHeader.RESET;
      locSalesHeader.SETRANGE("Document Type",locSalesHeader."Document Type"::Order);
      locSalesHeader.SETRANGE("No.",pOrderNo);
      IF NOT locSalesHeader.ISEMPTY THEN
        EXIT(TRUE);

      locSalesHeaderArch.RESET;
      locSalesHeaderArch.SETRANGE("Document Type",locSalesHeaderArch."Document Type"::Order);
      locSalesHeaderArch.SETRANGE("No.",pOrderNo);
      IF NOT locSalesHeaderArch.ISEMPTY THEN
        EXIT(TRUE);
      //E/P0745
    END;

    PROCEDURE ShowStatusDescription@1000000016(PurchasingCode_p@1000000000 : Code[10];DocumentNo_p@1000000001 : Code[20];DocumentLineNo_p@1000000006 : Integer;DHLShipmentNo_p@1000000007 : Code[40];StatusEventCode_p@1000000008 : Code[20];StatusCode_p@1000000009 : Code[20]) StatusDescription : Text[250];
    VAR
      DHLStatus_l@1000000005 : Record 50028;
      RhenusStatus_l@1000000004 : Record 50016;
      Purchasing_l@1000000003 : Record 5721;
      DHLParcelsStatusHistory_l@1000000002 : Record 50021;
      DHLParcelsStatusHistory@1000000010 : Record 50021;
      FPCGeneralSetup@1000000011 : Record 50055;
      ParcelStatusHistoryMgmt@1000000012 : Codeunit 80011;
      StatusText@1000000013 : Text[250];
    BEGIN
      //S/P1133
      FPCGeneralSetup.GET;
      // S/P1156
      FPCGeneralSetup.TESTFIELD("Purchasing Code FB CD-AT");
      FPCGeneralSetup.TESTFIELD("Purchasing Code GB CD-AT");
      FPCGeneralSetup.TESTFIELD("Purchasing Code FB CD-GER");
      FPCGeneralSetup.TESTFIELD("Purchasing Code GB CD-GER");
      FPCGeneralSetup.TESTFIELD("Purchasing Code FB CD-NL");
      FPCGeneralSetup.TESTFIELD("Purchasing Code GB CD-NL");
      FPCGeneralSetup.TESTFIELD("Purchasing Code FB CD-FRA");
      FPCGeneralSetup.TESTFIELD("Purchasing Code GB CD-FRA");
      FPCGeneralSetup.TESTFIELD("Purchasing Code 99 CD-GER");
      FPCGeneralSetup.TESTFIELD("Purchasing Code 99 CD-AT");
      FPCGeneralSetup.TESTFIELD("Purchasing Code 99 CD-NL");
      FPCGeneralSetup.TESTFIELD("Purchasing Code 99 CD-FRA");
      // S/P1156
      // S/P1194
      FPCGeneralSetup.TESTFIELD("Purchasing Code FB CD-CH");
      FPCGeneralSetup.TESTFIELD("Purchasing Code GB CD-CH");
      FPCGeneralSetup.TESTFIELD("Purchasing Code 99 CD-CH");
      // E/P1194

      //H1368 22.07.14 DMA +++++++++++++++++++++++++++++++++
      FPCGeneralSetup.TESTFIELD("Purchasing Code FB CD-BE");
      FPCGeneralSetup.TESTFIELD("Purchasing Code GB CD-BE");
      FPCGeneralSetup.TESTFIELD("Purchasing Code 99 CD-BE");
      //H1368 22.07.14 DMA ---------------------------------

      CASE FPCGeneralSetup."Active Parcel Status History" OF
        FPCGeneralSetup."Active Parcel Status History"::"Use Only Old DHL Parcel Status History",
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use Old":
          BEGIN
      //E/P1133

            // H0345 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
            {
            Deprecated code BEGIN;
             IF PurchasingCode_p IN ['FRA-1','FRA-2','FRA-9','FRA-10','FRA-11','FRA-98','FRA-99'] THEN BEGIN
               IF Purchasing_l.GET(PurchasingCode_p) THEN BEGIN
                 DHLParcelsStatusHistory_l.SETCURRENTKEY(
                   "Sale Order Code","Line No.","Current Status","Time Stamp","DHL Shipment Code");
                 DHLParcelsStatusHistory_l.SETRANGE("Sale Order Code",DocumentNo_p);
                 DHLParcelsStatusHistory_l.SETRANGE("Sales Doc Type",DHLParcelsStatusHistory_l."Sales Doc Type"::Order);
                 DHLParcelsStatusHistory_l.SETRANGE("Line No.",DocumentLineNo_p);
                 DHLParcelsStatusHistory_l.SETRANGE("Shipping Agent",'VIR');
                 IF DHLParcelsStatusHistory_l.FINDLAST THEN
                   IF DHLStatus_l.GET(DHLParcelsStatusHistory_l."Status Event",DHLParcelsStatusHistory_l."Status Code") THEN
                     EXIT(DHLStatus_l."Status RIC Name");
               END;
             END;

             //H0182 30.01.13 ARU +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
             IF (Purchasing_l.GET(PurchasingCode_p)) AND NOT (Purchasing_l."Use New Order Status") THEN BEGIN
               IF PurchasingCode_p IN ['GER-7','GER-8','GER-99','FRA-7','FRA-8','FRA-99','NL-7','NL-8','NL-99','AT-99'] THEN BEGIN
                 DHLParcelsStatusHistory_l.SETCURRENTKEY(
                   "Sale Order Code","Line No.","Current Status","Time Stamp","DHL Shipment Code","Rhenus Entry");
                 DHLParcelsStatusHistory_l.SETRANGE("Sale Order Code", DocumentNo_p);
                 DHLParcelsStatusHistory_l.SETRANGE("Sales Doc Type",DHLParcelsStatusHistory_l."Sales Doc Type"::Order);
                 DHLParcelsStatusHistory_l.SETRANGE("Line No.", DocumentLineNo_p);
                 DHLParcelsStatusHistory_l.SETRANGE(DHLParcelsStatusHistory_l."Status Drop Shipment", TRUE);
                 IF DHLParcelsStatusHistory_l.FINDLAST THEN
                   EXIT(DHLParcelsStatusHistory_l."Drop Shipment Status Desc.");
               END;
             END;

             IF (Purchasing_l.GET(PurchasingCode_p)) THEN BEGIN
               CASE PurchasingCode_p OF
                 'GER-4': BEGIN
                   DHLParcelsStatusHistory_l.SETCURRENTKEY(
                     "Sale Order Code","Line No.","Current Status","Time Stamp","DHL Shipment Code","Rhenus Entry");
                   DHLParcelsStatusHistory_l.SETRANGE("Sale Order Code", DocumentNo_p);
                   DHLParcelsStatusHistory_l.SETRANGE("Sales Doc Type", DHLParcelsStatusHistory_l."Sales Doc Type"::Order);
                   DHLParcelsStatusHistory_l.SETRANGE("Line No.", DocumentLineNo_p);
                   DHLParcelsStatusHistory_l.SETRANGE("Status DHL HD",TRUE);
                   IF DHLParcelsStatusHistory_l.FINDLAST THEN
                     EXIT(DHLParcelsStatusHistory_l."DHL HD Status Description");
                 END;

                 //H0216 18.13.13 PAU +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
                 'GER-9','NL-9','FRA-9','AT-9': BEGIN
                   IF Purchasing_l.GET(PurchasingCode_p) THEN BEGIN
                     DHLParcelsStatusHistory_l.SETCURRENTKEY(
                       "Sale Order Code","Line No.","Current Status","Time Stamp","DHL Shipment Code");
                     DHLParcelsStatusHistory_l.SETRANGE("Sale Order Code",DocumentNo_p);
                     DHLParcelsStatusHistory_l.SETRANGE("Sales Doc Type",DHLParcelsStatusHistory_l."Sales Doc Type"::Order);
                     DHLParcelsStatusHistory_l.SETRANGE("Line No.",DocumentLineNo_p);
                     DHLParcelsStatusHistory_l.SETRANGE("Shipping Agent",'UPS');
                     DHLParcelsStatusHistory_l.SETRANGE("Docdate Status Code",'21');
                     IF DHLParcelsStatusHistory_l.FINDLAST THEN BEGIN
                       IF DHLStatus_l.GET(DHLParcelsStatusHistory_l."Status Event",DHLParcelsStatusHistory_l."Status Code") THEN
                         EXIT(DHLStatus_l."Status Event Name");
                     END ELSE BEGIN
                       DHLParcelsStatusHistory_l.RESET;
                       DHLParcelsStatusHistory_l.SETCURRENTKEY(
                         "Sale Order Code","Line No.","Current Status","Time Stamp","DHL Shipment Code");
                       DHLParcelsStatusHistory_l.SETRANGE("Sale Order Code", DocumentNo_p);
                       DHLParcelsStatusHistory_l.SETRANGE("Sales Doc Type", DHLParcelsStatusHistory_l."Sales Doc Type"::Order);
                       DHLParcelsStatusHistory_l.SETRANGE("Line No.", DocumentLineNo_p);
                       IF DHLParcelsStatusHistory_l.FINDLAST THEN BEGIN
                         IF DHLParcelsStatusHistory_l."Shipment through" = DHLParcelsStatusHistory_l."Shipment through"::DocData THEN
                           EXIT(DHLParcelsStatusHistory_l."Docdata Status Description")
                         ELSE BEGIN
                           DHLParcelsStatusHistory_l.CALCFIELDS("Status Event Name");
                           EXIT(DHLParcelsStatusHistory_l."Status Event Name");
                         END;
                       END;
                     END;
                   END;
                 //H0216 18.13.13 PAU -----------------------------------------------------------------------------------------

                 // H0345 >>>
                 END ELSE BEGIN // For all the rest of cases
                   DHLParcelsStatusHistory_l.RESET;
                   DHLParcelsStatusHistory_l.SETCURRENTKEY(
                     "Sale Order Code","Line No.","Current Status","Time Stamp","DHL Shipment Code");
                   DHLParcelsStatusHistory_l.SETRANGE("Sale Order Code", DocumentNo_p);
                   DHLParcelsStatusHistory_l.SETRANGE("Sales Doc Type", DHLParcelsStatusHistory_l."Sales Doc Type"::Order);
                   DHLParcelsStatusHistory_l.SETRANGE("Line No.", DocumentLineNo_p);
                   IF DHLParcelsStatusHistory_l.FINDLAST THEN BEGIN
                     IF DHLParcelsStatusHistory_l."Shipment through" = DHLParcelsStatusHistory_l."Shipment through"::DocData THEN
                       EXIT(DHLParcelsStatusHistory_l."Docdata Status Description")
                     ELSE BEGIN
                       DHLParcelsStatusHistory_l.CALCFIELDS("Status Event Name");
                       IF DHLParcelsStatusHistory_l."Status Event Name" <> '' THEN
                         EXIT(DHLParcelsStatusHistory_l."Status Event Name");
                       DHLParcelsStatusHistory_l.CALCFIELDS("Rhenus Status Description");
                       IF DHLParcelsStatusHistory_l."Rhenus Status Description" <> '' THEN
                         EXIT(DHLParcelsStatusHistory_l."Rhenus Status Description");
                     END;
                   END;
                 END;
                 // H0345 <<<
               END;

             END ELSE BEGIN  // In case the Purchasing Code does not exist ??!!
               IF DHLShipmentNo_p <> '' THEN BEGIN
                 DHLStatus_l.SETRANGE(DHLStatus_l."Status Event Code", StatusEventCode_p);
                 IF DHLStatus_l.FINDFIRST THEN
                   EXIT(DHLStatus_l."Status Event Name");
               END ELSE BEGIN
                 IF RhenusStatus_l.GET(StatusCode_p) THEN
                   EXIT(RhenusStatus_l.Description);
               END;
             END;
             //H0182 30.01.13 ARU -----------------------------------------------------------------------------------------

             //H0216 18.13.13 PAU +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
             IF Purchasing_l.GET(PurchasingCode_p) THEN BEGIN
               DHLParcelsStatusHistory_l.SETCURRENTKEY(
               "Sale Order Code","Line No.","Current Status","Time Stamp","DHL Shipment Code");
               DHLParcelsStatusHistory_l.SETRANGE("Sale Order Code",DocumentNo_p);
               DHLParcelsStatusHistory_l.SETRANGE("Sales Doc Type",DHLParcelsStatusHistory_l."Sales Doc Type"::Order);
               DHLParcelsStatusHistory_l.SETRANGE("Line No.",DocumentLineNo_p);
               DHLParcelsStatusHistory_l.SETRANGE("Shipping Agent",'UPS');
               DHLParcelsStatusHistory_l.SETRANGE("Docdate Status Code",'21');
               IF DHLParcelsStatusHistory_l.FINDLAST THEN
                 IF DHLStatus_l.GET(DHLParcelsStatusHistory_l."Status Event",DHLParcelsStatusHistory_l."Status Code") THEN
                   EXIT(DHLStatus_l."Status Event Name");
             END;
             //H0216 18.13.13 PAU -----------------------------------------------------------------------------------------
            Deprecated code END;
            }

            DHLParcelsStatusHistory.SETCURRENTKEY(
              "Document No.","Document Line No.","Current Status","Time Stamp","DHL Shipment Code");
            DHLParcelsStatusHistory.SETRANGE("Document No.", DocumentNo_p);
            DHLParcelsStatusHistory.SETRANGE("Document Line No.", DocumentLineNo_p);
            IF DHLParcelsStatusHistory.FINDLAST THEN BEGIN
              DHLParcelsStatusHistory.CALCFIELDS("Rhenus Status Description");
              DHLParcelsStatusHistory.CALCFIELDS("Status Event Name");
              CASE PurchasingCode_p OF
                'GER-4':
                  EXIT(COPYSTR(DHLParcelsStatusHistory."DHL HD Status Description", 1, 250));
                // S/P1156
                // 'AT-1','AT-10','AT-98','AT-99','GER-1','GER-10','GER-3','GER-98','GER-99','NL-1','NL-10','NL-98','NL-99':
                'AT-1','AT-10',FPCGeneralSetup."Purchasing Code FB CD-AT",FPCGeneralSetup."Purchasing Code GB CD-AT",
                               FPCGeneralSetup."Purchasing Code 99 CD-AT",
                'GER-1','GER-10','GER-3',FPCGeneralSetup."Purchasing Code FB CD-GER",FPCGeneralSetup."Purchasing Code GB CD-GER",
                                         FPCGeneralSetup."Purchasing Code 99 CD-GER",
                // S/P1194
                // S/P1201
                //'CH-1','CH-10',FPCGeneralSetup."Purchasing Code FB CD-CH",FPCGeneralSetup."Purchasing Code GB CD-CH",
                'CH-1','CH-10','CH-3',FPCGeneralSetup."Purchasing Code FB CD-CH",FPCGeneralSetup."Purchasing Code GB CD-CH",
                // E/P1201
                                         FPCGeneralSetup."Purchasing Code 99 CD-CH",
                // E/P1194
                'NL-1','NL-10',FPCGeneralSetup."Purchasing Code FB CD-NL",FPCGeneralSetup."Purchasing Code GB CD-NL",
                               FPCGeneralSetup."Purchasing Code 99 CD-NL":
                // S/P1156
                  EXIT(COPYSTR(DHLParcelsStatusHistory."Rhenus Status Description", 1, 250));
                // S/P1156
                // 'FRA-1','FRA-10','FRA-98','FRA-99':
                'FRA-1','FRA-10',FPCGeneralSetup."Purchasing Code FB CD-FRA",FPCGeneralSetup."Purchasing Code GB CD-FRA",
                                 FPCGeneralSetup."Purchasing Code 99 CD-FRA":
                // E/P1156
                  EXIT(COPYSTR(DHLParcelsStatusHistory."Rhenus Status Description" + ' ' +
                    DHLParcelsStatusHistory."VIR Status Comment", 1, 250));
                'AT-12','AT-7','FRA-12','FRA-7','GER-12','GER-7','NL-12','NL-7','GER-13','AT-13','NL-13','FRA-13':
                  EXIT(COPYSTR(DHLParcelsStatusHistory."Status Event Name", 1, 250));
                // S/P1201
                //'AT-9','FRA-9','GER-9','NL-9':
                'AT-9','FRA-9','GER-9','NL-9','CH-9':
                // E/P1201
                  EXIT(COPYSTR(DHLParcelsStatusHistory."Status Event Name" + ' ' +
                    DHLParcelsStatusHistory."Docdata Status Description", 1, 250));
                // S/P1201
                //'AT-11','AT-2','GER-11','GER-2','NL-11','NL-2':
                'AT-11','AT-2','GER-11','GER-2','NL-11','NL-2','CH-11','CH-2':
                // E/P1201
                  EXIT(COPYSTR(DHLParcelsStatusHistory."Status Event Name" + ' ' +
                    DHLParcelsStatusHistory."Rhenus Status Description", 1, 250));
                'FRA-11','FRA-2':
                EXIT(COPYSTR(DHLParcelsStatusHistory."Status Event Name"  + ' ' +
                  DHLParcelsStatusHistory."Rhenus Status Description" + ' ' +
                  DHLParcelsStatusHistory."VIR Status Comment", 1, 250));
                //H1368 22.07.14 DMA +++++++++++++++++++++++++++++++++++++++++++++++
                'BE-1','BE-10',FPCGeneralSetup."Purchasing Code FB CD-BE",FPCGeneralSetup."Purchasing Code GB CD-BE",
                               FPCGeneralSetup."Purchasing Code 99 CD-BE":
                  EXIT(COPYSTR(DHLParcelsStatusHistory."Rhenus Status Description", 1, 250));
                'BE-12','BE-7','BE-13':
                  EXIT(COPYSTR(DHLParcelsStatusHistory."Status Event Name", 1, 250));
                'BE-9':
                  EXIT(COPYSTR(DHLParcelsStatusHistory."Status Event Name" + ' ' +
                    DHLParcelsStatusHistory."Docdata Status Description", 1, 250));
                'BE-2','BE-11':
                  EXIT(COPYSTR(DHLParcelsStatusHistory."Status Event Name" + ' ' +
                    DHLParcelsStatusHistory."Rhenus Status Description", 1, 250));
                //H1368 22.07.14 DMA -----------------------------------------------

              END;
            END;

            // H0345 ------------------------------------------------------------------------------------------------------
      //S/P1133
          END;
        FPCGeneralSetup."Active Parcel Status History"::"Fill Both But Show And Use New",
        FPCGeneralSetup."Active Parcel Status History"::"Use Only New Parcel Status History":
          BEGIN
            StatusText :=
              ParcelStatusHistoryMgmt.GetLastStatusDescription(
                37,1,DocumentNo_p,DocumentLineNo_p,'','',0);
            IF StatusText = '' THEN
              StatusText :=
                ParcelStatusHistoryMgmt.GetLastStatusDescription(
                  5108,1,DocumentNo_p,DocumentLineNo_p,'','',0);
            EXIT(StatusText);
          END;
      END;
      //E/P1133
    END;

    PROCEDURE SetChangeOrderNo@1000000017(DocNo@1000000000 : Code[20]);
    BEGIN
      // A/P0836
      ChangeOrderNo := DocNo;
      // E/P0836
    END;

    PROCEDURE GetChangeOrderNo@1000000020() : Code[20];
    BEGIN
      // A/P0836
      EXIT(ChangeOrderNo);
      // E/P0836
    END;

    PROCEDURE GetShippingAgentSalesLineArch@1000000021(pSalesLineArchive@1000000000 : Record 5108;Interface@1000000001 : Code[10]) : Code[10];
    VAR
      DDLine@1000000002 : Record 50062;
      DDHeader@1000000003 : Record 50061;
    BEGIN
      //H1390,P0864 25.08.14 MSL +++++++++++++++++++++++++++++++++++
      CASE Interface OF
        'DOCDATA': BEGIN
          IF DDLine.GET(pSalesLineArchive."DD Entry No.") THEN
            //IF DDHeader.GET(DDLine."Header Entry No.") THEN
            //  EXIT(DDHeader."Shipping Agent Code");
            EXIT(DDLine."Shipping Agent Code");
        END;
      END;
      //H1390,P0864 25.08.14 MSL -----------------------------------
    END;

    PROCEDURE "***HME************************"@1000000053();
    BEGIN
    END;

    PROCEDURE CheckItemChargeAssignment@1000000029(SalesLineV@1000000000 : Record 37) : Boolean;
    VAR
      ItemChargeAssignmentSalesL@1000000001 : Record 5809;
    BEGIN
      // CheckItemChargeAssignment
      //H0636 25.11.13 HCN +++++++++++++++++++++++++++++
      ItemChargeAssignmentSalesL.SETCURRENTKEY("Applies-to Doc. Type","Applies-to Doc. No.","Applies-to Doc. Line No.");
      ItemChargeAssignmentSalesL.SETRANGE("Applies-to Doc. Type",ItemChargeAssignmentSalesL."Applies-to Doc. Type"::Order);
      ItemChargeAssignmentSalesL.SETRANGE("Applies-to Doc. No.",SalesLineV."Document No.");
      ItemChargeAssignmentSalesL.SETRANGE("Applies-to Doc. Line No.",SalesLineV."Line No.");
      EXIT(ItemChargeAssignmentSalesL.ISEMPTY);
      //H0636 25.11.13 HCN -----------------------------
    END;

    PROCEDURE DetermItemChargeAssignAmount@1000000031(TableIDV@1000000005 : Integer;SalesLineV@1000000000 : Record 37;SalesLineArchiveV@1000000004 : Record 5108) TotalDiscountAmountRV : Decimal;
    VAR
      CustomerLedgerEntryL@1000000001 : Record 21;
      ItemChargeAssignmentSalesL@1000000002 : Record 5809;
      SalesInvoiceLineL@1000000003 : Record 113;
      ValueEntryL@1000000006 : Record 5802;
    BEGIN
      // DetermItemChargeAssignAmount
      //H0636 06.12.13 HCN +++++++++++++++++++++++++++++

      IF NOT CheckSalesReceivablesSetup() THEN BEGIN
        EXIT;
      END;
      IF (SalesLineV."Document Type" = SalesLineV."Document Type"::"Externe Logistik") THEN BEGIN
        EXIT;
      END;

      CASE TableIDV OF

        DATABASE::"Sales Line":
          BEGIN
            CLEAR(ItemChargeAssignmentSalesL);
            ItemChargeAssignmentSalesL.SETCURRENTKEY("Applies-to Doc. Type","Applies-to Doc. No.","Applies-to Doc. Line No.");
            ItemChargeAssignmentSalesL.SETRANGE("Applies-to Doc. Type",SalesLineV."Document Type");
            ItemChargeAssignmentSalesL.SETRANGE("Applies-to Doc. No.",SalesLineV."Document No.");
            ItemChargeAssignmentSalesL.SETRANGE("Applies-to Doc. Line No.",SalesLineV."Line No.");
            IF ItemChargeAssignmentSalesL.FIND('-') THEN BEGIN
              REPEAT
                TotalDiscountAmountRV += ItemChargeAssignmentSalesL."Cancelation Amount";
              UNTIL ItemChargeAssignmentSalesL.NEXT = 0;
            END;
          END;

        DATABASE::"Sales Line Archive":
          BEGIN
            CLEAR(SalesInvoiceLineL);
            SalesInvoiceLineL.SETCURRENTKEY("Order No.","Order Line No.","Posting Date");
            SalesInvoiceLineL.SETRANGE("Order No.",SalesLineArchiveV."Document No.");
            SalesInvoiceLineL.SETRANGE("Order Line No.",SalesLineArchiveV."Line No.");
            IF SalesInvoiceLineL.FIND('-') THEN BEGIN
              CLEAR(ValueEntryL);
              ValueEntryL.SETCURRENTKEY("Document Type","Document No.","Document Line No.");
              ValueEntryL.SETRANGE("Document Type",ValueEntryL."Document Type"::"Sales Invoice");
              REPEAT
                ValueEntryL.SETRANGE("Document No.",SalesInvoiceLineL."Document No.");
                ValueEntryL.SETRANGE("Document Line No.",SalesInvoiceLineL."Line No.");
                IF ValueEntryL.FIND('-') THEN BEGIN
                  REPEAT
                    IF (ValueEntryL."Item Charge No." <> '') THEN BEGIN
                      TotalDiscountAmountRV += ValueEntryL."Sales Amount (Actual)";
                    END;
                  UNTIL ValueEntryL.NEXT = 0;
                END;
              UNTIL SalesInvoiceLineL.NEXT = 0;
            END;
          END;
        ELSE BEGIN
        END;
      END;
      EXIT(TotalDiscountAmountRV);
      //H0636 06.12.13 HCN -----------------------------
    END;

    PROCEDURE CheckSalesReceivablesSetup@1000000033() : Boolean;
    BEGIN
      // CheckSalesReceivablesSetup
      //H0584, H0636 25.06.14 HCN +++++++++++++++++++++++++++++
      SalesReceivablesSetup.GET();
      IF NOT SalesReceivablesSetup."Pmt. Proposal perOrder enabled" THEN BEGIN
        EXIT(FALSE);
      END;
      EXIT(TRUE);
      //H0584, H0636 25.06.14 HCN -----------------------------
    END;

    PROCEDURE CheckIPLcancelled@1000000037(DocumentNoV@1000000000 : Code[20];DocumentLineNoV@1000000001 : Integer) : Boolean;
    VAR
      InterfaceProcessLogL@1000000002 : Record 50087;
    BEGIN
      // CheckIPLcancelled
      //H0584, H0587 17.07.14 HCN +++++++++++++++++++++++++++++
      FPCGeneralSetup.TESTFIELD("Status Cancel");

      CLEAR(InterfaceProcessLogL);
      InterfaceProcessLogL.SETCURRENTKEY("Entry Type","Entry Subtype",
                                         "Document No.","Document Line No.",
                                         Interface,Status,"Process Status");
      InterfaceProcessLogL.SETRANGE("Entry Type",InterfaceProcessLogL."Entry Type"::Sales);
      InterfaceProcessLogL.SETRANGE("Entry Subtype",InterfaceProcessLogL."Entry Subtype"::Order);
      InterfaceProcessLogL.SETRANGE("Document No.",DocumentNoV);
      InterfaceProcessLogL.SETRANGE("Document Line No.",DocumentLineNoV);
      InterfaceProcessLogL.SETFILTER(Status,'%1',FPCGeneralSetup."Status Cancel");

      InterfaceProcessLogL.SETFILTER("Process Status",'<>%1',InterfaceProcessLogL."Process Status"::Information);
      IF InterfaceProcessLogL.FINDLAST THEN BEGIN
        EXIT(FALSE);
      END ELSE BEGIN
        EXIT(TRUE);
      END;
      //H0584, H0587 17.07.14 HCN -----------------------------
    END;

    PROCEDURE CheckDocDataLocation@1000000025(SalesLineV@1000000000 : Record 37);
    VAR
      LocationL@1000000001 : Record 14;
      SalesHeaderL@1000000002 : Record 36;
      DDInterfaceOutboundL@1000000003 : Codeunit 50051;
    BEGIN
      // CheckDocDataLocation
      //H0587 28.03.14 HCN +++++++++++++++++++++++++++++
      LocationL.GET(SalesLineV."Location Code");
      IF LocationL."Docdata Location" AND
         SalesHeaderL.GET(SalesLineV."Document Type",SalesLineV."Document No.") AND
         SalesHeaderL.Kommissionierung AND
         NOT SalesHeaderL."Cancel Without Interfaces" AND
         NOT DDInterfaceOutboundL.CheckUpdateAllowed(SalesLineV)
      THEN BEGIN
        IF GUIALLOWED THEN BEGIN
          IF NOT DisplayConfirm(TextHME019,FALSE,1,FORMAT(SalesLineV."Line No."),'','') THEN BEGIN
            DisplayMessage(TextHME045,1,FORMAT(SalesLineV."Line No."),'','');
            DoProcessCurrentLine := FALSE;
          END;
        END;
      END;
      //H0587 28.03.14 HCN -----------------------------
    END;

    PROCEDURE CheckRhenusLocation@1000000043(SalesLineV@1000000000 : Record 37);
    VAR
      LocationL@1000000001 : Record 14;
    BEGIN
      // CheckRhenusLocation
      //H0587 28.03.14 HCN +++++++++++++++++++++++++++++
      LocationL.GET(SalesLineV."Location Code");
      IF LocationL."Rhenus Location" THEN BEGIN
        IF GUIALLOWED THEN
          IF (SalesLineV."Status Code" = '50') OR
             (SalesLineV."Status Code" = '11') OR
             (SalesLineV."Status Code" = '10') OR
             (SalesLineV."Status Code" = '1')
          THEN BEGIN
            IF NOT DisplayConfirm(TextHME018,FALSE,1,FORMAT(SalesLineV."Line No."),'','') THEN BEGIN
              DisplayMessage(TextHME045,0,'','','');
              DoProcessCurrentLine := FALSE;
            END;
          END;
      END;
      //H0587 28.03.14 HCN -----------------------------
    END;

    PROCEDURE CheckSalesLineToBeCancelled@1000000026(SalesLineV@1000000018 : Record 37);
    VAR
      BatchPostDocumentLineL@1000000014 : Record 50190;
      ContactTypeL@1000000003 : Record 50189;
      ExtendedTextHeaderL@1000000007 : Record 279;
      FPC_GeneralSetupL@1000000002 : Record 50055;
      PostedBatchPostDocumentLineL@1000000015 : Record 50191;
      PurchaseHeaderL@1000000005 : Record 38;
      SalesLineL@1000000000 : Record 37;
      SalesLineLT@1000000017 : TEMPORARY Record 37;
      UserSetupL@1000000004 : Record 91;
      VendorL@1000000006 : Record 23;
      POCancInquiry_FunctionsL@1000000001 : Codeunit 50146;
      ExtText_AllLangPreTxt_existL@1000000013 : Boolean;
      ExtText_AllLangPostTxt_existL@1000000011 : Boolean;
      ExtText_VendLangPreTxt_existL@1000000008 : Boolean;
      ExtText_VendLangPostTxt_existL@1000000009 : Boolean;
      StatusL@1000000016 : Text[30];
    BEGIN
      // CheckSalesLineToBeCancelled
      //H0587  01.04.14  HCN  ++++++++++++++++++++++++++++++++++++

      //H1366  17.07.14  hcn  ++++++++++++++++++++++++++++++++++++
      // to be used for new T37 functionality: send e-mail during manual cancellation request
      {
      // drop shipments
      IF SalesLineV."Drop Shipment" AND
         NOT BypassDSCDCheck  // when called from C50093, the fields have been reset already
      THEN BEGIN
        IF (SalesLineV."Purchase Order No." = '') OR
           (SalesLineV."Purch. Order Line No." = 0)
        THEN BEGIN
          DisplayMessage(TextHME043,3,
                         SalesLineV.FIELDCAPTION("Purchase Order No."),
                         SalesLineV.FIELDCAPTION("Purch. Order Line No."),
                         FORMAT(SalesLineV."Line No."));
          DoProcessCurrentLine := FALSE;
        END;
        IF NOT DoProcessCurrentLine THEN BEGIN
          EXIT;
        END;

        PurchaseHeaderL.GET(PurchaseHeaderL."Document Type"::Order,
                            SalesLineV."Purchase Order No.");
        IF NOT PurchaseHeaderTmp.GET(PurchaseHeaderTmp."Document Type"::Order,
                                     SalesLineV."Purchase Order No.")
        THEN BEGIN
          PurchaseHeaderTmp.INIT;
          PurchaseHeaderTmp := PurchaseHeaderL;
          PurchaseHeaderTmp.INSERT;

          PurchaseHeaderDropShipTmp.INIT;
          PurchaseHeaderDropShipTmp := PurchaseHeaderL;
          PurchaseHeaderDropShipTmp.INSERT;
        END;
        CheckVendorEmailAddress();
        SalesLineDSCDTmp.INIT;
        SalesLineDSCDTmp := SalesLineV;
        SalesLineDSCDTmp.Description := PurchaseHeaderTmp."No.";
        SalesLineDSCDTmp.INSERT;
        SalesLineDSTmp := SalesLineDSCDTmp;
        SalesLineDSTmp.INSERT;
        SalLineDSCDToBeCancelledExists := TRUE;
      END;

      // special orders
      IF SalesLineV."Special Order" AND
         NOT BypassDSCDCheck  // when called from C50093, the fields have been reset already
      THEN BEGIN
        IF (SalesLineV."Special Order Purchase No." = '') OR
           (SalesLineV."Special Order Purch. Line No." = 0)
        THEN BEGIN
          DisplayMessage(TextHME044,3,
                         SalesLineV.FIELDCAPTION("Special Order Purchase No."),
                         SalesLineV.FIELDCAPTION("Special Order Purch. Line No."),
                         FORMAT(SalesLineV."Line No."));
          DoProcessCurrentLine := FALSE;
        END;
        IF NOT DoProcessCurrentLine THEN BEGIN
          EXIT;
        END;
        PurchaseHeaderL.GET(PurchaseHeaderL."Document Type"::Order,
                            SalesLineV."Special Order Purchase No.");
        IF NOT PurchaseHeaderTmp.GET(PurchaseHeaderTmp."Document Type"::Order,
                                     SalesLineV."Special Order Purchase No.")
        THEN BEGIN
          PurchaseHeaderTmp.INIT;
          PurchaseHeaderTmp := PurchaseHeaderL;
          PurchaseHeaderTmp.INSERT;

          PurchaseHeaderSpecOrdTmp.INIT;
          PurchaseHeaderSpecOrdTmp := PurchaseHeaderL;
          PurchaseHeaderSpecOrdTmp.INSERT;
        END;
        CheckVendorEmailAddress();
        SalesLineDSCDTmp.INIT;
        SalesLineDSCDTmp := SalesLineV;
        SalesLineDSCDTmp.Description := PurchaseHeaderTmp."No.";
        SalesLineDSCDTmp.INSERT;
        SalLineDSCDToBeCancelledExists := TRUE;
      END;
      }
      //H1366  17.07.14  hcn  ------------------------------------

      // warehouse items
      IF NOT SalesLineV."Drop Shipment" AND
         NOT SalesLineV."Special Order" AND
         NOT SalesHeader."Cancel Without Interfaces"
      THEN BEGIN
        CheckRhenusLocation(SalesLineV);
        CheckDocDataLocation(SalesLineV);
        //CheckIFTMINEDI(SalesLineV);
      END;
      //H0587  01.04.14  HCN  ------------------------------------
    END;

    PROCEDURE DeleteTempRecords@1000000039();
    BEGIN
      // DeletePOCTempRecords
      //H0584  03.04.14  HCN  ++++++++++++++++++++++++++++++++++++
      CLEAR(PurchaseHeaderDropShipTmp);
      PurchaseHeaderDropShipTmp.DELETEALL;

      CLEAR(PurchaseHeaderSpecOrdTmp);
      PurchaseHeaderSpecOrdTmp.DELETEALL;

      CLEAR(SalesLineDSTmp);
      SalesLineDSTmp.DELETEALL;

      CLEAR(SalesLineDSCDTmp);
      SalesLineDSCDTmp.DELETEALL;

      CLEAR(PurchaseHeaderTmp);
      PurchaseHeaderTmp.DELETEALL;

      CLEAR(SalesLineToBeProcessedTmp);
      SalesLineToBeProcessedTmp.DELETEALL;

      CLEAR(SalesLineToBeProcessedTmp2);
      SalesLineToBeProcessedTmp2.DELETEALL;

      CLEAR(SalesLineToBeProcessedTmp3);
      SalesLineToBeProcessedTmp3.DELETEALL;

      CLEAR(SalesLineArchToBeProcessedTmp);
      SalesLineArchToBeProcessedTmp.DELETEALL;

      CLEAR(SalesLineArchToBeProcessedTmp2);
      SalesLineArchToBeProcessedTmp2.DELETEALL;

      CLEAR(SalesLineArchToBeProcessedTmp3);
      SalesLineArchToBeProcessedTmp3.DELETEALL;

      //H0584  03.04.14  HCN  ------------------------------------
    END;

    PROCEDURE DetermineCancellationCase@1000000054();
    VAR
      SalesLineL@1000000000 : Record 37;
      NoOfLinesNotCancelledYetL@1000000001 : Integer;
      NoOfLinesCancRequestedL@1000000002 : Integer;
      NoOfLinesCancelledAlreadyL@1000000003 : Integer;
    BEGIN
      // DetermineCancellationCase
      //H0587 15.04.14 HCN +++++++++++++++++++++++++++++

      NoOfLinesNotCancelledYetL := 0;
      NoOfLinesCancRequestedL := 0;
      NoOfLinesCancelledAlreadyL := 0;

      CLEAR(SalesLineL);
      SalesLineL.SETCURRENTKEY("Document Type","Document No.","Line No.");
      SalesLineL.SETRANGE("Document Type",SalesHeader."Document Type");
      SalesLineL.SETRANGE("Document No.",SalesHeader."No.");
      SalesLineL.SETFILTER(Type,'<>%1',SalesLineL.Type::" ");
      SalesLineL.SETFILTER("Line Status",'<>%1','CANCELED');
      NoOfLinesNotCancelledYetL := SalesLineL.COUNT;

      SalesLineL.SETRANGE("Return Type",SalesLineL."Return Type"::Cancelation);
      SalesLineL.SETFILTER("Status Return Order",'%1|%2',
                           SalesLineL."Status Return Order"::open,
                           SalesLineL."Status Return Order"::" ");
      SalesLineL.SETFILTER("Customer Prevention",'%1|%2',
                           SalesLineL."Customer Prevention"::"Not offered",
                           SalesLineL."Customer Prevention"::Declined);
      NoOfLinesCancRequestedL := SalesLineL.COUNT;

      SalesLineL.SETRANGE("Line Status",'CANCELED');
      SalesLineL.SETFILTER("Status Return Order",'>%1',SalesLineL."Status Return Order"::requested);
      NoOfLinesCancelledAlreadyL := SalesLineL.COUNT;

      IsFirstLineToCancel := TRUE;
      CASE TRUE OF
        (NoOfLinesCancRequestedL = 0):
          BEGIN
            CancellationCase := CancellationCase::CancelNothing;
            IsFirstLineToCancel := FALSE;
          END;

        (NoOfLinesCancRequestedL = NoOfLinesNotCancelledYetL):
          BEGIN
            CancellationCase := CancellationCase::CancelOrder;
          END;

        (NoOfLinesCancRequestedL > 1):
          BEGIN
            CancellationCase := CancellationCase::CancelSeveralLines;
          END;

        (NoOfLinesCancRequestedL = 1):
          BEGIN
            CancellationCase := CancellationCase::CancelOneLine;
          END;
      END;
      //H0587 15.04.14 HCN -----------------------------
    END;

    PROCEDURE GetSalesHeader@1000000057(SalesLineV@1000000000 : Record 37);
    BEGIN
      // GetSalesHeader
      //H0587  11.04.14  HCN  ++++++++++++++++++++++++++++++++++++
      SalesHeader.GET(SalesLineV."Document Type",
                      SalesLineV."Document No.");
      //H0587  11.04.14  HCN  ------------------------------------
    END;

    PROCEDURE GetSalesHeaderArchive@1000000061(SalesLineArchiveV@1000000000 : Record 5108);
    BEGIN
      // GetSalesHeaderArchive
      //H0587  11.04.14  HCN  ++++++++++++++++++++++++++++++++++++
      SalesHeaderArchive.GET(SalesLineArchiveV."Document Type",
                             SalesLineArchiveV."Document No.",
                             SalesLineArchiveV."Doc. No. Occurrence",
                             SalesLineArchiveV."Version No.");
      //H0587  11.04.14  HCN  ------------------------------------
    END;

    PROCEDURE InsertTemporarySalesLine@1000000060();
    VAR
      SalesLineL@1000000000 : Record 37;
      SalesLineArchiveL@1000000001 : Record 5108;
    BEGIN
      // InsertTemporarySalesLine
      //H0584  01.04.14  HCN  ++++++++++++++++++++++++++++++++++++
      CASE SalesLineRecRef.NUMBER OF
        DATABASE::"Sales Line":
          BEGIN
            SalesLineRecRef.SETTABLE(SalesLineL);
            SalesLineToBeProcessedTmp.INIT;
            SalesLineToBeProcessedTmp := SalesLineL;
            IF SalesLineToBeProcessedTmp.INSERT THEN BEGIN
              SalesLineToBeProcessedTmp2.COPY(SalesLineToBeProcessedTmp,FALSE);
              SalesLineToBeProcessedTmp2.INSERT;
              SalesLineToBeProcessedTmp3.COPY(SalesLineToBeProcessedTmp,FALSE);
              SalesLineToBeProcessedTmp3.INSERT;
            END;
          END;
        DATABASE::"Sales Line Archive":
          BEGIN
            SalesLineRecRef.SETTABLE(SalesLineArchiveL);
            SalesLineArchToBeProcessedTmp.INIT;
            SalesLineArchToBeProcessedTmp := SalesLineArchiveL;
            IF SalesLineArchToBeProcessedTmp.INSERT THEN BEGIN
              SalesLineArchToBeProcessedTmp2.COPY(SalesLineArchToBeProcessedTmp,FALSE);
              SalesLineArchToBeProcessedTmp2.INSERT;
              SalesLineArchToBeProcessedTmp3.COPY(SalesLineArchToBeProcessedTmp,FALSE);
              SalesLineArchToBeProcessedTmp3.INSERT;
            END;
          END;
      END;
      //H0584  01.04.14  HCN  ------------------------------------
    END;

    PROCEDURE PostReturnOrdersPrevAfterShpt@1000000050();
    VAR
      ReturnOrderPreventionL@1000000000 : Record 36;
      SalesPostL@1000000001 : Codeunit 80;
      "****CC************************"@1000000002 : Integer;
      MPPostingMgt@1000000003 : Codeunit 50501;
    BEGIN
      // PostReturnOrdersPrevAfterShpt
      //H0584 08.04.14 HCN +++++++++++++++++++++++++++++
      IF ReturnOrderPreventionTemp.FIND('-') THEN BEGIN
        REPEAT
          ReturnOrderPreventionL.GET(ReturnOrderPreventionTemp."Document Type",
                                     ReturnOrderPreventionTemp."No.");
          ReturnOrderPreventionL.Receive := TRUE;
          ReturnOrderPreventionL.Invoice := TRUE;

          //T0060 02.03.15 CC-GH +++++++++++++++++++++++++++++++++++++++++++++++++++
          CLEAR(MPPostingMgt);
          MPPostingMgt.RUN(ReturnOrderPreventionL);
          //T0060 02.03.15 CC-GH ---------------------------------------------------

          COMMIT;

          IsFirstLoop := TRUE;
          CLEAR(SalesLineToBeProcessedTmp2);
          SalesLineToBeProcessedTmp2.SETRANGE("Line No.",ReturnOrderPreventionTemp."Status Return Order");
          IF SalesLineToBeProcessedTmp2.FIND('-') THEN BEGIN
            GlobRecRef.GETTABLE(SalesLineToBeProcessedTmp2);
            UpdateStatusReturnOrder_Header(5); // 5 = finished
            UpdateStatusReturnOrder_Line(5); // 5 = finished
          END;

          CLEAR(SalesLineArchToBeProcessedTmp2);
          SalesLineArchToBeProcessedTmp2.SETRANGE("Line No.",ReturnOrderPreventionTemp."Status Return Order");
          IF SalesLineArchToBeProcessedTmp2.FIND('-') THEN BEGIN
            GlobRecRef.GETTABLE(SalesLineArchToBeProcessedTmp2);
            UpdateStatusReturnOrder_Header(5); // 5 = finished
            UpdateStatusReturnOrder_Line(5); // 5 = finished
          END;

        UNTIL ReturnOrderPreventionTemp.NEXT = 0;
      END;
      //H0584 08.04.14 HCN -----------------------------
    END;

    PROCEDURE UpdateStatusReturnOrder@1000000051();
    VAR
      SalesHeaderL@1000000000 : Record 36;
      SalesLineL@1000000001 : Record 37;
      SalesHeaderArchiveL@1000000003 : Record 5107;
      SalesLineArchiveL@1000000002 : Record 5108;
    BEGIN
      // UpdateStatusReturnOrder
      //H0584 07.04.14 HCN +++++++++++++++++++++++++++++

      CLEAR(SalesLineToBeProcessedTmp);
      IF SalesLineToBeProcessedTmp.FIND('-') THEN BEGIN
        IsFirstLoop := TRUE;
        REPEAT
          GlobRecRef.GETTABLE(SalesLineToBeProcessedTmp);
          //H0587 29.04.14 HCN +++++++++++++++++++++++++++++
          {
          UpdateStatusReturnOrder_Header(1);  // 1 = open
          }
          //H0587 29.04.14 HCN -----------------------------
          CASE TRUE OF
            // Prevention before shipment
            (SalesLineToBeProcessedTmp."Return Type" = SalesLineToBeProcessedTmp."Return Type"::Cancelation) AND
            (SalesLineToBeProcessedTmp."Customer Prevention" = SalesLineToBeProcessedTmp."Customer Prevention"::Accepted):
              BEGIN
                UpdateStatusReturnOrder_Line(1); // 1 = open
              END;
            // Cancellation
            (SalesLineToBeProcessedTmp."Return Type" = SalesLineToBeProcessedTmp."Return Type"::Cancelation):
              BEGIN
                UpdateStatusReturnOrder_Header(1);  // 1 = open
                UpdateStatusReturnOrder_Line(1);    // 1 = open
              END;
            // Prevention after shipment
            (SalesLineToBeProcessedTmp."Return Type" = SalesLineToBeProcessedTmp."Return Type"::Return) AND
            (SalesLineToBeProcessedTmp."Customer Prevention" = SalesLineToBeProcessedTmp."Customer Prevention"::Accepted):
              BEGIN
                UpdateStatusReturnOrder_Line(1); // 1 = open
              END;
            // return
            (SalesLineToBeProcessedTmp."Return Type" = SalesLineToBeProcessedTmp."Return Type"::Return):
              BEGIN
                UpdateStatusReturnOrder_Line(1); // 1 = open
              END;
            // change
            (SalesLineToBeProcessedTmp."Return Type" = SalesLineToBeProcessedTmp."Return Type"::Change):
              BEGIN
                UpdateStatusReturnOrder_Line(1); // 1 = open
              END;
            // Spare Part
            (SalesLineToBeProcessedTmp."Return Type" = SalesLineToBeProcessedTmp."Return Type"::"Spare Part"):
              BEGIN
                UpdateStatusReturnOrder_Line(1); // 1 = open
              END;
          END;
        UNTIL SalesLineToBeProcessedTmp.NEXT = 0;
        EXIT;
      END;


      CLEAR(SalesLineArchToBeProcessedTmp);
      IF SalesLineArchToBeProcessedTmp.FIND('-') THEN BEGIN
        IsFirstLoop := TRUE;
        REPEAT
          GlobRecRef.GETTABLE(SalesLineArchToBeProcessedTmp);
          UpdateStatusReturnOrder_Header(1);  // 1 = open
          CASE TRUE OF
            // Prevention before shipment
            (SalesLineArchToBeProcessedTmp."Return Type" = SalesLineArchToBeProcessedTmp."Return Type"::Cancelation) AND
            (SalesLineArchToBeProcessedTmp."Customer Prevention" = SalesLineArchToBeProcessedTmp."Customer Prevention"::Accepted):
              BEGIN
                UpdateStatusReturnOrder_Line(1); // 1 = open
              END;
            // Cancellation
            (SalesLineArchToBeProcessedTmp."Return Type" = SalesLineArchToBeProcessedTmp."Return Type"::Cancelation):
              BEGIN
                UpdateStatusReturnOrder_Line(1); // 1 = open
              END;
            // Prevention after shipment
            (SalesLineArchToBeProcessedTmp."Return Type" = SalesLineArchToBeProcessedTmp."Return Type"::Return) AND
            (SalesLineArchToBeProcessedTmp."Customer Prevention" = SalesLineArchToBeProcessedTmp."Customer Prevention"::Accepted):
              BEGIN
                UpdateStatusReturnOrder_Line(1); // 1 = open
              END;
            // return
            (SalesLineArchToBeProcessedTmp."Return Type" = SalesLineArchToBeProcessedTmp."Return Type"::Return):
              BEGIN
                UpdateStatusReturnOrder_Line(1); // 1 = open
              END;
            // change
            (SalesLineArchToBeProcessedTmp."Return Type" = SalesLineArchToBeProcessedTmp."Return Type"::Change):
              BEGIN
                UpdateStatusReturnOrder_Line(1); // 1 = open
              END;
            // Spare Part
            (SalesLineArchToBeProcessedTmp."Return Type" = SalesLineArchToBeProcessedTmp."Return Type"::"Spare Part"):
              BEGIN
                UpdateStatusReturnOrder_Line(1); // 1 = open
              END;
          END;
        UNTIL SalesLineArchToBeProcessedTmp.NEXT = 0;
      END;

      //H0584 07.04.14 HCN -----------------------------
    END;

    PROCEDURE UpdateStatusReturnOrder_Header@1000000049(NewStatusReturnOrderV@1000000004 : Option);
    VAR
      SalesHeaderL@1000000000 : Record 36;
      SalesLineL@1000000001 : Record 37;
      SalesHeaderArchiveL@1000000003 : Record 5107;
      SalesLineArchiveL@1000000002 : Record 5108;
    BEGIN
      // UpdateStatusReturnOrder_Header
      //H0584 07.04.14 HCN +++++++++++++++++++++++++++++

      IF NOT IsFirstLoop THEN BEGIN
        EXIT;
      END ELSE BEGIN
        IsFirstLoop := FALSE;
      END;

      CASE GlobRecRef.NUMBER OF
        DATABASE::"Sales Line":
          BEGIN
            GlobRecRef.SETTABLE(SalesLineL);

            SalesHeaderL.GET(SalesLineL."Document Type",SalesLineL."Document No.");
            SalesHeaderL."Status Return Order" := NewStatusReturnOrderV;
            SalesHeaderL.SuspendStatusCheck(TRUE);
            SalesHeaderL.MODIFY;
          END;

        DATABASE::"Sales Line Archive":
          BEGIN
            GlobRecRef.SETTABLE(SalesLineArchiveL);
            SalesHeaderArchiveL.GET(SalesLineArchiveL."Document Type",
                                    SalesLineArchiveL."Document No.",
                                    SalesLineArchiveL."Doc. No. Occurrence",
                                    SalesLineArchiveL."Version No.");
            SalesHeaderArchiveL."Status Return Order" := NewStatusReturnOrderV;
            SalesHeaderArchiveL.MODIFY;
          END;
      END;
      //H0584 07.04.14 HCN -----------------------------
    END;

    PROCEDURE UpdateStatusReturnOrder_Line@1000000052(NewStatusReturnOrderV@1000000004 : Option);
    VAR
      SalesHeaderL@1000000000 : Record 36;
      SalesLineL@1000000001 : Record 37;
      SalesLine2L@1000000005 : Record 37;
      SalesHeaderArchiveL@1000000003 : Record 5107;
      SalesLineArchiveL@1000000002 : Record 5108;
      SalesLineArchive2L@1000000006 : Record 5108;
    BEGIN
      // UpdateStatusReturnOrder_Line
      //H0584 07.04.14 HCN +++++++++++++++++++++++++++++

      CASE GlobRecRef.NUMBER OF
        DATABASE::"Sales Line":
          BEGIN
            GlobRecRef.SETTABLE(SalesLineL);
            SalesLine2L.GET(SalesLineL."Document Type",
                            SalesLineL."Document No.",
                            SalesLineL."Line No.");
            SalesLine2L."Status Return Order" := NewStatusReturnOrderV;
            SalesLine2L.SuspendStatusCheck(TRUE);
            SalesLine2L.MODIFY;
          END;

        DATABASE::"Sales Line Archive":
          BEGIN
            GlobRecRef.SETTABLE(SalesLineArchiveL);
            SalesLineArchive2L.GET(SalesLineArchiveL."Document Type",
                                   SalesLineArchiveL."Document No.",
                                   SalesLineArchiveL."Doc. No. Occurrence",
                                   SalesLineArchiveL."Version No.",
                                   SalesLineArchiveL."Line No.");
            SalesLineArchive2L."Status Return Order" := NewStatusReturnOrderV;
            SalesLineArchive2L.MODIFY;
          END;
      END;
      //H0584 07.04.14 HCN -----------------------------
    END;

    PROCEDURE DisplayConfirm@1000000075(MessageTextV@1000000006 : Text[1024];ConfirmDefaultValueV@1000000005 : Boolean;NumberOfParametersV@1000000004 : Integer;Parameter1V@1000000003 : Text[50];Parameter2V@1000000002 : Text[50];Parameter3V@1000000001 : Text[50]) : Boolean;
    VAR
      ACFManagementL@1000000000 : Codeunit 5327126;
    BEGIN
      // DisplayConfirm
      //H0584 30.04.14 HCN +++++++++++++++++++++++++++++

      IF ISSERVICETIER THEN BEGIN
        CASE NumberOfParametersV OF
          0:EXIT(ACFManagementL.CONFIRM(MessageTextV,ConfirmDefaultValueV));
          1:EXIT(ACFManagementL.CONFIRM1(MessageTextV,ConfirmDefaultValueV,Parameter1V));
          2:EXIT(ACFManagementL.CONFIRM2(MessageTextV,ConfirmDefaultValueV,Parameter1V,Parameter2V));
          3:EXIT(ACFManagementL.CONFIRM3(MessageTextV,ConfirmDefaultValueV,Parameter1V,Parameter2V,Parameter3V));
        END;
      END ELSE BEGIN
        IF NOT HideValidationDialog THEN BEGIN
          CASE NumberOfParametersV OF
            0:EXIT(CONFIRM(MessageTextV,ConfirmDefaultValueV));
            1:EXIT(CONFIRM(MessageTextV,ConfirmDefaultValueV,Parameter1V));
            2:EXIT(CONFIRM(MessageTextV,ConfirmDefaultValueV,Parameter1V,Parameter2V));
            3:EXIT(CONFIRM(MessageTextV,ConfirmDefaultValueV,Parameter1V,Parameter2V,Parameter3V));
          END;
        END;
      END;
      //H0584 30.04.14 HCN -----------------------------
    END;

    PROCEDURE DisplayMessage@1000000058(MessageTextV@1000000004 : Text[1024];NumberOfParametersV@1000000003 : Integer;Parameter1V@1000000002 : Text[50];Parameter2V@1000000001 : Text[50];Parameter3V@1000000000 : Text[50]);
    VAR
      ACFManagementL@1000000005 : Codeunit 5327126;
    BEGIN
      // DisplayMessage
      // T0079 +++++++++++++++++++++++++++++
      IF ACFManagementL.IsACF THEN BEGIN
        ACFManagementL.MESSAGE3(MessageTextV,Parameter1V,Parameter2V,Parameter3V);
      END ELSE BEGIN
        IF GUIALLOWED THEN BEGIN
          MESSAGE(MessageTextV,Parameter1V,Parameter2V,Parameter3V);
        END;
      END;

      //H0584 30.04.14 HCN +++++++++++++++++++++++++++++
      {
      IF ISSERVICETIER THEN BEGIN
        CASE NumberOfParametersV OF
          0:ACFManagementL.MESSAGE(MessageTextV);
          1:ACFManagementL.MESSAGE1(MessageTextV,Parameter1V);
          2:ACFManagementL.MESSAGE2(MessageTextV,Parameter1V,Parameter2V);
          3:ACFManagementL.MESSAGE3(MessageTextV,Parameter1V,Parameter2V,Parameter3V);
        END;
      END ELSE BEGIN
        IF NOT HideValidationDialog THEN BEGIN
          CASE NumberOfParametersV OF
            0:MESSAGE(MessageTextV);
            1:MESSAGE(MessageTextV,Parameter1V);
            2:MESSAGE(MessageTextV,Parameter1V,Parameter2V);
            3:MESSAGE(MessageTextV,Parameter1V,Parameter2V,Parameter3V);
          END;
        END;
      END;
      //H0584 30.04.14 HCN -----------------------------
      }
      // T0079 -----------------------------
    END;

    PROCEDURE DisplayMessage2@1000000030(MessageTextV@1000000004 : Text[1024];Parameter1V@1000000002 : Variant;Parameter2V@1000000001 : Variant;Parameter3V@1000000000 : Variant);
    VAR
      ACFManagementL@1000000005 : Codeunit 5327126;
    BEGIN
      // DisplayMessage2
      // T0079 +++++++++++++++++++++++++++++
      IF ACFManagementL.IsACF THEN BEGIN
        ACFManagementL.MESSAGE3(MessageTextV, Parameter1V, Parameter2V, Parameter3V);
      END ELSE BEGIN
        IF GUIALLOWED THEN BEGIN
          MESSAGE(MessageTextV, Parameter1V, Parameter2V, Parameter3V);
        END;
      END;
      // T0079 -----------------------------
    END;

    PROCEDURE SetRecRefSalesLine@1000000056(SalesLineV@1000000000 : Record 37);
    BEGIN
      // SetRecRefSalesLine
      //H0587 06.05.14 HCN +++++++++++++++++++++++++++++
      IsFirstLoop := TRUE;
      GlobRecRef.GETTABLE(SalesLineV);
      //H0587 06.05.14 HCN -----------------------------
    END;

    PROCEDURE CheckCopyResourceToReturnOrder@1000000069(SalesHeaderRecRefV@1000000001 : RecordRef;NewSalesHeaderV@1000000005 : Record 36;NewSalesLineV@1000000002 : Record 37;parReturnType@1000000000 : Option);
    VAR
      RecRefL@1000000006 : RecordRef;
      SalesLineResourceL@1000000003 : Record 37;
      SalesLineArchiveResourceL@1000000004 : Record 5108;
      LineNoL@1000000007 : Integer;
    BEGIN
      // CheckCopyResourceToReturnOrder
      //H1202 04.06.14 HCN +++++++++++++++++++++++++++++

      IF (parReturnType <> 2) THEN BEGIN // 2 = Change
        EXIT;
      END;

      CASE SalesHeaderRecRefV.NUMBER OF
        DATABASE::"Sales Header":
          BEGIN
            IF (SalesLineToBeProcessedTmp2.ID <> 0) AND
               ((NewSalesLineV."Customer Prevention" = NewSalesLineV."Customer Prevention"::Declined) OR
                (NewSalesLineV."Customer Prevention" = NewSalesLineV."Customer Prevention"::"Not offered"))
            THEN BEGIN
              CLEAR(SalesLineResourceL);
              SalesLineResourceL.RESET;
              SalesLineResourceL.SETRANGE("Document Type",SalesLineToBeProcessedTmp2."Document Type");
              SalesLineResourceL.SETRANGE("Document No.",SalesLineToBeProcessedTmp2."Document No.");
              SalesLineResourceL.SETRANGE("Parent ID",SalesLineToBeProcessedTmp2.ID);
              IF SalesLineResourceL.FINDFIRST THEN BEGIN
                RecRefL.GETTABLE(SalesLineResourceL);
                LineNoL := GetLineNo(NewSalesLineV);
                LineNoL += 10000;
                CopyRessourceToReturnOrder(RecRefL,NewSalesHeaderV,LineNoL);
              END;
            END;
          END;

        DATABASE::"Sales Header Archive":
          BEGIN
            IF (SalesLineArchToBeProcessedTmp2.ID <> 0) AND
               ((NewSalesLineV."Customer Prevention" = NewSalesLineV."Customer Prevention"::Declined) OR
                (NewSalesLineV."Customer Prevention" = NewSalesLineV."Customer Prevention"::"Not offered"))
            THEN BEGIN
              CLEAR(SalesLineArchiveResourceL);
              SalesLineArchiveResourceL.RESET;
              SalesLineArchiveResourceL.SETRANGE("Document Type",SalesLineArchToBeProcessedTmp2."Document Type");
              SalesLineArchiveResourceL.SETRANGE("Document No.",SalesLineArchToBeProcessedTmp2."Document No.");
              SalesLineArchiveResourceL.SETRANGE("Parent ID",SalesLineArchToBeProcessedTmp2.ID);
              IF SalesLineArchiveResourceL.FINDFIRST THEN BEGIN
                RecRefL.GETTABLE(SalesLineArchiveResourceL);
                LineNoL := GetLineNo(NewSalesLineV);
                LineNoL += 10000;
                CopyRessourceToReturnOrder(RecRefL,NewSalesHeaderV,LineNoL);
              END;
            END;
          END;
      END;
      //H1202 04.06.14 HCN -----------------------------
    END;

    PROCEDURE CreateFollowUpSalesHeader@1000000076(ReturnHeaderV@1108200000 : Record 36;VAR FollowUpSalesHeaderR@1000000014 : Record 36);
    VAR
      SourceSalesHeaderL@1000000000 : Record 36;
      SourceSalesHeaderArchL@1000000001 : Record 5107;
      SalesReceivablesSetupL@1000000002 : Record 311;
    BEGIN
      // CreateFollowUpSalesHeader
      //H1202 04.06.14 HCN +++++++++++++++++++++++++++++

      CLEAR(FollowUpSalesHeaderR);

      FollowUpSalesHeaderR.INIT;
      FollowUpSalesHeaderR."No." := '';
      FollowUpSalesHeaderR."Document Type" := FollowUpSalesHeaderR."Document Type"::Order;
      FollowUpSalesHeaderR.INSERT(TRUE);
      FollowUpSalesHeaderR.VALIDATE("Sell-to Customer No.",ReturnHeaderV."Sell-to Customer No.");
      FollowUpSalesHeaderR.VALIDATE("Bill-to Customer No.",ReturnHeaderV."Bill-to Customer No.");
      FollowUpSalesHeaderR."Posting Date" := TODAY;

      //H1009 15.07.14 ARI +++++++++++++++++++++++++++++
      SalesReceivablesSetupL.GET;
      FollowUpSalesHeaderR."Payment Method Code" := SalesReceivablesSetupL."SO Order Pmt. Method Code";
      //H1009 15.07.14 ARI -----------------------------

      FollowUpSalesHeaderR."Item Change Return No." := ReturnHeaderV."No.";
      FollowUpSalesHeaderR."External Document No." := ReturnHeaderV."External Document No.";
      IF SourceSalesHeaderL.GET(SourceSalesHeaderL."Document Type"::Order,
                                ReturnHeaderV."External Document No.")
      THEN BEGIN
        FollowUpSalesHeaderR."Sell-to Customer Name" := SourceSalesHeaderL."Ship-to Name";
        FollowUpSalesHeaderR."Sell-to Customer Name 2" := SourceSalesHeaderL."Ship-to Name 2";
        FollowUpSalesHeaderR."Sell-to Address" := SourceSalesHeaderL."Ship-to Address";
        FollowUpSalesHeaderR."Sell-to Address 2" := SourceSalesHeaderL."Ship-to Address 2";
        FollowUpSalesHeaderR."Sell-to City" := SourceSalesHeaderL."Ship-to City";
        FollowUpSalesHeaderR."Sell-to Contact" := SourceSalesHeaderL."Ship-to Contact";
        FollowUpSalesHeaderR."Sell-to Post Code" := SourceSalesHeaderL."Ship-to Post Code";
        FollowUpSalesHeaderR."Sell-to Country/Region Code" := SourceSalesHeaderL."Ship-to Country/Region Code";
        FollowUpSalesHeaderR."Ship-to Name" := SourceSalesHeaderL."Ship-to Name";
        FollowUpSalesHeaderR."Ship-to Name 2" := SourceSalesHeaderL."Ship-to Name 2";
        FollowUpSalesHeaderR."Ship-to Address" := SourceSalesHeaderL."Ship-to Address";
        FollowUpSalesHeaderR."Ship-to Address 2" := SourceSalesHeaderL."Ship-to Address 2";
        FollowUpSalesHeaderR."Ship-to City" := SourceSalesHeaderL."Ship-to City";
        FollowUpSalesHeaderR."Ship-to Contact" := SourceSalesHeaderL."Ship-to Contact";
        FollowUpSalesHeaderR."Ship-to Post Code" := SourceSalesHeaderL."Ship-to Post Code";
        FollowUpSalesHeaderR."Ship-to Country/Region Code" := SourceSalesHeaderL."Ship-to Country/Region Code";
        FollowUpSalesHeaderR."Payment received" := SourceSalesHeaderL."Payment received";
        FollowUpSalesHeaderR."Payment received from" := SourceSalesHeaderL."Payment received from";
        FollowUpSalesHeaderR."Payment received at" := SourceSalesHeaderL."Payment received at";
        FollowUpSalesHeaderR.VALIDATE("Payment received at",SourceSalesHeaderL."Payment received at");

      END ELSE BEGIN

        SourceSalesHeaderArchL.SETRANGE("Document Type",SourceSalesHeaderL."Document Type"::Order);
        SourceSalesHeaderArchL.SETRANGE("No.",ReturnHeaderV."External Document No.");
        IF SourceSalesHeaderArchL.FINDLAST THEN BEGIN
          FollowUpSalesHeaderR."Sell-to Customer Name" := SourceSalesHeaderArchL."Ship-to Name";
          FollowUpSalesHeaderR."Sell-to Customer Name 2" := SourceSalesHeaderArchL."Ship-to Name 2";
          FollowUpSalesHeaderR."Sell-to Address" := SourceSalesHeaderArchL."Ship-to Address";
          FollowUpSalesHeaderR."Sell-to Address 2" := SourceSalesHeaderArchL."Ship-to Address 2";
          FollowUpSalesHeaderR."Sell-to City" := SourceSalesHeaderArchL."Ship-to City";
          FollowUpSalesHeaderR."Sell-to Contact" := SourceSalesHeaderArchL."Ship-to Contact";
          FollowUpSalesHeaderR."Sell-to Post Code" := SourceSalesHeaderArchL."Ship-to Post Code";
          FollowUpSalesHeaderR."Sell-to Country/Region Code" := SourceSalesHeaderArchL."Ship-to Country/Region Code";
          FollowUpSalesHeaderR."Ship-to Name" := SourceSalesHeaderArchL."Ship-to Name";
          FollowUpSalesHeaderR."Ship-to Name 2" := SourceSalesHeaderArchL."Ship-to Name 2";
          FollowUpSalesHeaderR."Ship-to Address" := SourceSalesHeaderArchL."Ship-to Address";
          FollowUpSalesHeaderR."Ship-to Address 2" := SourceSalesHeaderArchL."Ship-to Address 2";
          FollowUpSalesHeaderR."Ship-to City" := SourceSalesHeaderArchL."Ship-to City";
          FollowUpSalesHeaderR."Ship-to Contact" := SourceSalesHeaderArchL."Ship-to Contact";
          FollowUpSalesHeaderR."Ship-to Post Code" := SourceSalesHeaderArchL."Ship-to Post Code";
          FollowUpSalesHeaderR."Ship-to Country/Region Code" := SourceSalesHeaderArchL."Ship-to Country/Region Code";

          FollowUpSalesHeaderR."Payment received" := SourceSalesHeaderArchL."Payment received";
          FollowUpSalesHeaderR."Payment received from" := SourceSalesHeaderArchL."Payment received from";
          FollowUpSalesHeaderR."Payment received at" := SourceSalesHeaderArchL."Payment received at";
          FollowUpSalesHeaderR.VALIDATE("Payment received at",SourceSalesHeaderArchL."Payment received at");

        END ELSE BEGIN

          FollowUpSalesHeaderR."Sell-to Customer Name" := ReturnHeaderV."Sell-to Customer Name";
          FollowUpSalesHeaderR."Sell-to Customer Name 2" := ReturnHeaderV."Sell-to Customer Name 2";
          FollowUpSalesHeaderR."Sell-to Address" := ReturnHeaderV."Sell-to Address";
          FollowUpSalesHeaderR."Sell-to Address 2" := ReturnHeaderV."Sell-to Address 2";
          FollowUpSalesHeaderR."Sell-to City" := ReturnHeaderV."Sell-to City";
          FollowUpSalesHeaderR."Sell-to Contact" := ReturnHeaderV."Sell-to Contact";
          FollowUpSalesHeaderR."Sell-to Post Code" := ReturnHeaderV."Ship-to Post Code";
          FollowUpSalesHeaderR."Sell-to Country/Region Code" := ReturnHeaderV."Sell-to Country/Region Code";
          FollowUpSalesHeaderR."Ship-to Name" := ReturnHeaderV."Sell-to Customer Name";
          FollowUpSalesHeaderR."Ship-to Name 2" := ReturnHeaderV."Sell-to Customer Name 2";
          FollowUpSalesHeaderR."Ship-to Address" := ReturnHeaderV."Sell-to Address";
          FollowUpSalesHeaderR."Ship-to Address 2" := ReturnHeaderV."Sell-to Address 2";
          FollowUpSalesHeaderR."Ship-to City" := ReturnHeaderV."Sell-to City";
          FollowUpSalesHeaderR."Ship-to Contact" := ReturnHeaderV."Sell-to Contact";
          FollowUpSalesHeaderR."Ship-to Post Code" := ReturnHeaderV."Ship-to Post Code";
          FollowUpSalesHeaderR."Ship-to Country/Region Code" := ReturnHeaderV."Sell-to Country/Region Code";

        END;
      END;

      FollowUpSalesHeaderR."Return Type" := FollowUpSalesHeaderR."Return Type"::Change;
      FollowUpSalesHeaderR."Is Follow-up Sales Order" := TRUE;

      IF ReturnHeaderV."Website No." <> 0 THEN
        FollowUpSalesHeaderR."Website No." := ReturnHeaderV."Website No."
      ELSE
        EVALUATE(FollowUpSalesHeaderR."Website No.",COPYSTR(FollowUpSalesHeaderR."Sell-to Customer No.",1,1));

      //H1241       12.09.14  JM ++++++++++++++++++
      InvH24Mgt.SetSalesFollowUpHeaderOnHold(FollowUpSalesHeaderR);
      //H1241       12.09.14  JM -----------------
      FollowUpSalesHeaderR.MODIFY;
      CreateDocDimForSalesHeader(FollowUpSalesHeaderR,ReturnHeaderV);
      //H1202 04.06.14 HCN -----------------------------
    END;

    PROCEDURE CreateFollowUpSalesLine@1000000067(ReturnOrderLineV@1108200000 : Record 37;FollowUpSalesHeaderV@1000000014 : Record 36);
    VAR
      FollowUpSalesLineL@1108200006 : Record 37;
      ItemL@1000000004 : Record 27;
      eBayNavCWebshopItemL@1000000010 : Record 5251566;
      CalendarManagementL@1000000003 : Codeunit 7600;
      SIIFillLogL@1000000009 : Codeunit 50123;
      NewDateL@1000000001 : Date;
      DateL@1000000006 : Date;
      Date2L@1000000007 : Date;
      DifferenceInDaysL@1000000008 : Integer;
      DaysAddedL@1000000000 : Integer;
      DescriptionL@1000000002 : Text[50];
    BEGIN
      // CreateFollowUpSalesLine
      //H1202 02.06.14 HCN +++++++++++++++++++++++++++++

      CLEAR(FollowUpSalesLineL);
      FollowUpSalesLineL.SETCURRENTKEY("Item Change Return No.","Item Change Return Line No.");
      FollowUpSalesLineL.SETRANGE("Item Change Return No.",ReturnOrderLineV."Document No.");
      FollowUpSalesLineL.SETRANGE("Item Change Return Line No.",ReturnOrderLineV."Line No.");
      IF NOT FollowUpSalesLineL.ISEMPTY THEN
        ERROR(Error001);

      CLEAR(FollowUpSalesLineL);
      FollowUpSalesLineL.INIT;
      FollowUpSalesLineL."Document Type" := FollowUpSalesHeaderV."Document Type";
      FollowUpSalesLineL."Document No." := FollowUpSalesHeaderV."No.";
      FollowUpSalesLineL."Line No." := ReturnOrderLineV."Line No.";
      FollowUpSalesLineL.VALIDATE(Type,ReturnOrderLineV.Type);
      FollowUpSalesLineL.VALIDATE("No.",ReturnOrderLineV."No.");
      FollowUpSalesLineL.VALIDATE(Quantity,ReturnOrderLineV.Quantity);
      FollowUpSalesLineL.VALIDATE("Unit Price",ReturnOrderLineV."Unit Price");
      FollowUpSalesLineL.VALIDATE("Line Discount %",ReturnOrderLineV."Line Discount %");
      FollowUpSalesLineL.ID := ReturnOrderLineV.ID;
      FollowUpSalesLineL."Parent ID" := ReturnOrderLineV."Parent ID";
      FollowUpSalesLineL.VALIDATE("Inv. Discount Amount",ReturnOrderLineV."Inv. Discount Amount");
      FollowUpSalesLineL."Linked to Sales Order No." := ReturnOrderLineV."Linked to Sales Order No.";
      FollowUpSalesLineL."Linked to Sales Order Line No." := ReturnOrderLineV."Linked to Sales Order Line No.";
      IF FollowUpSalesLineL.Type = FollowUpSalesLineL.Type::Item THEN BEGIN
        FollowUpSalesLineL.VALIDATE("Purchasing Code", ReturnOrderLineV."Purchasing Code");
        //H1389 20.08.14 MSL ++++++++++++++++++++++
        eBayNavCWebshopItemL.GET(FORMAT(FollowUpSalesHeaderV."Website No."),ReturnOrderLineV."No.");
        FollowUpSalesLineL."Shipping Agent Code" := eBayNavCWebshopItemL."Shipping Agent Code";
        //H1389 20.08.14 MSL ----------------------
      END;
      IF (ReturnOrderLineV.Type = ReturnOrderLineV.Type::Item) AND
         ItemL.GET(FollowUpSalesLineL."No.")
      THEN BEGIN
        DateL := TODAY;
        Date2L := CALCDATE(ItemL."Lead Time Calculation (max.)", DateL);
        DifferenceInDaysL := Date2L - DateL;

        NewDateL := FollowUpSalesHeaderV."Order Date";
        WHILE (DaysAddedL < DifferenceInDaysL) DO BEGIN
          NewDateL := CALCDATE('<1D>', NewDateL);
          IF NOT CalendarManagementL.CheckDateStatus('BC', NewDateL, DescriptionL) THEN // NOT NONWORKING
            DaysAddedL += 1;
        END;
        FollowUpSalesLineL.VALIDATE("Max. Order Date",NewDateL);
      END;
      FollowUpSalesLineL."Item Change Return No." := ReturnOrderLineV."Document No.";
      FollowUpSalesLineL."Item Change Return Line No." := ReturnOrderLineV."Line No.";
      //H1812 13.11.14 EHN +++++++++++++++++++++++++++++++++++++
      IF FollowUpSalesLineL."Shipping Agent Code" = '' THEN
        FollowUpSalesLineL.CalcShippingAgentCode;
      //H1812 13.11.14 EHN -------------------------------------
      FollowUpSalesLineL.INSERT(TRUE);
      TransferItemCharge(ReturnOrderLineV,FollowUpSalesLineL);
      IF ReturnOrderLineV."Return Type" = ReturnOrderLineV."Return Type"::Change THEN
        SIIFillLogL.Triggered_Change(3,FollowUpSalesLineL);
      CreateDocDimForSalesLine(FollowUpSalesLineL,ReturnOrderLineV);
      //H1202 04.06.14 HCN -----------------------------
    END;

    PROCEDURE UpdateDeliveryDaysOnSalesLine@1000000034(SalesHeaderV@1000000000 : Record 36);
    VAR
      ItemL@1000000002 : Record 27;
      SalesLineL@1000000008 : Record 37;
      AvailabilityCheckL@1000000001 : Codeunit 50149;
      NewDateL@1000000007 : Date;
      DateL@1000000006 : Date;
      Date2L@1000000005 : Date;
      DifferenceInDaysL@1000000004 : Integer;
      DaysAddedL@1000000003 : Integer;
    BEGIN
      //H2015 23.02.15 EHN +++++++++++++++++++++++++++
      //Calculate default Delivery Days value
      CLEAR(SalesLineL);
      SalesLineL.SETCURRENTKEY("Document Type","Document No.","Line No.");
      SalesLineL.SETRANGE("Document Type",SalesHeaderV."Document Type");
      SalesLineL.SETRANGE("Document No.",SalesHeaderV."No.");
      IF SalesLineL.FIND('-') THEN
        REPEAT
          IF (SalesLineL.Type = SalesLineL.Type::Item) AND ItemL.GET(SalesLineL."No.") THEN
            IF SalesLineL."Delivery Days" = 0 THEN BEGIN
              DateL := TODAY;
              Date2L := CALCDATE(ItemL."Lead Time Calculation (max.)", DateL);
              DifferenceInDaysL := Date2L - DateL;
              SalesLineL.VALIDATE("Delivery Days",DifferenceInDaysL);
              SalesLineL.MODIFY(TRUE);
            END;
        UNTIL SalesLineL.NEXT = 0;

      //Overwrite the calculated value if there is estimation from the webshop
      CLEAR(SalesLineL);
      SalesLineL.SETRANGE("Document Type",SalesHeaderV."Document Type");
      SalesLineL.SETRANGE("Document No.",SalesHeaderV."No.");
      SalesLineL.SETRANGE(Type,SalesLineL.Type::Item);
      IF SalesLineL.FINDSET THEN
        REPEAT
          CLEAR(AvailabilityCheckL);
          AvailabilityCheckL.SetUseStockLocationSetup(TRUE);
          AvailabilityCheckL.SetSkipChannelChange(TRUE);
          AvailabilityCheckL.GetAvailabilityForLineWInterf(SalesLineL); //There is a COMMIT!
        UNTIL SalesLineL.NEXT = 0;
      //H2015 23.02.15 EHN ---------------------------
    END;

    PROCEDURE SetSkipUpdateDeliveryDays@1000000035(SkipUpdateV@1000000000 : Boolean);
    BEGIN
      //H2015 23.02.15 EHN +++++++++++++++++++++++++++
      SkipUpdateDeliveryDaysOnSO := SkipUpdateV;
      //H2015 23.02.15 EHN ---------------------------
    END;

    PROCEDURE TransferItemCharge@1000000080(SourceSalesLineChargeItemV@1000000000 : Record 37;TargetSalesLineChargeItemV@1000000006 : Record 37);
    VAR
      ItemChargeAssignmentL@1000000001 : Record 5809;
      ItemChargeAssignment2L@1000000002 : Record 5809;
      SignFactorL@1000000003 : Integer;
    BEGIN
      // TransferItemCharge
      //H1202 05.06.14 HCN -----------------------------

      IF (SourceSalesLineChargeItemV.Type <> SourceSalesLineChargeItemV.Type::"Charge (Item)") THEN BEGIN
        EXIT;
      END;

      CLEAR(ItemChargeAssignmentL);
      ItemChargeAssignmentL.SETCURRENTKEY("Document Type","Document No.","Document Line No.","Line No.");
      ItemChargeAssignmentL.SETRANGE("Document Type",SourceSalesLineChargeItemV."Document Type");
      ItemChargeAssignmentL.SETRANGE("Document No.",SourceSalesLineChargeItemV."Document No.");
      ItemChargeAssignmentL.SETRANGE("Document Line No.",SourceSalesLineChargeItemV."Line No.");
      IF ItemChargeAssignmentL.FIND('-') THEN BEGIN
        REPEAT
          ItemChargeAssignment2L.INIT;
          ItemChargeAssignment2L."Document Type" := TargetSalesLineChargeItemV."Document Type";
          ItemChargeAssignment2L."Document No." := TargetSalesLineChargeItemV."Document No.";
          ItemChargeAssignment2L."Document Line No." := TargetSalesLineChargeItemV."Line No.";
          ItemChargeAssignment2L."Line No." := ItemChargeAssignmentL."Line No.";
          ItemChargeAssignment2L."Item Charge No." := ItemChargeAssignmentL."Item Charge No.";
          ItemChargeAssignment2L."Item No." := ItemChargeAssignmentL."Item No.";
          ItemChargeAssignment2L.Description := ItemChargeAssignmentL.Description;
          ItemChargeAssignment2L."Qty. to Assign" := ItemChargeAssignmentL."Qty. to Assign";
          ItemChargeAssignment2L."Qty. Assigned" := ItemChargeAssignmentL."Qty. Assigned";
          ItemChargeAssignment2L."Unit Cost" := ItemChargeAssignmentL."Unit Cost";
          IF (TargetSalesLineChargeItemV."Document Type" <> SourceSalesLineChargeItemV."Document Type") THEN BEGIN
            SignFactorL := +1;
          END ELSE BEGIN
            SignFactorL := -1;
          END;
          ItemChargeAssignment2L."Amount to Assign" := SignFactorL * ItemChargeAssignmentL."Amount to Assign";
          ItemChargeAssignment2L."Applies-to Doc. Type" := ItemChargeAssignmentL."Applies-to Doc. Type";
          ItemChargeAssignment2L."Applies-to Doc. No." := ItemChargeAssignmentL."Applies-to Doc. No.";
          ItemChargeAssignment2L."Applies-to Doc. Line No." := ItemChargeAssignmentL."Applies-to Doc. Line No.";
          ItemChargeAssignment2L."Applies-to Doc. Line Amount" := ItemChargeAssignmentL."Applies-to Doc. Line Amount";
          ItemChargeAssignment2L.INSERT(TRUE);
        UNTIL ItemChargeAssignmentL.NEXT = 0;
      END;
      //H1202 05.06.14 HCN -----------------------------
    END;

    PROCEDURE CheckIsParcelServiceOnly@1000000072(SalesHeaderDocType@1000000004 : Option;SalesHeaderNoP@1000000000 : Code[20];SalesHeaderSource@1000000005 : Integer) : Boolean;
    VAR
      SalesLineL@1000000001 : Record 37;
      SalesLineArchiveL@1000000003 : Record 5108;
      NoOfLinesL@1000000002 : Integer;
    BEGIN
      //T0003 17.06.14 tec-sf +++++++++++++++++++++++++++++

      CASE SalesHeaderSource OF
        0:
          BEGIN
            SalesLineL.RESET;
            SalesLineL.SETRANGE("Document Type", SalesHeaderDocType);
            SalesLineL.SETRANGE("Document No.", SalesHeaderNoP);
            NoOfLinesL := SalesLineL.COUNT;
            IF NoOfLinesL = 0 THEN
              EXIT(FALSE);
            SalesLineL.SETRANGE("Transp. Type", SalesLineL."Transp. Type"::"Parcel Service");
            IF NoOfLinesL = SalesLineL.COUNT THEN
              EXIT(TRUE);

            EXIT(FALSE);
          END;
        1:
          BEGIN
            SalesLineArchiveL.RESET;
            SalesLineArchiveL.SETRANGE("Document Type", SalesHeaderDocType);
            SalesLineArchiveL.SETRANGE("Document No.", SalesHeaderNoP);
            NoOfLinesL := SalesLineArchiveL.COUNT;
            IF NoOfLinesL = 0 THEN
              EXIT(FALSE);
            SalesLineArchiveL.SETRANGE("Transp. Type", SalesLineArchiveL."Transp. Type"::"Parcel Service");
            IF NoOfLinesL = SalesLineL.COUNT THEN
              EXIT(TRUE);

            EXIT(FALSE);
          END;
      END;
      //T0003 17.06.14 tec-sf -----------------------------
    END;

    PROCEDURE GetNewCreatedReturnOrderNo@1000000073() : Code[20];
    BEGIN
      //T0012 18.06.14 tec-sf +++++++++++++++++++++++++++++
      EXIT(CreateReturnOrderNo);
      //T0012 18.06.14 tec-sf -----------------------------
    END;

    PROCEDURE SetCalledRecursive@1000000074(NewCalledRecursive@1000000000 : Boolean);
    BEGIN
      //T0012 18.06.14 tec-sf +++++++++++++++++++++++++++++
      CalledRecursive := NewCalledRecursive;
      //T0012 18.06.14 tec-sf -----------------------------
    END;

    PROCEDURE SetCancellationMode@1000000077(CancellationModeV@1000000000 : ' ,ManualRequestCancel,ManualConfirmCancel');
    BEGIN
      // SetCancellationMode
      //H0587 18.06.14 HCN +++++++++++++++++++++++++++++
      CancellationMode := CancellationModeV;
      //H0587 18.06.14 HCN -----------------------------
    END;

    PROCEDURE PrintToBullZip@1000000032(ReportIDV@1000000000 : Integer;VAR RecordRefR@1000000008 : RecordRef;VAR OutputFilenameR@1000000001 : Text[250];TimeoutV@1000000011 : Integer;VAR SettingsR@1000000002 : ARRAY [20,2] OF Text[250]);
    VAR
      BullZipPDFL@1000000005 : Automation "{61CB5BFA-AFE6-4B0F-A4BB-7F3D4999EE52} 3.2:{BEBDC1DF-D793-4F6C-B8FF-E831A1C2595C}:'Bullzip'.PDFPrinterSettings";
      BullZipUtilL@1000000004 : Automation "{A3F69B34-EAD8-4A3B-8DD5-C1C3FD300D67} 4.0:{F9444F96-C32A-4745-9FF3-9059B92CDAB0}:'Bullzip - PDF Writer Automation'.ComPdfUtil";
      PrinterSelectionL@1000000010 : Record 78;
      SalesHeaderL@1000000003 : Record 36;
      SalesLineL@1000000013 : Record 37;
      SalesCrMemoHeaderL@1000000014 : Record 114;
      PurchaseHeaderL@1000000009 : Record 38;
      SalesInvoiceHeaderL@1000000012 : Record 112;
      IssuedReminderHeaderL@1000000015 : Record 297;
      StatusFileNameL@1000000006 : Text[250];
      i@1000000007 : Integer;
    BEGIN
      //H1672 20.10.14 MIK +++++++++++++++++++++++++++++
      // Print report to PDF file.
      // ReportIDV        - ID of the report to run
      // RecordRefR       - RecordRef with record, which will be used to filter report.
      // OutputFilenameR  - Output file name. If empty value is used, temporary folder will be used for output.
      //                    You can check OutputFilenameR after function completes to retrive generated file name.
      // TimeoutV         - Timeout for BullZip printer. You can use 0 to use default value (30000)
      // SettingsR        - Multidimensional array of additional settings. Use empty array for default settings.
      //
      //
      // Example usage:
      // ************
      //
      // recSalesHeader.GET(recSalesHeader."Document Type"::"Return Order", 'SR12131381');
      // recSalesHeader.SETRECFILTER;
      // RecordRefR.GETTABLE(recSalesHeader);
      // RecordRefR.SETVIEW(recSalesHeader.GETVIEW);
      // PrintToBullZip(REPORT::"Return Order - Return Sheet",RecordRefR,OutputFilenameR,0,SettingsR);
      //
      // ************


      IF ISCLEAR(BullZipPDFL) THEN
        CREATE(BullZipPDFL);
      IF ISCLEAR(BullZipUtilL) THEN
        CREATE(BullZipUtilL);

      IF OutputFilenameR = '' THEN
        OutputFilenameR := TEMPORARYPATH + FORMAT(CREATEGUID) + '.pdf';
      IF EXISTS(OutputFilenameR) THEN
        ERASE(OutputFilenameR);

      IF TimeoutV = 0 THEN
        TimeoutV := 30000;

      // The status file is used to check for errors and determine when the PDF is ready.
      StatusFileNameL :=  TEMPORARYPATH + FORMAT(CREATEGUID) + '.ini';
      IF EXISTS(StatusFileNameL) THEN
        ERASE(StatusFileNameL);


      BullZipPDFL.Init;
      BullZipPDFL.LoadSettings;

      // Set default settings
      BullZipPDFL.SetValue('Output',OutputFilenameR);
      BullZipPDFL.SetValue('Showsettings', 'never');
      BullZipPDFL.SetValue('ShowPDF', 'no');
      BullZipPDFL.SetValue('ShowProgress', 'no');
      BullZipPDFL.SetValue('ShowProgressFinished', 'no');
      BullZipPDFL.SetValue('SuppressErrors', 'yes');
      BullZipPDFL.SetValue('ConfirmOverwrite', 'no');
      BullZipPDFL.SetValue('StatusFile', StatusFileNameL);

      // Overwrite default settings with settings provided
      FOR i := 1 TO ARRAYLEN(SettingsR,1) DO BEGIN
       IF SettingsR[i][1] <> '' THEN BEGIN
         BullZipPDFL.SetValue(SettingsR[i][1],SettingsR[i][2]);
         IF SettingsR[i][1] = 'Output' THEN
           OutputFilenameR := SettingsR[i][2];
       END;
      END;

      BullZipPDFL.WriteSettings(TRUE);

      PrinterSelectionL.INIT;
      PrinterSelectionL."User ID" := USERID;
      PrinterSelectionL."Report ID" := ReportIDV;
      PrinterSelectionL."Printer Name" := BullZipPDFL.GetPrinterName;
      IF NOT PrinterSelectionL.INSERT(TRUE) THEN
        PrinterSelectionL.MODIFY(TRUE);


      //It is not possible to pass RecordRef to report, so we need to list all possible tables here
      CASE RecordRefR.NUMBER OF
        DATABASE::"Sales Header" : BEGIN
          SalesHeaderL.SETVIEW(RecordRefR.GETVIEW);
          RecordRefR.SETTABLE(SalesHeaderL);
          REPORT.RUNMODAL(ReportIDV,FALSE,FALSE,SalesHeaderL);
        END;
        DATABASE::"Sales Line" : BEGIN
          SalesLineL.SETVIEW(RecordRefR.GETVIEW);
          RecordRefR.SETTABLE(SalesLineL);
          REPORT.RUNMODAL(ReportIDV,FALSE,FALSE,SalesLineL);
        END;
        DATABASE::"Sales Cr.Memo Header" : BEGIN
          SalesCrMemoHeaderL.SETVIEW(RecordRefR.GETVIEW);
          RecordRefR.SETTABLE(SalesCrMemoHeaderL);
          REPORT.RUNMODAL(ReportIDV,FALSE,FALSE,SalesCrMemoHeaderL);
        END;
        DATABASE::"Purchase Header" : BEGIN
          PurchaseHeaderL.SETVIEW(RecordRefR.GETVIEW);
          RecordRefR.SETTABLE(PurchaseHeaderL);
          REPORT.RUNMODAL(ReportIDV,FALSE,FALSE,PurchaseHeaderL);
        END;
        DATABASE::"Sales Invoice Header" : BEGIN
          SalesInvoiceHeaderL.SETVIEW(RecordRefR.GETVIEW);
          RecordRefR.SETTABLE(SalesInvoiceHeaderL);
          REPORT.RUNMODAL(ReportIDV,FALSE,FALSE,SalesInvoiceHeaderL);
        END;
        //H1985  12.03.15  MBY  ++++++++++++++++++++++++++++++++++++++++++++++++++++++
        DATABASE::"Issued Reminder Header" : BEGIN
          IssuedReminderHeaderL.SETVIEW(RecordRefR.GETVIEW);
          RecordRefR.SETTABLE(IssuedReminderHeaderL);
          REPORT.RUNMODAL(ReportIDV,FALSE,FALSE,IssuedReminderHeaderL);
        END;
        //H1985  12.03.15  MBY  ------------------------------------------------------
        ELSE
          ERROR('Printing of table %1 - %2 is not implemented',RecordRefR.NUMBER,RecordRefR.CAPTION);
      END;

      PrinterSelectionL.DELETE(TRUE);

      IF BullZipUtilL.WaitForFile(OutputFilenameR, TimeoutV)  THEN BEGIN
          //H1742 30.10.14 MIK +++++++++++++++++++++++++++++
          IF BullZipUtilL.WaitForFile(StatusFileNameL, TimeoutV)  THEN BEGIN
            // Check status file for errors.
            IF BullZipUtilL.ReadIniString(StatusFileNameL, 'Status', 'Errors', '') <> '0' THEN BEGIN
              ERROR('Error creating PDF. ' + BullZipUtilL.ReadIniString(StatusFileNameL, 'Status', 'MessageText', ''));
            END;
          END ELSE BEGIN
            ERROR('Error creating PDF. Unable to locate status file: '+StatusFileNameL);
          END
          //H1742 30.10.14 MIK -----------------------------
      END ELSE BEGIN
        // The timeout elapsed. Something is wrong.
        ERROR('Error creating ' + OutputFilenameR);
      END;
      //H1672 20.10.14 MIK -----------------------------

      //H2103 17.02.15 MIK +++++++++++++++++++++++++++++
      IF EXISTS(StatusFileNameL) THEN
        IF ERASE(StatusFileNameL) THEN;
      //H2103 17.02.15 MIK -----------------------------
    END;

    PROCEDURE CreateSparePartOrderMail@1000000128(parSalesHeader@1108200002 : Record 36;manuallyTriggeredV@1000000002 : Boolean);
    VAR
      BatchPostDoc@1108200000 : Record 50043;
      EntryNo@1108200001 : Integer;
      locSalesLine@1000000000 : Record 37;
      SIISetupL@1000000001 : Record 50140;
      AutomEMailProcesses@1000000003 : Codeunit 50030;
      MailITSetup@1000000004 : Record 75402;
    BEGIN
      //H1472 27.10.14 tec-rhe ++++++++++

      // CreateSparePartOrderMail
      IF (parSalesHeader."Document Type" <> parSalesHeader."Document Type"::Order) AND
         (parSalesHeader."Return Type" <>  parSalesHeader."Return Type"::"Spare Part") THEN
        EXIT;


      AutomEMailProcesses.Proceed_FTTC_TriggerMsg(parSalesHeader, manuallyTriggeredV);

      //H1472 27.10.14 tec-rhe ----------
    END;

    PROCEDURE ConfirmCancelOrder@1000000027(VAR SalesHeaderR@1000000000 : Record 36;withCommitsV@1000000006 : Boolean);
    VAR
      CommentLineL@1000000004 : Record 97;
      SalesHeaderL@1000000003 : Record 36;
      SalesLineL@1000000002 : Record 37;
      FPCManagementL@1000000001 : Codeunit 50003;
    BEGIN
      //T0018 04.11.14 tec-cs ++++++++++++++++++++++++++
      // moved from form 42 to this function
      SalesHeaderR."Cancel Without Interfaces" := TRUE;
      SalesHeaderR.MODIFY;
      IF withCommitsV THEN COMMIT;

      CLEAR(FPCManagementL);
      FPCManagementL.InitCancelWithoutInterfaces(SalesHeaderR."No.", 0);
      FPCManagementL.SetCancellationMode(CancellationMode::ManualConfirmCancel);
      CLEARLASTERROR;

      IF withCommitsV THEN BEGIN
        COMMIT;
        IF NOT FPCManagementL.RUN THEN BEGIN
          SalesHeaderR."Cancel Without Interfaces" := FALSE;
          SalesHeaderR.MODIFY;
          COMMIT;
          ERROR(GETLASTERRORTEXT);
        END;
      END ELSE BEGIN
        FPCManagementL.RUN;
      END;

      // add log
      IF withCommitsV THEN COMMIT;
      SalesHeaderR.RESET;
      SalesHeaderR.GET(SalesHeaderR."Document Type", SalesHeaderR."No.");
      SalesHeaderR."Cancel Without Interfaces" := FALSE;
      SalesHeaderR.MODIFY;
      CommentLineL.InsertOrderHistory(SalesHeaderR."No.",
                                      'CANCNOINTF',
                                      STRSUBSTNO(TextHME004, CURRENTDATETIME));
      //T0018 04.11.14 tec-cs --------------------------
    END;

    PROCEDURE GetShippedItemLedgerEntry@1000081800(SalesOrderNo@1000000000 : Code[20];SalesOrderLineNo@1000000001 : Integer;SalesOrderLineItemNo@1000000003 : Code[20]) ILENo : Integer;
    VAR
      SalesShipmtLineL@1000000004 : Record 111;
      ItemLedgerEntryShipmentL@1000000002 : Record 32;
    BEGIN
      //H4307 30.06.2015 gob-dah ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
      SalesShipmtLineL.RESET;
      SalesShipmtLineL.SETCURRENTKEY("Order No.","Order Line No.","Posting Date");
      SalesShipmtLineL.SETRANGE("Order No.",SalesOrderNo);
      SalesShipmtLineL.SETRANGE("Order Line No.",SalesOrderLineNo);
      SalesShipmtLineL.SETRANGE("No.",SalesOrderLineItemNo);
      IF SalesShipmtLineL.FINDSET(FALSE,FALSE) THEN BEGIN
          ItemLedgerEntryShipmentL.RESET;
          ItemLedgerEntryShipmentL.SETCURRENTKEY("Document No.","Document Type","Document Line No.");
          ItemLedgerEntryShipmentL.SETRANGE("Document No.",SalesShipmtLineL."Document No.");
          ItemLedgerEntryShipmentL.SETRANGE("Document Line No.",SalesShipmtLineL."Line No.");
          ItemLedgerEntryShipmentL.SETRANGE("Item No.",SalesOrderLineItemNo);
          IF ItemLedgerEntryShipmentL.FIND('-') THEN BEGIN
            EXIT(ItemLedgerEntryShipmentL."Entry No.")
          END ELSE BEGIN
            EXIT(0)
          END;
      END ELSE BEGIN
        EXIT(0);
      END;
      //H4307 30.06.2015 gob-dah --------------------------------------------------------------
    END;

    BEGIN
    {
      +--------------------------------------------------+
      |                   ¬∏  Copyright                   |
      |       GOB Software & Systeme GmbH & Co. KG       |
      +--------------------------------------------------+
      |                     FP Commerce                  |
      +--------------------------------------------------+

      Version   Date      Consultant  Comment
      ____________________________________________________________________________________________________________________________________
      GOB1.00   19.06.12  gob-rste    Object created
      P0011     10.06.12  gob-mno     New Functions for Return Orders
      p0072     25.07.12  gob-mab     neue Fkt. CheckLastDocNoInteger
      P0011     30.07.12  gob-mno     New Function: CheckReturnEMailTyp
      P0011     30.07.12  gob-mno     New Function: GetReturnOrderLineType
      P0113     30.07.12  gob-mno     New Function: ResendDropshipMail
      P0011     31.07.12  gob-mno     New Code in CreateReturnDocument
      P0115     31.07.12  gob-rste    New Code in CheckForPickingInterruption
      P0011     31.07.12  gob-mno     New Code in CreateItemChangeOrder
      P0124     01.08.12  gob-rste    New Funktion DeleteCRLF
      P0128     01.08.12  gob-mno     Code Change
      P0151     08.08.12  gob-mno     HotFix for Return Order Functions
      p0150     10.08.12  gob-mab     Erweiterung Fkt. CreateReturnDocument
      P0180     14.08.12  gob-mno     Hotfixe
      P0184     14.08.12  gob-rste    New Funktion ChangeChannel
      P0188     15.08.12  gob-dst     Erweiterung Funktion DeleteCRLF (Tabs durch Leerzeichen ersetzen)
      P0192     15.08.12  gob-mno     Copy Payment Method Code to Return Order
      P0222     22.08.12  gob-mno     Transp. Type bei Rekl. f¬Ållen
      P0214     23.08.12  gob-rste    new COde for ChangeChannel2
      P0233     27.08.12  gob-mno     Anpassung, damit Rechnungsrabatte ¬Åbertragen werden
      P0236     28.08.12  gob-mno     Korrektur, bei Vermeidungsrabetten in Reklamationen
      P0244     29.08.12  gob-Fuchs   BugFix P0011
      P0260     30.08.12  gob-mno     BugFix / Optimierung
      P0264     31.08.12  gob-mno     Fix damit Storno / Kulanz Kennzeichen gespeichert wird
      P0268     04.09.12  gob-mno     UpdateItemChargeAsign insert
      P0277     04.09.12  gob-rste    New Code OnRun for Cancel without interfaces
      P0292     06.09.12  gob-rste    Processing Interrupted new Value for Address and Comment Check
      P0296     06.09.12  gob-rste    Remove Filter for Change Channel
      P0304     10.09.12  gob-mno     New Code CreateItemChangeOrder
      P0308     11.09.12  gob-mno     New Check Function for Item Charge Creation
      P0313     12.09.12  gob-rste    New Code for CheckPickingInterruption
      P0316     12.09.12  gob-rste    Change Webshop Nr fro  Flowfield to Integer
      P0324     17.09.12  gob-mno     New Function InsertCommentLineAnveo
      P0330     17.09.12  gob-mno     Fix Release Auftr‚Äûge
      P0355     19.09.12  gob-mno     Erweiterung Reklamationslogik
      P0368     24.09.12  gob-mab     Monat Fr. Korrektur
      P0355     25.09.12  gob-mno     New Function "CheckExistingCrMemo"
      P0355     26.09.12  gob-mno     Neue Feldzuweisungen
      P0386     26.09.12  gob-mno     Zuweisung Website No.
      P0387     26.09.12  gob-mno     Zuweisung der Gesch‚Äûftsbuchungsgruppe aus Ursprungsauftrag
      P0361     02.10.12  gob-dst     Versionierung bei DD
      P0400     02.10.12  gob-mno     2MHD bei Reklamationserstellung
      P0387     08.10.12  gob-mno     Anpasung: Zuweisung ebenfalls im Kopf
      P0420     09.10.12  gob-mno     Vermeidungsrabatte / Kulanzen ohne Schnittstelle
      P0423     09.10.12  gob-mno     Dimensionen bei Umtauschfolgeauftr‚Äûgen
      P0437     11.10.12  gob-ael     Fix von Gutscheinbetr‚Äûgen in Reklamationen
      P0418     11.10.12  gob-ael     Eintrag in History-Tabelle f¬År Gutscheine
      P0447     15.10.12  gob-mno     Sicherung des Auftragsstatus
      P0451     16.10.12  gob-mno     Pr¬Åfung, damit Rabatte / Kulanzen nicht gr‚Äù√°er Ursprungsbetrag gew‚Äûhrt werden
      P0418     23.10.12  gob-ael     F¬Ållen der loclineno mit Reklamationszeilennr. und nicht Verkaufszeilennr. -> Confirm sonst falsch
      P0544     31.10.12  gob-mno     Link between SO and SR
      P0548     31.10.12  gob-mno     Fix VK-Preis bei Umtauschfolgeauftragserstellung
      P0550     02.11.12  gob-mno     Fix Felder bei Umtauschfolgeauftr‚Äûgen
      P0551     14.11.12  gob-ael     Funktion CreateReturnOrder mit R¬Åckgabewert boolean versehen f¬År GETLASTERROR
      P0593     16.11.12  gob-mno     Save Return Type in Item Charge
      P0600     20.11.12  gob-mno     New Code for CreateReturnOrderMail
      P0651     06.12.12  gob-sfe     Function GetShippingAgent
      P0659     11.12.12  gob-mno     Change Ship Address in Return Order & Change Order
      P0651     20121206  gob-sfe     Default Shipping Agent
      P0689     18.12.12  gob-mno     New Code
      P0693     06.12.12  gob-ael     Neue Funktion SetHideValidationDialog
      P0694     18.12.12  gob-mno     New Function CopyFromSalesDocDimToLine
      P0722     03.01.13  gob-mno     New Function CopyFromSalesDocDimToHeader
      P0724     07.01.13  gob-mno     New Code for Dimensions
      P0745     16.01.13  gob-mno     New Code for Dimensions ins Change Sales Orders
      P0762     24.01.13  gob-mno     New Code to deactivate shipping no.
      P0763     24.01.13  gob-mno     New Code to transfer purchasing code to return order
      P0783     31.01.13  gob-sfe     DGB Shipping Agent
      P0790     05.02.13  gob-ael     Zu-/Abschlag bei Reklamationen: Verlinkung zur Lieferung ge‚Äûndert
      P0809     15.02.13  gob-ael     Beim Kopieren der Dimensionswerte: Wenn Dimensionswert f¬År Auftrag noch nicht existiert: anlegen
      P0815     20.02.13  gob-mno     New Code to check existing return order
      P0820     25.02.13  gob-lku     Anpassungen Line Status
      P0845     05.03.13  gob-rste    Fix Docdata Bulky Goods
      P0853     13.03.13  gob-lku     Line Status f¬År VIR
      P0862     19.03.13  gob-mno     Fix Code in P0011
      P0864     19.03.13  gob-dst     Neue Funktion "GetShippingAgentSalesLineArch"
      P0870     21.03.13  gob-mno     Paid Kennzeichen in Umtauschfolgeauftr‚Äûge ¬Åbernehmen
      P0877     26.03.13  gob-ael     Korrektur: Dim 4 nicht aus Verkaufskopf sondern Verkaufskopfarchiv!
      P0897     30.04.13  gob-mno     Bug Fix
      P0822     10.05.13  gob-lku     Anpassung Line Status VIR
      P0914     15.05.13  gob-adb     Performance
      P0930     28.05.13  gob-mno     Fix Dimension in Return Order Process
      P0962     13.06.13  gob-lku     Line Status for Channel 13
      P1003     03.07.13  gob-mno     Dimension Bug with resource lines in return orders
      P1038     23.07.13  gob-mno     Link Order Line to Change Order Line
      P1003     26.08.13  gob-ael     F¬År "Credit Bon" Ressource ebenfalls keine KTR-Dimension
      P1119     26.09.13  gob-ael     Korrektur Artikelbeschreibung
      P1133     05.11.13  gob-mlan    Redesign "DHL Parcel Status History"
      P1143     11.11.13  gob-adb     Insert Batch-Post Document due to AutoIncrement
      P1156     25.11.13  gob-ael     Crossdocking variabler mit Feldern
      P1156     04.12.13  gob-ael     CD Anpassungen f¬År ≈°bergangsphase
      P1194     05.02.14  gob-lku     CD Anpassungen f¬År CH
      P1195     07.02.14  gob-rste    DeleteCrLF enhanced parameter and return value to text 1024
      P1201     13.02.14  gob-lku     Anpassung f¬År CH
      P1215     06.03.14  gob-rste    Deactivate Old RHD Interface
      P1224     18.03.14  gob-rste    Cancel Dropshipment Line without Interface


      +--------------------------------------------+
      |                                            |
      |                  Home24                    |
      |     Cooperation Tectura & Home24 NAV Team  |
      |                                            |
      +--------------------------------------------+

      Project No. Date      Shortcut  Description
      _____________________________________________

      T0003       10.06.14  tec-sf    Changed CreateReturnOrderMail
                                      Added CreateReturnOrderMailByBatch, CreateReturnOrderMailByShop
      T0003       17.06.14  tec-sf    Changed CreateReturnOrderMail since there is no new Shop Code for Return Order Label
                                      New function CheckIsParcelServiceOnly()
      T0012       18.06.14  tec-sf    Added a global Var and new function GetNewCreatedReturnOrderNo()
      T0016       02.07.14  tec-cs    FTTC3 Phase 6: Prevention Calculation: redesign "prevention discount %"
      T0009       02.07.14  tec-sf    Added new functions for Credit Memo Mail
      T0003       09.09.14  rec-sf    Changes in CreatereturnOrderMailbyShop
      T0079       21.10.14  tec-cs    changes to avoid errors - needed for debugging
      H1472       27.10.14  tec-rh    New Function "CreateSparePartOrderMail"
      H1472       30.10.14  tec-rh    Check Return Order with filter
      T0080       05.11.14  tec-cs    "process somplaint request" is handled by a codeunit now
      T0062       24.10.14  tec-sh    fill commission lines
      T0096       28.01.15  CC-GH     Prevention Rebate Handling for Marketplace
      T0018       04.11.14  tec-cs    moved function "confirm cancel order" from form42 to this codeunit
      T0060       19.02.15  CC-GH     Special Return Locations for Marketplace
      +--------------------------------------------+
      |                                            |
      |                  Home24                    |
      |       Internal Customizing by NAV-Team     |
      |                                            |
      +--------------------------------------------+

      Project No. Date      Shortcut  Description
      _____________________________________________
      H0285       02.04.13  FX        Anveo - wrong address in Return Orders
      H0001       17.09.12  rho       New Functions for Cancelation of Drop Shipments: CancelDropShipment, AssignFunctionCode
      H0006       03.10.12  rho       Functions for Cancelation of Drop Shipments: CancelDropShipment, AssignFunctionCode moved to CO50093
      H0562       23.09.13  ARI       Date Caluclation when "Payment received at" is set
      H0579       11.11.13  ARI        2 New Functions added : CreatePurchaseJnlLine, CreatePurchJnlLineDimensions
                                      Post separate CreditMemo via Journal for Payment to Customer
      H0866       17.02.14  DMA       New logic for swiss in CalcShippingAgent
      H0121       17.12.12  ARU       Validate for "Max. Order Date"
      H0142       09.01.13  ARU       MonthDescr. for OE (DEA)
      H0182       30.01.13  ARU       Calc. "Line Status Description" > new Code Calling
      H0249       13.03.13  ABR       Change Adress Check Parameter Length
      H0216       18.03.13  PAU       UPS Tracking
      H0345       15.05.13  FX        Fix Line Status Description
      H0636       10.12.13  hcn        - New functions "CounterPostCreditMemoComplaint", "CreatePurchJnlLineDimFromCLE", etc.
                                         HO579-functions adjusted (no change marks)
                                       - Incorporate new Field-"Return Type"-Option "Prevention"
      H0584       11.03.14  hcn        Object copied to C80001 for temporary backup reasons
                                       - Various field changes incorporated
                                       - NOTE: for legibility reasons all change marks have been removed
                                                from the following functions (please check backup Codeunit 50250 if needed):
                                          - CreateReturnOrder
                                          - CreateReturnDocument
                                          - CalcPreventionDiscountLine
                                          - CheckReturnOrderLines
                                          - CheckExistingCrMemo
                                          - CopyItemChargetoReturnOrder
                                          - CopyArchItemChargeToReturnOrd
                                          - CreateFollowUpSalesOrder
                                          - CheckDiscountAmount
                                          - CopyRessourceToReturnOrder
                                          - CheckCompleteReturnOrder
                                          - CopyRessourceToReturnOrder
                                          - CalcPreventionDiscount (Source Code deleted, function was completely deactivated (commented))
                                            function left for the moment as it is called by C5317180 "ACF Events"
      H1023       04.04.14  FF          getDateCountryFormat: added Switzerland
      H1184       22.05.14  HCN        BugFix in Function "CreateReturnDocument"
      H0587       23.05.14  HCN        Redesign Cancellation Process:
                                        - Many new/modfied functions
                                        - Some functionality of "MagentoCancel" (T37 "Sales Line") moved to new functions
      H0862       13.06.14  DMA        Use Transportation Type of Sales Return Orders in "SO-Orders",CODECHANGE
      H1009       15.07.14  ARI        Remove all hardcoded Payment Methods
      H1369       17.07.14  DMA        Bugfix: DocData statuses are not filled to Parcel Status History when Carrier TBP
      H1368       22.07.14  DMA        Create channels for Belgium
      H1447       07.08.14  EHN        Correct display of month names in French & Dutch customer PDFs
      H1389       11.08.14  MSL        Carrier via SMT: 3) Validate proposed carrier per line
      H1200       13.08.14  DMA        Ship Sales Returns via Return Transit location, CODECHANGE
      H1390       25.08.14  MSL        Carrier via SMT: 4) Consolidation of Carriers
      H1202       11.09.14  JM         Bugfix: Validate purchasing code,
      H1241       12.09.14  JM         Check / Create Dunning On Hold Entry
      H1472       29.09.14  rst        New SparePart Process in Function Process Customer Complaint &Request
      H1672       20.10.14  MIK        New function PrintToBullZip. BUG: FTTC3 - Return labels are not created correctly from the SII Log
      H1742       30.10.14  MIK        Bugfix for Bullzip Label Creation. Wait for status file after PDF creation.
      H1734       05.11.14  MIK        ID generated incorrectly during Return Order creation. BUG: Change Order Creation
      H1581       04.11.14  EHN        Italy: customer Pdfs
      H1812       13.11.14  EHN        BUG: WHSLF - only DHL is transfered to KAD
      H1682       21.11.14  EHN        Change Parcel Retour Address to WHSLF
      H1783       14.11.14  MIK        SII Redesign for the Return&Change messages (Label&Instruction)
      H1876       02.12.14  MIK        FTTC3 - Phase 8 - Correction of special Characters
      H1511       10.11.14  ARI        MP2: Use MP Item Charges in Customer Complaint Process if based on an MP Item
      H2103       17.02.15  MIK        SII ProcessLog: delete .ini files in temp folder after printing
      H1985       02.03.15  MBY        Sending reminders by SII
      H2015       23.02.15  EHN        Calculate MODM for FUO
      H4307       xx.xx.xx  MD/JM      Apply return orders to original sales orders
    }
    END.
  }
}

